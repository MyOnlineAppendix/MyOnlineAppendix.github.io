<h3 style="margin:0px">Class: org.apache.hadoop.yarn.server.nodemanager.containermanager.localizer.TestResourceLocalizationService (11 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(2)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="18"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('18')" data-toggle="tooltip" title="Invokes logging operations"><kbd id="tag-18"class="label-info"style="display: inline-block;font-size:7pt" >Logger&nbsp;(1)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-18 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Invokes logging operations">Logger</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Invokes logging operations
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=20000) @SuppressWarnings("unchecked") public void testFailedPublicResource() throws Exception {
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[4];
  for (int i=0; i < 4; ++i) {
    localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
    sDirs[i]=localDirs.get(i).toString();
  }
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  DrainDispatcher dispatcher=new DrainDispatcher();
  EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
  dispatcher.register(ApplicationEventType.class,applicationBus);
  EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
  dispatcher.register(ContainerEventType.class,containerBus);
  ContainerExecutor exec=mock(ContainerExecutor.class);
  DeletionService delService=mock(DeletionService.class);
  LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
  dirsHandler.init(conf);
  dispatcher.init(conf);
  dispatcher.start();
  try {
    ResourceLocalizationService rawService=new ResourceLocalizationService(dispatcher,exec,delService,dirsHandler,new NMNullStateStoreService());
    ResourceLocalizationService spyService=spy(rawService);
    doReturn(mockServer).when(spyService).createServer();
    doReturn(lfs).when(spyService).getLocalFileContext(isA(Configuration.class));
    spyService.init(conf);
    spyService.start();
    final String user="user0";
    final Application app=mock(Application.class);
    final ApplicationId appId=BuilderUtils.newApplicationId(314159265358979L,3);
    when(app.getUser()).thenReturn(user);
    when(app.getAppId()).thenReturn(appId);
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app));
    dispatcher.await();
    final Container c=getMockContainer(appId,42,user);
    Random r=new Random();
    long seed=r.nextLong();
    System.out.println("SEED: " + seed);
    r.setSeed(seed);
    final CyclicBarrier barrier=new CyclicBarrier(2);
    doAnswer(new Answer<Void>(){
      public Void answer(      InvocationOnMock invocation) throws IOException {
        try {
          barrier.await();
        }
 catch (        InterruptedException e) {
        }
catch (        BrokenBarrierException e) {
        }
        throw new IOException("forced failure");
      }
    }
).when(spylfs).setPermission(isA(Path.class),isA(FsPermission.class));
    final LocalResource pubResource=getPublicMockedResource(r);
    final LocalResourceRequest pubReq=new LocalResourceRequest(pubResource);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> req=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    req.put(LocalResourceVisibility.PUBLIC,Collections.singletonList(pubReq));
    Set<LocalResourceRequest> pubRsrcs=new HashSet<LocalResourceRequest>();
    pubRsrcs.add(pubReq);
    spyService.handle(new ContainerLocalizationRequestEvent(c,req));
    spyService.handle(new ContainerLocalizationRequestEvent(c,req));
    dispatcher.await();
    barrier.await();
    verify(containerBus,timeout(5000).times(2)).handle(isA(ContainerResourceFailedEvent.class));
  }
  finally {
    dispatcher.stop();
  }
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void cleanup(){
  conf=null;
}

</code></pre>

<pre class="type-9 type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test @SuppressWarnings("unchecked") public void testRecovery() throws Exception {
  final String user1="user1";
  final String user2="user2";
  final ApplicationId appId1=ApplicationId.newInstance(1,1);
  final ApplicationId appId2=ApplicationId.newInstance(1,2);
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[4];
  for (int i=0; i < 4; ++i) {
    localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
    sDirs[i]=localDirs.get(i).toString();
  }
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  conf.setBoolean(YarnConfiguration.NM_RECOVERY_ENABLED,true);
  NMMemoryStateStoreService stateStore=new NMMemoryStateStoreService();
  stateStore.init(conf);
  stateStore.start();
  DrainDispatcher dispatcher=new DrainDispatcher();
  dispatcher.init(conf);
  dispatcher.start();
  EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
  dispatcher.register(ApplicationEventType.class,applicationBus);
  EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
  dispatcher.register(ContainerEventType.class,containerBus);
  EventHandler<LocalizerEvent> localizerBus=mock(EventHandler.class);
  dispatcher.register(LocalizerEventType.class,localizerBus);
  LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
  dirsHandler.init(conf);
  ResourceLocalizationService spyService=createSpyService(dispatcher,dirsHandler,stateStore);
  try {
    spyService.init(conf);
    spyService.start();
    final Application app1=mock(Application.class);
    when(app1.getUser()).thenReturn(user1);
    when(app1.getAppId()).thenReturn(appId1);
    final Application app2=mock(Application.class);
    when(app2.getUser()).thenReturn(user2);
    when(app2.getAppId()).thenReturn(appId2);
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app1));
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app2));
    dispatcher.await();
    LocalResourcesTracker appTracker1=spyService.getLocalResourcesTracker(LocalResourceVisibility.APPLICATION,user1,appId1);
    LocalResourcesTracker privTracker1=spyService.getLocalResourcesTracker(LocalResourceVisibility.PRIVATE,user1,null);
    LocalResourcesTracker appTracker2=spyService.getLocalResourcesTracker(LocalResourceVisibility.APPLICATION,user2,appId2);
    LocalResourcesTracker pubTracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PUBLIC,null,null);
    final Container c1=getMockContainer(appId1,1,user1);
    final Container c2=getMockContainer(appId2,2,user2);
    Random r=new Random();
    long seed=r.nextLong();
    System.out.println("SEED: " + seed);
    r.setSeed(seed);
    final LocalResource privResource1=getPrivateMockedResource(r);
    final LocalResourceRequest privReq1=new LocalResourceRequest(privResource1);
    final LocalResource privResource2=getPrivateMockedResource(r);
    final LocalResourceRequest privReq2=new LocalResourceRequest(privResource2);
    final LocalResource pubResource1=getPublicMockedResource(r);
    final LocalResourceRequest pubReq1=new LocalResourceRequest(pubResource1);
    final LocalResource pubResource2=getPublicMockedResource(r);
    final LocalResourceRequest pubReq2=new LocalResourceRequest(pubResource2);
    final LocalResource appResource1=getAppMockedResource(r);
    final LocalResourceRequest appReq1=new LocalResourceRequest(appResource1);
    final LocalResource appResource2=getAppMockedResource(r);
    final LocalResourceRequest appReq2=new LocalResourceRequest(appResource2);
    final LocalResource appResource3=getAppMockedResource(r);
    final LocalResourceRequest appReq3=new LocalResourceRequest(appResource3);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> req1=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    req1.put(LocalResourceVisibility.PRIVATE,Arrays.asList(new LocalResourceRequest[]{privReq1,privReq2}));
    req1.put(LocalResourceVisibility.PUBLIC,Collections.singletonList(pubReq1));
    req1.put(LocalResourceVisibility.APPLICATION,Collections.singletonList(appReq1));
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> req2=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    req2.put(LocalResourceVisibility.APPLICATION,Arrays.asList(new LocalResourceRequest[]{appReq2,appReq3}));
    req2.put(LocalResourceVisibility.PUBLIC,Collections.singletonList(pubReq2));
    spyService.handle(new ContainerLocalizationRequestEvent(c1,req1));
    spyService.handle(new ContainerLocalizationRequestEvent(c2,req2));
    dispatcher.await();
    privTracker1.getPathForLocalization(privReq1,dirsHandler.getLocalPathForWrite(ContainerLocalizer.USERCACHE + user1));
    privTracker1.getPathForLocalization(privReq2,dirsHandler.getLocalPathForWrite(ContainerLocalizer.USERCACHE + user1));
    LocalizedResource privLr1=privTracker1.getLocalizedResource(privReq1);
    LocalizedResource privLr2=privTracker1.getLocalizedResource(privReq2);
    appTracker1.getPathForLocalization(appReq1,dirsHandler.getLocalPathForWrite(ContainerLocalizer.APPCACHE + appId1));
    LocalizedResource appLr1=appTracker1.getLocalizedResource(appReq1);
    appTracker2.getPathForLocalization(appReq2,dirsHandler.getLocalPathForWrite(ContainerLocalizer.APPCACHE + appId2));
    LocalizedResource appLr2=appTracker2.getLocalizedResource(appReq2);
    appTracker2.getPathForLocalization(appReq3,dirsHandler.getLocalPathForWrite(ContainerLocalizer.APPCACHE + appId2));
    LocalizedResource appLr3=appTracker2.getLocalizedResource(appReq3);
    pubTracker.getPathForLocalization(pubReq1,dirsHandler.getLocalPathForWrite(ContainerLocalizer.FILECACHE));
    LocalizedResource pubLr1=pubTracker.getLocalizedResource(pubReq1);
    pubTracker.getPathForLocalization(pubReq2,dirsHandler.getLocalPathForWrite(ContainerLocalizer.FILECACHE));
    LocalizedResource pubLr2=pubTracker.getLocalizedResource(pubReq2);
    assertNotNull("Localization not started",privLr1.getLocalPath());
    privTracker1.handle(new ResourceLocalizedEvent(privReq1,privLr1.getLocalPath(),privLr1.getSize() + 5));
    assertNotNull("Localization not started",privLr2.getLocalPath());
    privTracker1.handle(new ResourceLocalizedEvent(privReq2,privLr2.getLocalPath(),privLr2.getSize() + 10));
    assertNotNull("Localization not started",appLr1.getLocalPath());
    appTracker1.handle(new ResourceLocalizedEvent(appReq1,appLr1.getLocalPath(),appLr1.getSize()));
    assertNotNull("Localization not started",appLr3.getLocalPath());
    appTracker2.handle(new ResourceLocalizedEvent(appReq3,appLr3.getLocalPath(),appLr3.getSize() + 7));
    assertNotNull("Localization not started",pubLr1.getLocalPath());
    pubTracker.handle(new ResourceLocalizedEvent(pubReq1,pubLr1.getLocalPath(),pubLr1.getSize() + 1000));
    assertNotNull("Localization not started",pubLr2.getLocalPath());
    pubTracker.handle(new ResourceLocalizedEvent(pubReq2,pubLr2.getLocalPath(),pubLr2.getSize() + 99999));
    dispatcher.await();
    assertEquals(ResourceState.LOCALIZED,privLr1.getState());
    assertEquals(ResourceState.LOCALIZED,privLr2.getState());
    assertEquals(ResourceState.LOCALIZED,appLr1.getState());
    assertEquals(ResourceState.DOWNLOADING,appLr2.getState());
    assertEquals(ResourceState.LOCALIZED,appLr3.getState());
    assertEquals(ResourceState.LOCALIZED,pubLr1.getState());
    assertEquals(ResourceState.LOCALIZED,pubLr2.getState());
    spyService=createSpyService(dispatcher,dirsHandler,stateStore);
    spyService.init(conf);
    spyService.recoverLocalizedResources(stateStore.loadLocalizationState());
    dispatcher.await();
    appTracker1=spyService.getLocalResourcesTracker(LocalResourceVisibility.APPLICATION,user1,appId1);
    privTracker1=spyService.getLocalResourcesTracker(LocalResourceVisibility.PRIVATE,user1,null);
    appTracker2=spyService.getLocalResourcesTracker(LocalResourceVisibility.APPLICATION,user2,appId2);
    pubTracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PUBLIC,null,null);
    LocalizedResource recoveredRsrc=privTracker1.getLocalizedResource(privReq1);
    assertEquals(privReq1,recoveredRsrc.getRequest());
    assertEquals(privLr1.getLocalPath(),recoveredRsrc.getLocalPath());
    assertEquals(privLr1.getSize(),recoveredRsrc.getSize());
    assertEquals(ResourceState.LOCALIZED,recoveredRsrc.getState());
    recoveredRsrc=privTracker1.getLocalizedResource(privReq2);
    assertEquals(privReq2,recoveredRsrc.getRequest());
    assertEquals(privLr2.getLocalPath(),recoveredRsrc.getLocalPath());
    assertEquals(privLr2.getSize(),recoveredRsrc.getSize());
    assertEquals(ResourceState.LOCALIZED,recoveredRsrc.getState());
    recoveredRsrc=appTracker1.getLocalizedResource(appReq1);
    assertEquals(appReq1,recoveredRsrc.getRequest());
    assertEquals(appLr1.getLocalPath(),recoveredRsrc.getLocalPath());
    assertEquals(appLr1.getSize(),recoveredRsrc.getSize());
    assertEquals(ResourceState.LOCALIZED,recoveredRsrc.getState());
    recoveredRsrc=appTracker2.getLocalizedResource(appReq2);
    assertNull("in-progress resource should not be present",recoveredRsrc);
    recoveredRsrc=appTracker2.getLocalizedResource(appReq3);
    assertEquals(appReq3,recoveredRsrc.getRequest());
    assertEquals(appLr3.getLocalPath(),recoveredRsrc.getLocalPath());
    assertEquals(appLr3.getSize(),recoveredRsrc.getSize());
    assertEquals(ResourceState.LOCALIZED,recoveredRsrc.getState());
  }
  finally {
    dispatcher.stop();
    stateStore.close();
  }
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=100000) @SuppressWarnings("unchecked") public void testParallelDownloadAttemptsForPrivateResource() throws Exception {
  DrainDispatcher dispatcher1=null;
  try {
    dispatcher1=new DrainDispatcher();
    String user="testuser";
    ApplicationId appId=BuilderUtils.newApplicationId(1,1);
    List<Path> localDirs=new ArrayList<Path>();
    String[] sDirs=new String[1];
    for (int i=0; i < 1; ++i) {
      localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
      sDirs[i]=localDirs.get(i).toString();
    }
    conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
    LocalDirsHandlerService localDirHandler=new LocalDirsHandlerService();
    localDirHandler.init(conf);
    EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
    dispatcher1.register(ApplicationEventType.class,applicationBus);
    EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
    dispatcher1.register(ContainerEventType.class,containerBus);
    ContainerExecutor exec=mock(ContainerExecutor.class);
    DeletionService delService=mock(DeletionService.class);
    LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
    dirsHandler.init(conf);
    dispatcher1.init(conf);
    dispatcher1.start();
    ResourceLocalizationService rls=new ResourceLocalizationService(dispatcher1,exec,delService,localDirHandler,new NMNullStateStoreService());
    dispatcher1.register(LocalizationEventType.class,rls);
    rls.init(conf);
    rls.handle(createApplicationLocalizationEvent(user,appId));
    LocalResourceRequest req=new LocalResourceRequest(new Path("file:///tmp"),123L,LocalResourceType.FILE,LocalResourceVisibility.PRIVATE,"");
    ContainerImpl container1=createMockContainer(user,1);
    String localizerId1=container1.getContainerId().toString();
    rls.getPrivateLocalizers().put(localizerId1,rls.new LocalizerRunner(new LocalizerContext(user,container1.getContainerId(),null),localizerId1));
    LocalizerRunner localizerRunner1=rls.getLocalizerRunner(localizerId1);
    dispatcher1.getEventHandler().handle(createContainerLocalizationEvent(container1,LocalResourceVisibility.PRIVATE,req));
    Assert.assertTrue(waitForPrivateDownloadToStart(rls,localizerId1,1,200));
    ContainerImpl container2=createMockContainer(user,2);
    String localizerId2=container2.getContainerId().toString();
    rls.getPrivateLocalizers().put(localizerId2,rls.new LocalizerRunner(new LocalizerContext(user,container2.getContainerId(),null),localizerId2));
    LocalizerRunner localizerRunner2=rls.getLocalizerRunner(localizerId2);
    dispatcher1.getEventHandler().handle(createContainerLocalizationEvent(container2,LocalResourceVisibility.PRIVATE,req));
    Assert.assertTrue(waitForPrivateDownloadToStart(rls,localizerId2,1,200));
    LocalResourcesTracker tracker=rls.getLocalResourcesTracker(LocalResourceVisibility.PRIVATE,user,appId);
    LocalizedResource lr=tracker.getLocalizedResource(req);
    Assert.assertEquals(ResourceState.DOWNLOADING,lr.getState());
    Assert.assertEquals(1,lr.sem.availablePermits());
    LocalizerHeartbeatResponse response1=rls.heartbeat(createLocalizerStatus(localizerId1));
    Assert.assertEquals(1,localizerRunner1.scheduled.size());
    Assert.assertEquals(req.getResource(),response1.getResourceSpecs().get(0).getResource().getResource());
    Assert.assertEquals(0,lr.sem.availablePermits());
    LocalizerHeartbeatResponse response2=rls.heartbeat(createLocalizerStatus(localizerId2));
    Assert.assertEquals(0,localizerRunner2.scheduled.size());
    Assert.assertEquals(0,response2.getResourceSpecs().size());
    rls.heartbeat(createLocalizerStatusForFailedResource(localizerId1,req));
    Assert.assertTrue(waitForResourceState(lr,rls,req,LocalResourceVisibility.PRIVATE,user,appId,ResourceState.FAILED,200));
    Assert.assertTrue(lr.getState().equals(ResourceState.FAILED));
    Assert.assertEquals(0,localizerRunner1.scheduled.size());
    response2=rls.heartbeat(createLocalizerStatus(localizerId2));
    Assert.assertEquals(0,localizerRunner2.scheduled.size());
    Assert.assertEquals(0,localizerRunner2.pending.size());
    Assert.assertEquals(0,response2.getResourceSpecs().size());
  }
  finally {
    if (dispatcher1 != null) {
      dispatcher1.stop();
    }
  }
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testLocalizationInit() throws Exception {
  conf.set(CommonConfigurationKeys.FS_PERMISSIONS_UMASK_KEY,"077");
  AsyncDispatcher dispatcher=new AsyncDispatcher();
  dispatcher.init(new Configuration());
  ContainerExecutor exec=mock(ContainerExecutor.class);
  DeletionService delService=spy(new DeletionService(exec));
  delService.init(conf);
  delService.start();
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[4];
  for (int i=0; i < 4; ++i) {
    localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
    sDirs[i]=localDirs.get(i).toString();
  }
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  LocalDirsHandlerService diskhandler=new LocalDirsHandlerService();
  diskhandler.init(conf);
  ResourceLocalizationService locService=spy(new ResourceLocalizationService(dispatcher,exec,delService,diskhandler,new NMNullStateStoreService()));
  doReturn(lfs).when(locService).getLocalFileContext(isA(Configuration.class));
  try {
    dispatcher.start();
    locService.init(conf);
    final FsPermission defaultPerm=new FsPermission((short)0755);
    for (    Path p : localDirs) {
      p=new Path((new URI(p.toString())).getPath());
      Path usercache=new Path(p,ContainerLocalizer.USERCACHE);
      verify(spylfs).mkdir(eq(usercache),eq(defaultPerm),eq(true));
      Path publicCache=new Path(p,ContainerLocalizer.FILECACHE);
      verify(spylfs).mkdir(eq(publicCache),eq(defaultPerm),eq(true));
      Path nmPriv=new Path(p,ResourceLocalizationService.NM_PRIVATE_DIR);
      verify(spylfs).mkdir(eq(nmPriv),eq(ResourceLocalizationService.NM_PRIVATE_PERM),eq(true));
    }
  }
  finally {
    dispatcher.stop();
    delService.stop();
  }
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=100000) @SuppressWarnings("unchecked") public void testParallelDownloadAttemptsForPublicResource() throws Exception {
  DrainDispatcher dispatcher1=null;
  String user="testuser";
  try {
    List<Path> localDirs=new ArrayList<Path>();
    String[] sDirs=new String[1];
    for (int i=0; i < 1; ++i) {
      localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
      sDirs[i]=localDirs.get(i).toString();
    }
    conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
    EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
    dispatcher1=new DrainDispatcher();
    dispatcher1.register(ApplicationEventType.class,applicationBus);
    EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
    dispatcher1.register(ContainerEventType.class,containerBus);
    ContainerExecutor exec=mock(ContainerExecutor.class);
    DeletionService delService=mock(DeletionService.class);
    LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
    dirsHandler.init(conf);
    dispatcher1.init(conf);
    dispatcher1.start();
    ResourceLocalizationService rawService=new ResourceLocalizationService(dispatcher1,exec,delService,dirsHandler,new NMNullStateStoreService());
    ResourceLocalizationService spyService=spy(rawService);
    dispatcher1.register(LocalizationEventType.class,spyService);
    spyService.init(conf);
    Assert.assertEquals(0,spyService.getPublicLocalizer().pending.size());
    LocalResourceRequest req=new LocalResourceRequest(new Path("/tmp"),123L,LocalResourceType.FILE,LocalResourceVisibility.PUBLIC,"");
    ApplicationImpl app=mock(ApplicationImpl.class);
    ApplicationId appId=BuilderUtils.newApplicationId(1,1);
    when(app.getAppId()).thenReturn(appId);
    when(app.getUser()).thenReturn(user);
    dispatcher1.getEventHandler().handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app));
    ContainerImpl container1=createMockContainer(user,1);
    dispatcher1.getEventHandler().handle(createContainerLocalizationEvent(container1,LocalResourceVisibility.PUBLIC,req));
    Assert.assertTrue(waitForResourceState(null,spyService,req,LocalResourceVisibility.PUBLIC,user,null,ResourceState.DOWNLOADING,200));
    Assert.assertTrue(waitForPublicDownloadToStart(spyService,1,200));
    LocalizedResource lr=getLocalizedResource(spyService,req,LocalResourceVisibility.PUBLIC,user,null);
    Assert.assertEquals(ResourceState.DOWNLOADING,lr.getState());
    Assert.assertEquals(1,spyService.getPublicLocalizer().pending.size());
    Assert.assertEquals(0,lr.sem.availablePermits());
    ContainerImpl container2=createMockContainer(user,2);
    dispatcher1.getEventHandler().handle(createContainerLocalizationEvent(container2,LocalResourceVisibility.PUBLIC,req));
    Assert.assertFalse(waitForPublicDownloadToStart(spyService,2,100));
    ResourceFailedLocalizationEvent locFailedEvent=new ResourceFailedLocalizationEvent(req,new Exception("test").toString());
    spyService.getLocalResourcesTracker(LocalResourceVisibility.PUBLIC,user,null).handle(locFailedEvent);
    Assert.assertTrue(waitForResourceState(lr,spyService,req,LocalResourceVisibility.PUBLIC,user,null,ResourceState.FAILED,200));
    lr.unlock();
    spyService.getPublicLocalizer().pending.clear();
    LocalizerResourceRequestEvent localizerEvent=new LocalizerResourceRequestEvent(lr,null,mock(LocalizerContext.class),null);
    dispatcher1.getEventHandler().handle(localizerEvent);
    Assert.assertFalse(waitForPublicDownloadToStart(spyService,1,100));
    Assert.assertEquals(1,lr.sem.availablePermits());
  }
  finally {
    if (dispatcher1 != null) {
      dispatcher1.stop();
    }
  }
}

</code></pre>

<pre class="type-9 type-13 type-11 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=10000) @SuppressWarnings("unchecked") public void testLocalResourcePath() throws Exception {
  DrainDispatcher dispatcher1=null;
  try {
    dispatcher1=new DrainDispatcher();
    String user="testuser";
    ApplicationId appId=BuilderUtils.newApplicationId(1,1);
    List<Path> localDirs=new ArrayList<Path>();
    String[] sDirs=new String[1];
    for (int i=0; i < 1; ++i) {
      localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
      sDirs[i]=localDirs.get(i).toString();
    }
    conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
    LocalDirsHandlerService localDirHandler=new LocalDirsHandlerService();
    localDirHandler.init(conf);
    EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
    dispatcher1.register(ApplicationEventType.class,applicationBus);
    EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
    dispatcher1.register(ContainerEventType.class,containerBus);
    ContainerExecutor exec=mock(ContainerExecutor.class);
    DeletionService delService=mock(DeletionService.class);
    LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
    dirsHandler.init(conf);
    dispatcher1.init(conf);
    dispatcher1.start();
    ResourceLocalizationService rls=new ResourceLocalizationService(dispatcher1,exec,delService,localDirHandler,new NMNullStateStoreService());
    dispatcher1.register(LocalizationEventType.class,rls);
    rls.init(conf);
    rls.handle(createApplicationLocalizationEvent(user,appId));
    Container container1=createMockContainer(user,1);
    String localizerId1=container1.getContainerId().toString();
    rls.getPrivateLocalizers().put(localizerId1,rls.new LocalizerRunner(new LocalizerContext(user,container1.getContainerId(),null),localizerId1));
    LocalResourceRequest reqPriv=new LocalResourceRequest(new Path("file:///tmp1"),123L,LocalResourceType.FILE,LocalResourceVisibility.PRIVATE,"");
    List<LocalResourceRequest> privList=new ArrayList<LocalResourceRequest>();
    privList.add(reqPriv);
    LocalResourceRequest reqApp=new LocalResourceRequest(new Path("file:///tmp2"),123L,LocalResourceType.FILE,LocalResourceVisibility.APPLICATION,"");
    List<LocalResourceRequest> appList=new ArrayList<LocalResourceRequest>();
    appList.add(reqApp);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> rsrcs=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    rsrcs.put(LocalResourceVisibility.APPLICATION,appList);
    rsrcs.put(LocalResourceVisibility.PRIVATE,privList);
    dispatcher1.getEventHandler().handle(new ContainerLocalizationRequestEvent(container1,rsrcs));
    Assert.assertTrue(waitForPrivateDownloadToStart(rls,localizerId1,2,500));
    String userCachePath=StringUtils.join(Path.SEPARATOR,Arrays.asList(localDirs.get(0).toUri().getRawPath(),ContainerLocalizer.USERCACHE,user,ContainerLocalizer.FILECACHE));
    String userAppCachePath=StringUtils.join(Path.SEPARATOR,Arrays.asList(localDirs.get(0).toUri().getRawPath(),ContainerLocalizer.USERCACHE,user,ContainerLocalizer.APPCACHE,appId.toString(),ContainerLocalizer.FILECACHE));
    int returnedResources=0;
    boolean appRsrc=false, privRsrc=false;
    while (returnedResources < 2) {
      LocalizerHeartbeatResponse response=rls.heartbeat(createLocalizerStatus(localizerId1));
      for (      ResourceLocalizationSpec resourceSpec : response.getResourceSpecs()) {
        returnedResources++;
        Path destinationDirectory=new Path(resourceSpec.getDestinationDirectory().getFile());
        if (resourceSpec.getResource().getVisibility() == LocalResourceVisibility.APPLICATION) {
          appRsrc=true;
          Assert.assertEquals(userAppCachePath,destinationDirectory.getParent().toUri().toString());
        }
 else         if (resourceSpec.getResource().getVisibility() == LocalResourceVisibility.PRIVATE) {
          privRsrc=true;
          Assert.assertEquals(userCachePath,destinationDirectory.getParent().toUri().toString());
        }
 else {
          throw new Exception("Unexpected resource recevied.");
        }
      }
    }
    Assert.assertTrue(appRsrc && privRsrc);
  }
  finally {
    if (dispatcher1 != null) {
      dispatcher1.stop();
    }
  }
}

</code></pre>

<pre class="type-9 type-7 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
"></span><br>
@Test @SuppressWarnings("unchecked") public void testPublicResourceAddResourceExceptions() throws Exception {
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[4];
  for (int i=0; i < 4; ++i) {
    localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
    sDirs[i]=localDirs.get(i).toString();
  }
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  conf.setBoolean(Dispatcher.DISPATCHER_EXIT_ON_ERROR_KEY,true);
  DrainDispatcher dispatcher=new DrainDispatcher();
  EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
  dispatcher.register(ApplicationEventType.class,applicationBus);
  EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
  dispatcher.register(ContainerEventType.class,containerBus);
  ContainerExecutor exec=mock(ContainerExecutor.class);
  DeletionService delService=mock(DeletionService.class);
  LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
  LocalDirsHandlerService dirsHandlerSpy=spy(dirsHandler);
  dirsHandlerSpy.init(conf);
  dispatcher.init(conf);
  dispatcher.start();
  try {
    ResourceLocalizationService rawService=new ResourceLocalizationService(dispatcher,exec,delService,dirsHandlerSpy,new NMNullStateStoreService());
    ResourceLocalizationService spyService=spy(rawService);
    doReturn(mockServer).when(spyService).createServer();
    doReturn(lfs).when(spyService).getLocalFileContext(isA(Configuration.class));
    spyService.init(conf);
    spyService.start();
    final String user="user0";
    final Application app=mock(Application.class);
    final ApplicationId appId=BuilderUtils.newApplicationId(314159265358979L,3);
    when(app.getUser()).thenReturn(user);
    when(app.getAppId()).thenReturn(appId);
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app));
    dispatcher.await();
    Random r=new Random();
    r.setSeed(r.nextLong());
    final LocalResource pubResource=getPublicMockedResource(r);
    final LocalResourceRequest pubReq=new LocalResourceRequest(pubResource);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> req=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    req.put(LocalResourceVisibility.PUBLIC,Collections.singletonList(pubReq));
    final Container c=getMockContainer(appId,42,user);
    Mockito.doThrow(new IOException()).when(dirsHandlerSpy).getLocalPathForWrite(isA(String.class),Mockito.anyLong(),Mockito.anyBoolean());
    spyService.handle(new ContainerLocalizationRequestEvent(c,req));
    dispatcher.await();
    LocalResourcesTracker tracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PUBLIC,user,appId);
    Assert.assertNull(tracker.getLocalizedResource(pubReq));
    Mockito.doCallRealMethod().when(dirsHandlerSpy).getLocalPathForWrite(isA(String.class),Mockito.anyLong(),Mockito.anyBoolean());
    PublicLocalizer publicLocalizer=spyService.getPublicLocalizer();
    publicLocalizer.threadPool.shutdown();
    spyService.handle(new ContainerLocalizationRequestEvent(c,req));
    dispatcher.await();
    tracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PUBLIC,user,appId);
    Assert.assertNull(tracker.getLocalizedResource(pubReq));
  }
  finally {
    dispatcher.await();
    dispatcher.stop();
  }
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=10000) @SuppressWarnings("unchecked") public void testLocalizationHeartbeat() throws Exception {
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[1];
  localDirs.add(lfs.makeQualified(new Path(basedir,0 + "")));
  sDirs[0]=localDirs.get(0).toString();
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  conf.set(YarnConfiguration.NM_LOCAL_CACHE_MAX_FILES_PER_DIRECTORY,"37");
  DrainDispatcher dispatcher=new DrainDispatcher();
  dispatcher.init(conf);
  dispatcher.start();
  EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
  dispatcher.register(ApplicationEventType.class,applicationBus);
  EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
  dispatcher.register(ContainerEventType.class,containerBus);
  ContainerExecutor exec=mock(ContainerExecutor.class);
  LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
  dirsHandler.init(conf);
  DeletionService delServiceReal=new DeletionService(exec);
  DeletionService delService=spy(delServiceReal);
  delService.init(new Configuration());
  delService.start();
  ResourceLocalizationService rawService=new ResourceLocalizationService(dispatcher,exec,delService,dirsHandler,new NMNullStateStoreService());
  ResourceLocalizationService spyService=spy(rawService);
  doReturn(mockServer).when(spyService).createServer();
  doReturn(lfs).when(spyService).getLocalFileContext(isA(Configuration.class));
  try {
    spyService.init(conf);
    spyService.start();
    final Application app=mock(Application.class);
    final ApplicationId appId=BuilderUtils.newApplicationId(314159265358979L,3);
    when(app.getUser()).thenReturn("user0");
    when(app.getAppId()).thenReturn(appId);
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app));
    ArgumentMatcher<ApplicationEvent> matchesAppInit=new ArgumentMatcher<ApplicationEvent>(){
      @Override public boolean matches(      Object o){
        ApplicationEvent evt=(ApplicationEvent)o;
        return evt.getType() == ApplicationEventType.APPLICATION_INITED && appId == evt.getApplicationID();
      }
    }
;
    dispatcher.await();
    verify(applicationBus).handle(argThat(matchesAppInit));
    Random r=new Random();
    long seed=r.nextLong();
    System.out.println("SEED: " + seed);
    r.setSeed(seed);
    final Container c=getMockContainer(appId,42,"user0");
    FSDataOutputStream out=new FSDataOutputStream(new DataOutputBuffer(),null);
    doReturn(out).when(spylfs).createInternal(isA(Path.class),isA(EnumSet.class),isA(FsPermission.class),anyInt(),anyShort(),anyLong(),isA(Progressable.class),isA(ChecksumOpt.class),anyBoolean());
    final LocalResource resource1=getPrivateMockedResource(r);
    LocalResource resource2=null;
    do {
      resource2=getPrivateMockedResource(r);
    }
 while (resource2 == null || resource2.equals(resource1));
    final LocalResourceRequest req1=new LocalResourceRequest(resource1);
    final LocalResourceRequest req2=new LocalResourceRequest(resource2);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> rsrcs=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    List<LocalResourceRequest> privateResourceList=new ArrayList<LocalResourceRequest>();
    privateResourceList.add(req1);
    privateResourceList.add(req2);
    rsrcs.put(LocalResourceVisibility.PRIVATE,privateResourceList);
    spyService.handle(new ContainerLocalizationRequestEvent(c,rsrcs));
    Thread.sleep(1000);
    dispatcher.await();
    String appStr=ConverterUtils.toString(appId);
    String ctnrStr=c.getContainerId().toString();
    ArgumentCaptor<Path> tokenPathCaptor=ArgumentCaptor.forClass(Path.class);
    verify(exec).startLocalizer(tokenPathCaptor.capture(),isA(InetSocketAddress.class),eq("user0"),eq(appStr),eq(ctnrStr),isA(List.class),isA(List.class));
    Path localizationTokenPath=tokenPathCaptor.getValue();
    LocalResourceStatus rsrcStat1=mock(LocalResourceStatus.class);
    LocalResourceStatus rsrcStat2=mock(LocalResourceStatus.class);
    LocalizerStatus stat=mock(LocalizerStatus.class);
    when(stat.getLocalizerId()).thenReturn(ctnrStr);
    when(rsrcStat1.getResource()).thenReturn(resource1);
    when(rsrcStat2.getResource()).thenReturn(resource2);
    when(rsrcStat1.getLocalSize()).thenReturn(4344L);
    when(rsrcStat2.getLocalSize()).thenReturn(2342L);
    URL locPath=getPath("/cache/private/blah");
    when(rsrcStat1.getLocalPath()).thenReturn(locPath);
    when(rsrcStat2.getLocalPath()).thenReturn(locPath);
    when(rsrcStat1.getStatus()).thenReturn(ResourceStatusType.FETCH_SUCCESS);
    when(rsrcStat2.getStatus()).thenReturn(ResourceStatusType.FETCH_SUCCESS);
    when(stat.getResources()).thenReturn(Collections.<LocalResourceStatus>emptyList()).thenReturn(Collections.singletonList(rsrcStat1)).thenReturn(Collections.singletonList(rsrcStat2)).thenReturn(Collections.<LocalResourceStatus>emptyList());
    String localPath=Path.SEPARATOR + ContainerLocalizer.USERCACHE + Path.SEPARATOR+ "user0"+ Path.SEPARATOR+ ContainerLocalizer.FILECACHE;
    LocalizerHeartbeatResponse response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.LIVE,response.getLocalizerAction());
    assertEquals(1,response.getResourceSpecs().size());
    assertEquals(req1,new LocalResourceRequest(response.getResourceSpecs().get(0).getResource()));
    URL localizedPath=response.getResourceSpecs().get(0).getDestinationDirectory();
    assertTrue(localizedPath.getFile().endsWith(localPath + Path.SEPARATOR + "10"));
    response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.LIVE,response.getLocalizerAction());
    assertEquals(1,response.getResourceSpecs().size());
    assertEquals(req2,new LocalResourceRequest(response.getResourceSpecs().get(0).getResource()));
    localizedPath=response.getResourceSpecs().get(0).getDestinationDirectory();
    assertTrue(localizedPath.getFile().endsWith(localPath + Path.SEPARATOR + "0"+ Path.SEPARATOR+ "11"));
    response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.LIVE,response.getLocalizerAction());
    assertEquals(0,response.getResourceSpecs().size());
    response=spyService.heartbeat(stat);
    assertEquals(LocalizerAction.DIE,response.getLocalizerAction());
    dispatcher.await();
    ArgumentMatcher<ContainerEvent> matchesContainerLoc=new ArgumentMatcher<ContainerEvent>(){
      @Override public boolean matches(      Object o){
        ContainerEvent evt=(ContainerEvent)o;
        return evt.getType() == ContainerEventType.RESOURCE_LOCALIZED && c.getContainerId() == evt.getContainerID();
      }
    }
;
    verify(containerBus,times(2)).handle(argThat(matchesContainerLoc));
    verify(delService).delete((String)isNull(),eq(localizationTokenPath));
  }
  finally {
    spyService.stop();
    dispatcher.stop();
    delService.stop();
  }
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test @SuppressWarnings("unchecked") public void testResourceRelease() throws Exception {
  List<Path> localDirs=new ArrayList<Path>();
  String[] sDirs=new String[4];
  for (int i=0; i < 4; ++i) {
    localDirs.add(lfs.makeQualified(new Path(basedir,i + "")));
    sDirs[i]=localDirs.get(i).toString();
  }
  conf.setStrings(YarnConfiguration.NM_LOCAL_DIRS,sDirs);
  LocalizerTracker mockLocallilzerTracker=mock(LocalizerTracker.class);
  DrainDispatcher dispatcher=new DrainDispatcher();
  dispatcher.init(conf);
  dispatcher.start();
  EventHandler<ApplicationEvent> applicationBus=mock(EventHandler.class);
  dispatcher.register(ApplicationEventType.class,applicationBus);
  EventHandler<ContainerEvent> containerBus=mock(EventHandler.class);
  dispatcher.register(ContainerEventType.class,containerBus);
  EventHandler<LocalizerEvent> localizerBus=mock(EventHandler.class);
  dispatcher.register(LocalizerEventType.class,localizerBus);
  ContainerExecutor exec=mock(ContainerExecutor.class);
  LocalDirsHandlerService dirsHandler=new LocalDirsHandlerService();
  dirsHandler.init(conf);
  DeletionService delService=new DeletionService(exec);
  delService.init(new Configuration());
  delService.start();
  ResourceLocalizationService rawService=new ResourceLocalizationService(dispatcher,exec,delService,dirsHandler,new NMNullStateStoreService());
  ResourceLocalizationService spyService=spy(rawService);
  doReturn(mockServer).when(spyService).createServer();
  doReturn(mockLocallilzerTracker).when(spyService).createLocalizerTracker(isA(Configuration.class));
  doReturn(lfs).when(spyService).getLocalFileContext(isA(Configuration.class));
  try {
    spyService.init(conf);
    spyService.start();
    final String user="user0";
    final Application app=mock(Application.class);
    final ApplicationId appId=BuilderUtils.newApplicationId(314159265358979L,3);
    when(app.getUser()).thenReturn(user);
    when(app.getAppId()).thenReturn(appId);
    spyService.handle(new ApplicationLocalizationEvent(LocalizationEventType.INIT_APPLICATION_RESOURCES,app));
    dispatcher.await();
    LocalResourcesTracker appTracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.APPLICATION,user,appId);
    LocalResourcesTracker privTracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PRIVATE,user,appId);
    LocalResourcesTracker pubTracker=spyService.getLocalResourcesTracker(LocalResourceVisibility.PUBLIC,user,appId);
    final Container c=getMockContainer(appId,42,user);
    Random r=new Random();
    long seed=r.nextLong();
    System.out.println("SEED: " + seed);
    r.setSeed(seed);
    final LocalResource privResource=getPrivateMockedResource(r);
    final LocalResourceRequest privReq=new LocalResourceRequest(privResource);
    final LocalResource pubResource=getPublicMockedResource(r);
    final LocalResourceRequest pubReq=new LocalResourceRequest(pubResource);
    final LocalResource pubResource2=getPublicMockedResource(r);
    final LocalResourceRequest pubReq2=new LocalResourceRequest(pubResource2);
    final LocalResource appResource=getAppMockedResource(r);
    final LocalResourceRequest appReq=new LocalResourceRequest(appResource);
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> req=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    req.put(LocalResourceVisibility.PRIVATE,Collections.singletonList(privReq));
    req.put(LocalResourceVisibility.PUBLIC,Collections.singletonList(pubReq));
    req.put(LocalResourceVisibility.APPLICATION,Collections.singletonList(appReq));
    Map<LocalResourceVisibility,Collection<LocalResourceRequest>> req2=new HashMap<LocalResourceVisibility,Collection<LocalResourceRequest>>();
    req2.put(LocalResourceVisibility.PRIVATE,Collections.singletonList(privReq));
    req2.put(LocalResourceVisibility.PUBLIC,Collections.singletonList(pubReq2));
    Set<LocalResourceRequest> pubRsrcs=new HashSet<LocalResourceRequest>();
    pubRsrcs.add(pubReq);
    pubRsrcs.add(pubReq2);
    spyService.handle(new ContainerLocalizationRequestEvent(c,req));
    spyService.handle(new ContainerLocalizationRequestEvent(c,req2));
    dispatcher.await();
    int privRsrcCount=0;
    for (    LocalizedResource lr : privTracker) {
      privRsrcCount++;
      Assert.assertEquals("Incorrect reference count",2,lr.getRefCount());
      Assert.assertEquals(privReq,lr.getRequest());
    }
    Assert.assertEquals(1,privRsrcCount);
    int pubRsrcCount=0;
    for (    LocalizedResource lr : pubTracker) {
      pubRsrcCount++;
      Assert.assertEquals("Incorrect reference count",1,lr.getRefCount());
      pubRsrcs.remove(lr.getRequest());
    }
    Assert.assertEquals(0,pubRsrcs.size());
    Assert.assertEquals(2,pubRsrcCount);
    int appRsrcCount=0;
    for (    LocalizedResource lr : appTracker) {
      appRsrcCount++;
      Assert.assertEquals("Incorrect reference count",1,lr.getRefCount());
      Assert.assertEquals(appReq,lr.getRequest());
    }
    Assert.assertEquals(1,appRsrcCount);
    spyService.handle(new ContainerLocalizationCleanupEvent(c,req));
    verify(mockLocallilzerTracker).cleanupPrivLocalizers("container_314159265358979_0003_01_000042");
    req2.remove(LocalResourceVisibility.PRIVATE);
    spyService.handle(new ContainerLocalizationCleanupEvent(c,req2));
    dispatcher.await();
    pubRsrcs.add(pubReq);
    pubRsrcs.add(pubReq2);
    privRsrcCount=0;
    for (    LocalizedResource lr : privTracker) {
      privRsrcCount++;
      Assert.assertEquals("Incorrect reference count",1,lr.getRefCount());
      Assert.assertEquals(privReq,lr.getRequest());
    }
    Assert.assertEquals(1,privRsrcCount);
    pubRsrcCount=0;
    for (    LocalizedResource lr : pubTracker) {
      pubRsrcCount++;
      Assert.assertEquals("Incorrect reference count",0,lr.getRefCount());
      pubRsrcs.remove(lr.getRequest());
    }
    Assert.assertEquals(0,pubRsrcs.size());
    Assert.assertEquals(2,pubRsrcCount);
    appRsrcCount=0;
    for (    LocalizedResource lr : appTracker) {
      appRsrcCount++;
      Assert.assertEquals("Incorrect reference count",0,lr.getRefCount());
      Assert.assertEquals(appReq,lr.getRequest());
    }
    Assert.assertEquals(1,appRsrcCount);
  }
  finally {
    dispatcher.stop();
    delService.stop();
  }
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setup() throws IOException {
  conf=new Configuration();
  spylfs=spy(FileContext.getLocalFSFileContext().getDefaultFileSystem());
  lfs=FileContext.getFileContext(spylfs,conf);
  doNothing().when(spylfs).mkdir(isA(Path.class),isA(FsPermission.class),anyBoolean());
  String logDir=lfs.makeQualified(new Path(basedir,"logdir ")).toString();
  conf.set(YarnConfiguration.NM_LOG_DIRS,logDir);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
