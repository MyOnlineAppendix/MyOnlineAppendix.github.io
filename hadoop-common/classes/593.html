<h3 style="margin:0px">Class: org.apache.hadoop.hdfs.server.namenode.snapshot.TestRenameWithSnapshots (38 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(31)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(30)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(23)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(22)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(19)</kbd></button>&nbsp;<button id="19"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('19')" data-toggle="tooltip" title="Verifies whether two objects/variables are the same"><kbd id="tag-19"class="label-info"style="display: inline-block;font-size:7pt" >IdentityVerifier&nbsp;(8)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(5)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-9 type-2 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=300000) public void testRenameFromSDir2NonSDir() throws Exception {
  final String dirStr="/testRenameWithSnapshot";
  final String abcStr=dirStr + "/abc";
  final Path abc=new Path(abcStr);
  hdfs.mkdirs(abc,new FsPermission((short)0777));
  hdfs.allowSnapshot(abc);
  final Path foo=new Path(abc,"foo");
  DFSTestUtil.createFile(hdfs,foo,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(abc,"s0");
  try {
    hdfs.rename(abc,new Path(dirStr,"tmp"));
    fail("Expect exception since " + abc + " is snapshottable and already has snapshots");
  }
 catch (  IOException e) {
    GenericTestUtils.assertExceptionContains(abcStr + " is snapshottable and already has snapshots",e);
  }
  final String xyzStr=dirStr + "/xyz";
  final Path xyz=new Path(xyzStr);
  hdfs.mkdirs(xyz,new FsPermission((short)0777));
  final Path bar=new Path(xyz,"bar");
  hdfs.rename(foo,bar);
  final INode fooRef=fsdir.getINode(SnapshotTestHelper.getSnapshotPath(abc,"s0","foo").toString());
  Assert.assertTrue(fooRef.isReference());
  Assert.assertTrue(fooRef.asReference() instanceof INodeReference.WithName);
  final INodeReference.WithCount withCount=(INodeReference.WithCount)fooRef.asReference().getReferredINode();
  Assert.assertEquals(2,withCount.getReferenceCount());
  final INode barRef=fsdir.getINode(bar.toString());
  Assert.assertTrue(barRef.isReference());
  Assert.assertSame(withCount,barRef.asReference().getReferredINode());
  hdfs.delete(bar,false);
  Assert.assertEquals(1,withCount.getReferenceCount());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Make sure we clean the whole subtree under a DstReference node after 
 * deleting a snapshot.
 * see HDFS-5476.
 */
@Test public void testCleanDstReference() throws Exception {
  final Path test=new Path("/test");
  final Path foo=new Path(test,"foo");
  final Path bar=new Path(foo,"bar");
  hdfs.mkdirs(bar);
  SnapshotTestHelper.createSnapshot(hdfs,test,"s0");
  final Path fileInBar=new Path(bar,"file");
  DFSTestUtil.createFile(hdfs,fileInBar,BLOCKSIZE,REPL,SEED);
  final Path foo2=new Path(test,"foo2");
  hdfs.rename(foo,foo2);
  hdfs.createSnapshot(test,"s1");
  hdfs.delete(new Path(foo2,"bar"),true);
  hdfs.delete(foo2,true);
  final Path sfileInBar=SnapshotTestHelper.getSnapshotPath(test,"s1","foo2/bar/file");
  assertTrue(hdfs.exists(sfileInBar));
  hdfs.deleteSnapshot(test,"s1");
  assertFalse(hdfs.exists(sfileInBar));
  restartClusterAndCheckImage(true);
  final Path barInS0=SnapshotTestHelper.getSnapshotPath(test,"s0","foo/bar");
  INodeDirectory barNode=fsdir.getINode(barInS0.toString()).asDirectory();
  assertEquals(0,barNode.getChildrenList(Snapshot.CURRENT_STATE_ID).size());
  List<DirectoryDiff> diffList=barNode.getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  assertEquals(0,diff.getChildrenDiff().getList(ListType.DELETED).size());
  assertEquals(0,diff.getChildrenDiff().getList(ListType.CREATED).size());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test the undo section of rename. Before the rename, we create the renamed 
 * file/dir before taking the snapshot.
 */
@Test public void testRenameUndo_1() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  final Path dir2file=new Path(sdir2,"file");
  DFSTestUtil.createFile(hdfs,dir2file,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  INodeDirectory dir2=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  INodeDirectory mockDir2=spy(dir2);
  doReturn(false).when(mockDir2).addChild((INode)anyObject(),anyBoolean(),Mockito.anyInt());
  INodeDirectory root=fsdir.getINode4Write("/").asDirectory();
  root.replaceChild(dir2,mockDir2,fsdir.getINodeMap());
  final Path newfoo=new Path(sdir2,"foo");
  boolean result=hdfs.rename(foo,newfoo);
  assertFalse(result);
  INodeDirectory dir1Node=fsdir.getINode4Write(sdir1.toString()).asDirectory();
  Snapshot s1=dir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  ReadOnlyList<INode> dir1Children=dir1Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir1Children.size());
  assertEquals(foo.getName(),dir1Children.get(0).getLocalName());
  List<DirectoryDiff> dir1Diffs=dir1Node.getDiffs().asList();
  assertEquals(1,dir1Diffs.size());
  assertEquals(s1.getId(),dir1Diffs.get(0).getSnapshotId());
  ChildrenDiff childrenDiff=dir1Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(0,childrenDiff.getList(ListType.CREATED).size());
  INode fooNode=fsdir.getINode4Write(foo.toString());
  assertTrue(fooNode.isDirectory() && fooNode.asDirectory().isWithSnapshot());
  List<DirectoryDiff> fooDiffs=fooNode.asDirectory().getDiffs().asList();
  assertEquals(1,fooDiffs.size());
  assertEquals(s1.getId(),fooDiffs.get(0).getSnapshotId());
  final Path foo_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","foo");
  INode fooNode_s1=fsdir.getINode(foo_s1.toString());
  assertTrue(fooNode_s1 == fooNode);
  assertFalse(hdfs.exists(newfoo));
  INodeDirectory dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  assertFalse(dir2Node.isWithSnapshot());
  ReadOnlyList<INode> dir2Children=dir2Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir2Children.size());
  assertEquals(dir2file.getName(),dir2Children.get(0).getLocalName());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Unit test for HDFS-4842.
 */
@Test public void testRenameDirAndDeleteSnapshot_7() throws Exception {
  fsn.getSnapshotManager().setAllowNestedSnapshots(true);
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(dir2);
  final Path foo=new Path(dir2,"foo");
  final Path bar=new Path(foo,"bar");
  final Path file=new Path(bar,"file");
  DFSTestUtil.createFile(hdfs,file,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,test,"s0");
  SnapshotTestHelper.createSnapshot(hdfs,test,"s1");
  hdfs.delete(file,true);
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  final Path newfoo=new Path(dir1,foo.getName());
  hdfs.rename(foo,newfoo);
  hdfs.deleteSnapshot(test,"s1");
  final Path file_s2=SnapshotTestHelper.getSnapshotPath(dir2,"s2","foo/bar/file");
  assertFalse(hdfs.exists(file_s2));
  final Path file_s0=SnapshotTestHelper.getSnapshotPath(test,"s0","dir2/foo/bar/file");
  assertTrue(hdfs.exists(file_s0));
  INodeDirectory dir1Node=fsdir.getINode4Write(dir1.toString()).asDirectory();
  List<DirectoryDiff> dir1DiffList=dir1Node.getDiffs().asList();
  assertEquals(1,dir1DiffList.size());
  List<INode> dList=dir1DiffList.get(0).getChildrenDiff().getList(ListType.DELETED);
  assertTrue(dList.isEmpty());
  List<INode> cList=dir1DiffList.get(0).getChildrenDiff().getList(ListType.CREATED);
  assertEquals(1,cList.size());
  INode cNode=cList.get(0);
  INode fooNode=fsdir.getINode4Write(newfoo.toString());
  assertSame(cNode,fooNode);
  final Path newbar=new Path(newfoo,bar.getName());
  INodeDirectory barNode=fsdir.getINode4Write(newbar.toString()).asDirectory();
  assertSame(fooNode.asDirectory(),barNode.getParent());
  List<DirectoryDiff> barDiffList=barNode.getDiffs().asList();
  assertEquals(1,barDiffList.size());
  DirectoryDiff diff=barDiffList.get(0);
  INodeDirectory testNode=fsdir.getINode4Write(test.toString()).asDirectory();
  Snapshot s0=testNode.getSnapshot(DFSUtil.string2Bytes("s0"));
  assertEquals(s0.getId(),diff.getSnapshotId());
  assertEquals("file",diff.getChildrenDiff().getList(ListType.DELETED).get(0).getLocalName());
  INodeDirectory dir2Node=fsdir.getINode4Write(dir2.toString()).asDirectory();
  List<DirectoryDiff> dir2DiffList=dir2Node.getDiffs().asList();
  assertEquals(1,dir2DiffList.size());
  dList=dir2DiffList.get(0).getChildrenDiff().getList(ListType.DELETED);
  assertEquals(1,dList.size());
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(dir2,"s2",foo.getName());
  INodeReference.WithName fooNode_s2=(INodeReference.WithName)fsdir.getINode(foo_s2.toString());
  assertSame(dList.get(0),fooNode_s2);
  assertSame(fooNode.asReference().getReferredINode(),fooNode_s2.getReferredINode());
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Rename a file and then append the same file. 
 */
@Test public void testRenameAndAppend() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir1,"foo");
  DFSTestUtil.createFile(hdfs,foo,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,snap1);
  final Path foo2=new Path(sdir2,"foo");
  hdfs.rename(foo,foo2);
  INode fooRef=fsdir.getINode4Write(foo2.toString());
  assertTrue(fooRef instanceof INodeReference.DstReference);
  FSDataOutputStream out=hdfs.append(foo2);
  try {
    byte[] content=new byte[1024];
    (new Random()).nextBytes(content);
    out.write(content);
    fooRef=fsdir.getINode4Write(foo2.toString());
    assertTrue(fooRef instanceof INodeReference.DstReference);
    INodeFile fooNode=fooRef.asFile();
    assertTrue(fooNode.isWithSnapshot());
    assertTrue(fooNode.isUnderConstruction());
  }
  finally {
    if (out != null) {
      out.close();
    }
  }
  fooRef=fsdir.getINode4Write(foo2.toString());
  assertTrue(fooRef instanceof INodeReference.DstReference);
  INodeFile fooNode=fooRef.asFile();
  assertTrue(fooNode.isWithSnapshot());
  assertFalse(fooNode.isUnderConstruction());
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test the undo section of rename. Before the rename, we create the renamed 
 * file/dir after taking the snapshot.
 */
@Test public void testRenameUndo_2() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path dir2file=new Path(sdir2,"file");
  DFSTestUtil.createFile(hdfs,dir2file,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  INodeDirectory dir2=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  INodeDirectory mockDir2=spy(dir2);
  doReturn(false).when(mockDir2).addChild((INode)anyObject(),anyBoolean(),Mockito.anyInt());
  INodeDirectory root=fsdir.getINode4Write("/").asDirectory();
  root.replaceChild(dir2,mockDir2,fsdir.getINodeMap());
  final Path newfoo=new Path(sdir2,"foo");
  boolean result=hdfs.rename(foo,newfoo);
  assertFalse(result);
  INodeDirectory dir1Node=fsdir.getINode4Write(sdir1.toString()).asDirectory();
  Snapshot s1=dir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  ReadOnlyList<INode> dir1Children=dir1Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir1Children.size());
  assertEquals(foo.getName(),dir1Children.get(0).getLocalName());
  List<DirectoryDiff> dir1Diffs=dir1Node.getDiffs().asList();
  assertEquals(1,dir1Diffs.size());
  assertEquals(s1.getId(),dir1Diffs.get(0).getSnapshotId());
  ChildrenDiff childrenDiff=dir1Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(1,childrenDiff.getList(ListType.CREATED).size());
  INode fooNode=fsdir.getINode4Write(foo.toString());
  assertTrue(fooNode instanceof INodeDirectory);
  assertTrue(childrenDiff.getList(ListType.CREATED).get(0) == fooNode);
  final Path foo_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","foo");
  assertFalse(hdfs.exists(foo_s1));
  assertFalse(hdfs.exists(newfoo));
  INodeDirectory dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  assertFalse(dir2Node.isWithSnapshot());
  ReadOnlyList<INode> dir2Children=dir2Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir2Children.size());
  assertEquals(dir2file.getName(),dir2Children.get(0).getLocalName());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test rename a dir and a file multiple times across snapshottable 
 * directories: /dir1/foo -> /dir2/foo -> /dir3/foo -> /dir2/foo -> /dir1/foo
 * Only create snapshots in the beginning (before the rename).
 */
@Test public void testRenameMoreThanOnceAcrossSnapDirs() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path sdir3=new Path("/dir3");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  hdfs.mkdirs(sdir3);
  final Path foo_dir1=new Path(sdir1,"foo");
  final Path bar1_dir1=new Path(foo_dir1,"bar1");
  final Path bar2_dir1=new Path(sdir1,"bar");
  DFSTestUtil.createFile(hdfs,bar1_dir1,BLOCKSIZE,REPL,SEED);
  DFSTestUtil.createFile(hdfs,bar2_dir1,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  SnapshotTestHelper.createSnapshot(hdfs,sdir3,"s3");
  final Path foo_dir2=new Path(sdir2,"foo");
  hdfs.rename(foo_dir1,foo_dir2);
  final Path bar2_dir2=new Path(sdir2,"bar");
  hdfs.rename(bar2_dir1,bar2_dir2);
  restartClusterAndCheckImage(true);
  final Path bar1_dir2=new Path(foo_dir2,"bar1");
  hdfs.setReplication(bar1_dir2,REPL_1);
  hdfs.setReplication(bar2_dir2,REPL_1);
  final Path bar1_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","foo/bar1");
  final Path bar2_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","bar");
  final Path bar1_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar1");
  final Path bar2_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","bar");
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar2_s1));
  assertFalse(hdfs.exists(bar1_s2));
  assertFalse(hdfs.exists(bar2_s2));
  FileStatus statusBar1=hdfs.getFileStatus(bar1_s1);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_dir2);
  assertEquals(REPL_1,statusBar1.getReplication());
  FileStatus statusBar2=hdfs.getFileStatus(bar2_s1);
  assertEquals(REPL,statusBar2.getReplication());
  statusBar2=hdfs.getFileStatus(bar2_dir2);
  assertEquals(REPL_1,statusBar2.getReplication());
  final Path foo_dir3=new Path(sdir3,"foo");
  hdfs.rename(foo_dir2,foo_dir3);
  final Path bar2_dir3=new Path(sdir3,"bar");
  hdfs.rename(bar2_dir2,bar2_dir3);
  restartClusterAndCheckImage(true);
  final Path bar1_dir3=new Path(foo_dir3,"bar1");
  hdfs.setReplication(bar1_dir3,REPL_2);
  hdfs.setReplication(bar2_dir3,REPL_2);
  final Path bar1_s3=SnapshotTestHelper.getSnapshotPath(sdir3,"s3","foo/bar1");
  final Path bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir3,"s3","bar");
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar2_s1));
  assertFalse(hdfs.exists(bar1_s2));
  assertFalse(hdfs.exists(bar2_s2));
  assertFalse(hdfs.exists(bar1_s3));
  assertFalse(hdfs.exists(bar2_s3));
  statusBar1=hdfs.getFileStatus(bar1_s1);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_dir3);
  assertEquals(REPL_2,statusBar1.getReplication());
  statusBar2=hdfs.getFileStatus(bar2_s1);
  assertEquals(REPL,statusBar2.getReplication());
  statusBar2=hdfs.getFileStatus(bar2_dir3);
  assertEquals(REPL_2,statusBar2.getReplication());
  hdfs.rename(foo_dir3,foo_dir2);
  hdfs.rename(bar2_dir3,bar2_dir2);
  restartClusterAndCheckImage(true);
  hdfs.setReplication(bar1_dir2,REPL);
  hdfs.setReplication(bar2_dir2,REPL);
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar2_s1));
  assertFalse(hdfs.exists(bar1_s2));
  assertFalse(hdfs.exists(bar2_s2));
  assertFalse(hdfs.exists(bar1_s3));
  assertFalse(hdfs.exists(bar2_s3));
  statusBar1=hdfs.getFileStatus(bar1_s1);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_dir2);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar2=hdfs.getFileStatus(bar2_s1);
  assertEquals(REPL,statusBar2.getReplication());
  statusBar2=hdfs.getFileStatus(bar2_dir2);
  assertEquals(REPL,statusBar2.getReplication());
  hdfs.rename(foo_dir2,foo_dir1);
  hdfs.rename(bar2_dir2,bar2_dir1);
  INodeReference fooRef=fsdir.getINode4Write(foo_dir1.toString()).asReference();
  INodeReference.WithCount fooWithCount=(WithCount)fooRef.getReferredINode();
  assertEquals(2,fooWithCount.getReferenceCount());
  INodeDirectory foo=fooWithCount.asDirectory();
  assertEquals(1,foo.getDiffs().asList().size());
  INodeDirectory sdir1Node=fsdir.getINode(sdir1.toString()).asDirectory();
  Snapshot s1=sdir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  assertEquals(s1.getId(),foo.getDirectoryWithSnapshotFeature().getLastSnapshotId());
  INodeFile bar1=fsdir.getINode4Write(bar1_dir1.toString()).asFile();
  assertEquals(1,bar1.getDiffs().asList().size());
  assertEquals(s1.getId(),bar1.getDiffs().getLastSnapshotId());
  INodeReference barRef=fsdir.getINode4Write(bar2_dir1.toString()).asReference();
  INodeReference.WithCount barWithCount=(WithCount)barRef.getReferredINode();
  assertEquals(2,barWithCount.getReferenceCount());
  INodeFile bar=barWithCount.asFile();
  assertEquals(1,bar.getDiffs().asList().size());
  assertEquals(s1.getId(),bar.getDiffs().getLastSnapshotId());
  restartClusterAndCheckImage(true);
  hdfs.delete(foo_dir1,true);
  hdfs.delete(bar2_dir1,true);
  restartClusterAndCheckImage(true);
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar2_s1));
  assertFalse(hdfs.exists(bar1_s2));
  assertFalse(hdfs.exists(bar2_s2));
  assertFalse(hdfs.exists(bar1_s3));
  assertFalse(hdfs.exists(bar2_s3));
  assertFalse(hdfs.exists(foo_dir1));
  assertFalse(hdfs.exists(bar1_dir1));
  assertFalse(hdfs.exists(bar2_dir1));
  statusBar1=hdfs.getFileStatus(bar1_s1);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar2=hdfs.getFileStatus(bar2_s1);
  assertEquals(REPL,statusBar2.getReplication());
  final Path foo_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","foo");
  fooRef=fsdir.getINode(foo_s1.toString()).asReference();
  fooWithCount=(WithCount)fooRef.getReferredINode();
  assertEquals(1,fooWithCount.getReferenceCount());
  barRef=fsdir.getINode(bar2_s1.toString()).asReference();
  barWithCount=(WithCount)barRef.getReferredINode();
  assertEquals(1,barWithCount.getReferenceCount());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test the undo section of the second-time rename.
 */
@Test public void testRenameUndo_3() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path sdir3=new Path("/dir3");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  hdfs.mkdirs(sdir3);
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  INodeDirectory dir3=fsdir.getINode4Write(sdir3.toString()).asDirectory();
  INodeDirectory mockDir3=spy(dir3);
  doReturn(false).when(mockDir3).addChild((INode)anyObject(),anyBoolean(),Mockito.anyInt());
  INodeDirectory root=fsdir.getINode4Write("/").asDirectory();
  root.replaceChild(dir3,mockDir3,fsdir.getINodeMap());
  final Path foo_dir2=new Path(sdir2,"foo2");
  final Path foo_dir3=new Path(sdir3,"foo3");
  hdfs.rename(foo,foo_dir2);
  boolean result=hdfs.rename(foo_dir2,foo_dir3);
  assertFalse(result);
  INodeDirectory dir1Node=fsdir.getINode4Write(sdir1.toString()).asDirectory();
  Snapshot s1=dir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  INodeDirectory dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  Snapshot s2=dir2Node.getSnapshot(DFSUtil.string2Bytes("s2"));
  ReadOnlyList<INode> dir2Children=dir2Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir2Children.size());
  List<DirectoryDiff> dir2Diffs=dir2Node.getDiffs().asList();
  assertEquals(1,dir2Diffs.size());
  assertEquals(s2.getId(),dir2Diffs.get(0).getSnapshotId());
  ChildrenDiff childrenDiff=dir2Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(1,childrenDiff.getList(ListType.CREATED).size());
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo2");
  assertFalse(hdfs.exists(foo_s2));
  INode fooNode=fsdir.getINode4Write(foo_dir2.toString());
  assertTrue(childrenDiff.getList(ListType.CREATED).get(0) == fooNode);
  assertTrue(fooNode instanceof INodeReference.DstReference);
  List<DirectoryDiff> fooDiffs=fooNode.asDirectory().getDiffs().asList();
  assertEquals(1,fooDiffs.size());
  assertEquals(s1.getId(),fooDiffs.get(0).getSnapshotId());
  hdfs.createSnapshot(sdir2,"s3");
  result=hdfs.rename(foo_dir2,foo_dir3);
  assertFalse(result);
  dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  Snapshot s3=dir2Node.getSnapshot(DFSUtil.string2Bytes("s3"));
  fooNode=fsdir.getINode4Write(foo_dir2.toString());
  dir2Children=dir2Node.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,dir2Children.size());
  dir2Diffs=dir2Node.getDiffs().asList();
  assertEquals(2,dir2Diffs.size());
  assertEquals(s2.getId(),dir2Diffs.get(0).getSnapshotId());
  assertEquals(s3.getId(),dir2Diffs.get(1).getSnapshotId());
  childrenDiff=dir2Diffs.get(0).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(1,childrenDiff.getList(ListType.CREATED).size());
  assertTrue(childrenDiff.getList(ListType.CREATED).get(0) == fooNode);
  childrenDiff=dir2Diffs.get(1).getChildrenDiff();
  assertEquals(0,childrenDiff.getList(ListType.DELETED).size());
  assertEquals(0,childrenDiff.getList(ListType.CREATED).size());
  final Path foo_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo2");
  assertFalse(hdfs.exists(foo_s2));
  assertTrue(hdfs.exists(foo_s3));
  assertTrue(fooNode instanceof INodeReference.DstReference);
  fooDiffs=fooNode.asDirectory().getDiffs().asList();
  assertEquals(2,fooDiffs.size());
  assertEquals(s1.getId(),fooDiffs.get(0).getSnapshotId());
  assertEquals(s3.getId(),fooDiffs.get(1).getSnapshotId());
}

</code></pre>

<pre class="type-2 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test undo where dst node being overwritten is a reference node
 */
@Test public void testRenameUndo_4() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path sdir3=new Path("/dir3");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  hdfs.mkdirs(sdir3);
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  final Path foo2=new Path(sdir2,"foo2");
  hdfs.mkdirs(foo2);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  final Path foo3=new Path(sdir3,"foo3");
  hdfs.rename(foo2,foo3);
  INode foo3Node=fsdir.getINode4Write(foo3.toString());
  assertTrue(foo3Node.isReference());
  INodeDirectory dir3=fsdir.getINode4Write(sdir3.toString()).asDirectory();
  INodeDirectory mockDir3=spy(dir3);
  doReturn(false).when(mockDir3).addChild((INode)Mockito.isNull(),anyBoolean(),Mockito.anyInt());
  Mockito.when(mockDir3.addChild((INode)Mockito.isNotNull(),anyBoolean(),Mockito.anyInt())).thenReturn(false).thenCallRealMethod();
  INodeDirectory root=fsdir.getINode4Write("/").asDirectory();
  root.replaceChild(dir3,mockDir3,fsdir.getINodeMap());
  foo3Node.setParent(mockDir3);
  try {
    hdfs.rename(foo,foo3,Rename.OVERWRITE);
    fail("the rename from " + foo + " to "+ foo3+ " should fail");
  }
 catch (  IOException e) {
    GenericTestUtils.assertExceptionContains("rename from " + foo + " to "+ foo3+ " failed.",e);
  }
  final INode foo3Node_undo=fsdir.getINode4Write(foo3.toString());
  assertSame(foo3Node,foo3Node_undo);
  INodeReference.WithCount foo3_wc=(WithCount)foo3Node.asReference().getReferredINode();
  assertEquals(2,foo3_wc.getReferenceCount());
  assertSame(foo3Node,foo3_wc.getParentReference());
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Rename a file under a snapshottable directory, file does not exist
 * in a snapshot.
 */
@Test(timeout=60000) public void testRenameFileNotInSnapshot() throws Exception {
  hdfs.mkdirs(sub1);
  hdfs.allowSnapshot(sub1);
  hdfs.createSnapshot(sub1,snap1);
  DFSTestUtil.createFile(hdfs,file1,BLOCKSIZE,REPL,SEED);
  hdfs.rename(file1,file2);
  SnapshotDiffReport diffReport=hdfs.getSnapshotDiffReport(sub1,snap1,"");
  List<DiffReportEntry> entries=diffReport.getDiffList();
  assertTrue(entries.size() == 2);
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.CREATE,file2.getName(),null));
}

</code></pre>

<pre class="type-9 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * After the following operations:
 * Rename a dir -> create a snapshot s on dst tree -> rename the renamed dir
 * again -> delete snapshot s on dst tree
 * Make sure we only delete the snapshot s under the renamed dir.
 */
@Test public void testRenameDirAndDeleteSnapshot_4() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  hdfs.mkdirs(sdir2);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  final Path foo2=new Path(sdir2,"foo");
  hdfs.rename(foo,foo2);
  final Path bar2=new Path(foo2,"bar2");
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  final Path bar3=new Path(foo2,"bar3");
  DFSTestUtil.createFile(hdfs,bar3,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sdir2,"s3");
  hdfs.rename(foo2,foo);
  hdfs.deleteSnapshot(sdir2,"s3");
  final INodeDirectory dir1Node=fsdir.getINode4Write(sdir1.toString()).asDirectory();
  Quota.Counts q1=dir1Node.getDirectoryWithQuotaFeature().getSpaceConsumed();
  assertEquals(9,q1.get(Quota.NAMESPACE));
  final INodeDirectory dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  Quota.Counts q2=dir2Node.getDirectoryWithQuotaFeature().getSpaceConsumed();
  assertEquals(2,q2.get(Quota.NAMESPACE));
  final Path foo_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1",foo.getName());
  final INode fooRef=fsdir.getINode(foo_s1.toString());
  assertTrue(fooRef instanceof INodeReference.WithName);
  INodeReference.WithCount wc=(WithCount)fooRef.asReference().getReferredINode();
  assertEquals(2,wc.getReferenceCount());
  INodeDirectory fooNode=wc.getReferredINode().asDirectory();
  ReadOnlyList<INode> children=fooNode.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(3,children.size());
  assertEquals(bar.getName(),children.get(0).getLocalName());
  assertEquals(bar2.getName(),children.get(1).getLocalName());
  assertEquals(bar3.getName(),children.get(2).getLocalName());
  List<DirectoryDiff> diffList=fooNode.getDiffs().asList();
  assertEquals(1,diffList.size());
  Snapshot s1=dir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  assertEquals(s1.getId(),diffList.get(0).getSnapshotId());
  ChildrenDiff diff=diffList.get(0).getChildrenDiff();
  assertEquals(2,diff.getList(ListType.CREATED).size());
  assertEquals(0,diff.getList(ListType.DELETED).size());
  final INode fooRef2=fsdir.getINode4Write(foo.toString());
  assertTrue(fooRef2 instanceof INodeReference.DstReference);
  INodeReference.WithCount wc2=(WithCount)fooRef2.asReference().getReferredINode();
  assertSame(wc,wc2);
  assertSame(fooRef2,wc.getParentReference());
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * move a directory to its prior descedant
 */
@Test public void testRename2PreDescendant_3() throws Exception {
  final Path root=new Path("/");
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  final Path fileInBar=new Path(bar,"file");
  hdfs.mkdirs(bar);
  hdfs.mkdirs(sdir2);
  DFSTestUtil.createFile(hdfs,fileInBar,BLOCKSIZE,REPL,SEED);
  hdfs.setQuota(sdir1,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  hdfs.setQuota(sdir2,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  hdfs.setQuota(foo,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  hdfs.setQuota(bar,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  SnapshotTestHelper.createSnapshot(hdfs,root,snap1);
  hdfs.delete(fileInBar,true);
  SnapshotTestHelper.createSnapshot(hdfs,root,snap2);
  final Path bar2=new Path(sdir2,"bar2");
  hdfs.rename(bar,bar2);
  final Path foo2=new Path(bar2,"foo2");
  hdfs.rename(foo,foo2);
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(root,snap1);
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test rename a dir multiple times across snapshottable directories: 
 * /dir1/foo -> /dir2/foo -> /dir3/foo -> /dir2/foo -> /dir1/foo
 * Create snapshots after each rename.
 */
@Test public void testRenameMoreThanOnceAcrossSnapDirs_2() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path sdir3=new Path("/dir3");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  hdfs.mkdirs(sdir3);
  final Path foo_dir1=new Path(sdir1,"foo");
  final Path bar1_dir1=new Path(foo_dir1,"bar1");
  final Path bar_dir1=new Path(sdir1,"bar");
  DFSTestUtil.createFile(hdfs,bar1_dir1,BLOCKSIZE,REPL,SEED);
  DFSTestUtil.createFile(hdfs,bar_dir1,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  SnapshotTestHelper.createSnapshot(hdfs,sdir3,"s3");
  final Path foo_dir2=new Path(sdir2,"foo");
  hdfs.rename(foo_dir1,foo_dir2);
  final Path bar_dir2=new Path(sdir2,"bar");
  hdfs.rename(bar_dir1,bar_dir2);
  final Path bar1_dir2=new Path(foo_dir2,"bar1");
  hdfs.setReplication(bar1_dir2,REPL_1);
  hdfs.setReplication(bar_dir2,REPL_1);
  restartClusterAndCheckImage(true);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s11");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s22");
  SnapshotTestHelper.createSnapshot(hdfs,sdir3,"s33");
  final Path foo_dir3=new Path(sdir3,"foo");
  hdfs.rename(foo_dir2,foo_dir3);
  final Path bar_dir3=new Path(sdir3,"bar");
  hdfs.rename(bar_dir2,bar_dir3);
  final Path bar1_dir3=new Path(foo_dir3,"bar1");
  hdfs.setReplication(bar1_dir3,REPL_2);
  hdfs.setReplication(bar_dir3,REPL_2);
  restartClusterAndCheckImage(true);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s111");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s222");
  SnapshotTestHelper.createSnapshot(hdfs,sdir3,"s333");
  final Path bar1_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","foo/bar1");
  final Path bar1_s22=SnapshotTestHelper.getSnapshotPath(sdir2,"s22","foo/bar1");
  final Path bar1_s333=SnapshotTestHelper.getSnapshotPath(sdir3,"s333","foo/bar1");
  final Path bar_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1","bar");
  final Path bar_s22=SnapshotTestHelper.getSnapshotPath(sdir2,"s22","bar");
  final Path bar_s333=SnapshotTestHelper.getSnapshotPath(sdir3,"s333","bar");
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar1_s22));
  assertTrue(hdfs.exists(bar1_s333));
  assertTrue(hdfs.exists(bar_s1));
  assertTrue(hdfs.exists(bar_s22));
  assertTrue(hdfs.exists(bar_s333));
  FileStatus statusBar1=hdfs.getFileStatus(bar1_s1);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_dir3);
  assertEquals(REPL_2,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_s22);
  assertEquals(REPL_1,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_s333);
  assertEquals(REPL_2,statusBar1.getReplication());
  FileStatus statusBar=hdfs.getFileStatus(bar_s1);
  assertEquals(REPL,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_dir3);
  assertEquals(REPL_2,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_s22);
  assertEquals(REPL_1,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_s333);
  assertEquals(REPL_2,statusBar.getReplication());
  hdfs.rename(foo_dir3,foo_dir2);
  hdfs.rename(bar_dir3,bar_dir2);
  hdfs.setReplication(bar1_dir2,REPL);
  hdfs.setReplication(bar_dir2,REPL);
  restartClusterAndCheckImage(true);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1111");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2222");
  final Path bar1_s2222=SnapshotTestHelper.getSnapshotPath(sdir2,"s2222","foo/bar1");
  final Path bar_s2222=SnapshotTestHelper.getSnapshotPath(sdir2,"s2222","bar");
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar1_s22));
  assertTrue(hdfs.exists(bar1_s333));
  assertTrue(hdfs.exists(bar1_s2222));
  assertTrue(hdfs.exists(bar_s1));
  assertTrue(hdfs.exists(bar_s22));
  assertTrue(hdfs.exists(bar_s333));
  assertTrue(hdfs.exists(bar_s2222));
  statusBar1=hdfs.getFileStatus(bar1_s1);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_dir2);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_s22);
  assertEquals(REPL_1,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_s333);
  assertEquals(REPL_2,statusBar1.getReplication());
  statusBar1=hdfs.getFileStatus(bar1_s2222);
  assertEquals(REPL,statusBar1.getReplication());
  statusBar=hdfs.getFileStatus(bar_s1);
  assertEquals(REPL,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_dir2);
  assertEquals(REPL,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_s22);
  assertEquals(REPL_1,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_s333);
  assertEquals(REPL_2,statusBar.getReplication());
  statusBar=hdfs.getFileStatus(bar_s2222);
  assertEquals(REPL,statusBar.getReplication());
  hdfs.rename(foo_dir2,foo_dir1);
  hdfs.rename(bar_dir2,bar_dir1);
  INodeDirectory sdir1Node=fsdir.getINode(sdir1.toString()).asDirectory();
  INodeDirectory sdir2Node=fsdir.getINode(sdir2.toString()).asDirectory();
  INodeDirectory sdir3Node=fsdir.getINode(sdir3.toString()).asDirectory();
  INodeReference fooRef=fsdir.getINode4Write(foo_dir1.toString()).asReference();
  INodeReference.WithCount fooWithCount=(WithCount)fooRef.getReferredINode();
  assertEquals(5,fooWithCount.getReferenceCount());
  INodeDirectory foo=fooWithCount.asDirectory();
  List<DirectoryDiff> fooDiffs=foo.getDiffs().asList();
  assertEquals(4,fooDiffs.size());
  Snapshot s2222=sdir2Node.getSnapshot(DFSUtil.string2Bytes("s2222"));
  Snapshot s333=sdir3Node.getSnapshot(DFSUtil.string2Bytes("s333"));
  Snapshot s22=sdir2Node.getSnapshot(DFSUtil.string2Bytes("s22"));
  Snapshot s1=sdir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  assertEquals(s2222.getId(),fooDiffs.get(3).getSnapshotId());
  assertEquals(s333.getId(),fooDiffs.get(2).getSnapshotId());
  assertEquals(s22.getId(),fooDiffs.get(1).getSnapshotId());
  assertEquals(s1.getId(),fooDiffs.get(0).getSnapshotId());
  INodeFile bar1=fsdir.getINode4Write(bar1_dir1.toString()).asFile();
  List<FileDiff> bar1Diffs=bar1.getDiffs().asList();
  assertEquals(3,bar1Diffs.size());
  assertEquals(s333.getId(),bar1Diffs.get(2).getSnapshotId());
  assertEquals(s22.getId(),bar1Diffs.get(1).getSnapshotId());
  assertEquals(s1.getId(),bar1Diffs.get(0).getSnapshotId());
  INodeReference barRef=fsdir.getINode4Write(bar_dir1.toString()).asReference();
  INodeReference.WithCount barWithCount=(WithCount)barRef.getReferredINode();
  assertEquals(5,barWithCount.getReferenceCount());
  INodeFile bar=barWithCount.asFile();
  List<FileDiff> barDiffs=bar.getDiffs().asList();
  assertEquals(4,barDiffs.size());
  assertEquals(s2222.getId(),barDiffs.get(3).getSnapshotId());
  assertEquals(s333.getId(),barDiffs.get(2).getSnapshotId());
  assertEquals(s22.getId(),barDiffs.get(1).getSnapshotId());
  assertEquals(s1.getId(),barDiffs.get(0).getSnapshotId());
  restartClusterAndCheckImage(true);
  hdfs.delete(foo_dir1,true);
  hdfs.delete(bar_dir1,true);
  restartClusterAndCheckImage(true);
  final Path bar1_s1111=SnapshotTestHelper.getSnapshotPath(sdir1,"s1111","foo/bar1");
  final Path bar_s1111=SnapshotTestHelper.getSnapshotPath(sdir1,"s1111","bar");
  assertTrue(hdfs.exists(bar1_s1));
  assertTrue(hdfs.exists(bar1_s22));
  assertTrue(hdfs.exists(bar1_s333));
  assertTrue(hdfs.exists(bar1_s2222));
  assertFalse(hdfs.exists(bar1_s1111));
  assertTrue(hdfs.exists(bar_s1));
  assertTrue(hdfs.exists(bar_s22));
  assertTrue(hdfs.exists(bar_s333));
  assertTrue(hdfs.exists(bar_s2222));
  assertFalse(hdfs.exists(bar_s1111));
  final Path foo_s2222=SnapshotTestHelper.getSnapshotPath(sdir2,"s2222","foo");
  fooRef=fsdir.getINode(foo_s2222.toString()).asReference();
  fooWithCount=(WithCount)fooRef.getReferredINode();
  assertEquals(4,fooWithCount.getReferenceCount());
  foo=fooWithCount.asDirectory();
  fooDiffs=foo.getDiffs().asList();
  assertEquals(4,fooDiffs.size());
  assertEquals(s2222.getId(),fooDiffs.get(3).getSnapshotId());
  bar1Diffs=bar1.getDiffs().asList();
  assertEquals(3,bar1Diffs.size());
  assertEquals(s333.getId(),bar1Diffs.get(2).getSnapshotId());
  barRef=fsdir.getINode(bar_s2222.toString()).asReference();
  barWithCount=(WithCount)barRef.getReferredINode();
  assertEquals(4,barWithCount.getReferenceCount());
  bar=barWithCount.asFile();
  barDiffs=bar.getDiffs().asList();
  assertEquals(4,barDiffs.size());
  assertEquals(s2222.getId(),barDiffs.get(3).getSnapshotId());
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * move a directory to its prior descendant
 */
@Test public void testRename2PreDescendant_2() throws Exception {
  final Path root=new Path("/");
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  final Path file1InBar=new Path(bar,"file1");
  final Path file2InBar=new Path(bar,"file2");
  hdfs.mkdirs(bar);
  hdfs.mkdirs(sdir2);
  DFSTestUtil.createFile(hdfs,file1InBar,BLOCKSIZE,REPL,SEED);
  DFSTestUtil.createFile(hdfs,file2InBar,BLOCKSIZE,REPL,SEED);
  hdfs.setQuota(sdir1,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  hdfs.setQuota(sdir2,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  hdfs.setQuota(foo,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  hdfs.setQuota(bar,Long.MAX_VALUE - 1,Long.MAX_VALUE - 1);
  SnapshotTestHelper.createSnapshot(hdfs,root,snap1);
  hdfs.delete(file1InBar,true);
  SnapshotTestHelper.createSnapshot(hdfs,root,snap2);
  hdfs.delete(file2InBar,true);
  final Path bar2=new Path(sdir2,"bar2");
  hdfs.rename(bar,bar2);
  final Path foo2=new Path(bar2,"foo2");
  hdfs.rename(foo,foo2);
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(root,snap2);
  restartClusterAndCheckImage(false);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test rename while the rename operation will exceed the quota in the dst
 * tree.
 */
@Test public void testRenameUndo_5() throws Exception {
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  final Path subdir2=new Path(dir2,"subdir2");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(subdir2);
  final Path foo=new Path(dir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,dir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  hdfs.setQuota(dir2,5,Long.MAX_VALUE - 1);
  final Path foo2=new Path(subdir2,foo.getName());
  boolean rename=hdfs.rename(foo,foo2);
  assertFalse(rename);
  assertTrue(hdfs.exists(foo));
  assertTrue(hdfs.exists(bar));
  INodeDirectory dir1Node=fsdir.getINode4Write(dir1.toString()).asDirectory();
  List<INode> childrenList=ReadOnlyList.Util.asList(dir1Node.getChildrenList(Snapshot.CURRENT_STATE_ID));
  assertEquals(1,childrenList.size());
  INode fooNode=childrenList.get(0);
  assertTrue(fooNode.asDirectory().isWithSnapshot());
  INode barNode=fsdir.getINode4Write(bar.toString());
  assertTrue(barNode.getClass() == INodeFile.class);
  assertSame(fooNode,barNode.getParent());
  List<DirectoryDiff> diffList=dir1Node.getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
  INodeDirectory dir2Node=fsdir.getINode4Write(dir2.toString()).asDirectory();
  assertTrue(dir2Node.isSnapshottable());
  Quota.Counts counts=dir2Node.computeQuotaUsage();
  assertEquals(3,counts.get(Quota.NAMESPACE));
  assertEquals(0,counts.get(Quota.DISKSPACE));
  childrenList=ReadOnlyList.Util.asList(dir2Node.asDirectory().getChildrenList(Snapshot.CURRENT_STATE_ID));
  assertEquals(1,childrenList.size());
  INode subdir2Node=childrenList.get(0);
  assertSame(dir2Node,subdir2Node.getParent());
  assertSame(subdir2Node,fsdir.getINode4Write(subdir2.toString()));
  diffList=dir2Node.getDiffs().asList();
  assertEquals(1,diffList.size());
  diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * After the following operations:
 * Rename a dir -> create a snapshot s on dst tree -> delete the renamed dir
 * -> delete snapshot s on dst tree
 * Make sure we destroy everything created after the rename under the renamed
 * dir.
 */
@Test public void testRenameDirAndDeleteSnapshot_3() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  hdfs.mkdirs(sdir2);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  final Path foo2=new Path(sdir2,"foo");
  hdfs.rename(foo,foo2);
  final Path bar2=new Path(foo2,"bar2");
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  final Path bar3=new Path(foo2,"bar3");
  DFSTestUtil.createFile(hdfs,bar3,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sdir2,"s3");
  hdfs.delete(foo2,true);
  hdfs.deleteSnapshot(sdir2,"s3");
  final INodeDirectory dir1Node=fsdir.getINode4Write(sdir1.toString()).asDirectory();
  Quota.Counts q1=dir1Node.getDirectoryWithQuotaFeature().getSpaceConsumed();
  assertEquals(4,q1.get(Quota.NAMESPACE));
  final INodeDirectory dir2Node=fsdir.getINode4Write(sdir2.toString()).asDirectory();
  Quota.Counts q2=dir2Node.getDirectoryWithQuotaFeature().getSpaceConsumed();
  assertEquals(2,q2.get(Quota.NAMESPACE));
  final Path foo_s1=SnapshotTestHelper.getSnapshotPath(sdir1,"s1",foo.getName());
  INode fooRef=fsdir.getINode(foo_s1.toString());
  assertTrue(fooRef instanceof INodeReference.WithName);
  INodeReference.WithCount wc=(WithCount)fooRef.asReference().getReferredINode();
  assertEquals(1,wc.getReferenceCount());
  INodeDirectory fooNode=wc.getReferredINode().asDirectory();
  ReadOnlyList<INode> children=fooNode.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,children.size());
  assertEquals(bar.getName(),children.get(0).getLocalName());
  List<DirectoryDiff> diffList=fooNode.getDiffs().asList();
  assertEquals(1,diffList.size());
  Snapshot s1=dir1Node.getSnapshot(DFSUtil.string2Bytes("s1"));
  assertEquals(s1.getId(),diffList.get(0).getSnapshotId());
  ChildrenDiff diff=diffList.get(0).getChildrenDiff();
  assertEquals(0,diff.getList(ListType.CREATED).size());
  assertEquals(0,diff.getList(ListType.DELETED).size());
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-9 type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Rename and deletion snapshot under the same the snapshottable directory.
 */
@Test public void testRenameDirAndDeleteSnapshot_6() throws Exception {
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(dir2);
  final Path foo=new Path(dir2,"foo");
  final Path bar=new Path(foo,"bar");
  final Path file=new Path(bar,"file");
  DFSTestUtil.createFile(hdfs,file,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,test,"s0");
  hdfs.delete(file,true);
  final Path newfoo=new Path(dir1,foo.getName());
  hdfs.rename(foo,newfoo);
  final Path foo_s0=SnapshotTestHelper.getSnapshotPath(test,"s0","dir2/foo");
  assertTrue("the snapshot path " + foo_s0 + " should exist",hdfs.exists(foo_s0));
  hdfs.deleteSnapshot(test,"s0");
  assertFalse("after deleting s0, " + foo_s0 + " should not exist",hdfs.exists(foo_s0));
  INodeDirectory dir2Node=fsdir.getINode4Write(dir2.toString()).asDirectory();
  assertTrue("the diff list of " + dir2 + " should be empty after deleting s0",dir2Node.getDiffs().asList().isEmpty());
  assertTrue(hdfs.exists(newfoo));
  INode fooRefNode=fsdir.getINode4Write(newfoo.toString());
  assertTrue(fooRefNode instanceof INodeReference.DstReference);
  INodeDirectory fooNode=fooRefNode.asDirectory();
  assertTrue(fooNode.isWithSnapshot());
  assertTrue(fooNode.getDiffs().asList().isEmpty());
  INodeDirectory barNode=fooNode.getChildrenList(Snapshot.CURRENT_STATE_ID).get(0).asDirectory();
  assertTrue(barNode.getDiffs().asList().isEmpty());
  assertTrue(barNode.getChildrenList(Snapshot.CURRENT_STATE_ID).isEmpty());
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test the rename undo when quota of dst tree is exceeded after rename.
 */
@Test public void testRenameExceedQuota() throws Exception {
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  final Path sub_dir2=new Path(dir2,"subdir");
  final Path subfile_dir2=new Path(sub_dir2,"subfile");
  hdfs.mkdirs(dir1);
  DFSTestUtil.createFile(hdfs,subfile_dir2,BLOCKSIZE,REPL,SEED);
  final Path foo=new Path(dir1,"foo");
  DFSTestUtil.createFile(hdfs,foo,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,dir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  hdfs.setQuota(dir2,5,Long.MAX_VALUE - 1);
  hdfs.rename(foo,subfile_dir2,Rename.OVERWRITE);
  INode dir2Node=fsdir.getINode4Write(dir2.toString());
  assertTrue(dir2Node.asDirectory().isSnapshottable());
  Quota.Counts counts=dir2Node.computeQuotaUsage();
  assertEquals(7,counts.get(Quota.NAMESPACE));
  assertEquals(BLOCKSIZE * REPL * 2,counts.get(Quota.DISKSPACE));
}

</code></pre>

<pre class="type-9 type-2 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test the rename undo when removing dst node fails
 */
@Test public void testRenameUndo_6() throws Exception {
  final Path test=new Path("/test");
  final Path dir1=new Path(test,"dir1");
  final Path dir2=new Path(test,"dir2");
  final Path sub_dir2=new Path(dir2,"subdir");
  final Path subsub_dir2=new Path(sub_dir2,"subdir");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(subsub_dir2);
  final Path foo=new Path(dir1,"foo");
  hdfs.mkdirs(foo);
  SnapshotTestHelper.createSnapshot(hdfs,dir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  hdfs.setQuota(dir2,4,Long.MAX_VALUE - 1);
  try {
    hdfs.rename(foo,subsub_dir2,Rename.OVERWRITE);
    fail("Expect QuotaExceedException");
  }
 catch (  QuotaExceededException e) {
    String msg="Failed to record modification for snapshot: " + "The NameSpace quota (directories and files)" + " is exceeded: quota=4 file count=5";
    GenericTestUtils.assertExceptionContains(msg,e);
  }
  assertTrue(hdfs.exists(foo));
  INodeDirectory dir1Node=fsdir.getINode4Write(dir1.toString()).asDirectory();
  List<INode> childrenList=ReadOnlyList.Util.asList(dir1Node.getChildrenList(Snapshot.CURRENT_STATE_ID));
  assertEquals(1,childrenList.size());
  INode fooNode=childrenList.get(0);
  assertTrue(fooNode.asDirectory().isWithSnapshot());
  assertSame(dir1Node,fooNode.getParent());
  List<DirectoryDiff> diffList=dir1Node.getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
  INodeDirectory dir2Node=fsdir.getINode4Write(dir2.toString()).asDirectory();
  assertTrue(dir2Node.isSnapshottable());
  Quota.Counts counts=dir2Node.computeQuotaUsage();
  assertEquals(4,counts.get(Quota.NAMESPACE));
  assertEquals(0,counts.get(Quota.DISKSPACE));
  childrenList=ReadOnlyList.Util.asList(dir2Node.asDirectory().getChildrenList(Snapshot.CURRENT_STATE_ID));
  assertEquals(1,childrenList.size());
  INode subdir2Node=childrenList.get(0);
  assertTrue(subdir2Node.asDirectory().isWithSnapshot());
  assertSame(dir2Node,subdir2Node.getParent());
  assertSame(subdir2Node,fsdir.getINode4Write(sub_dir2.toString()));
  INode subsubdir2Node=fsdir.getINode4Write(subsub_dir2.toString());
  assertTrue(subsubdir2Node.getClass() == INodeDirectory.class);
  assertSame(subdir2Node,subsubdir2Node.getParent());
  diffList=(dir2Node).getDiffs().asList();
  assertEquals(1,diffList.size());
  diff=diffList.get(0);
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
  diffList=subdir2Node.asDirectory().getDiffs().asList();
  assertEquals(0,diffList.size());
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test(timeout=60000) public void testRenameFileInSubDirOfDirWithSnapshot() throws Exception {
  final Path sub2=new Path(sub1,"sub2");
  final Path sub2file1=new Path(sub2,"sub2file1");
  final Path sub2file2=new Path(sub2,"sub2file2");
  final String sub1snap1="sub1snap1";
  hdfs.mkdirs(sub1);
  hdfs.mkdirs(sub2);
  DFSTestUtil.createFile(hdfs,sub2file1,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sub1,sub1snap1);
  hdfs.rename(sub2file1,sub2file2);
  SnapshotDiffReport diffReport=hdfs.getSnapshotDiffReport(sub1,sub1snap1,"");
  LOG.info("DiffList is \n\"" + diffReport.toString() + "\"");
  List<DiffReportEntry> entries=diffReport.getDiffList();
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,sub2.getName(),null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,sub2.getName() + "/" + sub2file1.getName(),sub2.getName() + "/" + sub2file2.getName()));
}

</code></pre>

<pre class="type-7 type-10 type-19 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test demonstrates that {@link INodeDirectory#removeChild(INode,Snapshot)}and {@link INodeDirectory#addChild(INode,boolean,Snapshot)}should use {@link INode#isInLatestSnapshot(Snapshot)} to check if the 
 * added/removed child should be recorded in snapshots.
 */
@Test public void testRenameDirAndDeleteSnapshot_5() throws Exception {
  final Path dir1=new Path("/dir1");
  final Path dir2=new Path("/dir2");
  final Path dir3=new Path("/dir3");
  hdfs.mkdirs(dir1);
  hdfs.mkdirs(dir2);
  hdfs.mkdirs(dir3);
  final Path foo=new Path(dir1,"foo");
  hdfs.mkdirs(foo);
  SnapshotTestHelper.createSnapshot(hdfs,dir1,"s1");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  hdfs.deleteSnapshot(dir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,dir2,"s2");
  final Path foo2=new Path(dir2,foo.getName());
  hdfs.rename(foo,foo2);
  final Path bar2=new Path(dir2,"foo/bar");
  final Path bar3=new Path(dir3,"bar");
  hdfs.rename(bar2,bar3);
  hdfs.delete(foo2,true);
  assertTrue(hdfs.exists(bar3));
  INodeFile barNode=(INodeFile)fsdir.getINode4Write(bar3.toString());
  assertSame(fsdir.getINode4Write(dir3.toString()),barNode.getParent());
}

</code></pre>

<pre class="type-2 type-7 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test rename where the src/dst directories are both snapshottable 
 * directories without snapshots. In such case we need to update the 
 * snapshottable dir list in SnapshotManager.
 */
@Test(timeout=60000) public void testRenameAndUpdateSnapshottableDirs() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(sdir2,"bar");
  hdfs.mkdirs(foo);
  hdfs.mkdirs(bar);
  hdfs.allowSnapshot(foo);
  SnapshotTestHelper.createSnapshot(hdfs,bar,snap1);
  assertEquals(2,fsn.getSnapshottableDirListing().length);
  INodeDirectory fooNode=fsdir.getINode4Write(foo.toString()).asDirectory();
  long fooId=fooNode.getId();
  try {
    hdfs.rename(foo,bar,Rename.OVERWRITE);
    fail("Expect exception since " + bar + " is snapshottable and already has snapshots");
  }
 catch (  IOException e) {
    GenericTestUtils.assertExceptionContains(bar.toString() + " is snapshottable and already has snapshots",e);
  }
  hdfs.deleteSnapshot(bar,snap1);
  hdfs.rename(foo,bar,Rename.OVERWRITE);
  SnapshottableDirectoryStatus[] dirs=fsn.getSnapshottableDirListing();
  assertEquals(1,dirs.length);
  assertEquals(bar,dirs[0].getFullPath());
  assertEquals(fooId,dirs[0].getDirStatus().getFileId());
}

</code></pre>

<pre class="type-9 type-2 type-7 type-10 type-19 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test rename to an invalid name (xxx/.snapshot)
 */
@Test public void testRenameUndo_7() throws Exception {
  final Path root=new Path("/");
  final Path foo=new Path(root,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,root,snap1);
  final Path invalid=new Path(foo,HdfsConstants.DOT_SNAPSHOT_DIR);
  try {
    hdfs.rename(bar,invalid);
    fail("expect exception since invalid name is used for rename");
  }
 catch (  Exception e) {
    GenericTestUtils.assertExceptionContains("\"" + HdfsConstants.DOT_SNAPSHOT_DIR + "\" is a reserved name",e);
  }
  INodeDirectory rootNode=fsdir.getINode4Write(root.toString()).asDirectory();
  INodeDirectory fooNode=fsdir.getINode4Write(foo.toString()).asDirectory();
  ReadOnlyList<INode> children=fooNode.getChildrenList(Snapshot.CURRENT_STATE_ID);
  assertEquals(1,children.size());
  List<DirectoryDiff> diffList=fooNode.getDiffs().asList();
  assertEquals(1,diffList.size());
  DirectoryDiff diff=diffList.get(0);
  Snapshot s1=rootNode.getSnapshot(DFSUtil.string2Bytes(snap1));
  assertEquals(s1.getId(),diff.getSnapshotId());
  assertTrue(diff.getChildrenDiff().getList(ListType.DELETED).isEmpty());
  assertTrue(diff.getChildrenDiff().getList(ListType.CREATED).isEmpty());
  INodeFile barNode=fsdir.getINode4Write(bar.toString()).asFile();
  assertSame(barNode,children.get(0));
  assertSame(fooNode,barNode.getParent());
  List<FileDiff> barDiffList=barNode.getDiffs().asList();
  assertEquals(1,barDiffList.size());
  FileDiff barDiff=barDiffList.get(0);
  assertEquals(s1.getId(),barDiff.getSnapshotId());
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_ENTER);
  hdfs.saveNamespace();
  hdfs.setSafeMode(SafeModeAction.SAFEMODE_LEAVE);
  cluster.shutdown();
  cluster=new MiniDFSCluster.Builder(conf).format(false).numDataNodes(REPL).build();
  cluster.waitActive();
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Rename a single file across snapshottable dirs.
 */
@Test(timeout=60000) public void testRenameFileAcrossSnapshottableDirs() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  DFSTestUtil.createFile(hdfs,foo,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  hdfs.createSnapshot(sdir1,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  hdfs.setReplication(newfoo,REPL_1);
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo");
  assertTrue(hdfs.exists(foo_s2));
  FileStatus status=hdfs.getFileStatus(foo_s2);
  assertEquals(REPL,status.getReplication());
  final Path foo_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo");
  assertFalse(hdfs.exists(foo_s3));
  INodeDirectory sdir2Node=fsdir.getINode(sdir2.toString()).asDirectory();
  Snapshot s2=sdir2Node.getSnapshot(DFSUtil.string2Bytes("s2"));
  INodeFile sfoo=fsdir.getINode(newfoo.toString()).asFile();
  assertEquals(s2.getId(),sfoo.getDiffs().getLastSnapshotId());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * After the following steps:
 * <pre>
 * 1. Take snapshot s1 on /dir1 at time t1.
 * 2. Take snapshot s2 on /dir2 at time t2.
 * 3. Modify the subtree of /dir2/foo/ to make it a dir with snapshots.
 * 4. Take snapshot s3 on /dir1 at time t3.
 * 5. Rename /dir2/foo/ to /dir1/foo/.
 * </pre>
 * When changes happening on foo, the diff should be recorded in snapshot s2. 
 */
@Test(timeout=60000) public void testRenameDirAcrossSnapshottableDirs() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  final Path bar=new Path(foo,"bar");
  final Path bar2=new Path(foo,"bar2");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  hdfs.setReplication(bar2,REPL_1);
  hdfs.delete(bar,true);
  hdfs.createSnapshot(sdir1,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  final Path snapshotBar=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar");
  assertTrue(hdfs.exists(snapshotBar));
  final Path newBar2=new Path(newfoo,"bar2");
  assertTrue(hdfs.exists(newBar2));
  hdfs.delete(newBar2,true);
  final Path bar2_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar2");
  assertTrue(hdfs.exists(bar2_s2));
  FileStatus status=hdfs.getFileStatus(bar2_s2);
  assertEquals(REPL,status.getReplication());
  final Path bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test(timeout=60000) public void testRenameTwiceInSnapshot() throws Exception {
  hdfs.mkdirs(sub1);
  hdfs.allowSnapshot(sub1);
  DFSTestUtil.createFile(hdfs,file1,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sub1,snap1);
  hdfs.rename(file1,file2);
  hdfs.createSnapshot(sub1,snap2);
  hdfs.rename(file2,file3);
  SnapshotDiffReport diffReport;
  diffReport=hdfs.getSnapshotDiffReport(sub1,snap1,snap2);
  LOG.info("DiffList is " + diffReport.toString());
  List<DiffReportEntry> entries=diffReport.getDiffList();
  assertTrue(entries.size() == 2);
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,file1.getName(),file2.getName()));
  diffReport=hdfs.getSnapshotDiffReport(sub1,snap2,"");
  LOG.info("DiffList is " + diffReport.toString());
  entries=diffReport.getDiffList();
  assertTrue(entries.size() == 2);
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,file2.getName(),file3.getName()));
  diffReport=hdfs.getSnapshotDiffReport(sub1,snap1,"");
  LOG.info("DiffList is " + diffReport.toString());
  entries=diffReport.getDiffList();
  assertTrue(entries.size() == 2);
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,file1.getName(),file3.getName()));
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * After rename, delete the snapshot in src
 */
@Test public void testRenameDirAndDeleteSnapshot_2() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  restartClusterAndCheckImage(true);
  final Path bar2=new Path(newfoo,"bar2");
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sdir1,"s4");
  hdfs.delete(newfoo,true);
  final Path bar2_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar2");
  assertTrue(hdfs.exists(bar2_s4));
  final Path bar_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar");
  assertTrue(hdfs.exists(bar_s4));
  hdfs.deleteSnapshot(sdir1,"s4");
  restartClusterAndCheckImage(true);
  Path bar_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar");
  assertFalse(hdfs.exists(bar_s3));
  bar_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar");
  assertTrue(hdfs.exists(bar_s3));
  Path bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  hdfs.deleteSnapshot(sdir2,"s3");
  final Path bar_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar");
  assertTrue(hdfs.exists(bar_s2));
  INodeDirectory sdir2Node=fsdir.getINode(sdir2.toString()).asDirectory();
  Snapshot s2=sdir2Node.getSnapshot(DFSUtil.string2Bytes("s2"));
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo");
  INodeReference fooRef=fsdir.getINode(foo_s2.toString()).asReference();
  assertTrue(fooRef instanceof INodeReference.WithName);
  INodeReference.WithCount fooWC=(WithCount)fooRef.getReferredINode();
  assertEquals(1,fooWC.getReferenceCount());
  INodeDirectory fooDir=fooWC.getReferredINode().asDirectory();
  List<DirectoryDiff> diffs=fooDir.getDiffs().asList();
  assertEquals(1,diffs.size());
  assertEquals(s2.getId(),diffs.get(0).getSnapshotId());
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir2,"s2");
  assertFalse(hdfs.exists(bar_s2));
  restartClusterAndCheckImage(true);
  Quota.Counts q=fsdir.getRoot().getDirectoryWithQuotaFeature().getSpaceConsumed();
  assertEquals(4,q.get(Quota.NAMESPACE));
  assertEquals(0,q.get(Quota.DISKSPACE));
  hdfs.deleteSnapshot(sdir1,"s1");
  restartClusterAndCheckImage(true);
  q=fsdir.getRoot().getDirectoryWithQuotaFeature().getSpaceConsumed();
  assertEquals(3,q.get(Quota.NAMESPACE));
  assertEquals(0,q.get(Quota.DISKSPACE));
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testRename2PreDescendant() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  hdfs.mkdirs(bar);
  hdfs.mkdirs(sdir2);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,snap1);
  final Path bar2=new Path(sdir2,"bar");
  hdfs.rename(bar,bar2);
  final Path foo2=new Path(bar2,"foo");
  hdfs.rename(foo,foo2);
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir1,snap1);
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Test rename from a non-snapshottable dir to a snapshottable dir
 */
@Test(timeout=60000) public void testRenameFromNonSDir2SDir() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir1,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,snap1);
  final Path newfoo=new Path(sdir2,"foo");
  hdfs.rename(foo,newfoo);
  INode fooNode=fsdir.getINode4Write(newfoo.toString());
  assertTrue(fooNode instanceof INodeDirectory);
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testRenameWithOverWrite() throws Exception {
  final Path root=new Path("/");
  final Path foo=new Path(root,"foo");
  final Path file1InFoo=new Path(foo,"file1");
  final Path file2InFoo=new Path(foo,"file2");
  final Path file3InFoo=new Path(foo,"file3");
  DFSTestUtil.createFile(hdfs,file1InFoo,1L,REPL,SEED);
  DFSTestUtil.createFile(hdfs,file2InFoo,1L,REPL,SEED);
  DFSTestUtil.createFile(hdfs,file3InFoo,1L,REPL,SEED);
  final Path bar=new Path(root,"bar");
  hdfs.mkdirs(bar);
  SnapshotTestHelper.createSnapshot(hdfs,root,"s0");
  final Path fileInBar=new Path(bar,"file1");
  hdfs.rename(file1InFoo,fileInBar);
  final Path newDir=new Path(root,"newDir");
  hdfs.rename(bar,newDir);
  final Path file2InNewDir=new Path(newDir,"file2");
  hdfs.rename(file2InFoo,file2InNewDir);
  final Path file1InNewDir=new Path(newDir,"file1");
  hdfs.rename(file3InFoo,file1InNewDir,Rename.OVERWRITE);
  SnapshotTestHelper.createSnapshot(hdfs,root,"s1");
  SnapshotDiffReport report=hdfs.getSnapshotDiffReport(root,"s0","s1");
  LOG.info("DiffList is \n\"" + report.toString() + "\"");
  List<DiffReportEntry> entries=report.getDiffList();
  assertEquals(7,entries.size());
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,foo.getName(),null));
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,bar.getName(),null));
  assertTrue(existsInDiffReport(entries,DiffType.DELETE,"foo/file1",null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,"bar","newDir"));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,"foo/file2","newDir/file2"));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,"foo/file3","newDir/file1"));
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test renaming a file and then delete snapshots.
 */
@Test public void testRenameFileAndDeleteSnapshot() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  DFSTestUtil.createFile(hdfs,foo,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  hdfs.createSnapshot(sdir1,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  hdfs.setReplication(newfoo,REPL_1);
  hdfs.createSnapshot(sdir1,"s4");
  hdfs.setReplication(newfoo,REPL_2);
  FileStatus status=hdfs.getFileStatus(newfoo);
  assertEquals(REPL_2,status.getReplication());
  final Path foo_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo");
  status=hdfs.getFileStatus(foo_s4);
  assertEquals(REPL_1,status.getReplication());
  hdfs.createSnapshot(sdir1,"s5");
  final Path foo_s5=SnapshotTestHelper.getSnapshotPath(sdir1,"s5","foo");
  status=hdfs.getFileStatus(foo_s5);
  assertEquals(REPL_2,status.getReplication());
  hdfs.deleteSnapshot(sdir1,"s5");
  restartClusterAndCheckImage(true);
  assertFalse(hdfs.exists(foo_s5));
  status=hdfs.getFileStatus(foo_s4);
  assertEquals(REPL_1,status.getReplication());
  hdfs.deleteSnapshot(sdir1,"s4");
  assertFalse(hdfs.exists(foo_s4));
  Path foo_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo");
  assertFalse(hdfs.exists(foo_s3));
  foo_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo");
  assertFalse(hdfs.exists(foo_s3));
  final Path foo_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo");
  assertTrue(hdfs.exists(foo_s2));
  status=hdfs.getFileStatus(foo_s2);
  assertEquals(REPL,status.getReplication());
  INodeFile snode=fsdir.getINode(newfoo.toString()).asFile();
  assertEquals(1,snode.getDiffs().asList().size());
  INodeDirectory sdir2Node=fsdir.getINode(sdir2.toString()).asDirectory();
  Snapshot s2=sdir2Node.getSnapshot(DFSUtil.string2Bytes("s2"));
  assertEquals(s2.getId(),snode.getDiffs().getLastSnapshotId());
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir2,"s2");
  assertFalse(hdfs.exists(foo_s2));
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir1,"s3");
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir1,"s1");
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-9 type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Test renaming a dir and then delete snapshots.
 */
@Test public void testRenameDirAndDeleteSnapshot_1() throws Exception {
  final Path sdir1=new Path("/dir1");
  final Path sdir2=new Path("/dir2");
  hdfs.mkdirs(sdir1);
  hdfs.mkdirs(sdir2);
  final Path foo=new Path(sdir2,"foo");
  final Path bar=new Path(foo,"bar");
  final Path bar2=new Path(foo,"bar2");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  DFSTestUtil.createFile(hdfs,bar2,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sdir1,"s1");
  SnapshotTestHelper.createSnapshot(hdfs,sdir2,"s2");
  hdfs.createSnapshot(sdir1,"s3");
  final Path newfoo=new Path(sdir1,"foo");
  hdfs.rename(foo,newfoo);
  final Path newbar=new Path(newfoo,bar.getName());
  final Path newbar2=new Path(newfoo,bar2.getName());
  final Path newbar3=new Path(newfoo,"bar3");
  DFSTestUtil.createFile(hdfs,newbar3,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sdir1,"s4");
  hdfs.delete(newbar,true);
  hdfs.delete(newbar3,true);
  assertFalse(hdfs.exists(newbar3));
  assertFalse(hdfs.exists(bar));
  final Path bar_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar");
  final Path bar3_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar3");
  assertTrue(hdfs.exists(bar_s4));
  assertTrue(hdfs.exists(bar3_s4));
  hdfs.createSnapshot(sdir1,"s5");
  hdfs.delete(newbar2,true);
  assertFalse(hdfs.exists(bar2));
  final Path bar2_s5=SnapshotTestHelper.getSnapshotPath(sdir1,"s5","foo/bar2");
  assertTrue(hdfs.exists(bar2_s5));
  hdfs.deleteSnapshot(sdir1,"s5");
  restartClusterAndCheckImage(true);
  assertFalse(hdfs.exists(bar2_s5));
  final Path bar2_s4=SnapshotTestHelper.getSnapshotPath(sdir1,"s4","foo/bar2");
  assertTrue(hdfs.exists(bar2_s4));
  hdfs.deleteSnapshot(sdir1,"s4");
  assertFalse(hdfs.exists(bar_s4));
  Path bar_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar");
  assertFalse(hdfs.exists(bar_s3));
  bar_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar");
  assertFalse(hdfs.exists(bar_s3));
  final Path bar_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar");
  assertTrue(hdfs.exists(bar_s2));
  assertFalse(hdfs.exists(bar2_s4));
  Path bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  bar2_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar2");
  assertFalse(hdfs.exists(bar2_s3));
  final Path bar2_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar2");
  assertTrue(hdfs.exists(bar2_s2));
  assertFalse(hdfs.exists(bar3_s4));
  Path bar3_s3=SnapshotTestHelper.getSnapshotPath(sdir1,"s3","foo/bar3");
  assertFalse(hdfs.exists(bar3_s3));
  bar3_s3=SnapshotTestHelper.getSnapshotPath(sdir2,"s3","foo/bar3");
  assertFalse(hdfs.exists(bar3_s3));
  final Path bar3_s2=SnapshotTestHelper.getSnapshotPath(sdir2,"s2","foo/bar3");
  assertFalse(hdfs.exists(bar3_s2));
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir2,"s2");
  assertFalse(hdfs.exists(bar_s2));
  assertFalse(hdfs.exists(bar2_s2));
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir1,"s3");
  restartClusterAndCheckImage(true);
  hdfs.deleteSnapshot(sdir1,"s1");
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setUp() throws Exception {
  conf.setLong(DFSConfigKeys.DFS_BLOCK_SIZE_KEY,BLOCKSIZE);
  cluster=new MiniDFSCluster.Builder(conf).numDataNodes(REPL).format(true).build();
  cluster.waitActive();
  fsn=cluster.getNamesystem();
  fsdir=fsn.getFSDirectory();
  hdfs=cluster.getFileSystem();
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Rename a file under a snapshottable directory, file exists
 * in a snapshot.
 */
@Test public void testRenameFileInSnapshot() throws Exception {
  hdfs.mkdirs(sub1);
  hdfs.allowSnapshot(sub1);
  DFSTestUtil.createFile(hdfs,file1,BLOCKSIZE,REPL,SEED);
  hdfs.createSnapshot(sub1,snap1);
  hdfs.rename(file1,file2);
  SnapshotDiffReport diffReport=hdfs.getSnapshotDiffReport(sub1,snap1,"");
  System.out.println("DiffList is " + diffReport.toString());
  List<DiffReportEntry> entries=diffReport.getDiffList();
  assertTrue(entries.size() == 2);
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,file1.getName(),file2.getName()));
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown() throws Exception {
  if (cluster != null) {
    cluster.shutdown();
  }
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRenameDirectoryInSnapshot() throws Exception {
  final Path sub2=new Path(sub1,"sub2");
  final Path sub3=new Path(sub1,"sub3");
  final Path sub2file1=new Path(sub2,"sub2file1");
  final String sub1snap1="sub1snap1";
  hdfs.mkdirs(sub1);
  hdfs.mkdirs(sub2);
  DFSTestUtil.createFile(hdfs,sub2file1,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,sub1,sub1snap1);
  hdfs.rename(sub2,sub3);
  SnapshotDiffReport diffReport=hdfs.getSnapshotDiffReport(sub1,sub1snap1,"");
  LOG.info("DiffList is \n\"" + diffReport.toString() + "\"");
  List<DiffReportEntry> entries=diffReport.getDiffList();
  assertEquals(2,entries.size());
  assertTrue(existsInDiffReport(entries,DiffType.MODIFY,"",null));
  assertTrue(existsInDiffReport(entries,DiffType.RENAME,sub2.getName(),sub3.getName()));
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Similar with testRenameUCFileInSnapshot, but do renaming first and then 
 * append file without closing it. Unit test for HDFS-5425.
 */
@Test public void testAppendFileAfterRenameInSnapshot() throws Exception {
  final Path test=new Path("/test");
  final Path foo=new Path(test,"foo");
  final Path bar=new Path(foo,"bar");
  DFSTestUtil.createFile(hdfs,bar,BLOCKSIZE,REPL,SEED);
  SnapshotTestHelper.createSnapshot(hdfs,test,"s0");
  final Path bar2=new Path(foo,"bar2");
  hdfs.rename(bar,bar2);
  FSDataOutputStream out=hdfs.append(bar2);
  out.writeByte(0);
  ((DFSOutputStream)out.getWrappedStream()).hsync(EnumSet.of(SyncFlag.UPDATE_LENGTH));
  restartClusterAndCheckImage(true);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Rename of the underconstruction file in snapshot should not fail NN restart
 * after checkpoint. Unit test for HDFS-5425.
 */
@Test public void testRenameUCFileInSnapshot() throws Exception {
  final Path test=new Path("/test");
  final Path foo=new Path(test,"foo");
  final Path bar=new Path(foo,"bar");
  hdfs.mkdirs(foo);
  hdfs.create(bar);
  SnapshotTestHelper.createSnapshot(hdfs,test,"s0");
  final Path bar2=new Path(foo,"bar2");
  hdfs.rename(bar,bar2);
  restartClusterAndCheckImage(true);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
