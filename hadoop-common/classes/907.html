<h3 style="margin:0px">Class: org.apache.hadoop.mapreduce.v2.app.rm.TestRMContainerAllocator (21 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(18)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(15)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(15)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test(timeout=30000) public void testPreemptReducers() throws Exception {
  LOG.info("Running testPreemptReducers");
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob,new SystemClock());
  allocator.setMapResourceRequest(1024);
  allocator.setReduceResourceRequest(1024);
  RMContainerAllocator.AssignedRequests assignedRequests=allocator.getAssignedRequests();
  RMContainerAllocator.ScheduledRequests scheduledRequests=allocator.getScheduledRequests();
  ContainerRequestEvent event1=createReq(jobId,1,2048,new String[]{"h1"},false,false);
  scheduledRequests.maps.put(mock(TaskAttemptId.class),new RMContainerRequestor.ContainerRequest(event1,null));
  assignedRequests.reduces.put(mock(TaskAttemptId.class),mock(Container.class));
  allocator.preemptReducesIfNeeded();
  Assert.assertEquals("The reducer is not preempted",1,assignedRequests.preemptionWaitingReduces.size());
}

</code></pre>

<pre class="type-9 type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test public void testCompletedTasksRecalculateSchedule() throws Exception {
  LOG.info("Running testCompletedTasksRecalculateSchedule");
  Configuration conf=new Configuration();
  final MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job job=mock(Job.class);
  when(job.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  doReturn(10).when(job).getTotalMaps();
  doReturn(10).when(job).getTotalReduces();
  doReturn(0).when(job).getCompletedMaps();
  RecalculateContainerAllocator allocator=new RecalculateContainerAllocator(rm,conf,appAttemptId,job);
  allocator.schedule();
  allocator.recalculatedReduceSchedule=false;
  allocator.schedule();
  Assert.assertFalse("Unexpected recalculate of reduce schedule",allocator.recalculatedReduceSchedule);
  doReturn(1).when(job).getCompletedMaps();
  allocator.schedule();
  Assert.assertTrue("Expected recalculate of reduce schedule",allocator.recalculatedReduceSchedule);
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown(){
  DefaultMetricsSystem.shutdown();
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testReportedAppProgress() throws Exception {
  LOG.info("Running testReportedAppProgress");
  Configuration conf=new Configuration();
  final MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher rmDispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp rmApp=rm.submitApp(1024);
  rmDispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",21504);
  amNodeManager.nodeHeartbeat(true);
  rmDispatcher.await();
  final ApplicationAttemptId appAttemptId=rmApp.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  rmDispatcher.await();
  MRApp mrApp=new MRApp(appAttemptId,ContainerId.newInstance(appAttemptId,0),10,10,false,this.getClass().getName(),true,1){
    @Override protected Dispatcher createDispatcher(){
      return new DrainDispatcher();
    }
    protected ContainerAllocator createContainerAllocator(    ClientService clientService,    AppContext context){
      return new MyContainerAllocator(rm,appAttemptId,context);
    }
  }
;
  Assert.assertEquals(0.0,rmApp.getProgress(),0.0);
  mrApp.submit(conf);
  Job job=mrApp.getContext().getAllJobs().entrySet().iterator().next().getValue();
  DrainDispatcher amDispatcher=(DrainDispatcher)mrApp.getDispatcher();
  MyContainerAllocator allocator=(MyContainerAllocator)mrApp.getContainerAllocator();
  mrApp.waitForInternalState((JobImpl)job,JobStateInternal.RUNNING);
  amDispatcher.await();
  for (  Task t : job.getTasks().values()) {
    if (t.getType() == TaskType.MAP) {
      mrApp.waitForInternalState((TaskAttemptImpl)t.getAttempts().values().iterator().next(),TaskAttemptStateInternal.UNASSIGNED);
    }
  }
  amDispatcher.await();
  allocator.schedule();
  rmDispatcher.await();
  amNodeManager.nodeHeartbeat(true);
  rmDispatcher.await();
  allocator.schedule();
  rmDispatcher.await();
  for (  Task t : job.getTasks().values()) {
    if (t.getType() == TaskType.MAP) {
      mrApp.waitForState(t,TaskState.RUNNING);
    }
  }
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.05f,job.getProgress(),0.001f);
  Assert.assertEquals(0.05f,rmApp.getProgress(),0.001f);
  Iterator<Task> it=job.getTasks().values().iterator();
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,1);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.095f,job.getProgress(),0.001f);
  Assert.assertEquals(0.095f,rmApp.getProgress(),0.001f);
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,7);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.41f,job.getProgress(),0.001f);
  Assert.assertEquals(0.41f,rmApp.getProgress(),0.001f);
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,2);
  allocator.schedule();
  rmDispatcher.await();
  amNodeManager.nodeHeartbeat(true);
  rmDispatcher.await();
  allocator.schedule();
  rmDispatcher.await();
  for (  Task t : job.getTasks().values()) {
    if (t.getType() == TaskType.REDUCE) {
      mrApp.waitForState(t,TaskState.RUNNING);
    }
  }
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,2);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.59f,job.getProgress(),0.001f);
  Assert.assertEquals(0.59f,rmApp.getProgress(),0.001f);
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,8);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.95f,job.getProgress(),0.001f);
  Assert.assertEquals(0.95f,rmApp.getProgress(),0.001f);
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testResource() throws Exception {
  LOG.info("Running testResource");
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",10240);
  MockNM nodeManager2=rm.registerNode("h2:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",10240);
  dispatcher.await();
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=createReq(jobId,2,2048,new String[]{"h2"});
  allocator.sendRequest(event2);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  nodeManager1.nodeHeartbeat(true);
  nodeManager2.nodeHeartbeat(true);
  nodeManager3.nodeHeartbeat(true);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  checkAssignments(new ContainerRequestEvent[]{event1,event2},assigned,false);
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testHeartbeatHandler() throws Exception {
  LOG.info("Running testHeartbeatHandler");
  Configuration conf=new Configuration();
  conf.setInt(MRJobConfig.MR_AM_TO_RM_HEARTBEAT_INTERVAL_MS,1);
  ControlledClock clock=new ControlledClock(new SystemClock());
  AppContext appContext=mock(AppContext.class);
  when(appContext.getClock()).thenReturn(clock);
  when(appContext.getApplicationID()).thenReturn(ApplicationId.newInstance(1,1));
  RMContainerAllocator allocator=new RMContainerAllocator(mock(ClientService.class),appContext,new NoopAMPreemptionPolicy()){
    @Override protected void register(){
    }
    @Override protected ApplicationMasterProtocol createSchedulerProxy(){
      return mock(ApplicationMasterProtocol.class);
    }
    @Override protected synchronized void heartbeat() throws Exception {
    }
  }
;
  allocator.init(conf);
  allocator.start();
  clock.setTime(5);
  int timeToWaitMs=5000;
  while (allocator.getLastHeartbeatTime() != 5 && timeToWaitMs > 0) {
    Thread.sleep(10);
    timeToWaitMs-=10;
  }
  Assert.assertEquals(5,allocator.getLastHeartbeatTime());
  clock.setTime(7);
  timeToWaitMs=5000;
  while (allocator.getLastHeartbeatTime() != 7 && timeToWaitMs > 0) {
    Thread.sleep(10);
    timeToWaitMs-=10;
  }
  Assert.assertEquals(7,allocator.getLastHeartbeatTime());
  final AtomicBoolean callbackCalled=new AtomicBoolean(false);
  allocator.runOnNextHeartbeat(new Runnable(){
    @Override public void run(){
      callbackCalled.set(true);
    }
  }
);
  clock.setTime(8);
  timeToWaitMs=5000;
  while (allocator.getLastHeartbeatTime() != 8 && timeToWaitMs > 0) {
    Thread.sleep(10);
    timeToWaitMs-=10;
  }
  Assert.assertEquals(8,allocator.getLastHeartbeatTime());
  Assert.assertTrue(callbackCalled.get());
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setup(){
  MyContainerAllocator.getJobUpdatedNodeEvents().clear();
  MyContainerAllocator.getTaskAttemptKillEvents().clear();
  UserGroupInformation.setLoginUser(null);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testReduceScheduling() throws Exception {
  int totalMaps=10;
  int succeededMaps=1;
  int scheduledMaps=10;
  int scheduledReduces=0;
  int assignedMaps=2;
  int assignedReduces=0;
  int mapResourceReqt=1024;
  int reduceResourceReqt=2 * 1024;
  int numPendingReduces=4;
  float maxReduceRampupLimit=0.5f;
  float reduceSlowStart=0.2f;
  RMContainerAllocator allocator=mock(RMContainerAllocator.class);
  doCallRealMethod().when(allocator).scheduleReduces(anyInt(),anyInt(),anyInt(),anyInt(),anyInt(),anyInt(),anyInt(),anyInt(),anyInt(),anyFloat(),anyFloat());
  allocator.scheduleReduces(totalMaps,succeededMaps,scheduledMaps,scheduledReduces,assignedMaps,assignedReduces,mapResourceReqt,reduceResourceReqt,numPendingReduces,maxReduceRampupLimit,reduceSlowStart);
  verify(allocator,never()).setIsReduceStarted(true);
  allocator.scheduleReduces(totalMaps,succeededMaps,0,scheduledReduces,totalMaps - succeededMaps,assignedReduces,mapResourceReqt,reduceResourceReqt,numPendingReduces,maxReduceRampupLimit,reduceSlowStart);
  verify(allocator,never()).setIsReduceStarted(true);
  verify(allocator,never()).scheduleAllReduces();
  succeededMaps=3;
  allocator.scheduleReduces(totalMaps,succeededMaps,scheduledMaps,scheduledReduces,assignedMaps,assignedReduces,mapResourceReqt,reduceResourceReqt,numPendingReduces,maxReduceRampupLimit,reduceSlowStart);
  verify(allocator,times(1)).setIsReduceStarted(true);
  doReturn(100 * 1024).when(allocator).getMemLimit();
  allocator.scheduleReduces(totalMaps,succeededMaps,scheduledMaps,scheduledReduces,assignedMaps,assignedReduces,mapResourceReqt,reduceResourceReqt,numPendingReduces,maxReduceRampupLimit,reduceSlowStart);
  verify(allocator).rampUpReduces(anyInt());
  verify(allocator,never()).rampDownReduces(anyInt());
  scheduledReduces=3;
  doReturn(10 * 1024).when(allocator).getMemLimit();
  allocator.scheduleReduces(totalMaps,succeededMaps,scheduledMaps,scheduledReduces,assignedMaps,assignedReduces,mapResourceReqt,reduceResourceReqt,numPendingReduces,maxReduceRampupLimit,reduceSlowStart);
  verify(allocator).rampDownReduces(anyInt());
  scheduledMaps=2;
  assignedReduces=2;
  doReturn(10 * 1024).when(allocator).getMemLimit();
  allocator.scheduleReduces(totalMaps,succeededMaps,scheduledMaps,scheduledReduces,assignedMaps,assignedReduces,mapResourceReqt,reduceResourceReqt,numPendingReduces,maxReduceRampupLimit,reduceSlowStart);
  verify(allocator,times(2)).rampDownReduces(anyInt());
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testBlackListedNodes() throws Exception {
  LOG.info("Running testBlackListedNodes");
  Configuration conf=new Configuration();
  conf.setBoolean(MRJobConfig.MR_AM_JOB_NODE_BLACKLISTING_ENABLE,true);
  conf.setInt(MRJobConfig.MAX_TASK_FAILURES_PER_TRACKER,1);
  conf.setInt(MRJobConfig.MR_AM_IGNORE_BLACKLISTING_BLACKLISTED_NODE_PERECENT,-1);
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",10240);
  MockNM nodeManager2=rm.registerNode("h2:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",10240);
  dispatcher.await();
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=createReq(jobId,2,1024,new String[]{"h2"});
  allocator.sendRequest(event2);
  ContainerRequestEvent event3=createReq(jobId,3,1024,new String[]{"h3"});
  allocator.sendRequest(event3);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  ContainerFailedEvent f1=createFailEvent(jobId,1,"h1",false);
  allocator.sendFailure(f1);
  ContainerFailedEvent f2=createFailEvent(jobId,1,"h2",false);
  allocator.sendFailure(f2);
  nodeManager1.nodeHeartbeat(true);
  nodeManager2.nodeHeartbeat(true);
  dispatcher.await();
  assigned=allocator.schedule();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  assertBlacklistAdditionsAndRemovals(2,0,rm);
  nodeManager1.nodeHeartbeat(false);
  nodeManager2.nodeHeartbeat(false);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  nodeManager3.nodeHeartbeat(true);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertTrue("No of assignments must be 3",assigned.size() == 3);
  for (  TaskAttemptContainerAssignedEvent assig : assigned) {
    Assert.assertTrue("Assigned container host not correct","h3".equals(assig.getContainer().getNodeId().getHost()));
  }
}

</code></pre>

<pre class="type-9 type-11 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testMapNodeLocality() throws Exception {
  LOG.info("Running testMapNodeLocality");
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",3072);
  rm.registerNode("h2:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",1536);
  dispatcher.await();
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=createReq(jobId,2,1024,new String[]{"h1"});
  allocator.sendRequest(event2);
  ContainerRequestEvent event3=createReq(jobId,3,1024,new String[]{"h2"});
  allocator.sendRequest(event3);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  nodeManager3.nodeHeartbeat(true);
  nodeManager1.nodeHeartbeat(true);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  checkAssignments(new ContainerRequestEvent[]{event1,event2,event3},assigned,false);
  for (  TaskAttemptContainerAssignedEvent event : assigned) {
    if (event.getTaskAttemptID().equals(event3.getAttemptID())) {
      assigned.remove(event);
      Assert.assertTrue(event.getContainer().getNodeId().getHost().equals("h3"));
      break;
    }
  }
  checkAssignments(new ContainerRequestEvent[]{event1,event2},assigned,true);
}

</code></pre>

<pre class="type-9 type-13 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testIgnoreBlacklisting() throws Exception {
  LOG.info("Running testIgnoreBlacklisting");
  Configuration conf=new Configuration();
  conf.setBoolean(MRJobConfig.MR_AM_JOB_NODE_BLACKLISTING_ENABLE,true);
  conf.setInt(MRJobConfig.MAX_TASK_FAILURES_PER_TRACKER,1);
  conf.setInt(MRJobConfig.MR_AM_IGNORE_BLACKLISTING_BLACKLISTED_NODE_PERECENT,33);
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM[] nodeManagers=new MockNM[10];
  int nmNum=0;
  List<TaskAttemptContainerAssignedEvent> assigned=null;
  nodeManagers[nmNum]=registerNodeManager(nmNum++,rm,dispatcher);
  nodeManagers[0].nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  assigned=getContainerOnHost(jobId,1,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  LOG.info("Failing container _1 on H1 (Node should be blacklisted and" + " ignore blacklisting enabled");
  ContainerFailedEvent f1=createFailEvent(jobId,1,"h1",false);
  allocator.sendFailure(f1);
  assigned=getContainerOnHost(jobId,2,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,1,0,0,1,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  assigned=getContainerOnHost(jobId,2,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  nodeManagers[nmNum]=registerNodeManager(nmNum++,rm,dispatcher);
  assigned=getContainerOnHost(jobId,3,1024,new String[]{"h2"},nodeManagers[1],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  nodeManagers[nmNum]=registerNodeManager(nmNum++,rm,dispatcher);
  assigned=getContainerOnHost(jobId,4,1024,new String[]{"h3"},nodeManagers[2],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  assigned=getContainerOnHost(jobId,5,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  nodeManagers[nmNum]=registerNodeManager(nmNum++,rm,dispatcher);
  assigned=getContainerOnHost(jobId,6,1024,new String[]{"h4"},nodeManagers[3],dispatcher,allocator,0,0,1,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  assigned=getContainerOnHost(jobId,7,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  ContainerFailedEvent f2=createFailEvent(jobId,3,"h2",false);
  allocator.sendFailure(f2);
  assigned=getContainerOnHost(jobId,8,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,1,0,0,2,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  assigned=getContainerOnHost(jobId,8,1024,new String[]{"h1"},nodeManagers[0],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 2",2,assigned.size());
  assigned=getContainerOnHost(jobId,9,1024,new String[]{"h2"},nodeManagers[1],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  ContainerFailedEvent f3=createFailEvent(jobId,4,"h3",false);
  allocator.sendFailure(f3);
  nodeManagers[nmNum]=registerNodeManager(nmNum++,rm,dispatcher);
  assigned=getContainerOnHost(jobId,10,1024,new String[]{"h3"},nodeManagers[2],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  for (int i=0; i < 5; i++) {
    nodeManagers[nmNum]=registerNodeManager(nmNum++,rm,dispatcher);
    assigned=getContainerOnHost(jobId,11 + i,1024,new String[]{String.valueOf(5 + i)},nodeManagers[4 + i],dispatcher,allocator,0,0,(i == 4 ? 3 : 0),0,rm);
    Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  }
  assigned=getContainerOnHost(jobId,20,1024,new String[]{"h3"},nodeManagers[2],dispatcher,allocator,0,0,0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
}

</code></pre>

<pre class="type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test(timeout=30000) public void testNonAggressivelyPreemptReducers() throws Exception {
  LOG.info("Running testPreemptReducers");
  final int preemptThreshold=2;
  Configuration conf=new Configuration();
  conf.setInt(MRJobConfig.MR_JOB_REDUCER_PREEMPT_DELAY_SEC,preemptThreshold);
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  ControlledClock clock=new ControlledClock(null);
  clock.setTime(1);
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob,clock);
  allocator.setMapResourceRequest(1024);
  allocator.setReduceResourceRequest(1024);
  RMContainerAllocator.AssignedRequests assignedRequests=allocator.getAssignedRequests();
  RMContainerAllocator.ScheduledRequests scheduledRequests=allocator.getScheduledRequests();
  ContainerRequestEvent event1=createReq(jobId,1,2048,new String[]{"h1"},false,false);
  scheduledRequests.maps.put(mock(TaskAttemptId.class),new RMContainerRequestor.ContainerRequest(event1,null,clock.getTime()));
  assignedRequests.reduces.put(mock(TaskAttemptId.class),mock(Container.class));
  clock.setTime(clock.getTime() + 1);
  allocator.preemptReducesIfNeeded();
  Assert.assertEquals("The reducer is aggressively preeempted",0,assignedRequests.preemptionWaitingReduces.size());
  clock.setTime(clock.getTime() + (preemptThreshold) * 1000);
  allocator.preemptReducesIfNeeded();
  Assert.assertEquals("The reducer is not preeempted",1,assignedRequests.preemptionWaitingReduces.size());
}

</code></pre>

<pre class="type-9 type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test(timeout=30000) public void testReducerRampdownDiagnostics() throws Exception {
  LOG.info("Running tesReducerRampdownDiagnostics");
  final Configuration conf=new Configuration();
  conf.setFloat(MRJobConfig.COMPLETED_MAPS_FOR_REDUCE_SLOWSTART,0.0f);
  final MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  final DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  final RMApp app=rm.submitApp(1024);
  dispatcher.await();
  final String host="host1";
  final MockNM nm=rm.registerNode(String.format("%s:1234",host),2048);
  nm.nodeHeartbeat(true);
  dispatcher.await();
  final ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  final JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  final Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  final MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  dispatcher.await();
  final String[] locations=new String[]{host};
  allocator.sendRequest(createReq(jobId,0,1024,locations,false,true));
  for (int i=0; i < 1; ) {
    dispatcher.await();
    i+=allocator.schedule().size();
    nm.nodeHeartbeat(true);
  }
  allocator.sendRequest(createReq(jobId,0,1024,locations,true,false));
  while (allocator.getTaskAttemptKillEvents().size() == 0) {
    dispatcher.await();
    allocator.schedule().size();
    nm.nodeHeartbeat(true);
  }
  final String killEventMessage=allocator.getTaskAttemptKillEvents().get(0).getMessage();
  Assert.assertTrue("No reducer rampDown preemption message",killEventMessage.contains(RMContainerAllocator.RAMPDOWN_DIAGNOSTIC));
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testUpdatedNodes() throws Exception {
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nm1=rm.registerNode("h1:1234",10240);
  MockNM nm2=rm.registerNode("h2:1234",10240);
  dispatcher.await();
  ContainerRequestEvent event=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event);
  TaskAttemptId attemptId=event.getAttemptID();
  TaskAttempt mockTaskAttempt=mock(TaskAttempt.class);
  when(mockTaskAttempt.getNodeId()).thenReturn(nm1.getNodeId());
  Task mockTask=mock(Task.class);
  when(mockTask.getAttempt(attemptId)).thenReturn(mockTaskAttempt);
  when(mockJob.getTask(attemptId.getTaskId())).thenReturn(mockTask);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  nm1.nodeHeartbeat(true);
  dispatcher.await();
  Assert.assertEquals(1,allocator.getJobUpdatedNodeEvents().size());
  Assert.assertEquals(3,allocator.getJobUpdatedNodeEvents().get(0).getUpdatedNodes().size());
  allocator.getJobUpdatedNodeEvents().clear();
  assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals(1,assigned.size());
  Assert.assertEquals(nm1.getNodeId(),assigned.get(0).getContainer().getNodeId());
  Assert.assertTrue(allocator.getJobUpdatedNodeEvents().isEmpty());
  Assert.assertTrue(allocator.getTaskAttemptKillEvents().isEmpty());
  nm1.nodeHeartbeat(false);
  nm2.nodeHeartbeat(false);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals(0,assigned.size());
  Assert.assertEquals(1,allocator.getJobUpdatedNodeEvents().size());
  Assert.assertEquals(1,allocator.getTaskAttemptKillEvents().size());
  Assert.assertEquals(2,allocator.getJobUpdatedNodeEvents().get(0).getUpdatedNodes().size());
  Assert.assertEquals(attemptId,allocator.getTaskAttemptKillEvents().get(0).getTaskAttemptID());
  allocator.getJobUpdatedNodeEvents().clear();
  allocator.getTaskAttemptKillEvents().clear();
  assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals(0,assigned.size());
  Assert.assertTrue(allocator.getJobUpdatedNodeEvents().isEmpty());
  Assert.assertTrue(allocator.getTaskAttemptKillEvents().isEmpty());
}

</code></pre>

<pre class="type-9 type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test public void testUnregistrationOnlyIfRegistered() throws Exception {
  Configuration conf=new Configuration();
  final MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher rmDispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp rmApp=rm.submitApp(1024);
  rmDispatcher.await();
  MockNM amNodeManager=rm.registerNode("127.0.0.1:1234",11264);
  amNodeManager.nodeHeartbeat(true);
  rmDispatcher.await();
  final ApplicationAttemptId appAttemptId=rmApp.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  rmDispatcher.await();
  MRApp mrApp=new MRApp(appAttemptId,ContainerId.newInstance(appAttemptId,0),10,0,false,this.getClass().getName(),true,1){
    @Override protected Dispatcher createDispatcher(){
      return new DrainDispatcher();
    }
    protected ContainerAllocator createContainerAllocator(    ClientService clientService,    AppContext context){
      return new MyContainerAllocator(rm,appAttemptId,context);
    }
  }
;
  mrApp.submit(conf);
  DrainDispatcher amDispatcher=(DrainDispatcher)mrApp.getDispatcher();
  MyContainerAllocator allocator=(MyContainerAllocator)mrApp.getContainerAllocator();
  amDispatcher.await();
  Assert.assertTrue(allocator.isApplicationMasterRegistered());
  mrApp.stop();
  Assert.assertTrue(allocator.isUnregistered());
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testBlackListedNodesWithSchedulingToThatNode() throws Exception {
  LOG.info("Running testBlackListedNodesWithSchedulingToThatNode");
  Configuration conf=new Configuration();
  conf.setBoolean(MRJobConfig.MR_AM_JOB_NODE_BLACKLISTING_ENABLE,true);
  conf.setInt(MRJobConfig.MAX_TASK_FAILURES_PER_TRACKER,1);
  conf.setInt(MRJobConfig.MR_AM_IGNORE_BLACKLISTING_BLACKLISTED_NODE_PERECENT,-1);
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",10240);
  dispatcher.await();
  LOG.info("Requesting 1 Containers _1 on H1");
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  LOG.info("RM Heartbeat (to send the container requests)");
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  LOG.info("h1 Heartbeat (To actually schedule the containers)");
  nodeManager1.nodeHeartbeat(true);
  dispatcher.await();
  LOG.info("RM Heartbeat (To process the scheduled containers)");
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 1",1,assigned.size());
  LOG.info("Failing container _1 on H1 (should blacklist the node)");
  ContainerFailedEvent f1=createFailEvent(jobId,1,"h1",false);
  allocator.sendFailure(f1);
  ContainerRequestEvent event1f=createReq(jobId,1,1024,new String[]{"h1"},true,false);
  allocator.sendRequest(event1f);
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(1,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  ContainerRequestEvent event3=createReq(jobId,3,1024,new String[]{"h1","h3"});
  allocator.sendRequest(event3);
  LOG.info("h1 Heartbeat (To actually schedule the containers)");
  nodeManager1.nodeHeartbeat(true);
  dispatcher.await();
  LOG.info("RM Heartbeat (To process the scheduled containers)");
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  LOG.info("RM Heartbeat (To process the re-scheduled containers)");
  assigned=allocator.schedule();
  dispatcher.await();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  LOG.info("h3 Heartbeat (To re-schedule the containers)");
  nodeManager3.nodeHeartbeat(true);
  dispatcher.await();
  LOG.info("RM Heartbeat (To process the re-scheduled containers for H3)");
  assigned=allocator.schedule();
  assertBlacklistAdditionsAndRemovals(0,0,rm);
  dispatcher.await();
  for (  TaskAttemptContainerAssignedEvent assig : assigned) {
    LOG.info(assig.getTaskAttemptID() + " assgined to " + assig.getContainer().getId()+ " with priority "+ assig.getContainer().getPriority());
  }
  Assert.assertEquals("No of assignments must be 2",2,assigned.size());
  for (  TaskAttemptContainerAssignedEvent assig : assigned) {
    Assert.assertEquals("Assigned container " + assig.getContainer().getId() + " host not correct","h3",assig.getContainer().getNodeId().getHost());
  }
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testSimple() throws Exception {
  LOG.info("Running testSimple");
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",10240);
  MockNM nodeManager2=rm.registerNode("h2:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",10240);
  dispatcher.await();
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=createReq(jobId,2,1024,new String[]{"h2"});
  allocator.sendRequest(event2);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  Assert.assertEquals(4,rm.getMyFifoScheduler().lastAsk.size());
  ContainerRequestEvent event3=createReq(jobId,3,1024,new String[]{"h3"});
  allocator.sendRequest(event3);
  assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  Assert.assertEquals(3,rm.getMyFifoScheduler().lastAsk.size());
  nodeManager1.nodeHeartbeat(true);
  nodeManager2.nodeHeartbeat(true);
  nodeManager3.nodeHeartbeat(true);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals(0,rm.getMyFifoScheduler().lastAsk.size());
  checkAssignments(new ContainerRequestEvent[]{event1,event2,event3},assigned,false);
  assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals(5,rm.getMyFifoScheduler().lastAsk.size());
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testCompletedContainerEvent(){
  RMContainerAllocator allocator=new RMContainerAllocator(mock(ClientService.class),mock(AppContext.class),new NoopAMPreemptionPolicy());
  TaskAttemptId attemptId=MRBuilderUtils.newTaskAttemptId(MRBuilderUtils.newTaskId(MRBuilderUtils.newJobId(1,1,1),1,TaskType.MAP),1);
  ApplicationId applicationId=ApplicationId.newInstance(1,1);
  ApplicationAttemptId applicationAttemptId=ApplicationAttemptId.newInstance(applicationId,1);
  ContainerId containerId=ContainerId.newInstance(applicationAttemptId,1);
  ContainerStatus status=ContainerStatus.newInstance(containerId,ContainerState.RUNNING,"",0);
  ContainerStatus abortedStatus=ContainerStatus.newInstance(containerId,ContainerState.RUNNING,"",ContainerExitStatus.ABORTED);
  TaskAttemptEvent event=allocator.createContainerFinishedEvent(status,attemptId);
  Assert.assertEquals(TaskAttemptEventType.TA_CONTAINER_COMPLETED,event.getType());
  TaskAttemptEvent abortedEvent=allocator.createContainerFinishedEvent(abortedStatus,attemptId);
  Assert.assertEquals(TaskAttemptEventType.TA_KILL,abortedEvent.getType());
  ContainerId containerId2=ContainerId.newInstance(applicationAttemptId,2);
  ContainerStatus status2=ContainerStatus.newInstance(containerId2,ContainerState.RUNNING,"",0);
  ContainerStatus preemptedStatus=ContainerStatus.newInstance(containerId2,ContainerState.RUNNING,"",ContainerExitStatus.PREEMPTED);
  TaskAttemptEvent event2=allocator.createContainerFinishedEvent(status2,attemptId);
  Assert.assertEquals(TaskAttemptEventType.TA_CONTAINER_COMPLETED,event2.getType());
  TaskAttemptEvent abortedEvent2=allocator.createContainerFinishedEvent(preemptedStatus,attemptId);
  Assert.assertEquals(TaskAttemptEventType.TA_KILL,abortedEvent2.getType());
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testReportedAppProgressWithOnlyMaps() throws Exception {
  LOG.info("Running testReportedAppProgressWithOnlyMaps");
  Configuration conf=new Configuration();
  final MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher rmDispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp rmApp=rm.submitApp(1024);
  rmDispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",11264);
  amNodeManager.nodeHeartbeat(true);
  rmDispatcher.await();
  final ApplicationAttemptId appAttemptId=rmApp.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  rmDispatcher.await();
  MRApp mrApp=new MRApp(appAttemptId,ContainerId.newInstance(appAttemptId,0),10,0,false,this.getClass().getName(),true,1){
    @Override protected Dispatcher createDispatcher(){
      return new DrainDispatcher();
    }
    protected ContainerAllocator createContainerAllocator(    ClientService clientService,    AppContext context){
      return new MyContainerAllocator(rm,appAttemptId,context);
    }
  }
;
  Assert.assertEquals(0.0,rmApp.getProgress(),0.0);
  mrApp.submit(conf);
  Job job=mrApp.getContext().getAllJobs().entrySet().iterator().next().getValue();
  DrainDispatcher amDispatcher=(DrainDispatcher)mrApp.getDispatcher();
  MyContainerAllocator allocator=(MyContainerAllocator)mrApp.getContainerAllocator();
  mrApp.waitForInternalState((JobImpl)job,JobStateInternal.RUNNING);
  amDispatcher.await();
  for (  Task t : job.getTasks().values()) {
    mrApp.waitForInternalState((TaskAttemptImpl)t.getAttempts().values().iterator().next(),TaskAttemptStateInternal.UNASSIGNED);
  }
  amDispatcher.await();
  allocator.schedule();
  rmDispatcher.await();
  amNodeManager.nodeHeartbeat(true);
  rmDispatcher.await();
  allocator.schedule();
  rmDispatcher.await();
  for (  Task t : job.getTasks().values()) {
    mrApp.waitForState(t,TaskState.RUNNING);
  }
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.05f,job.getProgress(),0.001f);
  Assert.assertEquals(0.05f,rmApp.getProgress(),0.001f);
  Iterator<Task> it=job.getTasks().values().iterator();
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,1);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.14f,job.getProgress(),0.001f);
  Assert.assertEquals(0.14f,rmApp.getProgress(),0.001f);
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,5);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.59f,job.getProgress(),0.001f);
  Assert.assertEquals(0.59f,rmApp.getProgress(),0.001f);
  finishNextNTasks(rmDispatcher,amNodeManager,mrApp,it,4);
  allocator.schedule();
  rmDispatcher.await();
  Assert.assertEquals(0.95f,job.getProgress(),0.001f);
  Assert.assertEquals(0.95f,rmApp.getProgress(),0.001f);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testRMContainerAllocatorResendsRequestsOnRMRestart() throws Exception {
  Configuration conf=new Configuration();
  conf.set(YarnConfiguration.RECOVERY_ENABLED,"true");
  conf.set(YarnConfiguration.RM_STORE,MemoryRMStateStore.class.getName());
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  conf.setBoolean(YarnConfiguration.RM_WORK_PRESERVING_RECOVERY_ENABLED,true);
  conf.setBoolean(MRJobConfig.MR_AM_JOB_NODE_BLACKLISTING_ENABLE,true);
  conf.setInt(MRJobConfig.MAX_TASK_FAILURES_PER_TRACKER,1);
  conf.setInt(MRJobConfig.MR_AM_IGNORE_BLACKLISTING_BLACKLISTED_NODE_PERECENT,-1);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  MyResourceManager rm1=new MyResourceManager(conf,memStore);
  rm1.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm1.getRMContext().getDispatcher();
  RMApp app=rm1.submitApp(1024);
  dispatcher.await();
  MockNM nm1=new MockNM("h1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  nm1.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm1.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm1,conf,appAttemptId,mockJob);
  ContainerRequestEvent event1=createReq(jobId,1,1024,new String[]{"h1"});
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=createReq(jobId,2,2048,new String[]{"h1","h2"});
  allocator.sendRequest(event2);
  ContainerFailedEvent f1=createFailEvent(jobId,1,"h2",false);
  allocator.sendFailure(f1);
  List<TaskAttemptContainerAssignedEvent> assignedContainers=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assignedContainers.size());
  assertAsksAndReleases(3,0,rm1);
  assertBlacklistAdditionsAndRemovals(1,0,rm1);
  nm1.nodeHeartbeat(true);
  dispatcher.await();
  assignedContainers=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 2",2,assignedContainers.size());
  assertAsksAndReleases(0,0,rm1);
  assertBlacklistAdditionsAndRemovals(0,0,rm1);
  assignedContainers=allocator.schedule();
  Assert.assertEquals("No of assignments must be 0",0,assignedContainers.size());
  assertAsksAndReleases(3,0,rm1);
  assertBlacklistAdditionsAndRemovals(0,0,rm1);
  ContainerRequestEvent event3=createReq(jobId,3,1000,new String[]{"h1"});
  allocator.sendRequest(event3);
  ContainerAllocatorEvent deallocate1=createDeallocateEvent(jobId,1,false);
  allocator.sendDeallocate(deallocate1);
  assignedContainers=allocator.schedule();
  Assert.assertEquals("No of assignments must be 0",0,assignedContainers.size());
  assertAsksAndReleases(3,1,rm1);
  assertBlacklistAdditionsAndRemovals(0,0,rm1);
  MyResourceManager rm2=new MyResourceManager(conf,memStore);
  rm2.start();
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  allocator.updateSchedulerProxy(rm2);
  dispatcher=(DrainDispatcher)rm2.getRMContext().getDispatcher();
  NodeHeartbeatResponse hbResponse=nm1.nodeHeartbeat(true);
  Assert.assertEquals(NodeAction.RESYNC,hbResponse.getNodeAction());
  nm1=new MockNM("h1:1234",10240,rm2.getResourceTrackerService());
  nm1.registerNode();
  nm1.nodeHeartbeat(true);
  dispatcher.await();
  ContainerAllocatorEvent deallocate2=createDeallocateEvent(jobId,2,false);
  allocator.sendDeallocate(deallocate2);
  ContainerFailedEvent f2=createFailEvent(jobId,1,"h3",false);
  allocator.sendFailure(f2);
  ContainerRequestEvent event4=createReq(jobId,4,2000,new String[]{"h1","h2"});
  allocator.sendRequest(event4);
  allocator.schedule();
  dispatcher.await();
  Assert.assertTrue("Last allocate response is not RESYNC",allocator.isResyncCommand());
  ContainerRequestEvent event5=createReq(jobId,5,3000,new String[]{"h1","h2","h3"});
  allocator.sendRequest(event5);
  assignedContainers=allocator.schedule();
  dispatcher.await();
  assertAsksAndReleases(3,2,rm2);
  assertBlacklistAdditionsAndRemovals(2,0,rm2);
  nm1.nodeHeartbeat(true);
  dispatcher.await();
  assignedContainers=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("Number of container should be 3",3,assignedContainers.size());
  for (  TaskAttemptContainerAssignedEvent assig : assignedContainers) {
    Assert.assertTrue("Assigned count not correct","h1".equals(assig.getContainer().getNodeId().getHost()));
  }
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testMapReduceScheduling() throws Exception {
  LOG.info("Running testMapReduceScheduling");
  Configuration conf=new Configuration();
  MyResourceManager rm=new MyResourceManager(conf);
  rm.start();
  DrainDispatcher dispatcher=(DrainDispatcher)rm.getRMContext().getDispatcher();
  RMApp app=rm.submitApp(1024);
  dispatcher.await();
  MockNM amNodeManager=rm.registerNode("amNM:1234",2048);
  amNodeManager.nodeHeartbeat(true);
  dispatcher.await();
  ApplicationAttemptId appAttemptId=app.getCurrentAppAttempt().getAppAttemptId();
  rm.sendAMLaunched(appAttemptId);
  dispatcher.await();
  JobId jobId=MRBuilderUtils.newJobId(appAttemptId.getApplicationId(),0);
  Job mockJob=mock(Job.class);
  when(mockJob.getReport()).thenReturn(MRBuilderUtils.newJobReport(jobId,"job","user",JobState.RUNNING,0,0,0,0,0,0,0,"jobfile",null,false,""));
  MyContainerAllocator allocator=new MyContainerAllocator(rm,conf,appAttemptId,mockJob);
  MockNM nodeManager1=rm.registerNode("h1:1234",1024);
  MockNM nodeManager2=rm.registerNode("h2:1234",10240);
  MockNM nodeManager3=rm.registerNode("h3:1234",10240);
  dispatcher.await();
  ContainerRequestEvent event1=createReq(jobId,1,2048,new String[]{"h1","h2"},true,false);
  allocator.sendRequest(event1);
  ContainerRequestEvent event2=createReq(jobId,2,3000,new String[]{"h1"},false,true);
  allocator.sendRequest(event2);
  ContainerRequestEvent event3=createReq(jobId,3,2048,new String[]{"h3"},false,false);
  allocator.sendRequest(event3);
  List<TaskAttemptContainerAssignedEvent> assigned=allocator.schedule();
  dispatcher.await();
  Assert.assertEquals("No of assignments must be 0",0,assigned.size());
  nodeManager1.nodeHeartbeat(true);
  nodeManager2.nodeHeartbeat(true);
  nodeManager3.nodeHeartbeat(true);
  dispatcher.await();
  assigned=allocator.schedule();
  dispatcher.await();
  checkAssignments(new ContainerRequestEvent[]{event1,event3},assigned,false);
  for (  TaskAttemptContainerAssignedEvent assig : assigned) {
    Assert.assertFalse("Assigned count not correct","h1".equals(assig.getContainer().getNodeId().getHost()));
  }
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
