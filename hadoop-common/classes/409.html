<h3 style="margin:0px">Class: org.apache.hadoop.hdfs.server.blockmanagement.TestReplicationPolicy (24 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(17)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(15)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(14)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(12)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(8)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(6)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="20"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('20')" data-toggle="tooltip" title="Verifies values related to public fields."><kbd id="tag-20"class="label-info"style="display: inline-block;font-size:7pt" >PublicFieldVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-9 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, client is is a node outside of file system.
 * So the 1st replica can be placed on any node. 
 * the 2nd replica should be placed on a different rack,
 * the 3rd replica should be placed on the same rack as the 2nd replica,
 * @throws Exception
 */
@Test public void testChooseTarget5() throws Exception {
  DatanodeDescriptor writerDesc=DFSTestUtil.getDatanodeDescriptor("7.7.7.7","/d2/r4");
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0,writerDesc);
  assertEquals(targets.length,0);
  targets=chooseTarget(1,writerDesc);
  assertEquals(targets.length,1);
  targets=chooseTarget(2,writerDesc);
  assertEquals(targets.length,2);
  assertFalse(isOnSameRack(targets[0],targets[1]));
  targets=chooseTarget(3,writerDesc);
  assertEquals(targets.length,3);
  assertTrue(isOnSameRack(targets[1],targets[2]));
  assertFalse(isOnSameRack(targets[0],targets[1]));
}

</code></pre>

<pre class="type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
/** 
 * Test for the chooseReplicaToDelete are processed based on 
 * block locality and free space
 */
@Test public void testChooseReplicaToDelete() throws Exception {
  List<DatanodeStorageInfo> replicaList=new ArrayList<DatanodeStorageInfo>();
  final Map<String,List<DatanodeStorageInfo>> rackMap=new HashMap<String,List<DatanodeStorageInfo>>();
  dataNodes[0].setRemaining(4 * 1024 * 1024);
  replicaList.add(storages[0]);
  dataNodes[1].setRemaining(3 * 1024 * 1024);
  replicaList.add(storages[1]);
  dataNodes[2].setRemaining(2 * 1024 * 1024);
  replicaList.add(storages[2]);
  dataNodes[5].setRemaining(1 * 1024 * 1024);
  replicaList.add(storages[5]);
  for (int i=0; i < dataNodes.length; i++) {
    dataNodes[i].setLastUpdate(Time.now());
  }
  List<DatanodeStorageInfo> first=new ArrayList<DatanodeStorageInfo>();
  List<DatanodeStorageInfo> second=new ArrayList<DatanodeStorageInfo>();
  replicator.splitNodesWithRack(replicaList,rackMap,first,second);
  assertEquals(2,first.size());
  assertEquals(2,second.size());
  DatanodeStorageInfo chosen=replicator.chooseReplicaToDelete(null,null,(short)3,first,second);
  assertEquals(chosen,storages[1]);
  replicator.adjustSetsWithChosenReplica(rackMap,first,second,chosen);
  assertEquals(0,first.size());
  assertEquals(3,second.size());
  chosen=replicator.chooseReplicaToDelete(null,null,(short)2,first,second);
  assertEquals(chosen,storages[5]);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testChooseTargetWithStaleNodes() throws Exception {
  dataNodes[0].setLastUpdate(Time.now() - staleInterval - 1);
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
  assertTrue(namenode.getNamesystem().getBlockManager().getDatanodeManager().shouldAvoidStaleDataNodesForWrite());
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertEquals(storages[1],targets[0]);
  Set<Node> excludedNodes=new HashSet<Node>();
  excludedNodes.add(dataNodes[1]);
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<DatanodeStorageInfo>();
  targets=chooseTarget(1,chosenNodes,excludedNodes);
  assertEquals(targets.length,1);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  dataNodes[0].setLastUpdate(Time.now());
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
}

</code></pre>

<pre class="type-13 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, client is dataNodes[0], but dataNodes[0] is not qualified
 * to be chosen. So the 1st replica should be placed on dataNodes[1], 
 * the 2nd replica should be placed on a different rack,
 * the 3rd replica should be placed on the same rack as the 2nd replica,
 * and the rest should be placed on the third rack.
 * @throws Exception
 */
@Test public void testChooseTarget3() throws Exception {
  updateHeartbeatWithUsage(dataNodes[0],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,(HdfsConstants.MIN_BLOCKS_FOR_WRITE - 1) * BLOCK_SIZE,0L,0L,0L,0,0);
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0);
  assertEquals(targets.length,0);
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertEquals(storages[1],targets[0]);
  targets=chooseTarget(2);
  assertEquals(targets.length,2);
  assertEquals(storages[1],targets[0]);
  assertFalse(isOnSameRack(targets[0],targets[1]));
  targets=chooseTarget(3);
  assertEquals(targets.length,3);
  assertEquals(storages[1],targets[0]);
  assertTrue(isOnSameRack(targets[1],targets[2]));
  assertFalse(isOnSameRack(targets[0],targets[1]));
  targets=chooseTarget(4);
  assertEquals(targets.length,4);
  assertEquals(storages[1],targets[0]);
  for (int i=1; i < 4; i++) {
    assertFalse(isOnSameRack(targets[0],targets[i]));
  }
  assertTrue(isOnSameRack(targets[1],targets[2]) || isOnSameRack(targets[2],targets[3]));
  assertFalse(isOnSameRack(targets[1],targets[3]));
  updateHeartbeatWithUsage(dataNodes[0],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,0L,0L,0,0);
}

</code></pre>

<pre class="type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, we set 3 nodes (dataNodes[0] ~ dataNodes[2]) as stale,
 * and when the number of replicas is less or equal to 3, all the healthy
 * datanodes should be returned by the chooseTarget method. When the number 
 * of replicas is 4, a stale node should be included.
 * @throws Exception
 */
@Test public void testChooseTargetWithHalfStaleNodes() throws Exception {
  for (int i=0; i < 3; i++) {
    dataNodes[i].setLastUpdate(Time.now() - staleInterval - 1);
  }
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
  DatanodeStorageInfo[] targets=chooseTarget(0);
  assertEquals(targets.length,0);
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertFalse(containsWithinRange(targets[0],dataNodes,0,2));
  targets=chooseTarget(2);
  assertEquals(targets.length,2);
  assertFalse(containsWithinRange(targets[0],dataNodes,0,2));
  assertFalse(containsWithinRange(targets[1],dataNodes,0,2));
  targets=chooseTarget(3);
  assertEquals(targets.length,3);
  assertTrue(containsWithinRange(targets[0],dataNodes,3,5));
  assertTrue(containsWithinRange(targets[1],dataNodes,3,5));
  assertTrue(containsWithinRange(targets[2],dataNodes,3,5));
  targets=chooseTarget(4);
  assertEquals(targets.length,4);
  assertTrue(containsWithinRange(dataNodes[3],targets,0,3));
  assertTrue(containsWithinRange(dataNodes[4],targets,0,3));
  assertTrue(containsWithinRange(dataNodes[5],targets,0,3));
  for (int i=0; i < dataNodes.length; i++) {
    dataNodes[i].setLastUpdate(Time.now());
  }
  namenode.getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * In this testcase, it tries to choose more targets than available nodes and
 * check the result, with stale node avoidance on the write path enabled.
 * @throws Exception
 */
@Test public void testChooseTargetWithMoreThanAvailableNodesWithStaleness() throws Exception {
  try {
    namenode.getNamesystem().getBlockManager().getDatanodeManager().setNumStaleNodes(NUM_OF_DATANODES);
    testChooseTargetWithMoreThanAvailableNodes();
  }
  finally {
    namenode.getNamesystem().getBlockManager().getDatanodeManager().setNumStaleNodes(0);
  }
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=60000) public void testConvertLastBlockToUnderConstructionDoesNotCauseSkippedReplication() throws IOException {
  Namesystem mockNS=mock(Namesystem.class);
  when(mockNS.isPopulatingReplQueues()).thenReturn(true);
  FSClusterStats mockStats=mock(FSClusterStats.class);
  BlockManager bm=new BlockManager(mockNS,mockStats,new HdfsConfiguration());
  UnderReplicatedBlocks underReplicatedBlocks=bm.neededReplications;
  Block block1=new Block(random.nextLong());
  Block block2=new Block(random.nextLong());
  underReplicatedBlocks.add(block1,0,1,1);
  underReplicatedBlocks.add(block2,0,1,1);
  List<List<Block>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
  final BlockInfo info=new BlockInfo(block1,1);
  final BlockCollection mbc=mock(BlockCollection.class);
  when(mbc.getLastBlock()).thenReturn(info);
  when(mbc.getPreferredBlockSize()).thenReturn(block1.getNumBytes() + 1);
  when(mbc.getBlockReplication()).thenReturn((short)1);
  when(mbc.isUnderConstruction()).thenReturn(true);
  ContentSummary cs=mock(ContentSummary.class);
  when(cs.getLength()).thenReturn((long)1);
  when(mbc.computeContentSummary()).thenReturn(cs);
  info.setBlockCollection(mbc);
  bm.addBlockCollection(info,mbc);
  DatanodeStorageInfo[] storageAry={new DatanodeStorageInfo(dataNodes[0],new DatanodeStorage("s1"))};
  final BlockInfoUnderConstruction ucBlock=info.convertToBlockUnderConstruction(BlockUCState.UNDER_CONSTRUCTION,storageAry);
  when(mbc.setLastBlock((BlockInfo)any(),(DatanodeStorageInfo[])any())).thenReturn(ucBlock);
  bm.convertLastBlockToUnderConstruction(mbc);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-20 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testChooseTargetWithMoreThanHalfStaleNodes() throws Exception {
  HdfsConfiguration conf=new HdfsConfiguration();
  conf.setBoolean(DFSConfigKeys.DFS_NAMENODE_AVOID_STALE_DATANODE_FOR_WRITE_KEY,true);
  String[] hosts=new String[]{"host1","host2","host3","host4","host5","host6"};
  String[] racks=new String[]{"/d1/r1","/d1/r1","/d1/r2","/d1/r2","/d2/r3","/d2/r3"};
  MiniDFSCluster miniCluster=new MiniDFSCluster.Builder(conf).racks(racks).hosts(hosts).numDataNodes(hosts.length).build();
  miniCluster.waitActive();
  try {
    for (int i=0; i < 2; i++) {
      DataNode dn=miniCluster.getDataNodes().get(i);
      DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,true);
      miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(dn.getDatanodeId()).setLastUpdate(Time.now() - staleInterval - 1);
    }
    miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
    int numStaleNodes=miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getNumStaleNodes();
    assertEquals(numStaleNodes,2);
    assertTrue(miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().shouldAvoidStaleDataNodesForWrite());
    DatanodeDescriptor staleNodeInfo=miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(miniCluster.getDataNodes().get(0).getDatanodeId());
    BlockPlacementPolicy replicator=miniCluster.getNameNode().getNamesystem().getBlockManager().getBlockPlacementPolicy();
    DatanodeStorageInfo[] targets=replicator.chooseTarget(filename,3,staleNodeInfo,new ArrayList<DatanodeStorageInfo>(),false,null,BLOCK_SIZE,StorageType.DEFAULT);
    assertEquals(targets.length,3);
    assertFalse(isOnSameRack(targets[0],staleNodeInfo));
    for (int i=0; i < 4; i++) {
      DataNode dn=miniCluster.getDataNodes().get(i);
      DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,true);
      miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(dn.getDatanodeId()).setLastUpdate(Time.now() - staleInterval - 1);
    }
    miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
    numStaleNodes=miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getNumStaleNodes();
    assertEquals(numStaleNodes,4);
    assertFalse(miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().shouldAvoidStaleDataNodesForWrite());
    targets=replicator.chooseTarget(filename,3,staleNodeInfo,new ArrayList<DatanodeStorageInfo>(),false,null,BLOCK_SIZE,StorageType.DEFAULT);
    assertEquals(targets.length,3);
    assertTrue(isOnSameRack(targets[0],staleNodeInfo));
    for (int i=2; i < 4; i++) {
      DataNode dn=miniCluster.getDataNodes().get(i);
      DataNodeTestUtils.setHeartbeatsDisabledForTests(dn,false);
      miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getDatanode(dn.getDatanodeId()).setLastUpdate(Time.now());
    }
    miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getHeartbeatManager().heartbeatCheck();
    numStaleNodes=miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().getNumStaleNodes();
    assertEquals(numStaleNodes,2);
    assertTrue(miniCluster.getNameNode().getNamesystem().getBlockManager().getDatanodeManager().shouldAvoidStaleDataNodesForWrite());
    targets=chooseTarget(3,staleNodeInfo);
    assertEquals(targets.length,3);
    assertFalse(isOnSameRack(targets[0],staleNodeInfo));
  }
  finally {
    miniCluster.shutdown();
  }
}

</code></pre>

<pre class="type-13 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, client is dataNodes[0], but none of the nodes on rack 1
 * is qualified to be chosen. So the 1st replica should be placed on either
 * rack 2 or rack 3. 
 * the 2nd replica should be placed on a different rack,
 * the 3rd replica should be placed on the same rack as the 1st replica,
 * @throws Exception
 */
@Test public void testChoooseTarget4() throws Exception {
  for (int i=0; i < 2; i++) {
    updateHeartbeatWithUsage(dataNodes[i],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,(HdfsConstants.MIN_BLOCKS_FOR_WRITE - 1) * BLOCK_SIZE,0L,0L,0L,0,0);
  }
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0);
  assertEquals(targets.length,0);
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  targets=chooseTarget(2);
  assertEquals(targets.length,2);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  assertFalse(isOnSameRack(targets[0],targets[1]));
  targets=chooseTarget(3);
  assertEquals(targets.length,3);
  for (int i=0; i < 3; i++) {
    assertFalse(isOnSameRack(targets[i],dataNodes[0]));
  }
  assertTrue(isOnSameRack(targets[0],targets[1]) || isOnSameRack(targets[1],targets[2]));
  assertFalse(isOnSameRack(targets[0],targets[2]));
  for (int i=0; i < 2; i++) {
    updateHeartbeatWithUsage(dataNodes[i],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,0L,0L,0,0);
  }
}

</code></pre>

<pre class="type-9 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
"></span><br>
/** 
 * This testcase tests whether an IllegalArgumentException 
 * will be thrown when a value greater than 1 is retrieved by 
 * DFSUtil#getInvalidateWorkPctPerIteration
 */
@Test public void testGetInvalidateWorkPctPerIteration_GreaterThanOne(){
  Configuration conf=new Configuration();
  float blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
  assertTrue(blocksInvalidateWorkPct > 0);
  conf.set(DFSConfigKeys.DFS_NAMENODE_INVALIDATE_WORK_PCT_PER_ITERATION,"1.5f");
  exception.expect(IllegalArgumentException.class);
  blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Test for the high priority blocks are processed before the low priority
 * blocks.
 */
@Test(timeout=60000) public void testReplicationWithPriority() throws Exception {
  int DFS_NAMENODE_REPLICATION_INTERVAL=1000;
  int HIGH_PRIORITY=0;
  Configuration conf=new Configuration();
  conf.setInt(DFSConfigKeys.DFS_NAMENODE_REPLICATION_INTERVAL_KEY,1);
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).format(true).build();
  try {
    cluster.waitActive();
    final UnderReplicatedBlocks neededReplications=cluster.getNameNode().getNamesystem().getBlockManager().neededReplications;
    for (int i=0; i < 100; i++) {
      neededReplications.add(new Block(random.nextLong()),2,0,3);
    }
    Thread.sleep(DFS_NAMENODE_REPLICATION_INTERVAL);
    neededReplications.add(new Block(random.nextLong()),1,0,3);
    Thread.sleep(DFS_NAMENODE_REPLICATION_INTERVAL);
    assertFalse("Not able to clear the element from high priority list",neededReplications.iterator(HIGH_PRIORITY).hasNext());
  }
  finally {
    cluster.shutdown();
  }
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This testcase tests whether the value returned by
 * DFSUtil.getReplWorkMultiplier() is positive,
 * and whether an IllegalArgumentException will be thrown 
 * when a non-positive value is retrieved
 */
@Test public void testGetReplWorkMultiplier(){
  Configuration conf=new Configuration();
  int blocksReplWorkMultiplier=DFSUtil.getReplWorkMultiplier(conf);
  assertTrue(blocksReplWorkMultiplier > 0);
  conf.set(DFSConfigKeys.DFS_NAMENODE_REPLICATION_WORK_MULTIPLIER_PER_ITERATION,"3");
  blocksReplWorkMultiplier=DFSUtil.getReplWorkMultiplier(conf);
  assertEquals(blocksReplWorkMultiplier,3);
  conf.set(DFSConfigKeys.DFS_NAMENODE_REPLICATION_WORK_MULTIPLIER_PER_ITERATION,"-1");
  exception.expect(IllegalArgumentException.class);
  blocksReplWorkMultiplier=DFSUtil.getReplWorkMultiplier(conf);
}

</code></pre>

<pre class="type-9 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This testcase tests re-replication, when dataNodes[0] is already chosen.
 * So the 1st replica can be placed on random rack. 
 * the 2nd replica should be placed on different node by same rack as 
 * the 1st replica. The 3rd replica can be placed randomly.
 * @throws Exception
 */
@Test public void testRereplicate1() throws Exception {
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<DatanodeStorageInfo>();
  chosenNodes.add(storages[0]);
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0,chosenNodes);
  assertEquals(targets.length,0);
  targets=chooseTarget(1,chosenNodes);
  assertEquals(targets.length,1);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  targets=chooseTarget(2,chosenNodes);
  assertEquals(targets.length,2);
  assertTrue(isOnSameRack(targets[0],dataNodes[0]));
  assertFalse(isOnSameRack(targets[0],targets[1]));
  targets=chooseTarget(3,chosenNodes);
  assertEquals(targets.length,3);
  assertTrue(isOnSameRack(targets[0],dataNodes[0]));
  assertFalse(isOnSameRack(targets[0],targets[2]));
}

</code></pre>

<pre class="type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, client is dataNodes[0]. So the 1st replica should be
 * placed on dataNodes[0], the 2nd replica should be placed on 
 * different rack and third should be placed on different node
 * of rack chosen for 2nd node.
 * The only excpetion is when the <i>numOfReplicas</i> is 2, 
 * the 1st is on dataNodes[0] and the 2nd is on a different rack.
 * @throws Exception
 */
@Test public void testChooseTarget1() throws Exception {
  updateHeartbeatWithUsage(dataNodes[0],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,0L,0L,4,0);
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0);
  assertEquals(targets.length,0);
  targets=chooseTarget(1);
  assertEquals(targets.length,1);
  assertEquals(storages[0],targets[0]);
  targets=chooseTarget(2);
  assertEquals(targets.length,2);
  assertEquals(storages[0],targets[0]);
  assertFalse(isOnSameRack(targets[0],targets[1]));
  targets=chooseTarget(3);
  assertEquals(targets.length,3);
  assertEquals(storages[0],targets[0]);
  assertFalse(isOnSameRack(targets[0],targets[1]));
  assertTrue(isOnSameRack(targets[1],targets[2]));
  targets=chooseTarget(4);
  assertEquals(targets.length,4);
  assertEquals(storages[0],targets[0]);
  assertTrue(isOnSameRack(targets[1],targets[2]) || isOnSameRack(targets[2],targets[3]));
  assertFalse(isOnSameRack(targets[0],targets[2]));
  updateHeartbeatWithUsage(dataNodes[0],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,0L,0L,0,0);
}

</code></pre>

<pre class="type-9 type-13 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, client is dataNodes[0], but the dataNodes[1] is
 * not allowed to be chosen. So the 1st replica should be
 * placed on dataNodes[0], the 2nd replica should be placed on a different
 * rack, the 3rd should be on same rack as the 2nd replica, and the rest
 * should be placed on a third rack.
 * @throws Exception
 */
@Test public void testChooseTarget2() throws Exception {
  Set<Node> excludedNodes;
  DatanodeStorageInfo[] targets;
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<DatanodeStorageInfo>();
  excludedNodes=new HashSet<Node>();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(0,chosenNodes,excludedNodes);
  assertEquals(targets.length,0);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(1,chosenNodes,excludedNodes);
  assertEquals(targets.length,1);
  assertEquals(storages[0],targets[0]);
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(2,chosenNodes,excludedNodes);
  assertEquals(targets.length,2);
  assertEquals(storages[0],targets[0]);
  assertFalse(isOnSameRack(targets[0],targets[1]));
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(3,chosenNodes,excludedNodes);
  assertEquals(targets.length,3);
  assertEquals(storages[0],targets[0]);
  assertFalse(isOnSameRack(targets[0],targets[1]));
  assertTrue(isOnSameRack(targets[1],targets[2]));
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  targets=chooseTarget(4,chosenNodes,excludedNodes);
  assertEquals(targets.length,4);
  assertEquals(storages[0],targets[0]);
  for (int i=1; i < 4; i++) {
    assertFalse(isOnSameRack(targets[0],targets[i]));
  }
  assertTrue(isOnSameRack(targets[1],targets[2]) || isOnSameRack(targets[2],targets[3]));
  assertFalse(isOnSameRack(targets[1],targets[3]));
  excludedNodes.clear();
  chosenNodes.clear();
  excludedNodes.add(dataNodes[1]);
  chosenNodes.add(storages[2]);
  targets=replicator.chooseTarget(filename,1,dataNodes[0],chosenNodes,true,excludedNodes,BLOCK_SIZE,StorageType.DEFAULT);
  System.out.println("targets=" + Arrays.asList(targets));
  assertEquals(2,targets.length);
  int i=0;
  for (; i < targets.length && !storages[2].equals(targets[i]); i++)   ;
  assertTrue(i < targets.length);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Test for the ChooseUnderReplicatedBlocks are processed based on priority
 */
@Test public void testChooseUnderReplicatedBlocks() throws Exception {
  UnderReplicatedBlocks underReplicatedBlocks=new UnderReplicatedBlocks();
  for (int i=0; i < 5; i++) {
    underReplicatedBlocks.add(new Block(random.nextLong()),1,0,3);
    underReplicatedBlocks.add(new Block(random.nextLong()),2,0,7);
    underReplicatedBlocks.add(new Block(random.nextLong()),6,0,6);
    underReplicatedBlocks.add(new Block(random.nextLong()),5,0,6);
    underReplicatedBlocks.add(new Block(random.nextLong()),0,0,3);
  }
  List<List<Block>> chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(6);
  assertTheChosenBlocks(chosenBlocks,5,1,0,0,0);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(10);
  assertTheChosenBlocks(chosenBlocks,0,4,5,1,0);
  underReplicatedBlocks.add(new Block(random.nextLong()),1,0,3);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(10);
  assertTheChosenBlocks(chosenBlocks,1,0,0,4,5);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(7);
  assertTheChosenBlocks(chosenBlocks,6,1,0,0,0);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=60000) public void testAddStoredBlockDoesNotCauseSkippedReplication() throws IOException {
  Namesystem mockNS=mock(Namesystem.class);
  when(mockNS.isPopulatingReplQueues()).thenReturn(true);
  when(mockNS.hasWriteLock()).thenReturn(true);
  FSClusterStats mockStats=mock(FSClusterStats.class);
  BlockManager bm=new BlockManager(mockNS,mockStats,new HdfsConfiguration());
  UnderReplicatedBlocks underReplicatedBlocks=bm.neededReplications;
  Block block1=new Block(random.nextLong());
  Block block2=new Block(random.nextLong());
  underReplicatedBlocks.add(block1,0,1,1);
  underReplicatedBlocks.add(block2,0,1,1);
  List<List<Block>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
  BlockInfoUnderConstruction info=new BlockInfoUnderConstruction(block1,1);
  BlockCollection bc=mock(BlockCollection.class);
  when(bc.getBlockReplication()).thenReturn((short)1);
  bm.addBlockCollection(info,bc);
  bm.addStoredBlockUnderConstruction(new StatefulBlockInfo(info,info,ReplicaState.FINALIZED),TestReplicationPolicy.storages[0]);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
}

</code></pre>

<pre class="type-9 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This testcase tests re-replication, 
 * when dataNodes[0] and dataNodes[2] are already chosen.
 * So the 1st replica should be placed on the rack that the writer resides. 
 * the rest replicas can be placed randomly,
 * @throws Exception
 */
@Test public void testRereplicate3() throws Exception {
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<DatanodeStorageInfo>();
  chosenNodes.add(storages[0]);
  chosenNodes.add(storages[2]);
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0,chosenNodes);
  assertEquals(targets.length,0);
  targets=chooseTarget(1,chosenNodes);
  assertEquals(targets.length,1);
  assertTrue(isOnSameRack(targets[0],dataNodes[0]));
  assertFalse(isOnSameRack(targets[0],dataNodes[2]));
  targets=chooseTarget(1,dataNodes[2],chosenNodes);
  assertEquals(targets.length,1);
  assertTrue(isOnSameRack(targets[0],dataNodes[2]));
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  targets=chooseTarget(2,chosenNodes);
  assertEquals(targets.length,2);
  assertTrue(isOnSameRack(targets[0],dataNodes[0]));
  targets=chooseTarget(2,dataNodes[2],chosenNodes);
  assertEquals(targets.length,2);
  assertTrue(isOnSameRack(targets[0],dataNodes[2]));
}

</code></pre>

<pre class="type-9 type-7 type-10 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this testcase, it tries to choose more targets than available nodes and
 * check the result. 
 * @throws Exception
 */
@Test public void testChooseTargetWithMoreThanAvailableNodes() throws Exception {
  for (int i=0; i < 2; i++) {
    updateHeartbeatWithUsage(dataNodes[i],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,(HdfsConstants.MIN_BLOCKS_FOR_WRITE - 1) * BLOCK_SIZE,0L,0L,0L,0,0);
  }
  final LogVerificationAppender appender=new LogVerificationAppender();
  final Logger logger=Logger.getRootLogger();
  logger.addAppender(appender);
  DatanodeStorageInfo[] targets=chooseTarget(NUM_OF_DATANODES);
  assertEquals(targets.length,NUM_OF_DATANODES - 2);
  final List<LoggingEvent> log=appender.getLog();
  assertNotNull(log);
  assertFalse(log.size() == 0);
  final LoggingEvent lastLogEntry=log.get(log.size() - 1);
  assertTrue(Level.WARN.isGreaterOrEqual(lastLogEntry.getLevel()));
  assertTrue(((String)lastLogEntry.getMessage()).contains("in need of 2"));
  for (int i=0; i < 2; i++) {
    updateHeartbeatWithUsage(dataNodes[i],2 * HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,HdfsConstants.MIN_BLOCKS_FOR_WRITE * BLOCK_SIZE,0L,0L,0L,0,0);
  }
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This testcase tests whether the default value returned by
 * DFSUtil.getInvalidateWorkPctPerIteration() is positive, 
 * and whether an IllegalArgumentException will be thrown 
 * when 0.0f is retrieved
 */
@Test public void testGetInvalidateWorkPctPerIteration(){
  Configuration conf=new Configuration();
  float blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
  assertTrue(blocksInvalidateWorkPct > 0);
  conf.set(DFSConfigKeys.DFS_NAMENODE_INVALIDATE_WORK_PCT_PER_ITERATION,"0.5f");
  blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
  assertEquals(blocksInvalidateWorkPct,0.5f,blocksInvalidateWorkPct * 1e-7);
  conf.set(DFSConfigKeys.DFS_NAMENODE_INVALIDATE_WORK_PCT_PER_ITERATION,"1.0f");
  blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
  assertEquals(blocksInvalidateWorkPct,1.0f,blocksInvalidateWorkPct * 1e-7);
  conf.set(DFSConfigKeys.DFS_NAMENODE_INVALIDATE_WORK_PCT_PER_ITERATION,"0.0f");
  exception.expect(IllegalArgumentException.class);
  blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=60000) public void testupdateNeededReplicationsDoesNotCauseSkippedReplication() throws IOException {
  Namesystem mockNS=mock(Namesystem.class);
  when(mockNS.isPopulatingReplQueues()).thenReturn(true);
  FSClusterStats mockStats=mock(FSClusterStats.class);
  BlockManager bm=new BlockManager(mockNS,mockStats,new HdfsConfiguration());
  UnderReplicatedBlocks underReplicatedBlocks=bm.neededReplications;
  Block block1=new Block(random.nextLong());
  Block block2=new Block(random.nextLong());
  underReplicatedBlocks.add(block1,0,1,1);
  underReplicatedBlocks.add(block2,0,1,1);
  List<List<Block>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
  bm.setReplication((short)0,(short)1,"",block1);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,1,0,0,0,0);
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=60000) public void testUpdateDoesNotCauseSkippedReplication(){
  UnderReplicatedBlocks underReplicatedBlocks=new UnderReplicatedBlocks();
  Block block1=new Block(random.nextLong());
  Block block2=new Block(random.nextLong());
  Block block3=new Block(random.nextLong());
  final int block1CurReplicas=2;
  final int block1ExpectedReplicas=7;
  underReplicatedBlocks.add(block1,block1CurReplicas,0,block1ExpectedReplicas);
  underReplicatedBlocks.add(block2,2,0,7);
  underReplicatedBlocks.add(block3,2,0,6);
  List<List<Block>> chosenBlocks;
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,0,1,0,0,0);
  underReplicatedBlocks.update(block1,block1CurReplicas + 1,0,block1ExpectedReplicas,1,0);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,0,1,0,0,0);
  chosenBlocks=underReplicatedBlocks.chooseUnderReplicatedBlocks(1);
  assertTheChosenBlocks(chosenBlocks,0,0,1,0,0);
}

</code></pre>

<pre class="type-9 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This testcase tests re-replication, 
 * when dataNodes[0] and dataNodes[1] are already chosen.
 * So the 1st replica should be placed on a different rack than rack 1. 
 * the rest replicas can be placed randomly,
 * @throws Exception
 */
@Test public void testRereplicate2() throws Exception {
  List<DatanodeStorageInfo> chosenNodes=new ArrayList<DatanodeStorageInfo>();
  chosenNodes.add(storages[0]);
  chosenNodes.add(storages[1]);
  DatanodeStorageInfo[] targets;
  targets=chooseTarget(0,chosenNodes);
  assertEquals(targets.length,0);
  targets=chooseTarget(1,chosenNodes);
  assertEquals(targets.length,1);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  targets=chooseTarget(2,chosenNodes);
  assertEquals(targets.length,2);
  assertFalse(isOnSameRack(targets[0],dataNodes[0]));
  assertFalse(isOnSameRack(targets[1],dataNodes[0]));
}

</code></pre>

<pre class="type-9 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
"></span><br>
/** 
 * This testcase tests whether an IllegalArgumentException 
 * will be thrown when a negative value is retrieved by 
 * DFSUtil#getInvalidateWorkPctPerIteration
 */
@Test public void testGetInvalidateWorkPctPerIteration_NegativeValue(){
  Configuration conf=new Configuration();
  float blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
  assertTrue(blocksInvalidateWorkPct > 0);
  conf.set(DFSConfigKeys.DFS_NAMENODE_INVALIDATE_WORK_PCT_PER_ITERATION,"-0.5f");
  exception.expect(IllegalArgumentException.class);
  blocksInvalidateWorkPct=DFSUtil.getInvalidateWorkPctPerIteration(conf);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
