<h3 style="margin:0px">Class: org.apache.hadoop.hdfs.TestLease (5 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("unchecked") @Test public void testFactory() throws Exception {
  final String[] groups=new String[]{"supergroup"};
  final UserGroupInformation[] ugi=new UserGroupInformation[3];
  for (int i=0; i < ugi.length; i++) {
    ugi[i]=UserGroupInformation.createUserForTesting("user" + i,groups);
  }
  Mockito.doReturn(new HdfsFileStatus(0,false,1,1024,0,0,new FsPermission((short)777),"owner","group",new byte[0],new byte[0],1010,0,null)).when(mcp).getFileInfo(anyString());
  Mockito.doReturn(new HdfsFileStatus(0,false,1,1024,0,0,new FsPermission((short)777),"owner","group",new byte[0],new byte[0],1010,0,null)).when(mcp).create(anyString(),(FsPermission)anyObject(),anyString(),(EnumSetWritable<CreateFlag>)anyObject(),anyBoolean(),anyShort(),anyLong(),(List<CipherSuite>)anyList());
  final Configuration conf=new Configuration();
  final DFSClient c1=createDFSClientAs(ugi[0],conf);
  FSDataOutputStream out1=createFsOut(c1,"/out1");
  final DFSClient c2=createDFSClientAs(ugi[0],conf);
  FSDataOutputStream out2=createFsOut(c2,"/out2");
  Assert.assertEquals(c1.getLeaseRenewer(),c2.getLeaseRenewer());
  final DFSClient c3=createDFSClientAs(ugi[1],conf);
  FSDataOutputStream out3=createFsOut(c3,"/out3");
  Assert.assertTrue(c1.getLeaseRenewer() != c3.getLeaseRenewer());
  final DFSClient c4=createDFSClientAs(ugi[1],conf);
  FSDataOutputStream out4=createFsOut(c4,"/out4");
  Assert.assertEquals(c3.getLeaseRenewer(),c4.getLeaseRenewer());
  final DFSClient c5=createDFSClientAs(ugi[2],conf);
  FSDataOutputStream out5=createFsOut(c5,"/out5");
  Assert.assertTrue(c1.getLeaseRenewer() != c5.getLeaseRenewer());
  Assert.assertTrue(c3.getLeaseRenewer() != c5.getLeaseRenewer());
}

</code></pre>

<pre class="type-9 type-11 type-2 type-7 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLeaseAbort() throws Exception {
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  try {
    cluster.waitActive();
    NamenodeProtocols preSpyNN=cluster.getNameNodeRpc();
    NamenodeProtocols spyNN=spy(preSpyNN);
    DFSClient dfs=new DFSClient(null,spyNN,conf,null);
    byte[] buf=new byte[1024];
    FSDataOutputStream c_out=createFsOut(dfs,dirString + "c");
    c_out.write(buf,0,1024);
    c_out.close();
    DFSInputStream c_in=dfs.open(dirString + "c");
    FSDataOutputStream d_out=createFsOut(dfs,dirString + "d");
    doThrow(new RemoteException(InvalidToken.class.getName(),"Your token is worthless")).when(spyNN).renewLease(anyString());
    LeaseRenewer originalRenewer=dfs.getLeaseRenewer();
    dfs.lastLeaseRenewal=Time.now() - HdfsConstants.LEASE_SOFTLIMIT_PERIOD - 1000;
    try {
      dfs.renewLease();
    }
 catch (    IOException e) {
    }
    try {
      d_out.write(buf,0,1024);
      LOG.info("Write worked beyond the soft limit as expected.");
    }
 catch (    IOException e) {
      Assert.fail("Write failed.");
    }
    dfs.lastLeaseRenewal=Time.now() - HdfsConstants.LEASE_HARDLIMIT_PERIOD - 1000;
    dfs.renewLease();
    try {
      d_out.write(buf,0,1024);
      d_out.close();
      Assert.fail("Write did not fail even after the fatal lease renewal failure");
    }
 catch (    IOException e) {
      LOG.info("Write failed as expected. ",e);
    }
    Thread.sleep(1000);
    Assert.assertTrue(originalRenewer.isEmpty());
    doNothing().when(spyNN).renewLease(anyString());
    try {
      int num=c_in.read(buf,0,1);
      if (num != 1) {
        Assert.fail("Failed to read 1 byte");
      }
      c_in.close();
    }
 catch (    IOException e) {
      LOG.error("Read failed with ",e);
      Assert.fail("Read after lease renewal failure failed");
    }
    try {
      c_out=createFsOut(dfs,dirString + "c");
      c_out.write(buf,0,1024);
      c_out.close();
    }
 catch (    IOException e) {
      LOG.error("Write failed with ",e);
      Assert.fail("Write failed");
    }
  }
  finally {
    cluster.shutdown();
  }
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test that we can open up a file for write, move it to another location,
 * and then create a new file in the previous location, without causing any
 * lease conflicts.  This is possible because we now use unique inode IDs
 * to identify files to the NameNode.
 */
@Test public void testLeaseAfterRenameAndRecreate() throws Exception {
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  try {
    final Path path1=new Path("/test-file");
    final String contents1="contents1";
    final Path path2=new Path("/test-file-new-location");
    final String contents2="contents2";
    FileSystem fs=cluster.getFileSystem();
    FSDataOutputStream out1=fs.create(path1);
    out1.writeBytes(contents1);
    Assert.assertTrue(hasLease(cluster,path1));
    Assert.assertEquals(1,leaseCount(cluster));
    DistributedFileSystem fs2=(DistributedFileSystem)FileSystem.newInstance(fs.getUri(),fs.getConf());
    fs2.rename(path1,path2);
    FSDataOutputStream out2=fs2.create(path1);
    out2.writeBytes(contents2);
    out2.close();
    Assert.assertTrue(hasLease(cluster,path2));
    out1.close();
    DistributedFileSystem fs3=(DistributedFileSystem)FileSystem.newInstance(fs.getUri(),fs.getConf());
    Assert.assertEquals(contents1,DFSTestUtil.readFile(fs3,path2));
    Assert.assertEquals(contents2,DFSTestUtil.readFile(fs3,path1));
  }
  finally {
    cluster.shutdown();
  }
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLeaseAfterRename() throws Exception {
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  try {
    Path p=new Path("/test-file");
    Path d=new Path("/test-d");
    Path d2=new Path("/test-d-other");
    FileSystem fs=cluster.getFileSystem();
    FSDataOutputStream out=fs.create(p);
    out.writeBytes("something");
    Assert.assertTrue(hasLease(cluster,p));
    Assert.assertEquals(1,leaseCount(cluster));
    DistributedFileSystem fs2=(DistributedFileSystem)FileSystem.newInstance(fs.getUri(),fs.getConf());
    LOG.info("DMS: rename file into dir");
    Path pRenamed=new Path(d,p.getName());
    fs2.mkdirs(d);
    fs2.rename(p,pRenamed);
    Assert.assertFalse(p + " exists",fs2.exists(p));
    Assert.assertTrue(pRenamed + " not found",fs2.exists(pRenamed));
    Assert.assertFalse("has lease for " + p,hasLease(cluster,p));
    Assert.assertTrue("no lease for " + pRenamed,hasLease(cluster,pRenamed));
    Assert.assertEquals(1,leaseCount(cluster));
    LOG.info("DMS: rename parent dir");
    Path pRenamedAgain=new Path(d2,pRenamed.getName());
    fs2.rename(d,d2);
    Assert.assertFalse(d + " exists",fs2.exists(d));
    Assert.assertFalse("has lease for " + pRenamed,hasLease(cluster,pRenamed));
    Assert.assertTrue(d2 + " not found",fs2.exists(d2));
    Assert.assertTrue(pRenamedAgain + " not found",fs2.exists(pRenamedAgain));
    Assert.assertTrue("no lease for " + pRenamedAgain,hasLease(cluster,pRenamedAgain));
    Assert.assertEquals(1,leaseCount(cluster));
    LOG.info("DMS: rename parent again");
    pRenamed=pRenamedAgain;
    pRenamedAgain=new Path(new Path(d,d2.getName()),p.getName());
    fs2.mkdirs(d);
    fs2.rename(d2,d);
    Assert.assertFalse(d2 + " exists",fs2.exists(d2));
    Assert.assertFalse("no lease for " + pRenamed,hasLease(cluster,pRenamed));
    Assert.assertTrue(d + " not found",fs2.exists(d));
    Assert.assertTrue(pRenamedAgain + " not found",fs2.exists(pRenamedAgain));
    Assert.assertTrue("no lease for " + pRenamedAgain,hasLease(cluster,pRenamedAgain));
    Assert.assertEquals(1,leaseCount(cluster));
    pRenamed=pRenamedAgain;
    pRenamedAgain=new Path(d2,p.getName());
    fs2.rename(pRenamed.getParent(),d2,Options.Rename.OVERWRITE);
    Assert.assertFalse(pRenamed.getParent() + " not found",fs2.exists(pRenamed.getParent()));
    Assert.assertFalse("has lease for " + pRenamed,hasLease(cluster,pRenamed));
    Assert.assertTrue(d2 + " not found",fs2.exists(d2));
    Assert.assertTrue(pRenamedAgain + " not found",fs2.exists(pRenamedAgain));
    Assert.assertTrue("no lease for " + pRenamedAgain,hasLease(cluster,pRenamedAgain));
    Assert.assertEquals(1,leaseCount(cluster));
    pRenamed=pRenamedAgain;
    pRenamedAgain=new Path(d,p.getName());
    fs2.rename(pRenamed.getParent(),d,Options.Rename.OVERWRITE);
    Assert.assertFalse(pRenamed.getParent() + " not found",fs2.exists(pRenamed.getParent()));
    Assert.assertFalse("has lease for " + pRenamed,hasLease(cluster,pRenamed));
    Assert.assertTrue(d + " not found",fs2.exists(d));
    Assert.assertTrue(pRenamedAgain + " not found",fs2.exists(pRenamedAgain));
    Assert.assertTrue("no lease for " + pRenamedAgain,hasLease(cluster,pRenamedAgain));
    Assert.assertEquals(1,leaseCount(cluster));
    out.close();
  }
  finally {
    cluster.shutdown();
  }
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test public void testLease() throws Exception {
  MiniDFSCluster cluster=new MiniDFSCluster.Builder(conf).numDataNodes(2).build();
  try {
    FileSystem fs=cluster.getFileSystem();
    Assert.assertTrue(fs.mkdirs(dir));
    Path a=new Path(dir,"a");
    Path b=new Path(dir,"b");
    DataOutputStream a_out=fs.create(a);
    a_out.writeBytes("something");
    Assert.assertTrue(hasLease(cluster,a));
    Assert.assertTrue(!hasLease(cluster,b));
    DataOutputStream b_out=fs.create(b);
    b_out.writeBytes("something");
    Assert.assertTrue(hasLease(cluster,a));
    Assert.assertTrue(hasLease(cluster,b));
    a_out.close();
    b_out.close();
    Assert.assertTrue(!hasLease(cluster,a));
    Assert.assertTrue(!hasLease(cluster,b));
    fs.delete(dir,true);
  }
  finally {
    if (cluster != null) {
      cluster.shutdown();
    }
  }
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
