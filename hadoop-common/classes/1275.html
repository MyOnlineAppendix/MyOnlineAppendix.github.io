<h3 style="margin:0px">Class: org.apache.hadoop.yarn.server.resourcemanager.TestRMRestart (23 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(17)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(16)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(14)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(12)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(3)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-9 type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMRestartAppRunningAMFailed() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  MockAM am0=launchAM(app0,rm1,nm1);
  nm1.nodeHeartbeat(am0.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am0.waitForState(RMAppAttemptState.FAILED);
  ApplicationState appState=rmAppState.get(app0.getApplicationId());
  Assert.assertEquals(RMAppAttemptState.FAILED,appState.getAttempt(am0.getApplicationAttemptId()).getState());
  Assert.assertNull(rmAppState.get(app0.getApplicationId()).getState());
  rm1.waitForState(app0.getApplicationId(),RMAppState.ACCEPTED);
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  rm2.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.FAILED);
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test(timeout=60000) public void testRMRestartKilledAppWithNoAttempts() throws Exception {
  MemoryRMStateStore memStore=new MemoryRMStateStore(){
    @Override public synchronized void storeApplicationAttemptStateInternal(    ApplicationAttemptId attemptId,    ApplicationAttemptStateData attemptStateData) throws Exception {
    }
    @Override public synchronized void updateApplicationAttemptStateInternal(    ApplicationAttemptId attemptId,    ApplicationAttemptStateData attemptStateData) throws Exception {
    }
  }
;
  memStore.init(conf);
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  RMApp app0=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",-1,null,"MAPREDUCE",false);
  rm1.killApp(app0.getApplicationId());
  rm1.waitForState(app0.getApplicationId(),RMAppState.KILLED);
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  RMApp loadedApp0=rm2.getRMContext().getRMApps().get(app0.getApplicationId());
  rm2.waitForState(loadedApp0.getApplicationId(),RMAppState.KILLED);
  Assert.assertTrue(loadedApp0.getAppAttempts().size() == 0);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("rawtypes") @Test(timeout=180000) public void testRMRestart() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  MockNM nm2=new MockNM("127.0.0.2:5678",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  nm2.registerNode();
  RMApp app0=rm1.submitApp(200);
  RMAppAttempt attempt0=app0.getCurrentAppAttempt();
  Assert.assertEquals(1,rmAppState.size());
  nm1.nodeHeartbeat(true);
  MockAM am0=rm1.sendAMLaunched(attempt0.getAppAttemptId());
  am0.registerAppAttempt();
  finishApplicationMaster(app0,rm1,nm1,am0);
  RMApp app1=rm1.submitApp(200);
  ApplicationState appState=rmAppState.get(app1.getApplicationId());
  Assert.assertNotNull(appState);
  Assert.assertEquals(0,appState.getAttemptCount());
  Assert.assertEquals(appState.getApplicationSubmissionContext().getApplicationId(),app1.getApplicationSubmissionContext().getApplicationId());
  nm1.nodeHeartbeat(true);
  RMAppAttempt attempt1=app1.getCurrentAppAttempt();
  ApplicationAttemptId attemptId1=attempt1.getAppAttemptId();
  rm1.waitForState(attemptId1,RMAppAttemptState.ALLOCATED);
  Assert.assertEquals(1,appState.getAttemptCount());
  ApplicationAttemptState attemptState=appState.getAttempt(attemptId1);
  Assert.assertNotNull(attemptState);
  Assert.assertEquals(BuilderUtils.newContainerId(attemptId1,1),attemptState.getMasterContainer().getId());
  MockAM am1=rm1.sendAMLaunched(attempt1.getAppAttemptId());
  am1.registerAppAttempt();
  am1.allocate("127.0.0.1",1000,1,new ArrayList<ContainerId>());
  nm1.nodeHeartbeat(true);
  List<Container> conts=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
  while (conts.size() == 0) {
    nm1.nodeHeartbeat(true);
    conts.addAll(am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers());
    Thread.sleep(500);
  }
  RMApp app2=rm1.submitApp(200);
  appState=rmAppState.get(app2.getApplicationId());
  Assert.assertNotNull(appState);
  Assert.assertEquals(0,appState.getAttemptCount());
  Assert.assertEquals(appState.getApplicationSubmissionContext().getApplicationId(),app2.getApplicationSubmissionContext().getApplicationId());
  RMApp appUnmanaged=rm1.submitApp(200,"someApp","someUser",null,true,null,conf.getInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS),null);
  ApplicationAttemptId unmanagedAttemptId=appUnmanaged.getCurrentAppAttempt().getAppAttemptId();
  ApplicationId unmanagedAppId=appUnmanaged.getApplicationId();
  appState=rmAppState.get(unmanagedAppId);
  Assert.assertNotNull(appState);
  rm1.waitForState(unmanagedAttemptId,RMAppAttemptState.LAUNCHED);
  rm1.waitForState(unmanagedAppId,RMAppState.ACCEPTED);
  Assert.assertEquals(1,appState.getAttemptCount());
  Assert.assertEquals(appState.getApplicationSubmissionContext().getApplicationId(),appUnmanaged.getApplicationSubmissionContext().getApplicationId());
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  nm2.setResourceTrackerService(rm2.getResourceTrackerService());
  Assert.assertEquals(4,rm2.getRMContext().getRMApps().size());
  rm2.waitForState(app0.getApplicationId(),RMAppState.FINISHED);
  rm2.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.FINISHED);
  RMApp loadedApp1=rm2.getRMContext().getRMApps().get(app1.getApplicationId());
  Assert.assertNotNull(loadedApp1);
  Assert.assertEquals(1,loadedApp1.getAppAttempts().size());
  Assert.assertEquals(app1.getApplicationSubmissionContext().getApplicationId(),loadedApp1.getApplicationSubmissionContext().getApplicationId());
  RMApp loadedApp2=rm2.getRMContext().getRMApps().get(app2.getApplicationId());
  Assert.assertNotNull(loadedApp2);
  Assert.assertEquals(app2.getApplicationSubmissionContext().getApplicationId(),loadedApp2.getApplicationSubmissionContext().getApplicationId());
  rm2.waitForState(loadedApp1.getApplicationId(),RMAppState.ACCEPTED);
  rm2.waitForState(loadedApp2.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(1,loadedApp1.getAppAttempts().size());
  Assert.assertEquals(1,loadedApp2.getAppAttempts().size());
  am1.setAMRMProtocol(rm2.getApplicationMasterService(),rm2.getRMContext());
  AllocateResponse allocResponse=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>());
  Assert.assertEquals(AMCommand.AM_SHUTDOWN,allocResponse.getAMCommand());
  NodeHeartbeatResponse hbResponse=nm1.nodeHeartbeat(true);
  Assert.assertEquals(NodeAction.RESYNC,hbResponse.getNodeAction());
  hbResponse=nm2.nodeHeartbeat(true);
  Assert.assertEquals(NodeAction.RESYNC,hbResponse.getNodeAction());
  nm1=new MockNM("127.0.0.1:1234",15120,rm2.getResourceTrackerService());
  nm2=new MockNM("127.0.0.2:5678",15120,rm2.getResourceTrackerService());
  NMContainerStatus status=TestRMRestart.createNMContainerStatus(loadedApp1.getCurrentAppAttempt().getAppAttemptId(),1,ContainerState.COMPLETE);
  nm1.registerNode(Arrays.asList(status),null);
  nm2.registerNode();
  rm2.waitForState(loadedApp1.getApplicationId(),RMAppState.ACCEPTED);
  int timeoutSecs=0;
  while (loadedApp1.getAppAttempts().size() != 2 && timeoutSecs++ < 40) {
    ;
    Thread.sleep(200);
  }
  hbResponse=nm1.nodeHeartbeat(true);
  Assert.assertTrue(NodeAction.RESYNC != hbResponse.getNodeAction());
  hbResponse=nm2.nodeHeartbeat(true);
  Assert.assertTrue(NodeAction.RESYNC != hbResponse.getNodeAction());
  attempt1=loadedApp1.getCurrentAppAttempt();
  attemptId1=attempt1.getAppAttemptId();
  rm2.waitForState(attemptId1,RMAppAttemptState.ALLOCATED);
  appState=rmAppState.get(loadedApp1.getApplicationId());
  attemptState=appState.getAttempt(attemptId1);
  Assert.assertNotNull(attemptState);
  Assert.assertEquals(BuilderUtils.newContainerId(attemptId1,1),attemptState.getMasterContainer().getId());
  MockNM am1Node=nm1;
  if (attemptState.getMasterContainer().getNodeId().toString().contains("127.0.0.2")) {
    am1Node=nm2;
  }
  RMAppAttempt attempt2=loadedApp2.getCurrentAppAttempt();
  ApplicationAttemptId attemptId2=attempt2.getAppAttemptId();
  rm2.waitForState(attemptId2,RMAppAttemptState.ALLOCATED);
  appState=rmAppState.get(loadedApp2.getApplicationId());
  attemptState=appState.getAttempt(attemptId2);
  Assert.assertNotNull(attemptState);
  Assert.assertEquals(BuilderUtils.newContainerId(attemptId2,1),attemptState.getMasterContainer().getId());
  MockNM am2Node=nm1;
  if (attemptState.getMasterContainer().getNodeId().toString().contains("127.0.0.2")) {
    am2Node=nm2;
  }
  am1=rm2.sendAMLaunched(attempt1.getAppAttemptId());
  am1.registerAppAttempt();
  MockAM am2=rm2.sendAMLaunched(attempt2.getAppAttemptId());
  am2.registerAppAttempt();
  am1.allocate("127.0.0.1",1000,3,new ArrayList<ContainerId>());
  am2.allocate("127.0.0.2",1000,1,new ArrayList<ContainerId>());
  nm1.nodeHeartbeat(true);
  nm2.nodeHeartbeat(true);
  conts=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
  while (conts.size() == 0) {
    nm1.nodeHeartbeat(true);
    nm2.nodeHeartbeat(true);
    conts.addAll(am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers());
    Thread.sleep(500);
  }
  finishApplicationMaster(loadedApp1,rm2,am1Node,am1);
  finishApplicationMaster(loadedApp2,rm2,am2Node,am2);
  rm2.stop();
  rm1.stop();
  Assert.assertEquals(4,rmAppState.size());
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=20000) public void testSynchronouslyRenewDTOnRecovery() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,"kerberos");
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  final MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  final MockAM am0=MockRM.launchAndRegisterAM(app0,rm1,nm1);
  MockRM rm2=new MockRM(conf,memStore){
    @Override protected ResourceTrackerService createResourceTrackerService(){
      return new ResourceTrackerService(this.rmContext,this.nodesListManager,this.nmLivelinessMonitor,this.rmContext.getContainerTokenSecretManager(),this.rmContext.getNMTokenSecretManager()){
        @Override protected void serviceStart() throws Exception {
          super.serviceStart();
          nm1.setResourceTrackerService(getResourceTrackerService());
          NMContainerStatus status=TestRMRestart.createNMContainerStatus(am0.getApplicationAttemptId(),1,ContainerState.COMPLETE);
          nm1.registerNode(Arrays.asList(status),null);
        }
      }
;
    }
  }
;
  rm2.start();
  RMApp loadedApp0=rm2.getRMContext().getRMApps().get(app0.getApplicationId());
  int timeoutSecs=0;
  while (loadedApp0.getAppAttempts().size() != 2 && timeoutSecs++ < 40) {
    Thread.sleep(200);
  }
  MockAM am1=MockRM.launchAndRegisterAM(loadedApp0,rm2,nm1);
  MockRM.finishAMAndVerifyAppState(loadedApp0,rm2,nm1,am1);
}

</code></pre>

<pre class="type-9 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMRestartFailedApp() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,1);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  MockAM am0=launchAM(app0,rm1,nm1);
  nm1.nodeHeartbeat(am0.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am0.waitForState(RMAppAttemptState.FAILED);
  rm1.waitForState(app0.getApplicationId(),RMAppState.FAILED);
  ApplicationState appState=rmAppState.get(app0.getApplicationId());
  Assert.assertEquals(RMAppState.FAILED,appState.getState());
  Assert.assertEquals(RMAppAttemptState.FAILED,appState.getAttempt(am0.getApplicationAttemptId()).getState());
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  RMApp loadedApp0=rm2.getRMContext().getRMApps().get(app0.getApplicationId());
  rm2.waitForState(app0.getApplicationId(),RMAppState.FAILED);
  rm2.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.FAILED);
  Assert.assertEquals(1,loadedApp0.getAppAttempts().size());
  verifyAppReportAfterRMRestart(app0,rm2);
  Assert.assertTrue(app0.getDiagnostics().toString().contains("Failing the application."));
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-9 type-7 type-10 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMStateStoreDispatcherDrainedOnRMStop() throws Exception {
  MemoryRMStateStore memStore=new MemoryRMStateStore(){
    volatile boolean wait=true;
    @Override public void serviceStop() throws Exception {
      wait=false;
      super.serviceStop();
    }
    @Override protected void handleStoreEvent(    RMStateStoreEvent event){
      while (wait)       ;
      super.handleStoreEvent(event);
    }
  }
;
  memStore.init(conf);
  final MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  final ArrayList<RMApp> appList=new ArrayList<RMApp>();
  final int NUM_APPS=5;
  for (int i=0; i < NUM_APPS; i++) {
    RMApp app=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",-1,null,"MAPREDUCE",false);
    appList.add(app);
    rm1.waitForState(app.getApplicationId(),RMAppState.NEW_SAVING);
  }
  Map<ApplicationId,ApplicationState> rmAppState=memStore.getState().getApplicationState();
  Assert.assertTrue(rmAppState.size() == 0);
  rm1.stop();
  for (  RMApp app : appList) {
    ApplicationState appState=rmAppState.get(app.getApplicationId());
    Assert.assertNotNull(appState);
    Assert.assertEquals(0,appState.getAttemptCount());
    Assert.assertEquals(appState.getApplicationSubmissionContext().getApplicationId(),app.getApplicationSubmissionContext().getApplicationId());
  }
  Assert.assertTrue(rmAppState.size() == NUM_APPS);
}

</code></pre>

<pre class="type-8 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Before public void setup() throws UnknownHostException {
  Logger rootLogger=LogManager.getRootLogger();
  rootLogger.setLevel(Level.DEBUG);
  conf=new YarnConfiguration();
  UserGroupInformation.setConfiguration(conf);
  conf.set(YarnConfiguration.RECOVERY_ENABLED,"true");
  conf.set(YarnConfiguration.RM_STORE,MemoryRMStateStore.class.getName());
  rmAddr=new InetSocketAddress("localhost",8032);
  Assert.assertTrue(YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS > 1);
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test(timeout=60000) public void testRMRestartSucceededApp() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  MockAM am0=launchAM(app0,rm1,nm1);
  FinishApplicationMasterRequest req=FinishApplicationMasterRequest.newInstance(FinalApplicationStatus.SUCCEEDED,"diagnostics","trackingUrl");
  finishApplicationMaster(app0,rm1,nm1,am0,req);
  ApplicationState appState=rmAppState.get(app0.getApplicationId());
  ApplicationAttemptState attemptState0=appState.getAttempt(am0.getApplicationAttemptId());
  Assert.assertEquals("diagnostics",attemptState0.getDiagnostics());
  Assert.assertEquals(FinalApplicationStatus.SUCCEEDED,attemptState0.getFinalApplicationStatus());
  Assert.assertEquals("trackingUrl",attemptState0.getFinalTrackingUrl());
  Assert.assertEquals(app0.getFinishTime(),appState.getFinishTime());
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  ApplicationReport appReport=verifyAppReportAfterRMRestart(app0,rm2);
  Assert.assertEquals(FinalApplicationStatus.SUCCEEDED,appReport.getFinalApplicationStatus());
  Assert.assertEquals("trackingUrl",appReport.getOriginalTrackingUrl());
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@SuppressWarnings("resource") @Test(timeout=60000) public void testQueueMetricsOnRMRestart() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  QueueMetrics qm1=rm1.getResourceScheduler().getRootQueueMetrics();
  resetQueueMetrics(qm1);
  assertQueueMetrics(qm1,0,0,0,0);
  RMApp app1=rm1.submitApp(200);
  rm1.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  RMAppAttempt attempt1=app1.getCurrentAppAttempt();
  ApplicationAttemptId attemptId1=attempt1.getAppAttemptId();
  rm1.waitForState(attemptId1,RMAppAttemptState.SCHEDULED);
  assertQueueMetrics(qm1,1,1,0,0);
  nm1.nodeHeartbeat(true);
  rm1.waitForState(attemptId1,RMAppAttemptState.ALLOCATED);
  MockAM am1=rm1.sendAMLaunched(attempt1.getAppAttemptId());
  am1.registerAppAttempt();
  am1.allocate("127.0.0.1",1000,1,new ArrayList<ContainerId>());
  nm1.nodeHeartbeat(true);
  List<Container> conts=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
  while (conts.size() == 0) {
    nm1.nodeHeartbeat(true);
    conts.addAll(am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers());
    Thread.sleep(500);
  }
  assertQueueMetrics(qm1,1,0,1,0);
  MockRM rm2=new MockRM(conf,memStore);
  QueueMetrics qm2=rm2.getResourceScheduler().getRootQueueMetrics();
  resetQueueMetrics(qm2);
  assertQueueMetrics(qm2,0,0,0,0);
  rm2.start();
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  RMApp loadedApp1=rm2.getRMContext().getRMApps().get(app1.getApplicationId());
  am1.setAMRMProtocol(rm2.getApplicationMasterService(),rm2.getRMContext());
  am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>());
  nm1.nodeHeartbeat(true);
  nm1=new MockNM("127.0.0.1:1234",15120,rm2.getResourceTrackerService());
  NMContainerStatus status=TestRMRestart.createNMContainerStatus(loadedApp1.getCurrentAppAttempt().getAppAttemptId(),1,ContainerState.COMPLETE);
  nm1.registerNode(Arrays.asList(status),null);
  while (loadedApp1.getAppAttempts().size() != 2) {
    Thread.sleep(200);
  }
  attempt1=loadedApp1.getCurrentAppAttempt();
  attemptId1=attempt1.getAppAttemptId();
  rm2.waitForState(attemptId1,RMAppAttemptState.SCHEDULED);
  assertQueueMetrics(qm2,1,1,0,0);
  nm1.nodeHeartbeat(true);
  rm2.waitForState(attemptId1,RMAppAttemptState.ALLOCATED);
  assertQueueMetrics(qm2,1,0,1,0);
  am1=rm2.sendAMLaunched(attempt1.getAppAttemptId());
  am1.registerAppAttempt();
  am1.allocate("127.0.0.1",1000,3,new ArrayList<ContainerId>());
  nm1.nodeHeartbeat(true);
  conts=am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers();
  while (conts.size() == 0) {
    nm1.nodeHeartbeat(true);
    conts.addAll(am1.allocate(new ArrayList<ResourceRequest>(),new ArrayList<ContainerId>()).getAllocatedContainers());
    Thread.sleep(500);
  }
  finishApplicationMaster(loadedApp1,rm2,nm1,am1);
  assertQueueMetrics(qm2,1,0,0,1);
  rm2.stop();
  rm1.stop();
}

</code></pre>

<pre class="type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test(timeout=60000) public void testDecomissionedNMsMetricsOnRMRestart() throws Exception {
  YarnConfiguration conf=new YarnConfiguration();
  conf.set(YarnConfiguration.RM_NODES_EXCLUDE_FILE_PATH,hostFile.getAbsolutePath());
  writeToHostsFile("");
  MockRM rm1=new MockRM(conf);
  rm1.start();
  rm1.registerNode("localhost:1234",8000);
  rm1.registerNode("host2:1234",8000);
  Assert.assertEquals(0,ClusterMetrics.getMetrics().getNumDecommisionedNMs());
  String ip=NetUtils.normalizeHostName("localhost");
  writeToHostsFile("host2",ip);
  rm1.getNodesListManager().refreshNodes(conf);
  Assert.assertEquals(2,ClusterMetrics.getMetrics().getNumDecommisionedNMs());
  MockRM rm2=new MockRM(conf);
  rm2.start();
  Assert.assertEquals(2,ClusterMetrics.getMetrics().getNumDecommisionedNMs());
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-9 type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testDelegationTokenRestoredInDelegationTokenRenewer() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,"kerberos");
  UserGroupInformation.setConfiguration(conf);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new TestSecurityMockRM(conf,memStore);
  rm1.start();
  HashSet<Token<RMDelegationTokenIdentifier>> tokenSet=new HashSet<Token<RMDelegationTokenIdentifier>>();
  Credentials ts=new Credentials();
  Text userText1=new Text("user1");
  RMDelegationTokenIdentifier dtId1=new RMDelegationTokenIdentifier(userText1,new Text("renewer1"),userText1);
  Token<RMDelegationTokenIdentifier> token1=new Token<RMDelegationTokenIdentifier>(dtId1,rm1.getRMContext().getRMDelegationTokenSecretManager());
  SecurityUtil.setTokenService(token1,rmAddr);
  ts.addToken(userText1,token1);
  tokenSet.add(token1);
  Text userText2=new Text("user2");
  RMDelegationTokenIdentifier dtId2=new RMDelegationTokenIdentifier(userText2,new Text("renewer2"),userText2);
  Token<RMDelegationTokenIdentifier> token2=new Token<RMDelegationTokenIdentifier>(dtId2,rm1.getRMContext().getRMDelegationTokenSecretManager());
  SecurityUtil.setTokenService(token2,rmAddr);
  ts.addToken(userText2,token2);
  tokenSet.add(token2);
  RMApp app=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",1,ts);
  ApplicationState appState=rmAppState.get(app.getApplicationId());
  Assert.assertNotNull(appState);
  Assert.assertEquals(tokenSet,rm1.getRMContext().getDelegationTokenRenewer().getDelegationTokens());
  DataOutputBuffer dob=new DataOutputBuffer();
  ts.writeTokenStorageToStream(dob);
  ByteBuffer securityTokens=ByteBuffer.wrap(dob.getData(),0,dob.getLength());
  securityTokens.rewind();
  Assert.assertEquals(securityTokens,appState.getApplicationSubmissionContext().getAMContainerSpec().getTokens());
  MockRM rm2=new TestSecurityMockRM(conf,memStore);
  rm2.start();
  waitForTokensToBeRenewed(rm2);
  Assert.assertEquals(tokenSet,rm2.getRMContext().getDelegationTokenRenewer().getDelegationTokens());
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test(timeout=60000) public void testAppSubmissionWithOldDelegationTokenAfterRMRestart() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,"kerberos");
  conf.set(YarnConfiguration.RM_ADDRESS,"localhost:8032");
  UserGroupInformation.setConfiguration(conf);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  MockRM rm1=new TestSecurityMockRM(conf,memStore);
  rm1.start();
  GetDelegationTokenRequest request1=GetDelegationTokenRequest.newInstance("renewer1");
  UserGroupInformation.getCurrentUser().setAuthenticationMethod(AuthMethod.KERBEROS);
  GetDelegationTokenResponse response1=rm1.getClientRMService().getDelegationToken(request1);
  Token<RMDelegationTokenIdentifier> token1=ConverterUtils.convertFromYarn(response1.getRMDelegationToken(),rmAddr);
  MockRM rm2=new TestSecurityMockRM(conf,memStore);
  rm2.start();
  Credentials ts=new Credentials();
  ts.addToken(token1.getService(),token1);
  RMApp app=rm2.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",1,ts);
  rm2.waitForState(app.getApplicationId(),RMAppState.ACCEPTED);
}

</code></pre>

<pre class="type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testFinishedAppRemovalAfterRMRestart() throws Exception {
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  conf.setInt(YarnConfiguration.RM_MAX_COMPLETED_APPLICATIONS,1);
  memStore.init(conf);
  RMState rmState=memStore.getState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  MockAM am0=launchAM(app0,rm1,nm1);
  finishApplicationMaster(app0,rm1,nm1,am0);
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  nm1=rm2.registerNode("127.0.0.1:1234",15120);
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  Assert.assertEquals(RMAppState.FINISHED,rmAppState.get(app0.getApplicationId()).getState());
  rm2.waitForState(app0.getApplicationId(),RMAppState.FINISHED);
  RMApp app1=rm2.submitApp(200);
  MockAM am1=launchAM(app1,rm2,nm1);
  finishApplicationMaster(app1,rm2,nm1,am1);
  Assert.assertNull(rm2.getRMContext().getRMApps().get(app0.getApplicationId()));
  Assert.assertNull(rmAppState.get(app0.getApplicationId()));
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-9 type-11 type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMRestartGetApplicationList() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,1);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200,"name","user",null,false,"default",1,null,"myType");
  MockAM am0=launchAM(app0,rm1,nm1);
  finishApplicationMaster(app0,rm1,nm1,am0);
  RMApp app1=rm1.submitApp(200,"name","user",null,false,"default",1,null,"myType");
  MockAM am1=launchAM(app1,rm1,nm1);
  nm1.nodeHeartbeat(am1.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am1.waitForState(RMAppAttemptState.FAILED);
  rm1.waitForState(app1.getApplicationId(),RMAppState.FAILED);
  RMApp app2=rm1.submitApp(200,"name","user",null,false,"default",1,null,"myType");
  MockAM am2=launchAM(app2,rm1,nm1);
  rm1.killApp(app2.getApplicationId());
  rm1.waitForState(app2.getApplicationId(),RMAppState.KILLED);
  rm1.waitForState(am2.getApplicationAttemptId(),RMAppAttemptState.KILLED);
  MockRM rm2=new MockRM(conf,memStore){
    @Override protected RMAppManager createRMAppManager(){
      return spy(super.createRMAppManager());
    }
  }
;
  rm2.start();
  GetApplicationsRequest request1=GetApplicationsRequest.newInstance(EnumSet.of(YarnApplicationState.FINISHED,YarnApplicationState.KILLED,YarnApplicationState.FAILED));
  GetApplicationsResponse response1=rm2.getClientRMService().getApplications(request1);
  List<ApplicationReport> appList1=response1.getApplicationList();
  boolean forApp0=false, forApp1=false, forApp2=false;
  for (  ApplicationReport report : appList1) {
    if (report.getApplicationId().equals(app0.getApplicationId())) {
      Assert.assertEquals(YarnApplicationState.FINISHED,report.getYarnApplicationState());
      forApp0=true;
    }
    if (report.getApplicationId().equals(app1.getApplicationId())) {
      Assert.assertEquals(YarnApplicationState.FAILED,report.getYarnApplicationState());
      forApp1=true;
    }
    if (report.getApplicationId().equals(app2.getApplicationId())) {
      Assert.assertEquals(YarnApplicationState.KILLED,report.getYarnApplicationState());
      forApp2=true;
    }
  }
  Assert.assertTrue(forApp0 && forApp1 && forApp2);
  Set<String> appTypes=new HashSet<String>();
  appTypes.add("myType");
  GetApplicationsRequest request2=GetApplicationsRequest.newInstance(appTypes);
  GetApplicationsResponse response2=rm2.getClientRMService().getApplications(request2);
  List<ApplicationReport> appList2=response2.getApplicationList();
  Assert.assertTrue(3 == appList2.size());
  verify(rm2.getRMAppManager(),times(3)).logApplicationSummary(isA(ApplicationId.class));
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-9 type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMRestartOnMaxAppAttempts() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app1=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",1,null);
  RMApp app2=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",-1,null);
  ApplicationState appState=rmAppState.get(app1.getApplicationId());
  Assert.assertNotNull(appState);
  Assert.assertEquals(0,appState.getAttemptCount());
  Assert.assertEquals(appState.getApplicationSubmissionContext().getApplicationId(),app1.getApplicationSubmissionContext().getApplicationId());
  nm1.nodeHeartbeat(true);
  RMAppAttempt attempt=app1.getCurrentAppAttempt();
  ApplicationAttemptId attemptId1=attempt.getAppAttemptId();
  rm1.waitForState(attemptId1,RMAppAttemptState.ALLOCATED);
  Assert.assertEquals(1,appState.getAttemptCount());
  ApplicationAttemptState attemptState=appState.getAttempt(attemptId1);
  Assert.assertNotNull(attemptState);
  Assert.assertEquals(BuilderUtils.newContainerId(attemptId1,1),attemptState.getMasterContainer().getId());
  conf.setInt(YarnConfiguration.RM_AM_EXPIRY_INTERVAL_MS,3000);
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  Assert.assertEquals(2,rm2.getRMContext().getRMApps().get(app2.getApplicationId()).getMaxAppAttempts());
  Assert.assertEquals(2,rm2.getRMContext().getRMApps().size());
  rm2.waitForState(app1.getApplicationId(),RMAppState.FAILED);
  rm2.waitForState(app2.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(RMAppState.FAILED,rmAppState.get(app1.getApplicationId()).getState());
  Assert.assertNull(rmAppState.get(app2.getApplicationId()).getState());
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test(timeout=60000) public void testRMRestartWaitForPreviousAMToFinish() throws Exception {
  YarnConfiguration conf=new YarnConfiguration(this.conf);
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,40);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  final MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",16382,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app1=rm1.submitApp(200);
  rm1.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  MockAM am1=launchAM(app1,rm1,nm1);
  nm1.nodeHeartbeat(am1.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  am1.waitForState(RMAppAttemptState.FAILED);
  MockAM am2=launchAM(app1,rm1,nm1);
  Assert.assertEquals(1,rmAppState.size());
  Assert.assertEquals(app1.getState(),RMAppState.RUNNING);
  Assert.assertEquals(app1.getAppAttempts().get(app1.getCurrentAppAttempt().getAppAttemptId()).getAppAttemptState(),RMAppAttemptState.RUNNING);
  MockRM rm2=null;
  rm2=new MockRM(conf,memStore);
  rm2.start();
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  NodeHeartbeatResponse res=nm1.nodeHeartbeat(true);
  Assert.assertEquals(NodeAction.RESYNC,res.getNodeAction());
  RMApp rmApp=rm2.getRMContext().getRMApps().get(app1.getApplicationId());
  rm2.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(RMAppState.ACCEPTED,rmApp.getState());
  Assert.assertEquals(2,rmApp.getAppAttempts().size());
  rm2.waitForState(am1.getApplicationAttemptId(),RMAppAttemptState.FAILED);
  rm2.waitForState(am2.getApplicationAttemptId(),RMAppAttemptState.LAUNCHED);
  Assert.assertEquals(RMAppAttemptState.FAILED,rmApp.getAppAttempts().get(am1.getApplicationAttemptId()).getAppAttemptState());
  Assert.assertEquals(RMAppAttemptState.LAUNCHED,rmApp.getAppAttempts().get(am2.getApplicationAttemptId()).getAppAttemptState());
  NMContainerStatus status=TestRMRestart.createNMContainerStatus(am2.getApplicationAttemptId(),1,ContainerState.COMPLETE);
  nm1.registerNode(Arrays.asList(status),null);
  rm2.waitForState(am2.getApplicationAttemptId(),RMAppAttemptState.FAILED);
  launchAM(rmApp,rm2,nm1);
  Assert.assertEquals(3,rmApp.getAppAttempts().size());
  rm2.waitForState(rmApp.getCurrentAppAttempt().getAppAttemptId(),RMAppAttemptState.RUNNING);
  conf.setInt(YarnConfiguration.RM_AM_EXPIRY_INTERVAL_MS,10000);
  MockRM rm3=null;
  rm3=new MockRM(conf,memStore);
  rm3.start();
  nm1.setResourceTrackerService(rm3.getResourceTrackerService());
  rmApp=rm3.getRMContext().getRMApps().get(app1.getApplicationId());
  rm3.waitForState(app1.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(rmApp.getState(),RMAppState.ACCEPTED);
  Assert.assertEquals(3,rmApp.getAppAttempts().size());
  rm3.waitForState(am1.getApplicationAttemptId(),RMAppAttemptState.FAILED);
  rm3.waitForState(am2.getApplicationAttemptId(),RMAppAttemptState.FAILED);
  ApplicationAttemptId latestAppAttemptId=rmApp.getCurrentAppAttempt().getAppAttemptId();
  rm3.waitForState(latestAppAttemptId,RMAppAttemptState.LAUNCHED);
  Assert.assertEquals(RMAppAttemptState.FAILED,rmApp.getAppAttempts().get(am1.getApplicationAttemptId()).getAppAttemptState());
  Assert.assertEquals(RMAppAttemptState.FAILED,rmApp.getAppAttempts().get(am2.getApplicationAttemptId()).getAppAttemptState());
  Assert.assertEquals(RMAppAttemptState.LAUNCHED,rmApp.getAppAttempts().get(latestAppAttemptId).getAppAttemptState());
  rm3.waitForState(latestAppAttemptId,RMAppAttemptState.FAILED);
  rm3.waitForState(rmApp.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(4,rmApp.getAppAttempts().size());
  Assert.assertEquals(RMAppAttemptState.FAILED,rmApp.getAppAttempts().get(latestAppAttemptId).getAppAttemptState());
  latestAppAttemptId=rmApp.getCurrentAppAttempt().getAppAttemptId();
  RMApp app2=rm3.submitApp(200);
  rm3.waitForState(app2.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(1,app2.getAppAttempts().size());
  Assert.assertEquals(0,memStore.getState().getApplicationState().get(app2.getApplicationId()).getAttemptCount());
  MockRM rm4=null;
  rm4=new MockRM(conf,memStore);
  rm4.start();
  rmApp=rm4.getRMContext().getRMApps().get(app1.getApplicationId());
  rm4.waitForState(rmApp.getApplicationId(),RMAppState.ACCEPTED);
  int timeoutSecs=0;
  while (rmApp.getAppAttempts().size() != 2 && timeoutSecs++ < 40) {
    Thread.sleep(200);
  }
  Assert.assertEquals(4,rmApp.getAppAttempts().size());
  Assert.assertEquals(RMAppState.ACCEPTED,rmApp.getState());
  rm4.waitForState(latestAppAttemptId,RMAppAttemptState.SCHEDULED);
  Assert.assertEquals(RMAppAttemptState.SCHEDULED,rmApp.getAppAttempts().get(latestAppAttemptId).getAppAttemptState());
  app2=rm4.getRMContext().getRMApps().get(app2.getApplicationId());
  rm4.waitForState(app2.getApplicationId(),RMAppState.ACCEPTED);
  Assert.assertEquals(RMAppState.ACCEPTED,app2.getState());
  Assert.assertEquals(1,app2.getAppAttempts().size());
  rm4.waitForState(app2.getCurrentAppAttempt().getAppAttemptId(),RMAppAttemptState.SCHEDULED);
  Assert.assertEquals(RMAppAttemptState.SCHEDULED,app2.getCurrentAppAttempt().getAppAttemptState());
}

</code></pre>

<pre class="type-9 type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testAppAttemptTokensRestoredOnRMRestart() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,"kerberos");
  UserGroupInformation.setConfiguration(conf);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new TestSecurityMockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("0.0.0.0:4321",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app1=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),"default");
  ApplicationState appState=rmAppState.get(app1.getApplicationId());
  Assert.assertNotNull(appState);
  nm1.nodeHeartbeat(true);
  RMAppAttempt attempt1=app1.getCurrentAppAttempt();
  ApplicationAttemptId attemptId1=attempt1.getAppAttemptId();
  rm1.waitForState(attemptId1,RMAppAttemptState.ALLOCATED);
  ApplicationAttemptState attemptState=appState.getAttempt(attemptId1);
  Assert.assertNotNull(attemptState);
  Assert.assertEquals(BuilderUtils.newContainerId(attemptId1,1),attemptState.getMasterContainer().getId());
  byte[] clientTokenMasterKey=attempt1.getClientTokenMasterKey().getEncoded();
  Credentials savedCredentials=attemptState.getAppAttemptCredentials();
  Assert.assertArrayEquals("client token master key not saved",clientTokenMasterKey,savedCredentials.getSecretKey(RMStateStore.AM_CLIENT_TOKEN_MASTER_KEY_NAME));
  MockRM rm2=new TestSecurityMockRM(conf,memStore);
  rm2.start();
  RMApp loadedApp1=rm2.getRMContext().getRMApps().get(app1.getApplicationId());
  RMAppAttempt loadedAttempt1=loadedApp1.getRMAppAttempt(attemptId1);
  Assert.assertNotNull(loadedAttempt1);
  Assert.assertEquals("client token master key not restored",attempt1.getClientTokenMasterKey(),loadedAttempt1.getClientTokenMasterKey());
  Assert.assertArrayEquals(clientTokenMasterKey,rm2.getClientToAMTokenSecretManager().getMasterKey(attemptId1).getEncoded());
  Token<AMRMTokenIdentifier> amrmToken=loadedAttempt1.getAMRMToken();
  Assert.assertArrayEquals(amrmToken.getPassword(),rm2.getRMContext().getAMRMTokenSecretManager().retrievePassword(amrmToken.decodeIdentifier()));
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-2 type-7 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=10000) public void testRMShutdown() throws Exception {
  MemoryRMStateStore memStore=new MemoryRMStateStore(){
    @Override public synchronized void checkVersion() throws Exception {
      throw new Exception("Invalid version.");
    }
  }
;
  memStore.init(conf);
  MockRM rm1=null;
  try {
    rm1=new MockRM(conf,memStore);
    rm1.start();
    Assert.fail();
  }
 catch (  Exception e) {
    Assert.assertTrue(e.getMessage().contains("Invalid version."));
  }
  Assert.assertTrue(rm1.getServiceState() == STATE.STOPPED);
}

</code></pre>

<pre class="type-7 type-10 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testClientRetryOnKillingApplication() throws Exception {
  MemoryRMStateStore memStore=new TestMemoryRMStateStore();
  memStore.init(conf);
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app1=rm1.submitApp(200,"name","user",null,false,"default",1,null,"myType");
  MockAM am1=launchAM(app1,rm1,nm1);
  KillApplicationResponse response;
  int count=0;
  while (true) {
    response=rm1.killApp(app1.getApplicationId());
    if (response.getIsKillCompleted()) {
      break;
    }
    Thread.sleep(100);
    count++;
  }
  Assert.assertTrue(count >= 1);
  rm1.waitForState(am1.getApplicationAttemptId(),RMAppAttemptState.KILLED);
  rm1.waitForState(app1.getApplicationId(),RMAppState.KILLED);
  Assert.assertEquals(1,((TestMemoryRMStateStore)memStore).updateAttempt);
  Assert.assertEquals(2,((TestMemoryRMStateStore)memStore).updateApp);
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown(){
  TEMP_DIR.delete();
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test(timeout=60000) public void testRMRestartKilledApp() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,YarnConfiguration.DEFAULT_RM_AM_MAX_ATTEMPTS);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=new MockNM("127.0.0.1:1234",15120,rm1.getResourceTrackerService());
  nm1.registerNode();
  RMApp app0=rm1.submitApp(200);
  MockAM am0=launchAM(app0,rm1,nm1);
  rm1.killApp(app0.getApplicationId());
  rm1.waitForState(app0.getApplicationId(),RMAppState.KILLED);
  rm1.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.KILLED);
  ApplicationState appState=rmAppState.get(app0.getApplicationId());
  Assert.assertEquals(RMAppState.KILLED,appState.getState());
  Assert.assertEquals(RMAppAttemptState.KILLED,appState.getAttempt(am0.getApplicationAttemptId()).getState());
  MockRM rm2=new MockRM(conf,memStore);
  rm2.start();
  RMApp loadedApp0=rm2.getRMContext().getRMApps().get(app0.getApplicationId());
  rm2.waitForState(app0.getApplicationId(),RMAppState.KILLED);
  rm2.waitForState(am0.getApplicationAttemptId(),RMAppAttemptState.KILLED);
  Assert.assertEquals(1,loadedApp0.getAppAttempts().size());
  ApplicationReport appReport=verifyAppReportAfterRMRestart(app0,rm2);
  Assert.assertEquals(app0.getDiagnostics().toString(),appReport.getDiagnostics());
  rm1.stop();
  rm2.stop();
}

</code></pre>

<pre class="type-7 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMRestartWaitForPreviousSucceededAttempt() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  MemoryRMStateStore memStore=new MemoryRMStateStore(){
    int count=0;
    @Override public void updateApplicationStateInternal(    ApplicationId appId,    ApplicationStateData appStateData) throws Exception {
      if (count == 0) {
        LOG.info(appId + " final state is not saved.");
        count++;
      }
 else {
        super.updateApplicationStateInternal(appId,appStateData);
      }
    }
  }
;
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  MockRM rm1=new MockRM(conf,memStore);
  rm1.start();
  MockNM nm1=rm1.registerNode("127.0.0.1:1234",15120);
  RMApp app0=rm1.submitApp(200);
  MockAM am0=MockRM.launchAndRegisterAM(app0,rm1,nm1);
  FinishApplicationMasterRequest req=FinishApplicationMasterRequest.newInstance(FinalApplicationStatus.SUCCEEDED,"","");
  am0.unregisterAppAttempt(req,true);
  am0.waitForState(RMAppAttemptState.FINISHING);
  Assert.assertNull(rmAppState.get(app0.getApplicationId()).getState());
  MockRM rm2=new MockRM(conf,memStore);
  nm1.setResourceTrackerService(rm2.getResourceTrackerService());
  rm2.start();
  rm2.waitForState(app0.getCurrentAppAttempt().getAppAttemptId(),RMAppAttemptState.FINISHED);
  rm2.waitForState(app0.getApplicationId(),RMAppState.FINISHED);
  Assert.assertEquals(RMAppState.FINISHED,rmAppState.get(app0.getApplicationId()).getState());
}

</code></pre>

<pre class="type-9 type-2 type-7 type-10 type-1 type-6 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=60000) public void testRMDelegationTokenRestoredOnRMRestart() throws Exception {
  conf.setInt(YarnConfiguration.RM_AM_MAX_ATTEMPTS,2);
  conf.set(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHENTICATION,"kerberos");
  conf.set(YarnConfiguration.RM_ADDRESS,"localhost:8032");
  UserGroupInformation.setConfiguration(conf);
  MemoryRMStateStore memStore=new MemoryRMStateStore();
  memStore.init(conf);
  RMState rmState=memStore.getState();
  Map<ApplicationId,ApplicationState> rmAppState=rmState.getApplicationState();
  Map<RMDelegationTokenIdentifier,Long> rmDTState=rmState.getRMDTSecretManagerState().getTokenState();
  Set<DelegationKey> rmDTMasterKeyState=rmState.getRMDTSecretManagerState().getMasterKeyState();
  MockRM rm1=new TestSecurityMockRM(conf,memStore);
  rm1.start();
  Credentials ts=new Credentials();
  GetDelegationTokenRequest request1=GetDelegationTokenRequest.newInstance("renewer1");
  UserGroupInformation.getCurrentUser().setAuthenticationMethod(AuthMethod.KERBEROS);
  GetDelegationTokenResponse response1=rm1.getClientRMService().getDelegationToken(request1);
  org.apache.hadoop.yarn.api.records.Token delegationToken1=response1.getRMDelegationToken();
  Token<RMDelegationTokenIdentifier> token1=ConverterUtils.convertFromYarn(delegationToken1,rmAddr);
  RMDelegationTokenIdentifier dtId1=token1.decodeIdentifier();
  HashSet<RMDelegationTokenIdentifier> tokenIdentSet=new HashSet<RMDelegationTokenIdentifier>();
  ts.addToken(token1.getService(),token1);
  tokenIdentSet.add(dtId1);
  RMApp app=rm1.submitApp(200,"name","user",new HashMap<ApplicationAccessType,String>(),false,"default",1,ts);
  ApplicationState appState=rmAppState.get(app.getApplicationId());
  Assert.assertNotNull(appState);
  Set<DelegationKey> allKeysRM1=rm1.getRMContext().getRMDelegationTokenSecretManager().getAllMasterKeys();
  Assert.assertEquals(allKeysRM1,rmDTMasterKeyState);
  Map<RMDelegationTokenIdentifier,Long> allTokensRM1=rm1.getRMContext().getRMDelegationTokenSecretManager().getAllTokens();
  Assert.assertEquals(tokenIdentSet,allTokensRM1.keySet());
  Assert.assertEquals(allTokensRM1,rmDTState);
  Assert.assertEquals(rm1.getRMContext().getRMDelegationTokenSecretManager().getLatestDTSequenceNumber(),rmState.getRMDTSecretManagerState().getDTSequenceNumber());
  GetDelegationTokenRequest request2=GetDelegationTokenRequest.newInstance("renewer2");
  GetDelegationTokenResponse response2=rm1.getClientRMService().getDelegationToken(request2);
  org.apache.hadoop.yarn.api.records.Token delegationToken2=response2.getRMDelegationToken();
  Token<RMDelegationTokenIdentifier> token2=ConverterUtils.convertFromYarn(delegationToken2,rmAddr);
  RMDelegationTokenIdentifier dtId2=token2.decodeIdentifier();
  try {
    rm1.getRMContext().getRMDelegationTokenSecretManager().cancelToken(token2,UserGroupInformation.getCurrentUser().getUserName());
  }
 catch (  Exception e) {
    Assert.fail();
  }
  Assert.assertEquals(rm1.getRMContext().getRMDelegationTokenSecretManager().getLatestDTSequenceNumber(),dtId2.getSequenceNumber());
  Assert.assertFalse(rmDTState.containsKey(dtId2));
  MockRM rm2=new TestSecurityMockRM(conf,memStore);
  rm2.start();
  Map<RMDelegationTokenIdentifier,Long> allTokensRM2=rm2.getRMContext().getRMDelegationTokenSecretManager().getAllTokens();
  Assert.assertEquals(allTokensRM2.keySet(),allTokensRM1.keySet());
  Assert.assertTrue(rm2.getRMContext().getRMDelegationTokenSecretManager().getAllMasterKeys().containsAll(allKeysRM1));
  Assert.assertEquals(rm1.getRMContext().getRMDelegationTokenSecretManager().getLatestDTSequenceNumber(),rm2.getRMContext().getRMDelegationTokenSecretManager().getLatestDTSequenceNumber());
  Long renewDateBeforeRenew=allTokensRM2.get(dtId1);
  try {
    Thread.sleep(1);
    rm2.getRMContext().getRMDelegationTokenSecretManager().renewToken(token1,"renewer1");
  }
 catch (  Exception e) {
    Assert.fail();
  }
  allTokensRM2=rm2.getRMContext().getRMDelegationTokenSecretManager().getAllTokens();
  Long renewDateAfterRenew=allTokensRM2.get(dtId1);
  Assert.assertTrue(renewDateAfterRenew > renewDateBeforeRenew);
  Assert.assertTrue(rmDTState.containsValue(renewDateAfterRenew));
  Assert.assertFalse(rmDTState.containsValue(renewDateBeforeRenew));
  try {
    rm2.getRMContext().getRMDelegationTokenSecretManager().cancelToken(token1,UserGroupInformation.getCurrentUser().getUserName());
  }
 catch (  Exception e) {
    Assert.fail();
  }
  allTokensRM2=rm2.getRMContext().getRMDelegationTokenSecretManager().getAllTokens();
  Assert.assertFalse(allTokensRM2.containsKey(dtId1));
  Assert.assertFalse(rmDTState.containsKey(dtId1));
  rm1.stop();
  rm2.stop();
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
