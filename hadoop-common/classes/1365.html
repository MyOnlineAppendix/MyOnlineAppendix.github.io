<h3 style="margin:0px">Class: org.apache.hadoop.yarn.util.TestProcfsBasedProcessTree (6 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="15"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('15')" data-toggle="tooltip" title="Sets implicit assumptions "><kbd id="tag-15"class="label-info"style="display: inline-block;font-size:7pt" >AssumptionSetter&nbsp;(1)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(1)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Tests that cumulative memory is computed only for processes older than a
 * given age.
 * @throws IOExceptionif there was a problem setting up the fake procfs directories or
 * files.
 */
@Test(timeout=30000) public void testMemForOlderProcesses() throws IOException {
  testMemForOlderProcesses(false);
  testMemForOlderProcesses(true);
}

</code></pre>

<pre class="type-9 type-13 type-11 type-2 type-7 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=30000) public void testProcessTree() throws Exception {
  try {
    Assert.assertTrue(ProcfsBasedProcessTree.isAvailable());
  }
 catch (  Exception e) {
    LOG.info(StringUtils.stringifyException(e));
    Assert.assertTrue("ProcfsBaseProcessTree should be available on Linux",false);
    return;
  }
  Random rm=new Random();
  File tempFile=new File(TEST_ROOT_DIR,getClass().getName() + "_shellScript_" + rm.nextInt()+ ".sh");
  tempFile.deleteOnExit();
  shellScript=TEST_ROOT_DIR + File.separator + tempFile.getName();
  tempFile=new File(TEST_ROOT_DIR,getClass().getName() + "_pidFile_" + rm.nextInt()+ ".pid");
  tempFile.deleteOnExit();
  pidFile=TEST_ROOT_DIR + File.separator + tempFile.getName();
  lowestDescendant=TEST_ROOT_DIR + File.separator + "lowestDescendantPidFile";
  try {
    FileWriter fWriter=new FileWriter(shellScript);
    fWriter.write("# rogue task\n" + "sleep 1\n" + "echo hello\n"+ "if [ $1 -ne 0 ]\n"+ "then\n"+ " sh " + shellScript + " $(($1-1))\n"+ "else\n"+ " echo $$ > "+ lowestDescendant+ "\n"+ " while true\n do\n"+ "  sleep 5\n"+ " done\n"+ "fi");
    fWriter.close();
  }
 catch (  IOException ioe) {
    LOG.info("Error: " + ioe);
    return;
  }
  Thread t=new RogueTaskThread();
  t.start();
  String pid=getRogueTaskPID();
  LOG.info("Root process pid: " + pid);
  ProcfsBasedProcessTree p=createProcessTree(pid);
  p.updateProcessTree();
  LOG.info("ProcessTree: " + p.toString());
  File leaf=new File(lowestDescendant);
  while (!leaf.exists()) {
    try {
      Thread.sleep(500);
    }
 catch (    InterruptedException ie) {
      break;
    }
  }
  p.updateProcessTree();
  LOG.info("ProcessTree: " + p.toString());
  String processTreeDump=p.getProcessTreeDump();
  destroyProcessTree(pid);
  boolean isAlive=true;
  for (int tries=100; tries > 0; tries--) {
    if (isSetsidAvailable()) {
      isAlive=isAnyProcessInTreeAlive(p);
    }
 else {
      isAlive=isAlive(pid);
    }
    if (!isAlive) {
      break;
    }
    Thread.sleep(100);
  }
  if (isAlive) {
    fail("ProcessTree shouldn't be alive");
  }
  LOG.info("Process-tree dump follows: \n" + processTreeDump);
  Assert.assertTrue("Process-tree dump doesn't start with a proper header",processTreeDump.startsWith("\t|- PID PPID PGRPID SESSID CMD_NAME " + "USER_MODE_TIME(MILLIS) SYSTEM_TIME(MILLIS) VMEM_USAGE(BYTES) " + "RSSMEM_USAGE(PAGES) FULL_CMD_LINE\n"));
  for (int i=N; i >= 0; i--) {
    String cmdLineDump="\\|- [0-9]+ [0-9]+ [0-9]+ [0-9]+ \\(sh\\)" + " [0-9]+ [0-9]+ [0-9]+ [0-9]+ sh " + shellScript + " "+ i;
    Pattern pat=Pattern.compile(cmdLineDump);
    Matcher mat=pat.matcher(processTreeDump);
    Assert.assertTrue("Process-tree dump doesn't contain the cmdLineDump of " + i + "th process!",mat.find());
  }
  try {
    t.join(2000);
    LOG.info("RogueTaskThread successfully joined.");
  }
 catch (  InterruptedException ie) {
    LOG.info("Interrupted while joining RogueTaskThread.");
  }
  p.updateProcessTree();
  Assert.assertFalse("ProcessTree must have been gone",isAlive(pid));
  Assert.assertTrue("Cumulative vmem for the gone-process is " + p.getCumulativeVmem() + " . It should be zero.",p.getCumulativeVmem() == 0);
  Assert.assertTrue(p.toString().equals("[ ]"));
}

</code></pre>

<pre class="type-9 type-13 type-7 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Test the correctness of process-tree dump.
 * @throws IOException
 */
@Test(timeout=30000) public void testProcessTreeDump() throws IOException {
  String[] pids={"100","200","300","400","500","600"};
  File procfsRootDir=new File(TEST_ROOT_DIR,"proc");
  try {
    setupProcfsRootDir(procfsRootDir);
    setupPidDirs(procfsRootDir,pids);
    int numProcesses=pids.length;
    ProcessStatInfo[] procInfos=new ProcessStatInfo[numProcesses];
    procInfos[0]=new ProcessStatInfo(new String[]{"100","proc1","1","100","100","100000","100","1000","200"});
    procInfos[1]=new ProcessStatInfo(new String[]{"200","proc2","100","100","100","200000","200","2000","400"});
    procInfos[2]=new ProcessStatInfo(new String[]{"300","proc3","200","100","100","300000","300","3000","600"});
    procInfos[3]=new ProcessStatInfo(new String[]{"400","proc4","200","100","100","400000","400","4000","800"});
    procInfos[4]=new ProcessStatInfo(new String[]{"500","proc5","400","100","100","400000","400","4000","800"});
    procInfos[5]=new ProcessStatInfo(new String[]{"600","proc6","1","1","1","400000","400","4000","800"});
    ProcessTreeSmapMemInfo[] memInfos=new ProcessTreeSmapMemInfo[6];
    memInfos[0]=new ProcessTreeSmapMemInfo("100");
    memInfos[1]=new ProcessTreeSmapMemInfo("200");
    memInfos[2]=new ProcessTreeSmapMemInfo("300");
    memInfos[3]=new ProcessTreeSmapMemInfo("400");
    memInfos[4]=new ProcessTreeSmapMemInfo("500");
    memInfos[5]=new ProcessTreeSmapMemInfo("600");
    String[] cmdLines=new String[numProcesses];
    cmdLines[0]="proc1 arg1 arg2";
    cmdLines[1]="proc2 arg3 arg4";
    cmdLines[2]="proc3 arg5 arg6";
    cmdLines[3]="proc4 arg7 arg8";
    cmdLines[4]="proc5 arg9 arg10";
    cmdLines[5]="proc6 arg11 arg12";
    createMemoryMappingInfo(memInfos);
    writeStatFiles(procfsRootDir,pids,procInfos,memInfos);
    writeCmdLineFiles(procfsRootDir,pids,cmdLines);
    ProcfsBasedProcessTree processTree=createProcessTree("100",procfsRootDir.getAbsolutePath());
    processTree.updateProcessTree();
    String processTreeDump=processTree.getProcessTreeDump();
    LOG.info("Process-tree dump follows: \n" + processTreeDump);
    Assert.assertTrue("Process-tree dump doesn't start with a proper header",processTreeDump.startsWith("\t|- PID PPID PGRPID SESSID CMD_NAME " + "USER_MODE_TIME(MILLIS) SYSTEM_TIME(MILLIS) VMEM_USAGE(BYTES) " + "RSSMEM_USAGE(PAGES) FULL_CMD_LINE\n"));
    for (int i=0; i < 5; i++) {
      ProcessStatInfo p=procInfos[i];
      Assert.assertTrue("Process-tree dump doesn't contain the cmdLineDump of process " + p.pid,processTreeDump.contains("\t|- " + p.pid + " "+ p.ppid+ " "+ p.pgrpId+ " "+ p.session+ " ("+ p.name+ ") "+ p.utime+ " "+ p.stime+ " "+ p.vmem+ " "+ p.rssmemPage+ " "+ cmdLines[i]));
    }
    ProcessStatInfo p=procInfos[5];
    Assert.assertFalse("Process-tree dump shouldn't contain the cmdLineDump of process " + p.pid,processTreeDump.contains("\t|- " + p.pid + " "+ p.ppid+ " "+ p.pgrpId+ " "+ p.session+ " ("+ p.name+ ") "+ p.utime+ " "+ p.stime+ " "+ p.vmem+ " "+ cmdLines[5]));
  }
  finally {
    FileUtil.fullyDelete(procfsRootDir);
  }
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
"></span><br>
/** 
 * Verifies ProcfsBasedProcessTree.checkPidPgrpidForMatch() in case of
 * 'constructProcessInfo() returning null' by not writing stat file for the
 * mock process
 * @throws IOExceptionif there was a problem setting up the fake procfs directories or
 * files.
 */
@Test(timeout=30000) public void testDestroyProcessTree() throws IOException {
  String pid="100";
  File procfsRootDir=new File(TEST_ROOT_DIR,"proc");
  try {
    setupProcfsRootDir(procfsRootDir);
    createProcessTree(pid,procfsRootDir.getAbsolutePath());
    Assert.assertTrue(ProcfsBasedProcessTree.checkPidPgrpidForMatch(pid,procfsRootDir.getAbsolutePath()));
  }
  finally {
    FileUtil.fullyDelete(procfsRootDir);
  }
}

</code></pre>

<pre class="type-8 type-15 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Sets implicit assumptions ">AssumptionSetter</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
- Sets implicit assumptions 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Before public void setup() throws IOException {
  assumeTrue(Shell.LINUX);
  FileContext.getLocalFSFileContext().delete(new Path(TEST_ROOT_DIR.getAbsolutePath()),true);
}

</code></pre>

<pre class="type-9 type-7 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
/** 
 * A basic test that creates a few process directories and writes stat files.
 * Verifies that the cpu time and memory is correctly computed.
 * @throws IOExceptionif there was a problem setting up the fake procfs directories or
 * files.
 */
@Test(timeout=30000) public void testCpuAndMemoryForProcessTree() throws IOException {
  String[] pids={"100","200","300","400"};
  File procfsRootDir=new File(TEST_ROOT_DIR,"proc");
  try {
    setupProcfsRootDir(procfsRootDir);
    setupPidDirs(procfsRootDir,pids);
    ProcessStatInfo[] procInfos=new ProcessStatInfo[4];
    procInfos[0]=new ProcessStatInfo(new String[]{"100","proc1","1","100","100","100000","100","1000","200"});
    procInfos[1]=new ProcessStatInfo(new String[]{"200","proc2","100","100","100","200000","200","2000","400"});
    procInfos[2]=new ProcessStatInfo(new String[]{"300","proc3","200","100","100","300000","300","3000","600"});
    procInfos[3]=new ProcessStatInfo(new String[]{"400","proc4","1","400","400","400000","400","4000","800"});
    ProcessTreeSmapMemInfo[] memInfo=new ProcessTreeSmapMemInfo[4];
    memInfo[0]=new ProcessTreeSmapMemInfo("100");
    memInfo[1]=new ProcessTreeSmapMemInfo("200");
    memInfo[2]=new ProcessTreeSmapMemInfo("300");
    memInfo[3]=new ProcessTreeSmapMemInfo("400");
    createMemoryMappingInfo(memInfo);
    writeStatFiles(procfsRootDir,pids,procInfos,memInfo);
    Configuration conf=new Configuration();
    ProcfsBasedProcessTree processTree=createProcessTree("100",procfsRootDir.getAbsolutePath());
    processTree.setConf(conf);
    processTree.updateProcessTree();
    Assert.assertEquals("Cumulative virtual memory does not match",600000L,processTree.getCumulativeVmem());
    long cumuRssMem=ProcfsBasedProcessTree.PAGE_SIZE > 0 ? 600L * ProcfsBasedProcessTree.PAGE_SIZE : 0L;
    Assert.assertEquals("Cumulative rss memory does not match",cumuRssMem,processTree.getCumulativeRssmem());
    long cumuCpuTime=ProcfsBasedProcessTree.JIFFY_LENGTH_IN_MILLIS > 0 ? 7200L * ProcfsBasedProcessTree.JIFFY_LENGTH_IN_MILLIS : 0L;
    Assert.assertEquals("Cumulative cpu time does not match",cumuCpuTime,processTree.getCumulativeCpuTime());
    setSmapsInProceTree(processTree,true);
    Assert.assertEquals("Cumulative rss memory does not match",(100 * KB_TO_BYTES * 3),processTree.getCumulativeRssmem());
    procInfos[0]=new ProcessStatInfo(new String[]{"100","proc1","1","100","100","100000","100","2000","300"});
    procInfos[1]=new ProcessStatInfo(new String[]{"200","proc2","100","100","100","200000","200","3000","500"});
    writeStatFiles(procfsRootDir,pids,procInfos,memInfo);
    processTree.updateProcessTree();
    cumuCpuTime=ProcfsBasedProcessTree.JIFFY_LENGTH_IN_MILLIS > 0 ? 9400L * ProcfsBasedProcessTree.JIFFY_LENGTH_IN_MILLIS : 0L;
    Assert.assertEquals("Cumulative cpu time does not match",cumuCpuTime,processTree.getCumulativeCpuTime());
  }
  finally {
    FileUtil.fullyDelete(procfsRootDir);
  }
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
