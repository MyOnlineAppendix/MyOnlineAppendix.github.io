<h3 style="margin:0px">Class: org.apache.sling.discovery.base.its.AbstractClusterTest (14 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(4)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="15"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('15')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-15"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="12"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('12')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-12"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="16"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('16')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-16"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-6 type-9 type-3 type-10 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testAdditionalInstance() throws Throwable {
  logger.info("testAdditionalInstance: start");
  assertNotNull(instance1);
  assertNotNull(instance2);
  assertEquals(instance1.getSlingId(),instance1.getClusterViewService().getSlingId());
  assertEquals(instance2.getSlingId(),instance2.getClusterViewService().getSlingId());
  try {
    instance1.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  try {
    instance2.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  instance1.dumpRepo();
  logger.info("testAdditionalInstance: 1st 2s sleep");
  Thread.sleep(2000);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  logger.info("testAdditionalInstance: 2nd 2s sleep");
  Thread.sleep(2000);
  instance1.dumpRepo();
  String clusterId1=instance1.getClusterViewService().getLocalClusterView().getId();
  logger.info("clusterId1=" + clusterId1);
  String clusterId2=instance2.getClusterViewService().getLocalClusterView().getId();
  logger.info("clusterId2=" + clusterId2);
  assertEquals(clusterId1,clusterId2);
  assertEquals(2,instance1.getClusterViewService().getLocalClusterView().getInstances().size());
  assertEquals(2,instance2.getClusterViewService().getLocalClusterView().getInstances().size());
  AssertingTopologyEventListener assertingTopologyEventListener=new AssertingTopologyEventListener();
  assertingTopologyEventListener.addExpected(Type.TOPOLOGY_INIT);
  assertEquals(1,assertingTopologyEventListener.getRemainingExpectedCount());
  instance1.bindTopologyEventListener(assertingTopologyEventListener);
  Thread.sleep(500);
  assertEquals(0,assertingTopologyEventListener.getRemainingExpectedCount());
  AcceptsMultiple acceptsMultiple=new AcceptsMultiple(Type.TOPOLOGY_CHANGING,Type.TOPOLOGY_CHANGED);
  assertingTopologyEventListener.addExpected(acceptsMultiple);
  assertingTopologyEventListener.addExpected(acceptsMultiple);
  instance3=newBuilder().setDebugName("thirdInstance").useRepositoryOf(instance1).build();
  for (int i=0; i < 4; i++) {
    instance1.heartbeatsAndCheckView();
    instance2.heartbeatsAndCheckView();
    instance3.heartbeatsAndCheckView();
    logger.info("testAdditionalInstance: i=" + i + ", 2s sleep");
    Thread.sleep(2000);
  }
  assertEquals(1,acceptsMultiple.getEventCnt(Type.TOPOLOGY_CHANGING));
  assertEquals(1,acceptsMultiple.getEventCnt(Type.TOPOLOGY_CHANGED));
  logger.info("testAdditionalInstance: end");
}

</code></pre>

<pre class="type-16 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown() throws Exception {
  if (instance5 != null) {
    instance5.stop();
  }
  if (instance4 != null) {
    instance4.stop();
  }
  if (instance3 != null) {
    instance3.stop();
  }
  if (instance3 != null) {
    instance3.stop();
  }
  if (instance2 != null) {
    instance2.stop();
  }
  if (instance1 != null) {
    instance1.stop();
  }
  if (instance1Restarted != null) {
    instance1Restarted.stop();
  }
  instance1Restarted=null;
  instance1=null;
  instance2=null;
  instance3=null;
  instance4=null;
  instance5=null;
  final org.apache.log4j.Logger discoveryLogger=LogManager.getRootLogger().getLogger("org.apache.sling.discovery");
  discoveryLogger.setLevel(logLevel);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Tests stale announcement reported in SLING-4139:
 * An instance which crashes but had announcements, never cleans up those announcements.
 * Thus on a restart, those announcements are still there, even if the connector
 * would no longer be in use (or point somewhere else etc).
 * That has various effects, one of them tested in this method: peers in the same cluster,
 * after the crashed/stopped instance restarts, will assume those stale announcements
 * as being correct and include them in the topology - hence reporting stale instances
 * (which can be old instances or even duplicates).
 */
@Test public void testStaleAnnouncementsVisibleToClusterPeers4139() throws Throwable {
  logger.info("testStaleAnnouncementsVisibleToClusterPeers4139: start");
  final String instance1SlingId=prepare4139();
  instance1Restarted=newBuilder().setDebugName("firstInstance").useRepositoryOf(instance2).setConnectorPingTimeout(Integer.MAX_VALUE).setMinEventDelay(1).setSlingId(instance1SlingId).build();
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  logger.info("instance1Restarted.dump: " + instance1Restarted.slingId);
  instance1Restarted.dumpRepo();
  logger.info("instance2.dump: " + instance2.slingId);
  instance2.dumpRepo();
  logger.info("instance3.dump: " + instance3.slingId);
  instance3.dumpRepo();
  assertTopology(instance1Restarted,new SimpleClusterView(instance1Restarted,instance2));
  assertTopology(instance3,new SimpleClusterView(instance3));
  assertTopology(instance2,new SimpleClusterView(instance1Restarted,instance2));
  instance1Restarted.stop();
  logger.info("testStaleAnnouncementsVisibleToClusterPeers4139: end");
}

</code></pre>

<pre class="type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
/** 
 * Tests a situation where a connector was done to instance1, which eventually
 * crashed, then the connector is done to instance4 (which is in a separate, 3rd cluster). 
 * Meanwhile instance1 got restarted and this test assures that the instance3 is not reported
 * twice in the topology. This used to happen prior to SLING-4139
 */
@Test public void testStaleInstanceIn3Clusters4139() throws Throwable {
  logger.info("testStaleInstanceIn3Clusters4139: start");
  final String instance1SlingId=prepare4139();
  instance4=newBuilder().setDebugName("remoteInstance4").newRepository("/var/discovery/implremote4/",false).setConnectorPingTimeout(Integer.MAX_VALUE).setMinEventDelay(1).build();
  try {
    instance4.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  instance4.heartbeatsAndCheckView();
  instance4.heartbeatsAndCheckView();
  pingConnector(instance3,instance4);
  instance1Restarted=newBuilder().setDebugName("firstInstance").useRepositoryOf(instance2).setConnectorPingTimeout(Integer.MAX_VALUE).setMinEventDelay(1).setSlingId(instance1SlingId).build();
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance4);
  pingConnector(instance3,instance4);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance4);
  pingConnector(instance3,instance4);
  logger.info("iteration 0");
  logger.info("instance1Restarted.slingId: " + instance1Restarted.slingId);
  logger.info("instance2.slingId: " + instance2.slingId);
  logger.info("instance3.slingId: " + instance3.slingId);
  logger.info("instance4.slingId: " + instance4.slingId);
  instance1Restarted.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance3),new SimpleClusterView(instance4));
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2));
  Thread.sleep(100);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance4);
  pingConnector(instance3,instance4);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance4);
  pingConnector(instance3,instance4);
  logger.info("iteration 1");
  logger.info("instance1Restarted.slingId: " + instance1Restarted.slingId);
  logger.info("instance2.slingId: " + instance2.slingId);
  logger.info("instance3.slingId: " + instance3.slingId);
  logger.info("instance4.slingId: " + instance4.slingId);
  instance1Restarted.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2));
  assertSameTopology(new SimpleClusterView(instance3),new SimpleClusterView(instance4));
  Thread.sleep(100);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance4);
  pingConnector(instance3,instance4);
  logger.info("iteration 2");
  logger.info("instance1Restarted.slingId: " + instance1Restarted.slingId);
  logger.info("instance2.slingId: " + instance2.slingId);
  logger.info("instance3.slingId: " + instance3.slingId);
  logger.info("instance4.slingId: " + instance4.slingId);
  instance1Restarted.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2));
  assertSameTopology(new SimpleClusterView(instance3),new SimpleClusterView(instance4));
  instance1Restarted.stop();
  logger.info("testStaleInstanceIn3Clusters4139: end");
}

</code></pre>

<pre class="type-15 type-11 type-13 type-9 type-3 type-10 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testConnectorSwitching4139() throws Throwable {
  final int MIN_EVENT_DELAY=1;
  tearDown();
  final org.apache.log4j.Logger discoveryLogger=LogManager.getRootLogger().getLogger("org.apache.sling.discovery");
  logLevel=discoveryLogger.getLevel();
  discoveryLogger.setLevel(Level.DEBUG);
  instance1=newBuilder().setDebugName("instance1").newRepository("/var/discovery/clusterA/",true).setConnectorPingTimeout(10).setConnectorPingInterval(999).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance2=newBuilder().setDebugName("instance2").useRepositoryOf(instance1).setConnectorPingTimeout(10).setConnectorPingInterval(999).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance3=newBuilder().setDebugName("instance3").newRepository("/var/discovery/clusterB/",false).setConnectorPingTimeout(10).setConnectorPingInterval(999).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance4=newBuilder().setDebugName("instance4").useRepositoryOf(instance3).setConnectorPingTimeout(10).setConnectorPingInterval(999).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance5=newBuilder().setDebugName("instance5").newRepository("/var/discovery/clusterC/",false).setConnectorPingTimeout(10).setConnectorPingInterval(999).setMinEventDelay(MIN_EVENT_DELAY).build();
  runHeartbeatOnceWith(instance1,instance2,instance3,instance4,instance5);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1,instance2,instance3,instance4,instance5);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1,instance2,instance3,instance4,instance5);
  Thread.sleep(500);
  assertSameTopology(new SimpleClusterView(instance1,instance2));
  assertSameTopology(new SimpleClusterView(instance3,instance4));
  assertSameTopology(new SimpleClusterView(instance5));
  runHeartbeatOnceWith(instance1,instance2,instance3,instance4,instance5);
  pingConnector(instance3,instance1);
  pingConnector(instance5,instance1);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1,instance2,instance3,instance4,instance5);
  pingConnector(instance3,instance1);
  pingConnector(instance5,instance1);
  Thread.sleep(500);
  logger.info("testConnectorSwitching4139: instance1.slingId=" + instance1.slingId);
  logger.info("testConnectorSwitching4139: instance2.slingId=" + instance2.slingId);
  logger.info("testConnectorSwitching4139: instance3.slingId=" + instance3.slingId);
  logger.info("testConnectorSwitching4139: instance4.slingId=" + instance4.slingId);
  logger.info("testConnectorSwitching4139: instance5.slingId=" + instance5.slingId);
  instance1.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance1,instance2),new SimpleClusterView(instance3,instance4),new SimpleClusterView(instance5));
  boolean success=false;
  for (int i=0; i < 25; i++) {
    runHeartbeatOnceWith(instance2,instance3,instance4,instance5);
    final boolean ping1=pingConnector(instance3,instance2);
    final boolean ping2=pingConnector(instance5,instance2);
    if (ping1 && ping2) {
      success=true;
      logger.info("testConnectorSwitching4139: successfully switched all pings to instance2 after " + i + " rounds.");
      if (i < 20) {
        logger.info("testConnectorSwitching4139: min loop cnt not yet reached: i=" + i);
        Thread.sleep(1000);
        continue;
      }
      break;
    }
    logger.info("testConnectorSwitching4139: looping cos ping1=" + ping1 + ", ping2="+ ping2);
    Thread.sleep(1000);
  }
  assertTrue(success);
  runHeartbeatOnceWith(instance2,instance3,instance4,instance5);
  assertTrue(pingConnector(instance3,instance2));
  assertTrue(pingConnector(instance5,instance2));
  instance2.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance2),new SimpleClusterView(instance3,instance4),new SimpleClusterView(instance5));
  instance4.stopViewChecker();
  instance1Restarted=newBuilder().setDebugName("instance1").useRepositoryOf(instance2).setConnectorPingTimeout(Integer.MAX_VALUE).setMinEventDelay(1).setSlingId(instance1.getSlingId()).build();
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance5);
  Thread.sleep(2000);
  assertTrue(pingConnector(instance3,instance2));
  assertTrue(pingConnector(instance5,instance2));
  success=false;
  for (int i=0; i < 40; i++) {
    runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance5);
    instance1.getViewChecker().checkView();
    try {
      pingConnector(instance3,instance2);
    }
 catch (    UndefinedClusterViewException ucve) {
    }
    pingConnector(instance5,instance2);
    final TopologyView topology=instance3.getDiscoveryService().getTopology();
    InstanceDescription i3=null;
    for (Iterator<InstanceDescription> it=topology.getInstances().iterator(); it.hasNext(); ) {
      final InstanceDescription id=it.next();
      if (id.getSlingId().equals(instance3.slingId)) {
        i3=id;
        break;
      }
    }
    assertNotNull(i3);
    assertEquals(instance3.slingId,i3.getSlingId());
    final ClusterView i3Cluster=i3.getClusterView();
    final int i3ClusterSize=i3Cluster.getInstances().size();
    if (i3ClusterSize == 1) {
      if (i < 30) {
        logger.info("testConnectorSwitching4139: [2] min loop cnt not yet reached: i=" + i);
        Thread.sleep(500);
        continue;
      }
      success=true;
      logger.info("testConnectorSwitching4139: i3ClusterSize: " + i3ClusterSize + ", i="+ i+ " (success)");
      break;
    }
    logger.info("testConnectorSwitching4139: i3ClusterSize: " + i3ClusterSize + ", i="+ i);
    Thread.sleep(500);
  }
  logger.info("testConnectorSwitching4139: instance1Restarted.slingId=" + instance1Restarted.slingId);
  logger.info("testConnectorSwitching4139: instance2.slingId=" + instance2.slingId);
  logger.info("testConnectorSwitching4139: instance3.slingId=" + instance3.slingId);
  logger.info("testConnectorSwitching4139: instance4.slingId=" + instance4.slingId);
  logger.info("testConnectorSwitching4139: instance5.slingId=" + instance5.slingId);
  instance1Restarted.dumpRepo();
  assertTrue(success);
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2),new SimpleClusterView(instance3),new SimpleClusterView(instance5));
  instance1Restarted.stop();
}

</code></pre>

<pre class="type-9 type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
"></span><br>
@Test public void testPropertyProviders() throws Throwable {
  logger.info("testPropertyProviders: start");
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  assertNull(instance3);
  instance3=newBuilder().setDebugName("thirdInstance").useRepositoryOf(instance1).build();
  instance3.heartbeatsAndCheckView();
  logger.info("testPropertyProviders: 1st 2s sleep");
  Thread.sleep(2000);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  instance3.heartbeatsAndCheckView();
  logger.info("testPropertyProviders: 2nd 2s sleep");
  Thread.sleep(2000);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  instance3.heartbeatsAndCheckView();
  logger.info("testPropertyProviders: 3rd 2s sleep");
  Thread.sleep(2000);
  property1Value=UUID.randomUUID().toString();
  property1Name=UUID.randomUUID().toString();
  PropertyProviderImpl pp1=new PropertyProviderImpl();
  pp1.setProperty(property1Name,property1Value);
  instance1.bindPropertyProvider(pp1,property1Name);
  property2Value=UUID.randomUUID().toString();
  property2Name=UUID.randomUUID().toString();
  PropertyProviderImpl pp2=new PropertyProviderImpl();
  pp2.setProperty(property2Name,property2Value);
  instance2.bindPropertyProvider(pp2,property2Name);
  assertPropertyValues();
  property1Value=UUID.randomUUID().toString();
  pp1.setProperty(property1Name,property1Value);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  assertPropertyValues();
  assertNull(instance1.getClusterViewService().getLocalClusterView().getInstances().get(0).getProperty(UUID.randomUUID().toString()));
  assertNull(instance2.getClusterViewService().getLocalClusterView().getInstances().get(0).getProperty(UUID.randomUUID().toString()));
  logger.info("testPropertyProviders: end");
}

</code></pre>

<pre class="type-15 type-11 type-13 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testDuplicateInstance3726() throws Throwable {
  logger.info("testDuplicateInstance3726: start");
  final int MIN_EVENT_DELAY=1;
  tearDown();
  final org.apache.log4j.Logger discoveryLogger=LogManager.getRootLogger().getLogger("org.apache.sling.discovery");
  logLevel=discoveryLogger.getLevel();
  discoveryLogger.setLevel(Level.DEBUG);
  instance1=newBuilder().setDebugName("instance1").newRepository("/var/discovery/clusterA/",true).setConnectorPingTimeout(15).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance2=newBuilder().setDebugName("instance2").useRepositoryOf(instance1).setConnectorPingTimeout(15).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance3=newBuilder().setDebugName("instance3").newRepository("/var/discovery/clusterB/",false).setConnectorPingTimeout(15).setMinEventDelay(MIN_EVENT_DELAY).build();
  instance5=newBuilder().setDebugName("instance5").newRepository("/var/discovery/clusterC/",false).setConnectorPingTimeout(15).setMinEventDelay(MIN_EVENT_DELAY).build();
  runHeartbeatOnceWith(instance1,instance2,instance3,instance5);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1,instance2,instance3,instance5);
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1,instance2,instance3,instance5);
  Thread.sleep(500);
  assertSameTopology(new SimpleClusterView(instance1,instance2));
  assertSameTopology(new SimpleClusterView(instance3));
  assertSameTopology(new SimpleClusterView(instance5));
  pingConnector(instance3,instance1);
  pingConnector(instance5,instance1);
  pingConnector(instance3,instance1);
  pingConnector(instance5,instance1);
  logger.info("testDuplicateInstance3726: instance1.slingId=" + instance1.slingId);
  logger.info("testDuplicateInstance3726: instance2.slingId=" + instance2.slingId);
  logger.info("testDuplicateInstance3726: instance3.slingId=" + instance3.slingId);
  logger.info("testDuplicateInstance3726: instance5.slingId=" + instance5.slingId);
  instance1.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance1,instance2),new SimpleClusterView(instance3),new SimpleClusterView(instance5));
  instance1.stopViewChecker();
  boolean success=false;
  for (int i=0; i < 25; i++) {
    runHeartbeatOnceWith(instance2,instance3,instance5);
    final boolean ping1=pingConnector(instance3,instance2);
    final boolean ping2=pingConnector(instance5,instance2);
    if (ping1 && ping2) {
      success=true;
      logger.info("testDuplicateInstance3726: successfully switched all pings to instance2 after " + i + " rounds.");
      if (i < 20) {
        logger.info("testDuplicateInstance3726: min loop cnt not yet reached: i=" + i);
        Thread.sleep(1000);
        continue;
      }
      break;
    }
    logger.info("testDuplicateInstance3726: looping");
    Thread.sleep(1000);
  }
  assertTrue(success);
  runHeartbeatOnceWith(instance2,instance3,instance5);
  assertTrue(pingConnector(instance3,instance2));
  assertTrue(pingConnector(instance5,instance2));
  instance2.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance2),new SimpleClusterView(instance3),new SimpleClusterView(instance5));
  instance1Restarted=newBuilder().setDebugName("instance1").useRepositoryOf(instance2).setConnectorPingTimeout(Integer.MAX_VALUE).setMinEventDelay(1).setSlingId(instance1.getSlingId()).build();
  instance4=newBuilder().setDebugName("instance4").useRepositoryOf(instance3).setConnectorPingTimeout(30).setMinEventDelay(MIN_EVENT_DELAY).build();
  for (int i=0; i < 3; i++) {
    runHeartbeatOnceWith(instance1Restarted,instance2,instance3,instance4,instance5);
    Thread.sleep(250);
    try {
      pingConnector(instance3,instance2);
    }
 catch (    UndefinedClusterViewException ucve) {
    }
    assertTrue(pingConnector(instance5,instance2));
  }
  instance1Restarted.dumpRepo();
  logger.info("testDuplicateInstance3726: instance1Restarted.slingId=" + instance1Restarted.slingId);
  logger.info("testDuplicateInstance3726: instance2.slingId=" + instance2.slingId);
  logger.info("testDuplicateInstance3726: instance3.slingId=" + instance3.slingId);
  logger.info("testDuplicateInstance3726: instance4.slingId=" + instance4.slingId);
  logger.info("testDuplicateInstance3726: instance5.slingId=" + instance5.slingId);
  assertTrue(success);
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2),new SimpleClusterView(instance3,instance4),new SimpleClusterView(instance5));
  instance1Restarted.stop();
  logger.info("testDuplicateInstance3726: end");
}

</code></pre>

<pre class="type-11 type-6 type-9 type-3 type-10 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testClusterView() throws Exception {
  logger.info("testClusterView: start");
  assertNotNull(instance1);
  assertNotNull(instance2);
  assertNull(instance3);
  instance3=newBuilder().setDebugName("thirdInstance").useRepositoryOf(instance1).build();
  assertNotNull(instance3);
  assertEquals(instance1.getSlingId(),instance1.getClusterViewService().getSlingId());
  assertEquals(instance2.getSlingId(),instance2.getClusterViewService().getSlingId());
  assertEquals(instance3.getSlingId(),instance3.getClusterViewService().getSlingId());
  try {
    instance1.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  try {
    instance2.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  try {
    instance3.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  instance1.dumpRepo();
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  instance3.heartbeatsAndCheckView();
  instance1.dumpRepo();
  logger.info("testClusterView: 1st 2s sleep");
  Thread.sleep(2000);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  instance3.heartbeatsAndCheckView();
  logger.info("testClusterView: 2nd 2s sleep");
  Thread.sleep(2000);
  instance1.dumpRepo();
  String clusterId1=instance1.getClusterViewService().getLocalClusterView().getId();
  logger.info("clusterId1=" + clusterId1);
  String clusterId2=instance2.getClusterViewService().getLocalClusterView().getId();
  logger.info("clusterId2=" + clusterId2);
  String clusterId3=instance3.getClusterViewService().getLocalClusterView().getId();
  logger.info("clusterId3=" + clusterId3);
  assertEquals(clusterId1,clusterId2);
  assertEquals(clusterId1,clusterId3);
  assertEquals(3,instance1.getClusterViewService().getLocalClusterView().getInstances().size());
  assertEquals(3,instance2.getClusterViewService().getLocalClusterView().getInstances().size());
  assertEquals(3,instance3.getClusterViewService().getLocalClusterView().getInstances().size());
  logger.info("testClusterView: end");
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Tests a situation where a connector was done to instance1, which eventually
 * crashed, then the connector is done to instance2. Meanwhile instance1 
 * got restarted and this test assures that the instance3 is not reported
 * twice in the topology. Did not happen before 4139, but should never afterwards neither
 */
@Test public void testDuplicateInstanceIn2Clusters4139() throws Throwable {
  logger.info("testDuplicateInstanceIn2Clusters4139: start");
  final String instance1SlingId=prepare4139();
  pingConnector(instance3,instance2);
  instance1Restarted=newBuilder().setDebugName("firstInstance").useRepositoryOf(instance2).setConnectorPingTimeout(Integer.MAX_VALUE).setMinEventDelay(1).setSlingId(instance1SlingId).build();
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  pingConnector(instance3,instance2);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  pingConnector(instance3,instance2);
  logger.info("iteration 0");
  logger.info("instance1Restarted.slingId: " + instance1Restarted.slingId);
  logger.info("instance2.slingId: " + instance2.slingId);
  logger.info("instance3.slingId: " + instance3.slingId);
  instance1Restarted.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2),new SimpleClusterView(instance3));
  Thread.sleep(500);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  pingConnector(instance3,instance2);
  runHeartbeatOnceWith(instance1Restarted,instance2,instance3);
  pingConnector(instance3,instance2);
  logger.info("iteration 1");
  logger.info("instance1Restarted.slingId: " + instance1Restarted.slingId);
  logger.info("instance2.slingId: " + instance2.slingId);
  logger.info("instance3.slingId: " + instance3.slingId);
  instance1Restarted.dumpRepo();
  assertSameTopology(new SimpleClusterView(instance1Restarted,instance2),new SimpleClusterView(instance3));
  instance1Restarted.stop();
  logger.info("testDuplicateInstanceIn2Clusters4139: end");
}

</code></pre>

<pre class="type-11 type-6 type-9 type-3 type-10 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testStableClusterId() throws Throwable {
  logger.info("testStableClusterId: start");
  instance2.stopViewChecker();
  instance1.stopViewChecker();
  instance2.stop();
  instance1.stop();
  instance1=newBuilder().setDebugName("firstInstance").newRepository("/var/discovery/impl/",true).setConnectorPingTimeout(100).setMinEventDelay(1).build();
  instance2=newBuilder().setDebugName("secondInstance").useRepositoryOf(instance1).setConnectorPingTimeout(100).setMinEventDelay(1).build();
  assertNotNull(instance1);
  assertNotNull(instance2);
  try {
    instance1.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  try {
    instance2.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  String newClusterId1=instance1.getClusterViewService().getLocalClusterView().getId();
  String newClusterId2=instance2.getClusterViewService().getLocalClusterView().getId();
  assertEquals(newClusterId1,newClusterId1);
  instance1.dumpRepo();
  assertEquals(2,instance1.getClusterViewService().getLocalClusterView().getInstances().size());
  assertEquals(2,instance2.getClusterViewService().getLocalClusterView().getInstances().size());
  instance2.getConfig().setViewCheckTimeout(1);
  instance1.getConfig().setViewCheckTimeout(1);
  instance2.stopViewChecker();
  instance1.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  assertEquals(1,instance1.getClusterViewService().getLocalClusterView().getInstances().size());
  try {
    instance2.getViewChecker().checkView();
    instance2.getClusterViewService().getLocalClusterView();
    fail("should complain");
  }
 catch (  UndefinedClusterViewException e) {
  }
  instance1.dumpRepo();
  String actualClusterId=instance1.getClusterViewService().getLocalClusterView().getId();
  logger.info("expected cluster id: " + newClusterId1);
  logger.info("actual   cluster id: " + actualClusterId);
  assertEquals(newClusterId1,actualClusterId);
  logger.info("testStableClusterId: end");
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * test leader behaviour with descending slingIds, SLING-3253 
 */
@Test public void testLeaderDesc() throws Throwable {
  logger.info("testLeaderDesc: start");
  doTestLeader("111","000");
  logger.info("testLeaderDesc: end");
}

</code></pre>

<pre class="type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setup() throws Exception {
  final org.apache.log4j.Logger discoveryLogger=LogManager.getRootLogger().getLogger("org.apache.sling.discovery");
  logLevel=discoveryLogger.getLevel();
  discoveryLogger.setLevel(Level.TRACE);
  logger.debug("here we are");
  instance1=newBuilder().setDebugName("firstInstance").newRepository("/var/discovery/impl/",true).build();
  instance2=newBuilder().setDebugName("secondInstance").useRepositoryOf(instance1).build();
}

</code></pre>

<pre class="type-11 type-12 type-6 type-13 type-9 type-3 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test plan:
 * * have a discoveryservice with two listeners registered
 * * one of them (the 'first' one) is long running
 * * during one of the topology changes, when the first
 * one is hit, deactivate the discovery service
 * * that deactivation used to block (SLING-4755) due
 * to synchronized(lock) which was blocked by the
 * long running listener. With having asynchronous
 * event sending this should no longer be the case
 * * also, once asserted that deactivation finished,
 * and that the first listener is still busy, make
 * sure that once the first listener finishes, that
 * the second listener still gets the event
 * @throws Throwable 
 */
@Test public void testLongRunningListener() throws Throwable {
  instance1.getConfig().setViewCheckTimeout(2);
  instance2.getConfig().setViewCheckTimeout(2);
  logger.info("testLongRunningListener : letting instance2 remain silent from now on");
  instance1.heartbeatsAndCheckView();
  Thread.sleep(1500);
  instance1.heartbeatsAndCheckView();
  Thread.sleep(1500);
  instance1.heartbeatsAndCheckView();
  Thread.sleep(1500);
  instance1.heartbeatsAndCheckView();
  logger.info("testLongRunningListener : instance 2 should now be considered dead");
  LongRunningListener longRunningListener1=new LongRunningListener();
  AssertingTopologyEventListener fastListener2=new AssertingTopologyEventListener();
  fastListener2.addExpected(Type.TOPOLOGY_INIT);
  longRunningListener1.assertNoFail();
  assertEquals(1,fastListener2.getRemainingExpectedCount());
  logger.info("testLongRunningListener : binding longRunningListener1 ...");
  instance1.bindTopologyEventListener(longRunningListener1);
  logger.info("testLongRunningListener : binding fastListener2 ...");
  instance1.bindTopologyEventListener(fastListener2);
  logger.info("testLongRunningListener : waiting a bit for longRunningListener1 to receive the TOPOLOGY_INIT event");
  Thread.sleep(2500);
  assertEquals(0,fastListener2.getRemainingExpectedCount());
  assertTrue(longRunningListener1.initReceived);
  fastListener2.addExpected(Type.TOPOLOGY_CHANGING);
  fastListener2.addExpected(Type.TOPOLOGY_CHANGED);
  instance1.getConfig().setViewCheckTimeout(10);
  instance2.getConfig().setViewCheckTimeout(10);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.heartbeatsAndCheckView();
  instance2.heartbeatsAndCheckView();
  Thread.sleep(500);
  instance1.dumpRepo();
  longRunningListener1.assertNoFail();
  assertEquals(0,fastListener2.getUnexpectedCount());
  assertEquals(1,fastListener2.getRemainingExpectedCount());
  assertEquals(1,longRunningListener1.noninitReceived);
  Thread.sleep(2000);
  assertTrue(longRunningListener1.getChangedSemaphore().hasQueuedThreads());
  Thread.sleep(2000);
  assertEquals(0,fastListener2.getUnexpectedCount());
  assertEquals(1,fastListener2.getRemainingExpectedCount());
  assertEquals(1,longRunningListener1.noninitReceived);
  assertTrue(longRunningListener1.getChangedSemaphore().hasQueuedThreads());
  final List<Exception> asyncException=new LinkedList<Exception>();
  Thread th=new Thread(new Runnable(){
    public void run(){
      try {
        instance1.stop();
      }
 catch (      Exception e) {
synchronized (asyncException) {
          asyncException.add(e);
        }
      }
    }
  }
);
  th.start();
  logger.info("Waiting max 4 sec...");
  th.join(4000);
  logger.info("Done waiting max 4 sec...");
  if (th.isAlive()) {
    logger.warn("Thread still alive: " + th.isAlive());
    longRunningListener1.getChangedSemaphore().release();
    fail("Thread was still alive");
  }
  logger.info("Thread was no longer alive: " + th.isAlive());
synchronized (asyncException) {
    logger.info("Async exceptions: " + asyncException.size());
    if (asyncException.size() != 0) {
      longRunningListener1.getChangedSemaphore().release();
      fail("async exceptions: " + asyncException.size() + ", first: "+ asyncException.get(0));
    }
  }
  longRunningListener1.getChangedSemaphore().release();
  Thread.sleep(500);
  assertEquals(0,fastListener2.getUnexpectedCount());
  assertEquals(0,fastListener2.getRemainingExpectedCount());
  assertEquals(2,longRunningListener1.noninitReceived);
  assertFalse(longRunningListener1.getChangedSemaphore().hasQueuedThreads());
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * test leader behaviour with ascending slingIds, SLING-3253 
 */
@Test public void testLeaderAsc() throws Throwable {
  logger.info("testLeaderAsc: start");
  doTestLeader("000","111");
  logger.info("testLeaderAsc: end");
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
