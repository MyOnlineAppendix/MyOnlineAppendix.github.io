<h3 style="margin:0px">Class: org.apache.jackrabbit.oak.plugins.index.lucene.LuceneIndexTest (20 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(9)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(8)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void cleanUp(){
  for (  File d : dirs) {
    FileUtils.deleteQuietly(d);
  }
}

</code></pre>

<pre class="type-9 type-7 type-6 type-4 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testCursorStability() throws Exception {
  NodeBuilder index=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  NodeBuilder rules=index.child(INDEX_RULES);
  NodeBuilder fooProp=rules.child("nt:base").child(LuceneIndexConstants.PROP_NODE).child("foo");
  fooProp.setProperty(LuceneIndexConstants.PROP_PROPERTY_INDEX,true);
  NodeState before=builder.getNodeState();
  int noOfDocs=LucenePropertyIndex.LUCENE_QUERY_BATCH_SIZE + 10;
  for (int i=0; i < noOfDocs; i++) {
    builder.child("a" + i).setProperty("foo",(long)i);
  }
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictProperty("foo",Operator.GREATER_OR_EQUAL,PropertyValues.newLong(0L));
  List<IndexPlan> plans=queryIndex.getPlans(filter,null,indexed);
  Cursor cursor=queryIndex.query(plans.get(0),indexed);
  assertTrue(cursor.hasNext());
  before=indexed;
  builder=indexed.builder();
  for (int i=0; i < noOfDocs - 10; i++) {
    builder.child("a" + i).remove();
  }
  after=builder.getNodeState();
  indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  builder=indexed.builder();
  NodeBuilder idx=builder.child(INDEX_DEFINITIONS_NAME).child("lucene");
  purgeDeletedDocs(idx,new IndexDefinition(root,idx));
  int numDeletes=getDeletedDocCount(idx,new IndexDefinition(root,idx));
  Assert.assertEquals(0,numDeletes);
  tracker.update(builder.getNodeState());
  Assert.assertTrue(Iterators.size(cursor) > 0);
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testPathRestrictions() throws Exception {
  NodeBuilder idx=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  idx.setProperty(LuceneIndexConstants.EVALUATE_PATH_RESTRICTION,true);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  builder.child("a").setProperty("foo","bar");
  builder.child("a1").setProperty("foo","bar");
  builder.child("a").child("b").setProperty("foo","bar");
  builder.child("a").child("b").child("c").setProperty("foo","bar");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createTestFilter();
  filter.restrictPath("/",Filter.PathRestriction.EXACT);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/"));
  filter=createTestFilter();
  filter.restrictPath("/",Filter.PathRestriction.DIRECT_CHILDREN);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/a","/a1"));
  filter=createTestFilter();
  filter.restrictPath("/a",Filter.PathRestriction.DIRECT_CHILDREN);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/a/b"));
  filter=createTestFilter();
  filter.restrictPath("/a",Filter.PathRestriction.ALL_CHILDREN);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/a/b","/a/b/c"));
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void luceneWithCopyOnReadDir() throws Exception {
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  newLucenePropertyIndexDefinition(index,"lucene",ImmutableSet.of("foo","foo2"),null);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  File indexRootDir=new File(getIndexDir());
  IndexTracker tracker=new IndexTracker(new IndexCopier(sameThreadExecutor(),indexRootDir));
  tracker.update(indexed);
  assertQuery(tracker,indexed,"foo","bar");
  builder=indexed.builder();
  builder.setProperty("foo2","bar2");
  indexed=HOOK.processCommit(indexed,builder.getNodeState(),CommitInfo.EMPTY);
  tracker.update(indexed);
  assertQuery(tracker,indexed,"foo2","bar2");
}

</code></pre>

<pre class="type-9 type-7 type-6 type-4 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLuceneV1NonExistentProperty() throws Exception {
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  NodeBuilder defn=newLuceneIndexDefinition(index,"lucene",ImmutableSet.of("String"));
  defn.setProperty(LuceneIndexConstants.COMPAT_MODE,IndexFormatVersion.V1.getVersion());
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","value-with-dash");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LuceneIndex(tracker,null);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictPath("/",Filter.PathRestriction.EXACT);
  filter.setFullTextConstraint(FullTextParser.parse("foo","value-with*"));
  List<IndexPlan> plans=queryIndex.getPlans(filter,null,builder.getNodeState());
  Cursor cursor=queryIndex.query(plans.get(0),indexed);
  assertTrue(cursor.hasNext());
  assertEquals("/",cursor.next().getPath());
  assertFalse(cursor.hasNext());
  FilterImpl filter2=createFilter(NT_BASE);
  filter2.restrictPath("/",Filter.PathRestriction.EXACT);
  filter2.setFullTextConstraint(FullTextParser.parse("baz","value-with*"));
  List<IndexPlan> plans2=queryIndex.getPlans(filter2,null,builder.getNodeState());
  Cursor cursor2=queryIndex.query(plans2.get(0),indexed);
  assertFalse(cursor2.hasNext());
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testPropertyNonExistence() throws Exception {
  root=TestUtil.registerTestNodeType(builder).getNodeState();
  NodeBuilder index=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  NodeBuilder rules=index.child(INDEX_RULES);
  NodeBuilder propNode=rules.child(NT_TEST).child(LuceneIndexConstants.PROP_NODE);
  NodeBuilder fooProp=propNode.child("foo");
  fooProp.setProperty(LuceneIndexConstants.PROP_PROPERTY_INDEX,true);
  fooProp.setProperty(LuceneIndexConstants.PROP_NULL_CHECK_ENABLED,true);
  NodeState before=builder.getNodeState();
  createNodeWithType(builder,"a",NT_TEST).setProperty("foo","bar");
  createNodeWithType(builder,"b",NT_TEST).setProperty("foo","bar");
  createNodeWithType(builder,"c",NT_TEST);
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_TEST);
  filter.restrictProperty("foo",Operator.EQUAL,null);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/c"));
}

</code></pre>

<pre class="type-9 type-7 type-6 type-4 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLucene() throws Exception {
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  newLucenePropertyIndexDefinition(index,"lucene",ImmutableSet.of("foo"),null);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictPath("/",Filter.PathRestriction.EXACT);
  filter.restrictProperty("foo",Operator.EQUAL,PropertyValues.newString("bar"));
  List<IndexPlan> plans=queryIndex.getPlans(filter,null,builder.getNodeState());
  Cursor cursor=queryIndex.query(plans.get(0),indexed);
  assertTrue(cursor.hasNext());
  assertEquals("/",cursor.next().getPath());
  assertFalse(cursor.hasNext());
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void analyzerWithStopWords() throws Exception {
  NodeBuilder nb=newLuceneIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",of(TYPENAME_STRING));
  TestUtil.useV2(nb);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","fox jumping");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter("nt:base");
  filter.setFullTextConstraint(new FullTextTerm(null,"fox jumping",false,false,null));
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/"));
  filter.setFullTextConstraint(new FullTextTerm(null,"fox was jumping",false,false,null));
  assertFilter(filter,queryIndex,indexed,Collections.<String>emptyList());
  NodeBuilder anlnb=nb.child(ANALYZERS).child(ANL_DEFAULT);
  anlnb.child(ANL_TOKENIZER).setProperty(ANL_NAME,"whitespace");
  anlnb.child(ANL_FILTERS).child("stop");
  nb.setProperty(IndexConstants.REINDEX_PROPERTY_NAME,true);
  before=after;
  after=builder.getNodeState();
  indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  tracker.update(indexed);
  queryIndex=new LucenePropertyIndex(tracker);
  filter.setFullTextConstraint(new FullTextTerm(null,"fox jumping",false,false,null));
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/"));
  filter.setFullTextConstraint(new FullTextTerm(null,"fox was jumping",false,false,null));
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/"));
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void luceneWithFSDirectory() throws Exception {
  NodeStore nodeStore=new SegmentNodeStore();
  final IndexTracker tracker=new IndexTracker();
  ((Observable)nodeStore).addObserver(new Observer(){
    @Override public void contentChanged(    @Nonnull NodeState root,    @Nullable CommitInfo info){
      tracker.update(root);
    }
  }
);
  builder=nodeStore.getRoot().builder();
  builder.setChildNode(JCR_SYSTEM,INITIAL_CONTENT.getChildNode(JCR_SYSTEM));
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  NodeBuilder idxb=newLucenePropertyIndexDefinition(index,"lucene",ImmutableSet.of("foo","foo2"),null);
  idxb.setProperty(PERSISTENCE_NAME,PERSISTENCE_FILE);
  idxb.setProperty(PERSISTENCE_PATH,getIndexDir());
  nodeStore.merge(builder,EmptyHook.INSTANCE,CommitInfo.EMPTY);
  builder=nodeStore.getRoot().builder();
  builder.setProperty("foo","bar");
  NodeState indexed=nodeStore.merge(builder,HOOK,CommitInfo.EMPTY);
  assertQuery(tracker,indexed,"foo","bar");
  builder=nodeStore.getRoot().builder();
  builder.setProperty("foo2","bar2");
  indexed=nodeStore.merge(builder,HOOK,CommitInfo.EMPTY);
  assertQuery(tracker,indexed,"foo2","bar2");
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void multiValuesForOrderedIndexShouldNotThrow(){
  NodeBuilder index=newLuceneIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",null);
  NodeBuilder singleProp=TestUtil.child(index,"indexRules/nt:base/properties/single");
  singleProp.setProperty(LuceneIndexConstants.PROP_PROPERTY_INDEX,true);
  singleProp.setProperty(LuceneIndexConstants.PROP_ORDERED,true);
  singleProp.setProperty(LuceneIndexConstants.PROP_INCLUDED_TYPE,PropertyType.TYPENAME_STRING);
  NodeState before=builder.getNodeState();
  builder.setProperty("single",asList("baz","bar"),Type.STRINGS);
  NodeState after=builder.getNodeState();
  try {
    HOOK.processCommit(before,after,CommitInfo.EMPTY);
  }
 catch (  CommitFailedException e) {
    fail("Exception thrown when indexing invalid content");
  }
}

</code></pre>

<pre class="type-9 type-7 type-6 type-4 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLucene3() throws Exception {
  NodeBuilder index=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  NodeBuilder rules=index.child(INDEX_RULES);
  NodeBuilder fooProp=rules.child("nt:base").child(LuceneIndexConstants.PROP_NODE).child("foo");
  fooProp.setProperty(LuceneIndexConstants.PROP_PROPERTY_INDEX,true);
  fooProp.setProperty(LuceneIndexConstants.PROP_INCLUDED_TYPE,PropertyType.TYPENAME_STRING);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  builder.child("a").setProperty("foo","bar");
  builder.child("a").child("b").setProperty("foo","bar",Type.NAME);
  builder.child("a").child("b").child("c").setProperty("foo","bar",Type.NAME);
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictProperty("foo",Operator.EQUAL,PropertyValues.newString("bar"));
  List<IndexPlan> plans=queryIndex.getPlans(filter,null,indexed);
  Cursor cursor=queryIndex.query(plans.get(0),indexed);
  assertTrue(cursor.hasNext());
  assertEquals("/a",cursor.next().getPath());
  assertEquals("/",cursor.next().getPath());
  assertFalse(cursor.hasNext());
}

</code></pre>

<pre class="type-9 type-7 type-6 type-4 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLuceneLazyCursor() throws Exception {
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  newLucenePropertyIndexDefinition(index,"lucene",ImmutableSet.of("foo"),null);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  for (int i=0; i < LuceneIndex.LUCENE_QUERY_BATCH_SIZE; i++) {
    builder.child("parent").child("child" + i).setProperty("foo","bar");
  }
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictProperty("foo",Operator.EQUAL,PropertyValues.newString("bar"));
  List<IndexPlan> plans=queryIndex.getPlans(filter,null,indexed);
  Cursor cursor=queryIndex.query(plans.get(0),indexed);
  List<String> paths=copyOf(transform(cursor,new Function<IndexRow,String>(){
    public String apply(    IndexRow input){
      return input.getPath();
    }
  }
));
  assertTrue(!paths.isEmpty());
  assertEquals(LuceneIndex.LUCENE_QUERY_BATCH_SIZE + 1,paths.size());
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void indexNodeLockHandling() throws Exception {
  IndexTracker tracker=new IndexTracker();
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  NodeBuilder nb=newLuceneIndexDefinitionV2(index,"lucene",of(TYPENAME_STRING));
  nb.setProperty(LuceneIndexConstants.FULL_TEXT_ENABLED,false);
  nb.setProperty(createProperty(INCLUDE_PROPERTY_NAMES,of("foo"),STRINGS));
  index=builder.child("test").child(INDEX_DEFINITIONS_NAME);
  NodeBuilder nb2=newLuceneIndexDefinitionV2(index,"lucene",of(TYPENAME_STRING));
  nb2.setProperty(LuceneIndexConstants.FULL_TEXT_ENABLED,false);
  nb2.setProperty(createProperty(INCLUDE_PROPERTY_NAMES,of("foo"),STRINGS));
  NodeState before=builder.getNodeState();
  builder.child("test").setProperty("foo","fox is jumping");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  tracker.update(indexed);
  QueryIndex.AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictPath("/test",Filter.PathRestriction.EXACT);
  filter.restrictProperty("foo",Operator.EQUAL,PropertyValues.newString("bar"));
  builder=indexed.builder();
  NodeBuilder dir=builder.child("oak:index").child("lucene").child(":data");
  List<Blob> blobs=new ArrayList<Blob>();
  Blob b=dir.child("segments_1").getProperty(JCR_DATA).getValue(Type.BINARY,0);
  FailingBlob fb=new FailingBlob(IOUtils.toByteArray(b.getNewStream()));
  blobs.add(fb);
  dir.child("segments_1").setProperty(JCR_DATA,blobs,BINARIES);
  indexed=builder.getNodeState();
  tracker.update(indexed);
  try {
    queryIndex.getPlans(filter,null,indexed);
    fail("Expecting UnsupportedOperationException exception");
  }
 catch (  UnsupportedOperationException ignore) {
  }
}

</code></pre>

<pre class="type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void luceneWithCopyOnReadDirAndReindex() throws Exception {
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  newLucenePropertyIndexDefinition(index,"lucene",ImmutableSet.of("foo","foo2","foo3"),null);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  NodeState indexed=HOOK.processCommit(before,builder.getNodeState(),CommitInfo.EMPTY);
  IndexCopier copier=new IndexCopier(sameThreadExecutor(),new File(getIndexDir()));
  IndexTracker tracker=new IndexTracker(copier);
  tracker.update(indexed);
  assertQuery(tracker,indexed,"foo","bar");
  assertEquals(0,copier.getInvalidFileCount());
  builder=indexed.builder();
  builder.setProperty("foo2","bar2");
  indexed=HOOK.processCommit(indexed,builder.getNodeState(),CommitInfo.EMPTY);
  tracker.update(indexed);
  assertQuery(tracker,indexed,"foo2","bar2");
  assertEquals(0,copier.getInvalidFileCount());
  builder=indexed.builder();
  builder.child(INDEX_DEFINITIONS_NAME).child("lucene").setProperty(REINDEX_PROPERTY_NAME,true);
  indexed=HOOK.processCommit(indexed,builder.getNodeState(),CommitInfo.EMPTY);
  tracker.update(indexed);
  assertQuery(tracker,indexed,"foo2","bar2");
  assertEquals(0,copier.getInvalidFileCount());
  assertEquals(2,copier.getIndexDir("/oak:index/lucene").listFiles().length);
  builder=indexed.builder();
  builder.setProperty("foo3","bar3");
  indexed=HOOK.processCommit(indexed,builder.getNodeState(),CommitInfo.EMPTY);
  tracker.update(indexed);
  assertQuery(tracker,indexed,"foo3","bar3");
  assertEquals(0,copier.getInvalidFileCount());
  assertEquals(1,copier.getIndexDir("/oak:index/lucene").listFiles().length);
}

</code></pre>

<pre class="type-9 type-7 type-6 type-4 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLucene2() throws Exception {
  NodeBuilder index=builder.child(INDEX_DEFINITIONS_NAME);
  newLucenePropertyIndexDefinition(index,"lucene",ImmutableSet.of("foo"),null);
  NodeState before=builder.getNodeState();
  builder.setProperty("foo","bar");
  builder.child("a").setProperty("foo","bar");
  builder.child("a").child("b").setProperty("foo","bar");
  builder.child("a").child("b").child("c").setProperty("foo","bar");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_BASE);
  filter.restrictProperty("foo",Operator.EQUAL,PropertyValues.newString("bar"));
  List<IndexPlan> plans=queryIndex.getPlans(filter,null,indexed);
  Cursor cursor=queryIndex.query(plans.get(0),indexed);
  assertTrue(cursor.hasNext());
  assertEquals("/a/b/c",cursor.next().getPath());
  assertEquals("/a/b",cursor.next().getPath());
  assertEquals("/a",cursor.next().getPath());
  assertEquals("/",cursor.next().getPath());
  assertFalse(cursor.hasNext());
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testRelativePropertyNonExistence() throws Exception {
  root=TestUtil.registerTestNodeType(builder).getNodeState();
  NodeBuilder index=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  NodeBuilder rules=index.child(INDEX_RULES);
  NodeBuilder propNode=rules.child(NT_TEST).child(LuceneIndexConstants.PROP_NODE);
  propNode.child("bar").setProperty(LuceneIndexConstants.PROP_NAME,"jcr:content/bar").setProperty(LuceneIndexConstants.PROP_PROPERTY_INDEX,true).setProperty(LuceneIndexConstants.PROP_NULL_CHECK_ENABLED,true);
  NodeState before=builder.getNodeState();
  NodeBuilder a1=createNodeWithType(builder,"a1",NT_TEST);
  a1.child("jcr:content").setProperty("bar","foo");
  NodeBuilder b1=createNodeWithType(builder,"b1",NT_TEST);
  b1.child("jcr:content");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_TEST);
  filter.restrictProperty("jcr:content/bar",Operator.EQUAL,null);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/b1"));
  builder.child("b1").child("jcr:content").setProperty("bar","foo");
  after=builder.getNodeState();
  indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  tracker.update(indexed);
  filter=createFilter(NT_TEST);
  filter.restrictProperty("jcr:content/bar",Operator.EQUAL,null);
  assertFilter(filter,queryIndex,indexed,Collections.<String>emptyList());
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void customScoreQuery() throws Exception {
  NodeBuilder nb=newLuceneIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",of(TYPENAME_STRING));
  TestUtil.useV2(nb);
  nb.setProperty(LuceneIndexConstants.PROP_SCORER_PROVIDER,"testScorer");
  NodeState before=builder.getNodeState();
  builder.child("a").setProperty("jcr:createdBy","bar bar");
  builder.child("b").setProperty("jcr:createdBy","foo bar");
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  SimpleScorerFactory factory=new SimpleScorerFactory();
  ScorerProvider provider=new ScorerProvider(){
    String scorerName="testScorer";
    @Override public String getName(){
      return scorerName;
    }
    @Override public CustomScoreQuery createCustomScoreQuery(    Query query){
      return new ModifiedCustomScoreQuery(query);
    }
class ModifiedCustomScoreQuery extends CustomScoreQuery {
      private Query query;
      public ModifiedCustomScoreQuery(      Query query){
        super(query);
        this.query=query;
      }
      @Override public CustomScoreProvider getCustomScoreProvider(      AtomicReaderContext context){
        return new CustomScoreProvider(context){
          public float customScore(          int doc,          float subQueryScore,          float valSrcScore){
            AtomicReader atomicReader=context.reader();
            try {
              Document document=atomicReader.document(doc);
              String fieldValue=document.get("full:jcr:createdBy");
              if (fieldValue != null && fieldValue.contains("foo")) {
                valSrcScore*=2.0;
              }
            }
 catch (            IOException e) {
              return subQueryScore * valSrcScore;
            }
            return subQueryScore * valSrcScore;
          }
        }
;
      }
    }
  }
;
  factory.providers.put(provider.getName(),provider);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker,factory);
  FilterImpl filter=createFilter(NT_BASE);
  filter.setFullTextConstraint(new FullTextTerm(null,"bar",false,false,null));
  assertFilter(filter,queryIndex,indexed,asList("/b","/a"),true);
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testPropertyExistence() throws Exception {
  root=TestUtil.registerTestNodeType(builder).getNodeState();
  NodeBuilder index=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  NodeBuilder rules=index.child(INDEX_RULES);
  NodeBuilder propNode=rules.child(NT_TEST).child(LuceneIndexConstants.PROP_NODE);
  NodeBuilder fooProp=propNode.child("foo");
  fooProp.setProperty(LuceneIndexConstants.PROP_PROPERTY_INDEX,true);
  fooProp.setProperty(LuceneIndexConstants.PROP_NOT_NULL_CHECK_ENABLED,true);
  NodeState before=builder.getNodeState();
  createNodeWithType(builder,"a",NT_TEST).setProperty("foo","bar");
  createNodeWithType(builder,"b",NT_TEST).setProperty("foo","bar");
  createNodeWithType(builder,"c",NT_TEST);
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_TEST);
  filter.restrictProperty("foo",Operator.NOT_EQUAL,null);
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/a","/b"));
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void nodeNameIndex() throws Exception {
  NodeBuilder index=newLucenePropertyIndexDefinition(builder.child(INDEX_DEFINITIONS_NAME),"lucene",ImmutableSet.of("foo"),null);
  NodeBuilder rules=index.child(INDEX_RULES);
  NodeBuilder ruleNode=rules.child(NT_FILE);
  ruleNode.setProperty(LuceneIndexConstants.INDEX_NODE_NAME,true);
  NodeState before=builder.getNodeState();
  createNodeWithType(builder,"foo",NT_FILE);
  createNodeWithType(builder,"camelCase",NT_FILE);
  NodeState after=builder.getNodeState();
  NodeState indexed=HOOK.processCommit(before,after,CommitInfo.EMPTY);
  IndexTracker tracker=new IndexTracker();
  tracker.update(indexed);
  AdvancedQueryIndex queryIndex=new LucenePropertyIndex(tracker);
  FilterImpl filter=createFilter(NT_FILE);
  filter.restrictProperty(QueryConstants.RESTRICTION_LOCAL_NAME,Operator.EQUAL,PropertyValues.newString("foo"));
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/foo"));
  filter=createFilter(NT_FILE);
  filter.restrictProperty(QueryConstants.RESTRICTION_LOCAL_NAME,Operator.LIKE,PropertyValues.newString("camelCase"));
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/camelCase"));
  filter=createFilter(NT_FILE);
  filter.restrictProperty(QueryConstants.RESTRICTION_LOCAL_NAME,Operator.LIKE,PropertyValues.newString("camel%"));
  assertFilter(filter,queryIndex,indexed,ImmutableList.of("/camelCase"));
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTokens(){
  Analyzer analyzer=LuceneIndexConstants.ANALYZER;
  assertEquals(ImmutableList.of("parent","child"),LuceneIndex.tokenize("/parent/child",analyzer));
  assertEquals(ImmutableList.of("p1234","p5678"),LuceneIndex.tokenize("/p1234/p5678",analyzer));
  assertEquals(ImmutableList.of("first","second"),LuceneIndex.tokenize("first_second",analyzer));
  assertEquals(ImmutableList.of("first1","second2"),LuceneIndex.tokenize("first1_second2",analyzer));
  assertEquals(ImmutableList.of("first","second"),LuceneIndex.tokenize("first. second",analyzer));
  assertEquals(ImmutableList.of("first","second"),LuceneIndex.tokenize("first.second",analyzer));
  assertEquals(ImmutableList.of("hello","world"),LuceneIndex.tokenize("hello-world",analyzer));
  assertEquals(ImmutableList.of("hello","wor*"),LuceneIndex.tokenize("hello-wor*",analyzer));
  assertEquals(ImmutableList.of("*llo","world"),LuceneIndex.tokenize("*llo-world",analyzer));
  assertEquals(ImmutableList.of("*llo","wor*"),LuceneIndex.tokenize("*llo-wor*",analyzer));
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
