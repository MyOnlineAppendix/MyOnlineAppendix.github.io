<h3 style="margin:0px">Class: org.apache.ambari.server.upgrade.UpgradeCatalog170Test (8 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testGetSourceVersion(){
  final DBAccessor dbAccessor=createNiceMock(DBAccessor.class);
  UpgradeCatalog upgradeCatalog=getUpgradeCatalog(dbAccessor);
  Assert.assertEquals("1.6.1",upgradeCatalog.getSourceVersion());
}

</code></pre>

<pre class="type-13 type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testExecuteDDLUpdates_DBAccessor() throws Exception {
  final DBAccessor dbAccessor=createNiceMock(DBAccessor.class);
  Statement statement=createNiceMock(Statement.class);
  Connection connection=createNiceMock(Connection.class);
  PreparedStatement stmt=createNiceMock(PreparedStatement.class);
  Configuration configuration=createNiceMock(Configuration.class);
  ResultSet resultSet=createNiceMock(ResultSet.class);
  expect(configuration.getDatabaseUrl()).andReturn(Configuration.JDBC_IN_MEMORY_URL).anyTimes();
  expect(dbAccessor.getNewConnection()).andReturn(connection);
  expect(connection.prepareStatement("SELECT config_id FROM clusterconfig " + "WHERE type_name = ? ORDER BY create_timestamp")).andReturn(stmt);
  expect(connection.prepareStatement("UPDATE clusterconfig SET version = ? " + "WHERE config_id = ?")).andReturn(stmt);
  stmt.close();
  expectLastCall().times(2);
  connection.close();
  expectLastCall();
  Capture<DBAccessor.DBColumnInfo> clusterConfigAttributesColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> hostgroupConfigAttributesColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> blueprintConfigAttributesColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> maskColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> systemColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> maskedColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> stageCommandParamsColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> stageHostParamsColumnCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<List<DBAccessor.DBColumnInfo>> groupsCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertDefinitionColumnCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertHistoryColumnCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertCurrentColumnCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertGroupColumnCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertTargetCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertGroupTargetCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertGroupingCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> alertNoticeCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> serviceConfigCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<List<DBAccessor.DBColumnInfo>> serviceConfigMappingCapture=new Capture<List<DBAccessor.DBColumnInfo>>();
  Capture<DBAccessor.DBColumnInfo> configDataClusterConfigCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> configDataBlueprintConfigurationCapture=new Capture<DBAccessor.DBColumnInfo>();
  Capture<DBAccessor.DBColumnInfo> configDataHostGroupConfigurationCapture=new Capture<DBAccessor.DBColumnInfo>();
  dbAccessor.createTable(eq("groups"),capture(groupsCapture),eq("group_id"));
  setViewExpectations(dbAccessor,maskColumnCapture,systemColumnCapture);
  setViewParameterExpectations(dbAccessor,maskedColumnCapture);
  setConfigAttributesColumnExpectations(dbAccessor,clusterConfigAttributesColumnCapture,"clusterconfig");
  setConfigAttributesColumnExpectations(dbAccessor,hostgroupConfigAttributesColumnCapture,"hostgroup_configuration");
  setConfigAttributesColumnExpectations(dbAccessor,blueprintConfigAttributesColumnCapture,"blueprint_configuration");
  setStageExpectations(dbAccessor,stageCommandParamsColumnCapture,stageHostParamsColumnCapture);
  dbAccessor.createTable(eq("alert_definition"),capture(alertDefinitionColumnCapture),eq("definition_id"));
  dbAccessor.createTable(eq("alert_history"),capture(alertHistoryColumnCapture),eq("alert_id"));
  dbAccessor.createTable(eq("alert_current"),capture(alertCurrentColumnCapture),eq("alert_id"));
  dbAccessor.createTable(eq("alert_group"),capture(alertGroupColumnCapture),eq("group_id"));
  dbAccessor.createTable(eq("alert_target"),capture(alertTargetCapture),eq("target_id"));
  dbAccessor.createTable(eq("alert_group_target"),capture(alertGroupTargetCapture),eq("group_id"),eq("target_id"));
  dbAccessor.createTable(eq("alert_grouping"),capture(alertGroupingCapture),eq("group_id"),eq("definition_id"));
  dbAccessor.createTable(eq("alert_notice"),capture(alertNoticeCapture),eq("notification_id"));
  dbAccessor.alterColumn(eq("clusterconfig"),capture(configDataClusterConfigCapture));
  dbAccessor.alterColumn(eq("blueprint_configuration"),capture(configDataBlueprintConfigurationCapture));
  dbAccessor.alterColumn(eq("hostgroup_configuration"),capture(configDataHostGroupConfigurationCapture));
  dbAccessor.createTable(eq("serviceconfig"),capture(serviceConfigCapture),eq("service_config_id"));
  dbAccessor.createTable(eq("serviceconfigmapping"),capture(serviceConfigMappingCapture),eq("service_config_id"),eq("config_id"));
  dbAccessor.getConnection();
  expectLastCall().andReturn(connection).anyTimes();
  connection.createStatement();
  expectLastCall().andReturn(statement).anyTimes();
  statement.executeQuery(anyObject(String.class));
  expectLastCall().andReturn(resultSet).anyTimes();
  resultSet.next();
  expectLastCall().andReturn(false).anyTimes();
  resultSet.close();
  expectLastCall().anyTimes();
  replay(dbAccessor,configuration,resultSet,connection,stmt,statement);
  AbstractUpgradeCatalog upgradeCatalog=getUpgradeCatalog(dbAccessor);
  Class<?> c=AbstractUpgradeCatalog.class;
  Field f=c.getDeclaredField("configuration");
  f.setAccessible(true);
  f.set(upgradeCatalog,configuration);
  upgradeCatalog.executeDDLUpdates();
  verify(dbAccessor,configuration,resultSet,connection,stmt,statement);
  assertClusterConfigColumns(clusterConfigAttributesColumnCapture);
  assertHostgroupConfigColumns(hostgroupConfigAttributesColumnCapture);
  assertBlueprintConfigColumns(blueprintConfigAttributesColumnCapture);
  assertViewColumns(maskColumnCapture,systemColumnCapture);
  assertViewParameterColumns(maskedColumnCapture);
  assertStageColumns(stageCommandParamsColumnCapture,stageHostParamsColumnCapture);
  assertEquals(4,groupsCapture.getValue().size());
  List<DBAccessor.DBColumnInfo> columnInfoList=groupsCapture.getValue();
  for (  DBAccessor.DBColumnInfo info : columnInfoList) {
    if (info.getName().equals("group_name")) {
      assertEquals(Integer.valueOf(255),info.getLength());
      break;
    }
  }
  assertEquals(12,alertDefinitionColumnCapture.getValue().size());
  assertEquals(11,alertHistoryColumnCapture.getValue().size());
  assertEquals(7,alertCurrentColumnCapture.getValue().size());
  assertEquals(5,alertGroupColumnCapture.getValue().size());
  assertEquals(5,alertTargetCapture.getValue().size());
  assertEquals(2,alertGroupTargetCapture.getValue().size());
  assertEquals(2,alertGroupingCapture.getValue().size());
  assertEquals(5,alertNoticeCapture.getValue().size());
  assertEquals(2,serviceConfigCapture.getValue().size());
  assertEquals(2,serviceConfigMappingCapture.getValue().size());
}

</code></pre>

<pre class="type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void updateClusterProvisionState() throws AmbariException {
  StackDAO stackDAO=injector.getInstance(StackDAO.class);
  injector.getInstance(AmbariMetaInfo.class);
  StackEntity desiredStackEntity=stackDAO.find(DESIRED_STACK.getStackName(),DESIRED_STACK.getStackVersion());
  assertNotNull(desiredStackEntity);
  ClusterEntity clusterEntity=upgradeCatalogHelper.createCluster(injector,CLUSTER_NAME,desiredStackEntity);
  UpgradeCatalog170 upgradeCatalog170=injector.getInstance(UpgradeCatalog170.class);
  upgradeCatalog170.updateClusterProvisionState();
  ClusterDAO clusterDAO=injector.getInstance(ClusterDAO.class);
  String assertMsg="updated provisioning state should be installed";
  String expectedState="INSTALLED";
  String actualState=clusterDAO.findById(1L).getProvisioningState().name();
  assertEquals(assertMsg,expectedState,actualState);
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void init(){
  reset(entityManagerProvider);
  expect(entityManagerProvider.get()).andReturn(entityManager).anyTimes();
  replay(entityManagerProvider);
  injector=Guice.createInjector(new InMemoryDefaultTestModule());
  injector.getInstance(GuiceJpaInitializer.class);
  upgradeCatalogHelper=injector.getInstance(UpgradeCatalogHelper.class);
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown(){
  injector.getInstance(PersistService.class).stop();
}

</code></pre>

<pre class="type-2 type-11 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
"></span><br>
@Test public void testMoveHcatalogIntoHiveService() throws AmbariException {
  UpgradeCatalog170 upgradeCatalog170=injector.getInstance(UpgradeCatalog170.class);
  ServiceComponentDesiredStateDAO serviceComponentDesiredStateDAO=injector.getInstance(ServiceComponentDesiredStateDAO.class);
  HostComponentDesiredStateDAO hostComponentDesiredStateDAO=injector.getInstance(HostComponentDesiredStateDAO.class);
  HostComponentStateDAO hostComponentStateDAO=injector.getInstance(HostComponentStateDAO.class);
  StackDAO stackDAO=injector.getInstance(StackDAO.class);
  injector.getInstance(AmbariMetaInfo.class);
  StackEntity desiredStackEntity=stackDAO.find(DESIRED_STACK.getStackName(),DESIRED_STACK.getStackVersion());
  assertNotNull(desiredStackEntity);
  final ClusterEntity clusterEntity=upgradeCatalogHelper.createCluster(injector,CLUSTER_NAME,desiredStackEntity);
  final ClusterServiceEntity clusterServiceEntityHDFS=upgradeCatalogHelper.addService(injector,clusterEntity,"HDFS",desiredStackEntity);
  final ClusterServiceEntity clusterServiceEntityHIVE=upgradeCatalogHelper.addService(injector,clusterEntity,"HIVE",desiredStackEntity);
  final ClusterServiceEntity clusterServiceEntityHCATALOG=upgradeCatalogHelper.addService(injector,clusterEntity,"HCATALOG",desiredStackEntity);
  final ClusterServiceEntity clusterServiceEntityWEBHCAT=upgradeCatalogHelper.addService(injector,clusterEntity,"WEBHCAT",desiredStackEntity);
  final HostEntity hostEntity=upgradeCatalogHelper.createHost(injector,clusterEntity,HOST_NAME);
  upgradeCatalogHelper.addComponent(injector,clusterEntity,clusterServiceEntityHDFS,hostEntity,"NAMENODE",desiredStackEntity);
  upgradeCatalogHelper.addComponent(injector,clusterEntity,clusterServiceEntityHIVE,hostEntity,"HIVE_SERVER",desiredStackEntity);
  upgradeCatalogHelper.addComponent(injector,clusterEntity,clusterServiceEntityHCATALOG,hostEntity,"HCAT",desiredStackEntity);
  upgradeCatalogHelper.addComponent(injector,clusterEntity,clusterServiceEntityWEBHCAT,hostEntity,"WEBHCAT_SERVER",desiredStackEntity);
  upgradeCatalog170.moveHcatalogIntoHiveService();
  ServiceComponentDesiredStateEntityPK pkHCATInHive=new ServiceComponentDesiredStateEntityPK();
  pkHCATInHive.setComponentName("HCAT");
  pkHCATInHive.setClusterId(clusterEntity.getClusterId());
  pkHCATInHive.setServiceName("HIVE");
  ServiceComponentDesiredStateEntity serviceComponentDesiredStateEntity=serviceComponentDesiredStateDAO.findByPK(pkHCATInHive);
  assertNotNull(serviceComponentDesiredStateEntity);
  HostComponentDesiredStateEntityPK hcDesiredStateEntityPk=new HostComponentDesiredStateEntityPK();
  hcDesiredStateEntityPk.setServiceName("HIVE");
  hcDesiredStateEntityPk.setClusterId(clusterEntity.getClusterId());
  hcDesiredStateEntityPk.setComponentName("HCAT");
  hcDesiredStateEntityPk.setHostId(hostEntity.getHostId());
  HostComponentDesiredStateEntity hcDesiredStateEntity=hostComponentDesiredStateDAO.findByPK(hcDesiredStateEntityPk);
  assertNotNull(hcDesiredStateEntity);
}

</code></pre>

<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testExecuteDMLUpdates() throws Exception {
  Configuration configuration=createNiceMock(Configuration.class);
  Connection connection=createNiceMock(Connection.class);
  Statement statement=createNiceMock(Statement.class);
  DBAccessor dbAccessor=createNiceMock(DBAccessor.class);
  Injector injector=createNiceMock(Injector.class);
  ConfigHelper configHelper=createNiceMock(ConfigHelper.class);
  AmbariManagementController amc=createNiceMock(AmbariManagementController.class);
  Cluster cluster=createNiceMock(Cluster.class);
  Clusters clusters=createStrictMock(Clusters.class);
  Config config=createStrictMock(Config.class);
  Config pigConfig=createStrictMock(Config.class);
  ViewRegistry viewRegistry=createNiceMock(ViewRegistry.class);
  PermissionEntity adminPermission=createNiceMock(PermissionEntity.class);
  PermissionEntity viewUsePermission=createNiceMock(PermissionEntity.class);
  ClusterConfigEntity clusterConfigEntity=createNiceMock(ClusterConfigEntity.class);
  ConfigGroupConfigMappingDAO configGroupConfigMappingDAO=createNiceMock(ConfigGroupConfigMappingDAO.class);
  UserDAO userDAO=createNiceMock(UserDAO.class);
  PrincipalDAO principalDAO=createNiceMock(PrincipalDAO.class);
  PrincipalTypeDAO principalTypeDAO=createNiceMock(PrincipalTypeDAO.class);
  ClusterDAO clusterDAO=createNiceMock(ClusterDAO.class);
  ResourceTypeDAO resourceTypeDAO=createNiceMock(ResourceTypeDAO.class);
  ResourceDAO resourceDAO=createNiceMock(ResourceDAO.class);
  ViewDAO viewDAO=createNiceMock(ViewDAO.class);
  ViewInstanceDAO viewInstanceDAO=createNiceMock(ViewInstanceDAO.class);
  PermissionDAO permissionDAO=createNiceMock(PermissionDAO.class);
  PrivilegeDAO privilegeDAO=createNiceMock(PrivilegeDAO.class);
  KeyValueDAO keyValueDAO=createNiceMock(KeyValueDAO.class);
  EntityTransaction trans=createNiceMock(EntityTransaction.class);
  CriteriaBuilder cb=createNiceMock(CriteriaBuilder.class);
  CriteriaQuery<HostRoleCommandEntity> cq=createNiceMock(CriteriaQuery.class);
  Root<HostRoleCommandEntity> hrc=createNiceMock(Root.class);
  Path<Long> taskId=null;
  Path<String> outputLog=null;
  Path<String> errorLog=null;
  Order o=createNiceMock(Order.class);
  TypedQuery<HostRoleCommandEntity> q=createNiceMock(TypedQuery.class);
  List<HostRoleCommandEntity> r=new ArrayList<HostRoleCommandEntity>();
  ResultSet userRolesResultSet=createNiceMock(ResultSet.class);
  ClusterEntity clusterEntity=createNiceMock(ClusterEntity.class);
  ClusterConfigEntity configEntity=createNiceMock(ClusterConfigEntity.class);
  Method m=AbstractUpgradeCatalog.class.getDeclaredMethod("updateConfigurationProperties",String.class,Map.class,boolean.class,boolean.class);
  Method n=AbstractUpgradeCatalog.class.getDeclaredMethod("getEntityManagerProvider");
  Method l=AbstractUpgradeCatalog.class.getDeclaredMethod("addNewConfigurationsFromXml");
  Method newPropMap=UpgradeCatalog170.class.getDeclaredMethod("getNewPropertyName");
  UpgradeCatalog170 upgradeCatalog=createMockBuilder(UpgradeCatalog170.class).addMockedMethod(m).addMockedMethod(n).addMockedMethod(l).addMockedMethod(newPropMap).createMock();
  List<ConfigGroupConfigMappingEntity> configGroupConfigMappingEntities=new ArrayList<ConfigGroupConfigMappingEntity>();
  ConfigGroupConfigMappingEntity configGroupConfigMappingEntity=new ConfigGroupConfigMappingEntity();
  configGroupConfigMappingEntity.setConfigType(Configuration.GLOBAL_CONFIG_TAG);
  configGroupConfigMappingEntity.setClusterConfigEntity(clusterConfigEntity);
  configGroupConfigMappingEntity.setClusterId(1L);
  configGroupConfigMappingEntities.add(configGroupConfigMappingEntity);
  Map<String,Cluster> clustersMap=new HashMap<String,Cluster>();
  clustersMap.put("c1",cluster);
  Map<String,String> globalConfigs=new HashMap<String,String>();
  globalConfigs.put("prop1","val1");
  globalConfigs.put("smokeuser_keytab","val2");
  Map<String,String> pigSettings=new HashMap<String,String>();
  pigSettings.put("pig-content","foo");
  Set<String> envDicts=new HashSet<String>();
  envDicts.add("hadoop-env");
  envDicts.add("global");
  Set<String> configTypes=new HashSet<String>();
  configTypes.add("hadoop-env");
  Map<String,String> contentOfHadoopEnv=new HashMap<String,String>();
  contentOfHadoopEnv.put("content","env file contents");
  upgradeCatalog.updateConfigurationProperties("hadoop-env",globalConfigs,false,true);
  expectLastCall();
  upgradeCatalog.addNewConfigurationsFromXml();
  expectLastCall();
  dbAccessor.getConnection();
  expectLastCall().andReturn(connection).anyTimes();
  connection.createStatement();
  expectLastCall().andReturn(statement).anyTimes();
  statement.executeQuery("SELECT role_name, user_id FROM user_roles");
  expectLastCall().andReturn(userRolesResultSet).once();
  expect(entityManager.getTransaction()).andReturn(trans).anyTimes();
  expect(entityManager.getCriteriaBuilder()).andReturn(cb).anyTimes();
  expect(entityManager.createQuery(cq)).andReturn(q).anyTimes();
  expect(trans.isActive()).andReturn(true).anyTimes();
  expect(upgradeCatalog.getEntityManagerProvider()).andReturn(entityManagerProvider).anyTimes();
  expect(upgradeCatalog.getNewPropertyName()).andReturn(new HashMap<String,String>()).anyTimes();
  expect(cb.createQuery(HostRoleCommandEntity.class)).andReturn(cq).anyTimes();
  expect(cb.desc(taskId)).andReturn(o).anyTimes();
  expect(cq.from(HostRoleCommandEntity.class)).andReturn(hrc).anyTimes();
  expect(cq.select(hrc)).andReturn(cq).anyTimes();
  expect(cq.where(anyObject(Predicate.class))).andReturn(cq).anyTimes();
  expect(hrc.get(isA(SingularAttribute.class))).andReturn(taskId).times(2);
  expect(hrc.get(isA(SingularAttribute.class))).andReturn(outputLog).once();
  expect(hrc.get(isA(SingularAttribute.class))).andReturn(errorLog).once();
  expect(q.setMaxResults(1000)).andReturn(q).anyTimes();
  expect(q.getResultList()).andReturn(r).anyTimes();
  expect(clusterConfigEntity.getData()).andReturn("{\"dtnode_heapsize\":\"1028m\"}");
  expect(configuration.getDatabaseUrl()).andReturn(Configuration.JDBC_IN_MEMORY_URL).anyTimes();
  expect(injector.getInstance(ConfigHelper.class)).andReturn(configHelper).anyTimes();
  expect(injector.getInstance(AmbariManagementController.class)).andReturn(amc).anyTimes();
  expect(amc.getClusters()).andReturn(clusters).anyTimes();
  expect(clusters.getClusters()).andReturn(clustersMap).anyTimes();
  expect(clusters.getClusterById(1L)).andReturn(clustersMap.values().iterator().next()).anyTimes();
  expect(clusters.getClusters()).andReturn(clustersMap).times(1);
  expect(cluster.getDesiredConfigByType("global")).andReturn(config).anyTimes();
  expect(cluster.getDesiredConfigByType("oozie-log4j")).andReturn(config).anyTimes();
  expect(cluster.getDesiredConfigByType("oozie-env")).andReturn(config).anyTimes();
  expect(cluster.getClusterId()).andReturn(1L);
  expect(cluster.getNextConfigVersion("hadoop-env")).andReturn(3L);
  expect(config.getProperties()).andReturn(globalConfigs).anyTimes();
  expect(cluster.getCurrentStackVersion()).andReturn(new StackId("HDP","2.1")).anyTimes();
  expect(cluster.getClusterName()).andReturn("c1").anyTimes();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"prop1","c1")).andReturn(envDicts).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"smokeuser_keytab","c1")).andReturn(new HashSet<String>()).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"content","c1")).andReturn(envDicts).once();
  expect(configHelper.findConfigTypesByPropertyName(new StackId("HDP","2.1"),"dtnode_heapsize","c1")).andReturn(configTypes).once();
  expect(injector.getInstance(ConfigGroupConfigMappingDAO.class)).andReturn(configGroupConfigMappingDAO).anyTimes();
  expect(injector.getInstance(UserDAO.class)).andReturn(userDAO).anyTimes();
  expect(injector.getInstance(PrincipalDAO.class)).andReturn(principalDAO).anyTimes();
  expect(injector.getInstance(PrincipalTypeDAO.class)).andReturn(principalTypeDAO).anyTimes();
  expect(injector.getInstance(ClusterDAO.class)).andReturn(clusterDAO).anyTimes();
  expect(injector.getInstance(ResourceTypeDAO.class)).andReturn(resourceTypeDAO).anyTimes();
  expect(injector.getInstance(ResourceDAO.class)).andReturn(resourceDAO).anyTimes();
  expect(injector.getInstance(ViewDAO.class)).andReturn(viewDAO).anyTimes();
  expect(injector.getInstance(ViewInstanceDAO.class)).andReturn(viewInstanceDAO).anyTimes();
  expect(injector.getInstance(PermissionDAO.class)).andReturn(permissionDAO).anyTimes();
  expect(injector.getInstance(PrivilegeDAO.class)).andReturn(privilegeDAO).anyTimes();
  expect(injector.getInstance(KeyValueDAO.class)).andReturn(keyValueDAO).anyTimes();
  expect(injector.getInstance(ViewRegistry.class)).andReturn(viewRegistry).anyTimes();
  expect(userRolesResultSet.next()).andReturn(true).times(3);
  expect(userRolesResultSet.next()).andReturn(false).times(1);
  expect(userRolesResultSet.getString(1)).andReturn("admin").times(1);
  expect(userRolesResultSet.getString(1)).andReturn("user").times(2);
  expect(userRolesResultSet.getInt(2)).andReturn(1).times(2);
  expect(userRolesResultSet.getInt(2)).andReturn(2).times(1);
  UserEntity userEntity1=createNiceMock(UserEntity.class);
  UserEntity userEntity2=createNiceMock(UserEntity.class);
  PrincipalEntity userPrincipal1=createNiceMock(PrincipalEntity.class);
  PrincipalEntity userPrincipal2=createNiceMock(PrincipalEntity.class);
  Set<PrivilegeEntity> userPrivileges1=createNiceMock(Set.class);
  Set<PrivilegeEntity> userPrivileges2=createNiceMock(Set.class);
  expect(userEntity1.getPrincipal()).andReturn(userPrincipal1).anyTimes();
  expect(userEntity2.getPrincipal()).andReturn(userPrincipal2).anyTimes();
  expect(userPrincipal1.getPrivileges()).andReturn(userPrivileges1).anyTimes();
  expect(userPrincipal2.getPrivileges()).andReturn(userPrivileges2).anyTimes();
  expect(userPrivileges1.add(anyObject(PrivilegeEntity.class))).andReturn(true).once();
  expect(userDAO.findByPK(1)).andReturn(userEntity1).times(2);
  expect(userDAO.findByPK(2)).andReturn(userEntity2).once();
  expect(userDAO.merge(userEntity1)).andReturn(userEntity1).once();
  expect(userDAO.merge(userEntity2)).andReturn(userEntity2).once();
  expect(configGroupConfigMappingDAO.findAll()).andReturn(configGroupConfigMappingEntities).once();
  expect(userDAO.findAll()).andReturn(Collections.<UserEntity>emptyList()).times(1);
  expect(userDAO.findAll()).andReturn(Arrays.asList(userEntity1,userEntity2)).times(1);
  expect(clusterDAO.findAll()).andReturn(Collections.<ClusterEntity>emptyList()).times(2);
  String yarnConfig=String.format("{'%s':'%s', '%s':'%s'}",YARN_TIMELINE_SERVICE_WEBAPP_ADDRESS_PROPERTY,"timeline:8081",YARN_RESOURCEMANAGER_WEBAPP_ADDRESS_PROPERTY,"resource_man:8081");
  expect(configGroupConfigMappingDAO.findAll()).andReturn(configGroupConfigMappingEntities).once();
  expect(clusterDAO.findAll()).andReturn(Collections.singletonList(clusterEntity)).anyTimes();
  expect(configEntity.getData()).andReturn(yarnConfig);
  expect(clusterDAO.findConfig(1L,YARN_SITE,"version1")).andReturn(configEntity).anyTimes();
  expect(viewDAO.findAll()).andReturn(Collections.<ViewEntity>emptyList()).anyTimes();
  expect(viewInstanceDAO.findAll()).andReturn(Collections.<ViewInstanceEntity>emptyList()).anyTimes();
  expect(permissionDAO.findAmbariAdminPermission()).andReturn(adminPermission).anyTimes();
  expect(permissionDAO.findViewUsePermission()).andReturn(viewUsePermission).anyTimes();
  expect(permissionDAO.findClusterOperatePermission()).andReturn(null);
  expect(permissionDAO.findClusterReadPermission()).andReturn(null);
  expect(cluster.getDesiredConfigByType("pig-properties")).andReturn(pigConfig).anyTimes();
  expect(pigConfig.getProperties()).andReturn(pigSettings).anyTimes();
  ViewEntity jobsView=createNiceMock(ViewEntity.class);
  KeyValueEntity showJobsKeyValue=createNiceMock(KeyValueEntity.class);
  UserEntity user=createNiceMock(UserEntity.class);
  ClusterConfigMappingEntity configMappingEntity=createNiceMock(ClusterConfigMappingEntity.class);
  ClusterStateEntity clusterStateEntity=createNiceMock(ClusterStateEntity.class);
  StackEntity stackEntity=createNiceMock(StackEntity.class);
  expect(stackEntity.getStackName()).andReturn(CLUSTER_STATE_STACK_HDP_2_1.getStackName());
  expect(stackEntity.getStackVersion()).andReturn(CLUSTER_STATE_STACK_HDP_2_1.getStackVersion());
  expect(clusterEntity.getClusterId()).andReturn(1L).anyTimes();
  expect(clusterEntity.getConfigMappingEntities()).andReturn(Collections.singleton(configMappingEntity)).times(2);
  expect(clusterEntity.getClusterStateEntity()).andReturn(clusterStateEntity).anyTimes();
  expect(clusterStateEntity.getCurrentStack()).andReturn(stackEntity);
  expect(configMappingEntity.getType()).andReturn(YARN_SITE).anyTimes();
  expect(configMappingEntity.isSelected()).andReturn(1).anyTimes();
  expect(configMappingEntity.getTag()).andReturn("version1");
  expect(userDAO.findAll()).andReturn(Collections.singletonList(user));
  expect(jobsView.getCommonName()).andReturn(JOBS_VIEW_NAME);
  expect(jobsView.getVersion()).andReturn("1.0.0");
  expect(viewDAO.findByCommonName(JOBS_VIEW_NAME)).andReturn(jobsView).once();
  expect(showJobsKeyValue.getValue()).andReturn("true");
  expect(keyValueDAO.findByKey(SHOW_JOBS_FOR_NON_ADMIN_KEY)).andReturn(showJobsKeyValue);
  expect(privilegeDAO.findAllByPrincipal(anyObject(List.class))).andReturn(Collections.<PrivilegeEntity>emptyList());
  expect(viewDAO.merge(jobsView)).andReturn(jobsView);
  resourceDAO.create(anyObject(ResourceEntity.class));
  expect(adminPermission.getId()).andReturn(3);
  expect(viewUsePermission.getId()).andReturn(4);
  viewInstanceDAO.create(anyObject(ViewInstanceEntity.class));
  expectLastCall().andAnswer(new IAnswer(){
    @Override public Object answer() throws Throwable {
      ((ViewInstanceEntity)getCurrentArguments()[0]).getResource().setId(1L);
      return null;
    }
  }
);
  keyValueDAO.remove(showJobsKeyValue);
  privilegeDAO.create(anyObject(PrivilegeEntity.class));
  replay(entityManager,trans,upgradeCatalog,cb,cq,hrc,q,connection,statement,userRolesResultSet);
  replay(dbAccessor,configuration,injector,cluster,clusters,amc,config,configHelper,pigConfig);
  replay(userDAO,clusterDAO,viewDAO,viewInstanceDAO,permissionDAO,configGroupConfigMappingDAO);
  replay(resourceTypeDAO,resourceDAO,keyValueDAO,privilegeDAO,clusterConfigEntity);
  replay(jobsView,showJobsKeyValue,user);
  replay(userEntity1,userEntity2,userPrincipal1,userPrincipal2,userPrivileges1,userPrivileges2);
  replay(viewRegistry,viewUsePermission,adminPermission);
  replay(clusterEntity,configEntity,configMappingEntity,clusterStateEntity,stackEntity);
  Class<?> c=AbstractUpgradeCatalog.class;
  Field f=c.getDeclaredField("configuration");
  f.setAccessible(true);
  f.set(upgradeCatalog,configuration);
  f=c.getDeclaredField("dbAccessor");
  f.setAccessible(true);
  f.set(upgradeCatalog,dbAccessor);
  f=c.getDeclaredField("injector");
  f.setAccessible(true);
  f.set(upgradeCatalog,injector);
  upgradeCatalog.executeDMLUpdates();
  verify(upgradeCatalog,dbAccessor,configuration,injector,cluster,clusters,amc,config,configHelper,jobsView,showJobsKeyValue,privilegeDAO,viewDAO,viewInstanceDAO,resourceDAO,keyValueDAO,connection,statement,userRolesResultSet,userEntity1,userEntity2,userPrincipal1,userPrincipal2,userPrivileges1,userPrivileges2,viewRegistry,clusterEntity,configEntity,configMappingEntity,clusterStateEntity);
}

</code></pre>

<pre class="type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testGetTargetVersion() throws Exception {
  final DBAccessor dbAccessor=createNiceMock(DBAccessor.class);
  UpgradeCatalog upgradeCatalog=getUpgradeCatalog(dbAccessor);
  Assert.assertEquals("1.7.0",upgradeCatalog.getTargetVersion());
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
