<h3 style="margin:0px">Class: org.apache.ambari.server.scheduler.ExecutionScheduleManagerTest (11 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="18"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('18')" data-toggle="tooltip" title="Verifies logic rules using matcher-style statements"><kbd id="tag-18"class="label-info"style="display: inline-block;font-size:7pt" >ConditionMatcher&nbsp;(3)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(3)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testUpdateBatchRequest() throws Exception {
  Clusters clustersMock=createMock(Clusters.class);
  Cluster clusterMock=createMock(Cluster.class);
  RequestExecution requestExecutionMock=createMock(RequestExecution.class);
  Configuration configurationMock=createNiceMock(Configuration.class);
  ExecutionScheduler executionSchedulerMock=createMock(ExecutionScheduler.class);
  InternalTokenStorage tokenStorageMock=createMock(InternalTokenStorage.class);
  ActionDBAccessor actionDBAccessorMock=createMock(ActionDBAccessor.class);
  Gson gson=new Gson();
  BatchRequest batchRequestMock=createMock(BatchRequest.class);
  long executionId=11L;
  long batchId=1L;
  long requestId=5L;
  String clusterName="mycluster";
  Map<Long,RequestExecution> executionMap=new HashMap<Long,RequestExecution>();
  executionMap.put(executionId,requestExecutionMock);
  BatchRequestResponse batchRequestResponse=new BatchRequestResponse();
  batchRequestResponse.setStatus(HostRoleStatus.IN_PROGRESS.toString());
  batchRequestResponse.setRequestId(requestId);
  batchRequestResponse.setReturnCode(202);
  EasyMock.expect(configurationMock.getApiSSLAuthentication()).andReturn(Boolean.FALSE);
  EasyMock.replay(configurationMock);
  ExecutionScheduleManager scheduleManager=createMockBuilder(ExecutionScheduleManager.class).withConstructor(configurationMock,executionSchedulerMock,tokenStorageMock,clustersMock,actionDBAccessorMock,gson).addMockedMethods("performApiRequest").createNiceMock();
  expect(clustersMock.getCluster(clusterName)).andReturn(clusterMock).anyTimes();
  expect(clusterMock.getAllRequestExecutions()).andReturn(executionMap).anyTimes();
  requestExecutionMock.updateBatchRequest(eq(batchId),eq(batchRequestResponse),eq(true));
  expectLastCall().once();
  replay(clusterMock,clustersMock,requestExecutionMock,executionSchedulerMock,tokenStorageMock,batchRequestMock,scheduleManager);
  scheduleManager.updateBatchRequest(executionId,batchId,clusterName,batchRequestResponse,true);
  verify(clusterMock,clustersMock,configurationMock,requestExecutionMock,executionSchedulerMock,tokenStorageMock,batchRequestMock,scheduleManager);
}

</code></pre>

<pre class="type-4 type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testScheduleBatch() throws Exception {
  RequestExecution requestExecution=createRequestExecution(true);
  Assert.assertNotNull(requestExecution);
  executionScheduleManager.scheduleBatch(requestExecution);
  String jobName1=executionScheduleManager.getJobName(requestExecution.getId(),10L);
  String jobName2=executionScheduleManager.getJobName(requestExecution.getId(),12L);
  JobDetail jobDetail1=null;
  JobDetail jobDetail2=null;
  Trigger trigger1=null;
  Trigger trigger2=null;
  for (  String group : scheduler.getJobGroupNames()) {
    for (    JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(ExecutionJob.LINEAR_EXECUTION_JOB_GROUP))) {
      LOG.info("Found job identified by: " + jobKey);
      String jobName=jobKey.getName();
      String jobGroup=jobKey.getGroup();
      List<Trigger> triggers=(List<Trigger>)scheduler.getTriggersOfJob(jobKey);
      Trigger trigger=triggers != null && !triggers.isEmpty() ? triggers.get(0) : null;
      Date nextFireTime=trigger != null ? trigger.getNextFireTime() : null;
      LOG.info("[jobName] : " + jobName + " [groupName] : "+ jobGroup+ " - "+ nextFireTime);
      if (jobName.equals(jobName1)) {
        jobDetail1=scheduler.getJobDetail(jobKey);
        trigger1=trigger;
      }
 else       if (jobName.equals(jobName2)) {
        jobDetail2=scheduler.getJobDetail(jobKey);
        trigger2=trigger;
      }
    }
  }
  Assert.assertNotNull(jobDetail1);
  Assert.assertNotNull(trigger1);
  Assert.assertNotNull(jobDetail2);
  Assert.assertNull(trigger2);
  CronTrigger cronTrigger=(CronTrigger)trigger1;
  Schedule schedule=new Schedule();
  schedule.setMinutes("10");
  schedule.setHours("2");
  schedule.setMonth("*");
  schedule.setDaysOfMonth("*");
  schedule.setDayOfWeek("?");
  Assert.assertEquals(schedule.getScheduleExpression(),cronTrigger.getCronExpression());
  Assert.assertEquals(jobName1,jobDetail1.getKey().getName());
  Assert.assertEquals(jobName2,jobDetail2.getKey().getName());
}

</code></pre>

<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@SuppressWarnings("unchecked") @Test public void testFinalizeBatch() throws Exception {
  Clusters clustersMock=createMock(Clusters.class);
  Cluster clusterMock=createMock(Cluster.class);
  Configuration configurationMock=createNiceMock(Configuration.class);
  ExecutionScheduler executionSchedulerMock=createMock(ExecutionScheduler.class);
  InternalTokenStorage tokenStorageMock=createMock(InternalTokenStorage.class);
  ActionDBAccessor actionDBAccessorMock=createMock(ActionDBAccessor.class);
  Gson gson=new Gson();
  RequestExecution requestExecutionMock=createMock(RequestExecution.class);
  Batch batchMock=createMock(Batch.class);
  JobDetail jobDetailMock=createMock(JobDetail.class);
  final BatchRequest batchRequestMock=createMock(BatchRequest.class);
  final Trigger triggerMock=createNiceMock(Trigger.class);
  final List<Trigger> triggers=new ArrayList<Trigger>(){
{
      add(triggerMock);
    }
  }
;
  long executionId=11L;
  String clusterName="c1";
  Date pastDate=new Date(new Date().getTime() - 2);
  Map<Long,RequestExecution> executionMap=new HashMap<Long,RequestExecution>();
  executionMap.put(executionId,requestExecutionMock);
  EasyMock.expect(configurationMock.getApiSSLAuthentication()).andReturn(Boolean.FALSE);
  EasyMock.replay(configurationMock);
  ExecutionScheduleManager scheduleManager=createMockBuilder(ExecutionScheduleManager.class).withConstructor(configurationMock,executionSchedulerMock,tokenStorageMock,clustersMock,actionDBAccessorMock,gson).createMock();
  expect(clustersMock.getCluster(clusterName)).andReturn(clusterMock).anyTimes();
  expect(clusterMock.getAllRequestExecutions()).andReturn(executionMap).anyTimes();
  expect(requestExecutionMock.getBatch()).andReturn(batchMock).anyTimes();
  expect(batchMock.getBatchRequests()).andReturn(new ArrayList<BatchRequest>(){
{
      add(batchRequestMock);
    }
  }
);
  expect(batchRequestMock.getOrderId()).andReturn(1L).anyTimes();
  expect(executionSchedulerMock.getJobDetail((JobKey)anyObject())).andReturn(jobDetailMock).anyTimes();
  expect((List<Trigger>)executionSchedulerMock.getTriggersForJob((JobKey)anyObject())).andReturn(triggers).anyTimes();
  expect(triggerMock.mayFireAgain()).andReturn(true).anyTimes();
  expect(triggerMock.getFinalFireTime()).andReturn(pastDate).anyTimes();
  requestExecutionMock.updateStatus(RequestExecution.Status.COMPLETED);
  expectLastCall();
  replay(clustersMock,clusterMock,requestExecutionMock,executionSchedulerMock,scheduleManager,batchMock,batchRequestMock,triggerMock,jobDetailMock,actionDBAccessorMock);
  scheduleManager.finalizeBatch(executionId,clusterName);
  verify(clustersMock,clusterMock,configurationMock,requestExecutionMock,executionSchedulerMock,scheduleManager,batchMock,batchRequestMock,triggerMock,jobDetailMock,actionDBAccessorMock);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testGetBatchRequestResponse() throws Exception {
  Clusters clustersMock=createMock(Clusters.class);
  Cluster clusterMock=createMock(Cluster.class);
  Configuration configurationMock=createNiceMock(Configuration.class);
  ExecutionScheduler executionSchedulerMock=createMock(ExecutionScheduler.class);
  InternalTokenStorage tokenStorageMock=createMock(InternalTokenStorage.class);
  ActionDBAccessor actionDBAccessorMock=createMock(ActionDBAccessor.class);
  Gson gson=new Gson();
  long requestId=5L;
  String clusterName="mycluster";
  String apiUri="api/v1/clusters/mycluster/requests/5";
  Capture<String> uriCapture=new Capture<String>();
  BatchRequestResponse batchRequestResponse=new BatchRequestResponse();
  batchRequestResponse.setStatus(HostRoleStatus.IN_PROGRESS.toString());
  batchRequestResponse.setRequestId(requestId);
  batchRequestResponse.setReturnCode(202);
  EasyMock.expect(configurationMock.getApiSSLAuthentication()).andReturn(Boolean.FALSE);
  EasyMock.replay(configurationMock);
  ExecutionScheduleManager scheduleManager=createMockBuilder(ExecutionScheduleManager.class).withConstructor(configurationMock,executionSchedulerMock,tokenStorageMock,clustersMock,actionDBAccessorMock,gson).addMockedMethods("performApiGetRequest").createNiceMock();
  expect(scheduleManager.performApiGetRequest(capture(uriCapture),eq(true))).andReturn(batchRequestResponse).once();
  replay(clusterMock,clustersMock,executionSchedulerMock,tokenStorageMock,scheduleManager);
  scheduleManager.getBatchRequestResponse(requestId,clusterName);
  verify(clusterMock,clustersMock,configurationMock,executionSchedulerMock,tokenStorageMock,scheduleManager);
  assertEquals(apiUri,uriCapture.getValue());
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void teardown() throws Exception {
  executionScheduleManager.stop();
  injector.getInstance(PersistService.class).stop();
}

</code></pre>

<pre class="type-4 type-7 type-2 type-11 type-18 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies logic rules using matcher-style statements">ConditionMatcher</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Allocates resources before the execution of the test cases
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies logic rules using matcher-style statements
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Before public void setup() throws Exception {
  InMemoryDefaultTestModule defaultTestModule=new InMemoryDefaultTestModule();
  properties=defaultTestModule.getProperties();
  injector=Guice.createInjector(Modules.override(defaultTestModule).with(new ExecutionSchedulerTestModule()));
  injector.getInstance(GuiceJpaInitializer.class);
  clusters=injector.getInstance(Clusters.class);
  metaInfo=injector.getInstance(AmbariMetaInfo.class);
  executionScheduleManager=injector.getInstance(ExecutionScheduleManager.class);
  executionScheduler=injector.getInstance(ExecutionScheduler.class);
  requestExecutionFactory=injector.getInstance(RequestExecutionFactory.class);
  clusterName="c1";
  clusters.addCluster(clusterName,new StackId("HDP-0.1"));
  cluster=clusters.getCluster(clusterName);
  Assert.assertNotNull(cluster);
  assertThat(executionScheduler,instanceOf(TestExecutionScheduler.class));
  TestExecutionScheduler testExecutionScheduler=(TestExecutionScheduler)executionScheduler;
  scheduler=testExecutionScheduler.getScheduler();
  Assert.assertNotNull(scheduler);
  executionScheduleManager.start();
}

</code></pre>

<pre class="type-2 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
@Test public void testHasToleranceThresholdExceeded() throws Exception {
  Clusters clustersMock=createMock(Clusters.class);
  Cluster clusterMock=createMock(Cluster.class);
  Configuration configurationMock=createNiceMock(Configuration.class);
  ExecutionScheduler executionSchedulerMock=createMock(ExecutionScheduler.class);
  InternalTokenStorage tokenStorageMock=createMock(InternalTokenStorage.class);
  ActionDBAccessor actionDBAccessorMock=createMock(ActionDBAccessor.class);
  Gson gson=new Gson();
  RequestExecution requestExecutionMock=createMock(RequestExecution.class);
  Batch batchMock=createMock(Batch.class);
  long executionId=11L;
  String clusterName="c1";
  BatchSettings batchSettings=new BatchSettings();
  batchSettings.setTaskFailureToleranceLimit(1);
  Map<Long,RequestExecution> executionMap=new HashMap<Long,RequestExecution>();
  executionMap.put(executionId,requestExecutionMock);
  expect(clustersMock.getCluster(clusterName)).andReturn(clusterMock).anyTimes();
  expect(clusterMock.getAllRequestExecutions()).andReturn(executionMap).anyTimes();
  expect(requestExecutionMock.getBatch()).andReturn(batchMock).anyTimes();
  expect(batchMock.getBatchSettings()).andReturn(batchSettings).anyTimes();
  replay(clustersMock,clusterMock,configurationMock,requestExecutionMock,executionSchedulerMock,batchMock);
  ExecutionScheduleManager scheduleManager=new ExecutionScheduleManager(configurationMock,executionSchedulerMock,tokenStorageMock,clustersMock,actionDBAccessorMock,gson);
  HashMap<String,Integer> taskCounts=new HashMap<String,Integer>(){
{
      put(BatchRequestJob.BATCH_REQUEST_FAILED_TASKS_KEY,2);
      put(BatchRequestJob.BATCH_REQUEST_TOTAL_TASKS_KEY,10);
    }
  }
;
  boolean exceeded=scheduleManager.hasToleranceThresholdExceeded(executionId,clusterName,taskCounts);
  Assert.assertTrue(exceeded);
  verify(clustersMock,clusterMock,configurationMock,requestExecutionMock,executionSchedulerMock,batchMock);
}

</code></pre>

<pre class="type-4 type-2 type-5 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testDeleteAllJobs() throws Exception {
  RequestExecution requestExecution=createRequestExecution(true);
  Assert.assertNotNull(requestExecution);
  executionScheduleManager.scheduleBatch(requestExecution);
  String jobName1=executionScheduleManager.getJobName(requestExecution.getId(),10L);
  String jobName2=executionScheduleManager.getJobName(requestExecution.getId(),12L);
  JobDetail jobDetail1=scheduler.getJobDetail(JobKey.jobKey(jobName1,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP));
  JobDetail jobDetail2=scheduler.getJobDetail(JobKey.jobKey(jobName2,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP));
  Assert.assertNotNull(jobDetail1);
  Assert.assertNotNull(jobDetail2);
  Assert.assertTrue(!scheduler.getTriggersOfJob(JobKey.jobKey(jobName1,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP)).isEmpty());
  executionScheduleManager.deleteAllJobs(requestExecution);
  Assert.assertTrue(scheduler.getTriggersOfJob(JobKey.jobKey(jobName1,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP)).isEmpty());
}

</code></pre>

<pre class="type-4 type-2 type-1 type-11 type-18 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies logic rules using matcher-style statements">ConditionMatcher</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies logic rules using matcher-style statements
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testPointInTimeExecutionJob() throws Exception {
  RequestExecution requestExecution=createRequestExecution(false);
  Assert.assertNotNull(requestExecution);
  executionScheduleManager.scheduleBatch(requestExecution);
  String jobName1=executionScheduleManager.getJobName(requestExecution.getId(),10L);
  String jobName2=executionScheduleManager.getJobName(requestExecution.getId(),12L);
  JobDetail jobDetail1=scheduler.getJobDetail(JobKey.jobKey(jobName1,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP));
  JobDetail jobDetail2=scheduler.getJobDetail(JobKey.jobKey(jobName2,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP));
  Assert.assertNotNull(jobDetail1);
  Assert.assertNotNull(jobDetail2);
  List<? extends Trigger> triggers=scheduler.getTriggersOfJob(JobKey.jobKey(jobName1,ExecutionJob.LINEAR_EXECUTION_JOB_GROUP));
  Assert.assertNotNull(triggers);
  Assert.assertEquals(1,triggers.size());
  assertThat(triggers.get(0),instanceOf(SimpleTrigger.class));
  Assert.assertNull(jobDetail2.getJobDataMap().getString(ExecutionJob.NEXT_EXECUTION_JOB_NAME_KEY));
  int waitCount=0;
  while (scheduler.getCurrentlyExecutingJobs().size() != 0 && waitCount < 10) {
    Thread.sleep(100);
    waitCount++;
  }
}

</code></pre>

<pre class="type-1 type-18 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies logic rules using matcher-style statements">ConditionMatcher</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
- Verifies logic rules using matcher-style statements
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testFinalizeBeforeExit() throws Exception {
  ExecutionScheduleManager scheduleManagerMock=createMock(ExecutionScheduleManager.class);
  AbstractLinearExecutionJob executionJob=createMockBuilder(AbstractLinearExecutionJob.class).addMockedMethods("finalizeExecution","doWork").withConstructor(scheduleManagerMock).createMock();
  JobExecutionContext context=createMock(JobExecutionContext.class);
  JobDetail jobDetail=createMock(JobDetail.class);
  JobDataMap jobDataMap=createMock(JobDataMap.class);
  expect(context.getJobDetail()).andReturn(jobDetail).anyTimes();
  expect(context.getMergedJobDataMap()).andReturn(jobDataMap).anyTimes();
  expect(jobDetail.getKey()).andReturn(new JobKey("TestJob"));
  expect(jobDataMap.getWrappedMap()).andReturn(new HashMap<String,Object>());
  expect(scheduleManagerMock.continueOnMisfire(context)).andReturn(true);
  executionJob.doWork((Map<String,Object>)anyObject());
  expectLastCall().andThrow(new AmbariException("Test Exception")).anyTimes();
  executionJob.finalizeExecution((Map<String,Object>)anyObject());
  expectLastCall().once();
  replay(scheduleManagerMock,executionJob,context,jobDataMap,jobDetail);
  try {
    executionJob.execute(context);
  }
 catch (  Exception ae) {
    assertThat(ae,instanceOf(JobExecutionException.class));
    JobExecutionException je=(JobExecutionException)ae;
    Assert.assertEquals("Test Exception",je.getUnderlyingException().getMessage());
  }
  verify(scheduleManagerMock,executionJob,context,jobDataMap,jobDetail);
}

</code></pre>

<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testExecuteBatchRequest() throws Exception {
  Clusters clustersMock=createMock(Clusters.class);
  Cluster clusterMock=createMock(Cluster.class);
  RequestExecution requestExecutionMock=createMock(RequestExecution.class);
  Configuration configurationMock=createNiceMock(Configuration.class);
  ExecutionScheduler executionSchedulerMock=createMock(ExecutionScheduler.class);
  InternalTokenStorage tokenStorageMock=createMock(InternalTokenStorage.class);
  ActionDBAccessor actionDBAccessorMock=createMock(ActionDBAccessor.class);
  Gson gson=new Gson();
  BatchRequest batchRequestMock=createMock(BatchRequest.class);
  long executionId=11L;
  long batchId=1L;
  long requestId=5L;
  String clusterName="mycluster";
  String uri="clusters";
  String type="post";
  String body="body";
  Map<Long,RequestExecution> executionMap=new HashMap<Long,RequestExecution>();
  executionMap.put(executionId,requestExecutionMock);
  BatchRequestResponse batchRequestResponse=new BatchRequestResponse();
  batchRequestResponse.setStatus(HostRoleStatus.IN_PROGRESS.toString());
  batchRequestResponse.setRequestId(requestId);
  batchRequestResponse.setReturnCode(202);
  EasyMock.expect(configurationMock.getApiSSLAuthentication()).andReturn(Boolean.FALSE);
  EasyMock.replay(configurationMock);
  ExecutionScheduleManager scheduleManager=createMockBuilder(ExecutionScheduleManager.class).withConstructor(configurationMock,executionSchedulerMock,tokenStorageMock,clustersMock,actionDBAccessorMock,gson).addMockedMethods("performApiRequest","updateBatchRequest").createNiceMock();
  expect(clustersMock.getCluster(clusterName)).andReturn(clusterMock).anyTimes();
  expect(clusterMock.getAllRequestExecutions()).andReturn(executionMap).anyTimes();
  expect(requestExecutionMock.getBatchRequest(eq(batchId))).andReturn(batchRequestMock).once();
  expect(requestExecutionMock.getRequestBody(eq(batchId))).andReturn(body).once();
  expect(batchRequestMock.getUri()).andReturn(uri).once();
  expect(batchRequestMock.getType()).andReturn(type).once();
  expect(scheduleManager.performApiRequest(eq(uri),eq(body),eq(type))).andReturn(batchRequestResponse).once();
  scheduleManager.updateBatchRequest(eq(executionId),eq(batchId),eq(clusterName),eq(batchRequestResponse),eq(false));
  expectLastCall().once();
  actionDBAccessorMock.setSourceScheduleForRequest(eq(requestId),eq(executionId));
  expectLastCall().once();
  replay(clusterMock,clustersMock,requestExecutionMock,executionSchedulerMock,tokenStorageMock,batchRequestMock,scheduleManager,actionDBAccessorMock);
  scheduleManager.executeBatchRequest(executionId,batchId,clusterName);
  verify(clusterMock,clustersMock,configurationMock,requestExecutionMock,executionSchedulerMock,tokenStorageMock,batchRequestMock,scheduleManager,actionDBAccessorMock);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
