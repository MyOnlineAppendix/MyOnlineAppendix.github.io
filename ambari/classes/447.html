<h3 style="margin:0px">Class: org.apache.ambari.server.state.UpgradeHelperTest (20 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(18)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(18)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(17)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(17)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(16)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(16)</kbd></button>&nbsp;<button id="17"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('17')" data-toggle="tooltip" title="Verifies values related to public fields."><kbd id="tag-17"class="label-info"style="display: inline-block;font-size:7pt" >PublicFieldVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testServiceCheckDowngradeStages() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test_checks"));
  UpgradePack upgrade=upgrades.get("upgrade_test_checks");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,DOWNGRADE_VERSION,Direction.DOWNGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(5,groups.size());
  UpgradeGroupHolder zookeeperGroup=groups.get(3);
  assertEquals("ZOOKEEPER",zookeeperGroup.name);
  ManualTask manualTask=(ManualTask)zookeeperGroup.items.get(0).getTasks().get(0).getTasks().get(0);
  assertEquals("This is a manual task with a placeholder of placeholder-rendered-properly",manualTask.message);
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Verify that a Rolling Upgrades restarts the NameNodes in the following order: standby, active.
 * @throws Exception
 */
@Test public void testNamenodeOrder() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  UpgradeGroupHolder mastersGroup=groups.get(2);
  assertEquals("CORE_MASTER",mastersGroup.name);
  List<String> orderedNameNodes=new LinkedList<String>();
  for (  StageWrapper sw : mastersGroup.items) {
    if (sw.getType().equals(StageWrapper.Type.RESTART) && sw.getText().toLowerCase().contains("NameNode".toLowerCase())) {
      for (      TaskWrapper tw : sw.getTasks()) {
        for (        String hostName : tw.getHosts()) {
          orderedNameNodes.add(hostName);
        }
      }
    }
  }
  assertEquals(2,orderedNameNodes.size());
  assertEquals("h2",orderedNameNodes.get(0));
  assertEquals("h1",orderedNameNodes.get(1));
}

</code></pre>

<pre class="type-4 type-13 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test that multiple execute tasks with an annotation of synchronized="true" each run in their own stage.
 */
@Test public void testUpgradeWithMultipleTasksInOwnStage() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  assertTrue(upgrade.getType() == UpgradeType.ROLLING);
  List<Grouping> upgradePackGroups=upgrade.getGroups(Direction.UPGRADE);
  boolean foundService=false;
  for (  Grouping group : upgradePackGroups) {
    if (group.title.equals("Oozie")) {
      foundService=true;
    }
  }
  assertTrue(foundService);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  int numPrepareStages=0;
  for (  UpgradeGroupHolder group : groups) {
    if (group.name.equals("OOZIE")) {
      assertTrue(group.items.size() > 0);
      for (      StageWrapper sw : group.items) {
        if (sw.getText().equalsIgnoreCase("Preparing Oozie Server on h2 (Batch 1 of 2)") || sw.getText().equalsIgnoreCase("Preparing Oozie Server on h3 (Batch 2 of 2)")) {
          numPrepareStages++;
          List<TaskWrapper> taskWrappers=sw.getTasks();
          assertEquals(1,taskWrappers.size());
          List<Task> tasks=taskWrappers.get(0).getTasks();
          assertEquals(1,taskWrappers.get(0).getHosts().size());
          assertEquals(1,tasks.size());
          ExecuteTask task=(ExecuteTask)tasks.get(0);
          assertTrue("scripts/oozie_server.py".equalsIgnoreCase(task.script));
          assertTrue("stop".equalsIgnoreCase(task.function));
        }
        if (sw.getText().equalsIgnoreCase("Preparing Oozie Server on h2")) {
          numPrepareStages++;
          List<TaskWrapper> taskWrappers=sw.getTasks();
          assertEquals(1,taskWrappers.size());
          List<Task> tasks=taskWrappers.get(0).getTasks();
          assertEquals(1,taskWrappers.get(0).getHosts().size());
          assertEquals(1,tasks.size());
          ExecuteTask task=(ExecuteTask)tasks.get(0);
          assertTrue("scripts/oozie_server_upgrade.py".equalsIgnoreCase(task.script));
          assertTrue("upgrade_oozie_database_and_sharelib".equalsIgnoreCase(task.function));
        }
      }
    }
  }
  assertEquals(3,numPrepareStages);
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void before() throws Exception {
  m_configHelper=EasyMock.createNiceMock(ConfigHelper.class);
  expect(m_configHelper.getPlaceholderValueFromDesiredConfigurations(EasyMock.anyObject(Cluster.class),EasyMock.eq("{{foo/bar}}"))).andReturn("placeholder-rendered-properly").anyTimes();
  expect(m_configHelper.getEffectiveDesiredTags(EasyMock.anyObject(Cluster.class),EasyMock.anyObject(String.class))).andReturn(new HashMap<String,Map<String,String>>()).anyTimes();
  replay(m_configHelper);
  final InMemoryDefaultTestModule injectorModule=new InMemoryDefaultTestModule(){
    @Override protected void configure(){
      super.configure();
    }
  }
;
  MockModule mockModule=new MockModule();
  injector=Guice.createInjector(Modules.override(injectorModule).with(mockModule));
  injector.getInstance(GuiceJpaInitializer.class);
  helper=injector.getInstance(OrmTestHelper.class);
  ambariMetaInfo=injector.getInstance(AmbariMetaInfo.class);
  m_upgradeHelper=injector.getInstance(UpgradeHelper.class);
  m_masterHostResolver=EasyMock.createMock(MasterHostResolver.class);
  m_managementController=injector.getInstance(AmbariManagementController.class);
  SecurityContextHolder.getContext().setAuthentication(TestAuthenticationFactory.createAdministrator("admin"));
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testDowngradeOrchestration() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,DOWNGRADE_VERSION,Direction.DOWNGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  assertEquals("PRE_CLUSTER",groups.get(0).name);
  assertEquals("OOZIE",groups.get(1).name);
  assertEquals("HIVE",groups.get(2).name);
  assertEquals("CORE_SLAVES",groups.get(3).name);
  assertEquals("CORE_MASTER",groups.get(4).name);
  assertEquals("ZOOKEEPER",groups.get(5).name);
  UpgradeGroupHolder postGroup=groups.get(6);
  assertEquals("POST_CLUSTER",postGroup.name);
  assertEquals("Finalize Downgrade",postGroup.title);
  assertEquals(3,postGroup.items.size());
  assertEquals("Confirm Finalize",postGroup.items.get(0).getText());
  assertEquals("Execute HDFS Finalize",postGroup.items.get(1).getText());
  assertEquals("Save Cluster State",postGroup.items.get(2).getText());
  assertEquals(StageWrapper.Type.SERVER_SIDE_ACTION,postGroup.items.get(2).getType());
  assertEquals(4,groups.get(0).items.size());
  assertEquals(8,groups.get(1).items.size());
  assertEquals(3,groups.get(2).items.size());
  assertEquals(8,groups.get(3).items.size());
  assertEquals(8,groups.get(4).items.size());
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testConfigureTaskWithMultipleConfigurations() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  ConfigUpgradePack cup=ambariMetaInfo.getConfigUpgradePack("HDP","2.1.1");
  assertNotNull(upgrade);
  Cluster cluster=makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  UpgradeGroupHolder hiveGroup=groups.get(4);
  assertEquals("HIVE",hiveGroup.name);
  ConfigureTask configureTask=(ConfigureTask)hiveGroup.items.get(2).getTasks().get(0).getTasks().get(0);
  Map<String,String> configProperties=configureTask.getConfigurationChanges(cluster,cup);
  assertFalse(configProperties.isEmpty());
  assertEquals(configProperties.get(ConfigureTask.PARAMETER_CONFIG_TYPE),"hive-site");
  String configurationJson=configProperties.get(ConfigureTask.PARAMETER_KEY_VALUE_PAIRS);
  String transferJson=configProperties.get(ConfigureTask.PARAMETER_TRANSFERS);
  assertNotNull(configurationJson);
  assertNotNull(transferJson);
  List<ConfigUpgradeChangeDefinition.ConfigurationKeyValue> keyValuePairs=m_gson.fromJson(configurationJson,new TypeToken<List<ConfigUpgradeChangeDefinition.ConfigurationKeyValue>>(){
  }
.getType());
  List<ConfigUpgradeChangeDefinition.Transfer> transfers=m_gson.fromJson(transferJson,new TypeToken<List<ConfigUpgradeChangeDefinition.Transfer>>(){
  }
.getType());
  assertEquals("fooKey",keyValuePairs.get(0).key);
  assertEquals("fooValue",keyValuePairs.get(0).value);
  assertEquals("fooKey2",keyValuePairs.get(1).key);
  assertEquals("fooValue2",keyValuePairs.get(1).value);
  assertEquals("fooKey3",keyValuePairs.get(2).key);
  assertEquals("fooValue3",keyValuePairs.get(2).value);
  assertEquals("copy-key",transfers.get(0).fromKey);
  assertEquals("copy-key-to",transfers.get(0).toKey);
  assertEquals("move-key",transfers.get(1).fromKey);
  assertEquals("move-key-to",transfers.get(1).toKey);
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testUpgradeServerActionOrchestration() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  ServiceInfo si=ambariMetaInfo.getService("HDP","2.1.1","ZOOKEEPER");
  si.setDisplayName("Zk");
  ComponentInfo ci=si.getComponentByName("ZOOKEEPER_SERVER");
  ci.setDisplayName("ZooKeeper1 Server2");
  assertTrue(upgrades.containsKey("upgrade_server_action_test"));
  UpgradePack upgrade=upgrades.get("upgrade_server_action_test");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(1,groups.size());
  UpgradeGroupHolder group=groups.get(0);
  assertEquals("CLUSTER_SERVER_ACTIONS",group.name);
  List<StageWrapper> stageWrappers=group.items;
  assertEquals(6,stageWrappers.size());
  assertEquals("Pre Upgrade",stageWrappers.get(0).getText());
  assertEquals("Pre Upgrade Zookeeper",stageWrappers.get(1).getText());
  assertEquals("Configuring",stageWrappers.get(2).getText());
  assertEquals("Configuring HDFS",stageWrappers.get(3).getText());
  assertEquals("Calculating Properties",stageWrappers.get(4).getText());
  assertEquals("Calculating HDFS Properties",stageWrappers.get(5).getText());
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testDowngradeAfterPartialUpgrade() throws Exception {
  Clusters clusters=injector.getInstance(Clusters.class);
  ServiceFactory serviceFactory=injector.getInstance(ServiceFactory.class);
  String clusterName="c1";
  StackId stackId=new StackId("HDP-2.1.1");
  clusters.addCluster(clusterName,stackId);
  Cluster c=clusters.getCluster(clusterName);
  helper.getOrCreateRepositoryVersion(stackId,c.getDesiredStackVersion().getStackVersion());
  c.createClusterVersion(stackId,c.getDesiredStackVersion().getStackVersion(),"admin",RepositoryVersionState.UPGRADING);
  for (int i=0; i < 2; i++) {
    String hostName="h" + (i + 1);
    clusters.addHost(hostName);
    Host host=clusters.getHost(hostName);
    Map<String,String> hostAttributes=new HashMap<String,String>();
    hostAttributes.put("os_family","redhat");
    hostAttributes.put("os_release_version","6");
    host.setHostAttributes(hostAttributes);
    host.persist();
    clusters.mapHostToCluster(hostName,clusterName);
  }
  c.addService(serviceFactory.createNew(c,"HDFS"));
  Service s=c.getService("HDFS");
  ServiceComponent sc=s.addServiceComponent("NAMENODE");
  sc.addServiceComponentHost("h1");
  sc.addServiceComponentHost("h2");
  List<ServiceComponentHost> schs=c.getServiceComponentHosts("HDFS","NAMENODE");
  assertEquals(2,schs.size());
  HostsType type=new HostsType();
  type.master="h1";
  type.secondary="h2";
  expect(m_masterHostResolver.getMasterAndHosts("ZOOKEEPER","ZOOKEEPER_SERVER")).andReturn(null).anyTimes();
  expect(m_masterHostResolver.getMasterAndHosts("HDFS","NAMENODE")).andReturn(type).anyTimes();
  expect(m_masterHostResolver.getCluster()).andReturn(c).anyTimes();
  replay(m_masterHostResolver);
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,DOWNGRADE_VERSION,Direction.DOWNGRADE,UpgradeType.ROLLING);
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_direction"));
  UpgradePack upgrade=upgrades.get("upgrade_direction");
  assertNotNull(upgrade);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(2,groups.size());
  UpgradeGroupHolder group=groups.get(0);
  assertEquals(1,group.items.size());
  assertEquals("PRE_POST_CLUSTER",group.name);
  group=groups.get(1);
  assertEquals("POST_CLUSTER",group.name);
  assertEquals(3,group.items.size());
  StageWrapper stage=group.items.get(1);
  assertEquals("NameNode Finalize",stage.getText());
  assertEquals(1,stage.getTasks().size());
  TaskWrapper task=stage.getTasks().get(0);
  assertEquals(1,task.getHosts().size());
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testManualTaskPostProcessing() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  UpgradeGroupHolder zookeeperGroup=groups.get(1);
  assertEquals("ZOOKEEPER",zookeeperGroup.name);
  ManualTask manualTask=(ManualTask)zookeeperGroup.items.get(0).getTasks().get(0).getTasks().get(0);
  assertEquals("This is a manual task with a placeholder of placeholder-rendered-properly",manualTask.message);
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testConditionalDeleteTask() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  ConfigUpgradePack cup=ambariMetaInfo.getConfigUpgradePack("HDP","2.1.1");
  assertNotNull(upgrade);
  Cluster cluster=makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  UpgradeGroupHolder hiveGroup=groups.get(4);
  assertEquals("HIVE",hiveGroup.name);
  ConfigureTask configureTask=(ConfigureTask)hiveGroup.items.get(2).getTasks().get(0).getTasks().get(0);
  Map<String,String> hiveConfigs=new HashMap<String,String>();
  hiveConfigs.put("hive.server2.transport.mode","http");
  hiveConfigs.put("hive.server2.thrift.port","10001");
  hiveConfigs.put("condition","1");
  ConfigurationRequest configurationRequest=new ConfigurationRequest();
  configurationRequest.setClusterName(cluster.getClusterName());
  configurationRequest.setType("hive-site");
  configurationRequest.setVersionTag("version2");
  configurationRequest.setProperties(hiveConfigs);
  final ClusterRequest clusterRequest=new ClusterRequest(cluster.getClusterId(),cluster.getClusterName(),cluster.getDesiredStackVersion().getStackVersion(),null);
  clusterRequest.setDesiredConfig(Collections.singletonList(configurationRequest));
  m_managementController.updateClusters(new HashSet<ClusterRequest>(){
{
      add(clusterRequest);
    }
  }
,null);
  Map<String,String> configProperties=configureTask.getConfigurationChanges(cluster,cup);
  assertFalse(configProperties.isEmpty());
  assertEquals(configProperties.get(ConfigureTask.PARAMETER_CONFIG_TYPE),"hive-site");
  String configurationJson=configProperties.get(ConfigureTask.PARAMETER_TRANSFERS);
  assertNotNull(configurationJson);
  List<ConfigUpgradeChangeDefinition.Transfer> transfers=m_gson.fromJson(configurationJson,new TypeToken<List<ConfigUpgradeChangeDefinition.Transfer>>(){
  }
.getType());
  assertEquals(10,transfers.size());
  assertEquals("copy-key",transfers.get(0).fromKey);
  assertEquals("copy-key-to",transfers.get(0).toKey);
  assertEquals("move-key",transfers.get(1).fromKey);
  assertEquals("move-key-to",transfers.get(1).toKey);
  assertEquals("delete-key",transfers.get(2).deleteKey);
  assertEquals("delete-http",transfers.get(3).deleteKey);
  assertEquals("delete-null-if-value",transfers.get(4).deleteKey);
  assertEquals("delete-blank-if-key",transfers.get(5).deleteKey);
  assertEquals("delete-blank-if-type",transfers.get(6).deleteKey);
  assertEquals("delete-thrift",transfers.get(7).deleteKey);
  assertEquals("delete-if-key-present",transfers.get(8).deleteKey);
  assertEquals("delete-if-key-absent",transfers.get(9).deleteKey);
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testUpgradeOrchestration() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("foo","bar");
  assertTrue(upgrades.isEmpty());
  upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  ServiceInfo si=ambariMetaInfo.getService("HDP","2.1.1","ZOOKEEPER");
  si.setDisplayName("Zk");
  ComponentInfo ci=si.getComponentByName("ZOOKEEPER_SERVER");
  ci.setDisplayName("ZooKeeper1 Server2");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  assertEquals("PRE_CLUSTER",groups.get(0).name);
  assertEquals("ZOOKEEPER",groups.get(1).name);
  assertEquals("CORE_MASTER",groups.get(2).name);
  assertEquals("CORE_SLAVES",groups.get(3).name);
  assertEquals("HIVE",groups.get(4).name);
  assertEquals("OOZIE",groups.get(5).name);
  UpgradeGroupHolder holder=groups.get(2);
  boolean found=false;
  for (  StageWrapper sw : holder.items) {
    if (sw.getTasksJson().contains("Upgrading your database")) {
      found=true;
    }
  }
  assertTrue("Expected to find replaced text for Upgrading",found);
  UpgradeGroupHolder group=groups.get(1);
  assertTrue(group.items.get(1).getText().contains("ZooKeeper1 Server2"));
  assertEquals(group.items.get(5).getText(),"Service Check Zk");
  group=groups.get(3);
  assertEquals(8,group.items.size());
  StageWrapper sw=group.items.get(3);
  assertEquals("Validate Partial Upgrade",sw.getText());
  assertEquals(1,sw.getTasks().size());
  assertEquals(1,sw.getTasks().get(0).getTasks().size());
  Task t=sw.getTasks().get(0).getTasks().get(0);
  assertEquals(ManualTask.class,t.getClass());
  ManualTask mt=(ManualTask)t;
  assertTrue(mt.message.contains("DataNode and NodeManager"));
  assertNotNull(mt.structuredOut);
  assertTrue(mt.structuredOut.contains("DATANODE"));
  assertTrue(mt.structuredOut.contains("NODEMANAGER"));
  UpgradeGroupHolder postGroup=groups.get(6);
  assertEquals("POST_CLUSTER",postGroup.name);
  assertEquals("Finalize Upgrade",postGroup.title);
  assertEquals(3,postGroup.items.size());
  assertEquals("Confirm Finalize",postGroup.items.get(0).getText());
  assertEquals("Execute HDFS Finalize",postGroup.items.get(1).getText());
  assertEquals("Save Cluster State",postGroup.items.get(2).getText());
  assertEquals(StageWrapper.Type.SERVER_SIDE_ACTION,postGroup.items.get(2).getType());
  assertEquals(4,groups.get(0).items.size());
  assertEquals(6,groups.get(1).items.size());
  assertEquals(9,groups.get(2).items.size());
  assertEquals(8,groups.get(3).items.size());
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void teardown(){
  injector.getInstance(PersistService.class).stop();
  SecurityContextHolder.getContext().setAuthentication(null);
}

</code></pre>

<pre class="type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testSuggestUpgradePack() throws Exception {
  final String clusterName="c1";
  final String upgradeFromVersion="2.1.1";
  final String upgradeToVersion="2.2.0";
  final Direction upgradeDirection=Direction.UPGRADE;
  final UpgradeType upgradeType=UpgradeType.ROLLING;
  makeCluster();
  try {
    String preferredUpgradePackName="upgrade_test";
    UpgradePack up=m_upgradeHelper.suggestUpgradePack(clusterName,upgradeFromVersion,upgradeToVersion,upgradeDirection,upgradeType,preferredUpgradePackName);
    assertEquals(upgradeType,up.getType());
  }
 catch (  AmbariException e) {
    assertTrue(false);
  }
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests that hosts in MM are not included in the upgrade.
 * @throws Exception
 */
@Test public void testUpgradeOrchestrationWithHostsInMM() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("foo","bar");
  assertTrue(upgrades.isEmpty());
  upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  ServiceInfo si=ambariMetaInfo.getService("HDP","2.1.1","ZOOKEEPER");
  si.setDisplayName("Zk");
  ComponentInfo ci=si.getComponentByName("ZOOKEEPER_SERVER");
  ci.setDisplayName("ZooKeeper1 Server2");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  Cluster cluster=makeCluster();
  Host hostInMaintenanceMode=cluster.getHosts().iterator().next();
  hostInMaintenanceMode.setMaintenanceState(cluster.getClusterId(),MaintenanceState.ON);
  MasterHostResolver masterHostResolver=new MasterHostResolver(null,cluster,"");
  UpgradeContext context=new UpgradeContext(masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  for (  UpgradeGroupHolder group : groups) {
    for (    StageWrapper stageWrapper : group.items) {
      Set<String> hosts=stageWrapper.getHosts();
      assertFalse(hosts.contains(hostInMaintenanceMode.getHostName()));
    }
  }
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testUpgradeOrchestrationFullTask() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  ServiceInfo si=ambariMetaInfo.getService("HDP","2.1.1","ZOOKEEPER");
  si.setDisplayName("Zk");
  ComponentInfo ci=si.getComponentByName("ZOOKEEPER_SERVER");
  ci.setDisplayName("ZooKeeper1 Server2");
  assertTrue(upgrades.containsKey("upgrade_to_new_stack"));
  UpgradePack upgrade=upgrades.get("upgrade_to_new_stack");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(6,groups.size());
  assertEquals("PRE_CLUSTER",groups.get(0).name);
  assertEquals("ZOOKEEPER",groups.get(1).name);
  assertEquals("CORE_MASTER",groups.get(2).name);
  assertEquals("CORE_SLAVES",groups.get(3).name);
  assertEquals("HIVE",groups.get(4).name);
  UpgradeGroupHolder holder=groups.get(2);
  boolean found=false;
  for (  StageWrapper sw : holder.items) {
    if (sw.getTasksJson().contains("Upgrading your database")) {
      found=true;
    }
  }
  assertTrue("Expected to find replaced text for Upgrading",found);
  UpgradeGroupHolder group=groups.get(1);
  assertTrue(group.items.get(1).getText().contains("ZooKeeper1 Server2"));
  assertEquals(group.items.get(4).getText(),"Service Check Zk");
  group=groups.get(3);
  assertEquals(8,group.items.size());
  StageWrapper sw=group.items.get(3);
  assertEquals("Validate Partial Upgrade",sw.getText());
  assertEquals(1,sw.getTasks().size());
  assertEquals(1,sw.getTasks().get(0).getTasks().size());
  Task t=sw.getTasks().get(0).getTasks().get(0);
  assertEquals(ManualTask.class,t.getClass());
  ManualTask mt=(ManualTask)t;
  assertTrue(mt.message.contains("DataNode and NodeManager"));
  assertNotNull(mt.structuredOut);
  assertTrue(mt.structuredOut.contains("DATANODE"));
  assertTrue(mt.structuredOut.contains("NODEMANAGER"));
  UpgradeGroupHolder postGroup=groups.get(5);
  assertEquals(postGroup.name,"POST_CLUSTER");
  assertEquals(postGroup.title,"Finalize Upgrade");
  assertEquals(4,postGroup.items.size());
  assertEquals("Confirm Finalize",postGroup.items.get(0).getText());
  assertEquals("Execute HDFS Finalize",postGroup.items.get(1).getText());
  assertEquals("Save Cluster State",postGroup.items.get(2).getText());
  assertEquals(StageWrapper.Type.SERVER_SIDE_ACTION,postGroup.items.get(2).getType());
  assertEquals("Run On All 2.2.1.0-1234",postGroup.items.get(3).getText());
  assertEquals(1,postGroup.items.get(3).getTasks().size());
  Set<String> hosts=postGroup.items.get(3).getTasks().get(0).getHosts();
  assertNotNull(hosts);
  assertEquals(4,hosts.size());
  assertEquals(4,groups.get(0).items.size());
  assertEquals(5,groups.get(1).items.size());
  assertEquals(9,groups.get(2).items.size());
  assertEquals(8,groups.get(3).items.size());
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testConfigureTask() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  ConfigUpgradePack cup=ambariMetaInfo.getConfigUpgradePack("HDP","2.1.1");
  assertNotNull(upgrade);
  Cluster cluster=makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  UpgradeGroupHolder hiveGroup=groups.get(4);
  assertEquals("HIVE",hiveGroup.name);
  ConfigureTask configureTask=(ConfigureTask)hiveGroup.items.get(1).getTasks().get(0).getTasks().get(0);
  Map<String,String> configProperties=configureTask.getConfigurationChanges(cluster,cup);
  assertFalse(configProperties.isEmpty());
  assertEquals(configProperties.get(ConfigureTask.PARAMETER_CONFIG_TYPE),"hive-site");
  String configurationJson=configProperties.get(ConfigureTask.PARAMETER_KEY_VALUE_PAIRS);
  assertNotNull(configurationJson);
  List<ConfigUpgradeChangeDefinition.ConfigurationKeyValue> keyValuePairs=m_gson.fromJson(configurationJson,new TypeToken<List<ConfigUpgradeChangeDefinition.ConfigurationKeyValue>>(){
  }
.getType());
  assertEquals("hive.server2.thrift.port",keyValuePairs.get(0).key);
  assertEquals("10010",keyValuePairs.get(0).value);
  Map<String,String> hiveConfigs=new HashMap<String,String>();
  hiveConfigs.put("hive.server2.transport.mode","http");
  hiveConfigs.put("hive.server2.thrift.port","10001");
  ConfigurationRequest configurationRequest=new ConfigurationRequest();
  configurationRequest.setClusterName(cluster.getClusterName());
  configurationRequest.setType("hive-site");
  configurationRequest.setVersionTag("version2");
  configurationRequest.setProperties(hiveConfigs);
  final ClusterRequest clusterRequest=new ClusterRequest(cluster.getClusterId(),cluster.getClusterName(),cluster.getDesiredStackVersion().getStackVersion(),null);
  clusterRequest.setDesiredConfig(Collections.singletonList(configurationRequest));
  m_managementController.updateClusters(new HashSet<ClusterRequest>(){
{
      add(clusterRequest);
    }
  }
,null);
  configProperties=configureTask.getConfigurationChanges(cluster,cup);
  assertFalse(configProperties.isEmpty());
  assertEquals(configProperties.get(ConfigureTask.PARAMETER_CONFIG_TYPE),"hive-site");
  configurationJson=configProperties.get(ConfigureTask.PARAMETER_KEY_VALUE_PAIRS);
  assertNotNull(configurationJson);
  keyValuePairs=m_gson.fromJson(configurationJson,new TypeToken<List<ConfigUpgradeChangeDefinition.ConfigurationKeyValue>>(){
  }
.getType());
  assertEquals("hive.server2.http.port",keyValuePairs.get(0).key);
  assertEquals("10011",keyValuePairs.get(0).value);
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testResolverWithFailedUpgrade() throws Exception {
  Clusters clusters=injector.getInstance(Clusters.class);
  ServiceFactory serviceFactory=injector.getInstance(ServiceFactory.class);
  String clusterName="c1";
  StackId stackId=new StackId("HDP-2.1.1");
  clusters.addCluster(clusterName,stackId);
  Cluster c=clusters.getCluster(clusterName);
  helper.getOrCreateRepositoryVersion(stackId,c.getDesiredStackVersion().getStackVersion());
  c.createClusterVersion(stackId,c.getDesiredStackVersion().getStackVersion(),"admin",RepositoryVersionState.UPGRADING);
  for (int i=0; i < 2; i++) {
    String hostName="h" + (i + 1);
    clusters.addHost(hostName);
    Host host=clusters.getHost(hostName);
    Map<String,String> hostAttributes=new HashMap<String,String>();
    hostAttributes.put("os_family","redhat");
    hostAttributes.put("os_release_version","6");
    host.setHostAttributes(hostAttributes);
    host.persist();
    clusters.mapHostToCluster(hostName,clusterName);
  }
  c.addService(serviceFactory.createNew(c,"ZOOKEEPER"));
  Service s=c.getService("ZOOKEEPER");
  ServiceComponent sc=s.addServiceComponent("ZOOKEEPER_SERVER");
  ServiceComponentHost sch1=sc.addServiceComponentHost("h1");
  sch1.setVersion("2.1.1.0-1234");
  ServiceComponentHost sch2=sc.addServiceComponentHost("h2");
  sch2.setVersion("2.1.1.0-1234");
  List<ServiceComponentHost> schs=c.getServiceComponentHosts("ZOOKEEPER","ZOOKEEPER_SERVER");
  assertEquals(2,schs.size());
  MasterHostResolver mhr=new MasterHostResolver(null,c,"2.1.1.0-1234");
  HostsType ht=mhr.getMasterAndHosts("ZOOKEEPER","ZOOKEEPER_SERVER");
  assertEquals(0,ht.hosts.size());
  sch2.setUpgradeState(UpgradeState.FAILED);
  ht=mhr.getMasterAndHosts("ZOOKEEPER","ZOOKEEPER_SERVER");
  assertEquals(1,ht.hosts.size());
  assertEquals("h2",ht.hosts.iterator().next());
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testUpgradeOrchestrationWithNoHeartbeat() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("foo","bar");
  assertTrue(upgrades.isEmpty());
  upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_test"));
  UpgradePack upgrade=upgrades.get("upgrade_test");
  assertNotNull(upgrade);
  Cluster cluster=makeCluster(false);
  Clusters clusters=injector.getInstance(Clusters.class);
  Host h4=clusters.getHost("h4");
  h4.setState(HostState.HEARTBEAT_LOST);
  h4.persist();
  List<ServiceComponentHost> schs=cluster.getServiceComponentHosts("h4");
  assertEquals(1,schs.size());
  assertEquals(HostState.HEARTBEAT_LOST,schs.get(0).getHostState());
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  assertEquals("PRE_CLUSTER",groups.get(0).name);
  assertEquals("ZOOKEEPER",groups.get(1).name);
  assertEquals("CORE_MASTER",groups.get(2).name);
  assertEquals("CORE_SLAVES",groups.get(3).name);
  assertEquals("HIVE",groups.get(4).name);
  assertEquals("OOZIE",groups.get(5).name);
  UpgradeGroupHolder postGroup=groups.get(6);
  assertEquals("POST_CLUSTER",postGroup.name);
  assertEquals("Finalize Upgrade",postGroup.title);
  assertEquals(3,postGroup.items.size());
  assertEquals("Confirm Finalize",postGroup.items.get(0).getText());
  assertEquals("Execute HDFS Finalize",postGroup.items.get(1).getText());
  assertEquals("Save Cluster State",postGroup.items.get(2).getText());
  assertEquals(StageWrapper.Type.SERVER_SIDE_ACTION,postGroup.items.get(2).getType());
  assertEquals(6,groups.get(1).items.size());
  assertEquals(9,groups.get(2).items.size());
  assertEquals(7,groups.get(3).items.size());
}

</code></pre>

<pre class="type-4 type-13 type-2 type-5 type-1 type-11 type-17 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testServiceCheckUpgradeStages() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.2.0");
  assertTrue(upgrades.containsKey("upgrade_test_checks"));
  UpgradePack upgrade=upgrades.get("upgrade_test_checks");
  assertNotNull(upgrade);
  Cluster c=makeCluster();
  Set<String> additionalServices=new HashSet<String>(){
{
      add("HBASE");
      add("PIG");
      add("TEZ");
      add("AMBARI_METRICS");
    }
  }
;
  for (  String service : additionalServices) {
    c.addService(service);
  }
  int numServiceChecksExpected=0;
  Collection<Service> services=c.getServices().values();
  for (  Service service : services) {
    ServiceInfo si=ambariMetaInfo.getService(c.getCurrentStackVersion().getStackName(),c.getCurrentStackVersion().getStackVersion(),service.getName());
    if (null == si.getCommandScript()) {
      continue;
    }
    if (service.getName().equalsIgnoreCase("TEZ")) {
      assertTrue("Expect Tez to not have any service checks",false);
    }
    if (service.getName().equalsIgnoreCase("AMBARI_METRICS")) {
      continue;
    }
    numServiceChecksExpected++;
  }
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_22,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(7,groups.size());
  UpgradeGroupHolder holder=groups.get(3);
  assertEquals(holder.name,"SERVICE_CHECK_1");
  assertEquals(7,holder.items.size());
  int numServiceChecksActual=0;
  for (  StageWrapper sw : holder.items) {
    for (    Service service : services) {
      Pattern p=Pattern.compile(".*" + service.getName(),Pattern.CASE_INSENSITIVE);
      Matcher matcher=p.matcher(sw.getText());
      if (matcher.matches()) {
        numServiceChecksActual++;
        continue;
      }
    }
  }
  assertEquals(numServiceChecksActual,numServiceChecksExpected);
  UpgradeGroupHolder zookeeperGroup=groups.get(1);
  assertEquals("ZOOKEEPER",zookeeperGroup.name);
  ManualTask manualTask=(ManualTask)zookeeperGroup.items.get(0).getTasks().get(0).getTasks().get(0);
  assertEquals("This is a manual task with a placeholder of placeholder-rendered-properly",manualTask.message);
}

</code></pre>

<pre class="type-4 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testBuckets() throws Exception {
  Map<String,UpgradePack> upgrades=ambariMetaInfo.getUpgradePacks("HDP","2.1.1");
  assertTrue(upgrades.containsKey("upgrade_bucket_test"));
  UpgradePack upgrade=upgrades.get("upgrade_bucket_test");
  assertNotNull(upgrade);
  makeCluster();
  UpgradeContext context=new UpgradeContext(m_masterHostResolver,HDP_21,HDP_21,UPGRADE_VERSION,Direction.UPGRADE,UpgradeType.ROLLING);
  List<UpgradeGroupHolder> groups=m_upgradeHelper.createSequence(upgrade,context);
  assertEquals(1,groups.size());
  UpgradeGroupHolder group=groups.iterator().next();
  assertEquals(22,group.items.size());
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
