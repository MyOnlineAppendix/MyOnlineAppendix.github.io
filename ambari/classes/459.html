<h3 style="margin:0px">Class: org.apache.ambari.server.state.cluster.ClusterTest (34 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(27)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(27)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(19)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(12)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(11)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(3)</kbd></button>&nbsp;<button id="12"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('12')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-12"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="14"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('14')" data-toggle="tooltip" title="Is not executed with the test suite"><kbd id="tag-14"class="label-info"style="display: inline-block;font-size:7pt" >IgnoredMethod&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testGetServiceComponentHosts_ForServiceComponent() throws Exception {
  createDefaultCluster();
  Service s=serviceFactory.createNew(c1,"HDFS");
  c1.addService(s);
  s.persist();
  ServiceComponent scNN=serviceComponentFactory.createNew(s,"NAMENODE");
  s.addServiceComponent(scNN);
  scNN.persist();
  ServiceComponentHost schNNH1=serviceComponentHostFactory.createNew(scNN,"h1");
  scNN.addServiceComponentHost(schNNH1);
  schNNH1.persist();
  ServiceComponent scDN=serviceComponentFactory.createNew(s,"DATANODE");
  s.addServiceComponent(scDN);
  scDN.persist();
  ServiceComponentHost scDNH1=serviceComponentHostFactory.createNew(scDN,"h1");
  scDN.addServiceComponentHost(scDNH1);
  scDNH1.persist();
  ServiceComponentHost scDNH2=serviceComponentHostFactory.createNew(scDN,"h2");
  scDN.addServiceComponentHost(scDNH2);
  scDNH2.persist();
  List<ServiceComponentHost> scHosts;
  scHosts=c1.getServiceComponentHosts("HDFS","DATANODE");
  Assert.assertEquals(2,scHosts.size());
  scHosts=c1.getServiceComponentHosts("HDFS","UNKNOWN COMPONENT");
  Assert.assertEquals(0,scHosts.size());
  scHosts=c1.getServiceComponentHosts("UNKNOWN SERVICE","DATANODE");
  Assert.assertEquals(0,scHosts.size());
  scHosts=c1.getServiceComponentHosts("UNKNOWN SERVICE","UNKNOWN COMPONENT");
  Assert.assertEquals(0,scHosts.size());
}

</code></pre>

<pre class="type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testTransitionNonReportableHost() throws Exception {
  StackId stackId=new StackId("HDP-2.0.5");
  String clusterName="c1";
  clusters.addCluster(clusterName,stackId);
  Cluster c1=clusters.getCluster(clusterName);
  Assert.assertEquals(clusterName,c1.getClusterName());
  Assert.assertEquals(1,c1.getClusterId());
  clusters.addHost("h-1");
  clusters.addHost("h-2");
  clusters.addHost("h-3");
  for (  String hostName : new String[]{"h-1","h-2","h-3"}) {
    Host h=clusters.getHost(hostName);
    h.setIPv4("ipv4");
    h.setIPv6("ipv6");
    Map<String,String> hostAttributes=new HashMap<String,String>();
    hostAttributes.put("os_family","redhat");
    hostAttributes.put("os_release_version","5.9");
    h.setHostAttributes(hostAttributes);
    h.persist();
  }
  String v1="2.0.5-1";
  String v2="2.0.5-2";
  c1.setDesiredStackVersion(stackId);
  RepositoryVersionEntity rve1=helper.getOrCreateRepositoryVersion(stackId,v1);
  RepositoryVersionEntity rve2=helper.getOrCreateRepositoryVersion(stackId,v2);
  c1.setCurrentStackVersion(stackId);
  c1.createClusterVersion(stackId,v1,"admin",RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion(stackId,v1,RepositoryVersionState.CURRENT);
  clusters.mapHostToCluster("h-1",clusterName);
  clusters.mapHostToCluster("h-2",clusterName);
  clusters.mapHostToCluster("h-3",clusterName);
  ClusterVersionDAOMock.failOnCurrentVersionState=false;
  Service service=c1.addService("ZOOKEEPER");
  ServiceComponent sc=service.addServiceComponent("ZOOKEEPER_SERVER");
  sc.addServiceComponentHost("h-1");
  sc.addServiceComponentHost("h-2");
  service=c1.addService("SQOOP");
  sc=service.addServiceComponent("SQOOP");
  sc.addServiceComponentHost("h-3");
  List<HostVersionEntity> entities=hostVersionDAO.findByClusterAndHost(clusterName,"h-3");
  assertTrue("Expected no host versions",null == entities || 0 == entities.size());
  c1.createClusterVersion(stackId,v2,"admin",RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,v2,RepositoryVersionState.INSTALLED);
  c1.transitionClusterVersion(stackId,v2,RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion(stackId,v2,RepositoryVersionState.UPGRADED);
  c1.transitionClusterVersion(stackId,v2,RepositoryVersionState.CURRENT);
  entities=hostVersionDAO.findByClusterAndHost(clusterName,"h-3");
  assertEquals(1,entities.size());
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testAddHost() throws Exception {
  createDefaultCluster();
  clusters.addHost("h3");
  try {
    clusters.addHost("h3");
    fail("Duplicate add should fail");
  }
 catch (  AmbariException e) {
  }
}

</code></pre>

<pre class="type-10 type-2 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testTransitionClusterVersionTransactionFail() throws Exception {
  createDefaultCluster();
  StackId stackId=new StackId("HDP","0.2");
  helper.getOrCreateRepositoryVersion(stackId,stackId.getStackVersion());
  c1.createClusterVersion(stackId,"0.2","admin",RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,"0.2",RepositoryVersionState.INSTALLED);
  c1.transitionClusterVersion(stackId,"0.2",RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion(stackId,"0.2",RepositoryVersionState.UPGRADED);
  try {
    ClusterVersionDAOMock.failOnCurrentVersionState=true;
    c1.transitionClusterVersion(stackId,"0.2",RepositoryVersionState.CURRENT);
    Assert.fail();
  }
 catch (  AmbariException e) {
  }
 finally {
    ClusterVersionDAOMock.failOnCurrentVersionState=false;
  }
  assertNotNull(c1.getCurrentClusterVersion());
}

</code></pre>

<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testTransitionClusterVersion() throws Exception {
  createDefaultCluster();
  String stack="HDP";
  String version="0.2";
  StackId stackId=new StackId(stack,version);
  helper.getOrCreateRepositoryVersion(stackId,version);
  c1.createClusterVersion(stackId,version,"admin",RepositoryVersionState.INSTALLING);
  assertStateException(stackId,version,RepositoryVersionState.CURRENT,RepositoryVersionState.INSTALLING);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADING,RepositoryVersionState.INSTALLING);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADED,RepositoryVersionState.INSTALLING);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADE_FAILED,RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.INSTALL_FAILED);
  checkStackVersionState(stackId,version,RepositoryVersionState.INSTALL_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.CURRENT,RepositoryVersionState.INSTALL_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALLED,RepositoryVersionState.INSTALL_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADING,RepositoryVersionState.INSTALL_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADED,RepositoryVersionState.INSTALL_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADE_FAILED,RepositoryVersionState.INSTALL_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.OUT_OF_SYNC,RepositoryVersionState.INSTALL_FAILED);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.INSTALLING);
  checkStackVersionState(stackId,version,RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.INSTALLED);
  checkStackVersionState(stackId,version,RepositoryVersionState.INSTALLED);
  assertStateException(stackId,version,RepositoryVersionState.CURRENT,RepositoryVersionState.INSTALLED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADE_FAILED,RepositoryVersionState.INSTALLED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALL_FAILED,RepositoryVersionState.INSTALLED);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.OUT_OF_SYNC);
  checkStackVersionState(stackId,version,RepositoryVersionState.OUT_OF_SYNC);
  assertStateException(stackId,version,RepositoryVersionState.CURRENT,RepositoryVersionState.OUT_OF_SYNC);
  assertStateException(stackId,version,RepositoryVersionState.INSTALLED,RepositoryVersionState.OUT_OF_SYNC);
  assertStateException(stackId,version,RepositoryVersionState.INSTALL_FAILED,RepositoryVersionState.OUT_OF_SYNC);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADING,RepositoryVersionState.OUT_OF_SYNC);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADED,RepositoryVersionState.OUT_OF_SYNC);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADE_FAILED,RepositoryVersionState.OUT_OF_SYNC);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.INSTALLING);
  checkStackVersionState(stackId,version,RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.INSTALLED);
  checkStackVersionState(stackId,version,RepositoryVersionState.INSTALLED);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.UPGRADING);
  checkStackVersionState(stackId,version,RepositoryVersionState.UPGRADING);
  assertStateException(stackId,version,RepositoryVersionState.CURRENT,RepositoryVersionState.UPGRADING);
  assertStateException(stackId,version,RepositoryVersionState.INSTALLED,RepositoryVersionState.UPGRADING);
  assertStateException(stackId,version,RepositoryVersionState.INSTALL_FAILED,RepositoryVersionState.UPGRADING);
  assertStateException(stackId,version,RepositoryVersionState.OUT_OF_SYNC,RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.UPGRADE_FAILED);
  checkStackVersionState(stackId,version,RepositoryVersionState.UPGRADE_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.CURRENT,RepositoryVersionState.UPGRADE_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALLED,RepositoryVersionState.UPGRADE_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALL_FAILED,RepositoryVersionState.UPGRADE_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADED,RepositoryVersionState.UPGRADE_FAILED);
  assertStateException(stackId,version,RepositoryVersionState.OUT_OF_SYNC,RepositoryVersionState.UPGRADE_FAILED);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.UPGRADING);
  checkStackVersionState(stackId,version,RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.UPGRADED);
  checkStackVersionState(stackId,version,RepositoryVersionState.UPGRADED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALLED,RepositoryVersionState.UPGRADED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALL_FAILED,RepositoryVersionState.UPGRADED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADING,RepositoryVersionState.UPGRADED);
  assertStateException(stackId,version,RepositoryVersionState.UPGRADE_FAILED,RepositoryVersionState.UPGRADED);
  assertStateException(stackId,version,RepositoryVersionState.OUT_OF_SYNC,RepositoryVersionState.UPGRADED);
  c1.setDesiredStackVersion(stackId);
  c1.transitionClusterVersion(stackId,version,RepositoryVersionState.CURRENT);
  checkStackVersionState(stackId,version,RepositoryVersionState.CURRENT);
  checkStackVersionState(new StackId("HDP","0.1"),"0.1",RepositoryVersionState.INSTALLED);
  assertStateException(stackId,version,RepositoryVersionState.INSTALLED,RepositoryVersionState.CURRENT);
}

</code></pre>

<pre class="type-10 type-2 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testHostEvent() throws Exception, InvalidStateTransitionException {
  createDefaultCluster();
  HostInfo hostInfo=new HostInfo();
  hostInfo.setHostName("h1");
  hostInfo.setInterfaces("fip_4");
  hostInfo.setArchitecture("os_arch");
  hostInfo.setOS("os_type");
  hostInfo.setMemoryTotal(10);
  hostInfo.setMemorySize(100);
  hostInfo.setProcessorCount(10);
  List<DiskInfo> mounts=new ArrayList<DiskInfo>();
  mounts.add(new DiskInfo("/dev/sda","/mnt/disk1","5000000","4000000","10%","size","fstype"));
  hostInfo.setMounts(mounts);
  AgentEnv agentEnv=new AgentEnv();
  Directory dir1=new Directory();
  dir1.setName("/etc/hadoop");
  dir1.setType("not_exist");
  Directory dir2=new Directory();
  dir2.setName("/var/log/hadoop");
  dir2.setType("not_exist");
  agentEnv.setStackFoldersAndFiles(new Directory[]{dir1,dir2});
  AgentVersion agentVersion=new AgentVersion("0.0.x");
  long currentTime=1001;
  clusters.getHost("h1").handleEvent(new HostRegistrationRequestEvent("h1",agentVersion,currentTime,hostInfo,agentEnv));
  Assert.assertEquals(HostState.WAITING_FOR_HOST_STATUS_UPDATES,clusters.getHost("h1").getState());
  clusters.getHost("h1").setState(HostState.HEARTBEAT_LOST);
  try {
    clusters.getHost("h1").handleEvent(new HostHealthyHeartbeatEvent("h1",currentTime,null,null));
    fail("Exception should be thrown on invalid event");
  }
 catch (  InvalidStateTransitionException e) {
  }
}

</code></pre>

<pre class="type-13 type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testDeleteServiceWithConfigHistory() throws Exception {
  createDefaultCluster();
  c1.addService("HDFS").persist();
  Config config1=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,new HashMap<String,Map<String,String>>());
  config1.setTag("version1");
  Config config2=configFactory.createNew(c1,"core-site",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,new HashMap<String,Map<String,String>>());
  config2.setTag("version2");
  config1.persist();
  c1.addConfig(config1);
  config2.persist();
  c1.addConfig(config2);
  Set<Config> configs=new HashSet<Config>();
  configs.add(config1);
  configs.add(config2);
  c1.addDesiredConfig("admin",configs);
  List<ServiceConfigVersionResponse> serviceConfigVersions=c1.getServiceConfigVersions();
  Assert.assertNotNull(serviceConfigVersions);
  Assert.assertEquals(1,serviceConfigVersions.size());
  Assert.assertEquals(Long.valueOf(1),serviceConfigVersions.get(0).getVersion());
  Assert.assertEquals(2,c1.getDesiredConfigs().size());
  Assert.assertEquals("version1",c1.getDesiredConfigByType("hdfs-site").getTag());
  Assert.assertEquals("version2",c1.getDesiredConfigByType("core-site").getTag());
  Map<String,Collection<ServiceConfigVersionResponse>> activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals(1,activeServiceConfigVersions.size());
  c1.deleteService("HDFS");
  Assert.assertEquals(0,c1.getServices().size());
  Assert.assertEquals(0,c1.getServiceConfigVersions().size());
  EntityManager em=injector.getProvider(EntityManager.class).get();
  Assert.assertEquals(0,em.createQuery("SELECT serviceConfig from ServiceConfigEntity serviceConfig").getResultList().size());
  Assert.assertEquals(2,em.createQuery("SELECT config from ClusterConfigEntity config").getResultList().size());
  List<ClusterConfigMappingEntity> configMappingEntities=em.createQuery("SELECT configmapping from ClusterConfigMappingEntity configmapping",ClusterConfigMappingEntity.class).getResultList();
  Assert.assertEquals(2,configMappingEntities.size());
  for (  ClusterConfigMappingEntity configMappingEntity : configMappingEntities) {
    if (StringUtils.equals(configMappingEntity.getType(),"core-site")) {
      assertEquals("core-site is not part of HDFS in test stack, should remain mapped to cluster",1,configMappingEntity.isSelected());
    }
    if (StringUtils.equals(configMappingEntity.getType(),"hdfs-site")) {
      assertEquals("hdfs-site should be unmapped from cluster when HDFS service is removed",0,configMappingEntity.isSelected());
    }
  }
  Assert.assertEquals(0,em.createNativeQuery("SELECT * from serviceconfigmapping").getResultList().size());
}

</code></pre>

<pre class="type-10 type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testBasicClusterSetup() throws Exception {
  StackId stackVersion=new StackId("HDP-1.2.0");
  createDefaultCluster();
  String clusterName="c2";
  try {
    clusters.getCluster(clusterName);
    fail("Exception expected for invalid cluster");
  }
 catch (  Exception e) {
  }
  clusters.addCluster(clusterName,stackVersion);
  Cluster c2=clusters.getCluster(clusterName);
  Assert.assertNotNull(c2);
  Assert.assertEquals(clusterName,c2.getClusterName());
  c2.setClusterName("foo2");
  Assert.assertEquals("foo2",c2.getClusterName());
  Assert.assertNotNull(c2.getDesiredStackVersion());
  Assert.assertEquals("HDP-1.2.0",c2.getDesiredStackVersion().getStackId());
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testSetHostState() throws Exception {
  createDefaultCluster();
  clusters.getHost("h1").setState(HostState.HEARTBEAT_LOST);
  Assert.assertEquals(HostState.HEARTBEAT_LOST,clusters.getHost("h1").getState());
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testGetServiceComponentHosts_ForService() throws Exception {
  createDefaultCluster();
  Service s=serviceFactory.createNew(c1,"HDFS");
  c1.addService(s);
  s.persist();
  ServiceComponent scNN=serviceComponentFactory.createNew(s,"NAMENODE");
  s.addServiceComponent(scNN);
  scNN.persist();
  ServiceComponentHost schNNH1=serviceComponentHostFactory.createNew(scNN,"h1");
  scNN.addServiceComponentHost(schNNH1);
  schNNH1.persist();
  ServiceComponent scDN=serviceComponentFactory.createNew(s,"DATANODE");
  s.addServiceComponent(scDN);
  scDN.persist();
  ServiceComponentHost scDNH1=serviceComponentHostFactory.createNew(scDN,"h1");
  scDN.addServiceComponentHost(scDNH1);
  scDNH1.persist();
  ServiceComponentHost scDNH2=serviceComponentHostFactory.createNew(scDN,"h2");
  scDN.addServiceComponentHost(scDNH2);
  scDNH2.persist();
  List<ServiceComponentHost> scHosts;
  scHosts=c1.getServiceComponentHosts("HDFS",null);
  Assert.assertEquals(3,scHosts.size());
  scHosts=c1.getServiceComponentHosts("UNKNOWN SERVICE",null);
  Assert.assertEquals(0,scHosts.size());
}

</code></pre>

<pre class="type-4 type-10 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testDesiredConfigs() throws Exception {
  createDefaultCluster();
  Config config1=configFactory.createNew(c1,"global",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,new HashMap<String,Map<String,String>>());
  config1.setTag("version1");
  Config config2=configFactory.createNew(c1,"global",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,new HashMap<String,Map<String,String>>());
  config2.setTag("version2");
  Config config3=configFactory.createNew(c1,"core-site",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,new HashMap<String,Map<String,String>>());
  config3.setTag("version2");
  c1.addConfig(config1);
  c1.addConfig(config2);
  c1.addConfig(config3);
  try {
    c1.addDesiredConfig(null,Collections.singleton(config1));
    fail("Cannot set a null user with config");
  }
 catch (  Exception e) {
  }
  c1.addDesiredConfig("_test1",Collections.singleton(config1));
  c1.addDesiredConfig("_test3",Collections.singleton(config3));
  Map<String,DesiredConfig> desiredConfigs=c1.getDesiredConfigs();
  Assert.assertFalse("Expect desired config not contain 'mapred-site'",desiredConfigs.containsKey("mapred-site"));
  Assert.assertTrue("Expect desired config contain " + config1.getType(),desiredConfigs.containsKey("global"));
  Assert.assertTrue("Expect desired config contain " + config3.getType(),desiredConfigs.containsKey("core-site"));
  Assert.assertEquals("Expect desired config for global should be " + config1.getTag(),config1.getTag(),desiredConfigs.get(config1.getType()).getTag());
  Assert.assertEquals("_test1",desiredConfigs.get(config1.getType()).getUser());
  Assert.assertEquals("_test3",desiredConfigs.get(config3.getType()).getUser());
  DesiredConfig dc=desiredConfigs.get(config1.getType());
  Assert.assertTrue("Expect no host-level overrides",(null == dc.getHostOverrides() || dc.getHostOverrides().size() == 0));
  c1.addDesiredConfig("_test2",Collections.singleton(config2));
  Assert.assertEquals("_test2",c1.getDesiredConfigs().get(config2.getType()).getUser());
  c1.addDesiredConfig("_test1",Collections.singleton(config1));
  Host host=clusters.getHost("h1");
  host.addDesiredConfig(c1.getClusterId(),true,"_test2",config2);
  desiredConfigs=c1.getDesiredConfigs();
  dc=desiredConfigs.get(config1.getType());
  Assert.assertNotNull("Expect host-level overrides",dc.getHostOverrides());
  Assert.assertEquals("Expect one host-level override",1,dc.getHostOverrides().size());
}

</code></pre>

<pre class="type-4 type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testServiceConfigVersionsForGroups() throws Exception {
  createDefaultCluster();
  Config config1=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,new HashMap<String,Map<String,String>>());
  config1.setTag("version1");
  c1.addConfig(config1);
  ServiceConfigVersionResponse scvResponse=c1.addDesiredConfig("admin",Collections.singleton(config1));
  assertEquals("SCV 1 should be created",Long.valueOf(1),scvResponse.getVersion());
  Map<String,Collection<ServiceConfigVersionResponse>> activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals("Only one scv should be active",1,activeServiceConfigVersions.get("HDFS").size());
  Config config2=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("a","c");
    }
  }
,new HashMap<String,Map<String,String>>());
  config2.setTag("version2");
  ConfigGroup configGroup=configGroupFactory.createNew(c1,"test group","HDFS","descr",Collections.singletonMap("hdfs-site",config2),Collections.<Long,Host>emptyMap());
  configGroup.persist();
  c1.addConfigGroup(configGroup);
  scvResponse=c1.createServiceConfigVersion("HDFS","admin","test note",configGroup);
  assertEquals("SCV 2 should be created",Long.valueOf(2),scvResponse.getVersion());
  activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals("Two service config versions should be active, for default and test groups",2,activeServiceConfigVersions.get("HDFS").size());
  Config config3=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("a","d");
    }
  }
,new HashMap<String,Map<String,String>>());
  configGroup.setConfigurations(Collections.singletonMap("hdfs-site",config3));
  configGroup.persist();
  scvResponse=c1.createServiceConfigVersion("HDFS","admin","test note",configGroup);
  assertEquals("SCV 3 should be created",Long.valueOf(3),scvResponse.getVersion());
  activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals("Two service config versions should be active, for default and test groups",2,activeServiceConfigVersions.get("HDFS").size());
  assertEquals(3,c1.getServiceConfigVersions().size());
  scvResponse=c1.setServiceConfigVersion("HDFS",2L,"admin","group rollback");
  assertEquals("SCV 4 should be created",Long.valueOf(4),scvResponse.getVersion());
  configGroup=c1.getConfigGroups().get(configGroup.getId());
  activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals("Two service config versions should be active, for default and test groups",2,activeServiceConfigVersions.get("HDFS").size());
  assertEquals(4,c1.getServiceConfigVersions().size());
  Map<String,String> configProperties=configGroup.getConfigurations().get("hdfs-site").getProperties();
  assertEquals("Configurations should be rolled back to a:c ","c",configProperties.get("a"));
  Config config4=new ConfigImpl("hdfs-site");
  config4.setProperties(new HashMap<String,String>(){
{
      put("a","b");
    }
  }
);
  ConfigGroup configGroup2=configGroupFactory.createNew(c1,"test group 2","HDFS","descr",Collections.singletonMap("hdfs-site",config4),Collections.<Long,Host>emptyMap());
  configGroup2.persist();
  c1.addConfigGroup(configGroup2);
  scvResponse=c1.createServiceConfigVersion("HDFS","admin","test note",configGroup2);
  assertEquals("SCV 5 should be created",Long.valueOf(5),scvResponse.getVersion());
  activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals("Three service config versions should be active, for default and test groups",3,activeServiceConfigVersions.get("HDFS").size());
  assertEquals("Five total scvs",5,c1.getServiceConfigVersions().size());
}

</code></pre>

<pre class="type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests that an existing configuration can be successfully updated without
 * creating a new version.
 * @throws Exception
 */
@Test public void testClusterConfigMergingWithoutNewVersion() throws Exception {
  createDefaultCluster();
  Cluster cluster=clusters.getCluster("c1");
  ClusterEntity clusterEntity=clusterDAO.findByName("c1");
  assertEquals(0,clusterEntity.getClusterConfigEntities().size());
  final Config originalConfig=configFactory.createNew(cluster,"foo-site",new HashMap<String,String>(){
{
      put("one","two");
    }
  }
,new HashMap<String,Map<String,String>>());
  originalConfig.setTag("version3");
  originalConfig.persist();
  cluster.addConfig(originalConfig);
  ConfigGroup configGroup=configGroupFactory.createNew(cluster,"g1","t1","",new HashMap<String,Config>(){
{
      put("foo-site",originalConfig);
    }
  }
,Collections.<Long,Host>emptyMap());
  configGroup.persist();
  cluster.addConfigGroup(configGroup);
  clusterEntity=clusterDAO.findByName("c1");
  assertEquals(1,clusterEntity.getClusterConfigEntities().size());
  Map<String,Config> configsByType=cluster.getConfigsByType("foo-site");
  Config config=configsByType.entrySet().iterator().next().getValue();
  Map<String,String> properties=config.getProperties();
  properties.put("three","four");
  config.setProperties(properties);
  config.persist(false);
  clusterEntity=clusterDAO.findByName("c1");
  assertEquals(1,clusterEntity.getClusterConfigEntities().size());
  ClusterConfigEntity clusterConfigEntity=clusterEntity.getClusterConfigEntities().iterator().next();
  assertTrue(clusterConfigEntity.getData().contains("one"));
  assertTrue(clusterConfigEntity.getData().contains("two"));
  assertTrue(clusterConfigEntity.getData().contains("three"));
  assertTrue(clusterConfigEntity.getData().contains("four"));
  cluster.refresh();
  clusterEntity=clusterDAO.findByName("c1");
  assertEquals(1,clusterEntity.getClusterConfigEntities().size());
  clusterConfigEntity=clusterEntity.getClusterConfigEntities().iterator().next();
  assertTrue(clusterConfigEntity.getData().contains("one"));
  assertTrue(clusterConfigEntity.getData().contains("two"));
  assertTrue(clusterConfigEntity.getData().contains("three"));
  assertTrue(clusterConfigEntity.getData().contains("four"));
}

</code></pre>

<pre class="type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testGetHostsDesiredConfigs() throws Exception {
  createDefaultCluster();
  Host host1=clusters.getHost("h1");
  HostEntity hostEntity1=hostDAO.findByName("h1");
  Map<String,Map<String,String>> propAttributes=new HashMap<String,Map<String,String>>();
  propAttributes.put("final",new HashMap<String,String>());
  propAttributes.get("final").put("test","true");
  Config config=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("test","test");
    }
  }
,propAttributes);
  config.setTag("1");
  host1.addDesiredConfig(c1.getClusterId(),true,"test",config);
  Map<Long,Map<String,DesiredConfig>> configs=c1.getAllHostsDesiredConfigs();
  assertTrue(configs.containsKey(hostEntity1.getHostId()));
  assertEquals(1,configs.get(hostEntity1.getHostId()).size());
  List<Long> hostIds=new ArrayList<Long>();
  hostIds.add(hostEntity1.getHostId());
  configs=c1.getHostsDesiredConfigs(hostIds);
  assertTrue(configs.containsKey(hostEntity1.getHostId()));
  assertEquals(1,configs.get(hostEntity1.getHostId()).size());
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setup() throws Exception {
  injector=Guice.createInjector(Modules.override(new InMemoryDefaultTestModule()).with(new MockModule()));
  injector.getInstance(GuiceJpaInitializer.class);
  clusters=injector.getInstance(Clusters.class);
  serviceFactory=injector.getInstance(ServiceFactory.class);
  configGroupFactory=injector.getInstance(ConfigGroupFactory.class);
  serviceComponentFactory=injector.getInstance(ServiceComponentFactory.class);
  serviceComponentHostFactory=injector.getInstance(ServiceComponentHostFactory.class);
  configFactory=injector.getInstance(ConfigFactory.class);
  metaInfo=injector.getInstance(AmbariMetaInfo.class);
  helper=injector.getInstance(OrmTestHelper.class);
  stackDAO=injector.getInstance(StackDAO.class);
  resourceTypeDAO=injector.getInstance(ResourceTypeDAO.class);
  clusterDAO=injector.getInstance(ClusterDAO.class);
  hostDAO=injector.getInstance(HostDAO.class);
  clusterVersionDAO=injector.getInstance(ClusterVersionDAO.class);
  hostVersionDAO=injector.getInstance(HostVersionDAO.class);
  hostComponentStateDAO=injector.getInstance(HostComponentStateDAO.class);
  repositoryVersionDAO=injector.getInstance(RepositoryVersionDAO.class);
  gson=injector.getInstance(Gson.class);
  injector.getInstance(UnitOfWork.class).begin();
}

</code></pre>

<pre class="type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests removing configurations and configuration mappings by stack.
 * @throws Exception
 */
@Test public void testRemoveConfigurations() throws Exception {
  createDefaultCluster();
  Cluster cluster=clusters.getCluster("c1");
  ClusterEntity clusterEntity=clusterDAO.findByName("c1");
  StackId stackId=cluster.getCurrentStackVersion();
  StackId newStackId=new StackId("HDP-2.0.6");
  StackEntity currentStack=stackDAO.find(stackId.getStackName(),stackId.getStackVersion());
  StackEntity newStack=stackDAO.find(newStackId.getStackName(),newStackId.getStackVersion());
  Assert.assertFalse(stackId.equals(newStackId));
  String configType="foo-type";
  ClusterConfigEntity clusterConfig=new ClusterConfigEntity();
  clusterConfig.setClusterEntity(clusterEntity);
  clusterConfig.setConfigId(1L);
  clusterConfig.setStack(currentStack);
  clusterConfig.setTag("version-1");
  clusterConfig.setData("{}");
  clusterConfig.setType(configType);
  clusterConfig.setTimestamp(1L);
  clusterConfig.setVersion(1L);
  clusterDAO.createConfig(clusterConfig);
  clusterEntity.getClusterConfigEntities().add(clusterConfig);
  clusterEntity=clusterDAO.merge(clusterEntity);
  ClusterConfigEntity newClusterConfig=new ClusterConfigEntity();
  newClusterConfig.setClusterEntity(clusterEntity);
  newClusterConfig.setConfigId(2L);
  newClusterConfig.setStack(newStack);
  newClusterConfig.setTag("version-2");
  newClusterConfig.setData("{}");
  newClusterConfig.setType(configType);
  newClusterConfig.setTimestamp(2L);
  newClusterConfig.setVersion(2L);
  clusterDAO.createConfig(newClusterConfig);
  clusterEntity.getClusterConfigEntities().add(newClusterConfig);
  clusterEntity=clusterDAO.merge(clusterEntity);
  ClusterConfigMappingEntity configMapping=new ClusterConfigMappingEntity();
  configMapping.setClusterEntity(clusterEntity);
  configMapping.setCreateTimestamp(1L);
  configMapping.setSelected(1);
  configMapping.setTag("version-1");
  configMapping.setType(configType);
  configMapping.setUser("admin");
  ClusterConfigMappingEntity newConfigMapping=new ClusterConfigMappingEntity();
  newConfigMapping.setClusterEntity(clusterEntity);
  newConfigMapping.setCreateTimestamp(2L);
  newConfigMapping.setSelected(0);
  newConfigMapping.setTag("version-2");
  newConfigMapping.setType(configType);
  newConfigMapping.setUser("admin");
  clusterDAO.persistConfigMapping(configMapping);
  clusterDAO.persistConfigMapping(newConfigMapping);
  clusterEntity.getConfigMappingEntities().add(configMapping);
  clusterEntity.getConfigMappingEntities().add(newConfigMapping);
  clusterEntity=clusterDAO.merge(clusterEntity);
  List<ClusterConfigEntity> clusterConfigs=clusterDAO.getAllConfigurations(cluster.getClusterId(),newStackId);
  Assert.assertEquals(1,clusterConfigs.size());
  cluster.removeConfigurations(newStackId);
  clusterConfigs=clusterDAO.getAllConfigurations(cluster.getClusterId(),newStackId);
  Assert.assertEquals(0,clusterConfigs.size());
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testDeleteService() throws Exception {
  createDefaultCluster();
  c1.addService("MAPREDUCE").persist();
  Service hdfs=c1.addService("HDFS");
  hdfs.persist();
  ServiceComponent nameNode=hdfs.addServiceComponent("NAMENODE");
  nameNode.persist();
  assertEquals(2,c1.getServices().size());
  assertEquals(2,injector.getProvider(EntityManager.class).get().createQuery("SELECT service FROM ClusterServiceEntity service").getResultList().size());
  c1.deleteService("HDFS");
  assertEquals(1,c1.getServices().size());
  assertEquals(1,injector.getProvider(EntityManager.class).get().createQuery("SELECT service FROM ClusterServiceEntity service").getResultList().size());
}

</code></pre>

<pre class="type-13 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests that hosts can be correctly transitioned into the "INSTALLING" state.
 * This method also tests that hosts in MM will not be transitioned, as per
 * the contract of{@link Cluster#transitionHostsToInstalling(ClusterVersionEntity)}.
 * @throws Exception
 */
@Test public void testTransitionHostVersions() throws Exception {
  createDefaultCluster();
  StackId stackId=new StackId("HDP","0.2");
  helper.getOrCreateRepositoryVersion(stackId,stackId.getStackVersion());
  c1.createClusterVersion(stackId,"0.2","admin",RepositoryVersionState.INSTALLING);
  ClusterVersionEntity entityHDP2=null;
  for (  ClusterVersionEntity entity : c1.getAllClusterVersions()) {
    StackEntity repoVersionStackEntity=entity.getRepositoryVersion().getStack();
    StackId repoVersionStackId=new StackId(repoVersionStackEntity);
    if (repoVersionStackId.getStackName().equals("HDP") && repoVersionStackId.getStackVersion().equals("0.2")) {
      entityHDP2=entity;
      break;
    }
  }
  assertNotNull(entityHDP2);
  List<HostVersionEntity> hostVersionsH1Before=hostVersionDAO.findByClusterAndHost("c1","h1");
  assertEquals(1,hostVersionsH1Before.size());
  c1.transitionHostsToInstalling(entityHDP2);
  List<HostVersionEntity> hostVersionsH1After=hostVersionDAO.findByClusterAndHost("c1","h1");
  assertEquals(2,hostVersionsH1After.size());
  boolean checked=false;
  for (  HostVersionEntity entity : hostVersionsH1After) {
    StackEntity repoVersionStackEntity=entity.getRepositoryVersion().getStack();
    if (repoVersionStackEntity.getStackName().equals("HDP") && repoVersionStackEntity.getStackVersion().equals("0.2")) {
      assertEquals(RepositoryVersionState.INSTALLING,entity.getState());
      checked=true;
      break;
    }
  }
  assertTrue(checked);
  c1.transitionHostsToInstalling(entityHDP2);
  hostVersionsH1After=hostVersionDAO.findByClusterAndHost("c1","h1");
  assertEquals(2,hostVersionsH1After.size());
  checked=false;
  for (  HostVersionEntity entity : hostVersionsH1After) {
    StackEntity repoVersionStackEntity=entity.getRepositoryVersion().getStack();
    if (repoVersionStackEntity.getStackName().equals("HDP") && repoVersionStackEntity.getStackVersion().equals("0.2")) {
      assertEquals(RepositoryVersionState.INSTALLING,entity.getState());
      checked=true;
      break;
    }
  }
  assertTrue(checked);
  List<HostVersionEntity> hostVersionEntities=hostVersionDAO.findAll();
  for (  HostVersionEntity hostVersionEntity : hostVersionEntities) {
    hostVersionEntity.setState(RepositoryVersionState.INSTALL_FAILED);
    hostVersionDAO.merge(hostVersionEntity);
  }
  hostVersionEntities=hostVersionDAO.findAll();
  for (  HostVersionEntity hostVersionEntity : hostVersionEntities) {
    assertEquals(RepositoryVersionState.INSTALL_FAILED,hostVersionEntity.getState());
  }
  Collection<Host> hosts=c1.getHosts();
  Iterator<Host> iterator=hosts.iterator();
  Host hostInMaintenanceMode=iterator.next();
  Host hostNotInMaintenanceMode=iterator.next();
  hostInMaintenanceMode.setMaintenanceState(c1.getClusterId(),MaintenanceState.ON);
  c1.transitionHostsToInstalling(entityHDP2);
  List<HostVersionEntity> hostInMaintModeVersions=hostVersionDAO.findByClusterAndHost("c1",hostInMaintenanceMode.getHostName());
  List<HostVersionEntity> otherHostVersions=hostVersionDAO.findByClusterAndHost("c1",hostNotInMaintenanceMode.getHostName());
  for (  HostVersionEntity hostVersionEntity : hostInMaintModeVersions) {
    StackEntity repoVersionStackEntity=hostVersionEntity.getRepositoryVersion().getStack();
    if (repoVersionStackEntity.getStackName().equals("HDP") && repoVersionStackEntity.getStackVersion().equals("0.2")) {
      assertEquals(RepositoryVersionState.OUT_OF_SYNC,hostVersionEntity.getState());
    }
  }
  for (  HostVersionEntity hostVersionEntity : otherHostVersions) {
    StackEntity repoVersionStackEntity=hostVersionEntity.getRepositoryVersion().getStack();
    if (repoVersionStackEntity.getStackName().equals("HDP") && repoVersionStackEntity.getStackVersion().equals("0.2")) {
      assertEquals(RepositoryVersionState.INSTALLING,hostVersionEntity.getState());
    }
  }
}

</code></pre>

<pre class="type-4 type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testServiceConfigVersions() throws Exception {
  createDefaultCluster();
  Config config1=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,new HashMap<String,Map<String,String>>());
  config1.setTag("version1");
  Config config2=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,new HashMap<String,Map<String,String>>());
  config2.setTag("version2");
  c1.addConfig(config1);
  c1.addConfig(config2);
  c1.addDesiredConfig("admin",Collections.singleton(config1));
  List<ServiceConfigVersionResponse> serviceConfigVersions=c1.getServiceConfigVersions();
  Assert.assertNotNull(serviceConfigVersions);
  Assert.assertEquals(1,serviceConfigVersions.size());
  Map<String,Collection<ServiceConfigVersionResponse>> activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals(1,activeServiceConfigVersions.size());
  ServiceConfigVersionResponse hdfsResponse=activeServiceConfigVersions.get("HDFS").iterator().next();
  Assert.assertEquals("HDFS",hdfsResponse.getServiceName());
  Assert.assertEquals("c1",hdfsResponse.getClusterName());
  Assert.assertEquals("admin",hdfsResponse.getUserName());
  Assert.assertEquals("default",hdfsResponse.getGroupName());
  Assert.assertEquals(Long.valueOf(-1),hdfsResponse.getGroupId());
  Assert.assertEquals(Long.valueOf(1),hdfsResponse.getVersion());
  c1.addDesiredConfig("admin",Collections.singleton(config2));
  serviceConfigVersions=c1.getServiceConfigVersions();
  Assert.assertNotNull(serviceConfigVersions);
  Assert.assertEquals(2,serviceConfigVersions.size());
  activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals(1,activeServiceConfigVersions.size());
  hdfsResponse=activeServiceConfigVersions.get("HDFS").iterator().next();
  Assert.assertEquals("HDFS",hdfsResponse.getServiceName());
  Assert.assertEquals("c1",hdfsResponse.getClusterName());
  Assert.assertEquals("admin",hdfsResponse.getUserName());
  assertEquals(Long.valueOf(2),hdfsResponse.getVersion());
  c1.setServiceConfigVersion("HDFS",1L,"admin","test_note");
  serviceConfigVersions=c1.getServiceConfigVersions();
  Assert.assertNotNull(serviceConfigVersions);
  Assert.assertEquals(3,serviceConfigVersions.size());
  activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals(1,activeServiceConfigVersions.size());
  hdfsResponse=activeServiceConfigVersions.get("HDFS").iterator().next();
  Assert.assertEquals("HDFS",hdfsResponse.getServiceName());
  Assert.assertEquals("c1",hdfsResponse.getClusterName());
  Assert.assertEquals("admin",hdfsResponse.getUserName());
  assertEquals(Long.valueOf(3),hdfsResponse.getVersion());
}

</code></pre>

<pre class="type-13 type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests that {@link Cluster#applyLatestConfigurations(StackId)} sets the
 * right configs to enabled.
 * @throws Exception
 */
@Test public void testApplyLatestConfigurations() throws Exception {
  createDefaultCluster();
  Cluster cluster=clusters.getCluster("c1");
  ClusterEntity clusterEntity=clusterDAO.findByName("c1");
  StackId stackId=cluster.getCurrentStackVersion();
  StackId newStackId=new StackId("HDP-2.0.6");
  StackEntity currentStack=stackDAO.find(stackId.getStackName(),stackId.getStackVersion());
  StackEntity newStack=stackDAO.find(newStackId.getStackName(),newStackId.getStackVersion());
  Assert.assertFalse(stackId.equals(newStackId));
  String configType="foo-type";
  ClusterConfigEntity clusterConfig=new ClusterConfigEntity();
  clusterConfig.setClusterEntity(clusterEntity);
  clusterConfig.setConfigId(1L);
  clusterConfig.setStack(currentStack);
  clusterConfig.setTag("version-1");
  clusterConfig.setData("{}");
  clusterConfig.setType(configType);
  clusterConfig.setTimestamp(1L);
  clusterConfig.setVersion(1L);
  clusterDAO.createConfig(clusterConfig);
  clusterEntity.getClusterConfigEntities().add(clusterConfig);
  clusterEntity=clusterDAO.merge(clusterEntity);
  ClusterConfigEntity newClusterConfig=new ClusterConfigEntity();
  newClusterConfig.setClusterEntity(clusterEntity);
  newClusterConfig.setConfigId(2L);
  newClusterConfig.setStack(newStack);
  newClusterConfig.setTag("version-2");
  newClusterConfig.setData("{}");
  newClusterConfig.setType(configType);
  newClusterConfig.setTimestamp(2L);
  newClusterConfig.setVersion(2L);
  clusterDAO.createConfig(newClusterConfig);
  clusterEntity.getClusterConfigEntities().add(newClusterConfig);
  clusterEntity=clusterDAO.merge(clusterEntity);
  ClusterConfigMappingEntity configMapping=new ClusterConfigMappingEntity();
  configMapping.setClusterEntity(clusterEntity);
  configMapping.setCreateTimestamp(1L);
  configMapping.setSelected(1);
  configMapping.setTag("version-1");
  configMapping.setType(configType);
  configMapping.setUser("admin");
  ClusterConfigMappingEntity newConfigMapping=new ClusterConfigMappingEntity();
  newConfigMapping.setClusterEntity(clusterEntity);
  newConfigMapping.setCreateTimestamp(2L);
  newConfigMapping.setSelected(0);
  newConfigMapping.setTag("version-2");
  newConfigMapping.setType(configType);
  newConfigMapping.setUser("admin");
  clusterDAO.persistConfigMapping(configMapping);
  clusterDAO.persistConfigMapping(newConfigMapping);
  clusterEntity.getConfigMappingEntities().add(configMapping);
  clusterEntity.getConfigMappingEntities().add(newConfigMapping);
  clusterEntity=clusterDAO.merge(clusterEntity);
  Collection<ClusterConfigMappingEntity> clusterConfigMappings=clusterEntity.getConfigMappingEntities();
  Assert.assertEquals(2,clusterConfigMappings.size());
  for (  ClusterConfigMappingEntity clusterConfigMapping : clusterConfigMappings) {
    if (clusterConfigMapping.getTag().equals("version-1")) {
      Assert.assertEquals(1,clusterConfigMapping.isSelected());
    }
 else {
      Assert.assertEquals(0,clusterConfigMapping.isSelected());
    }
  }
  cluster.applyLatestConfigurations(newStackId);
  clusterEntity=clusterDAO.findByName("c1");
  clusterConfigMappings=clusterEntity.getConfigMappingEntities();
  Assert.assertEquals(2,clusterConfigMappings.size());
  for (  ClusterConfigMappingEntity clusterConfigMapping : clusterConfigMappings) {
    if (clusterConfigMapping.getTag().equals("version-1")) {
      Assert.assertEquals(0,clusterConfigMapping.isSelected());
    }
 else {
      Assert.assertEquals(1,clusterConfigMapping.isSelected());
    }
  }
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testProvisioningState() throws Exception {
  createDefaultCluster();
  c1.setProvisioningState(State.INIT);
  Assert.assertEquals(State.INIT,c1.getProvisioningState());
  c1.setProvisioningState(State.INSTALLED);
  Assert.assertEquals(State.INSTALLED,c1.getProvisioningState());
}

</code></pre>

<pre class="type-2 type-1 type-11 type-14 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Is not executed with the test suite">IgnoredMethod</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Is not executed with the test suite
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test @Ignore public void testClusterRecovery() throws AmbariException {
  ClusterEntity entity=createDummyData();
  ClusterStateEntity clusterStateEntity=new ClusterStateEntity();
  clusterStateEntity.setCurrentStack(entity.getDesiredStack());
  entity.setClusterStateEntity(clusterStateEntity);
  ClusterImpl cluster=new ClusterImpl(entity,injector);
  Service service=cluster.getService("HDFS");
  Assert.assertEquals("HDFS",service.getName());
  Map<String,Service> services=cluster.getServices();
  Assert.assertNotNull(services.get("HDFS"));
}

</code></pre>

<pre class="type-4 type-12 type-13 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testBootstrapHostVersion() throws Exception {
  String clusterName="c1";
  String v1="2.2.0-123";
  StackId stackId=new StackId("HDP-2.2.0");
  RepositoryVersionEntity rv1=helper.getOrCreateRepositoryVersion(stackId,v1);
  Map<String,String> hostAttributes=new HashMap<String,String>();
  hostAttributes.put("os_family","redhat");
  hostAttributes.put("os_release_version","5.9");
  Cluster cluster=createClusterForRU(clusterName,stackId,hostAttributes);
  Host deadHost=cluster.getHosts().iterator().next();
  deadHost.setState(HostState.UNHEALTHY);
  int versionedComponentCount=0;
  List<HostComponentStateEntity> hostComponentStates=hostComponentStateDAO.findAll();
  for (int i=0; i < hostComponentStates.size(); i++) {
    HostComponentStateEntity hce=hostComponentStates.get(i);
    ComponentInfo compInfo=metaInfo.getComponent(stackId.getStackName(),stackId.getStackVersion(),hce.getServiceName(),hce.getComponentName());
    if (hce.getHostName().equals(deadHost.getHostName())) {
      continue;
    }
    if (compInfo.isVersionAdvertised()) {
      hce.setVersion(v1);
      hostComponentStateDAO.merge(hce);
      versionedComponentCount++;
    }
    Service svc=cluster.getService(hce.getServiceName());
    ServiceComponent svcComp=svc.getServiceComponent(hce.getComponentName());
    ServiceComponentHost scHost=svcComp.getServiceComponentHost(hce.getHostName());
    scHost.recalculateHostVersionState();
    cluster.recalculateClusterVersionState(rv1);
    Collection<ClusterVersionEntity> clusterVersions=cluster.getAllClusterVersions();
    if (versionedComponentCount > 0) {
      RepositoryVersionEntity repositoryVersion=repositoryVersionDAO.findByStackAndVersion(stackId,v1);
      Assert.assertNotNull(repositoryVersion);
      Assert.assertTrue(clusterVersions != null && clusterVersions.size() == 1);
      if (versionedComponentCount == 1 && i < (hostComponentStates.size() - 1)) {
        Assert.assertEquals(clusterVersions.iterator().next().getState(),RepositoryVersionState.CURRENT);
      }
    }
  }
}

</code></pre>

<pre class="type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void teardown(){
  injector.getInstance(UnitOfWork.class).end();
  injector.getInstance(PersistService.class).stop();
}

</code></pre>

<pre class="type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testSingleServiceVersionForMultipleConfigs() throws Exception {
  createDefaultCluster();
  Config config1=configFactory.createNew(c1,"hdfs-site",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,new HashMap<String,Map<String,String>>());
  config1.setTag("version1");
  Config config2=configFactory.createNew(c1,"core-site",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,new HashMap<String,Map<String,String>>());
  config2.setTag("version2");
  c1.addConfig(config1);
  c1.addConfig(config2);
  Set<Config> configs=new HashSet<Config>();
  configs.add(config1);
  configs.add(config2);
  c1.addDesiredConfig("admin",configs);
  List<ServiceConfigVersionResponse> serviceConfigVersions=c1.getServiceConfigVersions();
  Assert.assertNotNull(serviceConfigVersions);
  Assert.assertEquals(1,serviceConfigVersions.size());
  Assert.assertEquals(Long.valueOf(1),serviceConfigVersions.get(0).getVersion());
  Assert.assertEquals(2,c1.getDesiredConfigs().size());
  Assert.assertEquals("version1",c1.getDesiredConfigByType("hdfs-site").getTag());
  Assert.assertEquals("version2",c1.getDesiredConfigByType("core-site").getTag());
  Map<String,Collection<ServiceConfigVersionResponse>> activeServiceConfigVersions=c1.getActiveServiceConfigVersions();
  Assert.assertEquals(1,activeServiceConfigVersions.size());
}

</code></pre>

<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testRecalculateClusterVersionState() throws Exception {
  createDefaultCluster();
  Host h1=clusters.getHost("h1");
  h1.setState(HostState.HEALTHY);
  Host h2=clusters.getHost("h2");
  h2.setState(HostState.HEALTHY);
  StackId stackId=new StackId("HDP-0.1");
  final String stackVersion="0.1-1000";
  RepositoryVersionEntity repositoryVersionEntity=helper.getOrCreateRepositoryVersion(stackId,stackVersion);
  c1.createClusterVersion(stackId,stackVersion,"admin",RepositoryVersionState.INSTALLING);
  c1.setCurrentStackVersion(stackId);
  HostVersionEntity hv1=helper.createHostVersion("h1",repositoryVersionEntity,RepositoryVersionState.INSTALLING);
  HostVersionEntity hv2=helper.createHostVersion("h2",repositoryVersionEntity,RepositoryVersionState.INSTALLING);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  h2.setState(HostState.UNHEALTHY);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  hv1.setState(RepositoryVersionState.INSTALL_FAILED);
  hostVersionDAO.merge(hv1);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  h2.setState(HostState.HEALTHY);
  hv2.setState(RepositoryVersionState.INSTALLED);
  hostVersionDAO.merge(hv2);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALL_FAILED);
  c1.transitionClusterVersion(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  h2.setState(HostState.HEALTHY);
  hv2.setState(RepositoryVersionState.INSTALLED);
  hostVersionDAO.merge(hv2);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  hv1.setState(RepositoryVersionState.INSTALL_FAILED);
  hostVersionDAO.merge(hv1);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALL_FAILED);
  c1.transitionClusterVersion(stackId,stackVersion,RepositoryVersionState.INSTALLING);
  hv1.setState(RepositoryVersionState.INSTALLED);
  hostVersionDAO.merge(hv1);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.INSTALLED);
  hv1.setState(RepositoryVersionState.UPGRADING);
  hostVersionDAO.merge(hv1);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.UPGRADING);
  hv1.setState(RepositoryVersionState.UPGRADED);
  hostVersionDAO.merge(hv1);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.UPGRADING);
  hv1.setState(RepositoryVersionState.UPGRADING);
  hv2.setState(RepositoryVersionState.UPGRADING);
  hostVersionDAO.merge(hv2);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.UPGRADING);
  hv2.setState(RepositoryVersionState.UPGRADE_FAILED);
  hostVersionDAO.merge(hv2);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.UPGRADE_FAILED);
  c1.transitionClusterVersion(stackId,stackVersion,RepositoryVersionState.UPGRADING);
  hv2.setState(RepositoryVersionState.UPGRADED);
  hostVersionDAO.merge(hv2);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.UPGRADING);
  hv1.setState(RepositoryVersionState.UPGRADED);
  hostVersionDAO.merge(hv1);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.UPGRADED);
  hv1.setState(RepositoryVersionState.CURRENT);
  hostVersionDAO.merge(hv1);
  hv2.setState(RepositoryVersionState.CURRENT);
  hostVersionDAO.merge(hv2);
  c1.recalculateClusterVersionState(repositoryVersionEntity);
  checkStackVersionState(stackId,stackVersion,RepositoryVersionState.CURRENT);
}

</code></pre>

<pre class="type-2 type-5 type-1 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testGetServiceComponentHosts() throws Exception {
  createDefaultCluster();
  Service s=serviceFactory.createNew(c1,"HDFS");
  c1.addService(s);
  s.persist();
  ServiceComponent sc=serviceComponentFactory.createNew(s,"NAMENODE");
  s.addServiceComponent(sc);
  sc.persist();
  ServiceComponentHost sch=serviceComponentHostFactory.createNew(sc,"h1");
  sc.addServiceComponentHost(sch);
  sch.persist();
  List<ServiceComponentHost> scHosts=c1.getServiceComponentHosts("h1");
  Assert.assertEquals(1,scHosts.size());
  Iterator<ServiceComponentHost> iterator=scHosts.iterator();
  try {
    while (iterator.hasNext()) {
      iterator.next();
      Service s1=serviceFactory.createNew(c1,"PIG");
      c1.addService(s1);
      s1.persist();
      ServiceComponent sc1=serviceComponentFactory.createNew(s1,"PIG");
      s1.addServiceComponent(sc1);
      sc1.persist();
      ServiceComponentHost sch1=serviceComponentHostFactory.createNew(sc1,"h1");
      sc1.addServiceComponentHost(sch1);
      sch1.persist();
    }
  }
 catch (  ConcurrentModificationException e) {
    Assert.assertTrue("Failed to work concurrently with sch",false);
  }
  scHosts=c1.getServiceComponentHosts("h1");
  Assert.assertEquals(2,scHosts.size());
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testGetHostState() throws Exception {
  createDefaultCluster();
  Assert.assertEquals(HostState.INIT,clusters.getHost("h1").getState());
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransitionHostVersionState_OutOfSync_BlankCurrent() throws Exception {
  StackId stackId=new StackId("HDP-2.0.5");
  String clusterName="c1";
  clusters.addCluster(clusterName,stackId);
  final Cluster c1=clusters.getCluster(clusterName);
  Assert.assertEquals(clusterName,c1.getClusterName());
  Assert.assertEquals(1,c1.getClusterId());
  clusters.addHost("h-1");
  clusters.addHost("h-2");
  String h3="h-3";
  clusters.addHost(h3);
  for (  String hostName : new String[]{"h-1","h-2",h3}) {
    Host h=clusters.getHost(hostName);
    h.setIPv4("ipv4");
    h.setIPv6("ipv6");
    Map<String,String> hostAttributes=new HashMap<String,String>();
    hostAttributes.put("os_family","redhat");
    hostAttributes.put("os_release_version","5.9");
    h.setHostAttributes(hostAttributes);
    h.persist();
  }
  String v1="2.0.5-1";
  String v2="2.0.5-2";
  c1.setDesiredStackVersion(stackId);
  RepositoryVersionEntity rve1=helper.getOrCreateRepositoryVersion(stackId,v1);
  RepositoryVersionEntity rve2=helper.getOrCreateRepositoryVersion(stackId,v2);
  c1.setCurrentStackVersion(stackId);
  c1.createClusterVersion(stackId,v1,"admin",RepositoryVersionState.UPGRADING);
  c1.transitionClusterVersion(stackId,v1,RepositoryVersionState.CURRENT);
  clusters.mapHostToCluster("h-1",clusterName);
  clusters.mapHostToCluster("h-2",clusterName);
  ClusterVersionDAOMock.failOnCurrentVersionState=false;
  Service service=c1.addService("ZOOKEEPER");
  ServiceComponent sc=service.addServiceComponent("ZOOKEEPER_SERVER");
  sc.addServiceComponentHost("h-1");
  sc.addServiceComponentHost("h-2");
  c1.createClusterVersion(stackId,v2,"admin",RepositoryVersionState.INSTALLING);
  c1.transitionClusterVersion(stackId,v2,RepositoryVersionState.INSTALLED);
  c1.transitionClusterVersion(stackId,v2,RepositoryVersionState.OUT_OF_SYNC);
  clusters.mapHostToCluster(h3,clusterName);
  HostEntity hostEntity3=mock(HostEntity.class);
  when(hostEntity3.getHostName()).thenReturn(h3);
  HostVersionDAO hostVersionDAOMock=mock(HostVersionDAO.class);
  Field field=ClusterImpl.class.getDeclaredField("hostVersionDAO");
  field.setAccessible(true);
  field.set(c1,hostVersionDAOMock);
  ArgumentCaptor<HostVersionEntity> hostVersionCaptor=ArgumentCaptor.forClass(HostVersionEntity.class);
  ClusterVersionDAOMock.mockedClusterVersions=new ArrayList<ClusterVersionEntity>(){
{
      addAll(c1.getAllClusterVersions());
    }
  }
;
  c1.transitionHostVersionState(hostEntity3,rve1,stackId);
  ClusterVersionDAOMock.mockedClusterVersions=null;
  verify(hostVersionDAOMock).merge(hostVersionCaptor.capture());
  assertEquals(hostVersionCaptor.getValue().getState(),RepositoryVersionState.CURRENT);
}

</code></pre>

<pre class="type-4 type-12 type-13 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Comprehensive test for transitionHostVersion and recalculateClusterVersion.
 * It creates a cluster with 3 hosts and 3 services, one of which does not advertise a version.
 * It then verifies that all 3 hosts have a version of CURRENT, and so does the cluster.
 * It then adds one more host with a component, so its HostVersion will initialize in CURRENT.
 * Next, it distributes a repo so that it is INSTALLED on the 4 hosts.
 * It then adds one more host, whose HostVersion will be OUT_OF_SYNC for the new repo.
 * After redistributing bits again, it simulates an RU.
 * Finally, some of the hosts will end up with a HostVersion in UPGRADED, and others still in INSTALLED.
 * @throws Exception
 */
@Test public void testTransitionHostVersionAdvanced() throws Exception {
  String clusterName="c1";
  String v1="2.2.0-123";
  StackId stackId=new StackId("HDP-2.2.0");
  RepositoryVersionEntity rv1=helper.getOrCreateRepositoryVersion(stackId,v1);
  Map<String,String> hostAttributes=new HashMap<String,String>();
  hostAttributes.put("os_family","redhat");
  hostAttributes.put("os_release_version","5.9");
  Cluster cluster=createClusterForRU(clusterName,stackId,hostAttributes);
  int versionedComponentCount=0;
  List<HostComponentStateEntity> hostComponentStates=hostComponentStateDAO.findAll();
  for (int i=0; i < hostComponentStates.size(); i++) {
    HostComponentStateEntity hce=hostComponentStates.get(i);
    ComponentInfo compInfo=metaInfo.getComponent(stackId.getStackName(),stackId.getStackVersion(),hce.getServiceName(),hce.getComponentName());
    if (compInfo.isVersionAdvertised()) {
      hce.setVersion(v1);
      hostComponentStateDAO.merge(hce);
      versionedComponentCount++;
    }
    Service svc=cluster.getService(hce.getServiceName());
    ServiceComponent svcComp=svc.getServiceComponent(hce.getComponentName());
    ServiceComponentHost scHost=svcComp.getServiceComponentHost(hce.getHostName());
    scHost.recalculateHostVersionState();
    cluster.recalculateClusterVersionState(rv1);
    Collection<ClusterVersionEntity> clusterVersions=cluster.getAllClusterVersions();
    if (versionedComponentCount > 0) {
      RepositoryVersionEntity repositoryVersion=repositoryVersionDAO.findByStackAndVersion(stackId,v1);
      Assert.assertNotNull(repositoryVersion);
      Assert.assertTrue(clusterVersions != null && clusterVersions.size() == 1);
      if (versionedComponentCount == 1 && i < (hostComponentStates.size() - 1)) {
        Assert.assertEquals(clusterVersions.iterator().next().getState(),RepositoryVersionState.UPGRADING);
      }
      if (i == hostComponentStates.size() - 1) {
        Assert.assertEquals(clusterVersions.iterator().next().getState(),RepositoryVersionState.CURRENT);
      }
    }
  }
  addHost("h-4",hostAttributes);
  clusters.mapHostToCluster("h-4",clusterName);
  Service svc2=cluster.getService("ZOOKEEPER");
  Service svc3=cluster.getService("GANGLIA");
  ServiceComponent sc2CompA=svc2.getServiceComponent("ZOOKEEPER_SERVER");
  ServiceComponent sc2CompB=svc2.getServiceComponent("ZOOKEEPER_CLIENT");
  ServiceComponent sc3CompB=svc3.getServiceComponent("GANGLIA_MONITOR");
  ServiceComponentHost schHost4Serv2CompA=serviceComponentHostFactory.createNew(sc2CompA,"h-4");
  ServiceComponentHost schHost4Serv2CompB=serviceComponentHostFactory.createNew(sc2CompB,"h-4");
  ServiceComponentHost schHost4Serv3CompB=serviceComponentHostFactory.createNew(sc3CompB,"h-4");
  sc2CompA.addServiceComponentHost(schHost4Serv2CompA);
  sc2CompB.addServiceComponentHost(schHost4Serv2CompB);
  sc3CompB.addServiceComponentHost(schHost4Serv3CompB);
  schHost4Serv2CompA.persist();
  schHost4Serv2CompB.persist();
  schHost4Serv3CompB.persist();
  simulateStackVersionListener(stackId,v1,cluster,hostComponentStateDAO.findByHost("h-4"));
  Collection<HostVersionEntity> hostVersions=hostVersionDAO.findAll();
  Assert.assertEquals(hostVersions.size(),clusters.getHosts().size());
  HostVersionEntity h4Version1=hostVersionDAO.findByClusterStackVersionAndHost(clusterName,stackId,v1,"h-4");
  Assert.assertNotNull(h4Version1);
  Assert.assertEquals(h4Version1.getState(),RepositoryVersionState.CURRENT);
  String v2="2.2.0-456";
  RepositoryVersionEntity rv2=helper.getOrCreateRepositoryVersion(stackId,v2);
  for (  String hostName : clusters.getHostsForCluster(clusterName).keySet()) {
    HostEntity host=hostDAO.findByName(hostName);
    HostVersionEntity hve=new HostVersionEntity(host,rv2,RepositoryVersionState.INSTALLED);
    hostVersionDAO.create(hve);
  }
  cluster.createClusterVersion(stackId,v2,"admin",RepositoryVersionState.INSTALLING);
  cluster.transitionClusterVersion(stackId,v2,RepositoryVersionState.INSTALLED);
  ClusterVersionEntity cv2=clusterVersionDAO.findByClusterAndStackAndVersion(clusterName,stackId,v2);
  Assert.assertNotNull(cv2);
  Assert.assertEquals(cv2.getState(),RepositoryVersionState.INSTALLED);
  addHost("h-5",hostAttributes);
  clusters.mapHostToCluster("h-5",clusterName);
  ServiceComponentHost schHost5Serv3CompB=serviceComponentHostFactory.createNew(sc3CompB,"h-5");
  sc3CompB.addServiceComponentHost(schHost5Serv3CompB);
  schHost5Serv3CompB.persist();
  HostVersionEntity h5Version2=hostVersionDAO.findByClusterStackVersionAndHost(clusterName,stackId,v2,"h-5");
  Assert.assertNotNull(h5Version2);
  Assert.assertEquals(h5Version2.getState(),RepositoryVersionState.OUT_OF_SYNC);
  h5Version2.setState(RepositoryVersionState.INSTALLED);
  hostVersionDAO.merge(h5Version2);
  versionedComponentCount=0;
  hostComponentStates=hostComponentStateDAO.findAll();
  for (int i=0; i < hostComponentStates.size(); i++) {
    HostComponentStateEntity hce=hostComponentStates.get(i);
    ComponentInfo compInfo=metaInfo.getComponent(stackId.getStackName(),stackId.getStackVersion(),hce.getServiceName(),hce.getComponentName());
    if (compInfo.isVersionAdvertised()) {
      hce.setVersion(v2);
      hostComponentStateDAO.merge(hce);
      versionedComponentCount++;
    }
    Service svc=cluster.getService(hce.getServiceName());
    ServiceComponent svcComp=svc.getServiceComponent(hce.getComponentName());
    ServiceComponentHost scHost=svcComp.getServiceComponentHost(hce.getHostName());
    scHost.recalculateHostVersionState();
    cluster.recalculateClusterVersionState(rv2);
    Collection<ClusterVersionEntity> clusterVersions=cluster.getAllClusterVersions();
    if (versionedComponentCount > 0) {
      RepositoryVersionEntity repositoryVersion=repositoryVersionDAO.findByStackAndVersion(stackId,v2);
      Assert.assertNotNull(repositoryVersion);
      Assert.assertTrue(clusterVersions != null && clusterVersions.size() == 2);
      if (versionedComponentCount == 1 && i < (hostComponentStates.size() - 1)) {
        cv2=clusterVersionDAO.findByClusterAndStackAndVersion(clusterName,stackId,v2);
        Assert.assertEquals(cv2.getState(),RepositoryVersionState.UPGRADING);
      }
    }
  }
  cv2=clusterVersionDAO.findByClusterAndStackAndVersion(clusterName,stackId,v2);
  Assert.assertEquals(cv2.getState(),RepositoryVersionState.UPGRADING);
  Collection<HostVersionEntity> v2HostVersions=hostVersionDAO.findByClusterStackAndVersion(clusterName,stackId,v2);
  Assert.assertEquals(v2HostVersions.size(),clusters.getHostsForCluster(clusterName).size());
  for (  HostVersionEntity hve : v2HostVersions) {
    if (hve.getHostName().equals("h-3") || hve.getHostName().equals("h-5")) {
      Assert.assertEquals(hve.getState(),RepositoryVersionState.INSTALLED);
    }
 else {
      Assert.assertEquals(hve.getState(),RepositoryVersionState.UPGRADED);
    }
  }
}

</code></pre>

<pre class="type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testRecalculateAllClusterVersionStates() throws Exception {
  createDefaultCluster();
  Host h1=clusters.getHost("h1");
  h1.setState(HostState.HEALTHY);
  Host h2=clusters.getHost("h2");
  h2.setState(HostState.HEALTHY);
  StackId stackId=new StackId("HDP-0.1");
  RepositoryVersionEntity repositoryVersionEntity=helper.getOrCreateRepositoryVersion(stackId,"0.1-1000");
  c1.createClusterVersion(stackId,"0.1-1000","admin",RepositoryVersionState.INSTALLING);
  c1.setCurrentStackVersion(stackId);
  c1.recalculateAllClusterVersionStates();
  checkStackVersionState(stackId,"0.1-1000",RepositoryVersionState.INSTALLING);
  checkStackVersionState(stackId,"0.1-2086",RepositoryVersionState.CURRENT);
  HostVersionEntity hv1=helper.createHostVersion("h1",repositoryVersionEntity,RepositoryVersionState.INSTALLING);
  HostVersionEntity hv2=helper.createHostVersion("h2",repositoryVersionEntity,RepositoryVersionState.INSTALLING);
  c1.recalculateAllClusterVersionStates();
  checkStackVersionState(stackId,"0.1-1000",RepositoryVersionState.INSTALLING);
  checkStackVersionState(stackId,"1.0-2086",RepositoryVersionState.CURRENT);
  hv1.setState(RepositoryVersionState.INSTALL_FAILED);
  hostVersionDAO.merge(hv1);
  c1.recalculateAllClusterVersionStates();
  checkStackVersionState(stackId,"0.1-1000",RepositoryVersionState.INSTALL_FAILED);
  checkStackVersionState(stackId,"0.1-2086",RepositoryVersionState.CURRENT);
  c1.transitionClusterVersion(stackId,"0.1-1000",RepositoryVersionState.INSTALLING);
  hv1.setState(RepositoryVersionState.CURRENT);
  hostVersionDAO.merge(hv1);
  c1.recalculateAllClusterVersionStates();
  checkStackVersionState(stackId,"0.1-1000",RepositoryVersionState.OUT_OF_SYNC);
  checkStackVersionState(stackId,"0.1-2086",RepositoryVersionState.CURRENT);
}

</code></pre>

<pre class="type-2 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testGetAndSetConfigs() throws Exception {
  createDefaultCluster();
  Map<String,Map<String,String>> c1PropAttributes=new HashMap<String,Map<String,String>>();
  c1PropAttributes.put("final",new HashMap<String,String>());
  c1PropAttributes.get("final").put("a","true");
  Map<String,Map<String,String>> c2PropAttributes=new HashMap<String,Map<String,String>>();
  c2PropAttributes.put("final",new HashMap<String,String>());
  c2PropAttributes.get("final").put("x","true");
  Config config1=configFactory.createNew(c1,"global",new HashMap<String,String>(){
{
      put("a","b");
    }
  }
,c1PropAttributes);
  config1.setTag("version1");
  Config config2=configFactory.createNew(c1,"global",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,c2PropAttributes);
  config2.setTag("version2");
  Config config3=configFactory.createNew(c1,"core-site",new HashMap<String,String>(){
{
      put("x","y");
    }
  }
,new HashMap<String,Map<String,String>>());
  config3.setTag("version2");
  c1.addConfig(config1);
  c1.addConfig(config2);
  c1.addConfig(config3);
  c1.addDesiredConfig("_test",Collections.singleton(config1));
  Config res=c1.getDesiredConfigByType("global");
  Assert.assertNotNull("Expected non-null config",res);
  Assert.assertEquals("true",res.getPropertiesAttributes().get("final").get("a"));
  res=c1.getDesiredConfigByType("core-site");
  Assert.assertNull("Expected null config",res);
  c1.addDesiredConfig("_test",Collections.singleton(config2));
  res=c1.getDesiredConfigByType("global");
  Assert.assertEquals("Expected version tag to be 'version2'","version2",res.getTag());
  Assert.assertEquals("true",res.getPropertiesAttributes().get("final").get("x"));
}

</code></pre>

<pre class="type-10 type-2 type-5 type-1 type-11 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testAddAndGetServices() throws Exception {
  createDefaultCluster();
  Service s1=serviceFactory.createNew(c1,"HDFS");
  Service s2=serviceFactory.createNew(c1,"MAPREDUCE");
  c1.addService(s1);
  c1.addService(s2);
  s1.persist();
  s2.persist();
  Service s3=serviceFactory.createNew(c1,"MAPREDUCE");
  try {
    c1.addService(s3);
    fail("Expected error on adding dup service");
  }
 catch (  Exception e) {
  }
  Service s=c1.getService("HDFS");
  Assert.assertNotNull(s);
  Assert.assertEquals("HDFS",s.getName());
  Assert.assertEquals(c1.getClusterId(),s.getClusterId());
  try {
    c1.getService("HBASE");
    fail("Expected error for unknown service");
  }
 catch (  Exception e) {
  }
  Map<String,Service> services=c1.getServices();
  Assert.assertEquals(2,services.size());
  Assert.assertTrue(services.containsKey("HDFS"));
  Assert.assertTrue(services.containsKey("MAPREDUCE"));
}

</code></pre>

<pre class="type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testConvertToResponse() throws Exception {
  createDefaultCluster();
  ClusterResponse r=c1.convertToResponse();
  Assert.assertEquals(c1.getClusterId(),r.getClusterId().longValue());
  Assert.assertEquals(c1.getClusterName(),r.getClusterName());
  Assert.assertEquals(Integer.valueOf(2),r.getTotalHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getAlertStatusHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getHealthyStatusHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getUnhealthyStatusHosts());
  Assert.assertEquals(2,r.getClusterHealthReport().getUnknownStatusHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getStaleConfigsHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getMaintenanceStateHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getHealthyStateHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getHeartbeatLostStateHosts());
  Assert.assertEquals(2,r.getClusterHealthReport().getInitStateHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getUnhealthyStateHosts());
  clusters.addHost("h3");
  Host host=clusters.getHost("h3");
  host.setIPv4("ipv4");
  host.setIPv6("ipv6");
  Map<String,String> hostAttributes=new HashMap<String,String>();
  hostAttributes.put("os_family","redhat");
  hostAttributes.put("os_release_version","5.9");
  host.setHostAttributes(hostAttributes);
  host.setState(HostState.HEALTHY);
  host.setHealthStatus(new HostHealthStatus(HostHealthStatus.HealthStatus.HEALTHY,""));
  host.setStatus(host.getHealthStatus().getHealthStatus().name());
  host.persist();
  c1.setDesiredStackVersion(new StackId("HDP-2.0.6"));
  clusters.mapHostToCluster("h3","c1");
  r=c1.convertToResponse();
  Assert.assertEquals(Integer.valueOf(3),r.getTotalHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getAlertStatusHosts());
  Assert.assertEquals(1,r.getClusterHealthReport().getHealthyStatusHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getUnhealthyStatusHosts());
  Assert.assertEquals(2,r.getClusterHealthReport().getUnknownStatusHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getStaleConfigsHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getMaintenanceStateHosts());
  Assert.assertEquals(1,r.getClusterHealthReport().getHealthyStateHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getHeartbeatLostStateHosts());
  Assert.assertEquals(2,r.getClusterHealthReport().getInitStateHosts());
  Assert.assertEquals(0,r.getClusterHealthReport().getUnhealthyStateHosts());
  StringBuilder sb=new StringBuilder();
  c1.debugDump(sb);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
