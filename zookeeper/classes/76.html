<h3 style="margin:0px">Class: org.apache.zookeeper.server.quorum.Zab1_0Test (13 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(12)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(11)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="14"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('14')" data-toggle="tooltip" title="Verifies values related to public fields."><kbd id="tag-14"class="label-info"style="display: inline-block;font-size:7pt" >PublicFieldVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-5 type-3 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * In this test, the leader sets the last accepted epoch to 5. The call
 * to getEpochToPropose should set epoch to 6 and wait until another 
 * follower executes it. If in getEpochToPropose we don't check if
 * lastAcceptedEpoch == epoch, then the call from the subsequent
 * follower with lastAcceptedEpoch = 6 doesn't change the value
 * of epoch, and the test fails. It passes with the fix to predicate.{@link https://issues.apache.org/jira/browse/ZOOKEEPER-1343}
 * @throws Exception
 */
@Test public void testLastAcceptedEpoch() throws Exception {
  File tmpDir=File.createTempFile("test","dir",testData);
  tmpDir.delete();
  tmpDir.mkdir();
  Leader leader=null;
  LeadThread leadThread=null;
  try {
    QuorumPeer peer=createQuorumPeer(tmpDir);
    leader=createMockLeader(tmpDir,peer);
    peer.leader=leader;
    peer.setAcceptedEpoch(5);
    leadThread=new LeadThread(leader);
    leadThread.start();
    while (((MockLeader)leader).getCurrentEpochToPropose() != 6) {
      Thread.sleep(20);
    }
    try {
      long epoch=leader.getEpochToPropose(1,6);
      Assert.assertEquals("New proposed epoch is wrong",7,epoch);
    }
 catch (    Exception e) {
      Assert.fail("Timed out in getEpochToPropose");
    }
  }
  finally {
    if (leader != null) {
      leader.shutdown("end of test");
    }
    if (leadThread != null) {
      leadThread.interrupt();
      leadThread.join();
    }
    TestUtils.deleteFileRecursively(tmpDir);
  }
}

</code></pre>

<pre class="type-3 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testTxnTimeout() throws Exception {
  testLeaderConversation(new LeaderConversation(){
    public void converseWithLeader(    InputArchive ia,    OutputArchive oa,    Leader l) throws IOException, InterruptedException, org.apache.zookeeper.server.quorum.Leader.XidRolloverException {
      Assert.assertEquals(0,l.self.getAcceptedEpoch());
      Assert.assertEquals(0,l.self.getCurrentEpoch());
      LearnerInfo li=new LearnerInfo(1,0x10000,0);
      byte liBytes[]=new byte[20];
      ByteBufferOutputStream.record2ByteBuffer(li,ByteBuffer.wrap(liBytes));
      QuorumPacket qp=new QuorumPacket(Leader.FOLLOWERINFO,0,liBytes,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.LEADERINFO,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
      Assert.assertEquals(ByteBuffer.wrap(qp.getData()).getInt(),0x10000);
      Assert.assertEquals(1,l.self.getAcceptedEpoch());
      Assert.assertEquals(0,l.self.getCurrentEpoch());
      qp=new QuorumPacket(Leader.ACKEPOCH,0,new byte[4],null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.DIFF,qp.getType());
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.NEWLEADER,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
      Assert.assertEquals(1,l.self.getAcceptedEpoch());
      Assert.assertEquals(1,l.self.getCurrentEpoch());
      qp=new QuorumPacket(Leader.ACK,qp.getZxid(),null,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.UPTODATE,qp.getType());
      long zxid=l.zk.getZxid();
      l.propose(new Request(1,1,ZooDefs.OpCode.create,new TxnHeader(1,1,zxid,1,ZooDefs.OpCode.create),new CreateTxn("/test","hola".getBytes(),null,true,0),zxid));
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.PROPOSAL,qp.getType());
      LOG.info("Proposal sent.");
      for (int i=0; i < (2 * SYNC_LIMIT) + 2; i++) {
        try {
          ia.readRecord(qp,null);
          LOG.info("Ping received: " + i);
          qp=new QuorumPacket(Leader.PING,qp.getZxid(),"".getBytes(),null);
          oa.writeRecord(qp,null);
        }
 catch (        EOFException e) {
          return;
        }
      }
      Assert.fail("Connection hasn't been closed by leader after transaction times out.");
    }
  }
);
}

</code></pre>

<pre class="type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testLeaderBehind() throws Exception {
  testLeaderConversation(new LeaderConversation(){
    public void converseWithLeader(    InputArchive ia,    OutputArchive oa,    Leader l) throws IOException {
      LearnerInfo li=new LearnerInfo(1,0x10000,0);
      byte liBytes[]=new byte[20];
      ByteBufferOutputStream.record2ByteBuffer(li,ByteBuffer.wrap(liBytes));
      QuorumPacket qp=new QuorumPacket(Leader.FOLLOWERINFO,ZxidUtils.makeZxid(20,0),liBytes,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.LEADERINFO,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(21,0),qp.getZxid());
      Assert.assertEquals(ByteBuffer.wrap(qp.getData()).getInt(),0x10000);
      qp=new QuorumPacket(Leader.ACKEPOCH,0,new byte[4],null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.DIFF,qp.getType());
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.NEWLEADER,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(21,0),qp.getZxid());
      qp=new QuorumPacket(Leader.ACK,qp.getZxid(),null,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.UPTODATE,qp.getType());
    }
  }
);
}

</code></pre>

<pre class="type-5 type-6 type-4 type-14 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
"></span><br>
@Test public void testNormalFollowerRun() throws Exception {
  testFollowerConversation(new FollowerConversation(){
    @Override public void converseWithFollower(    InputArchive ia,    OutputArchive oa,    Follower f) throws Exception {
      File tmpDir=File.createTempFile("test","dir",testData);
      tmpDir.delete();
      tmpDir.mkdir();
      File logDir=f.fzk.getTxnLogFactory().getDataDir().getParentFile();
      File snapDir=f.fzk.getTxnLogFactory().getSnapDir().getParentFile();
      try {
        Assert.assertEquals(0,f.self.getAcceptedEpoch());
        Assert.assertEquals(0,f.self.getCurrentEpoch());
        ZKDatabase zkDb=new ZKDatabase(new FileTxnSnapLog(tmpDir,tmpDir));
        final long firstZxid=ZxidUtils.makeZxid(1,1);
        zkDb.processTxn(new TxnHeader(13,1313,firstZxid,33,ZooDefs.OpCode.create),new CreateTxn("/foo","data1".getBytes(),ZooDefs.Ids.OPEN_ACL_UNSAFE,false,1));
        Stat stat=new Stat();
        Assert.assertEquals("data1",new String(zkDb.getData("/foo",stat,null)));
        QuorumPacket qp=new QuorumPacket();
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.FOLLOWERINFO,qp.getType());
        Assert.assertEquals(qp.getZxid(),0);
        LearnerInfo learnInfo=new LearnerInfo();
        ByteBufferInputStream.byteBuffer2Record(ByteBuffer.wrap(qp.getData()),learnInfo);
        Assert.assertEquals(learnInfo.getProtocolVersion(),0x10000);
        Assert.assertEquals(learnInfo.getServerid(),0);
        qp.setType(Leader.LEADERINFO);
        qp.setZxid(ZxidUtils.makeZxid(1,0));
        byte protoBytes[]=new byte[4];
        ByteBuffer.wrap(protoBytes).putInt(0x10000);
        qp.setData(protoBytes);
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACKEPOCH,qp.getType());
        Assert.assertEquals(0,qp.getZxid());
        Assert.assertEquals(ZxidUtils.makeZxid(0,0),ByteBuffer.wrap(qp.getData()).getInt());
        Assert.assertEquals(1,f.self.getAcceptedEpoch());
        Assert.assertEquals(0,f.self.getCurrentEpoch());
        qp.setType(Leader.SNAP);
        qp.setData(new byte[0]);
        qp.setZxid(zkDb.getDataTreeLastProcessedZxid());
        oa.writeRecord(qp,null);
        zkDb.serializeSnapshot(oa);
        oa.writeString("BenWasHere",null);
        qp.setType(Leader.NEWLEADER);
        qp.setZxid(ZxidUtils.makeZxid(1,0));
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
        Assert.assertEquals(1,f.self.getAcceptedEpoch());
        Assert.assertEquals(1,f.self.getCurrentEpoch());
        Assert.assertEquals(firstZxid,f.fzk.getLastProcessedZxid());
        ZKDatabase zkDb2=new ZKDatabase(new FileTxnSnapLog(logDir,snapDir));
        long lastZxid=zkDb2.loadDataBase();
        Assert.assertEquals("data1",new String(zkDb2.getData("/foo",stat,null)));
        Assert.assertEquals(firstZxid,lastZxid);
        long proposalZxid=ZxidUtils.makeZxid(1,1000);
        proposeSetData(qp,proposalZxid,"data2",2);
        oa.writeRecord(qp,null);
        TrackerWatcher watcher=new TrackerWatcher();
        Assert.assertEquals("data1",new String(f.fzk.getZKDatabase().getData("/foo",stat,watcher)));
        qp.setType(Leader.COMMIT);
        qp.setZxid(proposalZxid);
        oa.writeRecord(qp,null);
        qp.setType(Leader.UPTODATE);
        qp.setZxid(0);
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(proposalZxid,qp.getZxid());
        watcher.waitForChange();
        Assert.assertEquals("data2",new String(f.fzk.getZKDatabase().getData("/foo",stat,null)));
        zkDb2=new ZKDatabase(new FileTxnSnapLog(logDir,snapDir));
        lastZxid=zkDb2.loadDataBase();
        Assert.assertEquals("data2",new String(zkDb2.getData("/foo",stat,null)));
        Assert.assertEquals(proposalZxid,lastZxid);
      }
  finally {
        TestUtils.deleteFileRecursively(tmpDir);
      }
    }
    private void proposeSetData(    QuorumPacket qp,    long zxid,    String data,    int version) throws IOException {
      qp.setType(Leader.PROPOSAL);
      qp.setZxid(zxid);
      TxnHeader hdr=new TxnHeader(4,1414,qp.getZxid(),55,ZooDefs.OpCode.setData);
      SetDataTxn sdt=new SetDataTxn("/foo",data.getBytes(),version);
      ByteArrayOutputStream baos=new ByteArrayOutputStream();
      OutputArchive boa=BinaryOutputArchive.getArchive(baos);
      boa.writeRecord(hdr,null);
      boa.writeRecord(sdt,null);
      qp.setData(baos.toByteArray());
    }
  }
);
}

</code></pre>

<pre class="type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testNormalRun() throws Exception {
  testLeaderConversation(new LeaderConversation(){
    public void converseWithLeader(    InputArchive ia,    OutputArchive oa,    Leader l) throws IOException {
      Assert.assertEquals(0,l.self.getAcceptedEpoch());
      Assert.assertEquals(0,l.self.getCurrentEpoch());
      LearnerInfo li=new LearnerInfo(1,0x10000,0);
      byte liBytes[]=new byte[20];
      ByteBufferOutputStream.record2ByteBuffer(li,ByteBuffer.wrap(liBytes));
      QuorumPacket qp=new QuorumPacket(Leader.FOLLOWERINFO,0,liBytes,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.LEADERINFO,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
      Assert.assertEquals(ByteBuffer.wrap(qp.getData()).getInt(),0x10000);
      Assert.assertEquals(1,l.self.getAcceptedEpoch());
      Assert.assertEquals(0,l.self.getCurrentEpoch());
      qp=new QuorumPacket(Leader.ACKEPOCH,0,new byte[4],null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.DIFF,qp.getType());
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.NEWLEADER,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
      Assert.assertEquals(1,l.self.getAcceptedEpoch());
      Assert.assertEquals(1,l.self.getCurrentEpoch());
      qp=new QuorumPacket(Leader.ACK,qp.getZxid(),null,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.UPTODATE,qp.getType());
    }
  }
);
}

</code></pre>

<pre class="type-5 type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testInitialAcceptedCurrent() throws Exception {
  File tmpDir=File.createTempFile("test",".dir",testData);
  tmpDir.delete();
  tmpDir.mkdir();
  try {
    FileTxnSnapLog logFactory=new FileTxnSnapLog(tmpDir,tmpDir);
    File version2=new File(tmpDir,"version-2");
    version2.mkdir();
    long zxid=ZxidUtils.makeZxid(3,3);
    logFactory.append(new Request(1,1,ZooDefs.OpCode.error,new TxnHeader(1,1,zxid,1,ZooDefs.OpCode.error),new ErrorTxn(1),zxid));
    logFactory.commit();
    ZKDatabase zkDb=new ZKDatabase(logFactory);
    QuorumPeer peer=new QuorumPeer();
    peer.setZKDatabase(zkDb);
    peer.setTxnFactory(logFactory);
    peer.getLastLoggedZxid();
    Assert.assertEquals(3,peer.getAcceptedEpoch());
    Assert.assertEquals(3,peer.getCurrentEpoch());
    Assert.assertEquals(3,Integer.parseInt(readContentsOfFile(new File(version2,QuorumPeer.CURRENT_EPOCH_FILENAME))));
    Assert.assertEquals(3,Integer.parseInt(readContentsOfFile(new File(version2,QuorumPeer.ACCEPTED_EPOCH_FILENAME))));
  }
  finally {
    TestUtils.deleteFileRecursively(tmpDir);
  }
}

</code></pre>

<pre class="type-13 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setUp(){
  System.setProperty("zookeeper.admin.enableServer","false");
}

</code></pre>

<pre class="type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
/** 
 * Tests that when a quorum of followers send LearnerInfo but do not ack the epoch (which is sent
 * by the leader upon receipt of LearnerInfo from a quorum), the leader does not start using this epoch
 * as it would in the normal case (when a quorum do ack the epoch). This tests ZK-1192
 * @throws Exception
 */
@Test public void testAbandonBeforeACKEpoch() throws Exception {
  testLeaderConversation(new LeaderConversation(){
    public void converseWithLeader(    InputArchive ia,    OutputArchive oa,    Leader l) throws IOException, InterruptedException {
      LearnerInfo li=new LearnerInfo(1,0x10000,0);
      byte liBytes[]=new byte[20];
      ByteBufferOutputStream.record2ByteBuffer(li,ByteBuffer.wrap(liBytes));
      QuorumPacket qp=new QuorumPacket(Leader.FOLLOWERINFO,0,liBytes,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.LEADERINFO,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
      Assert.assertEquals(ByteBuffer.wrap(qp.getData()).getInt(),0x10000);
      Thread.sleep(l.self.getInitLimit() * l.self.getTickTime() + 5000);
      Assert.assertEquals(0,l.self.getCurrentEpoch());
    }
  }
);
}

</code></pre>

<pre class="type-5 type-2 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testLeaderInElectingFollowers() throws Exception {
  File tmpDir=File.createTempFile("test","dir",testData);
  tmpDir.delete();
  tmpDir.mkdir();
  Leader leader=null;
  try {
    QuorumPeer peer=createQuorumPeer(tmpDir);
    leader=createLeader(tmpDir,peer);
    peer.leader=leader;
    FollowerMockThread f1=new FollowerMockThread(1,leader,false);
    FollowerMockThread f2=new FollowerMockThread(2,leader,false);
    leader.leaderStateSummary=new StateSummary(leader.self.getCurrentEpoch(),leader.zk.getLastProcessedZxid());
    f1.start();
    f2.start();
    f1.join(leader.self.getInitLimit() * leader.self.getTickTime() + 5000);
    f2.join(leader.self.getInitLimit() * leader.self.getTickTime() + 5000);
    Assert.assertTrue(f1.msg + " without waiting for leader",f1.msg == null);
    Assert.assertTrue(f2.msg + " without waiting for leader",f2.msg == null);
  }
  finally {
    if (leader != null) {
      leader.shutdown("end of test");
    }
    TestUtils.deleteFileRecursively(tmpDir);
  }
}

</code></pre>

<pre class="type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testUnnecessarySnap() throws Exception {
  testPopulatedLeaderConversation(new PopulatedLeaderConversation(){
    @Override public void converseWithLeader(    InputArchive ia,    OutputArchive oa,    Leader l,    long zxid) throws Exception {
      Assert.assertEquals(1,l.self.getAcceptedEpoch());
      Assert.assertEquals(1,l.self.getCurrentEpoch());
      LearnerInfo li=new LearnerInfo(1,0x10000,0);
      byte liBytes[]=new byte[20];
      ByteBufferOutputStream.record2ByteBuffer(li,ByteBuffer.wrap(liBytes));
      QuorumPacket qp=new QuorumPacket(Leader.FOLLOWERINFO,1,liBytes,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.LEADERINFO,qp.getType());
      Assert.assertEquals(ZxidUtils.makeZxid(2,0),qp.getZxid());
      Assert.assertEquals(ByteBuffer.wrap(qp.getData()).getInt(),0x10000);
      Assert.assertEquals(2,l.self.getAcceptedEpoch());
      Assert.assertEquals(1,l.self.getCurrentEpoch());
      byte epochBytes[]=new byte[4];
      final ByteBuffer wrappedEpochBytes=ByteBuffer.wrap(epochBytes);
      wrappedEpochBytes.putInt(1);
      qp=new QuorumPacket(Leader.ACKEPOCH,zxid,epochBytes,null);
      oa.writeRecord(qp,null);
      readPacketSkippingPing(ia,qp);
      Assert.assertEquals(Leader.DIFF,qp.getType());
    }
  }
,2);
}

</code></pre>

<pre class="type-5 type-3 type-6 type-4 type-14 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testLeaderInConnectingFollowers() throws Exception {
  File tmpDir=File.createTempFile("test","dir",testData);
  tmpDir.delete();
  tmpDir.mkdir();
  Leader leader=null;
  try {
    QuorumPeer peer=createQuorumPeer(tmpDir);
    leader=createLeader(tmpDir,peer);
    peer.leader=leader;
    peer.setAcceptedEpoch(5);
    FollowerMockThread f1=new FollowerMockThread(1,leader,true);
    FollowerMockThread f2=new FollowerMockThread(2,leader,true);
    f1.start();
    f2.start();
    f1.join(leader.self.getInitLimit() * leader.self.getTickTime() + 5000);
    f2.join(leader.self.getInitLimit() * leader.self.getTickTime() + 5000);
    try {
      long epoch=leader.getEpochToPropose(leader.self.getId(),leader.self.getAcceptedEpoch());
      Assert.assertEquals("leader got wrong epoch from getEpochToPropose",6,epoch);
    }
 catch (    Exception e) {
      Assert.fail("leader timed out in getEpochToPropose");
    }
  }
  finally {
    if (leader != null) {
      leader.shutdown("end of test");
    }
    TestUtils.deleteFileRecursively(tmpDir);
  }
}

</code></pre>

<pre class="type-5 type-6 type-8 type-4 type-14 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testNormalFollowerRunWithDiff() throws Exception {
  testFollowerConversation(new FollowerConversation(){
    @Override public void converseWithFollower(    InputArchive ia,    OutputArchive oa,    Follower f) throws Exception {
      File tmpDir=File.createTempFile("test","dir",testData);
      tmpDir.delete();
      tmpDir.mkdir();
      File logDir=f.fzk.getTxnLogFactory().getDataDir().getParentFile();
      File snapDir=f.fzk.getTxnLogFactory().getSnapDir().getParentFile();
      try {
        Assert.assertEquals(0,f.self.getAcceptedEpoch());
        Assert.assertEquals(0,f.self.getCurrentEpoch());
        ZKDatabase zkDb=new ZKDatabase(new FileTxnSnapLog(tmpDir,tmpDir));
        final long firstZxid=ZxidUtils.makeZxid(1,1);
        zkDb.processTxn(new TxnHeader(13,1313,firstZxid,33,ZooDefs.OpCode.create),new CreateTxn("/foo","data1".getBytes(),ZooDefs.Ids.OPEN_ACL_UNSAFE,false,1));
        Stat stat=new Stat();
        Assert.assertEquals("data1",new String(zkDb.getData("/foo",stat,null)));
        QuorumPacket qp=new QuorumPacket();
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.FOLLOWERINFO,qp.getType());
        Assert.assertEquals(qp.getZxid(),0);
        LearnerInfo learnInfo=new LearnerInfo();
        ByteBufferInputStream.byteBuffer2Record(ByteBuffer.wrap(qp.getData()),learnInfo);
        Assert.assertEquals(learnInfo.getProtocolVersion(),0x10000);
        Assert.assertEquals(learnInfo.getServerid(),0);
        qp.setType(Leader.LEADERINFO);
        qp.setZxid(ZxidUtils.makeZxid(1,0));
        byte protoBytes[]=new byte[4];
        ByteBuffer.wrap(protoBytes).putInt(0x10000);
        qp.setData(protoBytes);
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACKEPOCH,qp.getType());
        Assert.assertEquals(0,qp.getZxid());
        Assert.assertEquals(ZxidUtils.makeZxid(0,0),ByteBuffer.wrap(qp.getData()).getInt());
        Assert.assertEquals(1,f.self.getAcceptedEpoch());
        Assert.assertEquals(0,f.self.getCurrentEpoch());
        qp.setType(Leader.DIFF);
        qp.setData(new byte[0]);
        qp.setZxid(zkDb.getDataTreeLastProcessedZxid());
        oa.writeRecord(qp,null);
        final long createSessionZxid=ZxidUtils.makeZxid(1,2);
        proposeNewSession(qp,createSessionZxid,0x333);
        oa.writeRecord(qp,null);
        qp.setType(Leader.COMMIT);
        qp.setZxid(createSessionZxid);
        oa.writeRecord(qp,null);
        qp.setType(Leader.NEWLEADER);
        qp.setZxid(ZxidUtils.makeZxid(1,0));
        qp.setData(null);
        oa.writeRecord(qp,null);
        qp.setType(Leader.UPTODATE);
        qp.setZxid(0);
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
        Assert.assertEquals(1,f.self.getAcceptedEpoch());
        Assert.assertEquals(1,f.self.getCurrentEpoch());
        Assert.assertEquals(createSessionZxid,f.fzk.getLastProcessedZxid());
        ZKDatabase zkDb2=new ZKDatabase(new FileTxnSnapLog(logDir,snapDir));
        zkDb2.loadDataBase();
        LOG.info("zkdb2 sessions:" + zkDb2.getSessions());
        Assert.assertNotNull(zkDb2.getSessionWithTimeOuts().get(4L));
      }
  finally {
        TestUtils.deleteFileRecursively(tmpDir);
      }
    }
    private void proposeNewSession(    QuorumPacket qp,    long zxid,    long sessionId) throws IOException {
      qp.setType(Leader.PROPOSAL);
      qp.setZxid(zxid);
      TxnHeader hdr=new TxnHeader(4,1414,qp.getZxid(),55,ZooDefs.OpCode.createSession);
      CreateSessionTxn cst=new CreateSessionTxn(30000);
      ByteArrayOutputStream baos=new ByteArrayOutputStream();
      OutputArchive boa=BinaryOutputArchive.getArchive(baos);
      boa.writeRecord(hdr,null);
      boa.writeRecord(cst,null);
      qp.setData(baos.toByteArray());
    }
  }
);
}

</code></pre>

<pre class="type-5 type-6 type-4 type-14 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
"></span><br>
@Test public void testNormalObserverRun() throws Exception {
  testObserverConversation(new ObserverConversation(){
    @Override public void converseWithObserver(    InputArchive ia,    OutputArchive oa,    Observer o) throws Exception {
      File tmpDir=File.createTempFile("test","dir",testData);
      tmpDir.delete();
      tmpDir.mkdir();
      File logDir=o.zk.getTxnLogFactory().getDataDir().getParentFile();
      File snapDir=o.zk.getTxnLogFactory().getSnapDir().getParentFile();
      try {
        Assert.assertEquals(0,o.self.getAcceptedEpoch());
        Assert.assertEquals(0,o.self.getCurrentEpoch());
        ZKDatabase zkDb=new ZKDatabase(new FileTxnSnapLog(tmpDir,tmpDir));
        final long foo1Zxid=ZxidUtils.makeZxid(1,1);
        final long foo2Zxid=ZxidUtils.makeZxid(1,2);
        zkDb.processTxn(new TxnHeader(13,1313,foo1Zxid,33,ZooDefs.OpCode.create),new CreateTxn("/foo1","data1".getBytes(),ZooDefs.Ids.OPEN_ACL_UNSAFE,false,1));
        zkDb.processTxn(new TxnHeader(13,1313,foo2Zxid,33,ZooDefs.OpCode.create),new CreateTxn("/foo2","data1".getBytes(),ZooDefs.Ids.OPEN_ACL_UNSAFE,false,1));
        Stat stat=new Stat();
        Assert.assertEquals("data1",new String(zkDb.getData("/foo1",stat,null)));
        Assert.assertEquals("data1",new String(zkDb.getData("/foo2",stat,null)));
        QuorumPacket qp=new QuorumPacket();
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.OBSERVERINFO,qp.getType());
        Assert.assertEquals(qp.getZxid(),0);
        LearnerInfo learnInfo=new LearnerInfo();
        ByteBufferInputStream.byteBuffer2Record(ByteBuffer.wrap(qp.getData()),learnInfo);
        Assert.assertEquals(learnInfo.getProtocolVersion(),0x10000);
        Assert.assertEquals(learnInfo.getServerid(),0);
        qp.setType(Leader.LEADERINFO);
        qp.setZxid(ZxidUtils.makeZxid(1,0));
        byte protoBytes[]=new byte[4];
        ByteBuffer.wrap(protoBytes).putInt(0x10000);
        qp.setData(protoBytes);
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACKEPOCH,qp.getType());
        Assert.assertEquals(0,qp.getZxid());
        Assert.assertEquals(ZxidUtils.makeZxid(0,0),ByteBuffer.wrap(qp.getData()).getInt());
        Assert.assertEquals(1,o.self.getAcceptedEpoch());
        Assert.assertEquals(0,o.self.getCurrentEpoch());
        qp.setType(Leader.SNAP);
        qp.setData(new byte[0]);
        qp.setZxid(zkDb.getDataTreeLastProcessedZxid());
        oa.writeRecord(qp,null);
        zkDb.serializeSnapshot(oa);
        oa.writeString("BenWasHere",null);
        qp.setType(Leader.NEWLEADER);
        qp.setZxid(ZxidUtils.makeZxid(1,0));
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
        Assert.assertEquals(1,o.self.getAcceptedEpoch());
        Assert.assertEquals(1,o.self.getCurrentEpoch());
        Assert.assertEquals(foo2Zxid,o.zk.getLastProcessedZxid());
        ZKDatabase zkDb2=new ZKDatabase(new FileTxnSnapLog(logDir,snapDir));
        long lastZxid=zkDb2.loadDataBase();
        Assert.assertEquals("data1",new String(zkDb2.getData("/foo1",stat,null)));
        Assert.assertEquals(foo2Zxid,lastZxid);
        TrackerWatcher watcher=new TrackerWatcher();
        Assert.assertEquals("data1",new String(o.zk.getZKDatabase().getData("/foo2",stat,watcher)));
        long proposalZxid=ZxidUtils.makeZxid(1,1000);
        proposeSetData(qp,"/foo1",proposalZxid,"data2",2);
        oa.writeRecord(qp,null);
        qp.setType(Leader.COMMIT);
        qp.setZxid(proposalZxid);
        oa.writeRecord(qp,null);
        long informZxid=ZxidUtils.makeZxid(1,1001);
        proposeSetData(qp,"/foo2",informZxid,"data2",2);
        qp.setType(Leader.INFORM);
        oa.writeRecord(qp,null);
        qp.setType(Leader.UPTODATE);
        qp.setZxid(0);
        oa.writeRecord(qp,null);
        readPacketSkippingPing(ia,qp);
        Assert.assertEquals(Leader.ACK,qp.getType());
        Assert.assertEquals(ZxidUtils.makeZxid(1,0),qp.getZxid());
        watcher.waitForChange();
        Assert.assertEquals("data2",new String(o.zk.getZKDatabase().getData("/foo1",stat,null)));
        Assert.assertEquals("data2",new String(o.zk.getZKDatabase().getData("/foo2",stat,null)));
        o.zk.shutdown();
        zkDb2=new ZKDatabase(new FileTxnSnapLog(logDir,snapDir));
        lastZxid=zkDb2.loadDataBase();
        Assert.assertEquals("data2",new String(zkDb2.getData("/foo1",stat,null)));
        Assert.assertEquals("data2",new String(zkDb2.getData("/foo2",stat,null)));
        Assert.assertEquals(informZxid,lastZxid);
      }
  finally {
        TestUtils.deleteFileRecursively(tmpDir);
      }
    }
    private void proposeSetData(    QuorumPacket qp,    String path,    long zxid,    String data,    int version) throws IOException {
      qp.setType(Leader.PROPOSAL);
      qp.setZxid(zxid);
      TxnHeader hdr=new TxnHeader(4,1414,qp.getZxid(),55,ZooDefs.OpCode.setData);
      SetDataTxn sdt=new SetDataTxn(path,data.getBytes(),version);
      ByteArrayOutputStream baos=new ByteArrayOutputStream();
      OutputArchive boa=BinaryOutputArchive.getArchive(baos);
      boa.writeRecord(hdr,null);
      boa.writeRecord(sdt,null);
      qp.setData(baos.toByteArray());
    }
  }
);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
