<h3><span class=" glyphicon glyphicon-tag"/>&nbspIterativeVerifier</h3><kbd>Verifies assertions in iterations</kbd><br><br><br><h4 style="margin:0px">Class: org.apache.zookeeper.RemoveWatchesTest </h4><pre class="type-9 type-5 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test verifies removal of many watchers locally when no connection and
 * WatcherType#Any. Also, verifies internal watchManager datastructures
 */
@Test(timeout=90000) public void testManyWatchersWhenNoConnection() throws Exception {
  int count=3;
  List<MyWatcher> wList=new ArrayList<MyWatcher>(count);
  MyWatcher w;
  String path="/node";
  for (int i=0; i < count; i++) {
    String nodePath=path + i;
    zk1.create(nodePath,null,Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    nodePath+="/";
  }
  for (int i=0; i < count; i++) {
    String nodePath=path + i;
    w=new MyWatcher(path + i,2);
    wList.add(w);
    LOG.info("Adding child watcher {} on path {}",new Object[]{w,nodePath});
    zk1.getChildren(nodePath,w);
    nodePath+="/";
  }
  Assert.assertEquals("Failed to add watchers!",count,zk1.getChildWatches().size());
  for (int i=0; i < count; i++) {
    String nodePath=path + i;
    w=wList.get(i);
    LOG.info("Adding data watcher {} on path {}",new Object[]{w,nodePath});
    zk1.getData(nodePath,w,null);
    nodePath+="/";
  }
  Assert.assertEquals("Failed to add watchers!",count,zk1.getDataWatches().size());
  stopServer();
  for (int i=0; i < count; i++) {
    final MyWatcher watcher=wList.get(i);
    removeWatches(zk1,path + i,watcher,WatcherType.Any,true,Code.OK);
    Assert.assertTrue("Didn't remove watcher",watcher.matches());
  }
  Assert.assertEquals("Didn't remove watch references!",0,zk1.getChildWatches().size());
  Assert.assertEquals("Didn't remove watch references!",0,zk1.getDataWatches().size());
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test verifies many child watchers. Also, verifies internal datastructure
 * 'watchManager.childWatches'
 */
@Test(timeout=90000) public void testManyChildWatchers() throws Exception {
  int count=50;
  List<MyWatcher> wList=new ArrayList<MyWatcher>(count);
  MyWatcher w;
  String path="/node";
  for (int i=0; i < count; i++) {
    String nodePath=path + i;
    zk1.create(nodePath,null,Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    nodePath+="/";
  }
  for (int i=0; i < count; i++) {
    String nodePath=path + i;
    w=new MyWatcher(path + i,1);
    wList.add(w);
    LOG.info("Adding child watcher {} on path {}",new Object[]{w,nodePath});
    zk1.getChildren(nodePath,w);
    nodePath+="/";
  }
  Assert.assertEquals("Failed to add watchers!",count,zk1.getChildWatches().size());
  for (int i=0; i < count; i++) {
    final MyWatcher watcher=wList.get(i);
    removeWatches(zk1,path + i,watcher,WatcherType.Children,false,Code.OK);
    Assert.assertTrue("Didn't remove child watcher",watcher.matches());
  }
  Assert.assertEquals("Didn't remove watch references!",0,zk1.getChildWatches().size());
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test verifies many pre-node watchers. Also, verifies internal
 * datastructure 'watchManager.existWatches'
 */
@Test(timeout=90000) public void testManyPreNodeWatchers() throws Exception {
  int count=50;
  List<MyWatcher> wList=new ArrayList<MyWatcher>(count);
  MyWatcher w;
  String path="/node";
  for (int i=0; i < count; i++) {
    final String nodePath=path + i;
    w=new MyWatcher(nodePath,1);
    wList.add(w);
    LOG.info("Adding pre node watcher {} on path {}",new Object[]{w,nodePath});
    zk1.exists(nodePath,w);
  }
  Assert.assertEquals("Failed to add watchers!",count,zk1.getExistWatches().size());
  for (int i=0; i < count; i++) {
    final MyWatcher watcher=wList.get(i);
    removeWatches(zk1,path + i,watcher,WatcherType.Data,false,Code.OK);
    Assert.assertTrue("Didn't remove data watcher",watcher.matches());
  }
  Assert.assertEquals("Didn't remove watch references!",0,zk1.getExistWatches().size());
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test verifies many data watchers. Also, verifies internal datastructure
 * 'watchManager.dataWatches'
 */
@Test(timeout=90000) public void testManyDataWatchers() throws Exception {
  int count=50;
  List<MyWatcher> wList=new ArrayList<MyWatcher>(count);
  MyWatcher w;
  String path="/node";
  for (int i=0; i < count; i++) {
    String nodePath=path + i;
    w=new MyWatcher(path + i,1);
    wList.add(w);
    zk1.create(nodePath,null,Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    LOG.info("Adding data watcher {} on path {}",new Object[]{w,nodePath});
    zk1.getData(nodePath,w,null);
    nodePath+="/";
  }
  Assert.assertEquals("Failed to add watchers!",count,zk1.getDataWatches().size());
  for (int i=0; i < count; i++) {
    final MyWatcher watcher=wList.get(i);
    removeWatches(zk1,path + i,watcher,WatcherType.Data,false,Code.OK);
    Assert.assertTrue("Didn't remove data watcher",watcher.matches());
  }
  Assert.assertEquals("Didn't remove watch references!",0,zk1.getDataWatches().size());
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.recipes.queue.DistributedQueueTest </h4><pre class="type-9 type-2 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testTakeWait2() throws Exception {
  String dir="/testTakeWait2";
  final String testString="Hello World";
  final int num_clients=1;
  final ZooKeeper clients[]=new ZooKeeper[num_clients];
  final DistributedQueue queueHandles[]=new DistributedQueue[num_clients];
  for (int i=0; i < clients.length; i++) {
    clients[i]=createClient();
    queueHandles[i]=new DistributedQueue(clients[i],dir,null);
  }
  int num_attempts=2;
  for (int i=0; i < num_attempts; i++) {
    final byte[] takeResult[]=new byte[1][];
    final String threadTestString=testString + i;
    Thread takeThread=new Thread(){
      public void run(){
        try {
          takeResult[0]=queueHandles[0].take();
        }
 catch (        KeeperException e) {
        }
catch (        InterruptedException e) {
        }
      }
    }
;
    takeThread.start();
    Thread.sleep(1000);
    Thread offerThread=new Thread(){
      public void run(){
        try {
          queueHandles[0].offer(threadTestString.getBytes());
        }
 catch (        KeeperException e) {
        }
catch (        InterruptedException e) {
        }
      }
    }
;
    offerThread.start();
    offerThread.join();
    takeThread.join();
    Assert.assertTrue(takeResult[0] != null);
    Assert.assertEquals(new String(takeResult[0]),threadTestString);
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.ByteBufferInputStreamTest </h4><pre class="type-9 type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testRead() throws Exception {
  for (int i=0; i < DATA_BYTES.length; i++) {
    int b=in.read();
    assertEquals(DATA_BYTES[i],(byte)b);
  }
  assertEquals(-1,in.read());
}

</code></pre>

<br>
<pre class="type-9 type-6 type-4 type-14 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
"></span><br>
@Test public void testAvailable() throws Exception {
  for (int i=DATA_BYTES.length; i > 0; i--) {
    assertEquals(i,in.available());
    in.read();
  }
  assertEquals(0,in.available());
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.NettyServerCnxnTest </h4><pre class="type-9 type-10 type-3 type-2 type-6 type-8 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test verifies the channel closure - while closing the channel
 * servercnxnfactory should remove all channel references to avoid
 * duplicate channel closure. Duplicate closure may result in indefinite
 * hanging due to netty open issue.
 * @see <a href="https://issues.jboss.org/browse/NETTY-412">NETTY-412</a>
 */
@Test(timeout=40000) public void testSendCloseSession() throws Exception {
  Assert.assertTrue("Didn't instantiate ServerCnxnFactory with NettyServerCnxnFactory!",serverFactory instanceof NettyServerCnxnFactory);
  final ZooKeeper zk=createClient();
  final String path="/a";
  try {
    zk.create(path,"test".getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    Assert.assertNotNull("Didn't create znode:" + path,zk.exists(path,false));
    Iterable<ServerCnxn> connections=serverFactory.getConnections();
    Assert.assertEquals("Mismatch in number of live connections!",1,serverFactory.getNumAliveConnections());
    for (    ServerCnxn serverCnxn : connections) {
      serverCnxn.sendCloseSession();
    }
    LOG.info("Waiting for the channel disconnected event");
    int timeout=0;
    while (serverFactory.getNumAliveConnections() != 0) {
      Thread.sleep(1000);
      timeout+=1000;
      if (timeout > CONNECTION_TIMEOUT) {
        Assert.fail("The number of live connections should be 0");
      }
    }
  }
  finally {
    zk.close();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.PurgeTxnTest </h4><pre class="type-9 type-5 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests finding n recent snapshots from set of snapshots and data logs
 */
@Test public void testFindNRecentSnapshots() throws Exception {
  int nRecentSnap=4;
  int nRecentCount=30;
  int offset=0;
  tmpDir=ClientBase.createTmpDir();
  File version2=new File(tmpDir.toString(),"version-2");
  Assert.assertTrue("Failed to create version_2 dir:" + version2.toString(),version2.mkdir());
  List<File> expectedNRecentSnapFiles=new ArrayList<File>();
  int counter=offset + (2 * nRecentCount);
  for (int i=0; i < nRecentCount; i++) {
    File logFile=new File(version2 + "/log." + Long.toHexString(--counter));
    Assert.assertTrue("Failed to create log File:" + logFile.toString(),logFile.createNewFile());
    File snapFile=new File(version2 + "/snapshot." + Long.toHexString(--counter));
    Assert.assertTrue("Failed to create snap File:" + snapFile.toString(),snapFile.createNewFile());
    if (i < nRecentSnap) {
      expectedNRecentSnapFiles.add(snapFile);
    }
  }
  FileTxnSnapLog txnLog=new FileTxnSnapLog(tmpDir,tmpDir);
  List<File> nRecentSnapFiles=txnLog.findNRecentSnapshots(nRecentSnap);
  txnLog.close();
  Assert.assertEquals("exactly 4 snapshots ",4,nRecentSnapFiles.size());
  expectedNRecentSnapFiles.removeAll(nRecentSnapFiles);
  Assert.assertEquals("Didn't get the recent snap files",0,expectedNRecentSnapFiles.size());
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.quorum.LearnerSnapshotThrottlerTest </h4><pre class="type-9 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testTryWithResourceNoThrottle() throws Exception {
  LearnerSnapshotThrottler throttler=new LearnerSnapshotThrottler(1);
  for (int i=0; i < 3; i++) {
    LearnerSnapshot snapshot=throttler.beginSnapshot(false);
    try {
      Assert.assertFalse(snapshot.isEssential());
      Assert.assertEquals(1,snapshot.getConcurrentSnapshotNumber());
    }
  finally {
      snapshot.close();
    }
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.quorum.QuorumPeerMainTest </h4><pre class="type-9 type-10 type-3 type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test early leader abandonment.
 */
@Test public void testEarlyLeaderAbandonment() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=3;
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    sb.append("server." + i + "=127.0.0.1:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ";"+ clientPorts[i]+ "\n");
  }
  String quorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],quorumCfgSection);
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  waitForAll(zk,States.CONNECTED);
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
  }
  waitForAll(zk,States.CONNECTING);
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  waitForAll(zk,States.CONNECTED);
  int leader=-1;
  Map<Long,Proposal> outstanding=null;
  for (int i=0; i < SERVER_COUNT; i++) {
    if (mt[i].main.quorumPeer.leader == null) {
      mt[i].shutdown();
    }
 else {
      leader=i;
      outstanding=mt[leader].main.quorumPeer.leader.outstandingProposals;
    }
  }
  try {
    zk[leader].create("/zk" + leader,"zk".getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    Assert.fail("create /zk" + leader + " should have failed");
  }
 catch (  KeeperException e) {
  }
  Assert.assertTrue(outstanding.size() == 1);
  Assert.assertTrue(((Proposal)outstanding.values().iterator().next()).request.getHdr().getType() == OpCode.create);
  Thread.sleep(1000);
  mt[leader].shutdown();
  waitForAll(zk,States.CONNECTING);
  for (int i=0; i < SERVER_COUNT; i++) {
    if (i != leader) {
      mt[i].start();
    }
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    if (i != leader) {
      zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
      waitForOne(zk[i],States.CONNECTED);
      zk[i].create("/zk" + i,"zk".getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    }
  }
  mt[leader].start();
  waitForAll(zk,States.CONNECTED);
  for (int i=0; i < SERVER_COUNT; i++) {
    for (int j=0; j < SERVER_COUNT; j++) {
      if (i == leader) {
        Assert.assertTrue((j == leader ? ("Leader (" + leader + ")") : ("Follower " + j)) + " should not have /zk" + i,zk[j].exists("/zk" + i,false) == null);
      }
 else {
        Assert.assertTrue((j == leader ? ("Leader (" + leader + ")") : ("Follower " + j)) + " does not have /zk" + i,zk[j].exists("/zk" + i,false) != null);
      }
    }
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    zk[i].close();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.quorum.ReconfigBackupTest </h4><pre class="type-9 type-5 type-10 type-2 type-8 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks that if a version is appended to dynamic file,
 * then peer should use that version as quorum config version.
 * <p/>
 * The scenario: one server has an older version of 3 servers, and
 * four others have newer version of 5 servers. Finally, the lag-off one
 * should have server config of 5 servers.
 */
@Test public void testVersionOfDynamicFilename() throws Exception {
  final int SERVER_COUNT=5;
  final int oldServerCount=3;
  final int lagOffServerId=0;
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  String server;
  StringBuilder oldSb=new StringBuilder();
  ArrayList<String> allServers=new ArrayList<String>();
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ clientPorts[i];
    sb.append(server + "\n");
    allServers.add(server);
    if (i < oldServerCount) {
      oldSb.append(server + "\n");
    }
  }
  String currentQuorumCfgSection=sb.toString();
  String oldQuorumCfg=oldSb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    if (i == lagOffServerId) {
      mt[i]=new MainThread(i,clientPorts[i],oldQuorumCfg,true,"100000000");
    }
 else {
      mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfgSection,true,"200000000");
    }
    if (i == lagOffServerId) {
      Assert.assertNotNull(mt[i].getFileByName("zoo.cfg.dynamic.100000000"));
      Assert.assertNull(mt[i].getFileByName("zoo.cfg.dynamic.200000000"));
      Assert.assertTrue(mt[i].getPropFromStaticFile("dynamicConfigFile").endsWith(".100000000"));
    }
 else {
      Assert.assertNotNull(mt[i].getFileByName("zoo.cfg.dynamic.200000000"));
      Assert.assertTrue(mt[i].getPropFromStaticFile("dynamicConfigFile").endsWith(".200000000"));
    }
    mt[i].start();
  }
  String dynamicFileContent=null;
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    ZooKeeper zk=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
    String configStr=ReconfigTest.testServerHasConfig(zk,allServers,null);
    Assert.assertEquals("200000000",getVersionFromConfigStr(configStr));
    List<String> configLines=Arrays.asList(configStr.split("\n"));
    Collections.sort(configLines);
    String sortedConfigStr=StringUtils.joinStrings(configLines,"\n");
    File dynamicConfigFile=mt[i].getFileByName("zoo.cfg.dynamic.200000000");
    Assert.assertNotNull(dynamicConfigFile);
    if (i == 0) {
      dynamicFileContent=getFileContent(dynamicConfigFile);
      Assert.assertEquals(sortedConfigStr,dynamicFileContent + "version=200000000");
    }
 else {
      String otherDynamicFileContent=getFileContent(dynamicConfigFile);
      Assert.assertEquals(dynamicFileContent,otherDynamicFileContent);
    }
    zk.close();
  }
  Assert.assertTrue(mt[lagOffServerId].getPropFromStaticFile("dynamicConfigFile").endsWith(".200000000"));
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-10 type-2 type-8 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks that on reconfig, a new dynamic file will be created with
 * current version appended to file name. Meanwhile, the dynamic file pointer
 * in static config file should also be changed.
 */
@Test public void testReconfigCreateNewVersionFile() throws Exception {
  final int SERVER_COUNT=3;
  final int NEW_SERVER_COUNT=5;
  final int clientPorts[]=new int[NEW_SERVER_COUNT];
  final int quorumPorts[]=new int[NEW_SERVER_COUNT];
  final int electionPorts[]=new int[NEW_SERVER_COUNT];
  final String servers[]=new String[NEW_SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  ArrayList<String> oldServers=new ArrayList<String>();
  ArrayList<String> newServers=new ArrayList<String>();
  for (int i=0; i < NEW_SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    quorumPorts[i]=PortAssignment.unique();
    electionPorts[i]=PortAssignment.unique();
    servers[i]="server." + i + "=localhost:"+ quorumPorts[i]+ ":"+ electionPorts[i]+ ":participant;localhost:"+ clientPorts[i];
    newServers.add(servers[i]);
    if (i >= SERVER_COUNT) {
      continue;
    }
    oldServers.add(servers[i]);
    sb.append(servers[i] + "\n");
  }
  String quorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[NEW_SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[NEW_SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],quorumCfgSection);
    mt[i].start();
  }
  String firstVersion=null, secondVersion=null;
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
    Properties cfg=ReconfigLegacyTest.readPropertiesFromFile(mt[i].confFile);
    String filename=cfg.getProperty("dynamicConfigFile","");
    String version=QuorumPeerConfig.getVersionFromFilename(filename);
    Assert.assertNotNull(version);
    String configStr=ReconfigTest.testServerHasConfig(zk[i],oldServers,null);
    String configVersion=getVersionFromConfigStr(configStr);
    Assert.assertEquals(version,configVersion);
    if (i == 0) {
      firstVersion=version;
    }
 else {
      Assert.assertEquals(firstVersion,version);
    }
  }
  ReconfigTest.reconfig(zk[1],null,null,newServers,-1);
  for (int i=SERVER_COUNT; i < NEW_SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],quorumCfgSection + servers[i]);
    mt[i].start();
  }
  for (int i=SERVER_COUNT; i < NEW_SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=0; i < NEW_SERVER_COUNT; i++) {
    Properties cfg=ReconfigLegacyTest.readPropertiesFromFile(mt[i].confFile);
    String filename=cfg.getProperty("dynamicConfigFile","");
    String version=QuorumPeerConfig.getVersionFromFilename(filename);
    Assert.assertNotNull(version);
    String configStr=ReconfigTest.testServerHasConfig(zk[i],newServers,null);
    String quorumVersion=getVersionFromConfigStr(configStr);
    Assert.assertEquals(version,quorumVersion);
    if (i == 0) {
      secondVersion=version;
      Assert.assertTrue(Long.parseLong(secondVersion,16) > Long.parseLong(firstVersion,16));
    }
 else {
      Assert.assertEquals(secondVersion,version);
    }
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
    zk[i].close();
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-8 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks that it will backup static file on bootup.
 */
@Test public void testBackupStatic() throws Exception {
  final int SERVER_COUNT=3;
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  String server;
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ clientPorts[i];
    sb.append(server + "\n");
  }
  String currentQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  String[] staticFileContent=new String[SERVER_COUNT];
  String[] staticBackupContent=new String[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfgSection,false);
    Assert.assertNull("static file backup shouldn't exist before bootup",mt[i].getFileByName("zoo.cfg.bak"));
    staticFileContent[i]=getFileContent(mt[i].confFile);
    mt[i].start();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    File backupFile=mt[i].getFileByName("zoo.cfg.bak");
    Assert.assertNotNull("static file backup should exist",backupFile);
    staticBackupContent[i]=getFileContent(backupFile);
    Assert.assertEquals(staticFileContent[i],staticBackupContent[i]);
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.quorum.ReconfigFailureCasesTest </h4><pre class="type-9 type-5 type-3 type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testObserverToParticipantConversionFails() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=4;
  int[][] ports=ReconfigRecoveryTest.generatePorts(SERVER_COUNT);
  HashSet<Integer> observers=new HashSet<Integer>();
  observers.add(3);
  StringBuilder sb=ReconfigRecoveryTest.generateConfig(SERVER_COUNT,ports,observers);
  String currentQuorumCfgSection=sb.toString();
  String nextQuorumCfgSection=currentQuorumCfgSection.replace("observer","participant");
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=1; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,ports[i][2],currentQuorumCfgSection,true,"100000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + ports[i][2],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=1; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + ports[i][2],CONNECTION_TIMEOUT * 2));
  }
  try {
    zk[1].reconfig("","",nextQuorumCfgSection,-1,new Stat());
    Assert.fail("Reconfig should have failed with NewConfigNoQuorum");
  }
 catch (  NewConfigNoQuorum e) {
  }
catch (  Exception e) {
    Assert.fail("Reconfig should have failed with NewConfigNoQuorum");
  }
  ArrayList<String> leavingServers=new ArrayList<String>();
  leavingServers.add("3");
  ReconfigTest.reconfig(zk[1],null,leavingServers,null,-1);
  ReconfigTest.testNormalOperation(zk[2],zk[3]);
  ReconfigTest.testServerHasConfig(zk[3],null,leavingServers);
  List<String> newMembers=Arrays.asList(nextQuorumCfgSection.split("\n"));
  ReconfigTest.reconfig(zk[1],null,null,newMembers,-1);
  ReconfigTest.testNormalOperation(zk[2],zk[3]);
  for (int i=1; i < SERVER_COUNT; i++) {
    ReconfigTest.testServerHasConfig(zk[i],newMembers,null);
  }
  for (int i=1; i < SERVER_COUNT; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.quorum.ReconfigLegacyTest </h4><pre class="type-9 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test case for https://issues.apache.org/jira/browse/ZOOKEEPER-2244
 * @throws Exception
 */
@Test(timeout=120000) public void testRestartZooKeeperServer() throws Exception {
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  String server;
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    server="server." + i + "=127.0.0.1:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;127.0.0.1:"+ clientPorts[i];
    sb.append(server + "\n");
  }
  String currentQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfgSection,false);
    mt[i].start();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
  }
  CountdownWatcher watch1=new CountdownWatcher();
  ZooKeeper zk=new ZooKeeper("127.0.0.1:" + clientPorts[0],ClientBase.CONNECTION_TIMEOUT,watch1);
  watch1.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
  String zNodePath="/serverRestartTest";
  String data="originalData";
  zk.create(zNodePath,data.getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  zk.close();
  mt[0].shutdown();
  mt[1].shutdown();
  mt[0].start();
  mt[1].start();
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
  }
  CountdownWatcher watch2=new CountdownWatcher();
  zk=new ZooKeeper("127.0.0.1:" + clientPorts[0],ClientBase.CONNECTION_TIMEOUT,watch2);
  watch2.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
  byte[] dataBytes=zk.getData(zNodePath,null,null);
  String receivedData=new String(dataBytes);
  assertEquals(data,receivedData);
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<pre class="type-9 type-10 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies boolean conditions
"></span><br>
/** 
 * {@link https://issues.apache.org/jira/browse/ZOOKEEPER-1992}1. When a server starts from old style static config, without a client port in the server
 * specification, it should keep the client port in static config file.
 * 2. After port reconfig, the old port should be removed from static file
 * and new port added to dynamic file.
 * @throws Exception
 */
@Test public void testReconfigRemoveClientFromStatic() throws Exception {
  final int clientPorts[]=new int[SERVER_COUNT];
  final int quorumPorts[]=new int[SERVER_COUNT];
  final int electionPorts[]=new int[SERVER_COUNT];
  final int changedServerId=0;
  final int newClientPort=PortAssignment.unique();
  StringBuilder sb=new StringBuilder();
  ArrayList<String> allServers=new ArrayList<String>();
  ArrayList<String> newServers=new ArrayList<String>();
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    quorumPorts[i]=PortAssignment.unique();
    electionPorts[i]=PortAssignment.unique();
    String server="server." + i + "=localhost:"+ quorumPorts[i]+ ":"+ electionPorts[i]+ ":participant";
    allServers.add(server);
    sb.append(server + "\n");
    if (i == changedServerId) {
      newServers.add(server + ";0.0.0.0:" + newClientPort);
    }
 else {
      newServers.add(server);
    }
  }
  String quorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],quorumCfgSection,false);
    mt[i].start();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
    ReconfigTest.testServerHasConfig(zk[i],allServers,null);
    Properties cfg=readPropertiesFromFile(mt[i].confFile);
    Assert.assertTrue(cfg.containsKey("dynamicConfigFile"));
    Assert.assertTrue(cfg.containsKey("clientPort"));
  }
  ReconfigTest.testNormalOperation(zk[0],zk[1]);
  ReconfigTest.reconfig(zk[1],null,null,newServers,-1);
  ReconfigTest.testNormalOperation(zk[0],zk[1]);
  Thread.sleep(1000);
  for (int i=0; i < SERVER_COUNT; i++) {
    ReconfigTest.testServerHasConfig(zk[i],newServers,null);
    Properties staticCfg=readPropertiesFromFile(mt[i].confFile);
    if (i == changedServerId) {
      Assert.assertFalse(staticCfg.containsKey("clientPort"));
    }
 else {
      Assert.assertTrue(staticCfg.containsKey("clientPort"));
    }
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
    zk[i].close();
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks that when started with a single static config file the
 * servers will create a valid dynamic config file. Also checks that when
 * the static config includes a clientPort but the dynamic definition also
 * includes it, the static definition is erased.
 */
@Test public void testConfigFileBackwardCompatibility() throws Exception {
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  String server;
  ArrayList<String> allServers=new ArrayList<String>();
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ clientPorts[i];
    allServers.add(server);
    sb.append(server + "\n");
  }
  String currentQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfgSection,false);
    Assert.assertEquals(mt[i].getDynamicFiles().length,0);
    mt[i].start();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
    File[] dynamicFiles=mt[i].getDynamicFiles();
    Assert.assertTrue(dynamicFiles.length == 1);
    ReconfigTest.testServerHasConfig(zk[i],allServers,null);
    Properties cfg=readPropertiesFromFile(mt[i].confFile);
    for (int j=0; j < SERVER_COUNT; j++) {
      Assert.assertFalse(cfg.containsKey("server." + j));
    }
    Assert.assertTrue(cfg.containsKey("dynamicConfigFile"));
    Assert.assertFalse(cfg.containsKey("clientPort"));
    cfg=readPropertiesFromFile(dynamicFiles[0]);
    for (int j=0; j < SERVER_COUNT; j++) {
      String serverLine=cfg.getProperty("server." + j,"");
      Assert.assertEquals(allServers.get(j),"server." + j + "="+ serverLine);
    }
    Assert.assertFalse(cfg.containsKey("dynamicConfigFile"));
  }
  ReconfigTest.testNormalOperation(zk[0],zk[1]);
  for (int i=0; i < SERVER_COUNT; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].start();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
    ReconfigTest.testServerHasConfig(zk[i],allServers,null);
  }
  ReconfigTest.testNormalOperation(zk[0],zk[1]);
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i].shutdown();
    zk[i].close();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.server.quorum.ReconfigRecoveryTest </h4><pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
/** 
 * Reconfiguration recovery - current config servers discover .next file,
 * but they're both observers and their ports change in next config. Suppose
 * that next config wasn't activated yet. Should complete reconfiguration.
 */
@Test public void testCurrentServersAreObserversInNextConfig() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=5;
  final int clientPorts[]=new int[SERVER_COUNT];
  final int oldClientPorts[]=new int[2];
  StringBuilder sb=new StringBuilder();
  String server;
  String currentQuorumCfg, nextQuorumCfgSection;
  ArrayList<String> allServersNext=new ArrayList<String>();
  for (int i=0; i < 2; i++) {
    oldClientPorts[i]=PortAssignment.unique();
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ oldClientPorts[i];
    sb.append(server + "\n");
  }
  currentQuorumCfg=sb.toString();
  sb=new StringBuilder();
  String role;
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    if (i < 2) {
      role="observer";
    }
 else {
      role="participant";
    }
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":"+ role+ ";localhost:"+ clientPorts[i];
    allServersNext.add(server);
    sb.append(server + "\n");
  }
  nextQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=0; i < 2; i++) {
    mt[i]=new MainThread(i,oldClientPorts[i],currentQuorumCfg,true,"100000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + oldClientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=0; i < 2; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + oldClientPorts[i],CONNECTION_TIMEOUT * 2));
  }
  ReconfigTest.testNormalOperation(zk[0],zk[1]);
  for (int i=0; i < 2; i++) {
    mt[i].shutdown();
    zk[i].close();
  }
  for (int i=0; i < 2; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerDown("127.0.0.1:" + oldClientPorts[i],CONNECTION_TIMEOUT * 2));
  }
  for (int i=0; i < 2; i++) {
    mt[i].writeTempDynamicConfigFile(nextQuorumCfgSection,"200000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=2; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfg + allServersNext.get(i));
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT * 2));
    ReconfigTest.testServerHasConfig(zk[i],allServersNext,null);
  }
  ReconfigTest.testNormalOperation(zk[0],zk[2]);
  ReconfigTest.testNormalOperation(zk[4],zk[1]);
  for (int i=0; i < SERVER_COUNT; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests conversion of observer to participant AFTER new config was already
 * committed. Old config: servers 0 (participant), 1 (participant), 2
 * (observer) New config: servers 2 (participant), 3 (participant) We start
 * server 2 with old config and start server 3 with new config. All other
 * servers are down. In order to terminate FLE, server 3 must 'convince'
 * server 2 to adopt the new config and turn into a participant.
 */
@Test public void testObserverConvertedToParticipantDuringFLE() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=4;
  int[][] ports=generatePorts(SERVER_COUNT);
  String currentQuorumCfgSection, nextQuorumCfgSection;
  HashSet<Integer> observers=new HashSet<Integer>();
  observers.add(2);
  StringBuilder sb=generateConfig(3,ports,observers);
  currentQuorumCfgSection=sb.toString();
  ArrayList<String> allServersNext=new ArrayList<String>();
  sb=new StringBuilder();
  for (int i=2; i < SERVER_COUNT; i++) {
    String server="server." + i + "=localhost:"+ ports[i][0]+ ":"+ ports[i][1]+ ":participant;localhost:"+ ports[i][2];
    allServersNext.add(server);
    sb.append(server + "\n");
  }
  nextQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  mt[2]=new MainThread(2,ports[2][2],currentQuorumCfgSection,true,"100000000");
  mt[2].start();
  zk[2]=new ZooKeeper("127.0.0.1:" + ports[2][2],ClientBase.CONNECTION_TIMEOUT,this);
  mt[3]=new MainThread(3,ports[3][2],nextQuorumCfgSection,true,"200000000");
  mt[3].start();
  zk[3]=new ZooKeeper("127.0.0.1:" + ports[3][2],ClientBase.CONNECTION_TIMEOUT,this);
  for (int i=2; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + ports[i][2],CONNECTION_TIMEOUT * 2));
    ReconfigTest.testServerHasConfig(zk[i],allServersNext,null);
  }
  Assert.assertEquals(nextQuorumCfgSection + "version=200000000",ReconfigTest.testServerHasConfig(zk[2],null,null));
  Assert.assertEquals(nextQuorumCfgSection + "version=200000000",ReconfigTest.testServerHasConfig(zk[3],null,null));
  ReconfigTest.testNormalOperation(zk[2],zk[2]);
  ReconfigTest.testNormalOperation(zk[3],zk[2]);
  for (int i=2; i < SERVER_COUNT; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
/** 
 * Reconfiguration recovery - test that if servers in old config have a
 * .next file but no quorum of new config is up then no progress should be
 * possible (no progress will happen to ensure safety as the new config
 * might be actually up but partitioned from old config)
 */
@Test public void testNextConfigUnreachable() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=5;
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  String server;
  String currentQuorumCfgSection=null, nextQuorumCfgSection;
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ clientPorts[i];
    sb.append(server + "\n");
    if (i == 1)     currentQuorumCfgSection=sb.toString();
  }
  nextQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=0; i < 2; i++) {
    mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfgSection,true,"100000000");
    mt[i].writeTempDynamicConfigFile(nextQuorumCfgSection,"200000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  Thread.sleep(CONNECTION_TIMEOUT * 2);
  for (int i=0; i < 2; i++) {
    Assert.assertFalse("server " + i + " is up but shouldn't be",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT / 10));
  }
  for (int i=0; i < 2; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests conversion of observer to participant during reconfig recovery, new
 * config was not committed yet. Old config: servers 0 (participant), 1
 * (participant), 2 (observer) New config: servers 2 (participant), 3
 * (participant) We start server servers 0, 1, 2 with old config and a .next
 * file indicating a reconfig in progress. We start server 3 with old config
 * + itself in config file. In this scenario server 2 can't be converted to
 * participant during reconfig since we don't gossip about proposed
 * configurations, only about committed ones. This tests that new config can
 * be completed, which requires server 2's ack for the newleader message,
 * even though its an observer.
 */
@Test public void testCurrentObserverIsParticipantInNewConfig() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=4;
  int[][] ports=generatePorts(SERVER_COUNT);
  String currentQuorumCfg, nextQuorumCfgSection;
  HashSet<Integer> observers=new HashSet<Integer>();
  observers.add(2);
  StringBuilder sb=generateConfig(3,ports,observers);
  currentQuorumCfg=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=0; i <= 2; i++) {
    mt[i]=new MainThread(i,ports[i][2],currentQuorumCfg,true,"100000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + ports[i][2],ClientBase.CONNECTION_TIMEOUT,this);
  }
  ReconfigTest.testNormalOperation(zk[0],zk[2]);
  for (int i=0; i <= 2; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + ports[i][2],CONNECTION_TIMEOUT * 2));
  }
  for (int i=0; i <= 2; i++) {
    mt[i].shutdown();
    zk[i].close();
  }
  ArrayList<String> allServersNext=new ArrayList<String>();
  sb=new StringBuilder();
  for (int i=2; i < SERVER_COUNT; i++) {
    String server="server." + i + "=localhost:"+ ports[i][0]+ ":"+ ports[i][1]+ ":participant;localhost:"+ ports[i][2];
    allServersNext.add(server);
    sb.append(server + "\n");
  }
  nextQuorumCfgSection=sb.toString();
  for (int i=0; i <= 2; i++) {
    mt[i].writeTempDynamicConfigFile(nextQuorumCfgSection,"200000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + ports[i][2],ClientBase.CONNECTION_TIMEOUT,this);
  }
  mt[3]=new MainThread(3,ports[3][2],currentQuorumCfg + allServersNext.get(1));
  mt[3].start();
  zk[3]=new ZooKeeper("127.0.0.1:" + ports[3][2],ClientBase.CONNECTION_TIMEOUT,this);
  for (int i=2; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + ports[i][2],CONNECTION_TIMEOUT * 3));
    ReconfigTest.testServerHasConfig(zk[i],allServersNext,null);
  }
  ReconfigTest.testNormalOperation(zk[0],zk[2]);
  ReconfigTest.testNormalOperation(zk[3],zk[1]);
  Assert.assertEquals(nextQuorumCfgSection + "version=200000000",ReconfigTest.testServerHasConfig(zk[2],null,null));
  Assert.assertEquals(nextQuorumCfgSection + "version=200000000",ReconfigTest.testServerHasConfig(zk[3],null,null));
  for (int i=0; i < SERVER_COUNT; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<pre class="type-9 type-2 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Reconfiguration recovery - test that old config members will join the new
 * config if its already active, and not try to complete the reconfiguration
 */
@Test public void testNextConfigAlreadyActive() throws Exception {
  ClientBase.setupTestEnv();
  final int SERVER_COUNT=5;
  final int clientPorts[]=new int[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  String server;
  String currentQuorumCfgSection=null, nextQuorumCfgSection;
  ArrayList<String> allServers=new ArrayList<String>();
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    server="server." + i + "=localhost:"+ PortAssignment.unique()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ clientPorts[i];
    allServers.add(server);
    sb.append(server + "\n");
    if (i == 1)     currentQuorumCfgSection=sb.toString();
  }
  nextQuorumCfgSection=sb.toString();
  MainThread mt[]=new MainThread[SERVER_COUNT];
  ZooKeeper zk[]=new ZooKeeper[SERVER_COUNT];
  for (int i=2; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,clientPorts[i],nextQuorumCfgSection,true,"200000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=2; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT));
  }
  ReconfigTest.testNormalOperation(zk[2],zk[3]);
  long epoch=mt[2].main.quorumPeer.getAcceptedEpoch();
  for (int i=0; i < 2; i++) {
    mt[i]=new MainThread(i,clientPorts[i],currentQuorumCfgSection,true,"100000000");
    mt[i].writeTempDynamicConfigFile(nextQuorumCfgSection,"200000000");
    mt[i].start();
    zk[i]=new ZooKeeper("127.0.0.1:" + clientPorts[i],ClientBase.CONNECTION_TIMEOUT,this);
  }
  for (int i=0; i < 2; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],CONNECTION_TIMEOUT * 2));
  }
  Assert.assertEquals(epoch,mt[0].main.quorumPeer.getAcceptedEpoch());
  Assert.assertEquals(epoch,mt[1].main.quorumPeer.getAcceptedEpoch());
  Assert.assertEquals(epoch,mt[2].main.quorumPeer.getAcceptedEpoch());
  ReconfigTest.testServerHasConfig(zk[0],allServers,null);
  ReconfigTest.testServerHasConfig(zk[1],allServers,null);
  ReconfigTest.testNormalOperation(zk[0],zk[2]);
  ReconfigTest.testNormalOperation(zk[4],zk[1]);
  for (int i=0; i < SERVER_COUNT; i++) {
    zk[i].close();
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.AsyncHammerTest </h4><pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
@Test public void testHammer() throws Exception {
  setUp(false);
  bang=true;
  LOG.info("Starting hammers");
  HammerThread[] hammers=new HammerThread[100];
  for (int i=0; i < hammers.length; i++) {
    hammers[i]=new HammerThread("HammerThread-" + i);
    hammers[i].start();
  }
  LOG.info("Started hammers");
  Thread.sleep(5000);
  bang=false;
  LOG.info("Stopping hammers");
  for (int i=0; i < hammers.length; i++) {
    hammers[i].interrupt();
    verifyThreadTerminated(hammers[i],60000);
    Assert.assertFalse(hammers[i].failed);
  }
  LOG.info("Hammers stopped, verifying consistency");
  qb.verifyRootOfAllServersMatch(qb.hostPort);
  restart();
  LOG.info("Verifying hammers 2");
  qb.verifyRootOfAllServersMatch(qb.hostPort);
  tearDown();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.ClientTest </h4><pre class="type-9 type-6 type-8 type-4 type-14 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Register multiple watchers and verify that they all get notified and
 * in the right order.
 */
@Test public void testMutipleWatcherObjs() throws IOException, InterruptedException, KeeperException {
  ZooKeeper zk=createClient(new CountdownWatcher(),hostPort);
  try {
    MyWatcher watchers[]=new MyWatcher[100];
    MyWatcher watchers2[]=new MyWatcher[watchers.length];
    for (int i=0; i < watchers.length; i++) {
      watchers[i]=new MyWatcher();
      watchers2[i]=new MyWatcher();
      zk.create("/foo-" + i,("foodata" + i).getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    }
    Stat stat=new Stat();
    for (int i=0; i < watchers.length; i++) {
      Assert.assertNotNull(zk.getData("/foo-" + i,watchers[i],stat));
    }
    for (int i=0; i < watchers.length; i++) {
      Assert.assertNotNull(zk.exists("/foo-" + i,watchers[i]));
    }
    for (int i=0; i < watchers.length; i++) {
      zk.setData("/foo-" + i,("foodata2-" + i).getBytes(),-1);
      zk.setData("/foo-" + i,("foodata3-" + i).getBytes(),-1);
    }
    for (int i=0; i < watchers.length; i++) {
      WatchedEvent event=watchers[i].events.poll(10,TimeUnit.SECONDS);
      Assert.assertEquals("/foo-" + i,event.getPath());
      Assert.assertEquals(EventType.NodeDataChanged,event.getType());
      Assert.assertEquals(KeeperState.SyncConnected,event.getState());
      Assert.assertEquals(0,watchers[i].events.size());
    }
    for (int i=0; i < watchers.length; i++) {
      Assert.assertNotNull(zk.getData("/foo-" + i,watchers[i],stat));
      Assert.assertNotNull(zk.exists("/foo-" + i,watchers[i]));
    }
    for (int i=0; i < watchers.length; i++) {
      zk.setData("/foo-" + i,("foodata4-" + i).getBytes(),-1);
      zk.setData("/foo-" + i,("foodata5-" + i).getBytes(),-1);
    }
    for (int i=0; i < watchers.length; i++) {
      WatchedEvent event=watchers[i].events.poll(10,TimeUnit.SECONDS);
      Assert.assertEquals("/foo-" + i,event.getPath());
      Assert.assertEquals(EventType.NodeDataChanged,event.getType());
      Assert.assertEquals(KeeperState.SyncConnected,event.getState());
      Assert.assertEquals(0,watchers[i].events.size());
    }
    for (int i=0; i < watchers.length; i++) {
      Assert.assertNotNull(zk.getData("/foo-" + i,watchers[i],stat));
      Assert.assertNotNull(zk.exists("/foo-" + i,watchers2[i]));
    }
    for (int i=0; i < watchers.length; i++) {
      zk.setData("/foo-" + i,("foodata6-" + i).getBytes(),-1);
      zk.setData("/foo-" + i,("foodata7-" + i).getBytes(),-1);
    }
    for (int i=0; i < watchers.length; i++) {
      WatchedEvent event=watchers[i].events.poll(10,TimeUnit.SECONDS);
      Assert.assertEquals("/foo-" + i,event.getPath());
      Assert.assertEquals(EventType.NodeDataChanged,event.getType());
      Assert.assertEquals(KeeperState.SyncConnected,event.getState());
      Assert.assertEquals(0,watchers[i].events.size());
      WatchedEvent event2=watchers2[i].events.poll(10,TimeUnit.SECONDS);
      Assert.assertEquals("/foo-" + i,event2.getPath());
      Assert.assertEquals(EventType.NodeDataChanged,event2.getType());
      Assert.assertEquals(KeeperState.SyncConnected,event2.getState());
      Assert.assertEquals(0,watchers2[i].events.size());
    }
  }
  finally {
    if (zk != null) {
      zk.close();
    }
  }
}

</code></pre>

<br>
<pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
/** 
 * Verify that the client is cleaning up properly. Open/close a large
 * number of sessions. Essentially looking to see if sockets/selectors
 * are being cleaned up properly during close.
 * @throws Throwable
 */
@Test public void testClientCleanup() throws Throwable {
  OSMXBean osMbean=new OSMXBean();
  if (osMbean.getUnix() == false) {
    LOG.warn("skipping testClientCleanup, only available on Unix");
    return;
  }
  final int threadCount=3;
  final int clientCount=10;
  long initialFdCount=osMbean.getOpenFileDescriptorCount();
  VerifyClientCleanup threads[]=new VerifyClientCleanup[threadCount];
  for (int i=0; i < threads.length; i++) {
    threads[i]=new VerifyClientCleanup("VCC" + i,clientCount);
    threads[i].start();
  }
  for (int i=0; i < threads.length; i++) {
    threads[i].join(CONNECTION_TIMEOUT);
    Assert.assertTrue(threads[i].current == threads[i].count);
  }
  long currentCount=osMbean.getOpenFileDescriptorCount();
  final String logmsg="open fds after test ({}) are not significantly higher than before ({})";
  if (currentCount > initialFdCount + 10) {
    LOG.error(logmsg,Long.valueOf(currentCount),Long.valueOf(initialFdCount));
  }
 else {
    LOG.info(logmsg,Long.valueOf(currentCount),Long.valueOf(initialFdCount));
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.CnxManagerTest </h4><pre class="type-9 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects are null
"></span><br>
@Test public void testWorkerThreads() throws Exception {
  ArrayList<QuorumPeer> peerList=new ArrayList<QuorumPeer>();
  try {
    for (int sid=0; sid < 3; sid++) {
      QuorumPeer peer=new QuorumPeer(peers,peerTmpdir[sid],peerTmpdir[sid],peerClientPort[sid],3,sid,1000,2,2);
      LOG.info("Starting peer {}",peer.getId());
      peer.start();
      peerList.add(sid,peer);
    }
    String failure=verifyThreadCount(peerList,4);
    Assert.assertNull(failure,failure);
    for (int myid=0; myid < 3; myid++) {
      for (int i=0; i < 5; i++) {
        QuorumPeer peer=peerList.get(myid);
        LOG.info("Round {}, halting peer ",new Object[]{i,peer.getId()});
        peer.shutdown();
        peerList.remove(myid);
        failure=verifyThreadCount(peerList,2);
        Assert.assertNull(failure,failure);
        peer=new QuorumPeer(peers,peerTmpdir[myid],peerTmpdir[myid],peerClientPort[myid],3,myid,1000,2,2);
        LOG.info("Round {}, restarting peer ",new Object[]{i,peer.getId()});
        peer.start();
        peerList.add(myid,peer);
        failure=verifyThreadCount(peerList,4);
        Assert.assertNull(failure,failure);
      }
    }
  }
  finally {
    for (    QuorumPeer quorumPeer : peerList) {
      quorumPeer.shutdown();
    }
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.FLENewEpochTest </h4><pre class="type-9 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testLENewEpoch() throws Exception {
  LOG.info("TestLE: " + getTestName() + ", "+ count);
  for (int i=0; i < count; i++) {
    peers.put(Long.valueOf(i),new QuorumServer(i,new InetSocketAddress("127.0.0.1",PortAssignment.unique()),new InetSocketAddress("127.0.0.1",PortAssignment.unique())));
    tmpdir[i]=ClientBase.createTmpDir();
    port[i]=PortAssignment.unique();
  }
  for (int i=1; i < count; i++) {
    QuorumPeer peer=new QuorumPeer(peers,tmpdir[i],tmpdir[i],port[i],3,i,1000,2,2);
    peer.startLeaderElection();
    LEThread thread=new LEThread(peer,i);
    thread.start();
    threads.add(thread);
  }
  if (!start0.tryAcquire(4000,java.util.concurrent.TimeUnit.MILLISECONDS))   Assert.fail("First leader election failed");
  QuorumPeer peer=new QuorumPeer(peers,tmpdir[0],tmpdir[0],port[0],3,0,1000,2,2);
  peer.startLeaderElection();
  LEThread thread=new LEThread(peer,0);
  thread.start();
  threads.add(thread);
  LOG.info("Started threads " + getTestName());
  for (int i=0; i < threads.size(); i++) {
    threads.get(i).join(10000);
    if (threads.get(i).isAlive()) {
      Assert.fail("Threads didn't join");
    }
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.FLERestartTest </h4><pre class="type-9 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testLERestart() throws Exception {
  LOG.info("TestLE: " + getTestName() + ", "+ count);
  for (int i=0; i < count; i++) {
    peers.put(Long.valueOf(i),new QuorumServer(i,new InetSocketAddress("127.0.0.1",PortAssignment.unique()),new InetSocketAddress("127.0.0.1",PortAssignment.unique())));
    tmpdir[i]=ClientBase.createTmpDir();
    port[i]=PortAssignment.unique();
  }
  for (int i=0; i < count; i++) {
    QuorumPeer peer=new QuorumPeer(peers,tmpdir[i],tmpdir[i],port[i],3,i,1000,2,2);
    peer.startLeaderElection();
    FLERestartThread thread=new FLERestartThread(peer,i);
    thread.start();
    restartThreads.add(thread);
  }
  LOG.info("Started threads " + getTestName());
  for (int i=0; i < restartThreads.size(); i++) {
    restartThreads.get(i).join(10000);
    if (restartThreads.get(i).isAlive()) {
      Assert.fail("Threads didn't join");
    }
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.FLEZeroWeightTest </h4><pre class="type-9 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testZeroWeightQuorum() throws Exception {
  LOG.info("TestZeroWeightQuorum: " + getTestName() + ", "+ count);
  for (int i=0; i < count; i++) {
    InetSocketAddress addr1=new InetSocketAddress("127.0.0.1",PortAssignment.unique());
    InetSocketAddress addr2=new InetSocketAddress("127.0.0.1",PortAssignment.unique());
    InetSocketAddress addr3=new InetSocketAddress("127.0.0.1",PortAssignment.unique());
    port[i]=addr3.getPort();
    qp.setProperty("server." + i,"127.0.0.1:" + addr1.getPort() + ":"+ addr2.getPort()+ ";"+ port[i]);
    peers.put(Long.valueOf(i),new QuorumServer(i,addr1,addr2,addr3));
    tmpdir[i]=ClientBase.createTmpDir();
  }
  for (int i=0; i < count; i++) {
    QuorumHierarchical hq=new QuorumHierarchical(qp);
    QuorumPeer peer=new QuorumPeer(peers,tmpdir[i],tmpdir[i],port[i],3,i,1000,2,2,hq);
    peer.startLeaderElection();
    LEThread thread=new LEThread(peer,i);
    thread.start();
    threads.add(thread);
  }
  LOG.info("Started threads " + getTestName());
  for (int i=0; i < threads.size(); i++) {
    threads.get(i).join(15000);
    if (threads.get(i).isAlive()) {
      Assert.fail("Threads didn't join");
    }
 else {
      if (threads.get(i).fail)       Assert.fail("Elected zero-weight server");
    }
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.FourLetterWordsTest </h4><pre class="type-9 type-5 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
"></span><br>
@Test public void testValidateConsOutput() throws Exception {
  ZooKeeper zk1=createClient();
  ZooKeeper zk2=createClient();
  String resp=sendRequest("cons");
  BufferedReader in=new BufferedReader(new StringReader(resp));
  String line;
  int count=0;
  while ((line=in.readLine()) != null && line.length() > 0) {
    count++;
    Assert.assertTrue(line,Pattern.matches("^ /.*:\\d+\\[\\d+\\]\\(queued=\\d+,recved=\\d+,sent=\\d+.*\\)$",line));
  }
  Assert.assertTrue(count >= 2);
  zk1.close();
  zk2.close();
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
"></span><br>
@Test public void testValidateStatOutput() throws Exception {
  ZooKeeper zk1=createClient();
  ZooKeeper zk2=createClient();
  String resp=sendRequest("stat");
  BufferedReader in=new BufferedReader(new StringReader(resp));
  String line;
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^.*\\s\\d+\\.\\d+\\.\\d+-.*$",line));
  Assert.assertTrue(Pattern.matches("^Clients:$",in.readLine()));
  int count=0;
  while ((line=in.readLine()).length() > 0) {
    count++;
    Assert.assertTrue(Pattern.matches("^ /.*:\\d+\\[\\d+\\]\\(queued=\\d+,recved=\\d+,sent=\\d+\\)$",line));
  }
  Assert.assertTrue(count >= 2);
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Latency min/avg/max: \\d+/\\d+/\\d+$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Received: \\d+$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Sent: \\d+$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Connections: \\d+$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Outstanding: \\d+$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Zxid: 0x[\\da-fA-F]+$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Mode: .*$",line));
  line=in.readLine();
  Assert.assertTrue(Pattern.matches("^Node count: \\d+$",line));
  zk1.close();
  zk2.close();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.GetChildren2Test </h4><pre class="type-9 type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testChildren() throws IOException, KeeperException, InterruptedException {
  String name="/foo";
  zk.create(name,name.getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  List<String> children=new ArrayList<String>();
  List<String> children_s=new ArrayList<String>();
  for (int i=0; i < 10; i++) {
    String childname=name + "/bar" + i;
    String childname_s="bar" + i;
    children.add(childname);
    children_s.add(childname_s);
  }
  for (int i=0; i < children.size(); i++) {
    String childname=children.get(i);
    zk.create(childname,childname.getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
    Stat stat=new Stat();
    List<String> s=zk.getChildren(name,false,stat);
    Assert.assertEquals(stat.getCzxid(),stat.getMzxid());
    Assert.assertEquals(stat.getCzxid() + i + 1,stat.getPzxid());
    Assert.assertEquals(stat.getCtime(),stat.getMtime());
    Assert.assertEquals(i + 1,stat.getCversion());
    Assert.assertEquals(0,stat.getVersion());
    Assert.assertEquals(0,stat.getAversion());
    Assert.assertEquals(0,stat.getEphemeralOwner());
    Assert.assertEquals(name.length(),stat.getDataLength());
    Assert.assertEquals(i + 1,stat.getNumChildren());
    Assert.assertEquals(s.size(),stat.getNumChildren());
  }
  List<String> p=zk.getChildren(name,false,null);
  List<String> c_a=children_s;
  List<String> c_b=p;
  Collections.sort(c_a);
  Collections.sort(c_b);
  Assert.assertEquals(c_a.size(),10);
  Assert.assertEquals(c_a,c_b);
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.LETest </h4><pre class="type-9 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testLE() throws Exception {
  int count=30;
  HashMap<Long,QuorumServer> peers=new HashMap<Long,QuorumServer>(count);
  ArrayList<LEThread> threads=new ArrayList<LEThread>(count);
  File tmpdir[]=new File[count];
  int port[]=new int[count];
  votes=new Vote[count];
  for (int i=0; i < count; i++) {
    peers.put(Long.valueOf(i),new QuorumServer(i,new InetSocketAddress("127.0.0.1",PortAssignment.unique())));
    tmpdir[i]=ClientBase.createTmpDir();
    port[i]=PortAssignment.unique();
  }
  LeaderElection le[]=new LeaderElection[count];
  leaderDies=true;
  boolean allowOneBadLeader=leaderDies;
  for (int i=0; i < le.length; i++) {
    QuorumPeer peer=new QuorumPeer(peers,tmpdir[i],tmpdir[i],port[i],0,i,1000,2,2);
    peer.startLeaderElection();
    le[i]=new LeaderElection(peer);
    LEThread thread=new LEThread(le[i],peer,i);
    thread.start();
    threads.add(thread);
  }
  for (int i=0; i < threads.size(); i++) {
    threads.get(i).join(15000);
    if (threads.get(i).isAlive()) {
      Assert.fail("Threads didn't join");
    }
  }
  long id=votes[0].getId();
  for (int i=1; i < votes.length; i++) {
    if (votes[i] == null) {
      Assert.fail("Thread " + i + " had a null vote");
    }
    if (votes[i].getId() != id) {
      if (allowOneBadLeader && votes[i].getId() == i) {
        allowOneBadLeader=false;
      }
 else {
        Assert.fail("Thread " + i + " got "+ votes[i].getId()+ " expected "+ id);
      }
    }
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.LoadFromLogTest </h4><pre class="type-9 type-2 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
/** 
 * test that all transactions from the Log are loaded, and only once
 * @throws Exception an exception might be thrown here
 */
@Test public void testLoad() throws Exception {
  File tmpDir=ClientBase.createTmpDir();
  ClientBase.setupTestEnv();
  ZooKeeperServer zks=new ZooKeeperServer(tmpDir,tmpDir,3000);
  SyncRequestProcessor.setSnapCount(100);
  final int PORT=Integer.parseInt(HOSTPORT.split(":")[1]);
  ServerCnxnFactory f=ServerCnxnFactory.createFactory(PORT,-1);
  f.startup(zks);
  Assert.assertTrue("waiting for server being up ",ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));
  ZooKeeper zk=new ZooKeeper(HOSTPORT,CONNECTION_TIMEOUT,this);
  try {
    for (int i=0; i < NUM_MESSAGES; i++) {
      zk.create("/invalidsnap-" + i,new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    }
  }
  finally {
    zk.close();
  }
  f.shutdown();
  Assert.assertTrue("waiting for server to shutdown",ClientBase.waitForServerDown(HOSTPORT,CONNECTION_TIMEOUT));
  File logDir=new File(tmpDir,FileTxnSnapLog.version + FileTxnSnapLog.VERSION);
  FileTxnLog txnLog=new FileTxnLog(logDir);
  TxnIterator itr=txnLog.read(0);
  FileTxnIterator fileItr=(FileTxnIterator)itr;
  long storageSize=fileItr.getStorageSize();
  LOG.info("Txnlog size: " + storageSize + " bytes");
  Assert.assertTrue("Storage size is greater than zero ",(storageSize > 0));
  long expectedZxid=0;
  long lastZxid=0;
  TxnHeader hdr;
  do {
    hdr=itr.getHeader();
    expectedZxid++;
    Assert.assertTrue("not the same transaction. lastZxid=" + lastZxid + ", zxid="+ hdr.getZxid(),lastZxid != hdr.getZxid());
    Assert.assertTrue("excepting next transaction. expected=" + expectedZxid + ", retreived="+ hdr.getZxid(),(hdr.getZxid() == expectedZxid));
    lastZxid=hdr.getZxid();
  }
 while (itr.next());
  Assert.assertTrue("processed all transactions. " + expectedZxid + " == "+ TOTAL_TRANSACTIONS,(expectedZxid == TOTAL_TRANSACTIONS));
  zks.shutdown();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.MultiTransactionTest </h4><pre class="type-9 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testChRootSetData() throws Exception {
  String chRoot=createNameSpace();
  zk_chroot=createClient(this.hostPort + chRoot);
  String[] names={"/multi0","/multi1","/multi2"};
  List<Op> ops=new ArrayList<Op>();
  for (int i=0; i < names.length; i++) {
    ops.add(Op.create(names[i],new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT));
    ops.add(Op.setData(names[i],names[i].getBytes(),0));
  }
  multi(zk_chroot,ops);
  for (int i=0; i < names.length; i++) {
    Assert.assertArrayEquals("zNode data not matching",names[i].getBytes(),zk_chroot.getData(names[i],false,null));
  }
}

</code></pre>

<br>
<pre class="type-9 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testSetData() throws Exception {
  String[] names={"/multi0","/multi1","/multi2"};
  List<Op> ops=new ArrayList<Op>();
  for (int i=0; i < names.length; i++) {
    ops.add(Op.create(names[i],new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT));
    ops.add(Op.setData(names[i],names[i].getBytes(),0));
  }
  multi(zk,ops);
  for (int i=0; i < names.length; i++) {
    Assert.assertArrayEquals(names[i].getBytes(),zk.getData(names[i],false,null));
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.QuorumTest </h4><pre class="type-9 type-3 type-2 type-6 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Make sure that we can change sessions
 * from follower to leader.
 * @throws IOException
 * @throws InterruptedException
 * @throws KeeperException
 */
@Test public void testSessionMoved() throws Exception {
  String hostPorts[]=qb.hostPort.split(",");
  DisconnectableZooKeeper zk=new DisconnectableZooKeeper(hostPorts[0],ClientBase.CONNECTION_TIMEOUT,new Watcher(){
    public void process(    WatchedEvent event){
    }
  }
);
  zk.create("/sessionMoveTest",new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
  for (int i=0; i < hostPorts.length * 2; i++) {
    zk.dontReconnect();
    DisconnectableZooKeeper zknew=new DisconnectableZooKeeper(hostPorts[(i + 1) % hostPorts.length],ClientBase.CONNECTION_TIMEOUT,new Watcher(){
      public void process(      WatchedEvent event){
      }
    }
,zk.getSessionId(),zk.getSessionPasswd());
    zknew.setData("/",new byte[1],-1);
    final int result[]=new int[1];
    result[0]=Integer.MAX_VALUE;
    zknew.sync("/",new AsyncCallback.VoidCallback(){
      public void processResult(      int rc,      String path,      Object ctx){
synchronized (result) {
          result[0]=rc;
          result.notify();
        }
      }
    }
,null);
synchronized (result) {
      if (result[0] == Integer.MAX_VALUE) {
        result.wait(5000);
      }
    }
    LOG.info(hostPorts[(i + 1) % hostPorts.length] + " Sync returned " + result[0]);
    Assert.assertTrue(result[0] == KeeperException.Code.OK.intValue());
    try {
      zk.setData("/",new byte[1],-1);
      Assert.fail("Should have lost the connection");
    }
 catch (    KeeperException.ConnectionLossException e) {
    }
    zk=zknew;
  }
  zk.close();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.ReadOnlyModeTest </h4><pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
/** 
 * Ensures that upon connection to a read-only server client receives
 * ConnectedReadOnly state notification.
 */
@Test(timeout=90000) public void testConnectionEvents() throws Exception {
  final List<KeeperState> states=new ArrayList<KeeperState>();
  ZooKeeper zk=new ZooKeeper(qu.getConnString(),CONNECTION_TIMEOUT,new Watcher(){
    public void process(    WatchedEvent event){
      states.add(event.getState());
    }
  }
,true);
  boolean success=false;
  for (int i=0; i < 30; i++) {
    try {
      zk.create("/test","test".getBytes(),ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
      success=true;
      break;
    }
 catch (    KeeperException.ConnectionLossException e) {
      Thread.sleep(1000);
    }
  }
  Assert.assertTrue("Did not succeed in connecting in 30s",success);
  qu.shutdown(2);
  zk=new ZooKeeper(qu.getConnString(),CONNECTION_TIMEOUT,new Watcher(){
    public void process(    WatchedEvent event){
      states.add(event.getState());
    }
  }
,true);
  long start=Time.currentElapsedTime();
  while (!(zk.getState() == States.CONNECTEDREADONLY)) {
    Thread.sleep(200);
    Assert.assertTrue("Can't connect to the server",Time.currentElapsedTime() - start < 30000);
  }
  Assert.assertTrue("ConnectedReadOnly event wasn't received",states.get(2) == KeeperState.ConnectedReadOnly);
  zk.close();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.ReconfigTest </h4><pre class="type-9 type-5 type-10 type-2 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testRoleChange() throws Exception {
  qu=new QuorumUtil(1);
  qu.disableJMXTest=true;
  qu.startAll();
  ZooKeeper[] zkArr=createHandles(qu);
  List<String> joiningServers=new ArrayList<String>();
  int leaderIndex=getLeaderId(qu);
  int changingIndex=(leaderIndex == 1) ? 2 : 1;
  String newRole="observer";
  for (int i=0; i < 4; i++) {
    ZooKeeper zk1=(changingIndex == leaderIndex) ? zkArr[leaderIndex] : zkArr[(leaderIndex % qu.ALL) + 1];
    joiningServers.add("server." + changingIndex + "=localhost:"+ qu.getPeer(changingIndex).peer.getQuorumAddress().getPort()+ ":"+ qu.getPeer(changingIndex).peer.getElectionAddress().getPort()+ ":"+ newRole+ ";localhost:"+ qu.getPeer(changingIndex).peer.getClientPort());
    reconfig(zk1,joiningServers,null,null,-1);
    testNormalOperation(zkArr[changingIndex],zk1);
    if (newRole.equals("observer")) {
      Assert.assertTrue(qu.getPeer(changingIndex).peer.observer != null && qu.getPeer(changingIndex).peer.follower == null && qu.getPeer(changingIndex).peer.leader == null);
      Assert.assertTrue(qu.getPeer(changingIndex).peer.getPeerState() == ServerState.OBSERVING);
    }
 else {
      Assert.assertTrue(qu.getPeer(changingIndex).peer.observer == null && (qu.getPeer(changingIndex).peer.follower != null || qu.getPeer(changingIndex).peer.leader != null));
      Assert.assertTrue(qu.getPeer(changingIndex).peer.getPeerState() == ServerState.FOLLOWING || qu.getPeer(changingIndex).peer.getPeerState() == ServerState.LEADING);
    }
    joiningServers.clear();
    if (newRole.equals("observer")) {
      newRole="participant";
    }
 else {
      newRole="observer";
      leaderIndex=getLeaderId(qu);
      changingIndex=leaderIndex;
    }
  }
  closeAllHandles(zkArr);
}

</code></pre>

<br>
<pre class="type-9 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testRemoveAddOne() throws Exception {
  qu=new QuorumUtil(1);
  qu.disableJMXTest=true;
  qu.startAll();
  ZooKeeper[] zkArr=createHandles(qu);
  List<String> leavingServers=new ArrayList<String>();
  List<String> joiningServers=new ArrayList<String>();
  int leaderIndex=getLeaderId(qu);
  int leavingIndex=(leaderIndex == 1) ? 2 : 1;
  for (int i=0; i < 2; i++) {
    ZooKeeper zk1=(leavingIndex == leaderIndex) ? zkArr[leaderIndex] : zkArr[(leaderIndex % qu.ALL) + 1];
    ZooKeeper zk2=(leavingIndex == leaderIndex) ? zkArr[(leaderIndex % qu.ALL) + 1] : zkArr[leaderIndex];
    leavingServers.add(Integer.toString(leavingIndex));
    joiningServers.add("server." + leavingIndex + "=localhost:"+ qu.getPeer(leavingIndex).peer.getQuorumAddress().getPort()+ ":"+ qu.getPeer(leavingIndex).peer.getElectionAddress().getPort()+ ":participant;localhost:"+ qu.getPeer(leavingIndex).peer.getClientPort());
    String configStr=reconfig(zk1,null,leavingServers,null,-1);
    testServerHasConfig(zk2,null,leavingServers);
    testNormalOperation(zk2,zk1);
    QuorumVerifier qv=qu.getPeer(1).peer.configFromString(configStr);
    long version=qv.getVersion();
    try {
      reconfig(zk2,joiningServers,null,null,version + 1);
      Assert.fail("reconfig succeeded even though version condition was incorrect!");
    }
 catch (    KeeperException.BadVersionException e) {
    }
    reconfig(zk2,joiningServers,null,null,version);
    testNormalOperation(zk1,zk2);
    testServerHasConfig(zk1,joiningServers,null);
    leavingIndex=leaderIndex=getLeaderId(qu);
    leavingServers.clear();
    joiningServers.clear();
  }
  closeAllHandles(zkArr);
}

</code></pre>

<br>
<pre class="type-9 type-5 type-3 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testPortChange() throws Exception {
  qu=new QuorumUtil(1);
  qu.disableJMXTest=true;
  qu.startAll();
  ZooKeeper[] zkArr=createHandles(qu);
  List<String> joiningServers=new ArrayList<String>();
  int leaderIndex=getLeaderId(qu);
  int followerIndex=leaderIndex == 1 ? 2 : 1;
  int quorumPort=qu.getPeer(followerIndex).peer.getQuorumAddress().getPort();
  int electionPort=qu.getPeer(followerIndex).peer.getElectionAddress().getPort();
  int oldClientPort=qu.getPeer(followerIndex).peer.getClientPort();
  int newClientPort=PortAssignment.unique();
  joiningServers.add("server." + followerIndex + "=localhost:"+ quorumPort+ ":"+ electionPort+ ":participant;localhost:"+ newClientPort);
  testNormalOperation(zkArr[followerIndex],zkArr[leaderIndex]);
  reconfig(zkArr[followerIndex],joiningServers,null,null,-1);
  try {
    for (int i=0; i < 20; i++) {
      Thread.sleep(1000);
      zkArr[followerIndex].setData("/test","teststr".getBytes(),-1);
    }
  }
 catch (  KeeperException.ConnectionLossException e) {
    Assert.fail("Existing client disconnected when client port changed!");
  }
  zkArr[followerIndex].close();
  zkArr[followerIndex]=new ZooKeeper("127.0.0.1:" + oldClientPort,ClientBase.CONNECTION_TIMEOUT,new Watcher(){
    public void process(    WatchedEvent event){
    }
  }
);
  for (int i=0; i < 10; i++) {
    try {
      Thread.sleep(1000);
      zkArr[followerIndex].setData("/test","teststr".getBytes(),-1);
      Assert.fail("New client connected to old client port!");
    }
 catch (    KeeperException.ConnectionLossException e) {
    }
  }
  zkArr[followerIndex].close();
  zkArr[followerIndex]=new ZooKeeper("127.0.0.1:" + newClientPort,ClientBase.CONNECTION_TIMEOUT,new Watcher(){
    public void process(    WatchedEvent event){
    }
  }
);
  testNormalOperation(zkArr[followerIndex],zkArr[leaderIndex]);
  testServerHasConfig(zkArr[followerIndex],joiningServers,null);
  Assert.assertEquals(newClientPort,qu.getPeer(followerIndex).peer.getClientPort());
  joiningServers.clear();
  int newQuorumPort=PortAssignment.unique();
  joiningServers.add("server." + leaderIndex + "=localhost:"+ newQuorumPort+ ":"+ qu.getPeer(leaderIndex).peer.getElectionAddress().getPort()+ ":participant;localhost:"+ qu.getPeer(leaderIndex).peer.getClientPort());
  reconfig(zkArr[leaderIndex],joiningServers,null,null,-1);
  testNormalOperation(zkArr[followerIndex],zkArr[leaderIndex]);
  Assert.assertTrue(qu.getPeer(leaderIndex).peer.getQuorumAddress().getPort() == newQuorumPort);
  Assert.assertTrue(getLeaderId(qu) != leaderIndex);
  joiningServers.clear();
  for (int i=1; i <= 3; i++) {
    joiningServers.add("server." + i + "=localhost:"+ qu.getPeer(i).peer.getQuorumAddress().getPort()+ ":"+ PortAssignment.unique()+ ":participant;localhost:"+ qu.getPeer(i).peer.getClientPort());
  }
  reconfig(zkArr[1],joiningServers,null,null,-1);
  leaderIndex=getLeaderId(qu);
  int follower1=leaderIndex == 1 ? 2 : 1;
  int follower2=1;
  while (follower2 == leaderIndex || follower2 == follower1)   follower2++;
  qu.shutdown(getLeaderId(qu));
  testNormalOperation(zkArr[follower2],zkArr[follower1]);
  testServerHasConfig(zkArr[follower1],joiningServers,null);
  testServerHasConfig(zkArr[follower2],joiningServers,null);
  closeAllHandles(zkArr);
}

</code></pre>

<br>
<pre class="type-9 type-10 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@Test public void testQuorumSystemChange() throws Exception {
  qu=new QuorumUtil(3);
  qu.disableJMXTest=true;
  qu.startAll();
  ZooKeeper[] zkArr=createHandles(qu);
  ArrayList<String> members=new ArrayList<String>();
  members.add("group.1=3:4:5");
  members.add("group.2=1:2");
  members.add("weight.1=0");
  members.add("weight.2=0");
  members.add("weight.3=1");
  members.add("weight.4=1");
  members.add("weight.5=1");
  for (int i=1; i <= 5; i++) {
    members.add("server." + i + "=127.0.0.1:"+ qu.getPeer(i).peer.getQuorumAddress().getPort()+ ":"+ qu.getPeer(i).peer.getElectionAddress().getPort()+ ";"+ "127.0.0.1:"+ qu.getPeer(i).peer.getClientPort());
  }
  reconfig(zkArr[1],null,null,members,-1);
  testNormalOperation(zkArr[2],zkArr[3]);
  testNormalOperation(zkArr[4],zkArr[5]);
  for (int i=1; i <= 5; i++) {
    if (!(qu.getPeer(i).peer.quorumVerifier instanceof QuorumHierarchical))     Assert.fail("peer " + i + " doesn't think the quorum system is Hieararchical!");
  }
  qu.shutdown(1);
  qu.shutdown(2);
  qu.shutdown(3);
  qu.shutdown(7);
  qu.shutdown(6);
  testNormalOperation(zkArr[4],zkArr[5]);
  qu.restart(1);
  qu.restart(2);
  members.clear();
  for (int i=1; i <= 3; i++) {
    members.add("server." + i + "=127.0.0.1:"+ qu.getPeer(i).peer.getQuorumAddress().getPort()+ ":"+ qu.getPeer(i).peer.getElectionAddress().getPort()+ ";"+ "127.0.0.1:"+ qu.getPeer(i).peer.getClientPort());
  }
  reconfig(zkArr[1],null,null,members,-1);
  testNormalOperation(zkArr[1],zkArr[2]);
  qu.shutdown(4);
  qu.shutdown(5);
  testNormalOperation(zkArr[1],zkArr[2]);
  for (int i=1; i <= 2; i++) {
    if (!(qu.getPeer(i).peer.quorumVerifier instanceof QuorumMaj))     Assert.fail("peer " + i + " doesn't think the quorum system is a majority quorum system!");
  }
  closeAllHandles(zkArr);
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testInitialConfigHasPositiveVersion() throws Exception {
  qu=new QuorumUtil(1);
  qu.disableJMXTest=true;
  qu.startAll();
  ZooKeeper[] zkArr=createHandles(qu);
  testNormalOperation(zkArr[1],zkArr[2]);
  for (int i=1; i < 4; i++) {
    String configStr=testServerHasConfig(zkArr[i],null,null);
    QuorumVerifier qv=qu.getPeer(i).peer.configFromString(configStr);
    long version=qv.getVersion();
    Assert.assertTrue(version == 0x100000000L);
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.RecoveryTest </h4><pre class="type-9 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Verify that if a server goes down that clients will reconnect
 * automatically after the server is restarted. Note that this requires the
 * server to restart within the connection timeout period.
 * Also note that the client latches are used to eliminate any chance
 * of spurrious connectionloss exceptions on the read ops. Specifically
 * a sync operation will throw this exception if the server goes down
 * (as recognized by the client) during the operation. If the operation
 * occurs after the server is down, but before the client recognizes
 * that the server is down (ping) then the op will throw connectionloss.
 */
@Test public void testRecovery() throws Exception {
  File tmpDir=ClientBase.createTmpDir();
  ClientBase.setupTestEnv();
  ZooKeeperServer zks=new ZooKeeperServer(tmpDir,tmpDir,3000);
  int oldSnapCount=SyncRequestProcessor.getSnapCount();
  SyncRequestProcessor.setSnapCount(1000);
  try {
    final int PORT=Integer.parseInt(HOSTPORT.split(":")[1]);
    ServerCnxnFactory f=ServerCnxnFactory.createFactory(PORT,-1);
    f.startup(zks);
    LOG.info("starting up the the server, waiting");
    Assert.assertTrue("waiting for server up",ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));
    startSignal=new CountDownLatch(1);
    ZooKeeper zk=new ZooKeeper(HOSTPORT,CONNECTION_TIMEOUT,this);
    startSignal.await(CONNECTION_TIMEOUT,TimeUnit.MILLISECONDS);
    Assert.assertTrue("count == 0",startSignal.getCount() == 0);
    String path;
    LOG.info("starting creating nodes");
    for (int i=0; i < 10; i++) {
      path="/" + i;
      zk.create(path,(path + "!").getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
      for (int j=0; j < 10; j++) {
        String subpath=path + "/" + j;
        zk.create(subpath,(subpath + "!").getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
        for (int k=0; k < 20; k++) {
          String subsubpath=subpath + "/" + k;
          zk.create(subsubpath,(subsubpath + "!").getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
        }
      }
    }
    f.shutdown();
    zks.shutdown();
    Assert.assertTrue("waiting for server down",ClientBase.waitForServerDown(HOSTPORT,CONNECTION_TIMEOUT));
    zks=new ZooKeeperServer(tmpDir,tmpDir,3000);
    f=ServerCnxnFactory.createFactory(PORT,-1);
    startSignal=new CountDownLatch(1);
    f.startup(zks);
    Assert.assertTrue("waiting for server up",ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));
    startSignal.await(CONNECTION_TIMEOUT,TimeUnit.MILLISECONDS);
    Assert.assertTrue("count == 0",startSignal.getCount() == 0);
    Stat stat=new Stat();
    for (int i=0; i < 10; i++) {
      path="/" + i;
      LOG.info("Checking " + path);
      Assert.assertEquals(new String(zk.getData(path,false,stat)),path + "!");
      for (int j=0; j < 10; j++) {
        String subpath=path + "/" + j;
        Assert.assertEquals(new String(zk.getData(subpath,false,stat)),subpath + "!");
        for (int k=0; k < 20; k++) {
          String subsubpath=subpath + "/" + k;
          Assert.assertEquals(new String(zk.getData(subsubpath,false,stat)),subsubpath + "!");
        }
      }
    }
    f.shutdown();
    zks.shutdown();
    Assert.assertTrue("waiting for server down",ClientBase.waitForServerDown(HOSTPORT,ClientBase.CONNECTION_TIMEOUT));
    zks=new ZooKeeperServer(tmpDir,tmpDir,3000);
    f=ServerCnxnFactory.createFactory(PORT,-1);
    startSignal=new CountDownLatch(1);
    f.startup(zks);
    Assert.assertTrue("waiting for server up",ClientBase.waitForServerUp(HOSTPORT,CONNECTION_TIMEOUT));
    startSignal.await(CONNECTION_TIMEOUT,TimeUnit.MILLISECONDS);
    Assert.assertTrue("count == 0",startSignal.getCount() == 0);
    stat=new Stat();
    LOG.info("Check 2");
    for (int i=0; i < 10; i++) {
      path="/" + i;
      Assert.assertEquals(new String(zk.getData(path,false,stat)),path + "!");
      for (int j=0; j < 10; j++) {
        String subpath=path + "/" + j;
        Assert.assertEquals(new String(zk.getData(subpath,false,stat)),subpath + "!");
        for (int k=0; k < 20; k++) {
          String subsubpath=subpath + "/" + k;
          Assert.assertEquals(new String(zk.getData(subsubpath,false,stat)),subsubpath + "!");
        }
      }
    }
    zk.close();
    f.shutdown();
    zks.shutdown();
    Assert.assertTrue("waiting for server down",ClientBase.waitForServerDown(HOSTPORT,CONNECTION_TIMEOUT));
  }
  finally {
    SyncRequestProcessor.setSnapCount(oldSnapCount);
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.SSLTest </h4><pre class="type-9 type-10 type-3 type-2 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks that SSL works in cluster setup of ZK servers, which includes:
 * 1. setting "secureClientPort" in "zoo.cfg" file.
 * 2. setting jvm flags for serverCnxn, keystore, truststore.
 * Finally, a zookeeper client should be able to connect to the secure port and
 * communicate with server via secure connection.
 * <p/>
 * Note that in this test a ZK server has two ports -- clientPort and secureClientPort.
 */
@Test public void testSecureQuorumServer() throws Exception {
  final int SERVER_COUNT=3;
  final int clientPorts[]=new int[SERVER_COUNT];
  final Integer secureClientPorts[]=new Integer[SERVER_COUNT];
  StringBuilder sb=new StringBuilder();
  for (int i=0; i < SERVER_COUNT; i++) {
    clientPorts[i]=PortAssignment.unique();
    secureClientPorts[i]=PortAssignment.unique();
    String server=String.format("server.%d=localhost:%d:%d:participant;localhost:%d",i,PortAssignment.unique(),PortAssignment.unique(),clientPorts[i]);
    sb.append(server + "\n");
  }
  String quorumCfg=sb.toString();
  MainThread[] mt=new MainThread[SERVER_COUNT];
  for (int i=0; i < SERVER_COUNT; i++) {
    mt[i]=new MainThread(i,quorumCfg,secureClientPorts[i],true);
    mt[i].start();
  }
  for (int i=0; i < SERVER_COUNT; i++) {
    Assert.assertTrue("waiting for server " + i + " being up",ClientBase.waitForServerUp("127.0.0.1:" + clientPorts[i],TIMEOUT));
    final CountDownLatch latch=new CountDownLatch(1);
    ZooKeeper zk=new ZooKeeper("127.0.0.1:" + secureClientPorts[i],TIMEOUT,new Watcher(){
      @Override public void process(      WatchedEvent event){
        if (event.getState() != Event.KeeperState.SyncConnected) {
          Assert.fail("failed to connect to ZK server secure client port");
        }
        latch.countDown();
      }
    }
);
    if (!latch.await(TIMEOUT,TimeUnit.MILLISECONDS)) {
      Assert.fail("Timeout connecting to ZK server secure port");
    }
    zk.create("/test","".getBytes(),ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
    zk.delete("/test",-1);
    zk.close();
  }
  for (int i=0; i < mt.length; i++) {
    mt[i].shutdown();
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.SessionTest </h4><pre class="type-9 type-3 type-2 type-6 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Make sure that we cannot have two connections with the same
 * session id.
 * @throws IOException
 * @throws InterruptedException
 * @throws KeeperException
 */
@Test public void testSessionMove() throws Exception {
  String hostPorts[]=HOSTPORT.split(",");
  DisconnectableZooKeeper zk=new DisconnectableZooKeeper(hostPorts[0],CONNECTION_TIMEOUT,new MyWatcher("0"));
  zk.create("/sessionMoveTest",new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
  for (int i=0; i < hostPorts.length * 2; i++) {
    zk.dontReconnect();
    DisconnectableZooKeeper zknew=new DisconnectableZooKeeper(hostPorts[(i + 1) % hostPorts.length],CONNECTION_TIMEOUT,new MyWatcher(Integer.toString(i + 1)),zk.getSessionId(),zk.getSessionPasswd());
    final int result[]=new int[1];
    result[0]=Integer.MAX_VALUE;
    zknew.sync("/",new AsyncCallback.VoidCallback(){
      public void processResult(      int rc,      String path,      Object ctx){
synchronized (result) {
          result[0]=rc;
          result.notify();
        }
      }
    }
,null);
synchronized (result) {
      if (result[0] == Integer.MAX_VALUE) {
        result.wait(5000);
      }
    }
    LOG.info(hostPorts[(i + 1) % hostPorts.length] + " Sync returned " + result[0]);
    Assert.assertTrue(result[0] == KeeperException.Code.OK.intValue());
    zknew.setData("/",new byte[1],-1);
    try {
      zk.setData("/",new byte[1],-1);
      Assert.fail("Should have lost the connection");
    }
 catch (    KeeperException.ConnectionLossException e) {
      LOG.info("Got connection loss exception as expected");
    }
    zk=zknew;
  }
  zk.close();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.StatTest </h4><pre class="type-9 type-6 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testChildren() throws IOException, KeeperException, InterruptedException {
  String name="/foo";
  zk.create(name,name.getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  for (int i=0; i < 10; i++) {
    String childname=name + "/bar" + i;
    zk.create(childname,childname.getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
    Stat stat;
    stat=newStat();
    zk.getData(name,false,stat);
    Assert.assertEquals(stat.getCzxid(),stat.getMzxid());
    Assert.assertEquals(stat.getCzxid() + i + 1,stat.getPzxid());
    Assert.assertEquals(stat.getCtime(),stat.getMtime());
    Assert.assertEquals(i + 1,stat.getCversion());
    Assert.assertEquals(0,stat.getVersion());
    Assert.assertEquals(0,stat.getAversion());
    Assert.assertEquals(0,stat.getEphemeralOwner());
    Assert.assertEquals(name.length(),stat.getDataLength());
    Assert.assertEquals(i + 1,stat.getNumChildren());
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.StaticHostProviderTest </h4><pre class="type-9 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testUpdateMigrationGoesRound() throws UnknownHostException {
  HostProvider hostProvider=getHostProvider((byte)4);
  Collection<InetSocketAddress> newList=new ArrayList<InetSocketAddress>(10);
  for (byte i=12; i > 2; i--) {
    newList.add(new InetSocketAddress(InetAddress.getByAddress(new byte[]{10,10,10,i}),1234 + i));
  }
  Collection<InetSocketAddress> oldStaying=new ArrayList<InetSocketAddress>(2);
  for (byte i=4; i > 2; i--) {
    oldStaying.add(new InetSocketAddress(InetAddress.getByAddress(new byte[]{10,10,10,i}),1234 + i));
  }
  Collection<InetSocketAddress> newComing=new ArrayList<InetSocketAddress>(10);
  for (byte i=12; i > 4; i--) {
    newComing.add(new InetSocketAddress(InetAddress.getByAddress(new byte[]{10,10,10,i}),1234 + i));
  }
  boolean disconnectRequired=hostProvider.updateServerList(newList,new InetSocketAddress(InetAddress.getByAddress(new byte[]{10,10,10,1}),1235));
  assertTrue(disconnectRequired);
  ArrayList<InetSocketAddress> seen=new ArrayList<InetSocketAddress>();
  for (int i=0; i < newComing.size(); i++) {
    InetSocketAddress addr=hostProvider.next(0);
    assertTrue(newComing.contains(addr));
    assertTrue(!seen.contains(addr));
    seen.add(addr);
  }
  seen.clear();
  for (int i=0; i < oldStaying.size(); i++) {
    InetSocketAddress addr=hostProvider.next(0);
    assertTrue(oldStaying.contains(addr));
    assertTrue(!seen.contains(addr));
    seen.add(addr);
  }
  InetSocketAddress first=hostProvider.next(0);
  assertTrue(first != null);
  for (int i=0; i < newList.size() - 1; i++) {
    hostProvider.next(0);
  }
  assertEquals(first,hostProvider.next(0));
  hostProvider.onConnected();
}

</code></pre>

<br>
<pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
@Test public void testReconfigDuringReconfigMode() throws UnknownHostException {
  boolean disconnectRequired;
  StaticHostProvider[] hostProviderArray=new StaticHostProvider[numClients];
  InetSocketAddress[] curHostForEachClient=new InetSocketAddress[numClients];
  int[] numClientsPerHost=new int[9];
  for (int i=0; i < numClients; i++) {
    hostProviderArray[i]=getHostProvider((byte)9);
    curHostForEachClient[i]=hostProviderArray[i].next(0);
  }
  Collection<InetSocketAddress> newList=getServerAddresses((byte)7);
  for (int i=0; i < numClients; i++) {
    hostProviderArray[i].updateServerList(newList,curHostForEachClient[i]);
  }
  newList=getServerAddresses((byte)9);
  for (int i=0; i < numClients; i++) {
    InetSocketAddress myServer=(i < (numClients / 2)) ? null : curHostForEachClient[i];
    disconnectRequired=hostProviderArray[i].updateServerList(newList,myServer);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
 else {
      curHostForEachClient[i]=hostProviderArray[i].getServerAtCurrentIndex();
    }
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 9; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,9));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,9));
  }
}

</code></pre>

<br>
<pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
@Test public void testUpdateLoadBalancing() throws UnknownHostException {
  boolean disconnectRequired;
  HostProvider[] hostProviderArray=new HostProvider[numClients];
  InetSocketAddress[] curHostForEachClient=new InetSocketAddress[numClients];
  int[] numClientsPerHost=new int[9];
  for (int i=0; i < numClients; i++) {
    hostProviderArray[i]=getHostProvider((byte)9);
    curHostForEachClient[i]=hostProviderArray[i].next(0);
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 9; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,9));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,9));
    numClientsPerHost[i]=0;
  }
  Collection<InetSocketAddress> newList=getServerAddresses((byte)8);
  for (int i=0; i < numClients; i++) {
    disconnectRequired=hostProviderArray[i].updateServerList(newList,curHostForEachClient[i]);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 8; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,8));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,8));
    numClientsPerHost[i]=0;
  }
  assertTrue(numClientsPerHost[8] == 0);
  newList=getServerAddresses((byte)6);
  for (int i=0; i < numClients; i++) {
    disconnectRequired=hostProviderArray[i].updateServerList(newList,curHostForEachClient[i]);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 6; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,6));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,6));
    numClientsPerHost[i]=0;
  }
  assertTrue(numClientsPerHost[6] == 0);
  assertTrue(numClientsPerHost[7] == 0);
  assertTrue(numClientsPerHost[8] == 0);
  newList=new ArrayList<InetSocketAddress>(8);
  for (byte i=9; i > 1; i--) {
    newList.add(new InetSocketAddress(InetAddress.getByAddress(new byte[]{10,10,10,i}),1234 + i));
  }
  for (int i=0; i < numClients; i++) {
    disconnectRequired=hostProviderArray[i].updateServerList(newList,curHostForEachClient[i]);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  assertTrue(numClientsPerHost[0] == 0);
  for (int i=1; i < 9; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,8));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,8));
    numClientsPerHost[i]=0;
  }
  newList=getServerAddresses((byte)9);
  for (int i=0; i < numClients; i++) {
    disconnectRequired=hostProviderArray[i].updateServerList(newList,curHostForEachClient[i]);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 9; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,9));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,9));
  }
}

</code></pre>

<br>
<pre class="type-9 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
@Test public void testNoCurrentHostDuringNormalMode() throws UnknownHostException {
  boolean disconnectRequired;
  StaticHostProvider[] hostProviderArray=new StaticHostProvider[numClients];
  InetSocketAddress[] curHostForEachClient=new InetSocketAddress[numClients];
  int[] numClientsPerHost=new int[9];
  for (int i=0; i < numClients; i++) {
    hostProviderArray[i]=getHostProvider((byte)9);
    if (i >= (numClients / 2)) {
      curHostForEachClient[i]=hostProviderArray[i].next(0);
    }
 else {
      curHostForEachClient[i]=null;
    }
  }
  Collection<InetSocketAddress> newList=getServerAddresses((byte)7);
  for (int i=0; i < numClients; i++) {
    disconnectRequired=hostProviderArray[i].updateServerList(newList,curHostForEachClient[i]);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
 else     if (curHostForEachClient[i] == null) {
      curHostForEachClient[i]=hostProviderArray[i].getServerAtIndex(0);
    }
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 7; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,7));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,7));
    numClientsPerHost[i]=0;
  }
  assertTrue(numClientsPerHost[7] == 0);
  assertTrue(numClientsPerHost[8] == 0);
  newList=getServerAddresses((byte)8);
  for (int i=0; i < numClients; i++) {
    InetSocketAddress myServer=(i < (numClients / 2)) ? null : curHostForEachClient[i];
    disconnectRequired=hostProviderArray[i].updateServerList(newList,myServer);
    if (disconnectRequired)     curHostForEachClient[i]=hostProviderArray[i].next(0);
    numClientsPerHost[curHostForEachClient[i].getPort() - 1235]++;
    hostProviderArray[i].onConnected();
  }
  for (int i=0; i < 8; i++) {
    assertTrue(numClientsPerHost[i] <= upperboundCPS(numClients,8));
    assertTrue(numClientsPerHost[i] >= lowerboundCPS(numClients,8));
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-2 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testLiteralIPNoReverseNS() throws Exception {
  byte size=30;
  HostProvider hostProvider=getHostProviderUnresolved(size);
  for (int i=0; i < size; i++) {
    InetSocketAddress next=hostProvider.next(0);
    assertTrue(next instanceof InetSocketAddress);
    assertTrue(!next.isUnresolved());
    assertTrue(!next.toString().startsWith("/"));
    String hostname=next.getHostString();
    hostname.equals(next.getAddress().getHostAddress());
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.SyncCallTest </h4><pre class="type-9 type-10 type-3 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testSync() throws Exception {
  try {
    LOG.info("Starting ZK:" + (new Date()).toString());
    opsCount=new CountDownLatch(limit);
    ZooKeeper zk=createClient();
    LOG.info("Beginning test:" + (new Date()).toString());
    for (int i=0; i < 50; i++)     zk.create("/test" + i,new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT,(StringCallback)this,results);
    for (int i=50; i < 100; i++) {
      zk.create("/test" + i,new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT,(Create2Callback)this,results);
    }
    zk.sync("/test",this,results);
    for (int i=0; i < 100; i++)     zk.delete("/test" + i,0,this,results);
    for (int i=0; i < 100; i++)     zk.getChildren("/",new NullWatcher(),(ChildrenCallback)this,results);
    for (int i=0; i < 100; i++)     zk.getChildren("/",new NullWatcher(),(Children2Callback)this,results);
    LOG.info("Submitted all operations:" + (new Date()).toString());
    if (!opsCount.await(10000,TimeUnit.MILLISECONDS))     Assert.fail("Haven't received all confirmations" + opsCount.getCount());
    for (int i=0; i < limit; i++) {
      Assert.assertEquals(0,(int)results.get(i));
    }
  }
 catch (  IOException e) {
    System.out.println(e.toString());
  }
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.TruncateTest </h4><pre class="type-9 type-3 type-2 type-6 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testTruncationNullLog() throws Exception {
  File tmpdir=ClientBase.createTmpDir();
  FileTxnSnapLog snaplog=new FileTxnSnapLog(tmpdir,tmpdir);
  ZKDatabase zkdb=new ZKDatabase(snaplog);
  for (int i=1; i <= 100; i++) {
    append(zkdb,i);
  }
  zkdb.close();
  File[] logs=snaplog.getDataDir().listFiles();
  for (int i=0; i < logs.length; i++) {
    LOG.debug("Deleting: {}",logs[i].getName());
    Assert.assertTrue("Failed to delete log file: " + logs[i].getName(),logs[i].delete());
  }
  try {
    zkdb.truncateLog(1);
    Assert.assertTrue("Should not get here",false);
  }
 catch (  IOException e) {
    Assert.assertTrue("Should have received an IOException",true);
  }
catch (  NullPointerException npe) {
    Assert.fail("This should not throw NPE!");
  }
  ClientBase.recursiveDelete(tmpdir);
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.WatcherTest </h4><pre class="type-9 type-6 type-4 type-14 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
"></span><br>
/** 
 * Verify that we get all of the events we expect to get. This particular
 * case verifies that we see all of the data events on a particular node.
 * There was a bug (ZOOKEEPER-137) that resulted in events being dropped
 * in some cases (timing).
 * @throws IOException
 * @throws InterruptedException
 * @throws KeeperException
 */
@Test public void testWatcherCorrectness() throws IOException, InterruptedException, KeeperException {
  ZooKeeper zk=null;
  try {
    MyWatcher watcher=new MyWatcher();
    zk=createClient(watcher,hostPort);
    StatCallback scb=new StatCallback(){
      public void processResult(      int rc,      String path,      Object ctx,      Stat stat){
      }
    }
;
    VoidCallback vcb=new VoidCallback(){
      public void processResult(      int rc,      String path,      Object ctx){
      }
    }
;
    String names[]=new String[10];
    for (int i=0; i < names.length; i++) {
      String name=zk.create("/tc-","initialvalue".getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT_SEQUENTIAL);
      names[i]=name;
      Stat stat=new Stat();
      zk.getData(name,watcher,stat);
      zk.setData(name,"new".getBytes(),stat.getVersion(),scb,null);
      stat=zk.exists(name,watcher);
      zk.delete(name,stat.getVersion(),vcb,null);
    }
    for (int i=0; i < names.length; i++) {
      String name=names[i];
      WatchedEvent event=watcher.events.poll(10,TimeUnit.SECONDS);
      Assert.assertEquals(name,event.getPath());
      Assert.assertEquals(Event.EventType.NodeDataChanged,event.getType());
      Assert.assertEquals(Event.KeeperState.SyncConnected,event.getState());
      event=watcher.events.poll(10,TimeUnit.SECONDS);
      Assert.assertEquals(name,event.getPath());
      Assert.assertEquals(Event.EventType.NodeDeleted,event.getType());
      Assert.assertEquals(Event.KeeperState.SyncConnected,event.getState());
    }
  }
  finally {
    if (zk != null) {
      zk.close();
    }
  }
}

</code></pre>

<br>
<pre class="type-9 type-5 type-10 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks that watches for pending requests do not get triggered,
 * but watches set by previous requests do.
 * @throws Exception
 */
@Test public void testWatchAutoResetWithPending() throws Exception {
  MyWatcher watches[]=new MyWatcher[COUNT];
  MyStatCallback cbs[]=new MyStatCallback[COUNT];
  MyWatcher watcher=new MyWatcher();
  int count[]=new int[1];
  TestableZooKeeper zk=createClient(watcher,hostPort,6000);
  ZooKeeper zk2=createClient(watcher,hostPort,5000);
  zk2.create("/test",new byte[0],Ids.OPEN_ACL_UNSAFE,CreateMode.EPHEMERAL);
  for (int i=0; i < COUNT / 2; i++) {
    watches[i]=new MyWatcher();
    cbs[i]=new MyStatCallback();
    zk.exists("/test",watches[i],cbs[i],count);
  }
  zk.exists("/test",false);
  Assert.assertTrue("Failed to pause the connection!",zk.pauseCnxn(3000));
  zk2.close();
  stopServer();
  watches[0].waitForDisconnected(60000);
  for (int i=COUNT / 2; i < COUNT; i++) {
    watches[i]=new MyWatcher();
    cbs[i]=new MyStatCallback();
    zk.exists("/test",watches[i],cbs[i],count);
  }
  startServer();
  watches[COUNT / 2 - 1].waitForConnected(60000);
  Assert.assertEquals(null,zk.exists("/test",false));
  Thread.sleep(10);
  for (int i=0; i < COUNT / 2; i++) {
    Assert.assertEquals("For " + i,1,watches[i].events.size());
  }
  for (int i=COUNT / 2; i < COUNT; i++) {
    if (cbs[i].rc == 0) {
      Assert.assertEquals("For " + i,1,watches[i].events.size());
    }
 else {
      Assert.assertEquals("For " + i,0,watches[i].events.size());
    }
  }
  Assert.assertEquals(COUNT,count[0]);
  zk.close();
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.ZkDatabaseCorruptionTest </h4><pre class="type-9 type-10 type-2 type-6 type-8 type-14 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testCorruption() throws Exception {
  ClientBase.waitForServerUp(qb.hostPort,10000);
  ClientBase.waitForServerUp(qb.hostPort,10000);
  ZooKeeper zk=new ZooKeeper(qb.hostPort,10000,new Watcher(){
    public void process(    WatchedEvent event){
    }
  }
);
  SyncRequestProcessor.setSnapCount(100);
  for (int i=0; i < 2000; i++) {
    zk.create("/0-" + i,new byte[0],ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT,new NoopStringCallback(),null);
  }
  zk.close();
  long leaderSid=1;
  QuorumPeer leader=null;
  for (  QuorumPeer quorumPeer : Arrays.asList(qb.s1,qb.s2,qb.s3,qb.s4,qb.s5)) {
    if (quorumPeer.getPeerState() == ServerState.LEADING) {
      leader=quorumPeer;
      break;
    }
    ++leaderSid;
  }
  Assert.assertNotNull("Cannot find the leader.",leader);
  leader.shutdown();
  FileTxnSnapLog snapLog=leader.getTxnFactory();
  File snapDir=snapLog.getSnapDir();
  corruptAllSnapshots(snapDir);
  qb.shutdownServers();
  qb.setupServers();
  if (leaderSid != 1)   qb.s1.start();
 else   leader=qb.s1;
  if (leaderSid != 2)   qb.s2.start();
 else   leader=qb.s2;
  if (leaderSid != 3)   qb.s3.start();
 else   leader=qb.s3;
  if (leaderSid != 4)   qb.s4.start();
 else   leader=qb.s4;
  if (leaderSid != 5)   qb.s5.start();
 else   leader=qb.s5;
  try {
    leader.start();
    Assert.assertTrue(false);
  }
 catch (  RuntimeException re) {
    LOG.info("Got an error: expected",re);
  }
  String[] list=qb.hostPort.split(",");
  for (int i=0; i < 5; i++) {
    if (leaderSid != (i + 1)) {
      String hp=list[i];
      Assert.assertTrue("waiting for server up",ClientBase.waitForServerUp(hp,CONNECTION_TIMEOUT));
      LOG.info("{} is accepting client connections",hp);
    }
 else {
      LOG.info("Skipping the leader");
    }
  }
  zk=qb.createClient();
  SyncRequestProcessor.setSnapCount(100);
  for (int i=2000; i < 4000; i++) {
    zk.create("/0-" + i,new byte[0],ZooDefs.Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT,new NoopStringCallback(),null);
  }
  zk.close();
  if (leaderSid != 1)   QuorumBase.shutdown(qb.s1);
  if (leaderSid != 2)   QuorumBase.shutdown(qb.s2);
  if (leaderSid != 3)   QuorumBase.shutdown(qb.s3);
  if (leaderSid != 4)   QuorumBase.shutdown(qb.s4);
  if (leaderSid != 5)   QuorumBase.shutdown(qb.s5);
}

</code></pre>

<br>
<h4 style="margin:0px">Class: org.apache.zookeeper.test.system.SimpleSysTest </h4><pre class="type-9 type-10 type-3 type-2 type-6 type-4 type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * This test checks the following:
 * 1) All clients connect successfully
 * 2) Half of the servers die (assuming odd number) and a write succeeds
 * 3) All servers are restarted and cluster stays alive
 * 4) Clients see a change by the server
 * 5) Clients' ephemeral nodes are cleaned up
 * @throws Exception
 */
@Test public void testSimpleCase() throws Exception {
  configureServers(serverCount);
  configureClients(clientCount,SimpleClient.class,getHostPort());
  Stat stat=new Stat();
  startServers();
  LOG.debug("Connecting to " + getHostPort());
  ZooKeeper zk=new ZooKeeper(getHostPort(),15000,this);
  waitForConnect(zk,10000);
  zk.create("/simpleCase","orig".getBytes(),Ids.OPEN_ACL_UNSAFE,CreateMode.PERSISTENT);
  startClients();
  for (int i=0; i < getClientCount(); i++) {
    for (int j=0; j < maxTries; j++) {
      try {
        byte b[]=zk.getData("/simpleCase/" + i,false,stat);
        Assert.assertEquals("orig",new String(b));
      }
 catch (      NoNodeException e) {
        if (j + 1 == maxTries) {
          Assert.fail("Max tries exceeded on client " + i);
        }
        Thread.sleep(1000);
      }
    }
  }
  for (int i=0; i < getServerCount(); i++) {
    stopServer(i);
    if (i + 1 > getServerCount() / 2) {
      startServer(i);
    }
 else     if (i + 1 == getServerCount() / 2) {
      Assert.assertTrue("Connection didn't recover",waitForConnect(zk,10000));
      try {
        zk.setData("/simpleCase","new".getBytes(),-1);
      }
 catch (      ConnectionLossException e) {
        Assert.assertTrue("Connection didn't recover",waitForConnect(zk,10000));
        zk.setData("/simpleCase","new".getBytes(),-1);
      }
      for (int j=0; j < i; j++) {
        LOG.info("Starting server " + j);
        startServer(i);
      }
    }
  }
  Thread.sleep(100);
  Assert.assertTrue("Servers didn't bounce",waitForConnect(zk,15000));
  try {
    zk.getData("/simpleCase",false,stat);
  }
 catch (  ConnectionLossException e) {
    Assert.assertTrue("Servers didn't bounce",waitForConnect(zk,15000));
  }
  for (int i=0; i < getClientCount(); i++) {
    for (int j=0; j < maxTries; j++) {
      byte data[]=zk.getData("/simpleCase/" + i,false,stat);
      if (new String(data).equals("new")) {
        break;
      }
      if (j + 1 == maxTries) {
        Assert.fail("max tries exceeded for " + i);
      }
      Thread.sleep(1000);
    }
  }
  zk.setData("/simpleCase","die".getBytes(),-1);
  for (int i=0; i < getClientCount(); i++) {
    try {
      for (int j=0; j < maxTries; j++) {
        zk.getData("/simpleCase/" + i,false,stat);
        if (j + 1 == maxTries) {
          Assert.fail("max tries exceeded waiting for child " + i + " to die");
        }
        Thread.sleep(200);
      }
    }
 catch (    NoNodeException e) {
    }
  }
  stopClients();
  stopServers();
}

</code></pre>

<br>
<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
