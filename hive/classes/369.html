<h3 style="margin:0px">Class: org.apache.hive.hcatalog.streaming.TestStreaming (24 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(15)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(15)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(8)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="19"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('19')" data-toggle="tooltip" title="Invokes logging operations"><kbd id="tag-19"class="label-info"style="display: inline-block;font-size:7pt" >Logger&nbsp;(1)</kbd></button>&nbsp;<button id="16"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('16')" data-toggle="tooltip" title="Verifies values related to public fields."><kbd id="tag-16"class="label-info"style="display: inline-block;font-size:7pt" >PublicFieldVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="12"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('12')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-12"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(1)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransactionBatchAbortAndCommit() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("1,Hello streaming".getBytes());
  txnBatch.write("2,Welcome to streaming".getBytes());
  txnBatch.abort();
  checkNothingWritten(partLoc);
  Assert.assertEquals(TransactionBatch.TxnState.ABORTED,txnBatch.getCurrentTransactionState());
  txnBatch.beginNextTransaction();
  txnBatch.write("1,Hello streaming".getBytes());
  txnBatch.write("2,Welcome to streaming".getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}","{2, Welcome to streaming}");
  txnBatch.close();
  connection.close();
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testInterleavedTransactionBatchCommits() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch1=connection.fetchTransactionBatch(10,writer);
  txnBatch1.beginNextTransaction();
  DelimitedInputWriter writer2=new DelimitedInputWriter(fieldNames,",",endPt);
  TransactionBatch txnBatch2=connection.fetchTransactionBatch(10,writer2);
  txnBatch2.beginNextTransaction();
  txnBatch1.write("1,Hello streaming".getBytes());
  txnBatch2.write("3,Hello streaming - once again".getBytes());
  checkNothingWritten(partLoc);
  txnBatch2.commit();
  checkDataWritten(partLoc,11,20,1,1,"{3, Hello streaming - once again}");
  txnBatch1.commit();
  checkDataWritten(partLoc,1,20,1,2,"{1, Hello streaming}","{3, Hello streaming - once again}");
  txnBatch1.beginNextTransaction();
  txnBatch1.write("2,Welcome to streaming".getBytes());
  txnBatch2.beginNextTransaction();
  txnBatch2.write("4,Welcome to streaming - once again".getBytes());
  checkDataWritten(partLoc,1,20,1,2,"{1, Hello streaming}","{3, Hello streaming - once again}");
  txnBatch1.commit();
  checkDataWritten(partLoc,1,20,1,2,"{1, Hello streaming}","{2, Welcome to streaming}","{3, Hello streaming - once again}");
  txnBatch2.commit();
  checkDataWritten(partLoc,1,20,1,2,"{1, Hello streaming}","{2, Welcome to streaming}","{3, Hello streaming - once again}","{4, Welcome to streaming - once again}");
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch1.getCurrentTransactionState());
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch2.getCurrentTransactionState());
  txnBatch1.close();
  txnBatch2.close();
  connection.close();
}

</code></pre>

<pre class="type-4 type-5 type-8 type-16 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testAddPartition() throws Exception {
  List<String> newPartVals=new ArrayList<String>(2);
  newPartVals.add(PART1_CONTINENT);
  newPartVals.add("Nepal");
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,newPartVals);
  try {
    msClient.getPartition(endPt.database,endPt.table,endPt.partitionVals);
    Assert.assertTrue("Partition already exists",false);
  }
 catch (  NoSuchObjectException e) {
  }
  Assert.assertNotNull(endPt.newConnection(true,null));
  Partition p=msClient.getPartition(endPt.database,endPt.table,endPt.partitionVals);
  Assert.assertNotNull("Did not find added partition",p);
}

</code></pre>

<pre class="type-11 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testFileDumpCorruptSideFiles() throws Exception {
  dropDB(msClient,dbName3);
  String dbLocation=dbFolder.newFolder(dbName3).getCanonicalPath() + ".db";
  dbLocation=dbLocation.replaceAll("\\\\","/");
  String[] colNames="key1,key2,data".split(",");
  String[] colTypes="string,int,string".split(",");
  String[] bucketNames="key1,key2".split(",");
  int bucketCount=4;
  createDbAndTable(driver,dbName3,tblName3,null,colNames,colTypes,bucketNames,null,dbLocation,bucketCount);
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName3,tblName3,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(colNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("name0,1,Hello streaming".getBytes());
  txnBatch.write("name2,2,Welcome to streaming".getBytes());
  txnBatch.write("name4,2,more Streaming unlimited".getBytes());
  txnBatch.write("name5,2,even more Streaming unlimited".getBytes());
  txnBatch.write("name6,3,aHello streaming".getBytes());
  txnBatch.commit();
  Map<String,List<Long>> offsetMap=new HashMap<String,List<Long>>();
  recordOffsets(conf,dbLocation,offsetMap);
  txnBatch.beginNextTransaction();
  txnBatch.write("name01,11,-Hello streaming".getBytes());
  txnBatch.write("name21,21,-Welcome to streaming".getBytes());
  txnBatch.write("name41,21,-more Streaming unlimited".getBytes());
  txnBatch.write("name51,21,-even more Streaming unlimited".getBytes());
  txnBatch.write("name02,12,--Hello streaming".getBytes());
  txnBatch.write("name22,22,--Welcome to streaming".getBytes());
  txnBatch.write("name42,22,--more Streaming unlimited".getBytes());
  txnBatch.write("name52,22,--even more Streaming unlimited".getBytes());
  txnBatch.write("name7,4,aWelcome to streaming".getBytes());
  txnBatch.write("name8,5,amore Streaming unlimited".getBytes());
  txnBatch.write("name9,6,aeven more Streaming unlimited".getBytes());
  txnBatch.write("name10,7,bHello streaming".getBytes());
  txnBatch.write("name11,8,bWelcome to streaming".getBytes());
  txnBatch.write("name12,9,bmore Streaming unlimited".getBytes());
  txnBatch.write("name13,10,beven more Streaming unlimited".getBytes());
  txnBatch.commit();
  recordOffsets(conf,dbLocation,offsetMap);
  Path path=new Path(dbLocation);
  Collection<String> files=FileDump.getAllFilesInPath(path,conf);
  for (  String file : files) {
    if (file.contains("bucket_00000")) {
      corruptSideFile(file,conf,offsetMap,"bucket_00000",-1);
    }
 else     if (file.contains("bucket_00001")) {
      corruptSideFile(file,conf,offsetMap,"bucket_00001",0);
    }
 else     if (file.contains("bucket_00002")) {
      corruptSideFile(file,conf,offsetMap,"bucket_00002",3);
    }
 else     if (file.contains("bucket_00003")) {
      corruptSideFile(file,conf,offsetMap,"bucket_00003",10);
    }
  }
  PrintStream origErr=System.err;
  ByteArrayOutputStream myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation});
  System.err.flush();
  System.setErr(origErr);
  String errDump=new String(myErr.toByteArray());
  Assert.assertEquals(true,errDump.contains("bucket_00000_flush_length [length: 11"));
  Assert.assertEquals(true,errDump.contains("bucket_00001_flush_length [length: 0"));
  Assert.assertEquals(true,errDump.contains("bucket_00002_flush_length [length: 24"));
  Assert.assertEquals(true,errDump.contains("bucket_00003_flush_length [length: 80"));
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(true,errDump.contains("4 file(s) are corrupted"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  origErr=System.err;
  myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation,"--recover","--skip-dump"});
  System.err.flush();
  System.setErr(origErr);
  errDump=new String(myErr.toByteArray());
  Assert.assertEquals(true,errDump.contains("bucket_00000 recovered successfully!"));
  Assert.assertEquals(true,errDump.contains("bucket_00001 recovered successfully!"));
  Assert.assertEquals(true,errDump.contains("bucket_00002 recovered successfully!"));
  Assert.assertEquals(true,errDump.contains("bucket_00003 recovered successfully!"));
  List<Long> offsets=offsetMap.get("bucket_00000");
  Assert.assertEquals(true,errDump.contains("Readable footerOffsets: " + offsets.toString()));
  offsets=offsetMap.get("bucket_00001");
  Assert.assertEquals(true,errDump.contains("Readable footerOffsets: " + offsets.toString()));
  offsets=offsetMap.get("bucket_00002");
  Assert.assertEquals(true,errDump.contains("Readable footerOffsets: " + offsets.toString()));
  offsets=offsetMap.get("bucket_00003");
  Assert.assertEquals(true,errDump.contains("Readable footerOffsets: " + offsets.toString()));
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  origErr=System.err;
  myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation});
  System.err.flush();
  System.setErr(origErr);
  errDump=new String(myErr.toByteArray());
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(false,errDump.contains("file(s) are corrupted"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  files=FileDump.getAllFilesInPath(path,conf);
  for (  String file : files) {
    Assert.assertEquals(false,file.contains("_flush_length"));
  }
  txnBatch.close();
}

</code></pre>

<pre class="type-11 type-4 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testStreamBucketingMatchesRegularBucketing() throws Exception {
  int bucketCount=100;
  String dbUri="raw://" + new Path(dbFolder.newFolder().toString()).toUri().toString();
  String tableLoc="'" + dbUri + Path.SEPARATOR+ "streamedtable"+ "'";
  String tableLoc2="'" + dbUri + Path.SEPARATOR+ "finaltable"+ "'";
  String tableLoc3="'" + dbUri + Path.SEPARATOR+ "nobucket"+ "'";
  runDDL(driver,"create database testBucketing3");
  runDDL(driver,"use testBucketing3");
  runDDL(driver,"create table streamedtable ( key1 string,key2 int,data string ) clustered by ( key1,key2 ) into " + bucketCount + " buckets  stored as orc  location "+ tableLoc+ " TBLPROPERTIES ('transactional'='true')");
  runDDL(driver,"create table nobucket ( bucketid int, key1 string,key2 int,data string ) location " + tableLoc3);
  runDDL(driver,"create table finaltable ( bucketid int, key1 string,key2 int,data string ) clustered by ( key1,key2 ) into " + bucketCount + " buckets  stored as orc location "+ tableLoc2+ " TBLPROPERTIES ('transactional'='true')");
  String[] records=new String[]{"PSFAHYLZVC,29,EPNMA","PPPRKWAYAU,96,VUTEE","MIAOFERCHI,3,WBDSI","CEGQAZOWVN,0,WCUZL","XWAKMNSVQF,28,YJVHU","XBWTSAJWME,2,KDQFO","FUVLQTAXAY,5,LDSDG","QTQMDJMGJH,6,QBOMA","EFLOTLWJWN,71,GHWPS","PEQNAOJHCM,82,CAAFI","MOEKQLGZCP,41,RUACR","QZXMCOPTID,37,LFLWE","EYALVWICRD,13,JEZLC","VYWLZAYTXX,16,DMVZX","OSALYSQIXR,47,HNZVE","JGKVHKCEGQ,25,KSCJB","WQFMMYDHET,12,DTRWA","AJOVAYZKZQ,15,YBKFO","YAQONWCUAU,31,QJNHZ","DJBXUEUOEB,35,IYCBL"};
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,"testBucketing3","streamedtable",null);
  String[] colNames1=new String[]{"key1","key2","data"};
  DelimitedInputWriter wr=new DelimitedInputWriter(colNames1,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,wr);
  txnBatch.beginNextTransaction();
  for (  String record : records) {
    txnBatch.write(record.toString().getBytes());
  }
  txnBatch.commit();
  txnBatch.close();
  connection.close();
  ArrayList<String> res1=queryTable(driver,"select row__id.bucketid, * from streamedtable order by key2");
  for (  String re : res1) {
    System.out.println(re);
  }
  driver.run("insert into nobucket select row__id.bucketid,* from streamedtable");
  runDDL(driver," insert into finaltable select * from nobucket");
  ArrayList<String> res2=queryTable(driver,"select row__id.bucketid,* from finaltable where row__id.bucketid<>bucketid");
  for (  String s : res2) {
    LOG.error(s);
  }
  Assert.assertTrue(res2.isEmpty());
}

</code></pre>

<pre class="type-11 type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testBucketing() throws Exception {
  dropDB(msClient,dbName3);
  dropDB(msClient,dbName4);
  String dbLocation=dbFolder.newFolder(dbName3).getCanonicalPath() + ".db";
  dbLocation=dbLocation.replaceAll("\\\\","/");
  String[] colNames="key1,key2,data".split(",");
  String[] colTypes="string,int,string".split(",");
  String[] bucketNames="key1,key2".split(",");
  int bucketCount=4;
  createDbAndTable(driver,dbName3,tblName3,null,colNames,colTypes,bucketNames,null,dbLocation,bucketCount);
  String dbLocation2=dbFolder.newFolder(dbName4).getCanonicalPath() + ".db";
  dbLocation2=dbLocation2.replaceAll("\\\\","/");
  String[] colNames2="key3,key4,data2".split(",");
  String[] colTypes2="string,int,string".split(",");
  String[] bucketNames2="key3,key4".split(",");
  createDbAndTable(driver,dbName4,tblName4,null,colNames2,colTypes2,bucketNames2,null,dbLocation2,bucketCount);
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName3,tblName3,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(colNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("name0,1,Hello streaming".getBytes());
  txnBatch.write("name2,2,Welcome to streaming".getBytes());
  txnBatch.write("name4,2,more Streaming unlimited".getBytes());
  txnBatch.write("name5,2,even more Streaming unlimited".getBytes());
  txnBatch.commit();
  HiveEndPoint endPt2=new HiveEndPoint(metaStoreURI,dbName4,tblName4,null);
  DelimitedInputWriter writer2=new DelimitedInputWriter(colNames2,",",endPt2);
  StreamingConnection connection2=endPt2.newConnection(false);
  TransactionBatch txnBatch2=connection2.fetchTransactionBatch(2,writer2);
  txnBatch2.beginNextTransaction();
  txnBatch2.write("name5,2,fact3".getBytes());
  txnBatch2.write("name8,2,fact3".getBytes());
  txnBatch2.write("name0,1,fact1".getBytes());
  txnBatch2.commit();
  HashMap<Integer,ArrayList<SampleRec>> actual1=dumpAllBuckets(dbLocation,tblName3);
  HashMap<Integer,ArrayList<SampleRec>> actual2=dumpAllBuckets(dbLocation2,tblName4);
  System.err.println("\n  Table 1");
  System.err.println(actual1);
  System.err.println("\n  Table 2");
  System.err.println(actual2);
  Assert.assertEquals("number of buckets does not match expectation",actual1.values().size(),4);
  Assert.assertEquals("records in bucket does not match expectation",actual1.get(0).size(),2);
  Assert.assertEquals("records in bucket does not match expectation",actual1.get(1).size(),1);
  Assert.assertEquals("records in bucket does not match expectation",actual1.get(2).size(),0);
  Assert.assertEquals("records in bucket does not match expectation",actual1.get(3).size(),1);
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testMultipleTransactionBatchCommits() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(true);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("1,Hello streaming".getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}");
  txnBatch.beginNextTransaction();
  txnBatch.write("2,Welcome to streaming".getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}","{2, Welcome to streaming}");
  txnBatch.close();
  txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("3,Hello streaming - once again".getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,20,1,2,"{1, Hello streaming}","{2, Welcome to streaming}","{3, Hello streaming - once again}");
  txnBatch.beginNextTransaction();
  txnBatch.write("4,Welcome to streaming - once again".getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,20,1,2,"{1, Hello streaming}","{2, Welcome to streaming}","{3, Hello streaming - once again}","{4, Welcome to streaming - once again}");
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  connection.close();
}

</code></pre>

<pre class="type-6 type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testRemainingTransactions() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(true);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  int batch=0;
  int initialCount=txnBatch.remainingTransactions();
  while (txnBatch.remainingTransactions() > 0) {
    txnBatch.beginNextTransaction();
    Assert.assertEquals(--initialCount,txnBatch.remainingTransactions());
    for (int rec=0; rec < 2; ++rec) {
      Assert.assertEquals(TransactionBatch.TxnState.OPEN,txnBatch.getCurrentTransactionState());
      txnBatch.write((batch * rec + ",Hello streaming").getBytes());
    }
    txnBatch.commit();
    Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
    ++batch;
  }
  Assert.assertEquals(0,txnBatch.remainingTransactions());
  txnBatch.close();
  Assert.assertEquals(TransactionBatch.TxnState.INACTIVE,txnBatch.getCurrentTransactionState());
  txnBatch=connection.fetchTransactionBatch(10,writer);
  batch=0;
  initialCount=txnBatch.remainingTransactions();
  while (txnBatch.remainingTransactions() > 0) {
    txnBatch.beginNextTransaction();
    Assert.assertEquals(--initialCount,txnBatch.remainingTransactions());
    for (int rec=0; rec < 2; ++rec) {
      Assert.assertEquals(TransactionBatch.TxnState.OPEN,txnBatch.getCurrentTransactionState());
      txnBatch.write((batch * rec + ",Hello streaming").getBytes());
    }
    txnBatch.abort();
    Assert.assertEquals(TransactionBatch.TxnState.ABORTED,txnBatch.getCurrentTransactionState());
    ++batch;
  }
  Assert.assertEquals(0,txnBatch.remainingTransactions());
  txnBatch.close();
  Assert.assertEquals(TransactionBatch.TxnState.INACTIVE,txnBatch.getCurrentTransactionState());
  connection.close();
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
"></span><br>
/** 
 * check that transactions that have not heartbeated and timedout get properly aborted
 * @throws Exception
 */
@Test public void testTimeOutReaper() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames2,",",endPt);
  StreamingConnection connection=endPt.newConnection(false,null);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(5,writer);
  txnBatch.beginNextTransaction();
  conf.setTimeVar(HiveConf.ConfVars.HIVE_TIMEDOUT_TXN_REAPER_START,0,TimeUnit.SECONDS);
  conf.setTimeVar(HiveConf.ConfVars.HIVE_TXN_TIMEOUT,1,TimeUnit.MILLISECONDS);
  AcidHouseKeeperService houseKeeperService=new AcidHouseKeeperService();
  houseKeeperService.start(conf);
  while (houseKeeperService.getIsAliveCounter() <= Integer.MIN_VALUE) {
    Thread.sleep(100);
  }
  houseKeeperService.stop();
  try {
    txnBatch.commit();
  }
 catch (  TransactionError e) {
    Assert.assertTrue("Expected aborted transaction",e.getCause() instanceof TxnAbortedException);
  }
  txnBatch.close();
  txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.commit();
  txnBatch.beginNextTransaction();
  int lastCount=houseKeeperService.getIsAliveCounter();
  houseKeeperService.start(conf);
  while (houseKeeperService.getIsAliveCounter() <= lastCount) {
    Thread.sleep(100);
  }
  houseKeeperService.stop();
  try {
    txnBatch.commit();
  }
 catch (  TransactionError e) {
    Assert.assertTrue("Expected aborted transaction",e.getCause() instanceof TxnAbortedException);
  }
  txnBatch.close();
  connection.close();
}

</code></pre>

<pre class="type-4 type-5 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testHeartbeat() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames2,",",endPt);
  StreamingConnection connection=endPt.newConnection(false,null);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(5,writer);
  txnBatch.beginNextTransaction();
  ShowLocksResponse response=msClient.showLocks();
  Assert.assertEquals("Wrong nubmer of locks: " + response,1,response.getLocks().size());
  ShowLocksResponseElement lock=response.getLocks().get(0);
  long acquiredAt=lock.getAcquiredat();
  long heartbeatAt=lock.getLastheartbeat();
  txnBatch.heartbeat();
  response=msClient.showLocks();
  Assert.assertEquals("Wrong number of locks2: " + response,1,response.getLocks().size());
  lock=response.getLocks().get(0);
  Assert.assertEquals("Acquired timestamp didn't match",acquiredAt,lock.getAcquiredat());
  Assert.assertTrue("Expected new heartbeat (" + lock.getLastheartbeat() + ") == old heartbeat("+ heartbeatAt+ ")",lock.getLastheartbeat() == heartbeatAt);
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransactionBatchEmptyAbort() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(true);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.abort();
  Assert.assertEquals(TransactionBatch.TxnState.ABORTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  connection.close();
  endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,null);
  writer=new DelimitedInputWriter(fieldNames,",",endPt);
  connection=endPt.newConnection(true);
  txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.abort();
  Assert.assertEquals(TransactionBatch.TxnState.ABORTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  connection.close();
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransactionBatchCommit_Json() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  StrictJsonWriter writer=new StrictJsonWriter(endPt);
  StreamingConnection connection=endPt.newConnection(true);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  Assert.assertEquals(TransactionBatch.TxnState.OPEN,txnBatch.getCurrentTransactionState());
  String rec1="{\"id\" : 1, \"msg\": \"Hello streaming\"}";
  txnBatch.write(rec1.getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}");
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  Assert.assertEquals(TransactionBatch.TxnState.INACTIVE,txnBatch.getCurrentTransactionState());
  connection.close();
}

</code></pre>

<pre class="type-11 type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testFileDumpCorruptDataFiles() throws Exception {
  dropDB(msClient,dbName3);
  String dbLocation=dbFolder.newFolder(dbName3).getCanonicalPath() + ".db";
  dbLocation=dbLocation.replaceAll("\\\\","/");
  String[] colNames="key1,key2,data".split(",");
  String[] colTypes="string,int,string".split(",");
  String[] bucketNames="key1,key2".split(",");
  int bucketCount=4;
  createDbAndTable(driver,dbName3,tblName3,null,colNames,colTypes,bucketNames,null,dbLocation,bucketCount);
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName3,tblName3,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(colNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("name0,1,Hello streaming".getBytes());
  txnBatch.write("name2,2,Welcome to streaming".getBytes());
  txnBatch.write("name4,2,more Streaming unlimited".getBytes());
  txnBatch.write("name5,2,even more Streaming unlimited".getBytes());
  txnBatch.commit();
  Path path=new Path(dbLocation);
  Collection<String> files=FileDump.getAllFilesInPath(path,conf);
  int readableFooter=-1;
  for (  String file : files) {
    if (file.contains("bucket_00000")) {
      corruptDataFile(file,conf,Integer.MIN_VALUE);
    }
 else     if (file.contains("bucket_00001")) {
      corruptDataFile(file,conf,-1);
    }
 else     if (file.contains("bucket_00002")) {
      Path bPath=new Path(file);
      FileSystem fs=bPath.getFileSystem(conf);
      FileStatus fileStatus=fs.getFileStatus(bPath);
      readableFooter=(int)fileStatus.getLen();
      corruptDataFile(file,conf,2);
    }
 else     if (file.contains("bucket_00003")) {
      corruptDataFile(file,conf,100);
    }
  }
  PrintStream origErr=System.err;
  ByteArrayOutputStream myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation});
  System.err.flush();
  System.setErr(origErr);
  String errDump=new String(myErr.toByteArray());
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(true,errDump.contains("4 file(s) are corrupted"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  origErr=System.err;
  myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation,"--recover","--skip-dump"});
  System.err.flush();
  System.setErr(origErr);
  errDump=new String(myErr.toByteArray());
  Assert.assertEquals(true,errDump.contains("bucket_00000 recovered successfully!"));
  Assert.assertEquals(true,errDump.contains("No readable footers found. Creating empty orc file."));
  Assert.assertEquals(true,errDump.contains("bucket_00001 recovered successfully!"));
  Assert.assertEquals(true,errDump.contains("bucket_00002 recovered successfully!"));
  Assert.assertEquals(true,errDump.contains("Readable footerOffsets: [" + readableFooter + "]"));
  Assert.assertEquals(true,errDump.contains("bucket_00003 recovered successfully!"));
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  origErr=System.err;
  myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation});
  System.err.flush();
  System.setErr(origErr);
  errDump=new String(myErr.toByteArray());
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(false,errDump.contains("file(s) are corrupted"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  files=FileDump.getAllFilesInPath(path,conf);
  for (  String file : files) {
    Assert.assertEquals(false,file.contains("_flush_length"));
  }
  txnBatch.close();
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
"></span><br>
@Test public void testTableValidation() throws Exception {
  int bucketCount=100;
  String dbUri="raw://" + new Path(dbFolder.newFolder().toString()).toUri().toString();
  String tbl1="validation1";
  String tbl2="validation2";
  String tableLoc="'" + dbUri + Path.SEPARATOR+ tbl1+ "'";
  String tableLoc2="'" + dbUri + Path.SEPARATOR+ tbl2+ "'";
  runDDL(driver,"create database testBucketing3");
  runDDL(driver,"use testBucketing3");
  runDDL(driver,"create table " + tbl1 + " ( key1 string, data string ) clustered by ( key1 ) into "+ bucketCount+ " buckets  stored as orc  location "+ tableLoc);
  runDDL(driver,"create table " + tbl2 + " ( key1 string, data string ) clustered by ( key1 ) into "+ bucketCount+ " buckets  stored as orc  location "+ tableLoc2+ " TBLPROPERTIES ('transactional'='false')");
  try {
    HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,"testBucketing3","validation1",null);
    endPt.newConnection(false);
    Assert.assertTrue("InvalidTable exception was not thrown",false);
  }
 catch (  InvalidTable e) {
  }
  try {
    HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,"testBucketing3","validation2",null);
    endPt.newConnection(false);
    Assert.assertTrue("InvalidTable exception was not thrown",false);
  }
 catch (  InvalidTable e) {
  }
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransactionBatchCommit_Delimited() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(true);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  Assert.assertEquals(TransactionBatch.TxnState.OPEN,txnBatch.getCurrentTransactionState());
  txnBatch.write("1,Hello streaming".getBytes());
  txnBatch.commit();
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}");
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
  txnBatch.beginNextTransaction();
  Assert.assertEquals(TransactionBatch.TxnState.OPEN,txnBatch.getCurrentTransactionState());
  txnBatch.write("2,Welcome to streaming".getBytes());
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}");
  txnBatch.commit();
  checkDataWritten(partLoc,1,10,1,1,"{1, Hello streaming}","{2, Welcome to streaming}");
  txnBatch.close();
  Assert.assertEquals(TransactionBatch.TxnState.INACTIVE,txnBatch.getCurrentTransactionState());
  connection.close();
  endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,null);
  writer=new DelimitedInputWriter(fieldNames,",",endPt);
  connection=endPt.newConnection(true);
  txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  Assert.assertEquals(TransactionBatch.TxnState.OPEN,txnBatch.getCurrentTransactionState());
  txnBatch.write("1,Hello streaming".getBytes());
  txnBatch.commit();
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
  connection.close();
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setup() throws Exception {
  SessionState.start(new CliSessionState(conf));
  driver=new Driver(conf);
  driver.setMaxRows(200002);
  dropDB(msClient,dbName);
  String[] colNames=new String[]{COL1,COL2};
  String[] colTypes=new String[]{serdeConstants.INT_TYPE_NAME,serdeConstants.STRING_TYPE_NAME};
  String[] bucketCols=new String[]{COL1};
  String loc1=dbFolder.newFolder(dbName + ".db").toString();
  String[] partNames=new String[]{"Continent","Country"};
  partLoc=createDbAndTable(driver,dbName,tblName,partitionVals,colNames,colTypes,bucketCols,partNames,loc1,1);
  dropDB(msClient,dbName2);
  String loc2=dbFolder.newFolder(dbName2 + ".db").toString();
  partLoc2=createDbAndTable(driver,dbName2,tblName2,null,colNames,colTypes,bucketCols,null,loc2,2);
  String loc3=dbFolder.newFolder("testing5.db").toString();
  createStoreSales("testing5",loc3);
  runDDL(driver,"drop table testBucketing3.streamedtable");
  runDDL(driver,"drop table testBucketing3.finaltable");
  runDDL(driver,"drop table testBucketing3.nobucket");
}

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
"></span><br>
@Test public void testEndpointConnection() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  StreamingConnection connection=endPt.newConnection(false,null);
  connection.close();
  endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,null);
  endPt.newConnection(false,null).close();
  try {
    endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,null);
    connection=endPt.newConnection(true);
    Assert.assertTrue("ConnectionError was not thrown",false);
    connection.close();
  }
 catch (  ConnectionError e) {
    String errMsg="doesn't specify any partitions for partitioned table";
    Assert.assertTrue(e.toString().endsWith(errMsg));
  }
  try {
    endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,partitionVals);
    connection=endPt.newConnection(false);
    Assert.assertTrue("ConnectionError was not thrown",false);
    connection.close();
  }
 catch (  ConnectionError e) {
    String errMsg="specifies partitions for unpartitioned table";
    Assert.assertTrue(e.toString().endsWith(errMsg));
  }
}

</code></pre>

<pre class="type-13 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void cleanup() throws Exception {
  msClient.close();
  driver.close();
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransactionBatchAbort() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("1,Hello streaming".getBytes());
  txnBatch.write("2,Welcome to streaming".getBytes());
  txnBatch.abort();
  checkNothingWritten(partLoc);
  Assert.assertEquals(TransactionBatch.TxnState.ABORTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  connection.close();
  checkNothingWritten(partLoc);
}

</code></pre>

<pre class="type-19 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Invokes logging operations">Logger</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Invokes logging operations
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * make sure it works with table where bucket col is not 1st col
 * @throws Exception
 */
@Test public void testBucketingWhereBucketColIsNotFirstCol() throws Exception {
  List<String> partitionVals=new ArrayList<String>();
  partitionVals.add("2015");
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,"testing5","store_sales",partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(new String[]{"ss_sold_date_sk","ss_sold_time_sk","ss_item_sk","ss_customer_sk","ss_cdemo_sk","ss_hdemo_sk","ss_addr_sk","ss_store_sk","ss_promo_sk","ss_ticket_number","ss_quantity","ss_wholesale_cost","ss_list_price","ss_sales_price","ss_ext_discount_amt","ss_ext_sales_price","ss_ext_wholesale_cost","ss_ext_list_price","ss_ext_tax","ss_coupon_amt","ss_net_paid","ss_net_paid_inc_tax","ss_net_profit"},",",endPt);
  StreamingConnection connection=endPt.newConnection(false,null);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  StringBuilder row=new StringBuilder();
  for (int i=0; i < 10; i++) {
    for (int ints=0; ints < 11; ints++) {
      row.append(ints).append(',');
    }
    for (int decs=0; decs < 12; decs++) {
      row.append(i + 0.1).append(',');
    }
    row.setLength(row.length() - 1);
    txnBatch.write(row.toString().getBytes());
  }
  txnBatch.commit();
  txnBatch.close();
  connection.close();
  ArrayList<String> res=queryTable(driver,"select row__id.bucketid, * from testing5.store_sales");
  for (  String re : res) {
    System.out.println(re);
  }
}

</code></pre>

<pre class="type-12 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies boolean conditions
"></span><br>
@Test public void testConcurrentTransactionBatchCommits() throws Exception {
  final HiveEndPoint ep=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  List<WriterThd> writers=new ArrayList<WriterThd>(3);
  writers.add(new WriterThd(ep,"1,Matrix"));
  writers.add(new WriterThd(ep,"2,Gandhi"));
  writers.add(new WriterThd(ep,"3,Silence"));
  for (  WriterThd w : writers) {
    w.start();
  }
  for (  WriterThd w : writers) {
    w.join();
  }
  for (  WriterThd w : writers) {
    if (w.error != null) {
      Assert.assertFalse("Writer thread" + w.getName() + " died: "+ w.error.getMessage()+ " See log file for stack trace",true);
    }
  }
}

</code></pre>

<pre class="type-4 type-5 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testErrorHandling() throws Exception {
  runCmdOnDriver("create database testErrors");
  runCmdOnDriver("use testErrors");
  runCmdOnDriver("create table T(a int, b int) clustered by (b) into 2 buckets stored as orc TBLPROPERTIES ('transactional'='true')");
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,"testErrors","T",null);
  DelimitedInputWriter innerWriter=new DelimitedInputWriter("a,b".split(","),",",endPt);
  FaultyWriter writer=new FaultyWriter(innerWriter);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.close();
  txnBatch.heartbeat();
  txnBatch.abort();
  GetOpenTxnsInfoResponse r=msClient.showTxns();
  Assert.assertEquals("HWM didn't match",2,r.getTxn_high_water_mark());
  List<TxnInfo> ti=r.getOpen_txns();
  Assert.assertEquals("wrong status ti(0)",TxnState.ABORTED,ti.get(0).getState());
  Assert.assertEquals("wrong status ti(1)",TxnState.ABORTED,ti.get(1).getState());
  Exception expectedEx=null;
  try {
    txnBatch.beginNextTransaction();
  }
 catch (  IllegalStateException ex) {
    expectedEx=ex;
  }
  Assert.assertTrue("beginNextTransaction() should have failed",expectedEx != null && expectedEx.getMessage().contains("has been closed()"));
  expectedEx=null;
  try {
    txnBatch.write("name0,1,Hello streaming".getBytes());
  }
 catch (  IllegalStateException ex) {
    expectedEx=ex;
  }
  Assert.assertTrue("write()  should have failed",expectedEx != null && expectedEx.getMessage().contains("has been closed()"));
  expectedEx=null;
  try {
    txnBatch.commit();
  }
 catch (  IllegalStateException ex) {
    expectedEx=ex;
  }
  Assert.assertTrue("commit() should have failed",expectedEx != null && expectedEx.getMessage().contains("has been closed()"));
  txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("name2,2,Welcome to streaming".getBytes());
  txnBatch.write("name4,2,more Streaming unlimited".getBytes());
  txnBatch.write("name5,2,even more Streaming unlimited".getBytes());
  txnBatch.commit();
  expectedEx=null;
  txnBatch.beginNextTransaction();
  writer.enableErrors();
  try {
    txnBatch.write("name6,2,Doh!".getBytes());
  }
 catch (  StreamingIOFailure ex) {
    expectedEx=ex;
  }
  Assert.assertTrue("Wrong exception: " + (expectedEx != null ? expectedEx.getMessage() : "?"),expectedEx != null && expectedEx.getMessage().contains("Simulated fault occurred"));
  expectedEx=null;
  try {
    txnBatch.commit();
  }
 catch (  IllegalStateException ex) {
    expectedEx=ex;
  }
  Assert.assertTrue("commit() should have failed",expectedEx != null && expectedEx.getMessage().contains("has been closed()"));
  r=msClient.showTxns();
  Assert.assertEquals("HWM didn't match",4,r.getTxn_high_water_mark());
  ti=r.getOpen_txns();
  Assert.assertEquals("wrong status ti(0)",TxnState.ABORTED,ti.get(0).getState());
  Assert.assertEquals("wrong status ti(1)",TxnState.ABORTED,ti.get(1).getState());
  Assert.assertEquals("wrong status ti(2)",TxnState.ABORTED,ti.get(2).getState());
  writer.disableErrors();
  txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("name2,2,Welcome to streaming".getBytes());
  writer.enableErrors();
  expectedEx=null;
  try {
    txnBatch.commit();
  }
 catch (  StreamingIOFailure ex) {
    expectedEx=ex;
  }
  Assert.assertTrue("Wrong exception: " + (expectedEx != null ? expectedEx.getMessage() : "?"),expectedEx != null && expectedEx.getMessage().contains("Simulated fault occurred"));
  r=msClient.showTxns();
  Assert.assertEquals("HWM didn't match",6,r.getTxn_high_water_mark());
  ti=r.getOpen_txns();
  Assert.assertEquals("wrong status ti(3)",TxnState.ABORTED,ti.get(3).getState());
  Assert.assertEquals("wrong status ti(4)",TxnState.ABORTED,ti.get(4).getState());
  txnBatch.abort();
}

</code></pre>

<pre class="type-11 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testFileDump() throws Exception {
  dropDB(msClient,dbName3);
  dropDB(msClient,dbName4);
  String dbLocation=dbFolder.newFolder(dbName3).getCanonicalPath() + ".db";
  dbLocation=dbLocation.replaceAll("\\\\","/");
  String[] colNames="key1,key2,data".split(",");
  String[] colTypes="string,int,string".split(",");
  String[] bucketNames="key1,key2".split(",");
  int bucketCount=4;
  createDbAndTable(driver,dbName3,tblName3,null,colNames,colTypes,bucketNames,null,dbLocation,bucketCount);
  String dbLocation2=dbFolder.newFolder(dbName4).getCanonicalPath() + ".db";
  dbLocation2=dbLocation2.replaceAll("\\\\","/");
  String[] colNames2="key3,key4,data2".split(",");
  String[] colTypes2="string,int,string".split(",");
  String[] bucketNames2="key3,key4".split(",");
  createDbAndTable(driver,dbName4,tblName4,null,colNames2,colTypes2,bucketNames2,null,dbLocation2,bucketCount);
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName3,tblName3,null);
  DelimitedInputWriter writer=new DelimitedInputWriter(colNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(2,writer);
  txnBatch.beginNextTransaction();
  txnBatch.write("name0,1,Hello streaming".getBytes());
  txnBatch.write("name2,2,Welcome to streaming".getBytes());
  txnBatch.write("name4,2,more Streaming unlimited".getBytes());
  txnBatch.write("name5,2,even more Streaming unlimited".getBytes());
  txnBatch.commit();
  PrintStream origErr=System.err;
  ByteArrayOutputStream myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation});
  System.err.flush();
  System.setErr(origErr);
  String errDump=new String(myErr.toByteArray());
  Assert.assertEquals(false,errDump.contains("file(s) are corrupted"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
  HiveEndPoint endPt2=new HiveEndPoint(metaStoreURI,dbName4,tblName4,null);
  DelimitedInputWriter writer2=new DelimitedInputWriter(colNames2,",",endPt2);
  StreamingConnection connection2=endPt2.newConnection(false);
  TransactionBatch txnBatch2=connection2.fetchTransactionBatch(2,writer2);
  txnBatch2.beginNextTransaction();
  txnBatch2.write("name5,2,fact3".getBytes());
  txnBatch2.write("name8,2,fact3".getBytes());
  txnBatch2.write("name0,1,fact1".getBytes());
  txnBatch2.commit();
  origErr=System.err;
  myErr=new ByteArrayOutputStream();
  System.setErr(new PrintStream(myErr));
  FileDump.main(new String[]{dbLocation});
  System.out.flush();
  System.err.flush();
  System.setErr(origErr);
  errDump=new String(myErr.toByteArray());
  Assert.assertEquals(false,errDump.contains("Exception"));
  Assert.assertEquals(false,errDump.contains("file(s) are corrupted"));
  Assert.assertEquals(false,errDump.contains("is still open for writes."));
}

</code></pre>

<pre class="type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testTransactionBatchEmptyCommit() throws Exception {
  HiveEndPoint endPt=new HiveEndPoint(metaStoreURI,dbName,tblName,partitionVals);
  DelimitedInputWriter writer=new DelimitedInputWriter(fieldNames,",",endPt);
  StreamingConnection connection=endPt.newConnection(false,null);
  TransactionBatch txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.commit();
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  connection.close();
  endPt=new HiveEndPoint(metaStoreURI,dbName2,tblName2,null);
  writer=new DelimitedInputWriter(fieldNames2,",",endPt);
  connection=endPt.newConnection(false,null);
  txnBatch=connection.fetchTransactionBatch(10,writer);
  txnBatch.beginNextTransaction();
  txnBatch.commit();
  Assert.assertEquals(TransactionBatch.TxnState.COMMITTED,txnBatch.getCurrentTransactionState());
  txnBatch.close();
  connection.close();
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
