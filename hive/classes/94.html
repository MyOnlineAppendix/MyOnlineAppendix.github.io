<h3 style="margin:0px">Class: org.apache.hadoop.hive.ql.TestTxnCommands2 (13 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(4)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="17"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('17')" data-toggle="tooltip" title="Is not executed with the test suite"><kbd id="tag-17"class="label-info"style="display: inline-block;font-size:7pt" >IgnoredMethod&nbsp;(2)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="12"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('12')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-12"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testOrcNoPPD() throws Exception {
  testOrcPPD(false);
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testUpdateMixedCase() throws Exception {
  int[][] tableData={{1,2},{3,3},{5,3}};
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b) "+ makeValuesClause(tableData));
  runStatementOnDriver("update " + Table.ACIDTBL + " set B = 7 where A=1");
  List<String> rs=runStatementOnDriver("select a,b from " + Table.ACIDTBL + " order by a,b");
  int[][] updatedData={{1,7},{3,3},{5,3}};
  Assert.assertEquals("Update failed",stringifyValues(updatedData),rs);
  runStatementOnDriver("update " + Table.ACIDTBL + " set B = B + 1 where A=1");
  List<String> rs2=runStatementOnDriver("select a,b from " + Table.ACIDTBL + " order by a,b");
  int[][] updatedData2={{1,8},{3,3},{5,3}};
  Assert.assertEquals("Update failed",stringifyValues(updatedData2),rs2);
}

</code></pre>

<pre class="type-17 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Is not executed with the test suite">IgnoredMethod</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Is not executed with the test suite
- Executes methods or other tests from the same test unit
"></span><br>
@Ignore("not needed but useful for testing") @Test public void testNonAcidInsert() throws Exception {
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) values(1,2)");
  List<String> rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) values(2,3)");
  List<String> rs1=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
/** 
 * https://issues.apache.org/jira/browse/HIVE-10151
 */
@Test public void testBucketizedInputFormat() throws Exception {
  int[][] tableData={{1,2}};
  runStatementOnDriver("insert into " + Table.ACIDTBLPART + " partition(p=1) (a,b) "+ makeValuesClause(tableData));
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b) select a,b from "+ Table.ACIDTBLPART+ " where p = 1");
  List<String> rs=runStatementOnDriver("select a,b from " + Table.ACIDTBL);
  Assert.assertEquals("Insert into " + Table.ACIDTBL + " didn't match:",stringifyValues(tableData),rs);
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) select a,b from "+ Table.ACIDTBLPART+ " where p = 1");
  List<String> rs2=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  Assert.assertEquals("Insert into " + Table.NONACIDORCTBL + " didn't match:",stringifyValues(tableData),rs2);
}

</code></pre>

<pre class="type-11 type-6 type-12 type-4 type-5 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test the query correctness and directory layout after ACID table conversion and MAJOR compaction
 * @throws Exception
 */
@Test public void testNonAcidToAcidConversionAndMajorCompaction() throws Exception {
  FileSystem fs=FileSystem.get(hiveConf);
  FileStatus[] status;
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) values(1,2)");
  status=fs.listStatus(new Path(TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(BUCKET_COUNT,status.length);
  for (int i=0; i < status.length; i++) {
    Assert.assertTrue(status[i].getPath().getName().matches("00000[01]_0"));
  }
  List<String> rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  int[][] resultData=new int[][]{{1,2}};
  Assert.assertEquals(stringifyValues(resultData),rs);
  rs=runStatementOnDriver("select count(*) from " + Table.NONACIDORCTBL);
  int resultCount=1;
  Assert.assertEquals(resultCount,Integer.parseInt(rs.get(0)));
  runStatementOnDriver("alter table " + Table.NONACIDORCTBL + " SET TBLPROPERTIES ('transactional'='true')");
  status=fs.listStatus(new Path(TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(BUCKET_COUNT,status.length);
  for (int i=0; i < status.length; i++) {
    Assert.assertTrue(status[i].getPath().getName().matches("00000[01]_0"));
  }
  rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  resultData=new int[][]{{1,2}};
  Assert.assertEquals(stringifyValues(resultData),rs);
  rs=runStatementOnDriver("select count(*) from " + Table.NONACIDORCTBL);
  resultCount=1;
  Assert.assertEquals(resultCount,Integer.parseInt(rs.get(0)));
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) values(3,4)");
  status=fs.listStatus(new Path(TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(3,status.length);
  boolean sawNewDelta=false;
  for (int i=0; i < status.length; i++) {
    if (status[i].getPath().getName().matches("delta_.*")) {
      sawNewDelta=true;
      FileStatus[] buckets=fs.listStatus(status[i].getPath(),FileUtils.STAGING_DIR_PATH_FILTER);
      Assert.assertEquals(BUCKET_COUNT,buckets.length);
      Assert.assertTrue(buckets[0].getPath().getName().matches("bucket_0000[01]"));
      Assert.assertTrue(buckets[1].getPath().getName().matches("bucket_0000[01]"));
    }
 else {
      Assert.assertTrue(status[i].getPath().getName().matches("00000[01]_0"));
    }
  }
  Assert.assertTrue(sawNewDelta);
  rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  resultData=new int[][]{{1,2},{3,4}};
  Assert.assertEquals(stringifyValues(resultData),rs);
  rs=runStatementOnDriver("select count(*) from " + Table.NONACIDORCTBL);
  resultCount=2;
  Assert.assertEquals(resultCount,Integer.parseInt(rs.get(0)));
  runStatementOnDriver("alter table " + Table.NONACIDORCTBL + " compact 'MAJOR'");
  Worker w=new Worker();
  w.setThreadId((int)w.getId());
  w.setHiveConf(hiveConf);
  AtomicBoolean stop=new AtomicBoolean();
  AtomicBoolean looped=new AtomicBoolean();
  stop.set(true);
  w.init(stop,looped);
  w.run();
  status=fs.listStatus(new Path(TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(4,status.length);
  boolean sawNewBase=false;
  for (int i=0; i < status.length; i++) {
    if (status[i].getPath().getName().matches("base_.*")) {
      sawNewBase=true;
      FileStatus[] buckets=fs.listStatus(status[i].getPath(),FileUtils.STAGING_DIR_PATH_FILTER);
      Assert.assertEquals(BUCKET_COUNT,buckets.length);
      Assert.assertTrue(buckets[0].getPath().getName().matches("bucket_0000[01]"));
      Assert.assertTrue(buckets[1].getPath().getName().matches("bucket_0000[01]"));
    }
  }
  Assert.assertTrue(sawNewBase);
  rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  resultData=new int[][]{{1,2},{3,4}};
  Assert.assertEquals(stringifyValues(resultData),rs);
  rs=runStatementOnDriver("select count(*) from " + Table.NONACIDORCTBL);
  resultCount=2;
  Assert.assertEquals(resultCount,Integer.parseInt(rs.get(0)));
  String fakeFile0=TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()+ "/subdir/000000_0";
  String fakeFile1=TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()+ "/subdir/000000_1";
  fs.create(new Path(fakeFile0));
  fs.create(new Path(fakeFile1));
  status=fs.listStatus(new Path(TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(5,status.length);
  Cleaner c=new Cleaner();
  c.setThreadId((int)c.getId());
  c.setHiveConf(hiveConf);
  stop=new AtomicBoolean();
  looped=new AtomicBoolean();
  stop.set(true);
  c.init(stop,looped);
  c.run();
  status=fs.listStatus(new Path(TEST_WAREHOUSE_DIR + "/" + (Table.NONACIDORCTBL).toString().toLowerCase()),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(1,status.length);
  Assert.assertTrue(status[0].getPath().getName().matches("base_.*"));
  FileStatus[] buckets=fs.listStatus(status[0].getPath(),FileUtils.STAGING_DIR_PATH_FILTER);
  Assert.assertEquals(BUCKET_COUNT,buckets.length);
  Assert.assertTrue(buckets[0].getPath().getName().matches("bucket_0000[01]"));
  Assert.assertTrue(buckets[1].getPath().getName().matches("bucket_0000[01]"));
  rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL);
  resultData=new int[][]{{1,2},{3,4}};
  Assert.assertEquals(stringifyValues(resultData),rs);
  rs=runStatementOnDriver("select count(*) from " + Table.NONACIDORCTBL);
  resultCount=2;
  Assert.assertEquals(resultCount,Integer.parseInt(rs.get(0)));
}

</code></pre>

<pre class="type-13 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown() throws Exception {
  try {
    if (d != null) {
      dropTables();
      d.destroy();
      d.close();
      d=null;
    }
    TxnDbUtil.cleanDb();
  }
  finally {
    FileUtils.deleteDirectory(new File(TEST_DATA_DIR));
  }
}

</code></pre>

<pre class="type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testOrcPPD() throws Exception {
  testOrcPPD(true);
}

</code></pre>

<pre class="type-17 type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Is not executed with the test suite">IgnoredMethod</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Is not executed with the test suite
- Executes methods or other tests from the same test unit
"></span><br>
@Ignore("alter table") @Test public void testAlterTable() throws Exception {
  int[][] tableData={{1,2}};
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b) "+ makeValuesClause(tableData));
  runStatementOnDriver("alter table " + Table.ACIDTBL + " compact 'MAJOR'");
  Worker t=new Worker();
  t.setThreadId((int)t.getId());
  t.setHiveConf(hiveConf);
  AtomicBoolean stop=new AtomicBoolean();
  AtomicBoolean looped=new AtomicBoolean();
  stop.set(true);
  t.init(stop,looped);
  t.run();
  int[][] tableData2={{5,6}};
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b) "+ makeValuesClause(tableData2));
  List<String> rs1=runStatementOnDriver("select a,b from " + Table.ACIDTBL + " where b > 0 order by a,b");
  runStatementOnDriver("alter table " + Table.ACIDTBL + " add columns(c int)");
  int[][] moreTableData={{7,8,9}};
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b,c) "+ makeValuesClause(moreTableData));
  List<String> rs0=runStatementOnDriver("select a,b,c from " + Table.ACIDTBL + " where a > 0 order by a,b,c");
}

</code></pre>

<pre class="type-11 type-5 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
/** 
 * HIVE-12353
 * @throws Exception
 */
@Test public void testInitiatorWithMultipleFailedCompactions() throws Exception {
  String tblName="hive12353";
  runStatementOnDriver("drop table if exists " + tblName);
  runStatementOnDriver("CREATE TABLE " + tblName + "(a INT, b STRING) "+ " CLUSTERED BY(a) INTO 1 BUCKETS"+ " STORED AS ORC  TBLPROPERTIES ('transactional'='true')");
  hiveConf.setIntVar(HiveConf.ConfVars.HIVE_COMPACTOR_DELTA_NUM_THRESHOLD,4);
  for (int i=0; i < 5; i++) {
    runStatementOnDriver("insert into " + tblName + " values("+ (i + 1)+ ", 'foo'),("+ (i + 2)+ ", 'bar'),("+ (i + 3)+ ", 'baz')");
  }
  hiveConf.setBoolVar(HiveConf.ConfVars.HIVETESTMODEFAILCOMPACTION,true);
  int numFailedCompactions=hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_INITIATOR_FAILED_THRESHOLD);
  TxnStore txnHandler=TxnUtils.getTxnStore(hiveConf);
  AtomicBoolean stop=new AtomicBoolean(true);
  for (int i=0; i < numFailedCompactions; i++) {
    txnHandler.compact(new CompactionRequest("default",tblName,CompactionType.MINOR));
    runWorker(hiveConf);
  }
  Initiator init=new Initiator();
  init.setThreadId((int)init.getId());
  init.setHiveConf(hiveConf);
  init.init(stop,new AtomicBoolean());
  init.run();
  CompactionsByState cbs=countCompacts(txnHandler);
  Assert.assertEquals("Unexpected number of failed compactions",numFailedCompactions,cbs.failed);
  Assert.assertEquals("Unexpected total number of compactions",numFailedCompactions,cbs.total);
  hiveConf.setTimeVar(HiveConf.ConfVars.COMPACTOR_HISTORY_REAPER_INTERVAL,10,TimeUnit.MILLISECONDS);
  AcidCompactionHistoryService compactionHistoryService=new AcidCompactionHistoryService();
  runHouseKeeperService(compactionHistoryService,hiveConf);
  cbs=countCompacts(txnHandler);
  Assert.assertEquals("Number of failed compactions after History clean",numFailedCompactions,cbs.failed);
  Assert.assertEquals("Total number of compactions after History clean",numFailedCompactions,cbs.total);
  txnHandler.compact(new CompactionRequest("default",tblName,CompactionType.MAJOR));
  runWorker(hiveConf);
  txnHandler.compact(new CompactionRequest("default",tblName,CompactionType.MINOR));
  runWorker(hiveConf);
  cbs=countCompacts(txnHandler);
  Assert.assertEquals("Unexpected num failed1",numFailedCompactions + 2,cbs.failed);
  Assert.assertEquals("Unexpected num total1",numFailedCompactions + 2,cbs.total);
  runHouseKeeperService(compactionHistoryService,hiveConf);
  cbs=countCompacts(txnHandler);
  Assert.assertEquals("Unexpected num failed2",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED),cbs.failed);
  Assert.assertEquals("Unexpected num total2",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED),cbs.total);
  hiveConf.setBoolVar(HiveConf.ConfVars.HIVETESTMODEFAILCOMPACTION,false);
  txnHandler.compact(new CompactionRequest("default",tblName,CompactionType.MINOR));
  cbs=countCompacts(txnHandler);
  Assert.assertEquals("Unexpected num failed3",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED),cbs.failed);
  Assert.assertEquals("Unexpected num initiated",1,cbs.initiated);
  Assert.assertEquals("Unexpected num total3",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED) + 1,cbs.total);
  runWorker(hiveConf);
  cbs=countCompacts(txnHandler);
  Assert.assertEquals("Unexpected num failed4",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED),cbs.failed);
  Assert.assertEquals("Unexpected num ready to clean",1,cbs.readyToClean);
  Assert.assertEquals("Unexpected num total4",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED) + 1,cbs.total);
  runCleaner(hiveConf);
  runHouseKeeperService(compactionHistoryService,hiveConf);
  cbs=countCompacts(txnHandler);
  Assert.assertEquals("Unexpected num failed5",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED),cbs.failed);
  Assert.assertEquals("Unexpected num succeeded",1,cbs.succeeded);
  Assert.assertEquals("Unexpected num total5",hiveConf.getIntVar(HiveConf.ConfVars.COMPACTOR_HISTORY_RETENTION_FAILED) + 1,cbs.total);
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
/** 
 * HIVE-12352 has details
 * @throws Exception
 */
@Test public void writeBetweenWorkerAndCleaner() throws Exception {
  String tblName="hive12352";
  runStatementOnDriver("drop table if exists " + tblName);
  runStatementOnDriver("CREATE TABLE " + tblName + "(a INT, b STRING) "+ " CLUSTERED BY(a) INTO 1 BUCKETS"+ " STORED AS ORC  TBLPROPERTIES ('transactional'='true')");
  runStatementOnDriver("insert into " + tblName + " values(1, 'foo'),(2, 'bar'),(3, 'baz')");
  runStatementOnDriver("update " + tblName + " set b = 'blah' where a = 3");
  TxnStore txnHandler=TxnUtils.getTxnStore(hiveConf);
  txnHandler.compact(new CompactionRequest("default",tblName,CompactionType.MINOR));
  Worker t=new Worker();
  t.setThreadId((int)t.getId());
  t.setHiveConf(hiveConf);
  AtomicBoolean stop=new AtomicBoolean(true);
  AtomicBoolean looped=new AtomicBoolean();
  t.init(stop,looped);
  t.run();
  hiveConf.setBoolVar(HiveConf.ConfVars.HIVETESTMODEROLLBACKTXN,true);
  runStatementOnDriver("delete from " + tblName + " where a = 1");
  hiveConf.setBoolVar(HiveConf.ConfVars.HIVETESTMODEROLLBACKTXN,false);
  List<String> expected=new ArrayList<>();
  expected.add("1\tfoo");
  expected.add("2\tbar");
  expected.add("3\tblah");
  Assert.assertEquals("",expected,runStatementOnDriver("select a,b from " + tblName + " order by a"));
  Cleaner c=new Cleaner();
  c.setThreadId((int)c.getId());
  c.setHiveConf(hiveConf);
  c.init(stop,new AtomicBoolean());
  c.run();
  Initiator i=new Initiator();
  i.setThreadId((int)i.getId());
  i.setHiveConf(hiveConf);
  i.init(stop,new AtomicBoolean());
  i.run();
  Assert.assertEquals("",expected,runStatementOnDriver("select a,b from " + tblName + " order by a"));
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testInsertOverwriteWithSelfJoin() throws Exception {
  int[][] part1Data={{1,7}};
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) "+ makeValuesClause(part1Data));
  runStatementOnDriver("insert overwrite table " + Table.NONACIDORCTBL + " select 2, 9 from "+ Table.NONACIDORCTBL+ " T inner join "+ Table.NONACIDORCTBL+ " S on T.a=S.a");
  List<String> rs=runStatementOnDriver("select a,b from " + Table.NONACIDORCTBL + " order by a,b");
  int[][] joinData={{2,9}};
  Assert.assertEquals("Self join non-part insert overwrite failed",stringifyValues(joinData),rs);
  int[][] part2Data={{1,8}};
  runStatementOnDriver("insert into " + Table.NONACIDPART + " partition(p=1) (a,b) "+ makeValuesClause(part1Data));
  runStatementOnDriver("insert into " + Table.NONACIDPART + " partition(p=2) (a,b) "+ makeValuesClause(part2Data));
  runStatementOnDriver("insert overwrite table " + Table.NONACIDPART + " partition(p=1) select a,b from "+ Table.NONACIDPART);
  List<String> rs2=runStatementOnDriver("select a,b from " + Table.NONACIDPART + " order by a,b");
  int[][] updatedData={{1,7},{1,8},{1,8}};
  Assert.assertEquals("Insert overwrite partition failed",stringifyValues(updatedData),rs2);
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setUp() throws Exception {
  tearDown();
  hiveConf=new HiveConf(this.getClass());
  hiveConf.set(HiveConf.ConfVars.PREEXECHOOKS.varname,"");
  hiveConf.set(HiveConf.ConfVars.POSTEXECHOOKS.varname,"");
  hiveConf.set(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY.varname,"false");
  hiveConf.set(HiveConf.ConfVars.METASTOREWAREHOUSE.varname,TEST_WAREHOUSE_DIR);
  hiveConf.setVar(HiveConf.ConfVars.HIVEMAPREDMODE,"nonstrict");
  hiveConf.setVar(HiveConf.ConfVars.HIVEINPUTFORMAT,HiveInputFormat.class.getName());
  TxnDbUtil.setConfValues(hiveConf);
  TxnDbUtil.prepDb();
  File f=new File(TEST_WAREHOUSE_DIR);
  if (f.exists()) {
    FileUtil.fullyDelete(f);
  }
  if (!(new File(TEST_WAREHOUSE_DIR).mkdirs())) {
    throw new RuntimeException("Could not create " + TEST_WAREHOUSE_DIR);
  }
  SessionState.start(new SessionState(hiveConf));
  d=new Driver(hiveConf);
  dropTables();
  runStatementOnDriver("create table " + Table.ACIDTBL + "(a int, b int) clustered by (a) into "+ BUCKET_COUNT+ " buckets stored as orc TBLPROPERTIES ('transactional'='true')");
  runStatementOnDriver("create table " + Table.ACIDTBLPART + "(a int, b int) partitioned by (p string) clustered by (a) into "+ BUCKET_COUNT+ " buckets stored as orc TBLPROPERTIES ('transactional'='true')");
  runStatementOnDriver("create table " + Table.NONACIDORCTBL + "(a int, b int) clustered by (a) into "+ BUCKET_COUNT+ " buckets stored as orc TBLPROPERTIES ('transactional'='false')");
  runStatementOnDriver("create table " + Table.NONACIDPART + "(a int, b int) partitioned by (p string) stored as orc TBLPROPERTIES ('transactional'='false')");
}

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testDeleteIn() throws Exception {
  int[][] tableData={{1,2},{3,2},{5,2},{1,3},{3,3},{5,3}};
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b) "+ makeValuesClause(tableData));
  runStatementOnDriver("insert into " + Table.NONACIDORCTBL + "(a,b) values(1,7),(3,7)");
  runStatementOnDriver("delete from " + Table.ACIDTBL + " where a in(select a from "+ Table.NONACIDORCTBL+ ")");
  runStatementOnDriver("insert into " + Table.ACIDTBL + "(a,b) select a,b from "+ Table.NONACIDORCTBL);
  List<String> rs=runStatementOnDriver("select a,b from " + Table.ACIDTBL + " order by a,b");
  int[][] updatedData={{1,7},{3,7},{5,2},{5,3}};
  Assert.assertEquals("Bulk update failed",stringifyValues(updatedData),rs);
  runStatementOnDriver("update " + Table.ACIDTBL + " set b=19 where b in(select b from "+ Table.NONACIDORCTBL+ " where a = 3)");
  List<String> rs2=runStatementOnDriver("select a,b from " + Table.ACIDTBL + " order by a,b");
  int[][] updatedData2={{1,19},{3,19},{5,2},{5,3}};
  Assert.assertEquals("Bulk update2 failed",stringifyValues(updatedData2),rs2);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
