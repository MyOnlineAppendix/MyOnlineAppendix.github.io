<h3 style="margin:0px">Class: org.apache.karaf.service.guard.impl.GuardProxyCatalogTest (22 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(16)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(14)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="14"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('14')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-14"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="19"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('19')" data-toggle="tooltip" title="Verifies values related to public fields."><kbd id="tag-19"class="label-info"style="display: inline-block;font-size:7pt" >PublicFieldVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(2)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies whether two objects/variables are the same"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >IdentityVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-6 type-4 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@SuppressWarnings({"unchecked","rawtypes"}) @Test public void testHandleServiceUnregistering() throws Exception {
  BundleContext clientBC=openStrictMockBundleContext(mockBundle(12345L));
  BundleContext client2BC=openStrictMockBundleContext(mockBundle(6L));
  EasyMock.replay(clientBC);
  EasyMock.replay(client2BC);
  Hashtable<String,Object> props=new Hashtable<String,Object>();
  long originalServiceID=12345678901234L;
  props.put(Constants.SERVICE_ID,new Long(originalServiceID));
  props.put("foo","bar");
  ServiceReference<?> originalRef=mockServiceReference(props);
  Hashtable<String,Object> props2=new Hashtable<String,Object>();
  long anotherServiceID=5123456789012345L;
  props2.put(Constants.SERVICE_ID,anotherServiceID);
  ServiceReference<?> anotherRef=mockServiceReference(props2);
  GuardProxyCatalog gpc=new GuardProxyCatalog(mockBundleContext());
  ServiceRegistration<?> proxyReg=EasyMock.createMock(ServiceRegistration.class);
  EasyMock.expect(proxyReg.getReference()).andReturn((ServiceReference)mockServiceReference(props)).anyTimes();
  proxyReg.unregister();
  EasyMock.expectLastCall().once();
  EasyMock.replay(proxyReg);
  ServiceRegistrationHolder srh=new GuardProxyCatalog.ServiceRegistrationHolder();
  srh.registration=proxyReg;
  ServiceRegistration<?> proxy2Reg=EasyMock.createMock(ServiceRegistration.class);
  EasyMock.replay(proxy2Reg);
  ServiceRegistrationHolder srh2=new GuardProxyCatalog.ServiceRegistrationHolder();
  srh2.registration=proxy2Reg;
  gpc.proxyMap.put(originalServiceID,srh);
  gpc.proxyMap.put(anotherServiceID,srh2);
  assertEquals("Precondition",2,gpc.proxyMap.size());
  gpc.createProxyQueue.put(new MockCreateProxyRunnable(originalServiceID));
  gpc.createProxyQueue.put(new MockCreateProxyRunnable(777));
  assertEquals("Precondition",2,gpc.createProxyQueue.size());
  gpc.serviceChanged(new ServiceEvent(ServiceEvent.REGISTERED,originalRef));
  assertEquals("Registered events should be ignored",2,gpc.proxyMap.size());
  assertEquals("Registered events should be ignored",2,gpc.createProxyQueue.size());
  Hashtable<String,Object> proxyProps=new Hashtable<String,Object>(props);
  proxyProps.put(GuardProxyCatalog.PROXY_SERVICE_KEY,Boolean.TRUE);
  ServiceReference<?> proxyRef=mockServiceReference(proxyProps);
  gpc.serviceChanged(new ServiceEvent(ServiceEvent.UNREGISTERING,proxyRef));
  assertEquals("Unregistering the proxy should be ignored by the listener",2,gpc.proxyMap.size());
  assertEquals("Unregistering the proxy should be ignored by the listener",2,gpc.createProxyQueue.size());
  gpc.serviceChanged(new ServiceEvent(ServiceEvent.UNREGISTERING,originalRef));
  assertEquals("The proxy for this service should have been removed",1,gpc.proxyMap.size());
  assertEquals(anotherRef.getProperty(Constants.SERVICE_ID),gpc.proxyMap.keySet().iterator().next());
  assertEquals("The create proxy job for this service should have been removed",1,gpc.createProxyQueue.size());
  assertEquals(777,gpc.createProxyQueue.iterator().next().getOriginalServiceID());
  EasyMock.verify(proxyReg);
  EasyMock.verify(proxy2Reg);
}

</code></pre>

<pre class="type-6 type-3 type-4 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("unchecked") @Test public void testHandleProxificationForHook() throws Exception {
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,GuardProxyCatalog.SERVICE_ACL_PREFIX + "foo");
  config.put(GuardProxyCatalog.SERVICE_GUARD_KEY,"(a>=5)");
  BundleContext bc=mockConfigAdminBundleContext(config);
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  Dictionary<String,Object> props=new Hashtable<String,Object>();
  props.put(Constants.SERVICE_ID,13L);
  props.put("a","6");
  props.put(GuardProxyCatalog.PROXY_SERVICE_KEY,Boolean.TRUE);
  ServiceReference<?> sref2=mockServiceReference(props);
  assertFalse("Should not hide an existing proxy for this client",gpc.handleProxificationForHook(sref2));
  assertEquals("No proxy should have been created",0,gpc.proxyMap.size());
  Dictionary<String,Object> props4=new Hashtable<String,Object>();
  props4.put(Constants.SERVICE_ID,15L);
  props4.put("a","7");
  ServiceReference<?> sref4=mockServiceReference(props4);
  assertTrue("Should hide a service that needs to be proxied",gpc.handleProxificationForHook(sref4));
  assertEquals("Should trigger proxy creation",1,gpc.proxyMap.size());
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testCreateProxy() throws Exception {
  testCreateProxy(TestServiceAPI.class,new TestService());
  testCreateProxy(TestServiceAPI.class,new DescendantTestService());
  testCreateProxy(TestServiceAPI.class,new PrivateTestService());
  testCreateProxy(TestServiceAPI.class,new PrivateTestServiceNoDirectInterfaces());
  testCreateProxy(TestServiceAPI.class,new FinalTestService());
  testCreateProxy(TestObjectWithoutInterface.class,new TestObjectWithoutInterface());
  testCreateProxy(TestServiceAPI.class,new CombinedTestService());
  testCreateProxy(PrivateTestService.class,new PrivateTestService());
  testCreateProxy(PrivateTestServiceNoDirectInterfaces.class,new PrivateTestServiceNoDirectInterfaces());
  testCreateProxy(Object.class,new TestService());
  testCreateProxy(Object.class,new DescendantTestService());
  testCreateProxy(Object.class,new PrivateTestService());
  testCreateProxy(Object.class,new TestObjectWithoutInterface());
  testCreateProxy(Object.class,new CombinedTestService());
  testCreateProxy(Object.class,new FinalTestService());
  testCreateProxy(TestServiceAPI.class,new TestServiceAPI(){
    @Override public String doit(){
      return "Doing it";
    }
  }
);
  testCreateProxy(Object.class,new ClassWithFinalMethod());
  testCreateProxy(Object.class,new ClassWithPrivateMethod());
}

</code></pre>

<pre class="type-6 type-4 type-11 type-5 type-19 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test @SuppressWarnings({"unchecked","rawtypes"}) public void testServiceFactoryBehaviour() throws Exception {
  final Map<ServiceReference,Object> serviceMap=new HashMap<ServiceReference,Object>();
  TestServiceAPI testService=new TestService();
  BundleContext bc=mockConfigAdminBundleContext();
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  long serviceID=117L;
  final Hashtable<String,Object> serviceProps=new Hashtable<String,Object>();
  serviceProps.put(Constants.OBJECTCLASS,new String[]{TestServiceAPI.class.getName()});
  serviceProps.put(Constants.SERVICE_ID,serviceID);
  serviceProps.put("bar",42L);
  BundleContext providerBC=EasyMock.createMock(BundleContext.class);
  EasyMock.expect(providerBC.registerService(EasyMock.isA(String[].class),EasyMock.anyObject(),EasyMock.isA(Dictionary.class))).andAnswer(new IAnswer(){
    @Override public ServiceRegistration answer() throws Throwable {
      Dictionary<String,Object> props=(Dictionary<String,Object>)EasyMock.getCurrentArguments()[2];
      ServiceRegistration reg=EasyMock.createMock(ServiceRegistration.class);
      ServiceReference sr=mockServiceReference(props);
      EasyMock.expect(reg.getReference()).andReturn(sr).anyTimes();
      EasyMock.replay(reg);
      serviceMap.put(sr,EasyMock.getCurrentArguments()[1]);
      return reg;
    }
  }
).once();
  EasyMock.expect(providerBC.getService(EasyMock.isA(ServiceReference.class))).andAnswer(new IAnswer(){
    @Override public Object answer() throws Throwable {
      return serviceMap.get(EasyMock.getCurrentArguments()[0]);
    }
  }
).anyTimes();
  EasyMock.replay(providerBC);
  BundleWiring bw=EasyMock.createMock(BundleWiring.class);
  EasyMock.expect(bw.getClassLoader()).andReturn(getClass().getClassLoader()).anyTimes();
  EasyMock.replay(bw);
  Bundle providerBundle=EasyMock.createNiceMock(Bundle.class);
  EasyMock.expect(providerBundle.getBundleContext()).andReturn(providerBC).anyTimes();
  EasyMock.expect(providerBundle.adapt(BundleWiring.class)).andReturn(bw).anyTimes();
  EasyMock.replay(providerBundle);
  ServiceReference sr=mockServiceReference(providerBundle,serviceProps);
  BundleContext clientBC=EasyMock.createMock(BundleContext.class);
  EasyMock.expect(clientBC.getService(sr)).andReturn(testService).anyTimes();
  EasyMock.replay(clientBC);
  Bundle clientBundle=EasyMock.createNiceMock(Bundle.class);
  EasyMock.expect(clientBundle.getBundleContext()).andReturn(clientBC).anyTimes();
  EasyMock.replay(clientBundle);
  gpc.proxyIfNotAlreadyProxied(sr);
  GuardProxyCatalog.ServiceRegistrationHolder holder=gpc.proxyMap.get(serviceID);
  GuardProxyCatalog.CreateProxyRunnable runnable=gpc.createProxyQueue.take();
  assertEquals(117L,runnable.getOriginalServiceID());
  ProxyManager pm=getProxyManager();
  runnable.run(pm);
  ServiceReference<?> proxySR=holder.registration.getReference();
  EasyMock.verify(providerBC);
  ServiceFactory proxyServiceSF=(ServiceFactory)serviceMap.get(proxySR);
  TestServiceAPI proxyService=(TestServiceAPI)proxyServiceSF.getService(clientBundle,null);
  assertNotSame("The proxy should not be the same object as the original service",testService,proxyService);
  assertEquals("Doing it",proxyService.doit());
  EasyMock.reset(clientBC);
  EasyMock.expect(clientBC.ungetService(sr)).andReturn(true).once();
  EasyMock.replay(clientBC);
  proxyServiceSF.ungetService(clientBundle,null,proxyService);
  EasyMock.verify(clientBC);
}

</code></pre>

<pre class="type-6 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@SuppressWarnings("unchecked") @Test public void testAssignRoles4() throws Exception {
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,"foobar");
  config.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  config.put("somemethod","b");
  config.put("someOtherMethod","b");
  config.put("somethingelse","*");
  BundleContext bc=mockConfigAdminBundleContext(config);
  Dictionary<String,Object> proxyProps=testCreateProxy(bc,TestServiceAPI.class,new TestService());
  Collection<String> result=(Collection<String>)proxyProps.get(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY);
  assertEquals(1,result.size());
  assertEquals("b",result.iterator().next());
}

</code></pre>

<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@SuppressWarnings({"unchecked","rawtypes"}) @Test public void testAssignRoles3() throws Exception {
abstract class MyAbstractClass implements TestServiceAPI, TestServiceAPI2 {
  }
  ;
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,"foobar");
  config.put("service.guard","(objectClass=" + TestServiceAPI2.class.getName() + ")");
  config.put("doit","X");
  BundleContext bc=mockConfigAdminBundleContext(config);
  Map<ServiceReference,Object> serviceMap=new HashMap<ServiceReference,Object>();
  testCreateProxy(bc,new Class[]{TestServiceAPI.class,TestServiceAPI2.class},new MyAbstractClass(){
    @Override public String doit(){
      return null;
    }
    @Override public String doit(    String s){
      return null;
    }
  }
,serviceMap);
  assertEquals(1,serviceMap.size());
  assertEquals(Collections.singleton("X"),serviceMap.keySet().iterator().next().getProperty(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY));
}

</code></pre>

<pre class="type-6 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects are null
"></span><br>
@SuppressWarnings("unchecked") @Test public void testAssignRoles2() throws Exception {
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,"foobar");
  config.put("service.guard","(objectClass=" + TestServiceAPI2.class.getName() + ")");
  config.put("doit","X");
  BundleContext bc=mockConfigAdminBundleContext(config);
  Dictionary<String,Object> proxyProps=testCreateProxy(bc,TestServiceAPI.class,new TestService());
  assertNull("No security defined for this API, so no roles should be specified at all",proxyProps.get(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY));
}

</code></pre>

<pre class="type-6 type-14 type-4 type-5 type-19 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
"></span><br>
@SuppressWarnings({"unchecked","rawtypes"}) @Test public void testHandleServiceModified() throws Exception {
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,"test.1.2.3");
  config.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  config.put("doit","role.1");
  Dictionary<String,Object> config2=new Hashtable<String,Object>();
  config2.put(Constants.SERVICE_PID,"test.1.2.4");
  config2.put("service.guard","(objectClass=" + TestServiceAPI2.class.getName() + ")");
  config2.put("doit","role.2");
  BundleContext bc=mockConfigAdminBundleContext(config,config2);
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  long serviceID=1L;
  final Hashtable<String,Object> serviceProps=new Hashtable<String,Object>();
  serviceProps.put(Constants.OBJECTCLASS,new String[]{TestServiceAPI.class.getName(),TestServiceAPI2.class.getName()});
  serviceProps.put(Constants.SERVICE_ID,serviceID);
  serviceProps.put(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY,Arrays.asList("someone"));
  Object myObject=new Object();
  serviceProps.put("foo.bar",myObject);
  BundleContext providerBC=EasyMock.createNiceMock(BundleContext.class);
  EasyMock.expect(providerBC.registerService(EasyMock.aryEq(new String[]{TestServiceAPI.class.getName(),TestServiceAPI2.class.getName()}),EasyMock.anyObject(),EasyMock.anyObject(Dictionary.class))).andAnswer(new IAnswer(){
    @Override public Object answer() throws Throwable {
      final Dictionary props=(Dictionary)EasyMock.getCurrentArguments()[2];
      assertEquals(Boolean.TRUE,props.get(GuardProxyCatalog.PROXY_SERVICE_KEY));
      ServiceRegistration reg=EasyMock.createMock(ServiceRegistration.class);
      ServiceReference sr=mockServiceReference(props);
      EasyMock.expect(reg.getReference()).andReturn(sr).anyTimes();
      reg.setProperties(EasyMock.isA(Dictionary.class));
      EasyMock.expectLastCall().andAnswer(new IAnswer(){
        @Override public Object answer() throws Throwable {
          ArrayList<String> oldKeys=Collections.list(props.keys());
          for (          String key : oldKeys) {
            props.remove(key);
          }
          Dictionary<String,Object> newProps=(Dictionary<String,Object>)EasyMock.getCurrentArguments()[0];
          for (          String key : Collections.list(newProps.keys())) {
            props.put(key,newProps.get(key));
          }
          return null;
        }
      }
).once();
      EasyMock.replay(reg);
      return reg;
    }
  }
).anyTimes();
  EasyMock.replay(providerBC);
  BundleWiring bw=EasyMock.createMock(BundleWiring.class);
  EasyMock.expect(bw.getClassLoader()).andReturn(getClass().getClassLoader()).anyTimes();
  EasyMock.replay(bw);
  Bundle providerBundle=EasyMock.createNiceMock(Bundle.class);
  EasyMock.expect(providerBundle.getBundleContext()).andReturn(providerBC).anyTimes();
  EasyMock.expect(providerBundle.adapt(BundleWiring.class)).andReturn(bw).anyTimes();
  EasyMock.replay(providerBundle);
  ServiceReference sr=mockServiceReference(providerBundle,serviceProps);
  gpc.proxyIfNotAlreadyProxied(sr);
  GuardProxyCatalog.CreateProxyRunnable runnable=gpc.createProxyQueue.take();
  runnable.run(getProxyManager());
  ServiceRegistrationHolder holder=gpc.proxyMap.get(serviceID);
  ServiceRegistration<?> reg=holder.registration;
  for (  String key : serviceProps.keySet()) {
    if (GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY.equals(key)) {
      assertEquals(new HashSet(Arrays.asList("role.1","role.2")),reg.getReference().getProperty(key));
    }
 else {
      assertEquals(serviceProps.get(key),reg.getReference().getProperty(key));
    }
  }
  assertEquals(Boolean.TRUE,reg.getReference().getProperty(GuardProxyCatalog.PROXY_SERVICE_KEY));
  serviceProps.put("test","property");
  assertEquals("Precondition, the mocked reference should have picked up this change","property",sr.getProperty("test"));
  gpc.serviceChanged(new ServiceEvent(ServiceEvent.MODIFIED,sr));
  assertEquals("Changing the service should not change the number of proxies",1,gpc.proxyMap.size());
  for (  String key : serviceProps.keySet()) {
    if (GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY.equals(key)) {
      assertEquals(new HashSet(Arrays.asList("role.1","role.2")),reg.getReference().getProperty(key));
    }
 else {
      assertEquals(serviceProps.get(key),reg.getReference().getProperty(key));
    }
  }
  assertEquals("property",reg.getReference().getProperty("test"));
  assertEquals(Boolean.TRUE,reg.getReference().getProperty(GuardProxyCatalog.PROXY_SERVICE_KEY));
}

</code></pre>

<pre class="type-6 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@SuppressWarnings("unchecked") @Test public void testAssignRoles() throws Exception {
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,"foobar");
  config.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  config.put("somemethod","a,b");
  config.put("someOtherMethod(int)","c");
  config.put("someOtherMethod(int)[/12/]","d");
  config.put("someOtherMethod(int)[\"42\"]","e");
  config.put("someOtherMethod[/.*[x][y][z].*/]","f");
  config.put("someFoo*","g");
  BundleContext bc=mockConfigAdminBundleContext(config);
  Dictionary<String,Object> proxyProps=testCreateProxy(bc,TestServiceAPI.class,new TestService());
  assertEquals(new HashSet<String>(Arrays.asList("a","b","c","d","e","f","g")),new HashSet<String>((Collection<String>)proxyProps.get(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY)));
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@SuppressWarnings("unchecked") @Test public void testCustomRole() throws Exception {
class MyRolePrincipal implements Principal {
    @Override public String getName(){
      return "role1";
    }
  }
  ;
  Dictionary<String,Object> c1=new Hashtable<String,Object>();
  c1.put(Constants.SERVICE_PID,"foobar");
  c1.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  c1.put("doit",MyRolePrincipal.class.getName() + ":role1");
  BundleContext bc=mockConfigAdminBundleContext(c1);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI.class},new TestService());
  Subject s1=new Subject();
  s1.getPrincipals().add(new RolePrincipal("role1"));
  Subject.doAs(s1,new PrivilegedAction(){
    @Override public Object run(){
      try {
        ((TestServiceAPI)proxy).doit();
        fail("Should have prevented this invocation as the custom role is required");
      }
 catch (      SecurityException se) {
      }
      return null;
    }
  }
);
  Subject s2=new Subject();
  s2.getPrincipals().add(new MyRolePrincipal());
  Subject.doAs(s2,new PrivilegedAction(){
    @Override public Object run(){
      ((TestServiceAPI)proxy).doit();
      return null;
    }
  }
);
  Subject s3=new Subject();
  s3.getPrincipals().add(new MyRolePrincipal());
  s3.getPrincipals().add(new RolePrincipal("role1"));
  Subject.doAs(s3,new PrivilegedAction(){
    @Override public Object run(){
      ((TestServiceAPI)proxy).doit();
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-6 type-14 type-10 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking2() throws Exception {
  Dictionary<String,Object> config=new Hashtable<String,Object>();
  config.put(Constants.SERVICE_PID,"barfoobar");
  config.put("service.guard","(objectClass=" + TestObjectWithoutInterface.class.getName() + ")");
  config.put("compute(long)[\"42\"]","b");
  config.put("compute(long)","c");
  BundleContext bc=mockConfigAdminBundleContext(config);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI.class,TestObjectWithoutInterface.class},new CombinedTestService());
  Subject subject=new Subject();
  subject.getPrincipals().add(new RolePrincipal("b"));
  Subject.doAs(subject,new PrivilegedAction(){
    @Override public Object run(){
      if (!runningUnderCoverage) {
        assertEquals(-42L,((TestObjectWithoutInterface)proxy).compute(42L));
        try {
          ((TestObjectWithoutInterface)proxy).compute(44L);
          fail("Should have been blocked");
        }
 catch (        SecurityException se) {
        }
      }
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-6 type-3 type-4 type-5 type-19 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings({"unchecked","rawtypes"}) @Test public void testHandleServiceModified2() throws Exception {
  BundleContext bc=mockConfigAdminBundleContext();
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  long serviceID=1L;
  final Hashtable<String,Object> serviceProps=new Hashtable<String,Object>();
  serviceProps.put(Constants.OBJECTCLASS,new String[]{TestServiceAPI.class.getName()});
  serviceProps.put(Constants.SERVICE_ID,serviceID);
  BundleContext providerBC=EasyMock.createNiceMock(BundleContext.class);
  EasyMock.expect(providerBC.registerService(EasyMock.aryEq(new String[]{TestServiceAPI.class.getName()}),EasyMock.anyObject(),EasyMock.anyObject(Dictionary.class))).andAnswer(new IAnswer(){
    @Override public Object answer() throws Throwable {
      final Dictionary props=(Dictionary)EasyMock.getCurrentArguments()[2];
      assertEquals(Boolean.TRUE,props.get(GuardProxyCatalog.PROXY_SERVICE_KEY));
      ServiceRegistration reg=EasyMock.createMock(ServiceRegistration.class);
      ServiceReference sr=mockServiceReference(props);
      EasyMock.expect(reg.getReference()).andReturn(sr).anyTimes();
      reg.setProperties(EasyMock.isA(Dictionary.class));
      EasyMock.expectLastCall().andAnswer(new IAnswer(){
        @Override public Object answer() throws Throwable {
          ArrayList<String> oldKeys=Collections.list(props.keys());
          for (          String key : oldKeys) {
            props.remove(key);
          }
          Dictionary<String,Object> newProps=(Dictionary<String,Object>)EasyMock.getCurrentArguments()[0];
          for (          String key : Collections.list(newProps.keys())) {
            props.put(key,newProps.get(key));
          }
          return null;
        }
      }
).once();
      EasyMock.replay(reg);
      return reg;
    }
  }
).anyTimes();
  EasyMock.replay(providerBC);
  BundleWiring bw=EasyMock.createMock(BundleWiring.class);
  EasyMock.expect(bw.getClassLoader()).andReturn(getClass().getClassLoader()).anyTimes();
  EasyMock.replay(bw);
  Bundle providerBundle=EasyMock.createNiceMock(Bundle.class);
  EasyMock.expect(providerBundle.getBundleContext()).andReturn(providerBC).anyTimes();
  EasyMock.expect(providerBundle.adapt(BundleWiring.class)).andReturn(bw).anyTimes();
  EasyMock.replay(providerBundle);
  ServiceReference sr=mockServiceReference(providerBundle,serviceProps);
  gpc.proxyIfNotAlreadyProxied(sr);
  GuardProxyCatalog.CreateProxyRunnable runnable=gpc.createProxyQueue.take();
  runnable.run(getProxyManager());
  ServiceRegistrationHolder holder=gpc.proxyMap.get(serviceID);
  ServiceRegistration<?> reg=holder.registration;
  assertFalse("No roles defined for this service using configuration, so roles property should not be set",Arrays.asList(reg.getReference().getPropertyKeys()).contains(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY));
  for (  String key : serviceProps.keySet()) {
    assertEquals(serviceProps.get(key),reg.getReference().getProperty(key));
  }
  assertEquals(Boolean.TRUE,reg.getReference().getProperty(GuardProxyCatalog.PROXY_SERVICE_KEY));
  serviceProps.put(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY,"foobar");
  assertEquals("Precondition, the mocked reference should have picked up this change","foobar",sr.getProperty(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY));
  gpc.serviceChanged(new ServiceEvent(ServiceEvent.MODIFIED,sr));
  assertEquals("Changing the service should not change the number of proxies",1,gpc.proxyMap.size());
  assertFalse("The roles property set on the modified service should have been removed",Arrays.asList(reg.getReference().getPropertyKeys()).contains(GuardProxyCatalog.SERVICE_GUARD_ROLES_PROPERTY));
  assertEquals(Boolean.TRUE,reg.getReference().getProperty(GuardProxyCatalog.PROXY_SERVICE_KEY));
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testCreateProxyMultipleObjectClasses() throws Exception {
  testCreateProxy(new Class[]{TestServiceAPI.class,TestService.class},new TestService());
}

</code></pre>

<pre class="type-6 type-10 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking3() throws Exception {
class MyService implements TestServiceAPI, TestServiceAPI2 {
    public String doit(    String s){
      return new StringBuilder(s).reverse().toString();
    }
    public String doit(){
      return "Doing it";
    }
  }
  ;
  Dictionary<String,Object> c1=new Hashtable<String,Object>();
  c1.put(Constants.SERVICE_PID,"foobar");
  c1.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  c1.put("do*","c");
  Dictionary<String,Object> c2=new Hashtable<String,Object>();
  c2.put(Constants.SERVICE_PID,"foobar2");
  c2.put("service.guard","(objectClass=" + TestServiceAPI2.class.getName() + ")");
  c2.put("doit(java.lang.String)[/[tT][a]+/]","b,d # a regex rule");
  c2.put("doit(java.lang.String)","a");
  BundleContext bc=mockConfigAdminBundleContext(c1,c2);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI.class,TestServiceAPI2.class},new MyService());
  Subject subject=new Subject();
  subject.getPrincipals().add(new RolePrincipal("c"));
  Subject.doAs(subject,new PrivilegedAction(){
    @Override public Object run(){
      assertEquals("Doing it",((TestServiceAPI)proxy).doit());
      return null;
    }
  }
);
  Subject subject2=new Subject();
  subject2.getPrincipals().add(new RolePrincipal("b"));
  subject2.getPrincipals().add(new RolePrincipal("f"));
  Subject.doAs(subject2,new PrivilegedAction(){
    @Override public Object run(){
      try {
        assertEquals("Doing it",((TestServiceAPI)proxy).doit());
        fail("Should have been blocked");
      }
 catch (      SecurityException se) {
      }
      assertEquals("aaT",((TestServiceAPI2)proxy).doit("Taa"));
      try {
        ((TestServiceAPI2)proxy).doit("t");
        fail("Should have been blocked");
      }
 catch (      SecurityException se) {
      }
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-3 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testIsProxy() throws Exception {
  BundleContext bc=mockBundleContext();
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  Dictionary<String,Object> props=new Hashtable<String,Object>();
  props.put(GuardProxyCatalog.PROXY_SERVICE_KEY,Boolean.TRUE);
  assertTrue(gpc.isProxy(mockServiceReference(props)));
  assertFalse(gpc.isProxy(mockServiceReference(new Hashtable<String,Object>())));
}

</code></pre>

<pre class="type-6 type-14 type-10 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking1() throws Exception {
  Dictionary<String,Object> c1=new Hashtable<String,Object>();
  c1.put(Constants.SERVICE_PID,"foobar");
  c1.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  c1.put("doit","a,b");
  Dictionary<String,Object> c2=new Hashtable<String,Object>();
  c2.put(Constants.SERVICE_PID,"barfoobar");
  c2.put("service.guard","(objectClass=" + TestObjectWithoutInterface.class.getName() + ")");
  c2.put("compute","c");
  BundleContext bc=mockConfigAdminBundleContext(c1,c2);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI.class,TestObjectWithoutInterface.class},new CombinedTestService());
  Subject subject=new Subject();
  subject.getPrincipals().add(new RolePrincipal("b"));
  Subject.doAs(subject,new PrivilegedAction(){
    @Override public Object run(){
      assertEquals("Doing it",((TestServiceAPI)proxy).doit());
      if (!runningUnderCoverage) {
        try {
          ((TestObjectWithoutInterface)proxy).compute(44L);
          fail("Should have been blocked");
        }
 catch (        SecurityException se) {
        }
      }
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-14 type-3 type-4 type-5 type-7 type-19 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values related to public fields.">PublicFieldVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Verifies whether objects are null
- Verifies values related to public fields.
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings({"unchecked","rawtypes"}) @Test public void testProxyCreationThread() throws Exception {
  ProxyManager proxyManager=getProxyManager();
  ConfigurationAdmin ca=EasyMock.createMock(ConfigurationAdmin.class);
  EasyMock.expect(ca.listConfigurations(EasyMock.anyObject(String.class))).andReturn(null).anyTimes();
  EasyMock.replay(ca);
  ServiceReference pmSref=EasyMock.createMock(ServiceReference.class);
  EasyMock.replay(pmSref);
  ServiceReference pmSref2=EasyMock.createMock(ServiceReference.class);
  EasyMock.replay(pmSref2);
  ServiceReference cmSref=EasyMock.createMock(ServiceReference.class);
  EasyMock.replay(cmSref);
  Bundle b=EasyMock.createMock(Bundle.class);
  EasyMock.expect(b.getBundleId()).andReturn(23992734L).anyTimes();
  EasyMock.replay(b);
  BundleContext bc=EasyMock.createNiceMock(BundleContext.class);
  EasyMock.expect(bc.getBundle()).andReturn(b).anyTimes();
  EasyMock.expect(bc.createFilter(EasyMock.isA(String.class))).andAnswer(new IAnswer<Filter>(){
    @Override public Filter answer() throws Throwable {
      return FrameworkUtil.createFilter((String)EasyMock.getCurrentArguments()[0]);
    }
  }
).anyTimes();
  final ServiceListener[] pmListenerHolder=new ServiceListener[1];
  String pmFilter="(&(objectClass=" + ProxyManager.class.getName() + ")"+ "(!("+ GuardProxyCatalog.PROXY_SERVICE_KEY+ "=*)))";
  bc.addServiceListener(EasyMock.isA(ServiceListener.class),EasyMock.eq(pmFilter));
  EasyMock.expectLastCall().andAnswer(new IAnswer(){
    @Override public Object answer() throws Throwable {
      pmListenerHolder[0]=(ServiceListener)EasyMock.getCurrentArguments()[0];
      return null;
    }
  }
).anyTimes();
  EasyMock.expect(bc.getServiceReferences(EasyMock.anyObject(String.class),EasyMock.contains(ConfigurationAdmin.class.getName()))).andReturn(new ServiceReference[]{cmSref}).anyTimes();
  EasyMock.expect(bc.getService(pmSref)).andReturn(proxyManager).anyTimes();
  EasyMock.expect(bc.getService(pmSref2)).andReturn(proxyManager).anyTimes();
  EasyMock.expect(bc.getService(cmSref)).andReturn(ca).anyTimes();
  EasyMock.replay(bc);
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  final Hashtable<String,Object> serviceProps=new Hashtable<String,Object>();
  serviceProps.put(Constants.OBJECTCLASS,new String[]{TestServiceAPI.class.getName()});
  serviceProps.put(Constants.SERVICE_ID,162L);
  final Map<ServiceReference<?>,Object> serviceMap=new HashMap<ServiceReference<?>,Object>();
  BundleContext providerBC=EasyMock.createMock(BundleContext.class);
  final Hashtable<String,Object> expectedProxyProps=new Hashtable<String,Object>(serviceProps);
  expectedProxyProps.put(GuardProxyCatalog.PROXY_SERVICE_KEY,Boolean.TRUE);
  EasyMock.expect(providerBC.registerService(EasyMock.isA(String[].class),EasyMock.anyObject(),EasyMock.isA(Dictionary.class))).andAnswer(new IAnswer(){
    @Override public ServiceRegistration answer() throws Throwable {
      Dictionary<String,Object> props=(Dictionary<String,Object>)EasyMock.getCurrentArguments()[2];
      ServiceRegistration reg=EasyMock.createMock(ServiceRegistration.class);
      ServiceReference sr=mockServiceReference(props);
      EasyMock.expect(reg.getReference()).andReturn(sr).anyTimes();
      reg.unregister();
      EasyMock.expectLastCall().once();
      EasyMock.replay(reg);
      serviceMap.put(sr,EasyMock.getCurrentArguments()[1]);
      return reg;
    }
  }
).once();
  EasyMock.expect(providerBC.getService(EasyMock.isA(ServiceReference.class))).andAnswer(new IAnswer(){
    @Override public Object answer() throws Throwable {
      return serviceMap.get(EasyMock.getCurrentArguments()[0]);
    }
  }
).anyTimes();
  EasyMock.replay(providerBC);
  BundleWiring bw=EasyMock.createMock(BundleWiring.class);
  EasyMock.expect(bw.getClassLoader()).andReturn(getClass().getClassLoader()).anyTimes();
  EasyMock.replay(bw);
  Bundle providerBundle=EasyMock.createNiceMock(Bundle.class);
  EasyMock.expect(providerBundle.getBundleContext()).andReturn(providerBC).anyTimes();
  EasyMock.expect(providerBundle.adapt(BundleWiring.class)).andReturn(bw).anyTimes();
  EasyMock.replay(providerBundle);
  ServiceReference sr=mockServiceReference(providerBundle,serviceProps);
  assertEquals("Precondition",0,gpc.proxyMap.size());
  assertEquals("Precondition",0,gpc.createProxyQueue.size());
  gpc.proxyIfNotAlreadyProxied(sr);
  assertEquals(1,gpc.proxyMap.size());
  assertEquals(1,gpc.createProxyQueue.size());
  GuardProxyCatalog.ServiceRegistrationHolder holder=gpc.proxyMap.get(162L);
  assertNull("The registration shouldn't have happened yet",holder.registration);
  assertEquals(1,gpc.createProxyQueue.size());
  Thread[] tarray=new Thread[Thread.activeCount()];
  Thread.enumerate(tarray);
  for (  Thread t : tarray) {
    if (t != null) {
      assertTrue(!GuardProxyCatalog.PROXY_CREATOR_THREAD_NAME.equals(t.getName()));
    }
  }
  pmListenerHolder[0].serviceChanged(new ServiceEvent(ServiceEvent.REGISTERED,pmSref));
  Thread.sleep(400);
  Thread ourThread=null;
  Thread[] tarray2=new Thread[Thread.activeCount()];
  Thread.enumerate(tarray2);
  for (  Thread t : tarray2) {
    if (t != null) {
      if (t.getName().equals(GuardProxyCatalog.PROXY_CREATOR_THREAD_NAME)) {
        ourThread=t;
      }
    }
  }
  assertNotNull(ourThread);
  assertTrue(ourThread.isDaemon());
  assertTrue(ourThread.isAlive());
  assertNotNull(holder.registration);
  assertEquals(0,gpc.createProxyQueue.size());
  int numProxyThreads=0;
  pmListenerHolder[0].serviceChanged(new ServiceEvent(ServiceEvent.REGISTERED,pmSref2));
  Thread.sleep(300);
  Thread[] tarray3=new Thread[Thread.activeCount()];
  Thread.enumerate(tarray3);
  for (  Thread t : tarray3) {
    if (t != null) {
      if (t.getName().equals(GuardProxyCatalog.PROXY_CREATOR_THREAD_NAME)) {
        numProxyThreads++;
      }
    }
  }
  assertEquals("Maximum 1 proxy thread, even if there is more than 1 proxy service",1,numProxyThreads);
  pmListenerHolder[0].serviceChanged(new ServiceEvent(ServiceEvent.UNREGISTERING,pmSref));
  Thread.sleep(300);
  Thread[] tarray4=new Thread[Thread.activeCount()];
  Thread.enumerate(tarray4);
  for (  Thread t : tarray4) {
    if (t != null) {
      assertTrue(!GuardProxyCatalog.PROXY_CREATOR_THREAD_NAME.equals(t.getName()));
    }
  }
}

</code></pre>

<pre class="type-10 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking6() throws Exception {
  Dictionary<String,Object> c1=new Hashtable<String,Object>();
  c1.put(Constants.SERVICE_PID,"foobar");
  c1.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  c1.put("doit","a,b");
  Dictionary<String,Object> c2=new Hashtable<String,Object>();
  c2.put(Constants.SERVICE_PID,"foobar2");
  c2.put("service.guard","(objectClass=" + TestServiceAPI2.class.getName() + ")");
  c2.put("bar","c");
  BundleContext bc=mockConfigAdminBundleContext(c1,c2);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI2.class},new TestServiceAPI2(){
    @Override public String doit(    String s){
      return s.toUpperCase();
    }
  }
);
  Subject subject=new Subject();
  subject.getPrincipals().add(new RolePrincipal("a"));
  subject.getPrincipals().add(new RolePrincipal("b"));
  subject.getPrincipals().add(new RolePrincipal("c"));
  Subject.doAs(subject,new PrivilegedAction(){
    @Override public Object run(){
      try {
        ((TestServiceAPI2)proxy).doit("hello");
        fail("The invocation should not process as the 'doit' operation has no roles associated with it");
      }
 catch (      SecurityException se) {
      }
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-6 type-10 type-4 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking7() throws Exception {
  Dictionary<String,Object> c1=new Hashtable<String,Object>();
  c1.put(Constants.SERVICE_PID,"foobar");
  c1.put("service.guard","(objectClass=" + TestServiceAPI3.class.getName() + ")");
  c1.put("foo()","a");
  c1.put("bar","b");
  c1.put("*","*");
  BundleContext bc=mockConfigAdminBundleContext(c1);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI3.class},new TestService3());
  Subject s1=new Subject();
  Subject.doAs(s1,new PrivilegedAction(){
    @Override public Object run(){
      TestServiceAPI3 obj=(TestServiceAPI3)proxy;
      assertEquals("Should have allowed this invocation for any (or no) role",-7,obj.foo(7));
      try {
        obj.foo();
        fail("Should have been blocked");
      }
 catch (      SecurityException se) {
      }
      try {
        obj.bar();
        fail("Should have been blocked");
      }
 catch (      SecurityException se) {
      }
      return null;
    }
  }
);
  Subject s2=new Subject();
  s2.getPrincipals().add(new RolePrincipal("a"));
  s2.getPrincipals().add(new RolePrincipal("b"));
  s2.getPrincipals().add(new RolePrincipal("d"));
  Subject.doAs(s2,new PrivilegedAction(){
    @Override public Object run(){
      TestServiceAPI3 obj=(TestServiceAPI3)proxy;
      assertEquals(42,obj.foo());
      assertEquals(99,obj.bar());
      assertEquals(-32767,obj.foo(32767));
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-3 type-4 type-5 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testGuardProxyCatalog() throws Exception {
  Bundle b=EasyMock.createMock(Bundle.class);
  EasyMock.expect(b.getBundleId()).andReturn(9823L).anyTimes();
  EasyMock.replay(b);
  BundleContext bc=EasyMock.createNiceMock(BundleContext.class);
  EasyMock.expect(bc.getBundle()).andReturn(b).anyTimes();
  bc.addServiceListener(EasyMock.isA(ServiceListener.class));
  EasyMock.expectLastCall().once();
  String caFilter="(&(objectClass=org.osgi.service.cm.ConfigurationAdmin)" + "(!(" + GuardProxyCatalog.PROXY_SERVICE_KEY + "=*)))";
  EasyMock.expect(bc.createFilter(caFilter)).andReturn(FrameworkUtil.createFilter(caFilter)).anyTimes();
  String pmFilter="(&(objectClass=org.apache.aries.proxy.ProxyManager)" + "(!(" + GuardProxyCatalog.PROXY_SERVICE_KEY + "=*)))";
  EasyMock.expect(bc.createFilter(pmFilter)).andReturn(FrameworkUtil.createFilter(pmFilter)).anyTimes();
  EasyMock.replay(bc);
  GuardProxyCatalog gpc=new GuardProxyCatalog(bc);
  assertTrue("Service Tracker for ConfigAdmin should be opened",gpc.configAdminTracker.getTrackingCount() != -1);
  assertTrue("Service Tracker for ProxyManager should be opened",gpc.proxyManagerTracker.getTrackingCount() != -1);
  EasyMock.verify(bc);
  EasyMock.reset(bc);
  bc.removeServiceListener(EasyMock.isA(ServiceListener.class));
  EasyMock.expectLastCall().once();
  EasyMock.replay(bc);
  gpc.close();
  assertEquals("Service Tracker for ConfigAdmin should be closed",-1,gpc.configAdminTracker.getTrackingCount());
  assertEquals("Service Tracker for ProxyManager should be closed",-1,gpc.proxyManagerTracker.getTrackingCount());
  EasyMock.verify(bc);
}

</code></pre>

<pre class="type-6 type-14 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking4() throws Exception {
  BundleContext bc=mockConfigAdminBundleContext();
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI.class,TestObjectWithoutInterface.class},new CombinedTestService());
  Subject subject=new Subject();
  subject.getPrincipals().add(new RolePrincipal("b"));
  Subject.doAs(subject,new PrivilegedAction(){
    @Override public Object run(){
      assertEquals("Doing it",((TestServiceAPI)proxy).doit());
      if (!runningUnderCoverage) {
        assertEquals(42L,((TestObjectWithoutInterface)proxy).compute(-42L));
        assertEquals(-44L,((TestObjectWithoutInterface)proxy).compute(44L));
      }
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-6 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@SuppressWarnings("unchecked") @Test public void testInvocationBlocking5() throws Exception {
  Dictionary<String,Object> c1=new Hashtable<String,Object>();
  c1.put(Constants.SERVICE_PID,"foobar");
  c1.put("service.guard","(objectClass=" + TestServiceAPI.class.getName() + ")");
  c1.put("doit","a,b");
  BundleContext bc=mockConfigAdminBundleContext(c1);
  final Object proxy=testCreateProxy(bc,new Class[]{TestServiceAPI2.class},new TestServiceAPI2(){
    @Override public String doit(    String s){
      return s.toUpperCase();
    }
  }
);
  Subject subject=new Subject();
  subject.getPrincipals().add(new RolePrincipal("c"));
  Subject.doAs(subject,new PrivilegedAction(){
    @Override public Object run(){
      assertEquals("The invocation under role 'c' should be ok, as there are no rules specified " + "for this service at all.","HELLO",((TestServiceAPI2)proxy).doit("hello"));
      return null;
    }
  }
);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
