<h3 style="margin:0px">Class: org.apache.sshd.common.auth.AuthenticationTest (16 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(3)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="15"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('15')" data-toggle="tooltip" title="Verifies whether two objects/variables are the same"><kbd id="tag-15"class="label-info"style="display: inline-block;font-size:7pt" >IdentityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testWrongPassword() throws Exception {
  try (SshClient client=setupTestClient()){
    client.start();
    try (ClientSession s=client.connect("user",TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.addPasswordIdentity("bad password");
      assertAuthenticationResult(getCurrentTestName(),s.auth(),false);
    }
   }
 }

</code></pre>

<pre class="type-2 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testChangeUser() throws Exception {
  try (SshClient client=setupTestClient()){
    client.start();
    try (ClientSession s=client.connect(null,TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      Collection<ClientSession.ClientSessionEvent> mask=EnumSet.of(ClientSession.ClientSessionEvent.CLOSED,ClientSession.ClientSessionEvent.WAIT_AUTH);
      Collection<ClientSession.ClientSessionEvent> result=s.waitFor(mask,TimeUnit.SECONDS.toMillis(11L));
      assertFalse("Timeout while waiting on session events",result.contains(ClientSession.ClientSessionEvent.TIMEOUT));
      String password="the-password";
      for (      String username : new String[]{"user1","user2"}) {
        try {
          assertAuthenticationResult(username,authPassword(s,username,password),false);
        }
  finally {
          s.removePasswordIdentity(password);
        }
      }
      result=s.waitFor(EnumSet.of(ClientSession.ClientSessionEvent.CLOSED),TimeUnit.SECONDS.toMillis(3L));
      assertTrue("Mismatched client session close mask: " + result,result.containsAll(mask));
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testHostBasedAuthentication() throws Exception {
  final String CLIENT_USERNAME=getClass().getSimpleName();
  final String CLIENT_HOSTNAME=SshdSocketAddress.toAddressString(SshdSocketAddress.getFirstExternalNetwork4Address());
  final KeyPair CLIENT_HOSTKEY=Utils.generateKeyPair("RSA",1024);
  final AtomicInteger invocationCount=new AtomicInteger(0);
  sshd.setHostBasedAuthenticator(new HostBasedAuthenticator(){
    @Override public boolean authenticate(    ServerSession session,    String username,    PublicKey clientHostKey,    String clientHostName,    String clientUsername,    List<X509Certificate> certificates){
      invocationCount.incrementAndGet();
      return CLIENT_USERNAME.equals(clientUsername) && CLIENT_HOSTNAME.equals(clientHostName) && KeyUtils.compareKeys(CLIENT_HOSTKEY.getPublic(),clientHostKey);
    }
  }
);
  sshd.setPasswordAuthenticator(RejectAllPasswordAuthenticator.INSTANCE);
  sshd.setKeyboardInteractiveAuthenticator(KeyboardInteractiveAuthenticator.NONE);
  sshd.setPublickeyAuthenticator(RejectAllPublickeyAuthenticator.INSTANCE);
  sshd.setUserAuthFactories(Collections.<NamedFactory<org.apache.sshd.server.auth.UserAuth>>singletonList(org.apache.sshd.server.auth.hostbased.UserAuthHostBasedFactory.INSTANCE));
  try (SshClient client=setupTestClient()){
    org.apache.sshd.client.auth.hostbased.UserAuthHostBasedFactory factory=new org.apache.sshd.client.auth.hostbased.UserAuthHostBasedFactory();
    factory.setClientUsername(CLIENT_USERNAME);
    factory.setClientHostKeys(HostKeyIdentityProvider.Utils.wrap(CLIENT_HOSTKEY));
    client.setUserAuthFactories(Collections.<NamedFactory<org.apache.sshd.client.auth.UserAuth>>singletonList(factory));
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.auth().verify(11L,TimeUnit.SECONDS);
      assertEquals("Mismatched authenticator invocation count",1,invocationCount.get());
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-8 type-3 type-15 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testPasswordIdentityProviderPropagation() throws Exception {
  try (SshClient client=setupTestClient()){
    final List<String> passwords=Collections.singletonList(getCurrentTestName());
    final AtomicInteger loadCount=new AtomicInteger(0);
    PasswordIdentityProvider provider=new PasswordIdentityProvider(){
      @Override public Iterable<String> loadPasswords(){
        loadCount.incrementAndGet();
        outputDebugMessage("loadPasswords - count=%s",loadCount);
        return passwords;
      }
    }
;
    client.setPasswordIdentityProvider(provider);
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.auth().verify(11L,TimeUnit.SECONDS);
      assertEquals("Mismatched load passwords count",1,loadCount.get());
      assertSame("Mismatched passwords identity provider",provider,s.getPasswordIdentityProvider());
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-11 type-10 type-2 type-3 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testRuntimeErrorsInAuthenticators() throws Exception {
  final Error thrown=new OutOfMemoryError(getCurrentTestName());
  final PasswordAuthenticator authPassword=sshd.getPasswordAuthenticator();
  final AtomicInteger passCounter=new AtomicInteger(0);
  sshd.setPasswordAuthenticator(new PasswordAuthenticator(){
    @Override public boolean authenticate(    String username,    String password,    ServerSession session) throws PasswordChangeRequiredException {
      int count=passCounter.incrementAndGet();
      if (count == 1) {
        throw thrown;
      }
      return authPassword.authenticate(username,password,session);
    }
  }
);
  final PublickeyAuthenticator authPubkey=sshd.getPublickeyAuthenticator();
  final AtomicInteger pubkeyCounter=new AtomicInteger(0);
  sshd.setPublickeyAuthenticator(new PublickeyAuthenticator(){
    @Override public boolean authenticate(    String username,    PublicKey key,    ServerSession session){
      int count=pubkeyCounter.incrementAndGet();
      if (count == 1) {
        throw thrown;
      }
      return authPubkey.authenticate(username,key,session);
    }
  }
);
  sshd.setKeyboardInteractiveAuthenticator(KeyboardInteractiveAuthenticator.NONE);
  try (SshClient client=setupTestClient()){
    KeyPair kp=Utils.generateKeyPair("RSA",1024);
    client.start();
    try {
      for (int index=1; index < 3; index++) {
        try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
          s.addPasswordIdentity(getCurrentTestName());
          s.addPublicKeyIdentity(kp);
          AuthFuture auth=s.auth();
          assertTrue("Failed to complete authentication on time",auth.await(11L,TimeUnit.SECONDS));
          if (auth.isSuccess()) {
            assertTrue("Premature authentication success",index > 1);
            break;
          }
          assertEquals("Password authenticator not consulted",1,passCounter.get());
          assertEquals("Pubkey authenticator not consulted",1,pubkeyCounter.get());
        }
       }
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-11 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testMismatchedUserAuthPkOkData() throws Exception {
  final AtomicInteger challengeCounter=new AtomicInteger(0);
  sshd.setUserAuthFactories(Collections.<NamedFactory<org.apache.sshd.server.auth.UserAuth>>singletonList(new org.apache.sshd.server.auth.pubkey.UserAuthPublicKeyFactory(){
    @Override public org.apache.sshd.server.auth.pubkey.UserAuthPublicKey create(){
      return new org.apache.sshd.server.auth.pubkey.UserAuthPublicKey(){
        @Override protected void sendPublicKeyResponse(        ServerSession session,        String username,        String alg,        PublicKey key,        byte[] keyBlob,        int offset,        int blobLen,        Buffer buffer) throws Exception {
          int count=challengeCounter.incrementAndGet();
          outputDebugMessage("sendPublicKeyChallenge(%s)[%s]: count=%d",session,alg,count);
          if (count == 1) {
            super.sendPublicKeyResponse(session,username,KeyPairProvider.SSH_DSS,key,keyBlob,offset,blobLen,buffer);
          }
 else           if (count == 2) {
            KeyPair otherPair=org.apache.sshd.util.test.Utils.generateKeyPair("RSA",1024);
            PublicKey otherKey=otherPair.getPublic();
            Buffer buf=session.prepareBuffer(SshConstants.SSH_MSG_USERAUTH_PK_OK,BufferUtils.clear(buffer));
            buf.putString(alg);
            buf.putPublicKey(otherKey);
            session.writePacket(buf);
          }
 else {
            super.sendPublicKeyResponse(session,username,alg,key,keyBlob,offset,blobLen,buffer);
          }
        }
      }
;
    }
  }
));
  try (SshClient client=setupTestClient()){
    KeyPair clientIdentity=Utils.generateKeyPair("RSA",1024);
    client.start();
    try {
      for (int index=1; index <= 4; index++) {
        try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
          s.addPublicKeyIdentity(clientIdentity);
          s.auth().verify(17L,TimeUnit.SECONDS);
          assertEquals("Mismatched number of challenges",3,challengeCounter.get());
          break;
        }
 catch (        SshException e) {
          outputDebugMessage("%s on retry #%d: %s",e.getClass().getSimpleName(),index,e.getMessage());
          Throwable t=e.getCause();
          assertObjectInstanceOf("Unexpected failure cause at retry #" + index,InvalidKeySpecException.class,t);
        }
      }
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown() throws Exception {
  if (sshd != null) {
    sshd.stop(true);
  }
}

</code></pre>

<pre class="type-8 type-3 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testPublicKeyAuthDifferentThanKex() throws Exception {
  final KeyPairProvider serverKeys=KeyPairProvider.Utils.wrap(Utils.generateKeyPair("RSA",1024),Utils.generateKeyPair("DSA",512),Utils.generateKeyPair("EC",256));
  sshd.setKeyPairProvider(serverKeys);
  sshd.setKeyboardInteractiveAuthenticator(KeyboardInteractiveAuthenticator.NONE);
  sshd.setPasswordAuthenticator(RejectAllPasswordAuthenticator.INSTANCE);
  final KeyPair clientIdentity=Utils.generateKeyPair("EC",256);
  sshd.setPublickeyAuthenticator(new PublickeyAuthenticator(){
    @Override public boolean authenticate(    String username,    PublicKey key,    ServerSession session){
      String keyType=KeyUtils.getKeyType(key);
      String expType=KeyUtils.getKeyType(clientIdentity);
      assertEquals("Mismatched client key types",expType,keyType);
      assertKeyEquals("Mismatched authentication public keys",clientIdentity.getPublic(),key);
      return true;
    }
  }
);
  try (SshClient client=setupTestClient()){
    final NamedFactory<Signature> kexSignature=BuiltinSignatures.rsa;
    client.setSignatureFactories(Collections.<NamedFactory<Signature>>singletonList(kexSignature));
    client.setServerKeyVerifier(new ServerKeyVerifier(){
      @Override public boolean verifyServerKey(      ClientSession sshClientSession,      SocketAddress remoteAddress,      PublicKey serverKey){
        String keyType=KeyUtils.getKeyType(serverKey);
        String expType=kexSignature.getName();
        assertEquals("Mismatched server key type",expType,keyType);
        KeyPair kp=ValidateUtils.checkNotNull(serverKeys.loadKey(keyType),"No server key for type=%s",keyType);
        assertKeyEquals("Mismatched server public keys",kp.getPublic(),serverKey);
        return true;
      }
    }
);
    org.apache.sshd.client.auth.pubkey.UserAuthPublicKeyFactory factory=new org.apache.sshd.client.auth.pubkey.UserAuthPublicKeyFactory();
    factory.setSignatureFactories(Arrays.<NamedFactory<Signature>>asList(BuiltinSignatures.nistp256,BuiltinSignatures.nistp384,BuiltinSignatures.nistp521));
    client.setUserAuthFactories(Collections.<NamedFactory<UserAuth>>singletonList(factory));
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.addPublicKeyIdentity(clientIdentity);
      s.auth().verify(11L,TimeUnit.SECONDS);
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testAuthPasswordChangeRequest() throws Exception {
  final PasswordAuthenticator delegate=ValidateUtils.checkNotNull(sshd.getPasswordAuthenticator(),"No password authenticator");
  final AtomicInteger attemptsCount=new AtomicInteger(0);
  sshd.setPasswordAuthenticator(new PasswordAuthenticator(){
    @Override public boolean authenticate(    String username,    String password,    ServerSession session) throws PasswordChangeRequiredException {
      if (attemptsCount.incrementAndGet() == 1) {
        throw new PasswordChangeRequiredException(attemptsCount.toString(),getCurrentTestName(),ServerFactoryManager.DEFAULT_WELCOME_BANNER_LANGUAGE);
      }
      return delegate.authenticate(username,password,session);
    }
  }
);
  PropertyResolverUtils.updateProperty(sshd,ServerFactoryManager.AUTH_METHODS,UserAuthPasswordFactory.NAME);
  try (SshClient client=setupTestClient()){
    final AtomicInteger updatesCount=new AtomicInteger(0);
    client.setUserInteraction(new UserInteraction(){
      @Override public boolean isInteractionAllowed(      ClientSession session){
        return true;
      }
      @Override public void welcome(      ClientSession session,      String banner,      String lang){
      }
      @Override public String[] interactive(      ClientSession session,      String name,      String instruction,      String lang,      String[] prompt,      boolean[] echo){
        throw new UnsupportedOperationException("Unexpected call");
      }
      @Override public String getUpdatedPassword(      ClientSession session,      String prompt,      String lang){
        assertEquals("Mismatched prompt",getCurrentTestName(),prompt);
        assertEquals("Mismatched language",ServerFactoryManager.DEFAULT_WELCOME_BANNER_LANGUAGE,lang);
        assertEquals("Unexpected repeated call",1,updatesCount.incrementAndGet());
        return getCurrentTestName();
      }
    }
);
    PropertyResolverUtils.updateProperty(client,ServerFactoryManager.AUTH_METHODS,UserAuthPasswordFactory.NAME);
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.addPasswordIdentity(getCurrentTestName());
      s.auth().verify(11L,TimeUnit.SECONDS);
      assertEquals("No password change request generated",2,attemptsCount.get());
      assertEquals("No user interaction invoked",1,updatesCount.get());
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-8 type-2 type-3 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testAuthDefaultKeyInteractive() throws Exception {
  try (SshClient client=setupTestClient()){
    sshd.setPublickeyAuthenticator(RejectAllPublickeyAuthenticator.INSTANCE);
    sshd.setKeyboardInteractiveAuthenticator(new DefaultKeyboardInteractiveAuthenticator(){
      @Override public InteractiveChallenge generateChallenge(      ServerSession session,      String username,      String lang,      String subMethods){
        assertEquals("Mismatched user language",PropertyResolverUtils.getStringProperty(client,org.apache.sshd.client.auth.keyboard.UserAuthKeyboardInteractive.INTERACTIVE_LANGUAGE_TAG,org.apache.sshd.client.auth.keyboard.UserAuthKeyboardInteractive.DEFAULT_INTERACTIVE_LANGUAGE_TAG),lang);
        assertEquals("Mismatched client sub-methods",PropertyResolverUtils.getStringProperty(client,org.apache.sshd.client.auth.keyboard.UserAuthKeyboardInteractive.INTERACTIVE_SUBMETHODS,org.apache.sshd.client.auth.keyboard.UserAuthKeyboardInteractive.DEFAULT_INTERACTIVE_SUBMETHODS),subMethods);
        InteractiveChallenge challenge=super.generateChallenge(session,username,lang,subMethods);
        assertEquals("Mismatched interaction name",getInteractionName(session),challenge.getInteractionName());
        assertEquals("Mismatched interaction instruction",getInteractionInstruction(session),challenge.getInteractionInstruction());
        assertEquals("Mismatched language tag",getInteractionLanguage(session),challenge.getLanguageTag());
        List<PromptEntry> entries=challenge.getPrompts();
        assertEquals("Mismatched prompts count",1,GenericUtils.size(entries));
        PromptEntry entry=entries.get(0);
        assertEquals("Mismatched prompt",getInteractionPrompt(session),entry.getPrompt());
        assertEquals("Mismatched echo",isInteractionPromptEchoEnabled(session),entry.isEcho());
        return challenge;
      }
      @Override public boolean authenticate(      ServerSession session,      String username,      List<String> responses) throws Exception {
        return super.authenticate(session,username,responses);
      }
    }
);
    client.start();
    try (ClientSession s=client.connect(null,TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      Collection<ClientSession.ClientSessionEvent> result=s.waitFor(EnumSet.of(ClientSession.ClientSessionEvent.CLOSED,ClientSession.ClientSessionEvent.WAIT_AUTH),TimeUnit.SECONDS.toMillis(11L));
      assertFalse("Timeout while waiting for session",result.contains(ClientSession.ClientSessionEvent.TIMEOUT));
      KeyPair pair=createTestHostKeyProvider().loadKey(KeyPairProvider.SSH_RSA);
      try {
        assertAuthenticationResult(UserAuthMethodFactory.PUBLIC_KEY,authPublicKey(s,getCurrentTestName(),pair),false);
      }
  finally {
        s.removePublicKeyIdentity(pair);
      }
      try {
        assertAuthenticationResult(UserAuthMethodFactory.KB_INTERACTIVE,authInteractive(s,getCurrentTestName(),getCurrentTestName()),true);
      }
  finally {
        s.setUserInteraction(null);
      }
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-11 type-8 type-3 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testAuthMultiChallengeKeyInteractive() throws Exception {
  final Class<?> anchor=getClass();
  final InteractiveChallenge challenge=new InteractiveChallenge();
  challenge.setInteractionName(getCurrentTestName());
  challenge.setInteractionInstruction(anchor.getPackage().getName());
  challenge.setLanguageTag(Locale.getDefault().getLanguage());
  final Map<String,String> rspMap=new TreeMap<String,String>(String.CASE_INSENSITIVE_ORDER){
    private static final long serialVersionUID=1L;
{
      put("class",anchor.getSimpleName());
      put("package",anchor.getPackage().getName());
      put("test",getCurrentTestName());
    }
  }
;
  for (  String prompt : rspMap.keySet()) {
    challenge.addPrompt(prompt,(GenericUtils.size(challenge.getPrompts()) & 0x1) != 0);
  }
  PropertyResolverUtils.updateProperty(sshd,ServerFactoryManager.AUTH_METHODS,UserAuthKeyboardInteractiveFactory.NAME);
  final AtomicInteger genCount=new AtomicInteger(0);
  final AtomicInteger authCount=new AtomicInteger(0);
  sshd.setKeyboardInteractiveAuthenticator(new KeyboardInteractiveAuthenticator(){
    @Override public InteractiveChallenge generateChallenge(    ServerSession session,    String username,    String lang,    String subMethods){
      assertEquals("Unexpected challenge call",1,genCount.incrementAndGet());
      return challenge;
    }
    @Override public boolean authenticate(    ServerSession session,    String username,    List<String> responses) throws Exception {
      assertEquals("Unexpected authenticate call",1,authCount.incrementAndGet());
      assertEquals("Mismatched number of responses",GenericUtils.size(rspMap),GenericUtils.size(responses));
      int index=0;
      for (      Map.Entry<String,String> re : rspMap.entrySet()) {
        String prompt=re.getKey();
        String expected=re.getValue();
        String actual=responses.get(index);
        assertEquals("Mismatched response for prompt=" + prompt,expected,actual);
        index++;
      }
      return true;
    }
  }
);
  PropertyResolverUtils.updateProperty(sshd,ServerFactoryManager.AUTH_METHODS,UserAuthKeyboardInteractiveFactory.NAME);
  try (SshClient client=setupTestClient()){
    final AtomicInteger interactiveCount=new AtomicInteger(0);
    client.setUserInteraction(new UserInteraction(){
      @Override public boolean isInteractionAllowed(      ClientSession session){
        return true;
      }
      @Override public void welcome(      ClientSession session,      String banner,      String lang){
      }
      @Override public String[] interactive(      ClientSession session,      String name,      String instruction,      String lang,      String[] prompt,      boolean[] echo){
        assertEquals("Unexpected multiple calls",1,interactiveCount.incrementAndGet());
        assertEquals("Mismatched name",challenge.getInteractionName(),name);
        assertEquals("Mismatched instruction",challenge.getInteractionInstruction(),instruction);
        assertEquals("Mismatched language",challenge.getLanguageTag(),lang);
        List<PromptEntry> entries=challenge.getPrompts();
        assertEquals("Mismatched prompts count",GenericUtils.size(entries),GenericUtils.length(prompt));
        String[] responses=new String[prompt.length];
        for (int index=0; index < prompt.length; index++) {
          PromptEntry e=entries.get(index);
          String key=e.getPrompt();
          assertEquals("Mismatched prompt at index=" + index,key,prompt[index]);
          assertEquals("Mismatched echo at index=" + index,e.isEcho(),echo[index]);
          responses[index]=ValidateUtils.checkNotNull(rspMap.get(key),"No value for prompt=%s",key);
        }
        return responses;
      }
      @Override public String getUpdatedPassword(      ClientSession session,      String prompt,      String lang){
        throw new UnsupportedOperationException("Unexpected call");
      }
    }
);
    PropertyResolverUtils.updateProperty(client,ServerFactoryManager.AUTH_METHODS,UserAuthKeyboardInteractiveFactory.NAME);
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.auth().verify(11L,TimeUnit.SECONDS);
      assertEquals("Bad generated challenge count",1,genCount.get());
      assertEquals("Bad authentication count",1,authCount.get());
      assertEquals("Bad interactive count",1,interactiveCount.get());
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-8 type-2 type-3 type-15 type-7 type-9 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether two objects/variables are the same">IdentityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether two objects/variables are the same
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testAuthExceptionPropagation() throws Exception {
  try (SshClient client=setupTestClient()){
    final RuntimeException expected=new RuntimeException("Synthetic exception");
    final AtomicInteger invocations=new AtomicInteger(0);
    client.addSessionListener(new SessionListener(){
      @Override public void sessionCreated(      Session session){
      }
      @Override public void sessionEvent(      Session session,      Event event){
        assertEquals("Mismatched invocations count",1,invocations.incrementAndGet());
        throw expected;
      }
      @Override public void sessionException(      Session session,      Throwable t){
      }
      @Override public void sessionClosed(      Session session){
      }
    }
);
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.addPasswordIdentity(getCurrentTestName());
      AuthFuture future=s.auth();
      assertTrue("Failed to complete auth in allocated time",future.await(11L,TimeUnit.SECONDS));
      assertFalse("Unexpected authentication success",future.isSuccess());
      Throwable actual=future.getException();
      if (actual instanceof IOException) {
        actual=actual.getCause();
      }
      assertSame("Mismatched authentication failure reason",expected,actual);
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-2 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testAuthKeyPassword() throws Exception {
  try (SshClient client=setupTestClient()){
    sshd.setPublickeyAuthenticator(RejectAllPublickeyAuthenticator.INSTANCE);
    sshd.setKeyboardInteractiveAuthenticator(KeyboardInteractiveAuthenticator.NONE);
    client.start();
    try (ClientSession s=client.connect(null,TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      Collection<ClientSession.ClientSessionEvent> result=s.waitFor(EnumSet.of(ClientSession.ClientSessionEvent.CLOSED,ClientSession.ClientSessionEvent.WAIT_AUTH),TimeUnit.SECONDS.toMillis(11L));
      assertFalse("Timeout while waiting for session",result.contains(ClientSession.ClientSessionEvent.TIMEOUT));
      KeyPair pair=createTestHostKeyProvider().loadKey(KeyPairProvider.SSH_RSA);
      try {
        assertAuthenticationResult(UserAuthMethodFactory.PUBLIC_KEY,authPublicKey(s,getCurrentTestName(),pair),false);
      }
  finally {
        s.removePublicKeyIdentity(pair);
      }
      String password=getCurrentTestName();
      try {
        assertAuthenticationResult(UserAuthMethodFactory.PASSWORD,authPassword(s,getCurrentTestName(),password),true);
      }
  finally {
        s.removePasswordIdentity(password);
      }
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-10 type-7 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testChangePassword() throws Exception {
  final PasswordAuthenticator delegate=sshd.getPasswordAuthenticator();
  final AtomicInteger attemptsCount=new AtomicInteger(0);
  sshd.setPasswordAuthenticator(new PasswordAuthenticator(){
    @Override public boolean authenticate(    String username,    String password,    ServerSession session) throws PasswordChangeRequiredException {
      if (attemptsCount.incrementAndGet() == 1) {
        throw new PasswordChangeRequiredException(attemptsCount.toString(),getCurrentTestName(),ServerFactoryManager.DEFAULT_WELCOME_BANNER_LANGUAGE);
      }
      return delegate.authenticate(username,password,session);
    }
  }
);
  final AtomicInteger changesCount=new AtomicInteger(0);
  sshd.setUserAuthFactories(Collections.<NamedFactory<org.apache.sshd.server.auth.UserAuth>>singletonList(new org.apache.sshd.server.auth.password.UserAuthPasswordFactory(){
    @Override public org.apache.sshd.server.auth.password.UserAuthPassword create(){
      return new org.apache.sshd.server.auth.password.UserAuthPassword(){
        @Override protected Boolean handleClientPasswordChangeRequest(        Buffer buffer,        ServerSession session,        String username,        String oldPassword,        String newPassword) throws Exception {
          if (changesCount.incrementAndGet() == 1) {
            assertNotEquals("Non-different passwords",oldPassword,newPassword);
            return checkPassword(buffer,session,username,newPassword);
          }
 else {
            return super.handleClientPasswordChangeRequest(buffer,session,username,oldPassword,newPassword);
          }
        }
      }
;
    }
  }
));
  PropertyResolverUtils.updateProperty(sshd,ServerFactoryManager.AUTH_METHODS,UserAuthPasswordFactory.NAME);
  try (SshClient client=setupTestClient()){
    final AtomicInteger updatesCount=new AtomicInteger(0);
    client.setUserInteraction(new UserInteraction(){
      @Override public boolean isInteractionAllowed(      ClientSession session){
        return true;
      }
      @Override public void welcome(      ClientSession session,      String banner,      String lang){
      }
      @Override public String[] interactive(      ClientSession session,      String name,      String instruction,      String lang,      String[] prompt,      boolean[] echo){
        throw new UnsupportedOperationException("Unexpected call");
      }
      @Override public String getUpdatedPassword(      ClientSession session,      String prompt,      String lang){
        assertEquals("Mismatched prompt",getCurrentTestName(),prompt);
        assertEquals("Mismatched language",ServerFactoryManager.DEFAULT_WELCOME_BANNER_LANGUAGE,lang);
        assertEquals("Unexpected repeated call",1,updatesCount.incrementAndGet());
        return getCurrentTestName();
      }
    }
);
    final AtomicInteger sentCount=new AtomicInteger(0);
    client.setUserAuthFactories(Collections.<NamedFactory<org.apache.sshd.client.auth.UserAuth>>singletonList(new org.apache.sshd.client.auth.password.UserAuthPasswordFactory(){
      @Override public org.apache.sshd.client.auth.password.UserAuthPassword create(){
        return new org.apache.sshd.client.auth.password.UserAuthPassword(){
          @Override protected void sendPassword(          Buffer buffer,          ClientSession session,          String oldPassword,          String newPassword) throws IOException {
            int count=sentCount.incrementAndGet();
            if (count == 2) {
              super.sendPassword(buffer,session,getClass().getName(),newPassword);
            }
 else {
              super.sendPassword(buffer,session,oldPassword,newPassword);
            }
          }
        }
;
      }
    }
));
    PropertyResolverUtils.updateProperty(client,ServerFactoryManager.AUTH_METHODS,UserAuthPasswordFactory.NAME);
    client.start();
    try (ClientSession s=client.connect(getCurrentTestName(),TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      s.addPasswordIdentity(getCurrentTestName());
      s.auth().verify(11L,TimeUnit.SECONDS);
      assertEquals("No password change request generated",2,attemptsCount.get());
      assertEquals("No password change handled",1,changesCount.get());
      assertEquals("No user interaction invoked",1,updatesCount.get());
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setUp() throws Exception {
  sshd=setupTestServer();
  sshd.setSessionFactory(new SessionFactory(sshd){
    @Override protected ServerSessionImpl doCreateSession(    IoSession ioSession) throws Exception {
      return new TestSession(getServer(),ioSession);
    }
  }
);
  sshd.start();
  port=sshd.getPort();
}

</code></pre>

<pre class="type-2 type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
"></span><br>
@Test public void testAuthPasswordOnly() throws Exception {
  try (SshClient client=setupTestClient()){
    sshd.setPasswordAuthenticator(RejectAllPasswordAuthenticator.INSTANCE);
    client.start();
    try (ClientSession s=client.connect(null,TEST_LOCALHOST,port).verify(7L,TimeUnit.SECONDS).getSession()){
      Collection<ClientSession.ClientSessionEvent> result=s.waitFor(EnumSet.of(ClientSession.ClientSessionEvent.CLOSED,ClientSession.ClientSessionEvent.WAIT_AUTH),TimeUnit.SECONDS.toMillis(11L));
      assertFalse("Timeout while waiting for session",result.contains(ClientSession.ClientSessionEvent.TIMEOUT));
      String password=getCurrentTestName();
      try {
        assertAuthenticationResult(getCurrentTestName(),authPassword(s,getCurrentTestName(),password),false);
      }
  finally {
        s.removePasswordIdentity(password);
      }
    }
  finally {
      client.stop();
    }
  }
 }

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
