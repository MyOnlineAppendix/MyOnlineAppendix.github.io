<h3 style="margin:0px">Class: org.apache.wss4j.dom.message.AttachmentTest (17 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(17)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(17)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(13)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(13)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(13)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(4)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-8 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testInvalidXMLAttachmentContentSignature() throws Exception {
  WSSecSignature builder=new WSSecSignature();
  builder.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  builder.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  builder.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  final String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  builder.setAttachmentCallbackHandler(attachmentCallbackHandler);
  LOG.info("Before Signing....");
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  Document signedDoc=builder.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    LOG.debug("After Signing....");
    String outputString=XMLUtils.prettyDocumentToString(signedDoc);
    LOG.debug(outputString);
  }
  try {
    verify(signedDoc,new CallbackHandler(){
      @Override public void handle(      Callback[] callbacks) throws IOException, UnsupportedCallbackException {
        if (callbacks[0] instanceof AttachmentRequestCallback) {
          AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
          if (!attachment.getId().equals(attachmentRequestCallback.getAttachmentId())) {
            throw new RuntimeException("wrong attachment requested");
          }
          List<Attachment> attachments=new ArrayList<>();
          attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.replace("15","16").getBytes(StandardCharsets.UTF_8)));
          attachments.add(attachment);
          attachmentRequestCallback.setAttachments(attachments);
        }
      }
    }
);
    Assert.fail();
  }
 catch (  WSSecurityException e) {
    Assert.assertEquals(e.getMessage(),"The signature or decryption was invalid");
  }
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentCompleteSignature() throws Exception {
  WSSecSignature builder=new WSSecSignature();
  builder.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  builder.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  builder.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  final String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  builder.setAttachmentCallbackHandler(attachmentCallbackHandler);
  LOG.info("Before Signing....");
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  Document signedDoc=builder.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    LOG.debug("After Signing....");
    String outputString=XMLUtils.prettyDocumentToString(signedDoc);
    LOG.debug(outputString);
  }
  NodeList sigReferences=signedDoc.getElementsByTagNameNS(WSConstants.SIG_NS,"Reference");
  Assert.assertEquals(2,sigReferences.getLength());
  attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  verify(signedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentContentEncryptionExternalReferenceList() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  encrypt.prepare(doc,crypto);
  Element refs=encrypt.encrypt();
  encrypt.addAttachmentEncryptedDataElements(secHeader);
  encrypt.addExternalRefElement(refs,secHeader);
  encrypt.prependToHeader(secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(doc);
    LOG.debug(outputString);
  }
  NodeList references=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"DataReference");
  Assert.assertEquals(2,references.getLength());
  NodeList cipherReferences=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"CipherReference");
  Assert.assertEquals(1,cipherReferences.getLength());
  NodeList encDatas=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"EncryptedData");
  Assert.assertEquals(2,encDatas.getLength());
  NodeList securityHeaderElement=doc.getElementsByTagNameNS(WSConstants.WSSE_NS,"Security");
  Assert.assertEquals(1,securityHeaderElement.getLength());
  NodeList childs=securityHeaderElement.item(0).getChildNodes();
  Assert.assertEquals(3,childs.getLength());
  Assert.assertEquals(childs.item(0).getLocalName(),"EncryptedKey");
  Assert.assertEquals(childs.item(1).getLocalName(),"ReferenceList");
  Assert.assertEquals(childs.item(2).getLocalName(),"EncryptedData");
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(doc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentCompleteEncryption() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  Assert.assertEquals(1,encryptedAttachments.get(0).getHeaders().size());
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(encryptedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testMultipleAttachmentCompleteEncryption() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  final String attachment1Id=UUID.randomUUID().toString();
  final Attachment[] attachment=new Attachment[2];
  attachment[0]=new Attachment();
  attachment[0].setMimeType("text/xml");
  attachment[0].addHeaders(getHeaders(attachment1Id));
  attachment[0].setId(attachment1Id);
  attachment[0].setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  final String attachment2Id=UUID.randomUUID().toString();
  attachment[1]=new Attachment();
  attachment[1].setMimeType("text/plain");
  attachment[1].addHeaders(getHeaders(attachment2Id));
  attachment[1].setId(attachment2Id);
  attachment[1].setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Arrays.asList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(encryptedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachment1Bytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachment1Bytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> att1Headers=responseAttachment.getHeaders();
  Assert.assertEquals(6,att1Headers.size());
  responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(1);
  byte[] attachment2Bytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachment2Bytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/plain",responseAttachment.getMimeType());
  Map<String,String> att2Headers=responseAttachment.getHeaders();
  Assert.assertEquals(6,att2Headers.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testInvalidXMLAttachmentCompleteEncryption() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  try {
    final PushbackInputStream pis=new PushbackInputStream(encryptedAttachments.get(0).getSourceStream(),1);
    pis.unread('K');
    encryptedAttachments.get(0).setSourceStream(pis);
    attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
    verify(encryptedDoc,attachmentCallbackHandler);
  }
 catch (  WSSecurityException e) {
    return;
  }
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertFalse(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentContentSignature() throws Exception {
  WSSecSignature builder=new WSSecSignature();
  builder.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  builder.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  builder.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  final String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  builder.setAttachmentCallbackHandler(attachmentCallbackHandler);
  LOG.info("Before Signing....");
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  Document signedDoc=builder.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    LOG.debug("After Signing....");
    String outputString=XMLUtils.prettyDocumentToString(signedDoc);
    LOG.debug(outputString);
  }
  NodeList sigReferences=signedDoc.getElementsByTagNameNS(WSConstants.SIG_NS,"Reference");
  Assert.assertEquals(2,sigReferences.getLength());
  attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  verify(signedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
}

</code></pre>

<pre class="type-8 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testInvalidXMLAttachmentCmplSignCmplEnc() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  WSSecSignature signature=new WSSecSignature();
  signature.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  signature.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  signature.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment[] attachment=new Attachment[1];
  attachment[0]=new Attachment();
  attachment[0].setMimeType("text/xml");
  attachment[0].addHeaders(getHeaders(attachmentId));
  attachment[0].setId(attachmentId);
  attachment[0].setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  signature.setAttachmentCallbackHandler(new CallbackHandler(){
    @Override public void handle(    Callback[] callbacks) throws IOException, UnsupportedCallbackException {
      if (callbacks[0] instanceof AttachmentRequestCallback) {
        AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
        List<Attachment> attachments=new ArrayList<>();
        attachments.add(attachment[0]);
        attachmentRequestCallback.setAttachments(attachments);
      }
 else {
        AttachmentResultCallback attachmentResultCallback=(AttachmentResultCallback)callbacks[0];
        attachment[0]=attachmentResultCallback.getAttachment();
      }
    }
  }
);
  doc=signature.build(doc,crypto,secHeader);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  encrypt.getParts().addAll(signature.getParts());
  encrypt.setAttachmentCallbackHandler(new CallbackHandler(){
    @Override public void handle(    Callback[] callbacks) throws IOException, UnsupportedCallbackException {
      if (callbacks[0] instanceof AttachmentRequestCallback) {
        AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
        List<Attachment> attachments=new ArrayList<>();
        attachments.add(attachment[0]);
        attachmentRequestCallback.setAttachments(attachments);
      }
 else {
        AttachmentResultCallback attachmentResultCallback=(AttachmentResultCallback)callbacks[0];
        attachment[0]=attachmentResultCallback.getAttachment();
      }
    }
  }
);
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  try {
    verify(encryptedDoc,new CallbackHandler(){
      @Override public void handle(      Callback[] callbacks) throws IOException, UnsupportedCallbackException {
        if (callbacks[0] instanceof AttachmentRequestCallback) {
          AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
          if (!attachment[0].getId().equals(attachmentRequestCallback.getAttachmentId())) {
            throw new RuntimeException("wrong attachment requested");
          }
          List<Attachment> attachments=new ArrayList<>();
          attachments.add(attachment[0]);
          if (attachment[0].getHeaders().size() == 6) {
            attachment[0].addHeader(AttachmentUtils.MIME_HEADER_CONTENT_DESCRIPTION,"Kaputt");
          }
          attachmentRequestCallback.setAttachments(attachments);
        }
 else {
          AttachmentResultCallback attachmentResultCallback=(AttachmentResultCallback)callbacks[0];
          attachment[0]=attachmentResultCallback.getAttachment();
        }
      }
    }
);
    Assert.fail();
  }
 catch (  WSSecurityException e) {
    Assert.assertEquals(e.getMessage(),"The signature or decryption was invalid");
  }
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentCmplSignCmplEnc() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  WSSecSignature signature=new WSSecSignature();
  signature.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  signature.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  signature.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  signature.setAttachmentCallbackHandler(attachmentCallbackHandler);
  doc=signature.build(doc,crypto,secHeader);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  encrypt.getParts().addAll(signature.getParts());
  attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  NodeList securityHeaderElement=doc.getElementsByTagNameNS(WSConstants.WSSE_NS,"Security");
  Assert.assertEquals(1,securityHeaderElement.getLength());
  NodeList childs=securityHeaderElement.item(0).getChildNodes();
  Assert.assertEquals(3,childs.getLength());
  Assert.assertEquals(childs.item(0).getLocalName(),"EncryptedKey");
  Assert.assertEquals(childs.item(1).getLocalName(),"EncryptedData");
  Assert.assertEquals(childs.item(2).getLocalName(),"Signature");
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(encryptedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(1);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentContentEncryptionGCM() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  encrypt.setSymmetricEncAlgorithm(WSConstants.AES_128_GCM);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  NodeList references=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"DataReference");
  Assert.assertEquals(2,references.getLength());
  NodeList cipherReferences=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"CipherReference");
  Assert.assertEquals(1,cipherReferences.getLength());
  NodeList encDatas=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"EncryptedData");
  Assert.assertEquals(2,encDatas.getLength());
  NodeList securityHeaderElement=doc.getElementsByTagNameNS(WSConstants.WSSE_NS,"Security");
  Assert.assertEquals(1,securityHeaderElement.getLength());
  NodeList childs=securityHeaderElement.item(0).getChildNodes();
  Assert.assertEquals(2,childs.getLength());
  Assert.assertEquals(childs.item(0).getLocalName(),"EncryptedKey");
  Assert.assertEquals(childs.item(1).getLocalName(),"EncryptedData");
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(encryptedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentContentEncryption() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  NodeList references=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"DataReference");
  Assert.assertEquals(2,references.getLength());
  NodeList cipherReferences=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"CipherReference");
  Assert.assertEquals(1,cipherReferences.getLength());
  NodeList encDatas=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"EncryptedData");
  Assert.assertEquals(2,encDatas.getLength());
  NodeList securityHeaderElement=doc.getElementsByTagNameNS(WSConstants.WSSE_NS,"Security");
  Assert.assertEquals(1,securityHeaderElement.getLength());
  NodeList childs=securityHeaderElement.item(0).getChildNodes();
  Assert.assertEquals(2,childs.getLength());
  Assert.assertEquals(childs.item(0).getLocalName(),"EncryptedKey");
  Assert.assertEquals(childs.item(1).getLocalName(),"EncryptedData");
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(encryptedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testMultipleAttachmentCompleteSignature() throws Exception {
  WSSecSignature builder=new WSSecSignature();
  builder.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  builder.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  builder.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  final String attachment1Id=UUID.randomUUID().toString();
  final Attachment[] attachment=new Attachment[2];
  attachment[0]=new Attachment();
  attachment[0].setMimeType("text/xml");
  attachment[0].addHeaders(getHeaders(attachment1Id));
  attachment[0].setId(attachment1Id);
  attachment[0].setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  final String attachment2Id=UUID.randomUUID().toString();
  attachment[1]=new Attachment();
  attachment[1].setMimeType("text/plain");
  attachment[1].addHeaders(getHeaders(attachment2Id));
  attachment[1].setId(attachment2Id);
  attachment[1].setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Arrays.asList(attachment));
  builder.setAttachmentCallbackHandler(attachmentCallbackHandler);
  LOG.info("Before Signing....");
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  Document signedDoc=builder.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    LOG.debug("After Signing....");
    String outputString=XMLUtils.prettyDocumentToString(signedDoc);
    LOG.debug(outputString);
  }
  NodeList sigReferences=signedDoc.getElementsByTagNameNS(WSConstants.SIG_NS,"Reference");
  Assert.assertEquals(3,sigReferences.getLength());
  attachmentCallbackHandler=new AttachmentCallbackHandler(Arrays.asList(attachment));
  verify(signedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachment1Bytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachment1Bytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(1);
  byte[] attachment2Bytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachment2Bytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/plain",responseAttachment.getMimeType());
}

</code></pre>

<pre class="type-8 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testInvalidXMLAttachmentCmplEncCmplSign() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment[] attachment=new Attachment[1];
  attachment[0]=new Attachment();
  attachment[0].setMimeType("text/xml");
  attachment[0].addHeaders(getHeaders(attachmentId));
  attachment[0].setId(attachmentId);
  attachment[0].setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  encrypt.setAttachmentCallbackHandler(new CallbackHandler(){
    @Override public void handle(    Callback[] callbacks) throws IOException, UnsupportedCallbackException {
      if (callbacks[0] instanceof AttachmentRequestCallback) {
        AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
        List<Attachment> attachments=new ArrayList<>();
        attachments.add(attachment[0]);
        attachmentRequestCallback.setAttachments(attachments);
      }
 else {
        AttachmentResultCallback attachmentResultCallback=(AttachmentResultCallback)callbacks[0];
        attachment[0]=attachmentResultCallback.getAttachment();
      }
    }
  }
);
  doc=encrypt.build(doc,crypto,secHeader);
  WSSecSignature signature=new WSSecSignature();
  signature.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  signature.getParts().addAll(encrypt.getParts());
  signature.setAttachmentCallbackHandler(new CallbackHandler(){
    @Override public void handle(    Callback[] callbacks) throws IOException, UnsupportedCallbackException {
      if (callbacks[0] instanceof AttachmentRequestCallback) {
        AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
        List<Attachment> attachments=new ArrayList<>();
        attachments.add(attachment[0]);
        attachmentRequestCallback.setAttachments(attachments);
      }
 else {
        AttachmentResultCallback attachmentResultCallback=(AttachmentResultCallback)callbacks[0];
        attachment[0]=attachmentResultCallback.getAttachment();
      }
    }
  }
);
  doc=signature.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(doc);
    LOG.debug(outputString);
  }
  final PushbackInputStream pis=new PushbackInputStream(attachment[0].getSourceStream(),1);
  pis.unread('K');
  attachment[0].setSourceStream(pis);
  try {
    verify(doc,new CallbackHandler(){
      @Override public void handle(      Callback[] callbacks) throws IOException, UnsupportedCallbackException {
        if (callbacks[0] instanceof AttachmentRequestCallback) {
          AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
          if (!attachment[0].getId().equals(attachmentRequestCallback.getAttachmentId())) {
            throw new RuntimeException("wrong attachment requested");
          }
          List<Attachment> attachmentList=new ArrayList<>();
          attachmentList.add(attachment[0]);
          attachmentRequestCallback.setAttachments(attachmentList);
        }
 else {
          AttachmentResultCallback attachmentResultCallback=(AttachmentResultCallback)callbacks[0];
          attachment[0]=attachmentResultCallback.getAttachment();
        }
      }
    }
);
    Assert.fail();
  }
 catch (  WSSecurityException e) {
    Assert.assertEquals(e.getMessage(),"The signature or decryption was invalid");
  }
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentCmplEncCmplSign() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  doc=encrypt.build(doc,crypto,secHeader);
  WSSecSignature signature=new WSSecSignature();
  signature.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  signature.getParts().addAll(encrypt.getParts());
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  signature.setAttachmentCallbackHandler(attachmentCallbackHandler);
  encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  doc=signature.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(doc);
    LOG.debug(outputString);
  }
  NodeList securityHeaderElement=doc.getElementsByTagNameNS(WSConstants.WSSE_NS,"Security");
  Assert.assertEquals(1,securityHeaderElement.getLength());
  NodeList childs=securityHeaderElement.item(0).getChildNodes();
  Assert.assertEquals(3,childs.getLength());
  Assert.assertEquals(childs.item(0).getLocalName(),"Signature");
  Assert.assertEquals(childs.item(1).getLocalName(),"EncryptedKey");
  Assert.assertEquals(childs.item(2).getLocalName(),"EncryptedData");
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(doc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(1);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testXMLAttachmentContentEncryptionNoReference() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  encrypt.prepare(doc,crypto);
  encrypt.encrypt();
  encrypt.addAttachmentEncryptedDataElements(secHeader);
  encrypt.prependToHeader(secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(doc);
    LOG.debug(outputString);
  }
  NodeList references=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"DataReference");
  Assert.assertEquals(0,references.getLength());
  NodeList cipherReferences=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"CipherReference");
  Assert.assertEquals(1,cipherReferences.getLength());
  NodeList encDatas=doc.getElementsByTagNameNS(WSConstants.ENC_NS,"EncryptedData");
  Assert.assertEquals(2,encDatas.getLength());
  NodeList securityHeaderElement=doc.getElementsByTagNameNS(WSConstants.WSSE_NS,"Security");
  Assert.assertEquals(1,securityHeaderElement.getLength());
  NodeList childs=securityHeaderElement.item(0).getChildNodes();
  Assert.assertEquals(2,childs.getLength());
  Assert.assertEquals(childs.item(0).getLocalName(),"EncryptedKey");
  Assert.assertEquals(childs.item(1).getLocalName(),"EncryptedData");
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(doc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
  Assert.assertTrue(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  Assert.assertEquals("text/xml",responseAttachment.getMimeType());
  Map<String,String> attHeaders=responseAttachment.getHeaders();
  Assert.assertEquals(6,attHeaders.size());
}

</code></pre>

<pre class="type-3 type-7 type-5 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies boolean conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testInvalidXMLAttachmentContentEncryption() throws Exception {
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecEncrypt encrypt=new WSSecEncrypt();
  encrypt.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  encrypt.setKeyIdentifierType(WSConstants.ISSUER_SERIAL);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  encrypt.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  encrypt.getParts().add(new WSEncryptionPart("cid:Attachments","Content"));
  String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  encrypt.setAttachmentCallbackHandler(attachmentCallbackHandler);
  List<Attachment> encryptedAttachments=attachmentCallbackHandler.getResponseAttachments();
  Document encryptedDoc=encrypt.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    String outputString=XMLUtils.prettyDocumentToString(encryptedDoc);
    LOG.debug(outputString);
  }
  final PushbackInputStream pis=new PushbackInputStream(encryptedAttachments.get(0).getSourceStream(),1);
  pis.unread('K');
  encryptedAttachments.get(0).setSourceStream(pis);
  attachmentCallbackHandler=new AttachmentCallbackHandler(encryptedAttachments);
  verify(encryptedDoc,attachmentCallbackHandler);
  Assert.assertFalse(attachmentCallbackHandler.getResponseAttachments().isEmpty());
  Attachment responseAttachment=attachmentCallbackHandler.getResponseAttachments().get(0);
  try {
    byte[] attachmentBytes=readInputStream(responseAttachment.getSourceStream());
    Assert.assertFalse(Arrays.equals(attachmentBytes,SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
    Assert.assertEquals("text/xml",responseAttachment.getMimeType());
    Map<String,String> attHeaders=responseAttachment.getHeaders();
    Assert.assertEquals(6,attHeaders.size());
  }
 catch (  IOException ex) {
  }
}

</code></pre>

<pre class="type-8 type-1 type-4 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testInvalidXMLAttachmentCompleteSignature() throws Exception {
  WSSecSignature builder=new WSSecSignature();
  builder.setUserInfo("16c73ab6-b892-458f-abf5-2f875f74882e","security");
  builder.getParts().add(new WSEncryptionPart("Body","http://schemas.xmlsoap.org/soap/envelope/","Content"));
  builder.getParts().add(new WSEncryptionPart("cid:Attachments","Element"));
  final String attachmentId=UUID.randomUUID().toString();
  final Attachment attachment=new Attachment();
  attachment.setMimeType("text/xml");
  attachment.addHeaders(getHeaders(attachmentId));
  attachment.setId(attachmentId);
  attachment.setSourceStream(new ByteArrayInputStream(SOAPUtil.SAMPLE_SOAP_MSG.getBytes(StandardCharsets.UTF_8)));
  AttachmentCallbackHandler attachmentCallbackHandler=new AttachmentCallbackHandler(Collections.singletonList(attachment));
  builder.setAttachmentCallbackHandler(attachmentCallbackHandler);
  LOG.info("Before Signing....");
  Document doc=SOAPUtil.toSOAPPart(SOAPUtil.SAMPLE_SOAP_MSG);
  WSSecHeader secHeader=new WSSecHeader(doc);
  secHeader.insertSecurityHeader();
  Document signedDoc=builder.build(doc,crypto,secHeader);
  if (LOG.isDebugEnabled()) {
    LOG.debug("After Signing....");
    String outputString=XMLUtils.prettyDocumentToString(signedDoc);
    LOG.debug(outputString);
  }
  try {
    attachment.addHeader(AttachmentUtils.MIME_HEADER_CONTENT_DESCRIPTION,"Kaputt");
    verify(signedDoc,new CallbackHandler(){
      @Override public void handle(      Callback[] callbacks) throws IOException, UnsupportedCallbackException {
        if (callbacks[0] instanceof AttachmentRequestCallback) {
          AttachmentRequestCallback attachmentRequestCallback=(AttachmentRequestCallback)callbacks[0];
          if (!attachment.getId().equals(attachmentRequestCallback.getAttachmentId())) {
            throw new RuntimeException("wrong attachment requested");
          }
          List<Attachment> attachments=new ArrayList<>();
          attachments.add(attachment);
          attachmentRequestCallback.setAttachments(attachments);
        }
      }
    }
);
    Assert.fail();
  }
 catch (  WSSecurityException e) {
    Assert.assertEquals(e.getMessage(),"The signature or decryption was invalid");
  }
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
