<h3 style="margin:0px">Class: org.apache.hadoop.hbase.replication.TestReplicationSmallTests (13 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(10)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Integration test for TestReplicationAdmin, removes and re-add a peer
 * cluster
 * @throws Exception
 */
@Test(timeout=300000) public void testAddAndRemoveClusters() throws Exception {
  LOG.info("testAddAndRemoveClusters");
  admin.removePeer("2");
  Thread.sleep(SLEEP_TIME);
  byte[] rowKey=Bytes.toBytes("Won't be replicated");
  Put put=new Put(rowKey);
  put.addColumn(famName,row,row);
  htable1.put(put);
  Get get=new Get(rowKey);
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      break;
    }
    Result res=htable2.get(get);
    if (res.size() >= 1) {
      fail("Not supposed to be replicated");
    }
 else {
      LOG.info("Row not replicated, let's wait a bit more...");
      Thread.sleep(SLEEP_TIME);
    }
  }
  admin.addPeer("2",utility2.getClusterKey());
  Thread.sleep(SLEEP_TIME);
  rowKey=Bytes.toBytes("do rep");
  put=new Put(rowKey);
  put.addColumn(famName,row,row);
  LOG.info("Adding new row");
  htable1.put(put);
  get=new Get(rowKey);
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for put replication");
    }
    Result res=htable2.get(get);
    if (res.size() == 0) {
      LOG.info("Row not available");
      Thread.sleep(SLEEP_TIME * i);
    }
 else {
      assertArrayEquals(res.value(),row);
      break;
    }
  }
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Verify that version and column delete marker types are replicated
 * correctly.
 * @throws Exception
 */
@Test(timeout=300000) public void testDeleteTypes() throws Exception {
  LOG.info("testDeleteTypes");
  final byte[] v1=Bytes.toBytes("v1");
  final byte[] v2=Bytes.toBytes("v2");
  final byte[] v3=Bytes.toBytes("v3");
  htable1=utility1.getConnection().getTable(tableName);
  long t=EnvironmentEdgeManager.currentTime();
  Put put=new Put(row);
  put.addColumn(famName,row,t,v1);
  htable1.put(put);
  put=new Put(row);
  put.addColumn(famName,row,t + 1,v2);
  htable1.put(put);
  put=new Put(row);
  put.addColumn(famName,row,t + 2,v3);
  htable1.put(put);
  Get get=new Get(row);
  get.setMaxVersions();
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for put replication");
    }
    Result res=htable2.get(get);
    if (res.size() < 3) {
      LOG.info("Rows not available");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      assertArrayEquals(CellUtil.cloneValue(res.rawCells()[0]),v3);
      assertArrayEquals(CellUtil.cloneValue(res.rawCells()[1]),v2);
      assertArrayEquals(CellUtil.cloneValue(res.rawCells()[2]),v1);
      break;
    }
  }
  Delete d=new Delete(row);
  d.addColumn(famName,row,t);
  htable1.delete(d);
  get=new Get(row);
  get.setMaxVersions();
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for put replication");
    }
    Result res=htable2.get(get);
    if (res.size() > 2) {
      LOG.info("Version not deleted");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      assertArrayEquals(CellUtil.cloneValue(res.rawCells()[0]),v3);
      assertArrayEquals(CellUtil.cloneValue(res.rawCells()[1]),v2);
      break;
    }
  }
  d=new Delete(row);
  d.addColumns(famName,row,t + 2);
  htable1.delete(d);
  get=new Get(row);
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for del replication");
    }
    Result res=htable2.get(get);
    if (res.size() >= 1) {
      LOG.info("Rows not deleted");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      break;
    }
  }
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Do a more intense version testSmallBatch, one  that will trigger
 * wal rolling and other non-trivial code paths
 * @throws Exception
 */
@Test(timeout=300000) public void testLoading() throws Exception {
  LOG.info("Writing out rows to table1 in testLoading");
  List<Put> puts=new ArrayList<Put>();
  for (int i=0; i < NB_ROWS_IN_BIG_BATCH; i++) {
    Put put=new Put(Bytes.toBytes(i));
    put.addColumn(famName,row,row);
    puts.add(put);
  }
  htable1.setWriteBufferSize(1024);
  htable1.put(puts);
  Scan scan=new Scan();
  ResultScanner scanner=htable1.getScanner(scan);
  Result[] res=scanner.next(NB_ROWS_IN_BIG_BATCH);
  scanner.close();
  assertEquals(NB_ROWS_IN_BIG_BATCH,res.length);
  LOG.info("Looking in table2 for replicated rows in testLoading");
  long start=System.currentTimeMillis();
  final long retries=NB_RETRIES * 10;
  for (int i=0; i < retries; i++) {
    scan=new Scan();
    scanner=htable2.getScanner(scan);
    res=scanner.next(NB_ROWS_IN_BIG_BATCH);
    scanner.close();
    if (res.length != NB_ROWS_IN_BIG_BATCH) {
      if (i == retries - 1) {
        int lastRow=-1;
        for (        Result result : res) {
          int currentRow=Bytes.toInt(result.getRow());
          for (int row=lastRow + 1; row < currentRow; row++) {
            LOG.error("Row missing: " + row);
          }
          lastRow=currentRow;
        }
        LOG.error("Last row: " + lastRow);
        fail("Waited too much time for normal batch replication, " + res.length + " instead of "+ NB_ROWS_IN_BIG_BATCH+ "; waited="+ (System.currentTimeMillis() - start)+ "ms");
      }
 else {
        LOG.info("Only got " + res.length + " rows... retrying");
        Thread.sleep(SLEEP_TIME);
      }
    }
 else {
      break;
    }
  }
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test disable/enable replication, trying to insert, make sure nothing's
 * replicated, enable it, the insert should be replicated
 * @throws Exception
 */
@Test(timeout=300000) public void testDisableEnable() throws Exception {
  admin.disablePeer("2");
  byte[] rowkey=Bytes.toBytes("disable enable");
  Put put=new Put(rowkey);
  put.addColumn(famName,row,row);
  htable1.put(put);
  Get get=new Get(rowkey);
  for (int i=0; i < NB_RETRIES; i++) {
    Result res=htable2.get(get);
    if (res.size() >= 1) {
      fail("Replication wasn't disabled");
    }
 else {
      LOG.info("Row not replicated, let's wait a bit more...");
      Thread.sleep(SLEEP_TIME);
    }
  }
  admin.enablePeer("2");
  for (int i=0; i < NB_RETRIES; i++) {
    Result res=htable2.get(get);
    if (res.size() == 0) {
      LOG.info("Row not available");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      assertArrayEquals(res.value(),row);
      return;
    }
  }
  fail("Waited too much time for put replication");
}

</code></pre>

<pre class="type-4 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Do a small loading into a table, make sure the data is really the same,
 * then run the VerifyReplication job to check the results. Do a second
 * comparison where all the cells are different.
 * @throws Exception
 */
@Test(timeout=300000) public void testVerifyRepJob() throws Exception {
  testSmallBatch();
  String[] args=new String[]{"2",tableName.getNameAsString()};
  Job job=VerifyReplication.createSubmittableJob(CONF_WITH_LOCALFS,args);
  if (job == null) {
    fail("Job wasn't created, see the log");
  }
  if (!job.waitForCompletion(true)) {
    fail("Job failed, see the log");
  }
  assertEquals(NB_ROWS_IN_BATCH,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.GOODROWS).getValue());
  assertEquals(0,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.BADROWS).getValue());
  Scan scan=new Scan();
  ResultScanner rs=htable2.getScanner(scan);
  Put put=null;
  for (  Result result : rs) {
    put=new Put(result.getRow());
    Cell firstVal=result.rawCells()[0];
    put.addColumn(CellUtil.cloneFamily(firstVal),CellUtil.cloneQualifier(firstVal),Bytes.toBytes("diff data"));
    htable2.put(put);
  }
  Delete delete=new Delete(put.getRow());
  htable2.delete(delete);
  job=VerifyReplication.createSubmittableJob(CONF_WITH_LOCALFS,args);
  if (job == null) {
    fail("Job wasn't created, see the log");
  }
  if (!job.waitForCompletion(true)) {
    fail("Job failed, see the log");
  }
  assertEquals(0,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.GOODROWS).getValue());
  assertEquals(NB_ROWS_IN_BATCH,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.BADROWS).getValue());
}

</code></pre>

<pre class="type-7 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
"></span><br>
/** 
 * Test for HBASE-9531
 * put a few rows into htable1, which should be replicated to htable2
 * create a ClusterStatus instance 'status' from HBaseAdmin
 * test : status.getLoad(server).getReplicationLoadSourceList()
 * test : status.getLoad(server).getReplicationLoadSink()
 * * @throws Exception
 */
@Test(timeout=300000) public void testReplicationStatus() throws Exception {
  LOG.info("testReplicationStatus");
  try (Admin admin=utility1.getConnection().getAdmin()){
    final byte[] qualName=Bytes.toBytes("q");
    Put p;
    for (int i=0; i < NB_ROWS_IN_BATCH; i++) {
      p=new Put(Bytes.toBytes("row" + i));
      p.addColumn(famName,qualName,Bytes.toBytes("val" + i));
      htable1.put(p);
    }
    ClusterStatus status=admin.getClusterStatus();
    for (    ServerName server : status.getServers()) {
      ServerLoad sl=status.getLoad(server);
      List<ReplicationLoadSource> rLoadSourceList=sl.getReplicationLoadSourceList();
      ReplicationLoadSink rLoadSink=sl.getReplicationLoadSink();
      assertTrue("failed to get ReplicationLoadSourceList",(rLoadSourceList.size() > 0));
      assertTrue("failed to get ReplicationLoadSink.AgeOfLastShippedOp ",(rLoadSink.getAgeOfLastAppliedOp() >= 0));
      assertTrue("failed to get ReplicationLoadSink.TimeStampsOfLastAppliedOp ",(rLoadSink.getTimeStampsOfLastAppliedOp() >= 0));
    }
  }
 }

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Test for HBASE-9038, Replication.scopeWALEdits would NPE if it wasn't filtering out
 * the compaction WALEdit
 * @throws Exception
 */
@Test(timeout=300000) public void testCompactionWALEdits() throws Exception {
  WALProtos.CompactionDescriptor compactionDescriptor=WALProtos.CompactionDescriptor.getDefaultInstance();
  HRegionInfo hri=new HRegionInfo(htable1.getName(),HConstants.EMPTY_START_ROW,HConstants.EMPTY_END_ROW);
  WALEdit edit=WALEdit.createCompaction(hri,compactionDescriptor);
  Replication.scopeWALEdits(htable1.getTableDescriptor(),new WALKey(),edit,htable1.getConfiguration(),null);
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Try a small batch upload using the write buffer, check it's replicated
 * @throws Exception
 */
@Test(timeout=300000) public void testSmallBatch() throws Exception {
  LOG.info("testSmallBatch");
  List<Put> puts=new ArrayList<>();
  for (int i=0; i < NB_ROWS_IN_BATCH; i++) {
    Put put=new Put(Bytes.toBytes(i));
    put.addColumn(famName,row,row);
    puts.add(put);
  }
  htable1.put(puts);
  Scan scan=new Scan();
  ResultScanner scanner1=htable1.getScanner(scan);
  Result[] res1=scanner1.next(NB_ROWS_IN_BATCH);
  scanner1.close();
  assertEquals(NB_ROWS_IN_BATCH,res1.length);
  for (int i=0; i < NB_RETRIES; i++) {
    scan=new Scan();
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for normal batch replication");
    }
    ResultScanner scanner=htable2.getScanner(scan);
    Result[] res=scanner.next(NB_ROWS_IN_BATCH);
    scanner.close();
    if (res.length != NB_ROWS_IN_BATCH) {
      LOG.info("Only got " + res.length + " rows");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      break;
    }
  }
}

</code></pre>

<pre class="type-9 type-8 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies boolean conditions
"></span><br>
/** 
 * Test for HBASE-8663
 * Create two new Tables with colfamilies enabled for replication then run
 * ReplicationAdmin.listReplicated(). Finally verify the table:colfamilies. Note:
 * TestReplicationAdmin is a better place for this testing but it would need mocks.
 * @throws Exception
 */
@Test(timeout=300000) public void testVerifyListReplicatedTable() throws Exception {
  LOG.info("testVerifyListReplicatedTable");
  final String tName="VerifyListReplicated_";
  final String colFam="cf1";
  final int numOfTables=3;
  Admin hadmin=utility1.getHBaseAdmin();
  for (int i=0; i < numOfTables; i++) {
    HTableDescriptor ht=new HTableDescriptor(TableName.valueOf(tName + i));
    HColumnDescriptor cfd=new HColumnDescriptor(colFam);
    cfd.setScope(HConstants.REPLICATION_SCOPE_GLOBAL);
    ht.addFamily(cfd);
    hadmin.createTable(ht);
  }
  List<HashMap<String,String>> replicationColFams=admin.listReplicated();
  int[] match=new int[numOfTables];
  for (int i=0; i < replicationColFams.size(); i++) {
    HashMap<String,String> replicationEntry=replicationColFams.get(i);
    String tn=replicationEntry.get(ReplicationAdmin.TNAME);
    if ((tn.startsWith(tName)) && replicationEntry.get(ReplicationAdmin.CFNAME).equals(colFam)) {
      int m=Integer.parseInt(tn.substring(tn.length() - 1));
      match[m]++;
    }
  }
  for (int i=0; i < match.length; i++) {
    assertTrue("listReplicated() does not match table " + i,(match[i] == 1));
  }
  for (int i=0; i < numOfTables; i++) {
    TableName tableName=TableName.valueOf(tName + i);
    hadmin.disableTable(tableName);
    hadmin.deleteTable(tableName);
  }
  hadmin.close();
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Add a row, check it's replicated, delete it, check's gone
 * @throws Exception
 */
@Test(timeout=300000) public void testSimplePutDelete() throws Exception {
  LOG.info("testSimplePutDelete");
  Put put=new Put(row);
  put.addColumn(famName,row,row);
  htable1=utility1.getConnection().getTable(tableName);
  htable1.put(put);
  Get get=new Get(row);
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for put replication");
    }
    Result res=htable2.get(get);
    if (res.size() == 0) {
      LOG.info("Row not available");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      assertArrayEquals(res.value(),row);
      break;
    }
  }
  Delete del=new Delete(row);
  htable1.delete(del);
  get=new Get(row);
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for del replication");
    }
    Result res=htable2.get(get);
    if (res.size() >= 1) {
      LOG.info("Row not deleted");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      break;
    }
  }
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=300000) public void testVersionMismatchHBase14905() throws Exception {
  byte[] qualifierName=Bytes.toBytes("f1");
  Put put=new Put(Bytes.toBytes("r1"));
  long ts=System.currentTimeMillis();
  put.addColumn(famName,qualifierName,ts + 1,Bytes.toBytes("v1"));
  htable1.put(put);
  put.addColumn(famName,qualifierName,ts + 2,Bytes.toBytes("v2"));
  htable1.put(put);
  put.addColumn(famName,qualifierName,ts + 3,Bytes.toBytes("v3"));
  htable1.put(put);
  Scan scan=new Scan();
  scan.setMaxVersions(100);
  ResultScanner scanner1=htable1.getScanner(scan);
  Result[] res1=scanner1.next(1);
  scanner1.close();
  assertEquals(1,res1.length);
  assertEquals(3,res1[0].getColumnCells(famName,qualifierName).size());
  for (int i=0; i < NB_RETRIES; i++) {
    scan=new Scan();
    scan.setMaxVersions(100);
    scanner1=htable2.getScanner(scan);
    res1=scanner1.next(1);
    scanner1.close();
    if (res1.length != 1) {
      LOG.info("Only got " + res1.length + " rows");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      int cellNumber=res1[0].getColumnCells(famName,Bytes.toBytes("f1")).size();
      if (cellNumber != 3) {
        LOG.info("Only got " + cellNumber + " cells");
        Thread.sleep(SLEEP_TIME);
      }
 else {
        break;
      }
    }
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for normal batch replication");
    }
  }
  try {
    admin.disablePeer("2");
    Put put2=new Put(Bytes.toBytes("r1"));
    put2.addColumn(famName,qualifierName,ts + 2,Bytes.toBytes("v99"));
    htable2.put(put2);
    scan=new Scan();
    scan.setMaxVersions(100);
    scanner1=htable2.getScanner(scan);
    res1=scanner1.next(NB_ROWS_IN_BATCH);
    scanner1.close();
    assertEquals(1,res1.length);
    assertEquals(3,res1[0].getColumnCells(famName,qualifierName).size());
    String[] args=new String[]{"--versions=100","2",tableName.getNameAsString()};
    Job job=VerifyReplication.createSubmittableJob(CONF_WITH_LOCALFS,args);
    if (job == null) {
      fail("Job wasn't created, see the log");
    }
    if (!job.waitForCompletion(true)) {
      fail("Job failed, see the log");
    }
    assertEquals(0,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.GOODROWS).getValue());
    assertEquals(1,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.BADROWS).getValue());
  }
  finally {
    admin.enablePeer("2");
  }
}

</code></pre>

<pre class="type-4 type-9 type-10 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test(timeout=300000) public void testHBase14905() throws Exception {
  byte[] qualifierName=Bytes.toBytes("f1");
  Put put=new Put(Bytes.toBytes("r1"));
  put.addColumn(famName,qualifierName,Bytes.toBytes("v1002"));
  htable1.put(put);
  put.addColumn(famName,qualifierName,Bytes.toBytes("v1001"));
  htable1.put(put);
  put.addColumn(famName,qualifierName,Bytes.toBytes("v1112"));
  htable1.put(put);
  Scan scan=new Scan();
  scan.setMaxVersions(100);
  ResultScanner scanner1=htable1.getScanner(scan);
  Result[] res1=scanner1.next(1);
  scanner1.close();
  assertEquals(1,res1.length);
  assertEquals(3,res1[0].getColumnCells(famName,qualifierName).size());
  for (int i=0; i < NB_RETRIES; i++) {
    scan=new Scan();
    scan.setMaxVersions(100);
    scanner1=htable2.getScanner(scan);
    res1=scanner1.next(1);
    scanner1.close();
    if (res1.length != 1) {
      LOG.info("Only got " + res1.length + " rows");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      int cellNumber=res1[0].getColumnCells(famName,Bytes.toBytes("f1")).size();
      if (cellNumber != 3) {
        LOG.info("Only got " + cellNumber + " cells");
        Thread.sleep(SLEEP_TIME);
      }
 else {
        break;
      }
    }
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for normal batch replication");
    }
  }
  put.addColumn(famName,qualifierName,Bytes.toBytes("v1111"));
  htable2.put(put);
  put.addColumn(famName,qualifierName,Bytes.toBytes("v1112"));
  htable2.put(put);
  scan=new Scan();
  scan.setMaxVersions(100);
  scanner1=htable2.getScanner(scan);
  res1=scanner1.next(NB_ROWS_IN_BATCH);
  scanner1.close();
  assertEquals(1,res1.length);
  assertEquals(5,res1[0].getColumnCells(famName,qualifierName).size());
  String[] args=new String[]{"--versions=100","2",tableName.getNameAsString()};
  Job job=VerifyReplication.createSubmittableJob(CONF_WITH_LOCALFS,args);
  if (job == null) {
    fail("Job wasn't created, see the log");
  }
  if (!job.waitForCompletion(true)) {
    fail("Job failed, see the log");
  }
  assertEquals(0,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.GOODROWS).getValue());
  assertEquals(1,job.getCounters().findCounter(VerifyReplication.Verifier.Counters.BADROWS).getValue());
}

</code></pre>

<pre class="type-9 type-2 type-10 type-11 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Allocates resources before the execution of the test cases
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * @throws java.lang.Exception
 */
@Before public void setUp() throws Exception {
  for (  JVMClusterUtil.RegionServerThread r : utility1.getHBaseCluster().getRegionServerThreads()) {
    utility1.getHBaseAdmin().rollWALWriter(r.getRegionServer().getServerName());
  }
  utility1.deleteTableData(tableName);
  Scan scan=new Scan();
  int lastCount=0;
  for (int i=0; i < NB_RETRIES; i++) {
    if (i == NB_RETRIES - 1) {
      fail("Waited too much time for truncate");
    }
    ResultScanner scanner=htable2.getScanner(scan);
    Result[] res=scanner.next(NB_ROWS_IN_BIG_BATCH);
    scanner.close();
    if (res.length != 0) {
      if (res.length < lastCount) {
        i--;
      }
      lastCount=res.length;
      LOG.info("Still got " + res.length + " rows");
      Thread.sleep(SLEEP_TIME);
    }
 else {
      break;
    }
  }
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
