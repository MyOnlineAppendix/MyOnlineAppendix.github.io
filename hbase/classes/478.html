<h3 style="margin:0px">Class: org.apache.hadoop.hbase.regionserver.TestHRegionReplayEvents (28 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(13)</kbd></button>&nbsp;<button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(12)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(11)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(11)</kbd></button>&nbsp;<button id="1"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('1')" data-toggle="tooltip" title="Executes methods or other tests from the same test unit"><kbd id="tag-1"class="label-info"style="display: inline-block;font-size:7pt" >ExecutionTester&nbsp;(11)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(7)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(6)</kbd></button>&nbsp;<button id="9"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('9')" data-toggle="tooltip" title="Verifies assertions in iterations"><kbd id="tag-9"class="label-info"style="display: inline-block;font-size:7pt" >IterativeVerifier&nbsp;(5)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(4)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(2)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-4 type-7 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testSeqIdsFromReplay() throws IOException {
  String method=name.getMethodName();
  byte[] tableName=Bytes.toBytes(method);
  byte[] family=Bytes.toBytes("family");
  HRegion region=initHRegion(tableName,method,family);
  try {
    long readPoint=region.getMVCC().getReadPoint();
    long origSeqId=readPoint + 100;
    Put put=new Put(row).addColumn(family,row,row);
    put.setDurability(Durability.SKIP_WAL);
    replay(region,put,origSeqId);
    assertGet(region,family,row);
    assertEquals(origSeqId,region.getReadPoint(null));
    put=new Put(row2).addColumn(family,row2,row2);
    put.setDurability(Durability.SKIP_WAL);
    replay(region,put,origSeqId - 50);
    assertGet(region,family,row2);
  }
  finally {
    region.close();
  }
}

</code></pre>

<pre class="type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testRefreshStoreFiles() throws IOException {
  assertEquals(0,primaryRegion.getStoreFileList(families).size());
  assertEquals(0,secondaryRegion.getStoreFileList(families).size());
  secondaryRegion.refreshStoreFiles();
  assertEquals(0,secondaryRegion.getStoreFileList(families).size());
  putDataWithFlushes(primaryRegion,100,100,0);
  int numRows=100;
  secondaryRegion.refreshStoreFiles();
  assertPathListsEqual(primaryRegion.getStoreFileList(families),secondaryRegion.getStoreFileList(families));
  assertEquals(families.length,secondaryRegion.getStoreFileList(families).size());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  putDataWithFlushes(primaryRegion,100,300,0);
  numRows=300;
  secondaryRegion.refreshStoreFiles();
  assertPathListsEqual(primaryRegion.getStoreFileList(families),secondaryRegion.getStoreFileList(families));
  assertEquals(families.length * 4,secondaryRegion.getStoreFileList(families).size());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  if (FSUtils.WINDOWS) {
    return;
  }
  primaryRegion.compactStores();
  List<Region> regions=new ArrayList<Region>();
  regions.add(primaryRegion);
  when(rss.getOnlineRegions()).thenReturn(regions);
  CompactedHFilesDischarger cleaner=new CompactedHFilesDischarger(100,null,rss,false);
  cleaner.chore();
  secondaryRegion.refreshStoreFiles();
  assertPathListsEqual(primaryRegion.getStoreFileList(families),secondaryRegion.getStoreFileList(families));
  assertEquals(families.length,secondaryRegion.getStoreFileList(families).size());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Replaying edits in secondary");
  assertTrue(secondaryRegion.getMemstoreSize() == 0);
  putDataWithFlushes(primaryRegion,400,400,0);
  numRows=400;
  reader=createWALReaderForPrimary();
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flush=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flush != null) {
    }
 else {
      replayEdit(secondaryRegion,entry);
    }
  }
  assertTrue(secondaryRegion.getMemstoreSize() > 0);
  secondaryRegion.refreshStoreFiles();
  assertTrue(secondaryRegion.getMemstoreSize() == 0);
  LOG.info("-- Verifying edits from primary");
  verifyData(primaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
}

</code></pre>

<pre class="type-9 type-10 type-7 type-5 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
"></span><br>
@Test public void testReplayFlushSeqIds() throws IOException {
  int start=0;
  LOG.info("-- Writing some data to primary from " + start + " to "+ (start + 100));
  putData(primaryRegion,Durability.SYNC_WAL,start,100,cq,families);
  LOG.info("-- Flushing primary, creating 3 files for 3 stores");
  primaryRegion.flush(true);
  reader=createWALReaderForPrimary();
  long flushSeqId=-1;
  LOG.info("-- Replaying flush events in secondary");
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        LOG.info("-- Replaying flush start in secondary");
        secondaryRegion.replayWALFlushStartMarker(flushDesc);
        flushSeqId=flushDesc.getFlushSequenceNumber();
      }
 else       if (flushDesc.getAction() == FlushAction.COMMIT_FLUSH) {
        LOG.info("-- Replaying flush commit in secondary");
        secondaryRegion.replayWALFlushCommitMarker(flushDesc);
        assertEquals(flushSeqId,flushDesc.getFlushSequenceNumber());
      }
    }
  }
  long readPoint=secondaryRegion.getMVCC().getReadPoint();
  assertEquals(flushSeqId,readPoint);
  verifyData(secondaryRegion,0,100,cq,families);
}

</code></pre>

<pre class="type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setup() throws IOException {
  TEST_UTIL=HBaseTestingUtility.createLocalHTU();
  CONF=TEST_UTIL.getConfiguration();
  dir=TEST_UTIL.getDataTestDir("TestHRegionReplayEvents").toString();
  method=name.getMethodName();
  tableName=Bytes.toBytes(name.getMethodName());
  rootDir=new Path(dir + method);
  TEST_UTIL.getConfiguration().set(HConstants.HBASE_DIR,rootDir.toString());
  method=name.getMethodName();
  htd=new HTableDescriptor(TableName.valueOf(method));
  for (  byte[] family : families) {
    htd.addFamily(new HColumnDescriptor(family));
  }
  time=System.currentTimeMillis();
  primaryHri=new HRegionInfo(htd.getTableName(),HConstants.EMPTY_START_ROW,HConstants.EMPTY_END_ROW,false,time,0);
  secondaryHri=new HRegionInfo(htd.getTableName(),HConstants.EMPTY_START_ROW,HConstants.EMPTY_END_ROW,false,time,1);
  wals=TestHRegion.createWALFactory(CONF,rootDir);
  walPrimary=wals.getWAL(primaryHri.getEncodedNameAsBytes(),primaryHri.getTable().getNamespace());
  walSecondary=wals.getWAL(secondaryHri.getEncodedNameAsBytes(),secondaryHri.getTable().getNamespace());
  rss=mock(RegionServerServices.class);
  when(rss.getServerName()).thenReturn(ServerName.valueOf("foo",1,1));
  when(rss.getConfiguration()).thenReturn(CONF);
  when(rss.getRegionServerAccounting()).thenReturn(new RegionServerAccounting());
  String string=org.apache.hadoop.hbase.executor.EventType.RS_COMPACTED_FILES_DISCHARGER.toString();
  ExecutorService es=new ExecutorService(string);
  es.startExecutorService(string + "-" + string,1);
  when(rss.getExecutorService()).thenReturn(es);
  primaryRegion=HRegion.createHRegion(primaryHri,rootDir,CONF,htd,walPrimary);
  primaryRegion.close();
  List<Region> regions=new ArrayList<Region>();
  regions.add(primaryRegion);
  when(rss.getOnlineRegions()).thenReturn(regions);
  primaryRegion=HRegion.openHRegion(rootDir,primaryHri,htd,walPrimary,CONF,rss,null);
  secondaryRegion=HRegion.openHRegion(secondaryHri,htd,null,CONF,rss,null);
  reader=null;
}

</code></pre>

<pre class="type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests replaying region open markers from primary region. Checks whether the files are picked up
 */
@Test public void testReplayBulkLoadEvent() throws IOException {
  LOG.info("testReplayBulkLoadEvent starts");
  putDataWithFlushes(primaryRegion,100,0,100);
  primaryRegion.close();
  primaryRegion=HRegion.openHRegion(rootDir,primaryHri,htd,walPrimary,CONF,rss,null);
  Random random=new Random();
  byte[] randomValues=new byte[20];
  random.nextBytes(randomValues);
  Path testPath=TEST_UTIL.getDataTestDirOnTestFS();
  List<Pair<byte[],String>> familyPaths=new ArrayList<Pair<byte[],String>>();
  int expectedLoadFileCount=0;
  for (  byte[] family : families) {
    familyPaths.add(new Pair<byte[],String>(family,createHFileForFamilies(testPath,family,randomValues)));
    expectedLoadFileCount++;
  }
  primaryRegion.bulkLoadHFiles(familyPaths,false,null);
  reader=createWALReaderForPrimary();
  LOG.info("-- Replaying edits and region events in secondary");
  BulkLoadDescriptor bulkloadEvent=null;
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    bulkloadEvent=WALEdit.getBulkLoadDescriptor(entry.getEdit().getCells().get(0));
    if (bulkloadEvent != null) {
      break;
    }
  }
  assertTrue(bulkloadEvent != null);
  assertEquals(expectedLoadFileCount,bulkloadEvent.getStoresCount());
  secondaryRegion.replayWALBulkLoadEventMarker(bulkloadEvent);
  List<String> storeFileName=new ArrayList<String>();
  for (  StoreDescriptor storeDesc : bulkloadEvent.getStoresList()) {
    storeFileName.addAll(storeDesc.getStoreFileList());
  }
  for (  Store s : secondaryRegion.getStores()) {
    for (    StoreFile sf : s.getStorefiles()) {
      storeFileName.remove(sf.getPath().getName());
    }
  }
  assertTrue("Found some store file isn't loaded:" + storeFileName,storeFileName.isEmpty());
  LOG.info("-- Verifying edits from secondary");
  for (  byte[] family : families) {
    assertGet(secondaryRegion,family,randomValues);
  }
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Tests that a region opened in secondary mode would not write region open / close
 * events to its WAL.
 * @throws IOException
 */
@Test public void testSecondaryRegionDoesNotWriteRegionEventsToWAL() throws IOException {
  secondaryRegion.close();
  walSecondary=spy(walSecondary);
  secondaryRegion=HRegion.openHRegion(secondaryHri,htd,walSecondary,CONF,rss,null);
  verify(walSecondary,times(0)).append((HTableDescriptor)any(),(HRegionInfo)any(),(WALKey)any(),(WALEdit)any(),anyBoolean());
  putDataByReplay(secondaryRegion,0,10,cq,families);
  secondaryRegion.replayWALFlushStartMarker(FlushDescriptor.newBuilder().setFlushSequenceNumber(10).setTableName(ByteString.copyFrom(primaryRegion.getTableDesc().getTableName().getName())).setAction(FlushAction.START_FLUSH).setEncodedRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getEncodedNameAsBytes())).setRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getRegionName())).build());
  verify(walSecondary,times(0)).append((HTableDescriptor)any(),(HRegionInfo)any(),(WALKey)any(),(WALEdit)any(),anyBoolean());
  secondaryRegion.close();
  verify(walSecondary,times(0)).append((HTableDescriptor)any(),(HRegionInfo)any(),(WALKey)any(),(WALEdit)any(),anyBoolean());
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testReplayingBulkLoadEventWithFileAlreadyDeleted() throws IOException {
  secondaryRegion.replayWALBulkLoadEventMarker(BulkLoadDescriptor.newBuilder().setTableName(ProtobufUtil.toProtoTableName(primaryRegion.getTableDesc().getTableName())).setEncodedRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getEncodedNameAsBytes())).setBulkloadSeqNum(Long.MAX_VALUE).addStores(StoreDescriptor.newBuilder().setFamilyName(ByteString.copyFrom(families[0])).setStoreHomeDir("/store_home_dir").addStoreFile("/foo").build()).build());
}

</code></pre>

<pre class="type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests the case where a request for flush cache is sent to the region, but region cannot flush.
 * It should write the flush request marker instead.
 */
@Test public void testWriteFlushRequestMarker() throws IOException {
  FlushResultImpl result=(FlushResultImpl)((HRegion)primaryRegion).flushcache(true,false);
  assertNotNull(result);
  assertEquals(result.result,FlushResultImpl.Result.CANNOT_FLUSH_MEMSTORE_EMPTY);
  assertFalse(result.wroteFlushWalMarker);
  result=(FlushResultImpl)((HRegion)primaryRegion).flushcache(true,true);
  assertNotNull(result);
  assertEquals(result.result,FlushResultImpl.Result.CANNOT_FLUSH_MEMSTORE_EMPTY);
  assertTrue(result.wroteFlushWalMarker);
  List<FlushDescriptor> flushes=Lists.newArrayList();
  reader=createWALReaderForPrimary();
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flush=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flush != null) {
      flushes.add(flush);
    }
  }
  assertEquals(1,flushes.size());
  assertNotNull(flushes.get(0));
  assertEquals(FlushDescriptor.FlushAction.CANNOT_FLUSH,flushes.get(0).getAction());
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Tests the case where we receive a flush commit before receiving any flush prepare markers.
 * The memstore edits should be not dropped after the flush commit replay since not every edit
 * will be in flushed files (based on seqId)
 */
@Test public void testReplayFlushCommitMarkerWithoutFlushStartMarkerNonDroppableMemstore() throws IOException {
  testReplayFlushCommitMarkerWithoutFlushStartMarker(false);
}

</code></pre>

<pre class="type-4 type-9 type-10 type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests the case where we prepare a flush with some seqId and we receive a flush commit marker
 * larger than the previous flush start marker.
 */
@Test public void testReplayFlushCommitMarkerLargerThanFlushStartMarker() throws IOException {
  putDataWithFlushes(primaryRegion,100,100,100);
  int numRows=200;
  reader=createWALReaderForPrimary();
  LOG.info("-- Replaying edits and flush events in secondary");
  FlushDescriptor startFlushDesc=null;
  FlushDescriptor commitFlushDesc=null;
  int lastReplayed=0;
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        if (startFlushDesc == null) {
          LOG.info("-- Replaying flush start in secondary");
          startFlushDesc=flushDesc;
          PrepareFlushResult result=secondaryRegion.replayWALFlushStartMarker(startFlushDesc);
          assertNull(result.result);
        }
      }
 else       if (flushDesc.getAction() == FlushAction.COMMIT_FLUSH) {
        commitFlushDesc=FlushDescriptor.newBuilder(flushDesc).setFlushSequenceNumber(flushDesc.getFlushSequenceNumber() + 50).build();
      }
      verifyData(secondaryRegion,0,lastReplayed + 1,cq,families);
    }
 else {
      lastReplayed=replayEdit(secondaryRegion,entry);
    }
  }
  verifyData(secondaryRegion,0,numRows,cq,families);
  int expectedStoreFileCount=0;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  long regionMemstoreSize=secondaryRegion.getMemstoreSize();
  LOG.info("Testing replaying flush COMMIT " + commitFlushDesc + " on top of flush START"+ startFlushDesc);
  assertTrue(commitFlushDesc.getFlushSequenceNumber() > startFlushDesc.getFlushSequenceNumber());
  LOG.info("-- Replaying flush commit in secondary" + commitFlushDesc);
  secondaryRegion.replayWALFlushCommitMarker(commitFlushDesc);
  expectedStoreFileCount++;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  Store store=secondaryRegion.getStore(Bytes.toBytes("cf1"));
  long newFlushableSize=store.getFlushableSize();
  assertTrue(newFlushableSize > 0);
  long newRegionMemstoreSize=secondaryRegion.getMemstoreSize();
  assertTrue(newRegionMemstoreSize > 0);
  assertTrue(regionMemstoreSize > newRegionMemstoreSize);
  assertNull(secondaryRegion.getPrepareFlushResult());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from primary.");
  verifyData(primaryRegion,0,numRows,cq,families);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Test the case where the secondary region replica is not in reads enabled state because it is
 * waiting for a flush or region open marker from primary region. Replaying flush start and commit
 * entries should restore the reads enabled status in the region and allow the reads
 * to continue.
 */
@Test public void testReplayingFlushWithEmptyMemstoreRestoresReadsEnabledState() throws IOException {
  disableReads(secondaryRegion);
  putData(primaryRegion,Durability.SYNC_WAL,0,100,cq,families);
  primaryRegion.flush(true);
  reader=createWALReaderForPrimary();
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flush=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flush != null) {
      secondaryRegion.replayWALFlushMarker(flush,entry.getKey().getLogSeqNum());
    }
  }
  verifyData(secondaryRegion,0,100,cq,families);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testReplayingRegionOpenEventWithFileAlreadyDeleted() throws IOException {
  secondaryRegion.replayWALRegionEventMarker(RegionEventDescriptor.newBuilder().setTableName(ByteString.copyFrom(primaryRegion.getTableDesc().getTableName().getName())).setEncodedRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getEncodedNameAsBytes())).setRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getRegionName())).setEventType(EventType.REGION_OPEN).setServer(ProtobufUtil.toServerName(ServerName.valueOf("foo",1,1))).setLogSequenceNumber(Long.MAX_VALUE).addStores(StoreDescriptor.newBuilder().setFamilyName(ByteString.copyFrom(families[0])).setStoreHomeDir("/store_home_dir").addStoreFile("/foo").build()).build());
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Test the case where the secondary region replica is not in reads enabled state because it is
 * waiting for a flush or region open marker from primary region. Replaying region open event
 * entry from primary should restore the reads enabled status in the region and allow the reads
 * to continue.
 */
@Test public void testReplayingRegionOpenEventRestoresReadsEnabledState() throws IOException {
  disableReads(secondaryRegion);
  primaryRegion.close();
  primaryRegion=HRegion.openHRegion(rootDir,primaryHri,htd,walPrimary,CONF,rss,null);
  reader=createWALReaderForPrimary();
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    RegionEventDescriptor regionEventDesc=WALEdit.getRegionEventDescriptor(entry.getEdit().getCells().get(0));
    if (regionEventDesc != null) {
      secondaryRegion.replayWALRegionEventMarker(regionEventDesc);
    }
  }
  secondaryRegion.get(new Get(Bytes.toBytes(0)));
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testReplayingFlushCommitWithFileAlreadyDeleted() throws IOException {
  secondaryRegion.replayWALFlushCommitMarker(FlushDescriptor.newBuilder().setFlushSequenceNumber(Long.MAX_VALUE).setTableName(ByteString.copyFrom(primaryRegion.getTableDesc().getTableName().getName())).setAction(FlushAction.COMMIT_FLUSH).setEncodedRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getEncodedNameAsBytes())).setRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getRegionName())).addStoreFlushes(StoreFlushDescriptor.newBuilder().setFamilyName(ByteString.copyFrom(families[0])).setStoreHomeDir("/store_home_dir").addFlushOutput("/foo/baz/bar").build()).build());
}

</code></pre>

<pre class="type-4 type-9 type-10 type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests cases where we prepare a flush with some seqId and we receive other flush start markers
 * equal to, greater or less than the previous flush start marker.
 */
@Test public void testReplayFlushStartMarkers() throws IOException {
  putDataWithFlushes(primaryRegion,100,100,100);
  int numRows=200;
  reader=createWALReaderForPrimary();
  LOG.info("-- Replaying edits and flush events in secondary");
  FlushDescriptor startFlushDesc=null;
  int lastReplayed=0;
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      Store store=secondaryRegion.getStore(Bytes.toBytes("cf1"));
      long storeMemstoreSize=store.getMemStoreSize();
      long regionMemstoreSize=secondaryRegion.getMemstoreSize();
      long storeFlushableSize=store.getFlushableSize();
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        startFlushDesc=flushDesc;
        LOG.info("-- Replaying flush start in secondary");
        PrepareFlushResult result=secondaryRegion.replayWALFlushStartMarker(startFlushDesc);
        assertNull(result.result);
        assertEquals(result.flushOpSeqId,startFlushDesc.getFlushSequenceNumber());
        assertTrue(regionMemstoreSize > 0);
        assertTrue(storeFlushableSize > 0);
        long newStoreMemstoreSize=store.getMemStoreSize();
        LOG.info("Memstore size reduced by:" + StringUtils.humanReadableInt(newStoreMemstoreSize - storeMemstoreSize));
        assertTrue(storeMemstoreSize > newStoreMemstoreSize);
        verifyData(secondaryRegion,0,lastReplayed + 1,cq,families);
      }
      verifyData(secondaryRegion,0,lastReplayed + 1,cq,families);
    }
 else {
      lastReplayed=replayEdit(secondaryRegion,entry);
    }
  }
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Replaying same flush start in secondary again");
  PrepareFlushResult result=secondaryRegion.replayWALFlushStartMarker(startFlushDesc);
  assertNull(result);
  assertNotNull(secondaryRegion.getPrepareFlushResult());
  assertEquals(secondaryRegion.getPrepareFlushResult().flushOpSeqId,startFlushDesc.getFlushSequenceNumber());
  assertTrue(secondaryRegion.getMemstoreSize() > 0);
  verifyData(secondaryRegion,0,numRows,cq,families);
  FlushDescriptor startFlushDescSmallerSeqId=clone(startFlushDesc,startFlushDesc.getFlushSequenceNumber() - 50);
  LOG.info("-- Replaying same flush start in secondary again " + startFlushDescSmallerSeqId);
  result=secondaryRegion.replayWALFlushStartMarker(startFlushDescSmallerSeqId);
  assertNull(result);
  assertNotNull(secondaryRegion.getPrepareFlushResult());
  assertEquals(secondaryRegion.getPrepareFlushResult().flushOpSeqId,startFlushDesc.getFlushSequenceNumber());
  assertTrue(secondaryRegion.getMemstoreSize() > 0);
  verifyData(secondaryRegion,0,numRows,cq,families);
  FlushDescriptor startFlushDescLargerSeqId=clone(startFlushDesc,startFlushDesc.getFlushSequenceNumber() + 50);
  LOG.info("-- Replaying same flush start in secondary again " + startFlushDescLargerSeqId);
  result=secondaryRegion.replayWALFlushStartMarker(startFlushDescLargerSeqId);
  assertNull(result);
  assertNotNull(secondaryRegion.getPrepareFlushResult());
  assertEquals(secondaryRegion.getPrepareFlushResult().flushOpSeqId,startFlushDesc.getFlushSequenceNumber());
  assertTrue(secondaryRegion.getMemstoreSize() > 0);
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from primary.");
  verifyData(primaryRegion,0,numRows,cq,families);
}

</code></pre>

<pre class="type-11 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
/** 
 * Tests the reads enabled flag for the region. When unset all reads should be rejected
 */
@Test public void testRegionReadsEnabledFlag() throws IOException {
  putDataByReplay(secondaryRegion,0,100,cq,families);
  verifyData(secondaryRegion,0,100,cq,families);
  secondaryRegion.setReadsEnabled(false);
  try {
    verifyData(secondaryRegion,0,100,cq,families);
    fail("Should have failed with IOException");
  }
 catch (  IOException ex) {
  }
  putDataByReplay(secondaryRegion,100,100,cq,families);
  secondaryRegion.setReadsEnabled(true);
  verifyData(secondaryRegion,0,200,cq,families);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Test the case where the secondary region replica is not in reads enabled state because it is
 * waiting for a flush or region open marker from primary region. Replaying flush start and commit
 * entries should restore the reads enabled status in the region and allow the reads
 * to continue.
 */
@Test public void testReplayingFlushRestoresReadsEnabledState() throws IOException {
  disableReads(secondaryRegion);
  putData(primaryRegion,Durability.SYNC_WAL,0,100,cq,families);
  primaryRegion.flush(true);
  putData(primaryRegion,Durability.SYNC_WAL,0,100,cq,families);
  reader=createWALReaderForPrimary();
  while (true) {
    WAL.Entry entry=reader.next();
    LOG.info(entry);
    if (entry == null) {
      break;
    }
    FlushDescriptor flush=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flush != null) {
      secondaryRegion.replayWALFlushMarker(flush,entry.getKey().getLogSeqNum());
    }
 else {
      replayEdit(secondaryRegion,entry);
    }
  }
  verifyData(secondaryRegion,0,100,cq,families);
}

</code></pre>

<pre class="type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests a case where we replay only a flush start marker, then the region is closed. This region
 * should not block indefinitely
 */
@Test(timeout=60000) public void testOnlyReplayingFlushStartDoesNotHoldUpRegionClose() throws IOException {
  int start=0;
  LOG.info("-- Writing some data to primary from " + start + " to "+ (start + 100));
  putData(primaryRegion,Durability.SYNC_WAL,start,100,cq,families);
  LOG.info("-- Flushing primary, creating 3 files for 3 stores");
  primaryRegion.flush(true);
  reader=createWALReaderForPrimary();
  LOG.info("-- Replaying edits and flush events in secondary");
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        LOG.info("-- Replaying flush start in secondary");
        secondaryRegion.replayWALFlushStartMarker(flushDesc);
      }
 else       if (flushDesc.getAction() == FlushAction.COMMIT_FLUSH) {
        LOG.info("-- NOT Replaying flush commit in secondary");
      }
    }
 else {
      replayEdit(secondaryRegion,entry);
    }
  }
  assertTrue(rss.getRegionServerAccounting().getGlobalMemstoreSize() > 0);
  secondaryRegion.close();
  assertEquals(0,rss.getRegionServerAccounting().getGlobalMemstoreSize());
}

</code></pre>

<pre class="type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests the case where we replay a region open event after a flush start but before receiving
 * flush commit
 */
@Test public void testReplayRegionOpenEventAfterFlushStart() throws IOException {
  putDataWithFlushes(primaryRegion,100,100,100);
  int numRows=200;
  primaryRegion.close();
  primaryRegion=HRegion.openHRegion(rootDir,primaryHri,htd,walPrimary,CONF,rss,null);
  reader=createWALReaderForPrimary();
  List<RegionEventDescriptor> regionEvents=Lists.newArrayList();
  LOG.info("-- Replaying edits and region events in secondary");
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    RegionEventDescriptor regionEventDesc=WALEdit.getRegionEventDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        secondaryRegion.replayWALFlushStartMarker(flushDesc);
      }
    }
 else     if (regionEventDesc != null) {
      regionEvents.add(regionEventDesc);
    }
 else {
      replayEdit(secondaryRegion,entry);
    }
  }
  verifyData(secondaryRegion,0,numRows,cq,families);
  assertEquals(3,regionEvents.size());
  int expectedStoreFileCount=0;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  LOG.info("Testing replaying region open event " + regionEvents.get(2));
  secondaryRegion.replayWALRegionEventMarker(regionEvents.get(2));
  expectedStoreFileCount=2;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  Store store=secondaryRegion.getStore(Bytes.toBytes("cf1"));
  long newSnapshotSize=store.getSnapshotSize();
  assertTrue(newSnapshotSize == 0);
  long newRegionMemstoreSize=secondaryRegion.getMemstoreSize();
  assertTrue(newRegionMemstoreSize == 0);
  assertNull(secondaryRegion.getPrepareFlushResult());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from primary.");
  verifyData(primaryRegion,0,numRows,cq,families);
}

</code></pre>

<pre class="type-4 type-9 type-10 type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testReplayFlushesAndCompactions() throws IOException {
  putDataWithFlushes(primaryRegion,100,300,100);
  LOG.info("-- Compacting primary, only 1 store");
  primaryRegion.compactStore(Bytes.toBytes("cf1"),NoLimitThroughputController.INSTANCE);
  reader=createWALReaderForPrimary();
  LOG.info("-- Replaying edits and flush events in secondary");
  int lastReplayed=0;
  int expectedStoreFileCount=0;
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    CompactionDescriptor compactionDesc=WALEdit.getCompaction(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      verifyData(secondaryRegion,0,lastReplayed,cq,families);
      Store store=secondaryRegion.getStore(Bytes.toBytes("cf1"));
      long storeMemstoreSize=store.getMemStoreSize();
      long regionMemstoreSize=secondaryRegion.getMemstoreSize();
      long storeFlushableSize=store.getFlushableSize();
      long storeSize=store.getSize();
      long storeSizeUncompressed=store.getStoreSizeUncompressed();
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        LOG.info("-- Replaying flush start in secondary");
        PrepareFlushResult result=secondaryRegion.replayWALFlushStartMarker(flushDesc);
        assertNull(result.result);
        assertEquals(result.flushOpSeqId,flushDesc.getFlushSequenceNumber());
        long newStoreMemstoreSize=store.getMemStoreSize();
        LOG.info("Memstore size reduced by:" + StringUtils.humanReadableInt(newStoreMemstoreSize - storeMemstoreSize));
        assertTrue(storeMemstoreSize > newStoreMemstoreSize);
      }
 else       if (flushDesc.getAction() == FlushAction.COMMIT_FLUSH) {
        LOG.info("-- Replaying flush commit in secondary");
        secondaryRegion.replayWALFlushCommitMarker(flushDesc);
        expectedStoreFileCount++;
        for (        Store s : secondaryRegion.getStores()) {
          assertEquals(expectedStoreFileCount,s.getStorefilesCount());
        }
        long newFlushableSize=store.getFlushableSize();
        assertTrue(storeFlushableSize > newFlushableSize);
        long newRegionMemstoreSize=secondaryRegion.getMemstoreSize();
        assertTrue(regionMemstoreSize > newRegionMemstoreSize);
        assertTrue(store.getSize() > storeSize);
        assertTrue(store.getStoreSizeUncompressed() > storeSizeUncompressed);
        assertEquals(store.getSize(),store.getStorefilesSize());
      }
      verifyData(secondaryRegion,0,lastReplayed + 1,cq,families);
    }
 else     if (compactionDesc != null) {
      secondaryRegion.replayWALCompactionMarker(compactionDesc,true,false,Long.MAX_VALUE);
      for (      Store store : secondaryRegion.getStores()) {
        if (store.getColumnFamilyName().equals("cf1")) {
          assertEquals(1,store.getStorefilesCount());
        }
 else {
          assertEquals(expectedStoreFileCount,store.getStorefilesCount());
        }
      }
    }
 else {
      lastReplayed=replayEdit(secondaryRegion,entry);
      ;
    }
  }
  assertEquals(400 - 1,lastReplayed);
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,400,cq,families);
  LOG.info("-- Verifying edits from primary. Ensuring that files are not deleted");
  verifyData(primaryRegion,0,lastReplayed,cq,families);
  for (  Store store : primaryRegion.getStores()) {
    if (store.getColumnFamilyName().equals("cf1")) {
      assertEquals(1,store.getStorefilesCount());
    }
 else {
      assertEquals(expectedStoreFileCount,store.getStorefilesCount());
    }
  }
}

</code></pre>

<pre class="type-10 type-11 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions inside branch conditions
- Verifies (un)successful execution of the test case by reporting explicitly a failure
"></span><br>
/** 
 * Tests whether edits coming in for replay are skipped which have smaller seq id than the seqId
 * of the last replayed region open event.
 */
@Test public void testSkippingEditsWithSmallerSeqIdAfterRegionOpenEvent() throws IOException {
  putDataWithFlushes(primaryRegion,100,100,0);
  int numRows=100;
  primaryRegion.close();
  primaryRegion=HRegion.openHRegion(rootDir,primaryHri,htd,walPrimary,CONF,rss,null);
  reader=createWALReaderForPrimary();
  List<RegionEventDescriptor> regionEvents=Lists.newArrayList();
  List<WAL.Entry> edits=Lists.newArrayList();
  LOG.info("-- Replaying edits and region events in secondary");
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    RegionEventDescriptor regionEventDesc=WALEdit.getRegionEventDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
    }
 else     if (regionEventDesc != null) {
      regionEvents.add(regionEventDesc);
    }
 else {
      edits.add(entry);
    }
  }
  secondaryRegion.replayWALRegionEventMarker(RegionEventDescriptor.newBuilder(regionEvents.get(0)).setLogSequenceNumber(regionEvents.get(2).getLogSequenceNumber()).build());
  for (  WAL.Entry entry : edits) {
    replayEdit(secondaryRegion,entry);
  }
  boolean expectedFail=false;
  try {
    verifyData(secondaryRegion,0,numRows,cq,families);
  }
 catch (  AssertionError e) {
    expectedFail=true;
  }
  if (!expectedFail) {
    fail("Should have failed this verification");
  }
}

</code></pre>

<pre class="type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown() throws Exception {
  if (reader != null) {
    reader.close();
  }
  if (primaryRegion != null) {
    HBaseTestingUtility.closeRegionAndWAL(primaryRegion);
  }
  if (secondaryRegion != null) {
    HBaseTestingUtility.closeRegionAndWAL(secondaryRegion);
  }
  EnvironmentEdgeManagerTestHelper.reset();
  LOG.info("Cleaning test directory: " + TEST_UTIL.getDataTestDir());
  TEST_UTIL.cleanupTestDir();
}

</code></pre>

<pre class="type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests replaying region open markers from primary region. Checks whether the files are picked up
 */
@Test public void testReplayRegionOpenEvent() throws IOException {
  putDataWithFlushes(primaryRegion,100,0,100);
  int numRows=100;
  primaryRegion.close();
  primaryRegion=HRegion.openHRegion(rootDir,primaryHri,htd,walPrimary,CONF,rss,null);
  reader=createWALReaderForPrimary();
  List<RegionEventDescriptor> regionEvents=Lists.newArrayList();
  LOG.info("-- Replaying edits and region events in secondary");
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    RegionEventDescriptor regionEventDesc=WALEdit.getRegionEventDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
    }
 else     if (regionEventDesc != null) {
      regionEvents.add(regionEventDesc);
    }
 else {
    }
  }
  assertEquals(3,regionEvents.size());
  secondaryRegion.replayWALRegionEventMarker(regionEvents.get(0));
  secondaryRegion.replayWALRegionEventMarker(regionEvents.get(1));
  int expectedStoreFileCount=0;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  long regionMemstoreSize=secondaryRegion.getMemstoreSize();
  assertTrue(regionMemstoreSize == 0);
  LOG.info("Testing replaying region open event " + regionEvents.get(2));
  secondaryRegion.replayWALRegionEventMarker(regionEvents.get(2));
  expectedStoreFileCount++;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  Store store=secondaryRegion.getStore(Bytes.toBytes("cf1"));
  long newFlushableSize=store.getFlushableSize();
  assertTrue(newFlushableSize == 0);
  long newRegionMemstoreSize=secondaryRegion.getMemstoreSize();
  assertTrue(newRegionMemstoreSize == 0);
  assertNull(secondaryRegion.getPrepareFlushResult());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from primary.");
  verifyData(primaryRegion,0,numRows,cq,families);
}

</code></pre>

<pre class="type-9 type-10 type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions in iterations">IterativeVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies assertions in iterations
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests the case where we prepare a flush with some seqId and we receive a flush commit marker
 * less than the previous flush start marker.
 */
@Test public void testReplayFlushCommitMarkerSmallerThanFlushStartMarker() throws IOException {
  putDataWithFlushes(primaryRegion,100,200,100);
  int numRows=300;
  reader=createWALReaderForPrimary();
  LOG.info("-- Replaying edits and flush events in secondary");
  FlushDescriptor startFlushDesc=null;
  FlushDescriptor commitFlushDesc=null;
  int lastReplayed=0;
  while (true) {
    System.out.println(lastReplayed);
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flushDesc=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flushDesc != null) {
      if (flushDesc.getAction() == FlushAction.START_FLUSH) {
        if (startFlushDesc == null) {
          startFlushDesc=flushDesc;
        }
 else {
          LOG.info("-- Replaying flush start in secondary");
          startFlushDesc=flushDesc;
          PrepareFlushResult result=secondaryRegion.replayWALFlushStartMarker(startFlushDesc);
          assertNull(result.result);
        }
      }
 else       if (flushDesc.getAction() == FlushAction.COMMIT_FLUSH) {
        if (commitFlushDesc == null) {
          commitFlushDesc=flushDesc;
        }
      }
      verifyData(secondaryRegion,0,lastReplayed + 1,cq,families);
    }
 else {
      lastReplayed=replayEdit(secondaryRegion,entry);
    }
  }
  verifyData(secondaryRegion,0,numRows,cq,families);
  int expectedStoreFileCount=0;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  long regionMemstoreSize=secondaryRegion.getMemstoreSize();
  LOG.info("Testing replaying flush COMMIT " + commitFlushDesc + " on top of flush START"+ startFlushDesc);
  assertTrue(commitFlushDesc.getFlushSequenceNumber() < startFlushDesc.getFlushSequenceNumber());
  LOG.info("-- Replaying flush commit in secondary" + commitFlushDesc);
  secondaryRegion.replayWALFlushCommitMarker(commitFlushDesc);
  expectedStoreFileCount++;
  for (  Store s : secondaryRegion.getStores()) {
    assertEquals(expectedStoreFileCount,s.getStorefilesCount());
  }
  Store store=secondaryRegion.getStore(Bytes.toBytes("cf1"));
  long newFlushableSize=store.getFlushableSize();
  assertTrue(newFlushableSize > 0);
  long newRegionMemstoreSize=secondaryRegion.getMemstoreSize();
  assertEquals(regionMemstoreSize,newRegionMemstoreSize);
  assertNotNull(secondaryRegion.getPrepareFlushResult());
  LOG.info("-- Verifying edits from secondary");
  verifyData(secondaryRegion,0,numRows,cq,families);
  LOG.info("-- Verifying edits from primary.");
  verifyData(primaryRegion,0,numRows,cq,families);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
@Test public void testReplayingCompactionWithFileAlreadyDeleted() throws IOException {
  secondaryRegion.replayWALCompactionMarker(CompactionDescriptor.newBuilder().setTableName(ByteString.copyFrom(primaryRegion.getTableDesc().getTableName().getName())).setEncodedRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getEncodedNameAsBytes())).setFamilyName(ByteString.copyFrom(families[0])).addCompactionInput("/foo").addCompactionOutput("/bar").setStoreHomeDir("/store_home_dir").setRegionName(ByteString.copyFrom(primaryRegion.getRegionInfo().getRegionName())).build(),true,true,Long.MAX_VALUE);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Tests the case where we receive a flush commit before receiving any flush prepare markers.
 * The memstore edits should be dropped after the flush commit replay since they should be in
 * flushed files
 */
@Test public void testReplayFlushCommitMarkerWithoutFlushStartMarkerDroppableMemstore() throws IOException {
  testReplayFlushCommitMarkerWithoutFlushStartMarker(true);
}

</code></pre>

<pre class="type-1 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Executes methods or other tests from the same test unit">ExecutionTester</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Executes methods or other tests from the same test unit
"></span><br>
/** 
 * Test the case where the secondary region replica is not in reads enabled state because it is
 * waiting for a flush or region open marker from primary region. Replaying CANNOT_FLUSH
 * flush marker entry should restore the reads enabled status in the region and allow the reads
 * to continue.
 */
@Test public void testReplayingFlushRequestRestoresReadsEnabledState() throws IOException {
  disableReads(secondaryRegion);
  primaryRegion.flushcache(true,true);
  reader=createWALReaderForPrimary();
  while (true) {
    WAL.Entry entry=reader.next();
    if (entry == null) {
      break;
    }
    FlushDescriptor flush=WALEdit.getFlushDescriptor(entry.getEdit().getCells().get(0));
    if (flush != null) {
      secondaryRegion.replayWALFlushMarker(flush,entry.getKey().getLogSeqNum());
    }
  }
  secondaryRegion.get(new Get(Bytes.toBytes(0)));
}

</code></pre>

<pre class="type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testRegionReplicaSecondaryCannotFlush() throws IOException {
  putDataByReplay(secondaryRegion,0,1000,cq,families);
  verifyData(secondaryRegion,0,1000,cq,families);
  FlushResultImpl flush=(FlushResultImpl)secondaryRegion.flush(true);
  assertEquals(flush.result,FlushResultImpl.Result.CANNOT_FLUSH);
  verifyData(secondaryRegion,0,1000,cq,families);
  Map<byte[],List<StoreFile>> files=secondaryRegion.close(false);
  for (  List<StoreFile> f : files.values()) {
    assertTrue(f.isEmpty());
  }
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
