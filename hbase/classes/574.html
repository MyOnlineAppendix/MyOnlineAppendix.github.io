<h3 style="margin:0px">Class: org.apache.hadoop.hbase.regionserver.wal.TestWALReplay (12 methods) </h3><br><pre style="padding:0"><code class="html"><div id="tags"><button id="7"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('7')" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls"><kbd id="tag-7"class="label-info"style="display: inline-block;font-size:7pt" >InternalCallVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="6"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('6')" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes"><kbd id="tag-6"class="label-info"style="display: inline-block;font-size:7pt" >HybridVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="4"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('4')" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) "><kbd id="tag-4"class="label-info"style="display: inline-block;font-size:7pt" >APIUtilityVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="5"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('5')" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value "><kbd id="tag-5"class="label-info"style="display: inline-block;font-size:7pt" >EqualityVerifier&nbsp;(9)</kbd></button>&nbsp;<button id="8"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('8')" data-toggle="tooltip" title="Verifies boolean conditions"><kbd id="tag-8"class="label-info"style="display: inline-block;font-size:7pt" >BooleanVerifier&nbsp;(8)</kbd></button>&nbsp;<button id="3"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('3')" data-toggle="tooltip" title="Releases resources used by the test cases"><kbd id="tag-3"class="label-info"style="display: inline-block;font-size:7pt" >TestCleaner&nbsp;(2)</kbd></button>&nbsp;<button id="10"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('10')" data-toggle="tooltip" title="Verifies assertions inside branch conditions"><kbd id="tag-10"class="label-info"style="display: inline-block;font-size:7pt" >BranchVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="2"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('2')" data-toggle="tooltip" title="Allocates resources before the execution of the test cases"><kbd id="tag-2"class="label-info"style="display: inline-block;font-size:7pt" >TestInitializer&nbsp;(1)</kbd></button>&nbsp;<button id="13"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('13')" data-toggle="tooltip" title="Verifies whether objects are null"><kbd id="tag-13"class="label-info"style="display: inline-block;font-size:7pt" >NullVerifier&nbsp;(1)</kbd></button>&nbsp;<button id="11"style="border-width:0;padding:0;background:#282B2E"  onclick="filter('11')" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure"><kbd id="tag-11"class="label-info"style="display: inline-block;font-size:7pt" >UtilityVerifier&nbsp;(1)</kbd></button>&nbsp;</div></code></pre><center><button onclick="showBlocks()" style="margin:6px">Update filter <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> </button></center><br>
<pre class="type-2 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Allocates resources before the execution of the test cases">TestInitializer</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Allocates resources before the execution of the test cases
"></span><br>
@Before public void setUp() throws Exception {
  this.conf=HBaseConfiguration.create(TEST_UTIL.getConfiguration());
  this.fs=TEST_UTIL.getDFSCluster().getFileSystem();
  this.hbaseRootDir=FSUtils.getRootDir(this.conf);
  this.oldLogDir=new Path(this.hbaseRootDir,HConstants.HREGION_OLDLOGDIR_NAME);
  this.logName=DefaultWALProvider.getWALDirectoryName(currentTest.getMethodName() + "-manual");
  this.logDir=new Path(this.hbaseRootDir,logName);
  if (TEST_UTIL.getDFSCluster().getFileSystem().exists(this.hbaseRootDir)) {
    TEST_UTIL.getDFSCluster().getFileSystem().delete(this.hbaseRootDir,true);
  }
  this.mode=(conf.getBoolean(HConstants.DISTRIBUTED_LOG_REPLAY_KEY,false) ? RecoveryMode.LOG_REPLAY : RecoveryMode.LOG_SPLITTING);
  this.wals=new WALFactory(conf,null,currentTest.getMethodName());
}

</code></pre>

<pre class="type-4 type-7 type-8 type-13 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects are null">NullVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects are null
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
@Test public void testSequentialEditLogSeqNum() throws IOException {
  final TableName tableName=TableName.valueOf(currentTest.getMethodName());
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=FSUtils.getTableDir(this.hbaseRootDir,tableName);
  deleteDir(basedir);
  final byte[] rowName=tableName.getName();
  final int countPerFamily=10;
  final HTableDescriptor htd=createBasic1FamilyHTD(tableName);
  MockWAL wal=createMockWAL();
  HRegion region=HRegion.openHRegion(this.conf,this.fs,hbaseRootDir,hri,htd,wal);
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),countPerFamily,this.ee,region,"x");
  }
  region.flush(true);
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),5,this.ee,region,"x");
  }
  long lastestSeqNumber=region.getReadPoint(null);
  wal.doCompleteCacheFlush=true;
  wal.completeCacheFlush(hri.getEncodedNameAsBytes());
  wal.shutdown();
  FileStatus[] listStatus=wal.getFiles();
  assertNotNull(listStatus);
  assertTrue(listStatus.length > 0);
  WALSplitter.splitLogFile(hbaseRootDir,listStatus[0],this.fs,this.conf,null,null,null,mode,wals);
  FileStatus[] listStatus1=this.fs.listStatus(new Path(FSUtils.getTableDir(hbaseRootDir,tableName),new Path(hri.getEncodedName(),"recovered.edits")),new PathFilter(){
    @Override public boolean accept(    Path p){
      if (WALSplitter.isSequenceIdFile(p)) {
        return false;
      }
      return true;
    }
  }
);
  int editCount=0;
  for (  FileStatus fileStatus : listStatus1) {
    editCount=Integer.parseInt(fileStatus.getPath().getName());
  }
  assertEquals("The sequence number of the recoverd.edits and the current edit seq should be same",lastestSeqNumber,editCount);
}

</code></pre>

<pre class="type-4 type-10 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies assertions inside branch conditions">BranchVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies assertions inside branch conditions
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * @throws Exception
 */
@Test public void testReplayEditsAfterRegionMovedWithMultiCF() throws Exception {
  final TableName tableName=TableName.valueOf("testReplayEditsAfterRegionMovedWithMultiCF");
  byte[] family1=Bytes.toBytes("cf1");
  byte[] family2=Bytes.toBytes("cf2");
  byte[] qualifier=Bytes.toBytes("q");
  byte[] value=Bytes.toBytes("testV");
  byte[][] familys={family1,family2};
  TEST_UTIL.createTable(tableName,familys);
  Table htable=TEST_UTIL.getConnection().getTable(tableName);
  Put put=new Put(Bytes.toBytes("r1"));
  put.addColumn(family1,qualifier,value);
  htable.put(put);
  ResultScanner resultScanner=htable.getScanner(new Scan());
  int count=0;
  while (resultScanner.next() != null) {
    count++;
  }
  resultScanner.close();
  assertEquals(1,count);
  MiniHBaseCluster hbaseCluster=TEST_UTIL.getMiniHBaseCluster();
  List<HRegion> regions=hbaseCluster.getRegions(tableName);
  assertEquals(1,regions.size());
  Region destRegion=regions.get(0);
  int originServerNum=hbaseCluster.getServerWith(destRegion.getRegionInfo().getRegionName());
  assertTrue("Please start more than 1 regionserver",hbaseCluster.getRegionServerThreads().size() > 1);
  int destServerNum=0;
  while (destServerNum == originServerNum) {
    destServerNum++;
  }
  HRegionServer originServer=hbaseCluster.getRegionServer(originServerNum);
  HRegionServer destServer=hbaseCluster.getRegionServer(destServerNum);
  moveRegionAndWait(destRegion,destServer);
  Delete del=new Delete(Bytes.toBytes("r1"));
  htable.delete(del);
  resultScanner=htable.getScanner(new Scan());
  count=0;
  while (resultScanner.next() != null) {
    count++;
  }
  resultScanner.close();
  assertEquals(0,count);
  Region region=destServer.getOnlineRegion(destRegion.getRegionInfo().getRegionName());
  region.flush(true);
  for (  Store store : region.getStores()) {
    store.triggerMajorCompaction();
  }
  region.compact(true);
  moveRegionAndWait(destRegion,originServer);
  originServer.abort("testing");
  Result result=htable.get(new Get(Bytes.toBytes("r1")));
  if (result != null) {
    assertTrue("Row is deleted, but we get" + result.toString(),(result == null) || result.isEmpty());
  }
  resultScanner.close();
}

</code></pre>

<pre class="type-4 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Create an HRegion with the result of a WAL split and test we only see the
 * good edits
 * @throws Exception
 */
@Test public void testReplayEditsWrittenIntoWAL() throws Exception {
  final TableName tableName=TableName.valueOf("testReplayEditsWrittenIntoWAL");
  final MultiVersionConcurrencyControl mvcc=new MultiVersionConcurrencyControl();
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=FSUtils.getTableDir(hbaseRootDir,tableName);
  deleteDir(basedir);
  final HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  HRegion region2=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region2);
  final WAL wal=createWAL(this.conf);
  final byte[] rowName=tableName.getName();
  final byte[] regionName=hri.getEncodedNameAsBytes();
  final int countPerFamily=1000;
  Set<byte[]> familyNames=new HashSet<byte[]>();
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addWALEdits(tableName,hri,rowName,hcd.getName(),countPerFamily,ee,wal,htd,mvcc);
    familyNames.add(hcd.getName());
  }
  wal.startCacheFlush(regionName,familyNames);
  wal.completeCacheFlush(regionName);
  WALEdit edit=new WALEdit();
  long now=ee.currentTime();
  edit.add(new KeyValue(rowName,Bytes.toBytes("another family"),rowName,now,rowName));
  wal.append(htd,hri,new WALKey(hri.getEncodedNameAsBytes(),tableName,now,mvcc),edit,true);
  edit=new WALEdit();
  now=ee.currentTime();
  edit.add(new KeyValue(rowName,Bytes.toBytes("c"),null,now,KeyValue.Type.DeleteFamily));
  wal.append(htd,hri,new WALKey(hri.getEncodedNameAsBytes(),tableName,now,mvcc),edit,true);
  wal.sync();
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  User user=HBaseTestingUtility.getDifferentUser(newConf,".replay.wal.secondtime");
  user.runAs(new PrivilegedExceptionAction(){
    @Override public Object run() throws Exception {
      runWALSplit(newConf);
      FileSystem newFS=FileSystem.get(newConf);
      newConf.setInt(HConstants.HREGION_MEMSTORE_FLUSH_SIZE,1024 * 100);
      WAL newWal=createWAL(newConf);
      final AtomicInteger flushcount=new AtomicInteger(0);
      try {
        final HRegion region=new HRegion(basedir,newWal,newFS,newConf,hri,htd,null){
          @Override protected FlushResult internalFlushcache(          final WAL wal,          final long myseqid,          final Collection<Store> storesToFlush,          MonitoredTask status,          boolean writeFlushWalMarker) throws IOException {
            LOG.info("InternalFlushCache Invoked");
            FlushResult fs=super.internalFlushcache(wal,myseqid,storesToFlush,Mockito.mock(MonitoredTask.class),writeFlushWalMarker);
            flushcount.incrementAndGet();
            return fs;
          }
        }
;
        long seqid=region.initialize();
        long writePoint=mvcc.getWritePoint();
        assertTrue("Flushcount=" + flushcount.get(),flushcount.get() > 0);
        assertTrue((seqid - 1) == writePoint);
        Get get=new Get(rowName);
        Result result=region.get(get);
        assertEquals(countPerFamily * (htd.getFamilies().size() - 1),result.size());
        region.close();
      }
  finally {
        newWal.close();
      }
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-4 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test case of HRegion that is only made out of bulk loaded files.  Assert
 * that we don't 'crash'.
 * @throws IOException
 * @throws IllegalAccessException
 * @throws NoSuchFieldException
 * @throws IllegalArgumentException
 * @throws SecurityException
 */
@Test public void testRegionMadeOfBulkLoadedFilesOnly() throws IOException, SecurityException, IllegalArgumentException, NoSuchFieldException, IllegalAccessException, InterruptedException {
  final TableName tableName=TableName.valueOf("testRegionMadeOfBulkLoadedFilesOnly");
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=new Path(this.hbaseRootDir,tableName.getNameAsString());
  deleteDir(basedir);
  final HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  Region region2=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region2);
  WAL wal=createWAL(this.conf);
  Region region=HRegion.openHRegion(hri,htd,wal,this.conf);
  byte[] family=htd.getFamilies().iterator().next().getName();
  Path f=new Path(basedir,"hfile");
  HFileTestUtil.createHFile(this.conf,fs,f,family,family,Bytes.toBytes(""),Bytes.toBytes("z"),10);
  List<Pair<byte[],String>> hfs=new ArrayList<Pair<byte[],String>>(1);
  hfs.add(Pair.newPair(family,f.toString()));
  region.bulkLoadHFiles(hfs,true,null);
  byte[] row=tableName.getName();
  region.put((new Put(row)).addColumn(family,family,family));
  wal.sync();
  final int rowsInsertedCount=11;
  assertEquals(rowsInsertedCount,getScannedCount(region.getScanner(new Scan())));
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  User user=HBaseTestingUtility.getDifferentUser(newConf,tableName.getNameAsString());
  user.runAs(new PrivilegedExceptionAction(){
    @Override public Object run() throws Exception {
      runWALSplit(newConf);
      WAL wal2=createWAL(newConf);
      HRegion region2=HRegion.openHRegion(newConf,FileSystem.get(newConf),hbaseRootDir,hri,htd,wal2);
      long seqid2=region2.getOpenSeqNum();
      assertTrue(seqid2 > -1);
      assertEquals(rowsInsertedCount,getScannedCount(region2.getScanner(new Scan())));
      region2.close();
      wal2.close();
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-4 type-11 type-7 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies (un)successful execution of the test case by reporting explicitly a failure">UtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies (un)successful execution of the test case by reporting explicitly a failure
- Verifies values of objects/variables related to AUT calls
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test that we could recover the data correctly after aborting flush. In the
 * test, first we abort flush after writing some data, then writing more data
 * and flush again, at last verify the data.
 * @throws IOException
 */
@Test public void testReplayEditsAfterAbortingFlush() throws IOException {
  final TableName tableName=TableName.valueOf("testReplayEditsAfterAbortingFlush");
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=FSUtils.getTableDir(this.hbaseRootDir,tableName);
  deleteDir(basedir);
  final HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  HRegion region3=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region3);
  WAL wal=createWAL(this.conf);
  RegionServerServices rsServices=Mockito.mock(RegionServerServices.class);
  Mockito.doReturn(false).when(rsServices).isAborted();
  when(rsServices.getServerName()).thenReturn(ServerName.valueOf("foo",10,10));
  Configuration customConf=new Configuration(this.conf);
  customConf.set(DefaultStoreEngine.DEFAULT_STORE_FLUSHER_CLASS_KEY,CustomStoreFlusher.class.getName());
  HRegion region=HRegion.openHRegion(this.hbaseRootDir,hri,htd,wal,customConf,rsServices,null);
  int writtenRowCount=10;
  List<HColumnDescriptor> families=new ArrayList<HColumnDescriptor>(htd.getFamilies());
  for (int i=0; i < writtenRowCount; i++) {
    Put put=new Put(Bytes.toBytes(tableName + Integer.toString(i)));
    put.addColumn(families.get(i % families.size()).getName(),Bytes.toBytes("q"),Bytes.toBytes("val"));
    region.put(put);
  }
  RegionScanner scanner=region.getScanner(new Scan());
  assertEquals(writtenRowCount,getScannedCount(scanner));
  CustomStoreFlusher.throwExceptionWhenFlushing.set(true);
  try {
    region.flush(true);
    fail("Injected exception hasn't been thrown");
  }
 catch (  Throwable t) {
    LOG.info("Expected simulated exception when flushing region," + t.getMessage());
    Mockito.doReturn(true).when(rsServices).isAborted();
    region.setClosing(false);
  }
  int moreRow=10;
  for (int i=writtenRowCount; i < writtenRowCount + moreRow; i++) {
    Put put=new Put(Bytes.toBytes(tableName + Integer.toString(i)));
    put.addColumn(families.get(i % families.size()).getName(),Bytes.toBytes("q"),Bytes.toBytes("val"));
    region.put(put);
  }
  writtenRowCount+=moreRow;
  CustomStoreFlusher.throwExceptionWhenFlushing.set(false);
  try {
    region.flush(true);
  }
 catch (  IOException t) {
    LOG.info("Expected exception when flushing region because server is stopped," + t.getMessage());
  }
  region.close(true);
  wal.shutdown();
  runWALSplit(this.conf);
  WAL wal2=createWAL(this.conf);
  Mockito.doReturn(false).when(rsServices).isAborted();
  HRegion region2=HRegion.openHRegion(this.hbaseRootDir,hri,htd,wal2,this.conf,rsServices,null);
  scanner=region2.getScanner(new Scan());
  assertEquals(writtenRowCount,getScannedCount(scanner));
}

</code></pre>

<pre class="type-4 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test that we recover correctly when there is a failure in between the
 * flushes. i.e. Some stores got flushed but others did not.
 * Unfortunately, there is no easy hook to flush at a store level. The way
 * we get around this is by flushing at the region level, and then deleting
 * the recently flushed store file for one of the Stores. This would put us
 * back in the situation where all but that store got flushed and the region
 * died.
 * We restart Region again, and verify that the edits were replayed.
 * @throws IOException
 * @throws IllegalAccessException
 * @throws NoSuchFieldException
 * @throws IllegalArgumentException
 * @throws SecurityException
 */
@Test public void testReplayEditsAfterPartialFlush() throws IOException, SecurityException, IllegalArgumentException, NoSuchFieldException, IllegalAccessException, InterruptedException {
  final TableName tableName=TableName.valueOf("testReplayEditsWrittenViaHRegion");
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=FSUtils.getTableDir(this.hbaseRootDir,tableName);
  deleteDir(basedir);
  final byte[] rowName=tableName.getName();
  final int countPerFamily=10;
  final HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  HRegion region3=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region3);
  WAL wal=createWAL(this.conf);
  HRegion region=HRegion.openHRegion(this.conf,this.fs,hbaseRootDir,hri,htd,wal);
  long seqid=region.getOpenSeqNum();
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),countPerFamily,this.ee,region,"x");
  }
  final Get g=new Get(rowName);
  Result result=region.get(g);
  assertEquals(countPerFamily * htd.getFamilies().size(),result.size());
  region.flush(true);
  region.close(true);
  wal.shutdown();
  int cf_count=0;
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    cf_count++;
    if (cf_count == 2) {
      region.getRegionFileSystem().deleteFamily(hcd.getNameAsString());
    }
  }
  runWALSplit(this.conf);
  WAL wal2=createWAL(this.conf);
  HRegion region2=HRegion.openHRegion(this.conf,this.fs,hbaseRootDir,hri,htd,wal2);
  long seqid2=region2.getOpenSeqNum();
  assertTrue(seqid + result.size() < seqid2);
  final Result result1b=region2.get(g);
  assertEquals(result.size(),result1b.size());
}

</code></pre>

<pre class="type-4 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Tests for hbase-2727.
 * @throws Exception
 * @see <a href="https://issues.apache.org/jira/browse/HBASE-2727">HBASE-2727</a>
 */
@Test public void test2727() throws Exception {
  final TableName tableName=TableName.valueOf("test2727");
  MultiVersionConcurrencyControl mvcc=new MultiVersionConcurrencyControl();
  HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  Path basedir=FSUtils.getTableDir(hbaseRootDir,tableName);
  deleteDir(basedir);
  HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  Region region2=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region2);
  final byte[] rowName=tableName.getName();
  WAL wal1=createWAL(this.conf);
  final int countPerFamily=1000;
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addWALEdits(tableName,hri,rowName,hcd.getName(),countPerFamily,ee,wal1,htd,mvcc);
  }
  wal1.shutdown();
  runWALSplit(this.conf);
  WAL wal2=createWAL(this.conf);
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addWALEdits(tableName,hri,rowName,hcd.getName(),countPerFamily,ee,wal2,htd,mvcc);
  }
  wal2.shutdown();
  runWALSplit(this.conf);
  WAL wal3=createWAL(this.conf);
  try {
    HRegion region=HRegion.openHRegion(this.conf,this.fs,hbaseRootDir,hri,htd,wal3);
    long seqid=region.getOpenSeqNum();
    assertTrue(seqid > mvcc.getWritePoint());
    assertEquals(seqid - 1,mvcc.getWritePoint());
    LOG.debug("region.getOpenSeqNum(): " + region.getOpenSeqNum() + ", wal3.id: "+ mvcc.getReadPoint());
    region.close();
  }
  finally {
    wal3.close();
  }
}

</code></pre>

<pre class="type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@AfterClass public static void tearDownAfterClass() throws Exception {
  TEST_UTIL.shutdownMiniCluster();
}

</code></pre>

<pre class="type-3 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Releases resources used by the test cases">TestCleaner</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Releases resources used by the test cases
"></span><br>
@After public void tearDown() throws Exception {
  this.wals.close();
  TEST_UTIL.getDFSCluster().getFileSystem().delete(this.hbaseRootDir,true);
}

</code></pre>

<pre class="type-4 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * Test writing edits into an HRegion, closing it, splitting logs, opening
 * Region again.  Verify seqids.
 * @throws IOException
 * @throws IllegalAccessException
 * @throws NoSuchFieldException
 * @throws IllegalArgumentException
 * @throws SecurityException
 */
@Test public void testReplayEditsWrittenViaHRegion() throws IOException, SecurityException, IllegalArgumentException, NoSuchFieldException, IllegalAccessException, InterruptedException {
  final TableName tableName=TableName.valueOf("testReplayEditsWrittenViaHRegion");
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=FSUtils.getTableDir(this.hbaseRootDir,tableName);
  deleteDir(basedir);
  final byte[] rowName=tableName.getName();
  final int countPerFamily=10;
  final HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  HRegion region3=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region3);
  WAL wal=createWAL(this.conf);
  HRegion region=HRegion.openHRegion(this.conf,this.fs,hbaseRootDir,hri,htd,wal);
  long seqid=region.getOpenSeqNum();
  boolean first=true;
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),countPerFamily,this.ee,region,"x");
    if (first) {
      region.flush(true);
      first=false;
    }
  }
  final Get g=new Get(rowName);
  Result result=region.get(g);
  assertEquals(countPerFamily * htd.getFamilies().size(),result.size());
  region.close(true);
  wal.shutdown();
  runWALSplit(this.conf);
  WAL wal2=createWAL(this.conf);
  HRegion region2=HRegion.openHRegion(conf,this.fs,hbaseRootDir,hri,htd,wal2);
  long seqid2=region2.getOpenSeqNum();
  assertTrue(seqid + result.size() < seqid2);
  final Result result1b=region2.get(g);
  assertEquals(result.size(),result1b.size());
  for (  HColumnDescriptor hcd : htd.getFamilies()) {
    addRegionEdits(rowName,hcd.getName(),countPerFamily,this.ee,region2,"y");
  }
  final Result result2=region2.get(g);
  assertEquals(2 * result.size(),result2.size());
  wal2.sync();
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  User user=HBaseTestingUtility.getDifferentUser(newConf,tableName.getNameAsString());
  user.runAs(new PrivilegedExceptionAction(){
    @Override public Object run() throws Exception {
      runWALSplit(newConf);
      FileSystem newFS=FileSystem.get(newConf);
      WAL wal3=createWAL(newConf);
      final AtomicInteger countOfRestoredEdits=new AtomicInteger(0);
      HRegion region3=new HRegion(basedir,wal3,newFS,newConf,hri,htd,null){
        @Override protected boolean restoreEdit(        Store s,        Cell cell){
          boolean b=super.restoreEdit(s,cell);
          countOfRestoredEdits.incrementAndGet();
          return b;
        }
      }
;
      long seqid3=region3.initialize();
      Result result3=region3.get(g);
      assertEquals(result2.size(),result3.size());
      assertEquals(htd.getFamilies().size() * countPerFamily,countOfRestoredEdits.get());
      region3.close();
      wal3.close();
      return null;
    }
  }
);
}

</code></pre>

<pre class="type-4 type-7 type-8 type-5 type-6 "><code><span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to API calls (Java or TPL) ">APIUtilityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies values of objects/variables related to AUT calls">InternalCallVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies boolean conditions">BooleanVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Verifies whether objects/variable are equal to an expected value ">EqualityVerifier</span>&nbsp;<span class="label label-info" style="display: inline-block;" data-toggle="tooltip" title="Contains more than 2 JUnit-based stereotypes">HybridVerifier</span>&nbsp;<span class=" glyphicon glyphicon-comment" aria-hidden="true" label-info" data-toggle="tooltip" title="This method/test case: 
- Verifies values of objects/variables related to API calls (Java or TPL) 
- Verifies values of objects/variables related to AUT calls
- Verifies boolean conditions
- Verifies whether objects/variable are equal to an expected value 
- Contains more than 2 JUnit-based stereotypes
"></span><br>
/** 
 * HRegion test case that is made of a major compacted HFile (created with three bulk loaded
 * files) and an edit in the memstore.
 * This is for HBASE-10958 "[dataloss] Bulk loading with seqids can prevent some log entries
 * from being replayed"
 * @throws IOException
 * @throws IllegalAccessException
 * @throws NoSuchFieldException
 * @throws IllegalArgumentException
 * @throws SecurityException
 */
@Test public void testCompactedBulkLoadedFiles() throws IOException, SecurityException, IllegalArgumentException, NoSuchFieldException, IllegalAccessException, InterruptedException {
  final TableName tableName=TableName.valueOf("testCompactedBulkLoadedFiles");
  final HRegionInfo hri=createBasic3FamilyHRegionInfo(tableName);
  final Path basedir=new Path(this.hbaseRootDir,tableName.getNameAsString());
  deleteDir(basedir);
  final HTableDescriptor htd=createBasic3FamilyHTD(tableName);
  HRegion region2=HBaseTestingUtility.createRegionAndWAL(hri,hbaseRootDir,this.conf,htd);
  HBaseTestingUtility.closeRegionAndWAL(region2);
  WAL wal=createWAL(this.conf);
  HRegion region=HRegion.openHRegion(hri,htd,wal,this.conf);
  byte[] row=tableName.getName();
  byte[] family=htd.getFamilies().iterator().next().getName();
  region.put((new Put(row)).addColumn(family,family,family));
  wal.sync();
  List<Pair<byte[],String>> hfs=new ArrayList<Pair<byte[],String>>(1);
  for (int i=0; i < 3; i++) {
    Path f=new Path(basedir,"hfile" + i);
    HFileTestUtil.createHFile(this.conf,fs,f,family,family,Bytes.toBytes(i + "00"),Bytes.toBytes(i + "50"),10);
    hfs.add(Pair.newPair(family,f.toString()));
  }
  region.bulkLoadHFiles(hfs,true,null);
  final int rowsInsertedCount=31;
  assertEquals(rowsInsertedCount,getScannedCount(region.getScanner(new Scan())));
  region.compact(true);
  assertEquals(rowsInsertedCount,getScannedCount(region.getScanner(new Scan())));
  final Configuration newConf=HBaseConfiguration.create(this.conf);
  User user=HBaseTestingUtility.getDifferentUser(newConf,tableName.getNameAsString());
  user.runAs(new PrivilegedExceptionAction(){
    @Override public Object run() throws Exception {
      runWALSplit(newConf);
      WAL wal2=createWAL(newConf);
      HRegion region2=HRegion.openHRegion(newConf,FileSystem.get(newConf),hbaseRootDir,hri,htd,wal2);
      long seqid2=region2.getOpenSeqNum();
      assertTrue(seqid2 > -1);
      assertEquals(rowsInsertedCount,getScannedCount(region2.getScanner(new Scan())));
      region2.close();
      wal2.close();
      return null;
    }
  }
);
}

</code></pre>

<script>$(document).ready(function() {
  $('pre code').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});</script>
